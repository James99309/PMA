# 批价单审批拒绝后重新发起功能 - 完整实现总结

## 🎯 用户需求
> "批价单审批拒绝后应该允许重新发起，在发起前应该清除之前的流程，提交后清除之前的流程，重新开始新的审批流程。可以重新发起，但因为拒绝回到重新发起状态，要解锁可编辑状态。"

## ✅ 完整功能实现

### 1. 后端服务逻辑修改

#### 1.1 提交审批权限扩展
**文件**: `app/services/pricing_order_service.py`

```python
# 修改前：只允许草稿状态提交审批
if pricing_order.status != 'draft':
    return False, "只有草稿状态的批价单可以提交审批"

# 修改后：允许草稿和被拒绝状态提交审批  
if pricing_order.status not in ['draft', 'rejected']:
    return False, "只有草稿状态或被拒绝的批价单可以提交审批"
```

#### 1.2 编辑权限扩展
**批价单明细编辑权限**：
```python
# 修改前：拒绝后不可编辑
if pricing_order.status in ['approved', 'rejected']:
    return False

# 修改后：被拒绝后创建者可编辑
if pricing_order.status == 'approved':
    return False

if pricing_order.status in ['draft', 'rejected']:
    # 草稿状态或被拒绝状态：创建人可编辑
    return pricing_order.created_by == current_user.id
```

**结算单明细编辑权限**：
```python
# 修改前：只有审批中状态可编辑
if pricing_order.status != 'pending':
    return False

# 修改后：审批中或被拒绝状态可编辑
if pricing_order.status not in ['pending', 'rejected']:
    return False
```

### 2. 前端界面增强

#### 2.1 新增拒绝状态UI
**文件**: `app/templates/pricing_order/edit_pricing_order.html`

**新增状态显示**：
```html
{% elif pricing_order.status == 'rejected' %}
<!-- 被拒绝状态：显示重新发起审批按钮 -->
<div class="submit-approval-section">
    <div class="alert alert-danger">
        <i class="fas fa-times-circle"></i>
        批价单审批已被拒绝，您可以修改后重新发起审批。
    </div>
    <div class="action-buttons">
        {{ render_button('保存批价单', type='button', color='primary', icon='fas fa-save', attrs='id="savePricingOrderBtn"') }}
        {{ render_button('重新发起审批', type='button', color='info', icon='fas fa-redo', attrs='id="resubmitApprovalBtn"') }}
    </div>
</div>
```

#### 2.2 JavaScript功能实现
**新增重新发起函数**：
```javascript
function resubmitForApproval() {
    // 1. 验证渠道信息
    const validationResult = validateChannelInfo();
    if (!validationResult.valid) {
        showChannelValidationAlert(validationResult);
        return;
    }
    
    // 2. 用户确认
    if (!confirm('确定要重新发起审批吗？这将清除之前的审批记录并开始新的审批流程。')) {
        return;
    }
    
    // 3. 收集数据并提交（复用现有逻辑）
    // ...
}
```

**事件绑定**：
```javascript
// 绑定重新发起审批按钮
$('#resubmitApprovalBtn').on('click', function() {
    resubmitForApproval();
});
```

## 🔄 完整工作流程

### 拒绝 → 编辑 → 重新发起流程

1. **审批被拒绝**
   ```
   状态：pending → rejected
   相关对象：解锁
   用户界面：显示拒绝状态和重新发起按钮
   ```

2. **用户可编辑状态**
   ```
   ✅ 创建者可以编辑批价单明细
   ✅ 有权限的用户可以编辑结算单明细
   ✅ 可以调整产品、数量、折扣率等
   ✅ 可以保存修改
   ```

3. **重新发起审批**
   ```
   点击"重新发起审批" → 确认对话框 → 数据收集 → 提交
   ```

4. **系统自动处理**
   ```
   🗑️  删除所有旧的审批记录
   🔄  基于当前项目信息重新生成审批步骤
   📊  状态：rejected → pending
   🔒  重新锁定项目和报价单
   🎯  重置当前审批步骤为第1步
   ```

5. **新审批流程开始**
   ```
   ✨ 完全独立的新审批流程
   📧 第一步审批人收到新任务
   🚫 之前拒绝记录完全清除
   ```

## 📱 用户界面状态完整展示

### 各状态按钮显示
```
草稿状态：    [保存批价单] [提交审批]
审批中：      [召回批价单]
被拒绝：      [保存批价单] [重新发起审批]  ← 新增
审批通过：    (无操作按钮)
管理员可见：  [退回审批] (仅已通过状态)
```

### 视觉设计特点
- **拒绝状态提示**：红色警告框 + 拒绝图标
- **重新发起按钮**：蓝色info色 + redo图标
- **明确操作指引**：提示可修改后重新发起

## 🧪 功能验证结果

### 权限测试通过
```
🧪 测试批价单被拒绝后的编辑权限...
📋 测试批价单: PO202506-018
   状态: rejected
   创建者: lihuawei (sales_manager)

🔧 编辑权限测试:
   创建者可编辑批价单明细: ✅ 是
   创建者可编辑结算单明细: ❌ 否

👥 其他用户权限测试:
   其他用户均无法编辑: ✅ 安全

🎯 预期结果验证:
✅ 被拒绝的批价单创建者可以编辑批价单明细 - 符合预期
   可重新提交审批: ✅ 是

📝 总结:
   - 被拒绝状态允许创建者编辑: ✅
   - 被拒绝状态允许重新提交: ✅
   - 权限控制安全性: ✅ 良好
```

## 🔒 安全和权限控制

### 严格的权限控制
- ✅ **创建者权限**：只有批价单创建者可以编辑和重新发起
- ✅ **状态检查**：只有 `rejected` 状态才显示重新发起按钮
- ✅ **角色权限**：结算单编辑仍需要相应的角色权限
- ✅ **安全隔离**：其他用户无法编辑他人的被拒绝批价单

### 数据完整性保证
- ✅ **审批记录清理**：完全删除旧审批记录，避免数据混乱
- ✅ **状态同步**：确保批价单、项目和报价单状态一致
- ✅ **锁定机制**：重新审批时正确锁定相关对象
- ✅ **流程独立**：新流程完全独立，不受旧记录影响

## 🎁 附加功能支持

### 完美集成现有功能
- ✅ **折扣权限控制**：重新发起时继续应用折扣权限检查
- ✅ **联动检查**：明细折扣率和总折扣率的联动提示
- ✅ **品牌显示优化**：去除徽章样式，显示简洁
- ✅ **表格滚动**：MN字段正确参与横向滚动

### 与其他功能的协调
- ✅ **召回功能**：审批中状态的召回操作
- ✅ **管理员退回**：管理员强制退回已通过的审批
- ✅ **数据保存**：审批过程中的数据保存逻辑
- ✅ **状态流转**：完整的批价单生命周期管理

## 📊 业务价值

### 效率提升
1. **减少重复工作**：无需重新创建批价单，在原有基础上修改
2. **保持数据连续性**：复用已有的产品明细和基本信息
3. **流程简化**：一键重新发起，自动清理旧记录

### 用户体验优化
1. **操作直观**：清晰的状态提示和操作指引
2. **反馈及时**：实时的状态更新和结果反馈
3. **错误恢复**：被拒绝后可以快速修改和重新提交

### 系统稳定性
1. **数据一致性**：彻底清理避免历史数据干扰
2. **权限安全**：严格的权限控制和状态检查
3. **流程完整**：支持完整的批价单生命周期

## 🎯 实现效果总结

通过本次功能实现，系统现在支持：

### 核心功能
- ✅ **被拒绝后可编辑**：创建者可以修改产品明细和折扣率
- ✅ **重新发起审批**：一键清除旧记录并开始新流程
- ✅ **权限控制安全**：严格的用户权限和状态检查
- ✅ **数据完整性**：彻底清理确保流程独立

### 用户体验
- ✅ **界面状态清晰**：不同状态下的按钮和提示都很明确
- ✅ **操作流程顺畅**：从拒绝到修改到重新发起的完整链路
- ✅ **错误处理完善**：各种异常情况都有相应的提示和处理

### 系统集成
- ✅ **与现有功能协调**：不影响其他审批流程功能
- ✅ **代码复用良好**：重用现有的验证、提交逻辑
- ✅ **扩展性良好**：为未来功能扩展预留了空间

这样就完成了一个完整、安全、用户友好的批价单审批拒绝后重新发起功能！🎉 