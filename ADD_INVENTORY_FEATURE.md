# 添加库存功能使用说明

## 概述

新的批量添加库存功能采用了与报价单编辑相同的产品选择界面设计，提供了更直观和高效的库存管理体验。

## 功能特性

### 🎯 主要特性
- **报价单风格界面**：采用与报价单编辑相同的产品选择界面
- **逐级产品选择**：通过产品类型 → 产品名称 → 产品型号 → 规格规格的方式选择产品
- **批量添加支持**：可以同时添加多个不同产品的库存
- **智能产品匹配**：支持通过MN号或产品名称+型号精确匹配产品
- **精简字段显示**：专注于库存管理，不显示价格相关信息

### 📊 显示字段
- 产品名称
- 产品型号
- 指标规格
- 品牌
- 单位
- 数量（可修改）
- MN号

## 使用方法

### 1. 访问添加库存页面
- 登录系统后，进入库存管理模块
- 在库存列表页面点击"批量添加库存"按钮
- 或直接访问：`/inventory/add_inventory`

### 2. 选择库存公司
- 页面顶部有醒目的公司选择区域
- 从下拉列表中选择要添加库存的目标公司
- ⚠️ **必须选择公司才能继续添加产品**

### 3. 添加产品
#### 方式一：逐级选择产品
1. 点击"产品名称"输入框
2. 选择产品类别（如：基站、配件、天线等）
3. 选择具体产品名称
4. 选择产品型号
5. 选择具体规格
6. 系统自动填充产品信息（品牌、单位、MN号等）

#### 方式二：添加多个产品
1. 完成第一个产品的选择
2. 点击"添加产品"按钮新增产品行
3. 重复产品选择过程
4. 可以为不同产品设置不同的数量

### 4. 设置数量
- 在"数量"列中输入要添加的库存数量
- 默认数量为1，可以根据需要修改
- 数量必须大于0

### 5. 提交保存
- 检查所有产品信息和数量
- 点击"保存库存"按钮提交
- 系统会批量处理所有产品的库存添加

## 后端处理逻辑

### 产品匹配规则
1. **优先级1**：通过MN号精确匹配
2. **优先级2**：通过产品名称+型号匹配
3. **找不到匹配**：显示错误信息，跳过该产品

### 库存更新流程
1. 验证公司和产品信息
2. 检查产品是否存在于系统中
3. 调用`update_inventory`函数更新库存
4. 创建库存变动记录
5. 记录操作日志

### 错误处理
- 部分产品处理失败不影响其他产品
- 详细的错误信息反馈
- 成功数量和失败信息分别显示

## 技术实现

### 前端技术
- **JavaScript产品选择器**：复用报价单的产品自动完成功能
- **动态表格**：支持添加/删除产品行
- **AJAX产品API**：实时获取产品信息
- **表单验证**：确保数据完整性

### 后端API
```
GET  /inventory/add_inventory        - 显示添加库存页面
POST /inventory/add_inventory_bulk   - 处理批量添加库存
GET  /quotation/products/categories  - 获取产品类别列表
GET  /quotation/products/by-category - 按类别获取产品
GET  /quotation/products/models      - 按产品名称获取型号
GET  /quotation/products/specs       - 按型号获取规格
```

### 数据库操作
- 使用现有的`update_inventory`函数
- 创建库存变动记录（InventoryTransaction）
- 事务性操作确保数据一致性

## 权限要求

- **访问权限**：需要`inventory.create`权限
- **用户角色**：库存管理员、系统管理员
- **登录状态**：必须登录系统

## 注意事项

### ⚠️ 使用限制
1. 必须先选择库存公司
2. 产品必须在系统产品库中存在
3. 数量必须为正整数
4. 需要相应的库存管理权限

### 💡 最佳实践
1. 建议按类别批量添加相同类型的产品
2. 大批量添加时建议分批次操作
3. 添加后及时检查库存记录是否正确
4. 定期备份库存数据

## 常见问题

### Q: 为什么有些产品搜索不到？
A: 可能的原因：
- 产品状态为"停产"
- 产品信息不完整
- 产品类别设置错误

### Q: 批量添加时部分失败怎么办？
A: 
- 系统会显示成功和失败的详细信息
- 失败的产品不影响成功的产品
- 可以重新添加失败的产品

### Q: 如何快速找到产品？
A: 
- 如果知道MN号，系统会优先匹配
- 按产品类别逐级选择更准确
- 注意产品名称的完整性

## 更新日志

### v1.0.0 (当前版本)
- ✅ 实现报价单风格的产品选择界面
- ✅ 支持批量添加多个产品库存
- ✅ 完整的错误处理和用户反馈
- ✅ 集成现有的库存管理系统
- ✅ 添加完整的API支持

---

**开发完成日期**: 2024年

此功能完全集成到现有的PMA系统中，遵循系统的设计规范和安全标准。 