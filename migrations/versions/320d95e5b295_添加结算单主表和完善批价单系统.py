
"""添加结算单主表和完善批价单系统

Revision ID: 320d95e5b295
Revises: 247d0de6fa5d
Create Date: 2025-06-05 18:35:46.964530

"""
from alembic import op
import sqlalchemy as sa
from sqlalchemy.dialects import postgresql

# revision identifiers, used by Alembic.
revision = '320d95e5b295'
down_revision = '247d0de6fa5d'
branch_labels = None
depends_on = None


def upgrade():
    # ### commands auto generated by Alembic - please adjust! ###
    with op.batch_alter_table('pricing_order_approval_records', schema=None) as batch_op:
        batch_op.alter_column('pricing_order_id',
               existing_type=sa.INTEGER(),
               comment='批价单ID',
               existing_nullable=False)
        batch_op.alter_column('step_order',
               existing_type=sa.INTEGER(),
               comment='审批步骤顺序',
               existing_nullable=False)
        batch_op.alter_column('step_name',
               existing_type=sa.VARCHAR(length=50),
               type_=sa.String(length=64),
               comment='审批步骤名称',
               existing_nullable=False)
        batch_op.alter_column('approver_role',
               existing_type=sa.VARCHAR(length=50),
               type_=sa.String(length=64),
               comment='审批人角色',
               existing_nullable=False)
        batch_op.alter_column('approver_id',
               existing_type=sa.INTEGER(),
               comment='审批人ID',
               existing_nullable=False)
        batch_op.alter_column('action',
               existing_type=sa.VARCHAR(length=20),
               type_=sa.String(length=16),
               comment='审批动作：approve/reject',
               existing_nullable=True)
        batch_op.alter_column('comment',
               existing_type=sa.TEXT(),
               comment='审批意见',
               existing_nullable=True)
        batch_op.alter_column('approved_at',
               existing_type=postgresql.TIMESTAMP(),
               comment='审批时间',
               existing_nullable=True)
        batch_op.alter_column('is_fast_approval',
               existing_type=sa.BOOLEAN(),
               comment='是否快速通过',
               existing_nullable=True)
        batch_op.alter_column('fast_approval_reason',
               existing_type=sa.VARCHAR(length=200),
               type_=sa.String(length=255),
               comment='快速通过原因',
               existing_nullable=True)

    with op.batch_alter_table('pricing_order_details', schema=None) as batch_op:
        batch_op.alter_column('pricing_order_id',
               existing_type=sa.INTEGER(),
               comment='批价单ID',
               existing_nullable=False)
        batch_op.alter_column('product_name',
               existing_type=sa.VARCHAR(length=200),
               type_=sa.String(length=255),
               comment='产品名称',
               existing_nullable=False)
        batch_op.alter_column('product_model',
               existing_type=sa.VARCHAR(length=100),
               type_=sa.String(length=128),
               comment='产品型号',
               existing_nullable=True)
        batch_op.alter_column('product_desc',
               existing_type=sa.TEXT(),
               comment='产品描述',
               existing_nullable=True)
        batch_op.alter_column('brand',
               existing_type=sa.VARCHAR(length=50),
               type_=sa.String(length=64),
               comment='品牌',
               existing_nullable=True)
        batch_op.alter_column('unit',
               existing_type=sa.VARCHAR(length=20),
               type_=sa.String(length=16),
               comment='单位',
               existing_nullable=True)
        batch_op.alter_column('product_mn',
               existing_type=sa.VARCHAR(length=100),
               type_=sa.String(length=64),
               comment='产品MN编码',
               existing_nullable=True)
        batch_op.alter_column('market_price',
               existing_type=sa.DOUBLE_PRECISION(precision=53),
               comment='市场价',
               existing_nullable=False)
        batch_op.alter_column('unit_price',
               existing_type=sa.DOUBLE_PRECISION(precision=53),
               comment='单价',
               existing_nullable=False)
        batch_op.alter_column('quantity',
               existing_type=sa.INTEGER(),
               comment='数量',
               existing_nullable=False)
        batch_op.alter_column('discount_rate',
               existing_type=sa.DOUBLE_PRECISION(precision=53),
               nullable=True,
               comment='折扣率')
        batch_op.alter_column('total_price',
               existing_type=sa.DOUBLE_PRECISION(precision=53),
               comment='小计金额',
               existing_nullable=False)
        batch_op.alter_column('source_type',
               existing_type=sa.VARCHAR(length=20),
               type_=sa.String(length=32),
               comment='数据来源：quotation/manual',
               existing_nullable=True)
        batch_op.alter_column('source_quotation_detail_id',
               existing_type=sa.INTEGER(),
               comment='来源报价单明细ID',
               existing_nullable=True)
        batch_op.drop_constraint('pricing_order_details_source_quotation_detail_id_fkey', type_='foreignkey')

    with op.batch_alter_table('pricing_orders', schema=None) as batch_op:
        batch_op.alter_column('order_number',
               existing_type=sa.VARCHAR(length=32),
               type_=sa.String(length=64),
               comment='批价单号',
               existing_nullable=False)
        batch_op.alter_column('project_id',
               existing_type=sa.INTEGER(),
               comment='项目ID',
               existing_nullable=False)
        batch_op.alter_column('quotation_id',
               existing_type=sa.INTEGER(),
               comment='报价单ID',
               existing_nullable=False)
        batch_op.alter_column('dealer_id',
               existing_type=sa.INTEGER(),
               comment='经销商ID',
               existing_nullable=True)
        batch_op.alter_column('distributor_id',
               existing_type=sa.INTEGER(),
               comment='分销商ID',
               existing_nullable=True)
        batch_op.alter_column('approval_flow_type',
               existing_type=sa.VARCHAR(length=32),
               comment='审批流程类型',
               existing_nullable=False)
        batch_op.alter_column('status',
               existing_type=sa.VARCHAR(length=20),
               nullable=True,
               comment='批价单状态')
        batch_op.alter_column('current_approval_step',
               existing_type=sa.INTEGER(),
               nullable=True,
               comment='当前审批步骤')
        batch_op.alter_column('pricing_total_amount',
               existing_type=sa.DOUBLE_PRECISION(precision=53),
               nullable=True,
               comment='批价单总金额')
        batch_op.alter_column('pricing_total_discount_rate',
               existing_type=sa.DOUBLE_PRECISION(precision=53),
               nullable=True,
               comment='批价单总折扣率')
        batch_op.alter_column('settlement_total_amount',
               existing_type=sa.DOUBLE_PRECISION(precision=53),
               nullable=True,
               comment='结算单总金额')
        batch_op.alter_column('settlement_total_discount_rate',
               existing_type=sa.DOUBLE_PRECISION(precision=53),
               nullable=True,
               comment='结算单总折扣率')
        batch_op.alter_column('approved_by',
               existing_type=sa.INTEGER(),
               comment='最终批准人',
               existing_nullable=True)
        batch_op.alter_column('approved_at',
               existing_type=postgresql.TIMESTAMP(),
               comment='批准时间',
               existing_nullable=True)
        batch_op.alter_column('created_by',
               existing_type=sa.INTEGER(),
               comment='创建人',
               existing_nullable=False)
        batch_op.alter_column('created_at',
               existing_type=postgresql.TIMESTAMP(),
               nullable=True,
               comment='创建时间')
        batch_op.alter_column('updated_at',
               existing_type=postgresql.TIMESTAMP(),
               nullable=True,
               comment='更新时间')
        batch_op.drop_index('ix_pricing_orders_order_number')
        batch_op.create_unique_constraint(None, ['order_number'])

    with op.batch_alter_table('settlement_order_details', schema=None) as batch_op:
        batch_op.add_column(sa.Column('settlement_order_id', sa.Integer(), nullable=True, comment='结算单ID'))
        batch_op.alter_column('pricing_order_id',
               existing_type=sa.INTEGER(),
               comment='批价单ID',
               existing_nullable=False)
        batch_op.alter_column('product_name',
               existing_type=sa.VARCHAR(length=200),
               type_=sa.String(length=255),
               comment='产品名称',
               existing_nullable=False)
        batch_op.alter_column('product_model',
               existing_type=sa.VARCHAR(length=100),
               type_=sa.String(length=128),
               comment='产品型号',
               existing_nullable=True)
        batch_op.alter_column('product_desc',
               existing_type=sa.TEXT(),
               comment='产品描述',
               existing_nullable=True)
        batch_op.alter_column('brand',
               existing_type=sa.VARCHAR(length=50),
               type_=sa.String(length=64),
               comment='品牌',
               existing_nullable=True)
        batch_op.alter_column('unit',
               existing_type=sa.VARCHAR(length=20),
               type_=sa.String(length=16),
               comment='单位',
               existing_nullable=True)
        batch_op.alter_column('product_mn',
               existing_type=sa.VARCHAR(length=100),
               type_=sa.String(length=64),
               comment='产品MN编码',
               existing_nullable=True)
        batch_op.alter_column('market_price',
               existing_type=sa.DOUBLE_PRECISION(precision=53),
               comment='市场价',
               existing_nullable=False)
        batch_op.alter_column('unit_price',
               existing_type=sa.DOUBLE_PRECISION(precision=53),
               comment='单价',
               existing_nullable=False)
        batch_op.alter_column('quantity',
               existing_type=sa.INTEGER(),
               comment='数量',
               existing_nullable=False)
        batch_op.alter_column('discount_rate',
               existing_type=sa.DOUBLE_PRECISION(precision=53),
               nullable=True,
               comment='折扣率')
        batch_op.alter_column('total_price',
               existing_type=sa.DOUBLE_PRECISION(precision=53),
               comment='小计金额',
               existing_nullable=False)
        batch_op.alter_column('pricing_detail_id',
               existing_type=sa.INTEGER(),
               comment='关联批价单明细ID',
               existing_nullable=False)
        batch_op.create_foreign_key(None, 'settlement_orders', ['settlement_order_id'], ['id'])

    with op.batch_alter_table('settlement_orders', schema=None) as batch_op:
        batch_op.alter_column('status',
               existing_type=postgresql.ENUM('DRAFT', 'PENDING', 'APPROVED', 'REJECTED', name='settlementorderstatus'),
               type_=sa.String(length=20),
               existing_comment='结算单状态',
               existing_nullable=True)

    # ### end Alembic commands ###


def downgrade():
    # ### commands auto generated by Alembic - please adjust! ###
    with op.batch_alter_table('settlement_orders', schema=None) as batch_op:
        batch_op.alter_column('status',
               existing_type=sa.String(length=20),
               type_=postgresql.ENUM('DRAFT', 'PENDING', 'APPROVED', 'REJECTED', name='settlementorderstatus'),
               existing_comment='结算单状态',
               existing_nullable=True)

    with op.batch_alter_table('settlement_order_details', schema=None) as batch_op:
        batch_op.drop_constraint(None, type_='foreignkey')
        batch_op.alter_column('pricing_detail_id',
               existing_type=sa.INTEGER(),
               comment=None,
               existing_comment='关联批价单明细ID',
               existing_nullable=False)
        batch_op.alter_column('total_price',
               existing_type=sa.DOUBLE_PRECISION(precision=53),
               comment=None,
               existing_comment='小计金额',
               existing_nullable=False)
        batch_op.alter_column('discount_rate',
               existing_type=sa.DOUBLE_PRECISION(precision=53),
               nullable=False,
               comment=None,
               existing_comment='折扣率')
        batch_op.alter_column('quantity',
               existing_type=sa.INTEGER(),
               comment=None,
               existing_comment='数量',
               existing_nullable=False)
        batch_op.alter_column('unit_price',
               existing_type=sa.DOUBLE_PRECISION(precision=53),
               comment=None,
               existing_comment='单价',
               existing_nullable=False)
        batch_op.alter_column('market_price',
               existing_type=sa.DOUBLE_PRECISION(precision=53),
               comment=None,
               existing_comment='市场价',
               existing_nullable=False)
        batch_op.alter_column('product_mn',
               existing_type=sa.String(length=64),
               type_=sa.VARCHAR(length=100),
               comment=None,
               existing_comment='产品MN编码',
               existing_nullable=True)
        batch_op.alter_column('unit',
               existing_type=sa.String(length=16),
               type_=sa.VARCHAR(length=20),
               comment=None,
               existing_comment='单位',
               existing_nullable=True)
        batch_op.alter_column('brand',
               existing_type=sa.String(length=64),
               type_=sa.VARCHAR(length=50),
               comment=None,
               existing_comment='品牌',
               existing_nullable=True)
        batch_op.alter_column('product_desc',
               existing_type=sa.TEXT(),
               comment=None,
               existing_comment='产品描述',
               existing_nullable=True)
        batch_op.alter_column('product_model',
               existing_type=sa.String(length=128),
               type_=sa.VARCHAR(length=100),
               comment=None,
               existing_comment='产品型号',
               existing_nullable=True)
        batch_op.alter_column('product_name',
               existing_type=sa.String(length=255),
               type_=sa.VARCHAR(length=200),
               comment=None,
               existing_comment='产品名称',
               existing_nullable=False)
        batch_op.alter_column('pricing_order_id',
               existing_type=sa.INTEGER(),
               comment=None,
               existing_comment='批价单ID',
               existing_nullable=False)
        batch_op.drop_column('settlement_order_id')

    with op.batch_alter_table('pricing_orders', schema=None) as batch_op:
        batch_op.drop_constraint(None, type_='unique')
        batch_op.create_index('ix_pricing_orders_order_number', ['order_number'], unique=True)
        batch_op.alter_column('updated_at',
               existing_type=postgresql.TIMESTAMP(),
               nullable=False,
               comment=None,
               existing_comment='更新时间')
        batch_op.alter_column('created_at',
               existing_type=postgresql.TIMESTAMP(),
               nullable=False,
               comment=None,
               existing_comment='创建时间')
        batch_op.alter_column('created_by',
               existing_type=sa.INTEGER(),
               comment=None,
               existing_comment='创建人',
               existing_nullable=False)
        batch_op.alter_column('approved_at',
               existing_type=postgresql.TIMESTAMP(),
               comment=None,
               existing_comment='批准时间',
               existing_nullable=True)
        batch_op.alter_column('approved_by',
               existing_type=sa.INTEGER(),
               comment=None,
               existing_comment='最终批准人',
               existing_nullable=True)
        batch_op.alter_column('settlement_total_discount_rate',
               existing_type=sa.DOUBLE_PRECISION(precision=53),
               nullable=False,
               comment=None,
               existing_comment='结算单总折扣率')
        batch_op.alter_column('settlement_total_amount',
               existing_type=sa.DOUBLE_PRECISION(precision=53),
               nullable=False,
               comment=None,
               existing_comment='结算单总金额')
        batch_op.alter_column('pricing_total_discount_rate',
               existing_type=sa.DOUBLE_PRECISION(precision=53),
               nullable=False,
               comment=None,
               existing_comment='批价单总折扣率')
        batch_op.alter_column('pricing_total_amount',
               existing_type=sa.DOUBLE_PRECISION(precision=53),
               nullable=False,
               comment=None,
               existing_comment='批价单总金额')
        batch_op.alter_column('current_approval_step',
               existing_type=sa.INTEGER(),
               nullable=False,
               comment=None,
               existing_comment='当前审批步骤')
        batch_op.alter_column('status',
               existing_type=sa.VARCHAR(length=20),
               nullable=False,
               comment=None,
               existing_comment='批价单状态')
        batch_op.alter_column('approval_flow_type',
               existing_type=sa.VARCHAR(length=32),
               comment=None,
               existing_comment='审批流程类型',
               existing_nullable=False)
        batch_op.alter_column('distributor_id',
               existing_type=sa.INTEGER(),
               comment=None,
               existing_comment='分销商ID',
               existing_nullable=True)
        batch_op.alter_column('dealer_id',
               existing_type=sa.INTEGER(),
               comment=None,
               existing_comment='经销商ID',
               existing_nullable=True)
        batch_op.alter_column('quotation_id',
               existing_type=sa.INTEGER(),
               comment=None,
               existing_comment='报价单ID',
               existing_nullable=False)
        batch_op.alter_column('project_id',
               existing_type=sa.INTEGER(),
               comment=None,
               existing_comment='项目ID',
               existing_nullable=False)
        batch_op.alter_column('order_number',
               existing_type=sa.String(length=64),
               type_=sa.VARCHAR(length=32),
               comment=None,
               existing_comment='批价单号',
               existing_nullable=False)

    with op.batch_alter_table('pricing_order_details', schema=None) as batch_op:
        batch_op.create_foreign_key('pricing_order_details_source_quotation_detail_id_fkey', 'quotation_details', ['source_quotation_detail_id'], ['id'])
        batch_op.alter_column('source_quotation_detail_id',
               existing_type=sa.INTEGER(),
               comment=None,
               existing_comment='来源报价单明细ID',
               existing_nullable=True)
        batch_op.alter_column('source_type',
               existing_type=sa.String(length=32),
               type_=sa.VARCHAR(length=20),
               comment=None,
               existing_comment='数据来源：quotation/manual',
               existing_nullable=True)
        batch_op.alter_column('total_price',
               existing_type=sa.DOUBLE_PRECISION(precision=53),
               comment=None,
               existing_comment='小计金额',
               existing_nullable=False)
        batch_op.alter_column('discount_rate',
               existing_type=sa.DOUBLE_PRECISION(precision=53),
               nullable=False,
               comment=None,
               existing_comment='折扣率')
        batch_op.alter_column('quantity',
               existing_type=sa.INTEGER(),
               comment=None,
               existing_comment='数量',
               existing_nullable=False)
        batch_op.alter_column('unit_price',
               existing_type=sa.DOUBLE_PRECISION(precision=53),
               comment=None,
               existing_comment='单价',
               existing_nullable=False)
        batch_op.alter_column('market_price',
               existing_type=sa.DOUBLE_PRECISION(precision=53),
               comment=None,
               existing_comment='市场价',
               existing_nullable=False)
        batch_op.alter_column('product_mn',
               existing_type=sa.String(length=64),
               type_=sa.VARCHAR(length=100),
               comment=None,
               existing_comment='产品MN编码',
               existing_nullable=True)
        batch_op.alter_column('unit',
               existing_type=sa.String(length=16),
               type_=sa.VARCHAR(length=20),
               comment=None,
               existing_comment='单位',
               existing_nullable=True)
        batch_op.alter_column('brand',
               existing_type=sa.String(length=64),
               type_=sa.VARCHAR(length=50),
               comment=None,
               existing_comment='品牌',
               existing_nullable=True)
        batch_op.alter_column('product_desc',
               existing_type=sa.TEXT(),
               comment=None,
               existing_comment='产品描述',
               existing_nullable=True)
        batch_op.alter_column('product_model',
               existing_type=sa.String(length=128),
               type_=sa.VARCHAR(length=100),
               comment=None,
               existing_comment='产品型号',
               existing_nullable=True)
        batch_op.alter_column('product_name',
               existing_type=sa.String(length=255),
               type_=sa.VARCHAR(length=200),
               comment=None,
               existing_comment='产品名称',
               existing_nullable=False)
        batch_op.alter_column('pricing_order_id',
               existing_type=sa.INTEGER(),
               comment=None,
               existing_comment='批价单ID',
               existing_nullable=False)

    with op.batch_alter_table('pricing_order_approval_records', schema=None) as batch_op:
        batch_op.alter_column('fast_approval_reason',
               existing_type=sa.String(length=255),
               type_=sa.VARCHAR(length=200),
               comment=None,
               existing_comment='快速通过原因',
               existing_nullable=True)
        batch_op.alter_column('is_fast_approval',
               existing_type=sa.BOOLEAN(),
               comment=None,
               existing_comment='是否快速通过',
               existing_nullable=True)
        batch_op.alter_column('approved_at',
               existing_type=postgresql.TIMESTAMP(),
               comment=None,
               existing_comment='审批时间',
               existing_nullable=True)
        batch_op.alter_column('comment',
               existing_type=sa.TEXT(),
               comment=None,
               existing_comment='审批意见',
               existing_nullable=True)
        batch_op.alter_column('action',
               existing_type=sa.String(length=16),
               type_=sa.VARCHAR(length=20),
               comment=None,
               existing_comment='审批动作：approve/reject',
               existing_nullable=True)
        batch_op.alter_column('approver_id',
               existing_type=sa.INTEGER(),
               comment=None,
               existing_comment='审批人ID',
               existing_nullable=False)
        batch_op.alter_column('approver_role',
               existing_type=sa.String(length=64),
               type_=sa.VARCHAR(length=50),
               comment=None,
               existing_comment='审批人角色',
               existing_nullable=False)
        batch_op.alter_column('step_name',
               existing_type=sa.String(length=64),
               type_=sa.VARCHAR(length=50),
               comment=None,
               existing_comment='审批步骤名称',
               existing_nullable=False)
        batch_op.alter_column('step_order',
               existing_type=sa.INTEGER(),
               comment=None,
               existing_comment='审批步骤顺序',
               existing_nullable=False)
        batch_op.alter_column('pricing_order_id',
               existing_type=sa.INTEGER(),
               comment=None,
               existing_comment='批价单ID',
               existing_nullable=False)

    # ### end Alembic commands ###