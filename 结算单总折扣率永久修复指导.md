# ç»“ç®—å•æ€»æŠ˜æ‰£ç‡æ°¸ä¹…ä¿®å¤æŒ‡å¯¼

## é—®é¢˜ç¡®è®¤
âœ… ä¸´æ—¶æµ‹è¯•è„šæœ¬æœ‰æ•ˆï¼Œè¯´æ˜ä¿®å¤é€»è¾‘æ­£ç¡®
âŒ é¡µé¢åˆ·æ–°åå¤±æ•ˆï¼Œéœ€è¦æ°¸ä¹…åŒ–ä¿®å¤

## æ ¹æœ¬åŸå› 
ç°æœ‰çš„ `updateTotalDiscount` å‡½æ•°åœ¨ç¬¬2276è¡Œä½¿ç”¨äº†é”™è¯¯çš„æ•°é‡è·å–æ–¹æ³•ï¼š
```javascript
let quantityValue = $row.find('.quantity').val();
const quantity = parseInt(quantityValue) || 1;
```

åœ¨å®¡æ‰¹çŠ¶æ€ä¸‹ï¼Œæ•°é‡å­—æ®µæ˜¯çº¯æ–‡æœ¬æ˜¾ç¤ºï¼Œæ²¡æœ‰ `.val()` æ–¹æ³•ï¼Œå¯¼è‡´è·å–å¤±è´¥ã€‚

## æ°¸ä¹…ä¿®å¤æ–¹æ¡ˆ

### æ­¥éª¤1ï¼šä¿®æ”¹ updateTotalDiscount å‡½æ•°

æ‰¾åˆ°æ–‡ä»¶ `app/templates/pricing_order/edit_pricing_order.html` çš„ç¬¬2276è¡Œé™„è¿‘ï¼Œå°†ï¼š

```javascript
// è·å–å¸‚åœºä»·
const marketPrice = parseFloat($row.find('.product-price').data('raw-value')) || 0;

// ğŸ”¥ ç›´æ¥è·å–æ•°é‡ï¼Œä¸ä½¿ç”¨å¤æ‚çš„å‡½æ•°
let quantityValue = $row.find('.quantity').val();
const quantity = parseInt(quantityValue) || 1;
```

æ›¿æ¢ä¸ºï¼š

```javascript
// ğŸ”¥ ä¿®å¤ï¼šè·å–å¸‚åœºä»·ï¼Œæ”¯æŒä»æ˜¾ç¤ºå€¼è§£æ
const $marketPriceInput = $row.find('.product-price');
let marketPrice = parseFloat($marketPriceInput.data('raw-value')) || 0;

// å¦‚æœæ²¡æœ‰data-raw-valueï¼Œå°è¯•ä»æ˜¾ç¤ºå€¼è§£æ
if (marketPrice === 0) {
    const displayPrice = $marketPriceInput.val() || $marketPriceInput.text();
    if (displayPrice) {
        const cleanPrice = displayPrice.replace(/[^\d.]/g, '');
        marketPrice = parseFloat(cleanPrice) || 0;
        if (marketPrice > 0) {
            $marketPriceInput.data('raw-value', marketPrice);
        }
    }
}

// ğŸ”¥ ä¿®å¤ï¼šä½¿ç”¨æ­£ç¡®çš„æ•°é‡è·å–æ–¹æ³•ï¼Œæ”¯æŒå®¡æ‰¹çŠ¶æ€
const quantity = getQuantityValue($row);
```

### æ­¥éª¤2ï¼šæ›´æ–°è°ƒè¯•æ—¥å¿—

å°†è°ƒè¯•æ—¥å¿—éƒ¨åˆ†ï¼š

```javascript
console.log(`äº§å“: ${productName}`);
console.log(`å¸‚åœºä»·: ${marketPrice}`);
console.log(`æ•°é‡è¾“å…¥æ¡†å€¼: "${quantityValue}"`);
console.log(`æ•°é‡è§£æå€¼: ${quantity}`);
console.log(`æŠ˜æ‰£ç‡: ${discountRate * 100}%`);
```

æ›¿æ¢ä¸ºï¼š

```javascript
console.log(`äº§å“: ${productName}`);
console.log(`å¸‚åœºä»·: ${marketPrice}`);
console.log(`æ•°é‡: ${quantity}`);
console.log(`æŠ˜æ‰£ç‡: ${discountRate * 100}%`);
```

## ä¸´æ—¶è§£å†³æ–¹æ¡ˆï¼ˆç«‹å³å¯ç”¨ï¼‰

å¦‚æœæ‚¨æš‚æ—¶ä¸æƒ³ä¿®æ”¹æ¨¡æ¿æ–‡ä»¶ï¼Œå¯ä»¥åœ¨æ¯æ¬¡é¡µé¢åŠ è½½åæ‰§è¡Œä»¥ä¸‹è„šæœ¬ï¼š

### æ–¹æ³•1ï¼šæµè§ˆå™¨ä¹¦ç­¾è„šæœ¬
åˆ›å»ºä¸€ä¸ªæµè§ˆå™¨ä¹¦ç­¾ï¼ŒURLè®¾ä¸ºï¼š

```javascript
javascript:(function(){
    // é‡å†™ updateTotalDiscount å‡½æ•°
    window.updateTotalDiscount = function(tabType, value) {
        console.log('æ›´æ–°æ€»æŠ˜æ‰£ç‡:', tabType, value);
        
        const discountRate = parseFloat(value) / 100;
        const tableId = tabType === 'pricing' ? '#pricingTable' : '#settlementTable';
        
        $(tableId + ' tbody tr').each(function() {
            const $row = $(this);
            const productName = $row.find('.product-name').val() || $row.find('td:first').text().trim();
            
            if (productName && productName.trim()) {
                // è·å–å¸‚åœºä»·
                const $marketPriceInput = $row.find('.product-price');
                let marketPrice = parseFloat($marketPriceInput.data('raw-value')) || 0;
                
                if (marketPrice === 0) {
                    const displayPrice = $marketPriceInput.val() || $marketPriceInput.text();
                    if (displayPrice) {
                        const cleanPrice = displayPrice.replace(/[^\d.]/g, '');
                        marketPrice = parseFloat(cleanPrice) || 0;
                        if (marketPrice > 0) {
                            $marketPriceInput.data('raw-value', marketPrice);
                        }
                    }
                }
                
                // ä½¿ç”¨æ­£ç¡®çš„æ•°é‡è·å–æ–¹æ³•
                const quantity = getQuantityValue($row);
                
                console.log('è¡Œè®¡ç®—:', {äº§å“: productName, å¸‚åœºä»·: marketPrice, æ•°é‡: quantity, æŠ˜æ‰£ç‡: discountRate * 100 + '%'});
                
                // è®¡ç®—æ–°çš„å•ä»·å’Œå°è®¡
                const newUnitPrice = marketPrice * discountRate;
                const newSubtotal = newUnitPrice * quantity;
                
                // æ›´æ–°æŠ˜æ‰£ç‡æ˜¾ç¤º
                $row.find('.discount-rate').val((discountRate * 100).toFixed(1));
                
                // æ›´æ–°å•ä»·æ˜¾ç¤º
                const formattedUnitPrice = formatNumber(newUnitPrice);
                $row.find('.discounted-price').val(formattedUnitPrice).data('raw-value', newUnitPrice);
                
                // æ›´æ–°å°è®¡æ˜¾ç¤º
                const formattedSubtotal = formatNumber(newSubtotal);
                $row.find('.subtotal').val(formattedSubtotal).data('raw-value', newSubtotal);
                
                // åŒæ­¥åˆ°ç§»åŠ¨ç«¯
                const detailId = $row.data('detail-id');
                if (detailId) {
                    const $mobileCard = $('.mobile-product-card[data-detail-id="' + detailId + '"]');
                    if ($mobileCard.length) {
                        $mobileCard.find('.discount-rate').val((discountRate * 100).toFixed(1));
                        $mobileCard.find('.discounted-price').val(formattedUnitPrice).data('raw-value', newUnitPrice);
                        $mobileCard.find('.subtotal').val(formattedSubtotal).data('raw-value', newSubtotal);
                    }
                }
            }
        });
        
        // é‡æ–°è®¡ç®—æ€»é¢
        if (tabType === 'pricing') {
            updatePricingTableTotal();
        } else {
            updateSettlementTableTotal();
        }
        
        updateDistributionProfit();
        console.log('æ€»æŠ˜æ‰£ç‡æ›´æ–°å®Œæˆ: ' + value + '%');
    };
    
    alert('ç»“ç®—å•æ€»æŠ˜æ‰£ç‡ä¿®å¤å·²åŠ è½½ï¼');
})();
```

### æ–¹æ³•2ï¼šé¡µé¢åŠ è½½è„šæœ¬
åœ¨æ¯æ¬¡è¿›å…¥æ‰¹ä»·å•ç¼–è¾‘é¡µé¢åï¼Œåœ¨Consoleä¸­æ‰§è¡Œï¼š

```javascript
// å¿«é€Ÿä¿®å¤ç»“ç®—å•æ€»æŠ˜æ‰£ç‡
(function() {
    const originalUpdateTotalDiscount = window.updateTotalDiscount;
    
    window.updateTotalDiscount = function(tabType, value) {
        console.log('ä¿®å¤ç‰ˆæ€»æŠ˜æ‰£ç‡æ›´æ–°:', tabType, value);
        
        const discountRate = parseFloat(value) / 100;
        const tableId = tabType === 'pricing' ? '#pricingTable' : '#settlementTable';
        
        $(tableId + ' tbody tr').each(function() {
            const $row = $(this);
            const productName = $row.find('.product-name').val() || $row.find('td:first').text().trim();
            
            if (productName && productName.trim()) {
                // æ­£ç¡®è·å–å¸‚åœºä»·
                const $marketPriceInput = $row.find('.product-price');
                let marketPrice = parseFloat($marketPriceInput.data('raw-value')) || 0;
                
                if (marketPrice === 0) {
                    const displayPrice = $marketPriceInput.val() || $marketPriceInput.text();
                    if (displayPrice) {
                        marketPrice = parseFloat(displayPrice.replace(/[^\d.]/g, '')) || 0;
                        if (marketPrice > 0) {
                            $marketPriceInput.data('raw-value', marketPrice);
                        }
                    }
                }
                
                // æ­£ç¡®è·å–æ•°é‡
                const quantity = getQuantityValue($row);
                
                if (marketPrice > 0) {
                    const newUnitPrice = marketPrice * discountRate;
                    const newSubtotal = newUnitPrice * quantity;
                    
                    // æ›´æ–°æ‰€æœ‰å­—æ®µ
                    $row.find('.discount-rate').val((discountRate * 100).toFixed(1));
                    $row.find('.discounted-price').val(formatNumber(newUnitPrice)).data('raw-value', newUnitPrice);
                    $row.find('.subtotal').val(formatNumber(newSubtotal)).data('raw-value', newSubtotal);
                    
                    console.log(`æ›´æ–°è¡Œ: ${productName}, å¸‚åœºä»·=${marketPrice}, æ•°é‡=${quantity}, å•ä»·=${newUnitPrice.toFixed(2)}, å°è®¡=${newSubtotal.toFixed(2)}`);
                }
            }
        });
        
        // æ›´æ–°æ€»é¢
        if (typeof updatePricingTableTotal === 'function' && tabType === 'pricing') {
            updatePricingTableTotal();
        } else if (typeof updateSettlementTableTotal === 'function' && tabType === 'settlement') {
            updateSettlementTableTotal();
        } else {
            updateTableTotals(true);
        }
        
        if (typeof updateDistributionProfit === 'function') {
            updateDistributionProfit();
        }
    };
    
    console.log('âœ… ç»“ç®—å•æ€»æŠ˜æ‰£ç‡ä¿®å¤å·²åŠ è½½');
})();
```

## éªŒè¯æ­¥éª¤

ä¿®å¤åï¼Œè¯·éªŒè¯ï¼š

1. **ç»“ç®—å•æ€»æŠ˜æ‰£ç‡è°ƒæ•´**ï¼š
   - åˆ‡æ¢åˆ°ç»“ç®—å•æ ‡ç­¾é¡µ
   - ä¿®æ”¹æ€»æŠ˜æ‰£ç‡
   - æ£€æŸ¥æ‰€æœ‰è¡Œçš„å•ä»·å’Œå°è®¡æ˜¯å¦æ­£ç¡®æ›´æ–°

2. **é¡µé¢åˆ·æ–°æµ‹è¯•**ï¼š
   - åˆ·æ–°é¡µé¢
   - å†æ¬¡æµ‹è¯•æ€»æŠ˜æ‰£ç‡è°ƒæ•´
   - ç¡®è®¤åŠŸèƒ½æŒç»­æœ‰æ•ˆ

3. **è®¡ç®—éªŒè¯**ï¼š
   - æ‰‹åŠ¨éªŒè¯ï¼šå•ä»· = å¸‚åœºä»· Ã— æŠ˜æ‰£ç‡
   - æ‰‹åŠ¨éªŒè¯ï¼šå°è®¡ = å•ä»· Ã— æ•°é‡
   - æ£€æŸ¥æ€»é‡‘é¢æ˜¯å¦æ­£ç¡®

## æ¨èæ–¹æ¡ˆ

1. **ç«‹å³ä½¿ç”¨**ï¼šæ–¹æ³•2çš„é¡µé¢åŠ è½½è„šæœ¬
2. **é•¿æœŸè§£å†³**ï¼šä¿®æ”¹æ¨¡æ¿æ–‡ä»¶ï¼ˆæ­¥éª¤1-2ï¼‰
3. **ä¾¿åˆ©ä½¿ç”¨**ï¼šåˆ›å»ºæµè§ˆå™¨ä¹¦ç­¾ï¼ˆæ–¹æ³•1ï¼‰

é€‰æ‹©é€‚åˆæ‚¨çš„ä¿®å¤æ–¹å¼ï¼ 