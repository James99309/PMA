# æ‰¹ä»·å•å’Œç»“ç®—å•çŠ¶æ€æ§åˆ¶é€»è¾‘è¯¦è§£

## ğŸ“Š æ•°æ®è¡¨ç»“æ„å’ŒçŠ¶æ€å­—æ®µ

### 1. æ‰¹ä»·å•ä¸»è¡¨ (`pricing_orders`)
**æ§åˆ¶å­—æ®µ**: `status`
**å¯èƒ½çŠ¶æ€**:
- `draft` - è‰ç¨¿
- `pending` - å®¡æ‰¹ä¸­  
- `approved` - å·²æ‰¹å‡†
- `rejected` - å·²æ‹’ç»

### 2. ç»“ç®—å•ä¸»è¡¨ (`settlement_orders`)  
**æ§åˆ¶å­—æ®µ**: `status`
**å¯èƒ½çŠ¶æ€**:
- `draft` - è‰ç¨¿
- `pending` - å®¡æ‰¹ä¸­
- `approved` - å·²æ‰¹å‡†  
- `rejected` - å·²æ‹’ç»

### 3. ç»“ç®—å•æ˜ç»†è¡¨ (`settlement_order_details`)
**æ§åˆ¶å­—æ®µ**: `settlement_status`
**å¯èƒ½çŠ¶æ€**:
- `draft` - è‰ç¨¿ (æ–°å¢çŠ¶æ€ï¼Œä¿®å¤å)
- `pending` - å¾…ç»“ç®—
- `completed` - å·²ç»“ç®— (settled)

## ğŸ”„ çŠ¶æ€åˆ‡æ¢é€»è¾‘

### æ‰¹ä»·å•çŠ¶æ€åˆ‡æ¢
```
draft â†’ pending â†’ approved/rejected
  â†‘                    â†“
  â””â”€â”€â”€ ç®¡ç†å‘˜é€€å› â†â”€â”€â”€â”€â”€â”€â”˜
```

### ç»“ç®—å•çŠ¶æ€åˆ‡æ¢ (è·Ÿéšæ‰¹ä»·å•)
```
æ‰¹ä»·å• draft/pending/rejected â†’ ç»“ç®—å• draft
æ‰¹ä»·å• approved â†’ ç»“ç®—å• approved
```

### ç»“ç®—å•æ˜ç»†çŠ¶æ€åˆ‡æ¢ (è·Ÿéšæ‰¹ä»·å•)
```
æ‰¹ä»·å• draft/pending/rejected â†’ æ˜ç»† draft
æ‰¹ä»·å• approved â†’ æ˜ç»† settled/completed
```

## ğŸ¯ ç»“ç®—æ¨¡å—æ˜¾ç¤ºæ¡ä»¶

### åœ¨ç»“ç®—æ¨¡å—ä¸­ä¼šæ˜¾ç¤ºçš„æ•°æ®

#### 1. ç»“ç®—å•æ˜ç»†åˆ—è¡¨ (`/inventory/settlement`)
**æŸ¥è¯¢æ¡ä»¶**: è·å–æ‰€æœ‰ `settlement_order_details` è®°å½•
**æ˜¾ç¤ºé€»è¾‘**:
- âœ… **æ‰€æœ‰æ˜ç»†éƒ½ä¼šæ˜¾ç¤º**ï¼Œæ— è®ºæ‰¹ä»·å•çŠ¶æ€å¦‚ä½•
- ğŸ” **æŒ‰æ˜ç»†çš„ `settlement_status` è¿‡æ»¤**:
  - `pending` â†’ æ˜¾ç¤ºä¸º"å¾…ç»“ç®—"
  - `completed` â†’ æ˜¾ç¤ºä¸º"å·²ç»“ç®—"
  - `draft` â†’ æ˜¾ç¤ºä¸º"è‰ç¨¿"(æ–°å¢)

#### 2. ç»“ç®—å•åˆ—è¡¨ (`/inventory/settlement_orders`)
**æŸ¥è¯¢æ¡ä»¶**: è·å–æ‰€æœ‰ `settlement_orders` è®°å½•  
**æ˜¾ç¤ºé€»è¾‘**:
- âœ… **æ‰€æœ‰ç»“ç®—å•éƒ½ä¼šæ˜¾ç¤º**ï¼Œæ— è®ºçŠ¶æ€å¦‚ä½•
- ğŸ” **æŒ‰ç»“ç®—å•çš„ `status` åˆ†ç±»**:
  - `approved` â†’ æ˜¾ç¤ºä¸º"å·²å®¡æ‰¹"
  - `draft` â†’ æ˜¾ç¤ºä¸º"è‰ç¨¿"
  - `pending` â†’ æ˜¾ç¤ºä¸º"å®¡æ‰¹ä¸­"

## âŒ é—®é¢˜æ ¹æºåˆ†æ

### ä¸ºä»€ä¹ˆè‰ç¨¿çŠ¶æ€çš„æ‰¹ä»·å•ä¼šåœ¨ç»“ç®—æ¨¡å—æ˜¾ç¤ºï¼Ÿ

#### é—®é¢˜1: æ˜ç»†çŠ¶æ€ä¸æ­£ç¡®
```sql
-- é—®é¢˜: æ‰¹ä»·å•æ˜¯draftï¼Œä½†æ˜ç»†æ˜¯pending
SELECT 
    po.status as pricing_status,           -- draft
    sod.settlement_status as detail_status -- pending âŒ
FROM settlement_order_details sod
JOIN settlement_orders so ON sod.settlement_order_id = so.id  
JOIN pricing_orders po ON so.pricing_order_id = po.id
WHERE po.status = 'draft' AND sod.settlement_status = 'pending'
```

#### é—®é¢˜2: ç»“ç®—å•çŠ¶æ€ä¸ä¸€è‡´
```sql
-- é—®é¢˜: æ‰¹ä»·å•æ˜¯draftï¼Œä½†ç»“ç®—å•æ˜¯approved
SELECT 
    po.status as pricing_status,     -- draft
    so.status as settlement_status   -- approved âŒ
FROM settlement_orders so
JOIN pricing_orders po ON so.pricing_order_id = po.id
WHERE po.status = 'draft' AND so.status = 'approved'
```

## âœ… æ­£ç¡®çš„çŠ¶æ€é€»è¾‘

### çŠ¶æ€ä¸€è‡´æ€§è§„åˆ™
```
æ‰¹ä»·å•çŠ¶æ€ â†’ ç»“ç®—å•çŠ¶æ€ â†’ æ˜ç»†çŠ¶æ€
draft      â†’ draft      â†’ draft
pending    â†’ draft      â†’ draft  
rejected   â†’ draft      â†’ draft
approved   â†’ approved   â†’ settled/completed
```

### å…³é”®ä»£ç ä½ç½®

#### 1. ç»“ç®—æ¨¡å—æŸ¥è¯¢ (`app/routes/inventory.py`)
```python
# ç»“ç®—æ˜ç»†åˆ—è¡¨æŸ¥è¯¢
query = db.session.query(SettlementOrderDetail).join(SettlementOrder)

# çŠ¶æ€è¿‡æ»¤
if status_filter == 'pending':
    query = query.filter(SettlementOrderDetail.settlement_status == 'pending')
elif status_filter == 'completed':  
    query = query.filter(SettlementOrderDetail.settlement_status == 'completed')
```

#### 2. å®¡æ‰¹å®Œæˆæ—¶çŠ¶æ€æ›´æ–° (`app/services/pricing_order_service.py`)
```python
def complete_approval(pricing_order):
    # æ›´æ–°ç»“ç®—å•çŠ¶æ€
    settlement_order = SettlementOrder.query.filter_by(pricing_order_id=pricing_order.id).first()
    if settlement_order:
        settlement_order.status = 'approved'
        settlement_order.approved_by = pricing_order.approved_by
        settlement_order.approved_at = pricing_order.approved_at
```

#### 3. å®¡æ‰¹æ‹’ç»æ—¶çŠ¶æ€é‡ç½® (`app/services/pricing_order_service.py`)
```python
def reset_settlement_approval_status(pricing_order_id):
    # é‡ç½®ç»“ç®—å•çŠ¶æ€
    settlement_order = SettlementOrder.query.filter_by(pricing_order_id=pricing_order_id).first()
    if settlement_order:
        settlement_order.status = 'draft'
        settlement_order.approved_by = None
        settlement_order.approved_at = None
    
    # é‡ç½®æ˜ç»†çŠ¶æ€  
    settlement_details = SettlementOrderDetail.query.filter_by(pricing_order_id=pricing_order_id).all()
    for detail in settlement_details:
        detail.settlement_status = 'draft'  # ä¿®å¤: åº”è¯¥æ˜¯draftè€Œä¸æ˜¯pending
        detail.settlement_date = None
        detail.settlement_notes = None
```

## ğŸ› ï¸ ä¿®å¤æ–¹æ¡ˆ

### å·²å®æ–½çš„ä¿®å¤

#### 1. ä¿®å¤æ˜ç»†çŠ¶æ€é€»è¾‘
- **åŸé—®é¢˜**: è‰ç¨¿/å®¡æ‰¹ä¸­çš„æ‰¹ä»·å•æ˜ç»†æ˜¯ `pending` çŠ¶æ€
- **ä¿®å¤**: æ”¹ä¸º `draft` çŠ¶æ€
- **å½±å“**: ç»“ç®—æ¨¡å—ä¸ä¼šæ˜¾ç¤ºè‰ç¨¿çŠ¶æ€çš„æ˜ç»†

#### 2. ä¿®å¤ç»“ç®—å•çŠ¶æ€åŒæ­¥
- **åŸé—®é¢˜**: ç»“ç®—å•çŠ¶æ€ä¸æ‰¹ä»·å•çŠ¶æ€ä¸ä¸€è‡´
- **ä¿®å¤**: ç¡®ä¿çŠ¶æ€åŒæ­¥æ›´æ–°
- **å½±å“**: ç»“ç®—æ¨¡å—çŠ¶æ€æ˜¾ç¤ºæ­£ç¡®

#### 3. æ·»åŠ æ–°çš„æ˜ç»†çŠ¶æ€
- **æ–°å¢**: `draft` çŠ¶æ€ç”¨äºè‰ç¨¿/å®¡æ‰¹ä¸­çš„æ˜ç»†
- **åŒºåˆ†**: 
  - `draft` - ä¸åº”åœ¨ç»“ç®—æ¨¡å—æ˜¾ç¤º
  - `pending` - å¾…ç»“ç®—ï¼Œåº”åœ¨ç»“ç®—æ¨¡å—æ˜¾ç¤º
  - `completed` - å·²ç»“ç®—ï¼Œåº”åœ¨ç»“ç®—æ¨¡å—æ˜¾ç¤º

### çŠ¶æ€æ˜ å°„è¡¨

| æ‰¹ä»·å•çŠ¶æ€ | ç»“ç®—å•çŠ¶æ€ | æ˜ç»†çŠ¶æ€ | åœ¨ç»“ç®—æ¨¡å—æ˜¾ç¤º |
|-----------|-----------|---------|---------------|
| draft     | draft     | draft   | âŒ ä¸æ˜¾ç¤º      |
| pending   | draft     | draft   | âŒ ä¸æ˜¾ç¤º      |
| rejected  | draft     | draft   | âŒ ä¸æ˜¾ç¤º      |
| approved  | approved  | settled | âœ… æ˜¾ç¤º        |

## ğŸ” æ£€æŸ¥å’ŒéªŒè¯

### æ£€æŸ¥æ•°æ®ä¸€è‡´æ€§çš„SQL
```sql
-- æ£€æŸ¥çŠ¶æ€ä¸ä¸€è‡´çš„ç»“ç®—å•
SELECT 
    p.project_name,
    po.order_number as pricing_order,
    po.status as pricing_status,
    so.order_number as settlement_order,
    so.status as settlement_status
FROM settlement_orders so
JOIN pricing_orders po ON so.pricing_order_id = po.id
JOIN projects p ON po.project_id = p.id
WHERE (po.status = 'approved' AND so.status != 'approved')
   OR (po.status != 'approved' AND so.status != 'draft');

-- æ£€æŸ¥çŠ¶æ€ä¸ä¸€è‡´çš„æ˜ç»†
SELECT 
    p.project_name,
    po.order_number as pricing_order,
    po.status as pricing_status,
    COUNT(*) as detail_count,
    sod.settlement_status
FROM settlement_order_details sod
JOIN settlement_orders so ON sod.settlement_order_id = so.id
JOIN pricing_orders po ON so.pricing_order_id = po.id  
JOIN projects p ON po.project_id = p.id
WHERE (po.status = 'approved' AND sod.settlement_status != 'settled')
   OR (po.status IN ('draft', 'pending', 'rejected') AND sod.settlement_status != 'draft')
GROUP BY p.project_name, po.order_number, po.status, sod.settlement_status;
```

### ä¿®å¤æ•°æ®çš„SQL
```sql
-- ä¿®å¤ç»“ç®—å•çŠ¶æ€
UPDATE settlement_orders 
SET 
    status = 'draft',
    approved_by = NULL,
    approved_at = NULL
WHERE id IN (
    SELECT so.id
    FROM settlement_orders so
    JOIN pricing_orders po ON so.pricing_order_id = po.id
    WHERE so.status = 'approved' AND po.status != 'approved'
);

-- ä¿®å¤æ˜ç»†çŠ¶æ€
UPDATE settlement_order_details 
SET settlement_status = 'draft'
WHERE settlement_order_id IN (
    SELECT so.id
    FROM settlement_orders so
    JOIN pricing_orders po ON so.pricing_order_id = po.id
    WHERE po.status IN ('draft', 'pending', 'rejected')
) AND settlement_status = 'pending';
```

## ğŸ“ æ€»ç»“

### æ ¸å¿ƒåŸåˆ™
1. **çŠ¶æ€ä¸€è‡´æ€§**: ç»“ç®—å•å’Œæ˜ç»†çŠ¶æ€å¿…é¡»ä¸æ‰¹ä»·å•çŠ¶æ€ä¿æŒä¸€è‡´
2. **æ˜¾ç¤ºé€»è¾‘**: åªæœ‰å·²å®¡æ‰¹çš„æ‰¹ä»·å•å¯¹åº”çš„ç»“ç®—æ•°æ®æ‰åº”åœ¨ç»“ç®—æ¨¡å—æ˜¾ç¤º
3. **æ•°æ®å®Œæ•´æ€§**: çŠ¶æ€å˜æ›´å¿…é¡»åŒæ­¥æ›´æ–°æ‰€æœ‰ç›¸å…³è¡¨

### å…³é”®æ§åˆ¶ç‚¹
1. **å®¡æ‰¹å®Œæˆæ—¶**: åŒæ­¥æ›´æ–°ç»“ç®—å•å’Œæ˜ç»†çŠ¶æ€ä¸ºå·²å®¡æ‰¹/å·²ç»“ç®—
2. **å®¡æ‰¹æ‹’ç»æ—¶**: é‡ç½®ç»“ç®—å•å’Œæ˜ç»†çŠ¶æ€ä¸ºè‰ç¨¿
3. **ç»“ç®—æ¨¡å—æŸ¥è¯¢**: æ ¹æ®æ˜ç»†çŠ¶æ€è¿‡æ»¤æ˜¾ç¤ºå†…å®¹

é€šè¿‡è¿™äº›ä¿®å¤ï¼Œç¡®ä¿äº†åªæœ‰çœŸæ­£åº”è¯¥ç»“ç®—çš„æ•°æ®æ‰ä¼šåœ¨ç»“ç®—æ¨¡å—ä¸­æ˜¾ç¤ºï¼Œé¿å…äº†è‰ç¨¿çŠ¶æ€çš„æ‰¹ä»·å•æ•°æ®è¢«è¯¯è®¤ä¸ºå¾…ç»“ç®—æ•°æ®ã€‚ 