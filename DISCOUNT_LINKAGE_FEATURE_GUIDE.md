# 折扣权限联动检查功能说明

## 🎯 功能概述
实现明细折扣率和总折扣率之间的权限检查联动，确保两者变化时能够相互影响并及时提示超出权限范围。

## ✨ 联动检查逻辑

### 1. 明细折扣率 → 总折扣率联动
**触发条件**：用户修改任一产品明细的折扣率
**联动行为**：
1. 系统自动重新计算总折扣率（加权平均）
2. 检查计算后的总折扣率是否低于权限下限
3. 如果总折扣率低于权限下限，总折扣率输入框显示红色背景警告

**示例场景**：
- 销售总监权限：35%下限
- 产品A明细折扣率：从40%改为30%
- 系统重新计算总折扣率：可能变为32%
- 结果：总折扣率输入框显示红色警告（32% < 35%）

### 2. 总折扣率 → 明细折扣率联动
**触发条件**：用户直接修改总折扣率输入框
**联动行为**：
1. 检查输入的总折扣率是否低于权限下限
2. 同时检查当前页签所有明细折扣率的权限状态
3. 如果有明细折扣率低于权限下限，相应输入框显示红色背景警告

**示例场景**：
- 服务经理权限：40%下限
- 用户将总折扣率从45%改为35%
- 系统检查所有明细折扣率
- 结果：总折扣率和低于40%的明细折扣率都显示红色警告

## 🔧 技术实现

### 核心函数
```javascript
// 带联动检查的权限检查函数
function checkDiscountPermissionWithLinkage(inputElement) {
    // 1. 先检查当前输入框权限
    checkDiscountPermission(inputElement);
    
    // 2. 判断输入框类型并执行相应联动
    const isTotalDiscountInput = inputElement.id && inputElement.id.includes('TotalDiscount');
    
    if (isTotalDiscountInput) {
        // 总折扣率变化 → 检查所有明细折扣率
        // ...联动检查逻辑
    } else {
        // 明细折扣率变化 → 延迟检查总折扣率
        // ...联动检查逻辑
    }
}
```

### 集成点
1. **事件监听器**：所有折扣率输入框的input事件
2. **计算函数**：`calculateAndUpdateTotalDiscountRate()`函数末尾
3. **页面初始化**：页面加载时的初始检查

## 🧪 测试场景

### 场景1：明细→总折扣率联动
1. 登录销售总监账号(权限35%)
2. 打开批价单编辑页面
3. 将某个产品明细折扣率从40%改为30%
4. **预期**：总折扣率重新计算，如果结果<35%则显示红色警告

### 场景2：总折扣率→明细联动
1. 登录服务经理账号(权限40%)
2. 打开批价单编辑页面
3. 直接修改总折扣率输入框为35%
4. **预期**：总折扣率显示红色警告，所有<40%的明细也显示红色警告

### 场景3：权限恢复联动
1. 继续上述场景
2. 将总折扣率改回45%
3. **预期**：总折扣率警告消失，但明细中仍<40%的继续显示警告

## 🎨 视觉反馈

### 警告状态
- **背景色**：红色 (#dc3545)
- **文字颜色**：白色
- **边框**：红色
- **实时性**：输入时立即响应

### 正常状态
- **样式**：恢复默认Bootstrap输入框样式
- **响应**：移除警告样式，显示正常状态

## 📋 测试检查清单

### 明细→总折扣率联动
- [ ] 明细折扣率下调，总折扣率自动计算并检查权限
- [ ] 多个明细同时修改，总折扣率正确联动
- [ ] 明细折扣率提升，总折扣率警告及时清除

### 总折扣率→明细联动
- [ ] 总折扣率下调，所有明细重新检查权限
- [ ] 总折扣率提升，明细权限状态正确更新
- [ ] 不同页签（批价单/结算单）分别联动

### 权限边界测试
- [ ] 刚好等于权限下限时不显示警告
- [ ] 刚好低于权限下限时立即显示警告
- [ ] 跨越权限边界时警告状态正确切换

## ⚡ 性能优化

### 延迟检查
- 明细→总折扣率联动使用100ms延迟，确保计算完成
- 避免频繁的DOM操作和重复计算

### 函数复用
- 复用现有的`checkDiscountPermission()`函数
- 统一的权限检查逻辑，降低维护成本

## 🔍 调试信息
系统会在浏览器控制台输出联动检查的调试信息：
- `总折扣率变化，已联动检查pricing表格所有明细折扣率权限`
- `明细折扣率变化，已联动检查pricing总折扣率权限`

## 📝 注意事项
1. 联动检查只影响视觉提示，不阻止用户输入
2. 权限检查是实时的，不需要保存或提交
3. 联动检查支持批价单和结算单两个页签
4. 移动端和桌面端输入框都支持联动检查 