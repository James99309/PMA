# å¾…å®¡æ‰¹æ•°é‡é€»è¾‘é”™è¯¯ä¿®å¤æ–¹æ¡ˆ

## ğŸ” é—®é¢˜è¯Šæ–­

å‘ç° `app/helpers/approval_helpers.py` æ–‡ä»¶ä¸­å­˜åœ¨ **ä¸¤ä¸ªé‡å¤çš„ `get_pending_approval_count` å‡½æ•°å®šä¹‰**ï¼š

1. **ç¬¬678è¡Œ** - æ—§ç‰ˆå®ç°ï¼ˆæ•ˆç‡ä½ï¼Œå¯èƒ½æœ‰é€»è¾‘é”™è¯¯ï¼‰
2. **ç¬¬3085è¡Œ** - æ–°ç‰ˆå®ç°ï¼ˆæ•ˆç‡é«˜ï¼Œé€»è¾‘æ›´å‡†ç¡®ï¼‰

è¿™ç§é‡å¤å®šä¹‰å¯èƒ½å¯¼è‡´ï¼š
- Python ä½¿ç”¨åå®šä¹‰çš„å‡½æ•°ï¼ˆç¬¬3085è¡Œï¼‰ï¼Œä½†ä»£ç é€»è¾‘ä¸ä¸€è‡´
- ä¸åŒæŸ¥è¯¢æ–¹æ³•å¯èƒ½è¿”å›ä¸åŒç»“æœ
- å®¡æ‰¹ä¸­å¿ƒæç¤ºæ•°å­—ä¸å‡†ç¡®

## ğŸ”§ æ ¹æœ¬åŸå› åˆ†æ

### æ—§ç‰ˆå®ç°çš„é—®é¢˜ï¼ˆç¬¬678è¡Œï¼‰ï¼š
```python
# é€ä¸ªæ£€æŸ¥æ¯ä¸ªå®¡æ‰¹å®ä¾‹ï¼Œæ•ˆç‡ä½
for instance in query.all():
    current_step = get_current_step_info(instance)
    if current_step and current_step.approver_user_id == user_id:
        pending_instance_ids.append(instance.id)
```

### æ–°ç‰ˆå®ç°çš„ä¼˜åŠ¿ï¼ˆç¬¬3085è¡Œï¼‰ï¼š
```python
# ä½¿ç”¨SQLè¿æ¥æŸ¥è¯¢ï¼Œæ•ˆç‡é«˜ä¸”å‡†ç¡®
general_count = ApprovalInstance.query.join(
    ApprovalStep, 
    and_(
        ApprovalStep.process_id == ApprovalInstance.process_id,
        ApprovalStep.step_order == ApprovalInstance.current_step
    )
).filter(
    ApprovalStep.approver_user_id == user_id,
    ApprovalInstance.status == ApprovalStatus.PENDING
).count()
```

## ğŸ› ï¸ ä¿®å¤æ–¹æ¡ˆ

### æ–¹æ¡ˆ1ï¼šåˆ é™¤é‡å¤å‡½æ•°ï¼ˆæ¨èï¼‰

åˆ é™¤ç¬¬678-772è¡Œçš„æ—§ç‰ˆå‡½æ•°å®šä¹‰ï¼Œä¿ç•™ç¬¬3085è¡Œçš„æ–°ç‰ˆå®ç°ã€‚

### æ–¹æ¡ˆ2ï¼šè¿è¡Œè¯Šæ–­è„šæœ¬

ä½¿ç”¨æä¾›çš„è¯Šæ–­è„šæœ¬æ£€æŸ¥ç‰¹å®šç”¨æˆ·çš„å·®å¼‚ï¼š

```bash
cd /Users/nijie/Documents/PMA
python å¾…å®¡æ‰¹æ•°é‡è¯Šæ–­è„šæœ¬.py linwengguan
```

## ğŸ” è¯Šæ–­ç»“æœåˆ†æ

è¯Šæ–­è„šæœ¬ä¼šæ¯”è¾ƒä¸¤ç§å®ç°çš„ç»“æœï¼š

1. **é€šç”¨å®¡æ‰¹ç³»ç»Ÿ**ï¼š
   - æ—§æ–¹æ³•ï¼šé€ä¸ªæ£€æŸ¥å®¡æ‰¹å®ä¾‹
   - æ–°æ–¹æ³•ï¼šSQLè¿æ¥æŸ¥è¯¢

2. **æ‰¹ä»·å•å®¡æ‰¹ç³»ç»Ÿ**ï¼š
   - æ—§æ–¹æ³•ï¼š`action IS NULL`
   - æ–°æ–¹æ³•ï¼š`step_order = current_approval_step`

3. **å¯èƒ½çš„å·®å¼‚åŸå› **ï¼š
   - å®¡æ‰¹æ­¥éª¤çŠ¶æ€ä¸åŒæ­¥
   - æ•°æ®åº“è®°å½•ä¸ä¸€è‡´
   - æŸ¥è¯¢é€»è¾‘ä¸åŒ

## ğŸ”§ ç«‹å³ä¿®å¤è„šæœ¬

```python
# ä¸´æ—¶ä¿®å¤ï¼šå¼ºåˆ¶ä½¿ç”¨æ–°ç‰ˆå®ç°
import app.helpers.approval_helpers as ah

# ä¿å­˜æ—§å‡½æ•°çš„å¼•ç”¨
old_get_pending_approval_count = ah.get_pending_approval_count

def fixed_get_pending_approval_count(user_id=None):
    """ä¿®å¤åçš„å¾…å®¡æ‰¹æ•°é‡ç»Ÿè®¡ - å¼ºåˆ¶ä½¿ç”¨æ–°ç‰ˆé€»è¾‘"""
    if user_id is None:
        from flask_login import current_user
        if not current_user.is_authenticated:
            return 0
        user_id = current_user.id
    
    from app.models.approval import ApprovalInstance, ApprovalStatus, ApprovalStep
    from app.models.pricing_order import PricingOrder, PricingOrderApprovalRecord
    from app.models.inventory import PurchaseOrder
    from sqlalchemy import and_
    
    # æ–¹æ³•ï¼šä½¿ç”¨æ–°ç‰ˆè¿æ¥æŸ¥è¯¢
    general_count = ApprovalInstance.query.join(
        ApprovalStep, 
        and_(
            ApprovalStep.process_id == ApprovalInstance.process_id,
            ApprovalStep.step_order == ApprovalInstance.current_step
        )
    ).filter(
        ApprovalStep.approver_user_id == user_id,
        ApprovalInstance.status == ApprovalStatus.PENDING
    ).count()
    
    # æ‰¹ä»·å•å®¡æ‰¹æ•°é‡
    pricing_order_count = 0
    try:
        pricing_order_count = PricingOrder.query.join(
            PricingOrderApprovalRecord,
            and_(
                PricingOrderApprovalRecord.pricing_order_id == PricingOrder.id,
                PricingOrderApprovalRecord.step_order == PricingOrder.current_approval_step
            )
        ).filter(
            PricingOrderApprovalRecord.approver_id == user_id,
            PricingOrder.status == 'pending'
        ).count()
    except Exception as e:
        pricing_order_count = 0
    
    # è®¢å•å®¡æ‰¹æ•°é‡
    order_count = 0
    try:
        order_count = PurchaseOrder.query.join(
            ApprovalInstance,
            and_(
                ApprovalInstance.object_type == 'purchase_order',
                ApprovalInstance.object_id == PurchaseOrder.id,
                ApprovalInstance.status == ApprovalStatus.PENDING
            )
        ).join(
            ApprovalStep,
            and_(
                ApprovalStep.process_id == ApprovalInstance.process_id,
                ApprovalStep.step_order == ApprovalInstance.current_step
            )
        ).filter(
            ApprovalStep.approver_user_id == user_id
        ).count()
    except Exception as e:
        order_count = 0
    
    total = general_count + pricing_order_count + order_count
    print(f"ğŸ”§ ä¿®å¤åç»Ÿè®¡ - ç”¨æˆ· {user_id}: é€šç”¨ {general_count} + æ‰¹ä»·å• {pricing_order_count} + è®¢å• {order_count} = {total}")
    
    return total

# æ›¿æ¢å‡½æ•°
ah.get_pending_approval_count = fixed_get_pending_approval_count

print("âœ… å¾…å®¡æ‰¹æ•°é‡ç»Ÿè®¡å‡½æ•°å·²ä¿®å¤ï¼Œä½¿ç”¨æ–°ç‰ˆé€»è¾‘")
```

## ğŸ“‹ éªŒè¯æ­¥éª¤

1. **è¿è¡Œè¯Šæ–­è„šæœ¬**ï¼š
   ```bash
   python å¾…å®¡æ‰¹æ•°é‡è¯Šæ–­è„šæœ¬.py linwengguan
   ```

2. **æŸ¥çœ‹ç»“æœå¯¹æ¯”**ï¼š
   - æ£€æŸ¥æ˜¯å¦å­˜åœ¨æ•°é‡å·®å¼‚
   - åˆ†æå·®å¼‚çš„å…·ä½“åŸå› 

3. **åº”ç”¨ä¿®å¤**ï¼š
   - åˆ é™¤é‡å¤å‡½æ•°å®šä¹‰
   - æˆ–è€…ä½¿ç”¨ä¸´æ—¶ä¿®å¤è„šæœ¬

4. **éªŒè¯ä¿®å¤æ•ˆæœ**ï¼š
   - é‡æ–°æ£€æŸ¥å¾…å®¡æ‰¹æ•°é‡
   - ç¡®è®¤å®¡æ‰¹ä¸­å¿ƒæ˜¾ç¤ºæ­£ç¡®

## ğŸ¯ é•¿æœŸè§£å†³æ–¹æ¡ˆ

1. **ä»£ç é‡æ„**ï¼š
   - åˆ é™¤ç¬¬678-772è¡Œçš„é‡å¤å‡½æ•°
   - ç»Ÿä¸€ä½¿ç”¨ç¬¬3085è¡Œçš„é«˜æ•ˆå®ç°

2. **æ•°æ®ä¸€è‡´æ€§æ£€æŸ¥**ï¼š
   - æ£€æŸ¥å®¡æ‰¹æ­¥éª¤çŠ¶æ€åŒæ­¥
   - ä¿®å¤å¯èƒ½çš„æ•°æ®ä¸ä¸€è‡´

3. **å•å…ƒæµ‹è¯•**ï¼š
   - ä¸ºå¾…å®¡æ‰¹æ•°é‡ç»Ÿè®¡æ·»åŠ æµ‹è¯•
   - ç¡®ä¿é€»è¾‘æ­£ç¡®æ€§

4. **æ€§èƒ½ä¼˜åŒ–**ï¼š
   - ä¼˜åŒ–SQLæŸ¥è¯¢
   - æ·»åŠ å¿…è¦çš„æ•°æ®åº“ç´¢å¼•

## ğŸš¨ æ³¨æ„äº‹é¡¹

- ä¿®å¤å‰å»ºè®®å¤‡ä»½æ•°æ®åº“
- å…ˆåœ¨æµ‹è¯•ç¯å¢ƒéªŒè¯ä¿®å¤æ•ˆæœ
- ç›‘æ§ä¿®å¤åçš„æ€§èƒ½è¡¨ç°
- ç¡®ä¿ä¸å½±å“å…¶ä»–å®¡æ‰¹åŠŸèƒ½ 