# 批价单审批拒绝后重新发起功能实现

## 🎯 功能需求
**用户反馈**：批价单审批拒绝后应该允许重新发起，在发起前应该清除之前的流程，提交后清除之前的流程，重新开始新的审批流程。

## ✅ 已实现的功能

### 1. 后端服务逻辑修改

**文件**: `app/services/pricing_order_service.py`

**修改内容**：
```python
# 修改前：只允许草稿状态提交审批
if pricing_order.status != 'draft':
    return False, "只有草稿状态的批价单可以提交审批"

# 修改后：允许草稿和被拒绝状态提交审批  
if pricing_order.status not in ['draft', 'rejected']:
    return False, "只有草稿状态或被拒绝的批价单可以提交审批"
```

**关键特性**：
- ✅ **清理旧的审批记录**：重新提交时自动删除所有之前的审批记录
- ✅ **生成新的审批流程**：基于当前项目信息重新生成审批步骤
- ✅ **重置审批状态**：将状态从 `rejected` 变更为 `pending`
- ✅ **重新锁定相关对象**：重新锁定项目和报价单

### 2. 前端界面增强

**文件**: `app/templates/pricing_order/edit_pricing_order.html`

**新增UI组件**：
```html
{% elif pricing_order.status == 'rejected' %}
<!-- 被拒绝状态：显示重新发起审批按钮 -->
<div class="submit-approval-section">
    <div class="alert alert-danger">
        <i class="fas fa-times-circle"></i>
        批价单审批已被拒绝，您可以修改后重新发起审批。
    </div>
    <div class="action-buttons">
        {{ render_button('保存批价单', type='button', color='primary', icon='fas fa-save', attrs='id="savePricingOrderBtn"') }}
        {{ render_button('重新发起审批', type='button', color='info', icon='fas fa-redo', attrs='id="resubmitApprovalBtn"') }}
    </div>
</div>
```

**关键特性**：
- ✅ **清晰的状态提示**：红色警告框显示审批已被拒绝
- ✅ **双重操作选项**：可以先保存修改，也可以直接重新发起审批
- ✅ **图标和颜色**：使用redo图标和info颜色区分普通提交

### 3. JavaScript功能实现

**新增函数**: `resubmitForApproval()`

**功能特点**：
```javascript
function resubmitForApproval() {
    // 1. 验证渠道信息
    const validationResult = validateChannelInfo();
    
    // 2. 用户确认
    if (!confirm('确定要重新发起审批吗？这将清除之前的审批记录并开始新的审批流程。')) {
        return;
    }
    
    // 3. 收集数据并提交
    const submitData = {
        basic_info: window.pricingOrderCache || {},
        pricing_details: collectPricingDetails()
    };
    
    // 4. 调用相同的提交接口
    fetch(`/pricing_order/${PRICING_ORDER_ID}/save_and_submit`, {
        // ... 与普通提交相同的逻辑
    });
}
```

**关键特性**：
- ✅ **复用现有逻辑**：使用相同的验证、数据收集和提交流程
- ✅ **明确的用户提示**：确认对话框说明将清除之前的审批记录
- ✅ **状态反馈**：按钮状态变更和成功/失败提示
- ✅ **自动跳转**：成功后跳转到审批中心

## 🔄 工作流程

### 完整的拒绝-重新发起流程

1. **审批被拒绝**
   - 审批人点击"拒绝"
   - 批价单状态变为 `rejected`
   - 相关对象解锁

2. **用户修改批价单**
   - 在拒绝状态下，创建者可以编辑产品明细
   - 可以调整折扣率、数量等信息
   - 可以保存修改

3. **重新发起审批**
   - 点击"重新发起审批"按钮
   - 系统提示将清除之前的审批记录
   - 用户确认后开始重新提交

4. **清理和重建流程**
   - 自动删除所有旧的审批记录
   - 基于当前项目信息重新生成审批步骤
   - 状态变更为 `pending`
   - 重新锁定相关对象
   - 重置当前审批步骤为第1步

5. **新的审批流程开始**
   - 第一步审批人收到新的审批任务
   - 完全独立的新审批流程
   - 之前的拒绝记录被清除，不影响新流程

## 📱 用户体验特点

### 界面状态变化

**草稿状态**：
```
[保存批价单] [提交审批]
```

**审批中状态**：
```
[召回批价单]
```

**被拒绝状态**：
```
[保存批价单] [重新发起审批]  ← 新增
```

**审批通过状态**：
```
(无操作按钮)
```

### 视觉区分

- **拒绝状态提示**：红色警告框 + 拒绝图标
- **重新发起按钮**：蓝色按钮 + redo图标
- **明确的操作说明**：提示用户可以修改后重新发起

## 🔒 安全和权限

### 权限控制
- ✅ **创建者权限**：只有批价单创建者可以重新发起审批
- ✅ **状态检查**：只有 `rejected` 状态的批价单才显示重新发起按钮
- ✅ **数据验证**：重新提交时进行完整的数据验证

### 数据完整性
- ✅ **审批记录清理**：完全删除旧的审批记录，避免数据混乱
- ✅ **状态同步**：确保批价单、项目和报价单状态的一致性
- ✅ **锁定机制**：重新启动审批时正确锁定相关对象

## 🧪 测试要点

### 功能测试
- [ ] 被拒绝的批价单显示正确的界面
- [ ] 重新发起审批按钮正常工作
- [ ] 旧的审批记录被正确清除
- [ ] 新的审批流程正确生成
- [ ] 相关对象的锁定状态正确

### 边界测试
- [ ] 非创建者无法看到重新发起按钮
- [ ] 非rejected状态不显示重新发起按钮
- [ ] 网络错误时的错误处理
- [ ] 重复点击的防护

### 流程测试
- [ ] 拒绝 → 修改 → 重新发起 → 审批通过
- [ ] 拒绝 → 重新发起 → 再次拒绝 → 再次重新发起
- [ ] 多次拒绝和重新发起的记录完整性

## 📊 预期效果

### 业务流程改进
1. **提高效率**：被拒绝的批价单无需重新创建
2. **保持连续性**：可以在原有基础上修改和完善
3. **减少重复工作**：复用已有的产品明细和基本信息

### 用户体验提升
1. **操作直观**：清晰的状态提示和操作按钮
2. **反馈及时**：实时的状态更新和结果反馈
3. **流程透明**：明确告知将清除旧记录并开始新流程

### 系统稳定性
1. **数据一致性**：彻底清除旧记录避免混乱
2. **状态同步**：确保所有相关对象状态正确
3. **权限安全**：严格的权限控制和状态检查

## 🔗 相关功能

该功能与以下现有功能完美集成：
- ✅ **召回功能**：审批中状态的召回操作
- ✅ **管理员退回**：管理员强制退回已通过的审批
- ✅ **折扣权限控制**：重新发起时继续应用折扣权限检查
- ✅ **联动检查**：明细折扣率和总折扣率的联动提示

这样就形成了完整的批价单生命周期管理体系！ 