# æ‰¹ä»·å•å°è®¡è®¡ç®—ç›´æ¥ä¿®å¤æ–¹æ¡ˆ

## é—®é¢˜åˆ†æ

æ ¹æ®æ‚¨çš„æˆªå›¾å’Œæˆ‘çš„ä»£ç åˆ†æï¼Œé—®é¢˜åœ¨äºè°ƒæ•´æ€»æŠ˜æ‰£ç‡åï¼Œå°è®¡æ²¡æœ‰æ­£ç¡®è®¡ç®—æ•°é‡ã€‚è™½ç„¶å•ä»·è®¡ç®—æ˜¯æ­£ç¡®çš„ï¼Œä½†å°è®¡æ˜¾ç¤ºé”™è¯¯ã€‚

## æ ¹æœ¬åŸå› 

ç»è¿‡è¯Šæ–­è„šæœ¬éªŒè¯ï¼Œè®¡ç®—é€»è¾‘æœ¬èº«æ˜¯æ­£ç¡®çš„ï¼Œé—®é¢˜å¯èƒ½åœ¨äºï¼š

1. **æ•°é‡è·å–ä¸ç¨³å®š**ï¼š`getQuantityValue` å‡½æ•°å¯èƒ½åœ¨æŸäº›æƒ…å†µä¸‹è¿”å›äº†é”™è¯¯çš„å€¼
2. **DOMæ›´æ–°æ—¶æœº**ï¼šå°è®¡æ›´æ–°å¯èƒ½åœ¨æ•°é‡å­—æ®µæ›´æ–°ä¹‹å‰æ‰§è¡Œ
3. **æ ¼å¼åŒ–é—®é¢˜**ï¼š`formatNumber` å‡½æ•°å¯èƒ½å½±å“äº†æ˜¾ç¤º

## ç›´æ¥ä¿®å¤æ–¹æ¡ˆ

### æ–¹æ¡ˆ1ï¼šç®€åŒ–æ•°é‡è·å–é€»è¾‘

åœ¨ `updateTotalDiscount` å‡½æ•°ä¸­ï¼Œä¸ä½¿ç”¨ `getQuantityValue`ï¼Œç›´æ¥è·å–æ•°é‡ï¼š

```javascript
// æ›¿æ¢è¿™è¡Œï¼š
const quantity = getQuantityValue($row); 

// æ”¹ä¸ºï¼š
const quantity = parseInt($row.find('.quantity').val()) || 1;
console.log(`ç›´æ¥è·å–æ•°é‡: äº§å“=${productName}, æ•°é‡=${quantity}`);
```

### æ–¹æ¡ˆ2ï¼šå¼ºåˆ¶é‡æ–°è®¡ç®—å°è®¡

åœ¨ `updateTotalDiscount` å‡½æ•°çš„æ¯è¡Œå¤„ç†æœ€åï¼Œæ·»åŠ å¼ºåˆ¶é‡æ–°è®¡ç®—ï¼š

```javascript
// åœ¨æ›´æ–°å°è®¡æ˜¾ç¤ºåï¼Œæ·»åŠ ï¼š
// å¼ºåˆ¶é‡æ–°è®¡ç®—å°è®¡ä»¥ç¡®ä¿æ­£ç¡®
setTimeout(() => {
    calculateSubtotal($row);
}, 10);
```

### æ–¹æ¡ˆ3ï¼šæ·»åŠ è¯¦ç»†è°ƒè¯•ä¿¡æ¯

åœ¨ `updateTotalDiscount` å‡½æ•°ä¸­æ·»åŠ æ›´è¯¦ç»†çš„è°ƒè¯•ï¼š

```javascript
console.log(`è¡Œè®¡ç®—è¯¦ç»†è°ƒè¯•:`);
console.log(`  äº§å“: ${productName}`);
console.log(`  å¸‚åœºä»·: ${marketPrice} (æ¥æº: ${$row.find('.product-price').data('raw-value')})`);
console.log(`  æ•°é‡è¾“å…¥æ¡†å€¼: "${$row.find('.quantity').val()}"`);
console.log(`  æ•°é‡è§£æå€¼: ${quantity}`);
console.log(`  æŠ˜æ‰£ç‡: ${discountRate}`);
console.log(`  è®¡ç®—å•ä»·: ${marketPrice} Ã— ${discountRate} = ${newUnitPrice}`);
console.log(`  è®¡ç®—å°è®¡: ${newUnitPrice} Ã— ${quantity} = ${newSubtotal}`);
console.log(`  æ ¼å¼åŒ–å°è®¡: ${formatNumber(newSubtotal)}`);
```

## æ¨èçš„å®Œæ•´ä¿®å¤ä»£ç 

å°† `updateTotalDiscount` å‡½æ•°ä¸­çš„æ ¸å¿ƒè®¡ç®—éƒ¨åˆ†æ›¿æ¢ä¸ºï¼š

```javascript
// åªå¤„ç†æœ‰äº§å“åç§°çš„è¡Œ
if (productName && productName.trim()) {
    // è·å–å¸‚åœºä»·
    const marketPrice = parseFloat($row.find('.product-price').data('raw-value')) || 0;
    
    // ğŸ”¥ ç›´æ¥è·å–æ•°é‡ï¼Œä¸ä½¿ç”¨å¤æ‚çš„å‡½æ•°
    let quantityValue = $row.find('.quantity').val();
    const quantity = parseInt(quantityValue) || 1;
    
    console.log(`=== è¡Œè®¡ç®—å¼€å§‹ ===`);
    console.log(`äº§å“: ${productName}`);
    console.log(`å¸‚åœºä»·: ${marketPrice}`);
    console.log(`æ•°é‡è¾“å…¥æ¡†å€¼: "${quantityValue}"`);
    console.log(`æ•°é‡è§£æå€¼: ${quantity}`);
    console.log(`æŠ˜æ‰£ç‡: ${discountRate * 100}%`);
    
    // è®¡ç®—æ–°çš„å•ä»·å’Œå°è®¡
    const newUnitPrice = marketPrice * discountRate;
    const newSubtotal = newUnitPrice * quantity;
    
    console.log(`è®¡ç®—å•ä»·: ${marketPrice} Ã— ${discountRate} = ${newUnitPrice}`);
    console.log(`è®¡ç®—å°è®¡: ${newUnitPrice} Ã— ${quantity} = ${newSubtotal}`);
    
    // æ›´æ–°æŠ˜æ‰£ç‡æ˜¾ç¤ºï¼ˆä¿ç•™ä¸€ä½å°æ•°ï¼‰
    $row.find('.discount-rate').val((discountRate * 100).toFixed(1));
    
    // æ›´æ–°å•ä»·æ˜¾ç¤º
    const formattedUnitPrice = formatNumber(newUnitPrice);
    $row.find('.discounted-price')
        .val(formattedUnitPrice)
        .data('raw-value', newUnitPrice);
    
    // æ›´æ–°å°è®¡æ˜¾ç¤º
    const formattedSubtotal = formatNumber(newSubtotal);
    $row.find('.subtotal')
        .val(formattedSubtotal)
        .data('raw-value', newSubtotal);
    
    console.log(`å•ä»·æ˜¾ç¤º: ${formattedUnitPrice}`);
    console.log(`å°è®¡æ˜¾ç¤º: ${formattedSubtotal}`);
    console.log(`=== è¡Œè®¡ç®—ç»“æŸ ===`);
    
    // åŒæ­¥åˆ°ç§»åŠ¨ç«¯å¡ç‰‡ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
    const detailId = $row.data('detail-id');
    if (detailId) {
        const $mobileCard = $(`.mobile-product-card[data-detail-id="${detailId}"]`);
        if ($mobileCard.length) {
            $mobileCard.find('.discount-rate').val((discountRate * 100).toFixed(1));
            $mobileCard.find('.discounted-price')
                .val(formattedUnitPrice)
                .data('raw-value', newUnitPrice);
            $mobileCard.find('.subtotal')
                .val(formattedSubtotal)
                .data('raw-value', newSubtotal);
        }
    }
}
```

## æµ‹è¯•éªŒè¯

ä¿®å¤åï¼Œè¯·ï¼š

1. åˆ·æ–°æ‰¹ä»·å•ç¼–è¾‘é¡µé¢
2. æ‰“å¼€æµè§ˆå™¨å¼€å‘è€…å·¥å…·ï¼ˆF12ï¼‰
3. è°ƒæ•´æ€»æŠ˜æ‰£ç‡
4. æŸ¥çœ‹æ§åˆ¶å°è¾“å‡ºï¼Œç¡®è®¤æ¯è¡Œçš„è®¡ç®—è¿‡ç¨‹
5. éªŒè¯å°è®¡æ˜¯å¦æ­£ç¡®æ˜¾ç¤º

## é¢„æœŸç»“æœ

ä¿®å¤åï¼Œæ‚¨åº”è¯¥çœ‹åˆ°ï¼š
- æ™ºèƒ½å…‰çº¤è¿œç«¯æœºï¼š7 Ã— 5368.50 = 37,579.52
- è¶…é€šå®¤å†…å…¨å‘é¡¶å¤©çº¿ï¼š200 Ã— 64.33 = 12,866.00
- ä¸‹è¡Œä¿¡å·æµ‹å™¨ï¼š1 Ã— 2069.76 = 2,069.76

## å¦‚æœä»æœ‰é—®é¢˜

å¦‚æœä¿®å¤åä»æœ‰é—®é¢˜ï¼Œå¯èƒ½éœ€è¦æ£€æŸ¥ï¼š

1. **HTMLç»“æ„**ï¼šç¡®è®¤æ•°é‡è¾“å…¥æ¡†çš„classåç§°æ˜¯å¦ä¸º `quantity`
2. **åˆå§‹åŒ–**ï¼šç¡®è®¤é¡µé¢åŠ è½½æ—¶æ•°é‡å­—æ®µæ˜¯å¦æœ‰æ­£ç¡®çš„å€¼
3. **äº‹ä»¶å†²çª**ï¼šæ˜¯å¦æœ‰å…¶ä»–JavaScriptä»£ç å¹²æ‰°äº†è®¡ç®—

è¯·å‘Šè¯‰æˆ‘ä¿®å¤ç»“æœï¼Œä»¥ä¾¿è¿›ä¸€æ­¥ä¼˜åŒ–ã€‚ 