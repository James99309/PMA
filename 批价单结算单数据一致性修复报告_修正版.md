# æ‰¹ä»·å•ç»“ç®—å•æ•°æ®ä¸€è‡´æ€§ä¿®å¤æŠ¥å‘Šï¼ˆä¿®æ­£ç‰ˆï¼‰

## ğŸ“‹ é—®é¢˜é‡æ–°åˆ†æ

ç”¨æˆ·æŒ‡å‡ºäº†æˆ‘åˆå§‹æ–¹æ¡ˆçš„é”™è¯¯ï¼š**æ‰¹ä»·å•é€€å›/å¬å›åï¼Œåº”è¯¥é‡ç½®ç»“ç®—å•çš„å®¡æ‰¹çŠ¶æ€æ ‡è®°ï¼Œè€Œä¸æ˜¯åˆ é™¤æ•°æ®**ã€‚

### âœ… æ­£ç¡®çš„ä¸šåŠ¡é€»è¾‘

1. **ç»“ç®—æ¨¡å—åº”è¯¥åªæ˜¾ç¤ºå·²å®¡æ‰¹é€šè¿‡çš„ç»“ç®—å•**ï¼ˆ`status = 'approved'`ï¼‰
2. **æ‰¹ä»·å•å¬å›/é€€å›/æ‹’ç»æ—¶ï¼Œåº”è¯¥å»é™¤å®¡æ‰¹é€šè¿‡æ ‡è®°**ï¼ˆå°†çŠ¶æ€é‡ç½®ä¸º `'draft'`ï¼‰
3. **ç»“ç®—å•æ•°æ®æœ¬èº«åº”è¯¥ä¿ç•™**ï¼Œåªæ˜¯ä¸åœ¨ç»“ç®—æ¨¡å—ä¸­æ˜¾ç¤º
4. **è‰ç¨¿çŠ¶æ€çš„ç»“ç®—å•ä»ç„¶å­˜åœ¨**ï¼Œç­‰å¾…é‡æ–°å®¡æ‰¹

## ğŸ” é‡æ–°åˆ†ææ•°æ®æµç¨‹

### æ­£å¸¸å®¡æ‰¹æµç¨‹
```
æ‰¹ä»·å•åˆ›å»º â†’ ç»“ç®—å•åˆ›å»ºï¼ˆstatus='draft'ï¼‰
     â†“
æ‰¹ä»·å•å®¡æ‰¹é€šè¿‡ â†’ ç»“ç®—å•çŠ¶æ€æ›´æ–°ï¼ˆstatus='approved'ï¼‰
     â†“
ç»“ç®—æ¨¡å—å¯è§ â†’ è¿›è¡Œå®é™…ç»“ç®—
```

### å¬å›/é€€å›/æ‹’ç»æµç¨‹
```
æ‰¹ä»·å•å¬å›/é€€å›/æ‹’ç» â†’ ç»“ç®—å•çŠ¶æ€é‡ç½®ï¼ˆstatus='draft'ï¼‰
     â†“
ç»“ç®—æ¨¡å—ä¸å¯è§ â†’ ç­‰å¾…é‡æ–°å®¡æ‰¹
```

## ğŸ”§ ä¿®æ­£çš„ä¿®å¤æ–¹æ¡ˆ

### 1. ä¿®æ­£çš„æ•°æ®æ¸…ç†å‡½æ•°

**é‡å‘½åå¹¶ä¿®æ­£åŠŸèƒ½**ï¼š`reset_settlement_approval_status()`

```python
@staticmethod
def reset_settlement_approval_status(pricing_order_id):
    """é‡ç½®ç»“ç®—å•å®¡æ‰¹çŠ¶æ€ï¼ˆè€Œä¸æ˜¯åˆ é™¤æ•°æ®ï¼‰"""
    try:
        from app.models.pricing_order import SettlementOrder, SettlementOrderDetail
        from app import db
        
        # é‡ç½®ç‹¬ç«‹ç»“ç®—å•çŠ¶æ€ä¸ºè‰ç¨¿
        settlement_order = SettlementOrder.query.filter_by(pricing_order_id=pricing_order_id).first()
        if settlement_order:
            settlement_order.status = 'draft'
            settlement_order.approved_by = None
            settlement_order.approved_at = None
        
        # é‡ç½®ç»“ç®—å•æ˜ç»†çš„ç»“ç®—çŠ¶æ€
        settlement_details = SettlementOrderDetail.query.filter_by(pricing_order_id=pricing_order_id).all()
        for detail in settlement_details:
            detail.settlement_status = 'pending'
            detail.settlement_date = None
            detail.settlement_notes = None
            
    except Exception as e:
        # è®°å½•é”™è¯¯ä½†ä¸é˜»æ–­ä¸»æµç¨‹
        from flask import current_app
        if current_app:
            current_app.logger.warning(f"é‡ç½®æ‰¹ä»·å• {pricing_order_id} ç»“ç®—çŠ¶æ€æ—¶å‡ºé”™: {str(e)}")
```

### 2. åº”ç”¨åˆ°ä¸‰ä¸ªåœºæ™¯

**å¬å›é€»è¾‘**ï¼š
```python
# é‡ç½®ç»“ç®—å•å®¡æ‰¹çŠ¶æ€ï¼ˆä¿ç•™æ•°æ®ï¼Œä»…é‡ç½®çŠ¶æ€ï¼‰
PricingOrderService.reset_settlement_approval_status(pricing_order_id)
```

**ç®¡ç†å‘˜é€€å›é€»è¾‘**ï¼š
```python
# é‡ç½®ç»“ç®—å•å®¡æ‰¹çŠ¶æ€ï¼ˆä¿ç•™æ•°æ®ï¼Œä»…é‡ç½®çŠ¶æ€ï¼‰
PricingOrderService.reset_settlement_approval_status(pricing_order_id)
```

**æ‹’ç»é€»è¾‘**ï¼š
```python
# é‡ç½®ç»“ç®—å•å®¡æ‰¹çŠ¶æ€ï¼ˆä¿ç•™æ•°æ®ï¼Œä»…é‡ç½®çŠ¶æ€ï¼‰
PricingOrderService.reset_settlement_approval_status(pricing_order_id)
```

## âœ… é¢„æœŸçš„æ•°æ®çŠ¶æ€

### ä¿®å¤åçš„æ•°æ®çŠ¶æ€

**æ‰¹ä»·å•çŠ¶æ€ä¸º 'approved'**ï¼š
- ç»“ç®—å•çŠ¶æ€ï¼š`'approved'` âœ…
- ç»“ç®—æ¨¡å—ï¼š**å¯è§** âœ…
- å¯è¿›è¡Œå®é™…ç»“ç®—æ“ä½œ âœ…

**æ‰¹ä»·å•çŠ¶æ€ä¸º 'draft' æˆ– 'rejected'**ï¼š
- ç»“ç®—å•çŠ¶æ€ï¼š`'draft'` âœ…  
- ç»“ç®—æ¨¡å—ï¼š**ä¸å¯è§** âœ…
- ç­‰å¾…é‡æ–°å®¡æ‰¹ âœ…

**æ‰¹ä»·å•çŠ¶æ€ä¸º 'pending'**ï¼š
- ç»“ç®—å•çŠ¶æ€ï¼š`'draft'` âœ…
- ç»“ç®—æ¨¡å—ï¼š**ä¸å¯è§** âœ…
- å®¡æ‰¹è¿‡ç¨‹ä¸­ä¸æ˜¾ç¤ºåœ¨ç»“ç®—æ¨¡å— âœ…

## ğŸ¯ ç»“ç®—æ¨¡å—è¿‡æ»¤é€»è¾‘

ç»“ç®—æ¨¡å—åº”è¯¥åªæ˜¾ç¤ºå·²å®¡æ‰¹é€šè¿‡çš„ç»“ç®—å•ï¼š

```python
# ç»“ç®—æ¨¡å—æŸ¥è¯¢é€»è¾‘
approved_settlements = SettlementOrder.query.filter_by(status='approved').all()
```

è¿™æ ·ç¡®ä¿ï¼š
1. åªæœ‰çœŸæ­£å®¡æ‰¹é€šè¿‡çš„æ‰¹ä»·å•å¯¹åº”çš„ç»“ç®—å•æ‰ä¼šåœ¨ç»“ç®—æ¨¡å—ä¸­æ˜¾ç¤º
2. å¬å›ã€é€€å›ã€æ‹’ç»çš„æ‰¹ä»·å•å¯¹åº”çš„ç»“ç®—å•ä¸ä¼šæ˜¾ç¤ºåœ¨ç»“ç®—æ¨¡å—
3. æ•°æ®å¾—åˆ°ä¿ç•™ï¼Œæ–¹ä¾¿é‡æ–°å®¡æ‰¹å’Œæ•°æ®è¿½æº¯

## ğŸ“ˆ æ­£ç¡®çš„ä¸šåŠ¡å«ä¹‰

### çŠ¶æ€å¯¹åº”å…³ç³»

| æ‰¹ä»·å•çŠ¶æ€ | ç»“ç®—å•çŠ¶æ€ | ç»“ç®—æ¨¡å—å¯è§æ€§ | ä¸šåŠ¡å«ä¹‰ |
|------------|------------|----------------|----------|
| `draft` | `draft` | âŒ ä¸å¯è§ | è‰ç¨¿é˜¶æ®µï¼Œå°šæœªæäº¤å®¡æ‰¹ |
| `pending` | `draft` | âŒ ä¸å¯è§ | å®¡æ‰¹ä¸­ï¼Œå°šæœªç¡®å®š |
| `approved` | `approved` | âœ… å¯è§ | å®¡æ‰¹é€šè¿‡ï¼Œå¯ä»¥è¿›è¡Œç»“ç®— |
| `rejected` | `draft` | âŒ ä¸å¯è§ | å·²æ‹’ç»ï¼Œéœ€è¦ä¿®æ”¹é‡æ–°å®¡æ‰¹ |

### æ•°æ®å®Œæ•´æ€§

âœ… **æ•°æ®ä¿ç•™**ï¼šæ‰€æœ‰ç»“ç®—å•æ•°æ®éƒ½è¢«ä¿ç•™ï¼Œä¾¿äºï¼š
- é‡æ–°æäº¤å®¡æ‰¹
- æ•°æ®è¿½æº¯å’Œå†å²æŸ¥è¯¢  
- å®¡è®¡å’Œåˆè§„è¦æ±‚

âœ… **çŠ¶æ€ä¸€è‡´æ€§**ï¼šç»“ç®—å•çŠ¶æ€ä¸æ‰¹ä»·å•çŠ¶æ€ä¿æŒé€»è¾‘ä¸€è‡´

âœ… **æƒé™æ§åˆ¶**ï¼šåªæœ‰å·²å®¡æ‰¹çš„æ•°æ®æ‰èƒ½åœ¨ç»“ç®—æ¨¡å—è¿›è¡Œæ“ä½œ

## ğŸ”„ å®Œæ•´çš„ç”Ÿå‘½å‘¨æœŸ

```
1. åˆ›å»ºæ‰¹ä»·å• â†’ åˆ›å»ºç»“ç®—å•ï¼ˆstatus='draft'ï¼‰
2. æäº¤å®¡æ‰¹ â†’ ç»“ç®—å•ä¿æŒï¼ˆstatus='draft'ï¼‰
3. å®¡æ‰¹é€šè¿‡ â†’ ç»“ç®—å•æ›´æ–°ï¼ˆstatus='approved'ï¼‰â†’ ç»“ç®—æ¨¡å—å¯è§
4. å¦‚æœå¬å›/é€€å›/æ‹’ç» â†’ ç»“ç®—å•é‡ç½®ï¼ˆstatus='draft'ï¼‰â†’ ç»“ç®—æ¨¡å—ä¸å¯è§
5. é‡æ–°å®¡æ‰¹é€šè¿‡ â†’ ç»“ç®—å•å†æ¬¡æ›´æ–°ï¼ˆstatus='approved'ï¼‰â†’ ç»“ç®—æ¨¡å—å†æ¬¡å¯è§
```

## ğŸ¯ æ€»ç»“

**ä¿®æ­£çš„å…³é”®è®¤è¯†**ï¼š
1. âŒ ~~åˆ é™¤ç»“ç®—å•æ•°æ®~~ 
2. âœ… **é‡ç½®å®¡æ‰¹çŠ¶æ€æ ‡è®°**
3. âœ… **ä¿ç•™æ‰€æœ‰æ•°æ®ç”¨äºé‡æ–°å®¡æ‰¹**
4. âœ… **ç»“ç®—æ¨¡å—åªæ˜¾ç¤ºå·²å®¡æ‰¹é€šè¿‡çš„æ•°æ®**

æ„Ÿè°¢ç”¨æˆ·çš„çº æ­£ï¼Œè¿™ä¸ªä¿®æ­£ç‰ˆæ–¹æ¡ˆæ›´ç¬¦åˆå®é™…çš„ä¸šåŠ¡éœ€æ±‚å’Œæ•°æ®ç®¡ç†åŸåˆ™ã€‚

---

*ä¿®æ­£å®Œæˆæ—¶é—´ï¼š2025å¹´6æœˆ18æ—¥*  
*ä¿®æ­£äººå‘˜ï¼šAI Assistant*  
*éªŒè¯çŠ¶æ€ï¼šâœ… ä¸šåŠ¡é€»è¾‘æ­£ç¡®* 