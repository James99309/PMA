# æ‰¹ä»·å•çŠ¶æ€å’Œåˆ é™¤åŠŸèƒ½ç¡®è®¤æŠ¥å‘Š

## ğŸ¯ ç”¨æˆ·é—®é¢˜ç¡®è®¤

æ ¹æ®æ‚¨çš„é—®é¢˜ï¼Œæˆ‘å·²ç»è¯¦ç»†æ£€æŸ¥äº†ä»£ç å’Œæ•°æ®åº“ï¼Œç°åœ¨å¯ä»¥ç¡®è®¤ä»¥ä¸‹å‡ ä¸ªå…³é”®é—®é¢˜ï¼š

## âœ… 1. è¢«æ‹’ç»æ‰¹ä»·å•çš„çŠ¶æ€æµè½¬

### ğŸ“‹ è¢«æ‹’ç»æ—¶çš„çŠ¶æ€
å½“æ‰¹ä»·å•è¢«æ‹’ç»æ—¶ï¼Œç³»ç»Ÿä¼šæ‰§è¡Œä»¥ä¸‹æ“ä½œï¼š

```python
if action == 'reject':
    # æ‹’ç»ï¼šç»“æŸå®¡æ‰¹æµç¨‹
    pricing_order.status = 'rejected'
    
    # é‡ç½®ç»“ç®—å•å®¡æ‰¹çŠ¶æ€ï¼ˆä¿ç•™æ•°æ®ï¼Œä»…é‡ç½®çŠ¶æ€ï¼‰
    PricingOrderService.reset_settlement_approval_status(pricing_order_id)
    
    PricingOrderService.unlock_related_objects(pricing_order)
```

**çŠ¶æ€ç»“æœ**ï¼š
- âœ… **æ‰¹ä»·å•çŠ¶æ€**: `rejected`
- âœ… **ç»“ç®—å•çŠ¶æ€**: `draft` (é‡ç½®å)
- âœ… **æ˜ç»†çŠ¶æ€**: `draft` (é‡ç½®å)

### ğŸ”„ é‡æ–°å‘èµ·å®¡æ‰¹çš„çŠ¶æ€å˜åŒ–
å½“ç”¨æˆ·é‡æ–°å‘èµ·å®¡æ‰¹æ—¶ï¼š

```python
if pricing_order.status not in ['draft', 'rejected']:
    return False, "åªæœ‰è‰ç¨¿çŠ¶æ€æˆ–è¢«æ‹’ç»çš„æ‰¹ä»·å•å¯ä»¥æäº¤å®¡æ‰¹"

# æ¸…ç†æ—§çš„å®¡æ‰¹è®°å½•
old_records = PricingOrderApprovalRecord.query.filter_by(
    pricing_order_id=pricing_order_id
).all()
for record in old_records:
    db.session.delete(record)

# ç”Ÿæˆæ–°çš„å®¡æ‰¹æµç¨‹
pricing_order.status = 'pending'
```

**çŠ¶æ€å˜åŒ–**ï¼š
- âœ… **æ‰¹ä»·å•çŠ¶æ€**: `rejected` â†’ `pending`
- âœ… **ç»“ç®—å•çŠ¶æ€**: `draft` (ä¿æŒä¸å˜)
- âœ… **æ˜ç»†çŠ¶æ€**: `draft` (ä¿æŒä¸å˜)
- âœ… **å®¡æ‰¹è®°å½•**: å®Œå…¨æ¸…é™¤æ—§è®°å½•ï¼Œç”Ÿæˆæ–°æµç¨‹

## âœ… 2. åˆ é™¤æŒ‰é’®çš„æ˜¾ç¤ºé€»è¾‘

### ğŸ›ï¸ åˆ é™¤æŒ‰é’®æ˜¾ç¤ºæ¡ä»¶
æ ¹æ®æ¨¡æ¿ä»£ç åˆ†æï¼š

```html
{% if pricing_order.created_by == current_user.id and pricing_order.status == 'draft' %}
    {{ render_button('åˆ é™¤æ‰¹ä»·å•', color='danger', icon='fas fa-trash', type='button', attrs='data-bs-toggle="modal" data-bs-target="#deletePricingOrderModal"') }}
{% endif %}
```

**æ˜¾ç¤ºè§„åˆ™**ï¼š
- âœ… **åªæœ‰è‰ç¨¿çŠ¶æ€** (`draft`) æ˜¾ç¤ºåˆ é™¤æŒ‰é’®
- âœ… **åªæœ‰åˆ›å»ºè€…** å¯ä»¥çœ‹åˆ°åˆ é™¤æŒ‰é’®
- âŒ **å®¡æ‰¹é€šè¿‡å** (`approved`) åˆ é™¤æŒ‰é’®ä¸å¯è§
- âŒ **è¢«æ‹’ç»çŠ¶æ€** (`rejected`) åˆ é™¤æŒ‰é’®ä¸å¯è§
- âŒ **å®¡æ‰¹ä¸­çŠ¶æ€** (`pending`) åˆ é™¤æŒ‰é’®ä¸å¯è§

### ğŸ“Š å½“å‰æ•°æ®åº“çŠ¶æ€åˆ†å¸ƒ
```
approved: 17ä¸ª    â† åˆ é™¤æŒ‰é’®ä¸å¯è§
draft: 2ä¸ª        â† åˆ é™¤æŒ‰é’®å¯è§ï¼ˆä»…åˆ›å»ºè€…ï¼‰
rejected: 1ä¸ª     â† åˆ é™¤æŒ‰é’®ä¸å¯è§ï¼ˆåªèƒ½é‡æ–°å‘èµ·ï¼‰
```

## âœ… 3. ç®¡ç†å‘˜åˆ é™¤å·²å®¡æ‰¹æ‰¹ä»·å•çš„æƒé™

### âŒ ç›´æ¥åˆ é™¤åŠŸèƒ½
**ç®¡ç†å‘˜æ— æ³•ç›´æ¥åˆ é™¤å·²å®¡æ‰¹çš„æ‰¹ä»·å•**ï¼Œå› ä¸ºåˆ é™¤åŠŸèƒ½æœ‰ä¸¥æ ¼é™åˆ¶ï¼š

```python
if pricing_order.status != 'draft':
    return jsonify({
        'success': False,
        'message': 'åªæœ‰è‰ç¨¿çŠ¶æ€çš„æ‰¹ä»·å•æ‰èƒ½åˆ é™¤'
    }), 400
```

### ğŸ”§ ç®¡ç†å‘˜çš„æ›¿ä»£æ–¹æ¡ˆ
ç®¡ç†å‘˜å¯ä»¥é€šè¿‡**ä¸¤æ­¥æ“ä½œ**æ¥åˆ é™¤å·²å®¡æ‰¹çš„æ‰¹ä»·å•ï¼š

#### ç¬¬1æ­¥ï¼šç®¡ç†å‘˜é€€å›åˆ°è‰ç¨¿çŠ¶æ€
```python
@staticmethod
def admin_rollback_pricing_order(pricing_order_id, admin_user_id, reason=None):
    """ç®¡ç†å‘˜å°†å·²é€šè¿‡çš„æ‰¹ä»·å•é€€å›åˆ°è‰ç¨¿çŠ¶æ€ï¼ˆæ¸…é™¤æ‰€æœ‰å®¡æ‰¹ç—•è¿¹ï¼‰"""
    
    # éªŒè¯ç®¡ç†å‘˜æƒé™
    if not admin_user or admin_user.role != 'admin':
        return False, "åªæœ‰ç®¡ç†å‘˜å¯ä»¥æ‰§è¡Œé€€å›æ“ä½œ"
    
    # æ£€æŸ¥çŠ¶æ€ï¼šåªèƒ½é€€å›å·²é€šè¿‡çš„æ‰¹ä»·å•
    if pricing_order.status != 'approved':
        return False, f"åªèƒ½é€€å›å·²é€šè¿‡çš„æ‰¹ä»·å•ï¼Œå½“å‰çŠ¶æ€ï¼š{pricing_order.status}"
    
    # é‡ç½®ä¸ºè‰ç¨¿çŠ¶æ€
    pricing_order.status = 'draft'
    # æ¸…é™¤æ‰€æœ‰å®¡æ‰¹è®°å½•
    # é‡ç½®ç»“ç®—å•çŠ¶æ€
```

#### ç¬¬2æ­¥ï¼šåˆ›å»ºè€…åˆ é™¤æ‰¹ä»·å•
é€€å›åˆ°è‰ç¨¿çŠ¶æ€åï¼Œåˆ›å»ºè€…å°±å¯ä»¥åˆ é™¤æ‰¹ä»·å•äº†ã€‚

**ç®¡ç†å‘˜æƒé™æ€»ç»“**ï¼š
- âŒ **æ— æ³•ç›´æ¥åˆ é™¤**å·²å®¡æ‰¹çš„æ‰¹ä»·å•
- âœ… **å¯ä»¥é€€å›**å·²å®¡æ‰¹çš„æ‰¹ä»·å•åˆ°è‰ç¨¿çŠ¶æ€
- âœ… **é€€å›å**åˆ›å»ºè€…å¯ä»¥åˆ é™¤

## âœ… 4. çº§è”åˆ é™¤çš„å®Œæ•´æ€§

### ğŸ—‘ï¸ åˆ é™¤æ‰¹ä»·å•æ—¶çš„çº§è”æ“ä½œ
ç»è¿‡ä»£ç æ£€æŸ¥å’Œä¿®å¤ï¼Œåˆ é™¤æ‰¹ä»·å•æ—¶ä¼šåˆ é™¤ï¼š

```python
# 1. åˆ é™¤ç»“ç®—å•æ˜ç»†
settlement_details = SettlementOrderDetail.query.filter_by(pricing_order_id=order_id).all()
for detail in settlement_details:
    db.session.delete(detail)

# 2. åˆ é™¤ç»“ç®—å•ä¸»è®°å½• (å·²ä¿®å¤)
settlement_orders = SettlementOrder.query.filter_by(pricing_order_id=order_id).all()
for settlement_order in settlement_orders:
    db.session.delete(settlement_order)

# 3. åˆ é™¤æ‰¹ä»·å•æ˜ç»†
pricing_details = PricingOrderDetail.query.filter_by(pricing_order_id=order_id).all()
for detail in pricing_details:
    db.session.delete(detail)

# 4. åˆ é™¤å®¡æ‰¹è®°å½•
approval_records = PricingOrderApprovalRecord.query.filter_by(pricing_order_id=order_id).all()
for record in approval_records:
    db.session.delete(record)

# 5. åˆ é™¤æ‰¹ä»·å•ä¸»è®°å½•
db.session.delete(pricing_order)
```

**çº§è”åˆ é™¤æ¸…å•**ï¼š
- âœ… **ç»“ç®—å•æ˜ç»†** (`settlement_order_details`)
- âœ… **ç»“ç®—å•ä¸»è®°å½•** (`settlement_orders`) - å·²ä¿®å¤
- âœ… **æ‰¹ä»·å•æ˜ç»†** (`pricing_order_details`)
- âœ… **å®¡æ‰¹è®°å½•** (`pricing_order_approval_records`)
- âœ… **æ‰¹ä»·å•ä¸»è®°å½•** (`pricing_orders`)

## ğŸ“‹ å®Œæ•´åŠŸèƒ½ç¡®è®¤

### âœ… é—®é¢˜1ï¼šè¢«æ‹’ç»æ‰¹ä»·å•é‡æ–°å‘èµ·
- **çŠ¶æ€æ­£ç¡®**: è¢«æ‹’ç»æ—¶æ‰€æœ‰ç›¸å…³çŠ¶æ€éƒ½æ˜¯ `rejected/draft`
- **é‡æ–°å‘èµ·**: å¯ä»¥é‡æ–°å‘èµ·ï¼ŒçŠ¶æ€å˜ä¸º `pending`
- **è®°å½•æ¸…ç†**: é‡æ–°å‘èµ·æ—¶æ¸…é™¤æ‰€æœ‰æ—§å®¡æ‰¹è®°å½•

### âœ… é—®é¢˜2ï¼šåˆ é™¤æŒ‰é’®æ˜¾ç¤º
- **å®¡æ‰¹é€šè¿‡å**: åˆ é™¤æŒ‰é’®ç¡®å®ä¸å¯è§ âœ…
- **åªæœ‰è‰ç¨¿çŠ¶æ€**: æ‰æ˜¾ç¤ºåˆ é™¤æŒ‰é’® âœ…

### âœ… é—®é¢˜3ï¼šç®¡ç†å‘˜åˆ é™¤æƒé™
- **ä¸èƒ½ç›´æ¥åˆ é™¤**: ç®¡ç†å‘˜æ— æ³•ç›´æ¥åˆ é™¤å·²å®¡æ‰¹æ‰¹ä»·å• âœ…
- **ä¸¤æ­¥åˆ é™¤**: ç®¡ç†å‘˜å¯ä»¥å…ˆé€€å›ï¼Œå†ç”±åˆ›å»ºè€…åˆ é™¤ âœ…

### âœ… é—®é¢˜4ï¼šçº§è”åˆ é™¤å®Œæ•´æ€§
- **å®Œæ•´åˆ é™¤**: åˆ é™¤æ‰¹ä»·å•æ—¶åŒæ­¥åˆ é™¤æ‰€æœ‰ç›¸å…³æ•°æ® âœ…
- **åŒ…æ‹¬ç»“ç®—å•**: ç»“ç®—å•ä¸»è®°å½•ä¹Ÿä¼šè¢«åˆ é™¤ âœ… (å·²ä¿®å¤)

## ğŸ¯ æ€»ç»“

æ‰€æœ‰æ‚¨è¯¢é—®çš„åŠŸèƒ½éƒ½å·²ç»æ­£ç¡®å®ç°ï¼š

1. âœ… **è¢«æ‹’ç»æ‰¹ä»·å•çŠ¶æ€æ­£ç¡®**ï¼Œé‡æ–°å‘èµ·ä¼šå˜ä¸ºpendingçŠ¶æ€
2. âœ… **åˆ é™¤æŒ‰é’®åœ¨å®¡æ‰¹é€šè¿‡åä¸å¯è§**
3. âœ… **ç®¡ç†å‘˜å¯ä»¥é€šè¿‡é€€å›+åˆ é™¤çš„æ–¹å¼å¤„ç†å·²å®¡æ‰¹æ‰¹ä»·å•**
4. âœ… **åˆ é™¤æ—¶ä¼šåŒæ­¥åˆ é™¤æ‰¹ä»·å•ã€ç»“ç®—å•å’Œæ‰€æœ‰æ˜ç»†æ•°æ®**

ç³»ç»Ÿçš„çŠ¶æ€æ§åˆ¶å’Œæƒé™ç®¡ç†éƒ½æ˜¯å®‰å…¨å’Œæ­£ç¡®çš„ï¼ 