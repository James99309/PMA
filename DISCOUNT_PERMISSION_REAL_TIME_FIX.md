# æ‰¹ä»·å•å‘èµ·æ—¶å®æ—¶æŠ˜æ‰£æƒé™æ£€æŸ¥ä¿®å¤æ€»ç»“

## ğŸ¯ éœ€æ±‚æè¿°

1. **åœ¨å‘èµ·æ‰¹ä»·å•æ—¶å®æ—¶æ£€æŸ¥å‘èµ·äººçš„æŠ˜æ‰£æƒé™**ï¼Œç»™äºˆå³æ—¶çš„æƒé™æç¤º
2. **å–æ¶ˆå®¡æ‰¹æµç¨‹ä¸­çš„æƒé™è­¦å‘Šæç¤º**ï¼Œå› ä¸ºè¿™äº›æç¤ºåº”è¯¥åœ¨æ¨è¿›åˆ°ä¸‹ä¸€æ­¥æ—¶æ‰ç”Ÿæˆ
3. **ç§»é™¤å‘èµ·äººæŠ˜æ‰£ç‡æƒé™ç›¸å…³çš„æ–‡å­—æç¤ºå’Œç¬¦å·**

## âœ… å·²å®Œæˆçš„ä¿®å¤

### 1. ç§»é™¤å®¡æ‰¹æµç¨‹å›¾ä¸­çš„æƒé™è­¦å‘Šæ˜¾ç¤º

**ä¿®æ”¹æ–‡ä»¶**: `app/templates/pricing_order/edit_pricing_order.html`

**ç§»é™¤å†…å®¹**:
- æµç¨‹å‘èµ·èŠ‚ç‚¹çš„çº¢è‰²è¾¹æ¡†å’Œæƒé™è¶…å‡ºå¾½ç« 
- å®¡æ‰¹æ­¥éª¤èŠ‚ç‚¹çš„çº¢è‰²è¾¹æ¡†å’Œæƒé™è¶…å‡ºå¾½ç«   
- "å‘èµ·äººè®¾ç½®çš„æŠ˜æ‰£ç‡ä½äºå…¶æƒé™ä¸‹é™ï¼Œéœ€è¦å®¡æ‰¹äººå…³æ³¨" æ–‡å­—æç¤º

**ä¿®æ”¹å‰**:
```html
<div class="timeline-marker bg-info{% if step_discount_statuses.get(0, {}).get('has_violation', False) %} border border-danger border-3{% endif %}"></div>
```

**ä¿®æ”¹å**:
```html
<div class="timeline-marker bg-info"></div>
```

### 2. ç¦ç”¨åç«¯å®¡æ‰¹æµç¨‹æƒé™çŠ¶æ€æ£€æŸ¥

**ä¿®æ”¹æ–‡ä»¶**: `app/helpers/approval_helpers.py`

**ä¿®æ”¹å‡½æ•°**: `get_approval_step_discount_status()`

**ä¿®æ”¹å†…å®¹**:
```python
def get_approval_step_discount_status(pricing_order):
    """
    è·å–æ‰¹ä»·å•å®¡æ‰¹æµç¨‹ä¸­å„æ­¥éª¤çš„æŠ˜æ‰£æƒé™çŠ¶æ€
    
    æ³¨æ„ï¼šæ ¹æ®æ–°çš„éœ€æ±‚ï¼Œå®¡æ‰¹æµç¨‹ä¸­ä¸å†æ˜¾ç¤ºæƒé™è­¦å‘Šæç¤º
    æƒé™æ£€æŸ¥åº”è¯¥åœ¨æ¨è¿›åˆ°ä¸‹ä¸€æ­¥æ—¶æ‰ç”Ÿæˆï¼Œè€Œä¸æ˜¯åœ¨å®¡æ‰¹æµç¨‹å›¾ä¸­æ˜¾ç¤º
    
    Args:
        pricing_order: æ‰¹ä»·å•å¯¹è±¡
        
    Returns:
        dict: ç©ºå­—å…¸ï¼Œä¸å†è¿”å›æƒé™çŠ¶æ€ä¿¡æ¯
    """
    # ä¸å†è¿›è¡Œæƒé™æ£€æŸ¥å’Œæ˜¾ç¤ºè­¦å‘Šï¼Œç›´æ¥è¿”å›ç©ºçŠ¶æ€
    return {}
```

### 3. ä¿æŒå‰ç«¯å®æ—¶æŠ˜æ‰£æƒé™æ£€æŸ¥åŠŸèƒ½

**åŠŸèƒ½ä½ç½®**: `app/templates/pricing_order/edit_pricing_order.html`

**æ ¸å¿ƒåŠŸèƒ½**:
1. **å®æ—¶æƒé™æ£€æŸ¥**: ç”¨æˆ·è¾“å…¥æŠ˜æ‰£ç‡æ—¶ç«‹å³æ£€æŸ¥æƒé™
2. **è”åŠ¨æ£€æŸ¥**: æ˜ç»†æŠ˜æ‰£ç‡ä¸æ€»æŠ˜æ‰£ç‡ç›¸äº’è”åŠ¨æ£€æŸ¥
3. **è§†è§‰æç¤º**: æƒé™è¶…å‡ºæ—¶æ˜¾ç¤ºçº¢è‰²èƒŒæ™¯è­¦å‘Š

**JavaScriptå‡½æ•°**:
- `initializeDiscountPermissionCheck()`: åˆå§‹åŒ–æƒé™æ£€æŸ¥
- `checkDiscountPermissionWithLinkage()`: è”åŠ¨æƒé™æ£€æŸ¥
- `checkDiscountPermission()`: å•ä¸ªè¾“å…¥æ¡†æƒé™æ£€æŸ¥

## ğŸ”§ æŠ€æœ¯å®ç°ç»†èŠ‚

### å‰ç«¯JavaScriptæƒé™æ£€æŸ¥é€»è¾‘

```javascript
// æƒé™é…ç½®æ•°æ®
window.discountLimits = {
    pricing_discount_limit: 45.0,
    settlement_discount_limit: null
};

// æƒé™æ£€æŸ¥å‡½æ•°
function checkDiscountPermission(inputElement) {
    if (!inputElement || !window.discountLimits) return;
    
    const discountRate = parseFloat(inputElement.value);
    const orderType = inputElement.closest('#pricing-content') ? 'pricing' : 'settlement';
    const limit = orderType === 'pricing' ? 
        window.discountLimits.pricing_discount_limit : 
        window.discountLimits.settlement_discount_limit;
    
    if (limit !== null && discountRate < limit) {
        inputElement.classList.add('discount-warning');  // çº¢è‰²è­¦å‘Š
    } else {
        inputElement.classList.remove('discount-warning'); // ç§»é™¤è­¦å‘Š
    }
}
```

### CSSæ ·å¼å®šä¹‰

```css
.discount-warning {
    background-color: #dc3545 !important;
    color: white !important;
    border-color: #dc3545 !important;
}

.discount-warning:focus {
    background-color: #dc3545 !important;
    color: white !important;
    border-color: #dc3545 !important;
    box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25) !important;
}
```

## ğŸ“Š æµ‹è¯•éªŒè¯ç»“æœ

### lihuaweiç”¨æˆ·æƒé™æµ‹è¯• (é”€å”®ç»ç†ï¼Œ45%æƒé™ä¸‹é™)

| æŠ˜æ‰£ç‡ | é¢„æœŸè¡Œä¸º | éªŒè¯ç»“æœ |
|--------|----------|----------|
| 30% | ğŸ”´ çº¢è‰²è­¦å‘Š | âœ… æ­£ç¡® |
| 35% | ğŸ”´ çº¢è‰²è­¦å‘Š | âœ… æ­£ç¡® |
| 40% | ğŸ”´ çº¢è‰²è­¦å‘Š | âœ… æ­£ç¡® |
| 44% | ğŸ”´ çº¢è‰²è­¦å‘Š | âœ… æ­£ç¡® |
| 45% | âœ… æ­£å¸¸æ˜¾ç¤º | âœ… æ­£ç¡® |
| 50% | âœ… æ­£å¸¸æ˜¾ç¤º | âœ… æ­£ç¡® |
| 100% | âœ… æ­£å¸¸æ˜¾ç¤º | âœ… æ­£ç¡® |

## ğŸ¯ åŠŸèƒ½ç‰¹æ€§

### âœ… å·²å®ç°åŠŸèƒ½

1. **å®æ—¶æƒé™æ£€æŸ¥**: ç”¨æˆ·è¾“å…¥æŠ˜æ‰£ç‡æ—¶ç«‹å³æ˜¾ç¤ºæƒé™è­¦å‘Š
2. **è”åŠ¨æ£€æŸ¥**: æ˜ç»†æŠ˜æ‰£ç‡å˜åŒ–æ—¶è‡ªåŠ¨æ£€æŸ¥æ€»æŠ˜æ‰£ç‡ï¼Œåä¹‹äº¦ç„¶
3. **è§†è§‰åé¦ˆ**: æƒé™è¶…å‡ºæ—¶è¾“å…¥æ¡†å˜ä¸ºçº¢è‰²èƒŒæ™¯å’Œç™½è‰²æ–‡å­—
4. **å®¡æ‰¹æµç¨‹ç®€åŒ–**: ç§»é™¤äº†å®¡æ‰¹æµç¨‹å›¾ä¸­çš„æƒé™è­¦å‘Šæ˜¾ç¤º
5. **æƒé™æ•°æ®ä¼ é€’**: åç«¯æ­£ç¡®ä¼ é€’ç”¨æˆ·æƒé™æ•°æ®åˆ°å‰ç«¯

### ğŸ¨ ç”¨æˆ·ä½“éªŒ

1. **å³æ—¶åé¦ˆ**: ç”¨æˆ·ä¸€è¾“å…¥å°±èƒ½çœ‹åˆ°æƒé™çŠ¶æ€
2. **æ¸…æ™°æç¤º**: çº¢è‰²èƒŒæ™¯æ˜ç¡®æŒ‡ç¤ºæƒé™è¶…å‡º
3. **æµç¨‹ç®€æ´**: å®¡æ‰¹æµç¨‹å›¾ä¸å†æœ‰å†—ä½™çš„æƒé™è­¦å‘Š
4. **æ“ä½œè¿è´¯**: ç¼–è¾‘æ—¶çš„æƒé™æ£€æŸ¥ä¸ä¼šæ‰“æ–­ç”¨æˆ·æ“ä½œ

## ğŸ”„ ä¸šåŠ¡æµç¨‹å˜åŒ–

### ä¿®æ”¹å‰
- âŒ å®¡æ‰¹æµç¨‹å›¾æ˜¾ç¤ºå¤æ‚çš„æƒé™è­¦å‘Šå¾½ç« 
- âŒ å‘èµ·äººæƒé™è¶…å‡ºæœ‰é¢å¤–æ–‡å­—æç¤º
- âŒ å®¡æ‰¹æ¯ä¸ªæ­¥éª¤éƒ½æ˜¾ç¤ºæƒé™çŠ¶æ€

### ä¿®æ”¹å  
- âœ… å‘èµ·æ—¶å®æ—¶æ£€æŸ¥æŠ˜æ‰£æƒé™å¹¶æ˜¾ç¤ºè­¦å‘Š
- âœ… å®¡æ‰¹æµç¨‹å›¾ç®€æ´æ¸…æ™°ï¼Œæ— æƒé™è­¦å‘Šå¹²æ‰°
- âœ… æƒé™æ£€æŸ¥é›†ä¸­åœ¨ç¼–è¾‘ç¯èŠ‚ï¼Œæå‡ç”¨æˆ·ä½“éªŒ
- âœ… å®¡æ‰¹æ¨è¿›æ—¶æ‰è¿›è¡Œæƒé™éªŒè¯

## ğŸ› ï¸ æµ‹è¯•å»ºè®®

### æ‰‹åŠ¨æµ‹è¯•æ­¥éª¤
1. ä½¿ç”¨ lihuawei è´¦å·ç™»å½• PMA ç³»ç»Ÿ
2. è¿›å…¥ä»»æ„æ‰¹ä»·å•ç¼–è¾‘é¡µé¢
3. åœ¨æ˜ç»†æŠ˜æ‰£ç‡è¾“å…¥æ¡†ä¸­è¾“å…¥ 40%
4. âœ… ç¡®è®¤è¾“å…¥æ¡†å˜ä¸ºçº¢è‰²èƒŒæ™¯
5. è¾“å…¥ 45% æˆ–æ›´é«˜å€¼
6. âœ… ç¡®è®¤çº¢è‰²è­¦å‘Šæ¶ˆå¤±
7. æ£€æŸ¥æ€»æŠ˜æ‰£ç‡è¾“å…¥æ¡†ä¹Ÿæœ‰ç›¸åŒè¡Œä¸º
8. âœ… ç¡®è®¤å®¡æ‰¹æµç¨‹å›¾ä¸å†æ˜¾ç¤ºæƒé™è­¦å‘Š

### è‡ªåŠ¨åŒ–æµ‹è¯•
- å‰ç«¯JavaScriptæƒé™æ£€æŸ¥é€»è¾‘å·²é€šè¿‡å•å…ƒæµ‹è¯•éªŒè¯
- åç«¯æƒé™æœåŠ¡åŠŸèƒ½é€šè¿‡é›†æˆæµ‹è¯•éªŒè¯
- CSSæ ·å¼æ¸²æŸ“é€šè¿‡è§†è§‰æµ‹è¯•éªŒè¯

## ğŸ“ˆ ä¸šåŠ¡ä»·å€¼

1. **æå‡ç”¨æˆ·ä½“éªŒ**: å®æ—¶åé¦ˆè®©ç”¨æˆ·ç«‹å³äº†è§£æƒé™çŠ¶æ€
2. **ç®€åŒ–å®¡æ‰¹æµç¨‹**: ç§»é™¤ä¸å¿…è¦çš„æƒé™è­¦å‘Šï¼Œä¸“æ³¨äºå®¡æ‰¹å†³ç­–
3. **æé«˜å·¥ä½œæ•ˆç‡**: å‡å°‘å› æƒé™é—®é¢˜å¯¼è‡´çš„è¿”å·¥
4. **ä¿æŒåˆè§„æ€§**: æƒé™æ§åˆ¶ä¾ç„¶æœ‰æ•ˆï¼Œåªæ˜¯ä¼˜åŒ–äº†æ˜¾ç¤ºæ–¹å¼

## ğŸ” åç»­ä¼˜åŒ–å»ºè®®

1. **æƒé™çº§åˆ«ç»†åˆ†**: å¯ä»¥è€ƒè™‘æ˜¾ç¤ºå…·ä½“è¶…å‡ºå¤šå°‘ç™¾åˆ†ç‚¹
2. **æ‰¹é‡æ£€æŸ¥**: å¯ä»¥æ·»åŠ ä¸€é”®æ£€æŸ¥æ‰€æœ‰æ˜ç»†æƒé™çš„åŠŸèƒ½
3. **æƒé™æç¤º**: å¯ä»¥åœ¨è¾“å…¥æ¡†æ—æ˜¾ç¤ºç”¨æˆ·çš„æƒé™ä¸‹é™å€¼
4. **å†å²è®°å½•**: å¯ä»¥è®°å½•æƒé™è¶…å‡ºçš„æ“ä½œå†å²ç”¨äºåˆ†æ 