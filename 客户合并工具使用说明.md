# 客户合并工具使用说明

## 功能概述

客户合并工具是PMA系统中专为管理员设计的功能，用于检测和合并重复的客户数据，确保数据库的整洁性和一致性。

## 主要特性

### 🔍 智能重复检测
- **名称相似度分析**: 使用先进的字符串相似度算法检测相似客户名称
- **标准化处理**: 自动去除公司后缀（如"有限公司"、"科技"等）进行比较
- **多语言支持**: 支持中英文混合的公司名称检测
- **灵活阈值**: 采用多层次相似度判断，减少误报

### 📊 详细数据预览
- **关联数据统计**: 显示每个客户的联系人、行动记录、项目数量
- **合并预览**: 在执行合并前显示将要合并的所有数据
- **影响评估**: 清晰展示合并操作对数据的影响范围

### 🛡️ 安全保障机制
- **权限控制**: 仅管理员可访问和使用
- **数据完整性**: 保持原有数据归属和权限不变
- **事务安全**: 使用数据库事务确保操作的原子性
- **操作日志**: 记录所有合并操作的详细日志

## 访问方式

1. **登录要求**: 必须以管理员身份登录系统
2. **入口位置**: 客户列表页面 → "客户合并" 按钮（橙色警告色）
3. **直接访问**: `http://localhost:5005/customer/merge-tool`

## 使用流程

### 第一步：检测重复客户
1. 进入客户合并工具页面
2. 系统自动检测重复客户并分组显示
3. 如无重复数据，显示"太棒了！没有检测到重复的客户数据"

### 第二步：选择保留客户
1. 点击展开重复客户组
2. 查看每个客户的详细信息：
   - 公司代码
   - 所有者
   - 创建时间
   - 关联数据统计（联系人、行动记录、项目数量）
3. 选择要保留的目标客户（通过单选按钮）

### 第三步：预览合并结果
1. 选择目标客户后，系统自动显示合并预览
2. **编辑企业名称**（可选）：
   - 在"合并后企业名称"输入框中修改最终的企业名称
   - 可以从下拉菜单选择现有企业名称作为模板
   - 如不修改则使用选中的目标企业名称
3. 预览内容包括：
   - **联系人列表**: 将要合并的所有联系人（显示职位信息）
   - **重复联系人检测**: 自动检测并提示重复联系人处理方式
   - **行动记录**: 将要合并的行动记录（显示前5条）
   - **关联项目**: 相关的项目记录
4. 确认预览信息无误

### 第四步：执行合并
1. 点击"执行合并"按钮
2. 在确认对话框中再次确认操作
3. 系统执行合并并显示进度
4. 完成后跳转回客户列表

## 合并规则

### 数据归属原则
- **目标客户**: 成为所有数据的新归属
- **联系人**: 转移到目标客户下，保持原有创建者不变
- **行动记录**: 转移到目标客户下，保持原有创建者不变
- **项目关联**: 更新项目的end_user字段，项目归属不变
- **共享权限**: 合并所有客户的共享用户列表

### 数据处理方式
1. **企业名称**: 使用用户指定的最终名称或目标企业名称
2. **智能联系人合并**: 
   - 检测重复联系人（基于姓名+邮箱+电话）
   - 重复联系人将被合并，其行动记录转移到目标企业
   - 非重复联系人直接转移到目标客户
3. **行动记录合并**: 所有相关行动记录归属目标客户
4. **项目更新**: 更新项目表中的end_user字段为最终企业名称
5. **共享权限合并**: 合并所有共享用户ID
6. **源客户删除**: 标记为已删除（is_deleted=True）

## 重要注意事项

### ⚠️ 安全提醒
- **不可撤销**: 合并操作无法撤销，请谨慎操作
- **数据备份**: 建议在大批量合并前先备份数据库
- **权限变更**: 合并后数据归属会发生变化
- **业务影响**: 可能影响现有的业务流程和报表

### 🎯 最佳实践
1. **小批量操作**: 建议分批处理重复数据，避免一次性处理过多
2. **仔细核对**: 合并前仔细检查预览数据，确保选择正确的目标客户
3. **沟通确认**: 与相关用户确认数据归属变更
4. **操作记录**: 记录合并操作的详细信息，便于后续追踪

## 技术细节

### 重复检测算法
```python
# 相似度计算
similarity = difflib.SequenceMatcher(None, name1, name2).ratio()

# 判断条件
- 高相似度: similarity > 0.8
- 中等相似度 + 包含关系: similarity > 0.6 且存在包含关系
- 前缀匹配: 公司名称前缀相同且相似度 > 0.65
```

### API接口
- `GET /customer/api/detect-duplicates`: 检测重复客户
- `POST /customer/api/merge-preview`: 获取合并预览
- `POST /customer/api/execute-merge`: 执行合并操作

## 测试数据

系统已预置测试数据，包括：
- **苹果公司组**: 苹果公司、苹果有限公司、Apple Inc
- **华为公司组**: 华为技术有限公司、华为科技、华为公司

可以使用这些测试数据熟悉合并工具的操作流程。

## 故障排除

### 常见问题
1. **权限不足**: 确保以管理员身份登录
2. **检测失败**: 检查数据库连接是否正常
3. **合并失败**: 查看应用日志获取详细错误信息
4. **页面无响应**: 刷新页面或重新登录

### 日志查看
合并操作的详细日志会记录在应用日志中，包括：
- 操作用户
- 目标客户信息
- 源客户列表
- 合并统计数据

---

**版本**: 1.0.0  
**更新日期**: 2025年7月6日  
**适用系统**: PMA项目管理系统 v1.2.2