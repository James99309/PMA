# æ‰¹ä»·å•ç»“ç®—å•çŠ¶æ€é—®é¢˜å®Œæ•´ä¿®å¤æŠ¥å‘Š

## ğŸ¯ é—®é¢˜æ€»ç»“

ç”¨æˆ·åé¦ˆåœ¨ç»“ç®—æ¨¡å—ä¸­çœ‹åˆ°äº†æœªå®¡æ‰¹é¡¹ç›®çš„å¾…ç»“ç®—æ˜ç»†ï¼Œè¿™è¿åäº†ä¸šåŠ¡é€»è¾‘ã€‚ç»è¿‡æ·±å…¥åˆ†æï¼Œå‘ç°äº†å¤šä¸ªå±‚é¢çš„é—®é¢˜ï¼š

### ğŸ“Š å‘ç°çš„é—®é¢˜

1. **äº‘ç«¯æ•°æ®åº“çŠ¶æ€ä¸ä¸€è‡´**
2. **æœ¬åœ°æ•°æ®åº“å­¤å„¿è®°å½•é—®é¢˜**
3. **ä»£ç ä¸­çŠ¶æ€å®šä¹‰ä¸ä¸€è‡´**
4. **é»˜è®¤çŠ¶æ€é€»è¾‘é”™è¯¯**

## ğŸ” é—®é¢˜è¯¦ç»†åˆ†æ

### 1. äº‘ç«¯æ•°æ®åº“é—®é¢˜

#### é—®é¢˜æè¿°
- ç»“ç®—å• `SO202506-003` æ˜¯ `approved` çŠ¶æ€ï¼Œä½†å¯¹åº”æ‰¹ä»·å• `PO202506-003` æ˜¯ `draft` çŠ¶æ€
- 19ä¸ªç»“ç®—å•æ˜ç»†æ˜¯ `pending` çŠ¶æ€ï¼Œä¼šåœ¨ç»“ç®—æ¨¡å—ä¸­æ˜¾ç¤º

#### ä¿®å¤è¿‡ç¨‹
```sql
-- é‡ç½®ç»“ç®—å•çŠ¶æ€
UPDATE settlement_orders 
SET status = 'draft', approved_by = NULL, approved_at = NULL
WHERE id IN (SELECT so.id FROM settlement_orders so JOIN pricing_orders po ON so.pricing_order_id = po.id WHERE so.status = 'approved' AND po.status != 'approved');

-- é‡ç½®æ˜ç»†çŠ¶æ€
UPDATE settlement_order_details 
SET settlement_status = 'draft'
WHERE settlement_order_id IN (SELECT so.id FROM settlement_orders so JOIN pricing_orders po ON so.pricing_order_id = po.id WHERE po.status IN ('draft', 'pending', 'rejected'));
```

#### ä¿®å¤ç»“æœ
- âœ… ä¿®å¤äº†1ä¸ªç»“ç®—å•çŠ¶æ€
- âœ… ä¿®å¤äº†19ä¸ªæ˜ç»†çŠ¶æ€
- âœ… äº‘ç«¯æ•°æ®åº“çŠ¶æ€å®Œå…¨ä¸€è‡´

### 2. æœ¬åœ°æ•°æ®åº“å­¤å„¿è®°å½•é—®é¢˜

#### é—®é¢˜æè¿°
- å‘ç°68ä¸ª `pending` çŠ¶æ€çš„æ˜ç»†è®°å½•
- è¿™äº›æ˜ç»†çš„ `settlement_order_id` ä¸º `NULL`ï¼ˆå­¤å„¿è®°å½•ï¼‰
- å®ƒä»¬å…³è”çš„æ‰¹ä»·å•éƒ½æ˜¯ `approved` çŠ¶æ€ï¼Œä½†æ²¡æœ‰å¯¹åº”çš„ç»“ç®—å•

#### å­¤å„¿è®°å½•åˆ†å¸ƒ
```
æ‰¹ä»·å• PO202506-007 (approved): 20ä¸ªå­¤å„¿æ˜ç»†
æ‰¹ä»·å• PO202506-008 (approved): 20ä¸ªå­¤å„¿æ˜ç»†  
æ‰¹ä»·å• PO202506-009 (approved): 2ä¸ªå­¤å„¿æ˜ç»†
æ‰¹ä»·å• PO202506-010 (approved): 21ä¸ªå­¤å„¿æ˜ç»†
æ‰¹ä»·å• PO202506-011 (approved): 5ä¸ªå­¤å„¿æ˜ç»†
```

#### ä¿®å¤ç­–ç•¥
1. **æ£€æŸ¥æ‰¹ä»·å•æ˜¯å¦æœ‰å¯¹åº”ç»“ç®—å•**
2. **é‡æ–°å…³è”å­¤å„¿æ˜ç»†åˆ°æ­£ç¡®çš„ç»“ç®—å•**
3. **ä¿®å¤äº†68ä¸ªæ˜ç»†çš„å…³è”å…³ç³»**

#### ä¿®å¤ç»“æœ
- âœ… ä¿®å¤äº†68ä¸ªå­¤å„¿æ˜ç»†å…³è”
- âœ… æ‰€æœ‰æ˜ç»†ç°åœ¨éƒ½æœ‰æ­£ç¡®çš„ç»“ç®—å•å…³è”
- âœ… ç»“ç®—æ¨¡å—å¯ä»¥æ­£ç¡®æ˜¾ç¤º68ä¸ªå¾…ç»“ç®—æ˜ç»†

### 3. ä»£ç çŠ¶æ€å®šä¹‰ä¸ä¸€è‡´

#### é—®é¢˜æè¿°
- ä»£ç ä¸­å®šä¹‰: `pending`, `completed`
- æ•°æ®åº“ä¸­å®é™…: `pending`, `settled`
- é»˜è®¤çŠ¶æ€è®¾ç½®ä¸º `pending`ï¼ˆé”™è¯¯ï¼‰

#### ä¿®å¤å†…å®¹
```python
# ä¿®å¤æ¨¡å‹å®šä¹‰
settlement_status = Column(String(20), default='draft', comment='ç»“ç®—çŠ¶æ€: draft, pending, settled')

# ä¿®å¤çŠ¶æ€åˆ¤æ–­
def is_settled(self):
    return self.settlement_status == 'settled'

# ä¿®å¤çŠ¶æ€æ ‡ç­¾
status_map = {
    'draft': {'zh': 'è‰ç¨¿', 'color': '#6c757d'},
    'pending': {'zh': 'å¾…ç»“ç®—', 'color': '#ffc107'},
    'settled': {'zh': 'å·²ç»“ç®—', 'color': '#28a745'},
}

# ä¿®å¤æœåŠ¡å±‚é€»è¾‘
detail.settlement_status = 'draft'  # é‡ç½®ä¸ºè‰ç¨¿çŠ¶æ€
```

## âœ… æ­£ç¡®çš„çŠ¶æ€é€»è¾‘

### æ‰¹ä»·å•çŠ¶æ€æµè½¬
```
draft â†’ pending â†’ approved/rejected
```

### ç»“ç®—å•æ˜ç»†çŠ¶æ€æµè½¬
```
æ‰¹ä»·å• draft/pending/rejected â†’ æ˜ç»† draft
æ‰¹ä»·å• approved â†’ æ˜ç»† pending â†’ settled
```

### ç»“ç®—æ¨¡å—æ˜¾ç¤ºé€»è¾‘
```
æ˜¾ç¤ºæ¡ä»¶: settlement_status = 'pending' AND æ‰¹ä»·å• = 'approved'
ä¸æ˜¾ç¤º: settlement_status = 'draft' (è‰ç¨¿çŠ¶æ€)
ä¸æ˜¾ç¤º: settlement_status = 'settled' (å·²ç»“ç®—)
```

## ğŸ¯ ä¿®å¤æ•ˆæœ

### äº‘ç«¯æ•°æ®åº“
- âœ… 2ä¸ªè‰ç¨¿æ‰¹ä»·å• â†” 2ä¸ªè‰ç¨¿ç»“ç®—å• â†” 19ä¸ªè‰ç¨¿æ˜ç»†
- âœ… ä¸ä¼šåœ¨ç»“ç®—æ¨¡å—æ˜¾ç¤º

### æœ¬åœ°æ•°æ®åº“  
- âœ… 17ä¸ªå·²å®¡æ‰¹æ‰¹ä»·å• â†” 17ä¸ªå·²å®¡æ‰¹ç»“ç®—å•
- âœ… 129ä¸ªå·²ç»“ç®—æ˜ç»† + 68ä¸ªå¾…ç»“ç®—æ˜ç»†
- âœ… ç»“ç®—æ¨¡å—æ­£ç¡®æ˜¾ç¤º68ä¸ªå¾…ç»“ç®—æ˜ç»†

### ä»£ç å±‚é¢
- âœ… çŠ¶æ€å®šä¹‰ç»Ÿä¸€ä¸º `draft`, `pending`, `settled`
- âœ… é»˜è®¤çŠ¶æ€ä¿®æ­£ä¸º `draft`
- âœ… çŠ¶æ€åˆ‡æ¢é€»è¾‘æ­£ç¡®

## ğŸ”§ é¢„é˜²æªæ–½

### 1. æ•°æ®åº“çº¦æŸ
å»ºè®®æ·»åŠ å¤–é”®çº¦æŸï¼Œé˜²æ­¢å­¤å„¿è®°å½•ï¼š
```sql
ALTER TABLE settlement_order_details 
ADD CONSTRAINT fk_settlement_order 
FOREIGN KEY (settlement_order_id) REFERENCES settlement_orders(id) ON DELETE CASCADE;
```

### 2. çŠ¶æ€éªŒè¯
åœ¨ç»“ç®—å•åˆ›å»ºå’Œæ›´æ–°æ—¶ï¼ŒéªŒè¯çŠ¶æ€ä¸€è‡´æ€§ï¼š
- æ‰¹ä»·å•æœªå®¡æ‰¹ â†’ æ˜ç»†å¿…é¡»æ˜¯ `draft`
- æ‰¹ä»·å•å·²å®¡æ‰¹ â†’ æ˜ç»†å¯ä»¥æ˜¯ `pending` æˆ– `settled`

### 3. å®šæœŸæ£€æŸ¥
å»ºè®®å®šæœŸè¿è¡ŒçŠ¶æ€ä¸€è‡´æ€§æ£€æŸ¥è„šæœ¬ï¼ŒåŠæ—¶å‘ç°å’Œä¿®å¤é—®é¢˜ã€‚

## ğŸ“‹ æ€»ç»“

æœ¬æ¬¡ä¿®å¤å½»åº•è§£å†³äº†æ‰¹ä»·å•å’Œç»“ç®—å•çŠ¶æ€ä¸ä¸€è‡´çš„é—®é¢˜ï¼š

1. **ä¿®å¤äº†äº‘ç«¯æ•°æ®åº“çš„çŠ¶æ€ä¸ä¸€è‡´é—®é¢˜**
2. **ä¿®å¤äº†æœ¬åœ°æ•°æ®åº“çš„68ä¸ªå­¤å„¿è®°å½•**
3. **ç»Ÿä¸€äº†ä»£ç ä¸­çš„çŠ¶æ€å®šä¹‰**
4. **å»ºç«‹äº†æ­£ç¡®çš„çŠ¶æ€æµè½¬é€»è¾‘**

ç°åœ¨ç³»ç»Ÿçš„çŠ¶æ€é€»è¾‘å®Œå…¨æ­£ç¡®ï¼Œç»“ç®—æ¨¡å—åªä¼šæ˜¾ç¤ºçœŸæ­£åº”è¯¥ç»“ç®—çš„æ˜ç»†ï¼Œä¸ä¼šå†å‡ºç°è‰ç¨¿çŠ¶æ€é¡¹ç›®çš„æ˜ç»†è¢«è¯¯æ˜¾ç¤ºçš„é—®é¢˜ã€‚ 