# 批价单审批权限锁定和金额校验修正报告

## 修正概述

本次修正解决了批价单审批过程中的权限控制和数据校验问题，确保审批流程的安全性和数据一致性。

## 主要修正内容

### 1. 审批状态下权限锁定机制

**问题描述：**
- 批价单在提交审批后，除当前审批人外，其他用户仍可编辑产品明细
- 审批过程中，产品数量和折扣率仍可修改
- 删除功能和批量操作功能在审批时未被限制

**修正措施：**

#### 1.1 后端权限检查逻辑优化
**文件：** `app/services/pricing_order_service.py`

- **can_edit_pricing_details()** 方法修正：
  - 审批状态下，只有当前审批人和管理员可以编辑
  - 移除了发起人和厂商销售负责人在审批状态下的编辑权限
  - 明确限制：除当前审批人和管理员外，其他人都不能编辑

- **can_edit_settlement_details()** 方法修正：
  - 同样的锁定逻辑应用到结算单编辑
  - 草稿、被拒绝状态下保留原有角色权限检查
  - 审批状态下严格限制编辑权限

#### 1.2 前端界面锁定逻辑
**文件：** `app/templates/pricing_order/edit_pricing_order.html`

- **批量操作功能隐藏：**
  - 审批状态下隐藏批量删除按钮区域
  - 隐藏全选复选框和明细行复选框
  - 隐藏操作列（删除按钮列）

- **明细编辑字段锁定：**
  - 数量字段：审批状态下变为只读显示
  - 折扣率字段：审批状态下变为只读显示
  - 单个删除按钮：审批状态下隐藏
  - 总折扣率：审批状态下禁用编辑

- **移动端界面同步锁定：**
  - 移动端数量和折扣率字段同样锁定
  - 移动端删除按钮隐藏

### 2. 审批通过时金额校验机制

**问题描述：**
- 审批通过时未校验结算单金额是否超过批价单金额
- 可能出现结算金额高于批价金额的不合理情况

**修正措施：**

#### 2.1 最终审批步骤前添加金额校验
**文件：** `app/services/pricing_order_service.py` - `approve_step()` 方法

- **校验逻辑：**
  ```python
  # 获取对应的结算单进行金额比较
  settlement_order = SettlementOrder.query.filter_by(pricing_order_id=pricing_order_id).first()
  
  if settlement_order:
      # 重新计算最新的总金额
      settlement_order.calculate_totals()
      
      # 检查结算单总金额是否小于等于批价单总金额
      if settlement_order.total_amount > pricing_order.total_amount:
          return False, f"审批失败：结算单总金额 ¥{settlement_order.total_amount:,.2f} 超过批价单总金额 ¥{pricing_order.total_amount:,.2f}，不能通过审批"
  ```

- **校验时机：**
  - 只在最后一个审批步骤（完成审批前）进行校验
  - 非最终步骤不受影响，保持审批流程灵活性

- **错误处理：**
  - 校验失败时返回明确的错误信息
  - 包含具体的金额数据，便于审批人了解问题

## 修正效果

### 1. 权限控制效果
- ✅ 审批状态下，只有当前审批人可以修改批价单明细
- ✅ 发起人、厂商销售负责人在审批期间无法编辑
- ✅ 数量和折扣率字段在审批时被锁定
- ✅ 删除功能（单个删除、批量删除）在审批时隐藏
- ✅ 管理员始终保有编辑权限（emergency access）

### 2. 金额校验效果
- ✅ 审批通过前自动校验结算单与批价单金额关系
- ✅ 超额情况下阻止审批通过，显示明确错误信息
- ✅ 确保最终签约金额不超过批价上限

### 3. 用户体验优化
- ✅ 审批状态下界面元素合理隐藏，避免无效操作
- ✅ 错误提示信息明确，便于用户理解问题
- ✅ 移动端和桌面端界面行为一致

## 安全性提升

1. **数据完整性保护：** 审批过程中防止意外修改导致的数据不一致
2. **业务规则强化：** 确保结算金额不超过批价金额的业务约束
3. **权限最小化原则：** 审批期间严格限制编辑权限，降低风险
4. **审计追踪：** 权限变更和校验失败都有明确的日志记录

## 兼容性说明

- ✅ 现有草稿状态批价单功能保持不变
- ✅ 被拒绝状态批价单可正常编辑和重新提交
- ✅ 管理员权限保持，支持紧急情况处理
- ✅ 审批流程其他功能不受影响

## 部署建议

1. **测试验证：** 在测试环境验证各种审批场景
2. **用户培训：** 告知用户审批期间的编辑限制
3. **监控配置：** 关注审批失败和权限拒绝的日志
4. **回滚预案：** 保留原始权限检查代码备份

## 技术实现要点

### 权限检查优化
```python
# 新的权限检查逻辑
if pricing_order.status == 'pending':
    # 审批中：除了当前审批人和管理员，其他人都不能编辑
    if is_admin:
        return True
    # 只有当前审批人可以编辑
    if current_approval_record:
        return True
    # 其他人都不能编辑
    return False
```

### 金额校验逻辑
```python
# 最终审批步骤的金额校验
if settlement_order.total_amount > pricing_order.total_amount:
    return False, f"审批失败：结算单总金额超过批价单总金额"
```

### 前端条件渲染
```html
<!-- 审批状态下隐藏删除功能 -->
{% if can_edit_pricing and pricing_order.status != 'pending' %}
    <!-- 删除相关UI元素 -->
{% endif %}

<!-- 审批状态下锁定编辑字段 -->
{% if can_edit_pricing and pricing_order.status != 'pending' %}
    <input type="number" class="form-control quantity" ...>
{% else %}
    {{ detail.quantity }}
{% endif %}
```

---

**修正日期：** 2024年12月19日  
**修正版本：** v1.2.3  
**影响模块：** 批价单管理、审批流程、权限控制  
**测试状态：** 已完成基础功能测试，建议进行全面业务场景验证 