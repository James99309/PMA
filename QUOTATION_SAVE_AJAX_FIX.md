# æŠ¥ä»·å•AJAXä¿å­˜åŠŸèƒ½ä¿®å¤æ–‡æ¡£

## é—®é¢˜æè¿°

ç”¨æˆ·åé¦ˆï¼šæŠ¥ä»·å•è¯¦æƒ…é¡µé¢çš„ç¼–è¾‘ä¿å­˜åŠŸèƒ½ä»ä¼šç›´æ¥å°†æ²¡æœ‰ä»»ä½•ä¿®æ”¹çš„äº§å“æ˜ç»†å–æ¶ˆå®¡æ ¸é€šè¿‡æ ‡è®°ã€‚

## é—®é¢˜æ ¹å› 

æŠ¥ä»·å•è¯¦æƒ…é¡µé¢ä½¿ç”¨AJAXä¿å­˜åŠŸèƒ½ï¼ˆ`save_quotation`å‡½æ•°ï¼‰ï¼Œè¯¥å‡½æ•°é‡‡ç”¨"åˆ é™¤æ‰€æœ‰æ—§æ˜ç»†ï¼Œç„¶åé‡æ–°åˆ›å»º"çš„æ–¹å¼å¤„ç†äº§å“æ˜ç»†ï¼Œä½†æ²¡æœ‰åƒè¡¨å•ç‰ˆæœ¬çš„`edit_quotation`å‡½æ•°é‚£æ ·ä¸´æ—¶ç¦ç”¨äº‹ä»¶ç›‘å¬å™¨ï¼Œå¯¼è‡´ï¼š

1. åˆ é™¤æ“ä½œè§¦å‘äº‹ä»¶ç›‘å¬å™¨
2. é‡æ–°åˆ›å»ºæ“ä½œè§¦å‘äº‹ä»¶ç›‘å¬å™¨
3. å³ä½¿æœ€ç»ˆå†…å®¹ç›¸åŒï¼Œä¸­é—´è¿‡ç¨‹çš„å˜åŒ–ä¼šè¯¯è§¦å‘æ¸…é™¤ç¡®è®¤çŠ¶æ€çš„é€»è¾‘

## ä¿®å¤æ–¹æ¡ˆ

### æ ¸å¿ƒç­–ç•¥
åº”ç”¨ä¸`edit_quotation`å‡½æ•°ç›¸åŒçš„ä¿®å¤ç­–ç•¥ï¼š
1. åœ¨åˆ é™¤-é‡å»ºè¿‡ç¨‹å¼€å§‹å‰ä¸´æ—¶ç¦ç”¨äº‹ä»¶ç›‘å¬å™¨
2. å®Œæˆåˆ é™¤-é‡å»ºåæ‰‹åŠ¨è¿›è¡Œç­¾åæ£€æµ‹å’ŒçŠ¶æ€å¤„ç†
3. ä½¿ç”¨`try-finally`å—ç¡®ä¿äº‹ä»¶ç›‘å¬å™¨åœ¨ä»»ä½•æƒ…å†µä¸‹éƒ½èƒ½æ¢å¤
4. åœ¨æäº¤å‰ï¼ˆè€Œä¸æ˜¯æäº¤åï¼‰è¿›è¡Œç­¾åæ£€æµ‹

### ä¿®å¤ä»£ç 

#### 1. äº‹ä»¶ç›‘å¬å™¨ç®¡ç†
```python
# ä¸´æ—¶ç¦ç”¨äº‹ä»¶ç›‘å¬å™¨
event.remove(QuotationDetail, 'after_insert', update_quotation_product_signature)
event.remove(QuotationDetail, 'after_update', update_quotation_product_signature)
event.remove(QuotationDetail, 'after_delete', update_quotation_product_signature)

try:
    # åˆ é™¤-é‡å»ºé€»è¾‘
    # ...
    
    # åœ¨æäº¤å‰è¿›è¡Œç­¾åæ£€æµ‹å’ŒçŠ¶æ€å¤„ç†
    try:
        new_product_signature = quotation.calculate_product_signature()
        product_details_changed = old_product_signature != new_product_signature
        
        # å¦‚æœäº§å“æ˜ç»†å‘ç”Ÿå…³é”®å˜åŒ–ï¼Œæ‰‹åŠ¨æ¸…é™¤ç¡®è®¤çŠ¶æ€
        if product_details_changed and quotation.confirmation_badge_status == 'confirmed':
            quotation.confirmation_badge_status = 'none'
            quotation.confirmation_badge_color = None
            quotation.confirmed_by = None
            quotation.confirmed_at = None
            current_app.logger.info(f"æŠ¥ä»·å• {quotation.id} çš„äº§å“æ˜ç»†å‘ç”Ÿå…³é”®å˜åŒ–ï¼Œå·²æ‰‹åŠ¨æ¸…é™¤ç¡®è®¤çŠ¶æ€")
        
        # æ›´æ–°äº§å“ç­¾å
        quotation.product_signature = new_product_signature
        
    except Exception as signature_error:
        current_app.logger.error(f"å¤„ç†äº§å“ç­¾åå’Œç¡®è®¤çŠ¶æ€æ—¶å‡ºé”™: {str(signature_error)}")
    
    # æäº¤æ›´æ”¹ï¼ˆåœ¨äº‹ä»¶ç›‘å¬å™¨è¢«ç¦ç”¨çš„æƒ…å†µä¸‹ï¼‰
    db.session.commit()
    
finally:
    # ç¡®ä¿äº‹ä»¶ç›‘å¬å™¨åœ¨ä»»ä½•æƒ…å†µä¸‹éƒ½èƒ½æ¢å¤
    event.listen(QuotationDetail, 'after_insert', update_quotation_product_signature)
    event.listen(QuotationDetail, 'after_update', update_quotation_product_signature)
    event.listen(QuotationDetail, 'after_delete', update_quotation_product_signature)
```

#### 2. å…³é”®æ”¹è¿›ç‚¹
- **æäº¤å‰æ£€æµ‹**ï¼šå°†ç­¾åæ£€æµ‹å’ŒçŠ¶æ€å¤„ç†æ”¾åœ¨`db.session.commit()`ä¹‹å‰ï¼Œé¿å…äº‹ä»¶ç›‘å¬å™¨å¹²æ‰°
- **åŒé‡ä¿æŠ¤**ï¼šå³ä½¿äº‹ä»¶ç›‘å¬å™¨åœ¨æ¢å¤åè¢«æ„å¤–è§¦å‘ï¼Œæ‰‹åŠ¨æ£€æµ‹å·²ç»ç¡®ä¿äº†æ­£ç¡®çš„çŠ¶æ€
- **å¼‚å¸¸å®‰å…¨**ï¼šä½¿ç”¨`try-finally`ç¡®ä¿äº‹ä»¶ç›‘å¬å™¨å¿…å®šæ¢å¤

## æµ‹è¯•éªŒè¯

### è°ƒè¯•æµ‹è¯•ç»“æœ
é€šè¿‡ä¸“é—¨çš„è°ƒè¯•è„šæœ¬éªŒè¯ä¿®å¤æ•ˆæœï¼š

```
=== è°ƒè¯•save_quotationé€»è¾‘çš„äº‹ä»¶ç›‘å¬å™¨ ===

ğŸ”§ æ­¥éª¤1: ç§»é™¤äº‹ä»¶ç›‘å¬å™¨...
   âœ… äº‹ä»¶ç›‘å¬å™¨ç§»é™¤æˆåŠŸ

ğŸ”§ æ­¥éª¤3: ç­¾åæ£€æµ‹å’ŒçŠ¶æ€å¤„ç†...
   æ—§ç­¾å: 0cfc304077e6e9eee8cea6821c6c0fe9
   æ–°ç­¾å: 0cfc304077e6e9eee8cea6821c6c0fe9
   ç­¾åæ˜¯å¦æ”¹å˜: å¦
   å½“å‰ç¡®è®¤çŠ¶æ€: confirmed
   âœ… ä¿æŒç¡®è®¤çŠ¶æ€ï¼ˆç­¾åæœªå˜åŒ–ï¼‰

ğŸ”§ æ­¥éª¤4: æäº¤æ›´æ”¹...
   ç¡®è®¤çŠ¶æ€ï¼ˆæäº¤å‰ï¼‰: confirmed
   âœ… æ•°æ®åº“æäº¤æˆåŠŸ

ğŸ“Š æœ€ç»ˆç»“æœ:
   æœ€ç»ˆç­¾å: 0cfc304077e6e9eee8cea6821c6c0fe9
   æœ€ç»ˆç¡®è®¤çŠ¶æ€: confirmed
   æµ‹è¯•ç»“æœ: âœ… æˆåŠŸ
```

### åŠŸèƒ½éªŒè¯
- âœ… ä¿å­˜ç›¸åŒå†…å®¹æ—¶ç¡®è®¤çŠ¶æ€ä¿æŒä¸å˜
- âœ… ä¿®æ”¹MNå·æ—¶ç¡®è®¤çŠ¶æ€è¢«æ­£ç¡®æ¸…é™¤
- âœ… å¢åŠ /å‡å°‘æ˜ç»†è¡Œæ—¶ç¡®è®¤çŠ¶æ€è¢«æ­£ç¡®æ¸…é™¤
- âœ… ä¿®æ”¹æ•°é‡ã€å•ä»·ã€æŠ˜æ‰£ç‡æ—¶ç¡®è®¤çŠ¶æ€ä¿æŒä¸å˜

## å½±å“èŒƒå›´

### ä¿®æ”¹æ–‡ä»¶
- `app/views/quotation.py` - `save_quotation`å‡½æ•°

### åŠŸèƒ½å½±å“
- **æŠ¥ä»·å•è¯¦æƒ…é¡µé¢ä¿å­˜åŠŸèƒ½**ï¼šAJAXä¿å­˜ç°åœ¨èƒ½æ­£ç¡®å¤„ç†ç¡®è®¤çŠ¶æ€
- **å‘åå…¼å®¹**ï¼šä¸å½±å“ç°æœ‰çš„è¡¨å•ä¿å­˜åŠŸèƒ½
- **æ€§èƒ½å½±å“**ï¼šå¾®å°ï¼Œä¸»è¦æ˜¯å¢åŠ äº†äº‹ä»¶ç›‘å¬å™¨ç®¡ç†å¼€é”€

## æŠ€æœ¯ç»†èŠ‚

### äº‹ä»¶ç›‘å¬å™¨å‡½æ•°å¼•ç”¨
ç¡®ä¿ç§»é™¤å’Œæ¢å¤çš„æ˜¯åŒä¸€ä¸ªå‡½æ•°å¼•ç”¨ï¼š
```python
from app.models.quotation import update_quotation_product_signature

event.remove(QuotationDetail, 'after_insert', update_quotation_product_signature)
event.listen(QuotationDetail, 'after_insert', update_quotation_product_signature)
```

### ç­¾åç®—æ³•
åªå…³æ³¨å…³é”®å˜åŒ–ï¼ˆè¡Œæ•°å’ŒMNå·ï¼‰ï¼š
```python
signature_data = {
    'count': detail_count,
    'mn_list': sorted([detail.product_mn for detail in details])
}
```

### é”™è¯¯å¤„ç†
å®Œå–„çš„å¼‚å¸¸å¤„ç†ç¡®ä¿ç³»ç»Ÿç¨³å®šæ€§ï¼š
- äº‹ä»¶ç›‘å¬å™¨ç®¡ç†å¼‚å¸¸
- ç­¾åæ£€æµ‹å¼‚å¸¸
- æ•°æ®åº“æäº¤å¼‚å¸¸

## æ€»ç»“

é€šè¿‡ä¸´æ—¶ç¦ç”¨äº‹ä»¶ç›‘å¬å™¨å’Œæ‰‹åŠ¨ç­¾åæ£€æµ‹ï¼ŒæˆåŠŸä¿®å¤äº†AJAXä¿å­˜åŠŸèƒ½ä¸­ç¡®è®¤çŠ¶æ€è¢«é”™è¯¯æ¸…é™¤çš„é—®é¢˜ã€‚ç°åœ¨æ— è®ºæ˜¯è¡¨å•ä¿å­˜è¿˜æ˜¯AJAXä¿å­˜ï¼Œéƒ½èƒ½æ­£ç¡®å¤„ç†ç¡®è®¤çŠ¶æ€çš„ä¿æŒå’Œæ¸…é™¤é€»è¾‘ã€‚

**ä¿®å¤å‰**ï¼šä¿å­˜ç›¸åŒå†…å®¹ä¼šé”™è¯¯æ¸…é™¤ç¡®è®¤çŠ¶æ€  
**ä¿®å¤å**ï¼šåªåœ¨å…³é”®å˜åŒ–æ—¶æ¸…é™¤ç¡®è®¤çŠ¶æ€ï¼Œä¿å­˜ç›¸åŒå†…å®¹æ—¶ä¿æŒç¡®è®¤çŠ¶æ€

è¿™ä¸ªä¿®å¤å®Œå–„äº†æŠ¥ä»·å•å®¡æ ¸å¾½ç« ç³»ç»Ÿï¼Œç¡®ä¿äº†ç”¨æˆ·ä½“éªŒçš„ä¸€è‡´æ€§å’ŒåŠŸèƒ½çš„å‡†ç¡®æ€§ã€‚ 