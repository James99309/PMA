# æ‰¹ä»·å•ç»“ç®—å•å‰ç«¯æ•°é‡è·å–é”™è¯¯ä¿®å¤æŠ¥å‘Š

## é—®é¢˜æè¿°

ç”¨æˆ·åé¦ˆï¼šæ‰¹ä»·å•å‰ç«¯åœ¨è°ƒæ•´äº§å“æ˜ç»†ä»·æ ¼å’ŒæŠ˜æ‰£ç‡åŠæ€»æŠ˜æ‰£ç‡æ—¶ï¼Œé‡æ–°è®¡ç®—è·å¾—çš„äº§å“æ•°é‡æœ‰é”™è¯¯ï¼Œå¯¼è‡´å‰ç«¯è®¡ç®—ç»“æœä¸æ­£ç¡®ã€‚åŒæ ·çš„é—®é¢˜ä¹Ÿå‘ç”Ÿåœ¨ç»“ç®—å•çš„å‰ç«¯è®¡ç®—ä¸­ã€‚

## é—®é¢˜åˆ†æ

é€šè¿‡ä»£ç å®¡æŸ¥ï¼Œå‘ç°ä»¥ä¸‹å‡ ä¸ªå…³é”®é—®é¢˜ï¼š

### 1. æ•°é‡è·å–ä¸ä¸€è‡´é—®é¢˜

åœ¨ä¸åŒçš„è®¡ç®—å‡½æ•°ä¸­ï¼Œæ•°é‡è·å–çš„æ–¹å¼å­˜åœ¨ä¸ä¸€è‡´ï¼š

**é—®é¢˜ä»£ç ç¤ºä¾‹ï¼š**
```javascript
// åœ¨ updateTotalDiscount å‡½æ•°ä¸­ (ç¬¬2267è¡Œ)
const quantity = parseInt($row.find('.quantity').val()) || 1;

// åœ¨ calculateAndUpdateTotalDiscountRate å‡½æ•°ä¸­ (ç¬¬2431è¡Œ) 
const quantity = parseInt($row.find('.quantity').val()) || 1;

// åœ¨ calculateSubtotal å‡½æ•°ä¸­ (ç¬¬3462è¡Œ)
var quantity = parseInt($row.find('.quantity').val()) || 1;
```

**æ ¸å¿ƒé—®é¢˜ï¼š**
- æ‰€æœ‰å‡½æ•°éƒ½ä½¿ç”¨ `parseInt($row.find('.quantity').val()) || 1` æ¥è·å–æ•°é‡
- å½“æ•°é‡è¾“å…¥æ¡†ä¸ºç©ºæˆ–åŒ…å«éæ•°å­—å­—ç¬¦æ—¶ï¼Œä¼šé»˜è®¤è¿”å›1
- è¿™å¯¼è‡´åœ¨æŸäº›æƒ…å†µä¸‹è·å–åˆ°é”™è¯¯çš„æ•°é‡å€¼

### 2. ç§»åŠ¨ç«¯å’Œæ¡Œé¢ç«¯åŒæ­¥é—®é¢˜

ç§»åŠ¨ç«¯å¡ç‰‡å’Œæ¡Œé¢ç«¯è¡¨æ ¼çš„æ•°é‡åŒæ­¥å­˜åœ¨é—®é¢˜ï¼š

**é—®é¢˜ä»£ç ç¤ºä¾‹ï¼š**
```javascript
// ç§»åŠ¨ç«¯æ•°é‡è¾“å…¥æ¡†äº‹ä»¶ç»‘å®š (ç¬¬3010è¡Œ)
$(document).on('input change', '.mobile-card-input.quantity', function() {
    const $input = $(this);
    const $card = $input.closest('.mobile-product-card');
    const detailId = $card.data('detail-id');
    const newQuantity = parseInt($input.val()) || 1;  // ğŸ”¥ é—®é¢˜ï¼šé»˜è®¤å€¼1å¯èƒ½ä¸æ­£ç¡®
    
    // åŒæ­¥åˆ°æ¡Œé¢ç«¯è¡¨æ ¼
    if (detailId) {
        const $desktopRow = $(`#pricingTable tr[data-detail-id="${detailId}"], #settlementTable tr[data-detail-id="${detailId}"]`);
        if ($desktopRow.length) {
            $desktopRow.find('.quantity').val(newQuantity);
        }
    }
```

### 3. æ•°é‡éªŒè¯é€»è¾‘ç¼ºé™·

å½“å‰çš„æ•°é‡éªŒè¯é€»è¾‘è¿‡äºç®€å•ï¼š

**é—®é¢˜ä»£ç ç¤ºä¾‹ï¼š**
```javascript
// ç›‘å¬æ•°é‡å˜æ›´äº‹ä»¶ (ç¬¬2954è¡Œ)
$('#pricingTable, #settlementTable').on('input change', '.quantity', function() {
    var $row = $(this).closest('tr');
    var quantity = parseInt($(this).val());
    
    // éªŒè¯æ•°é‡è¾“å…¥
    if (isNaN(quantity) || quantity < 1) {
        quantity = 1;
        $(this).val('1');  // ğŸ”¥ é—®é¢˜ï¼šå¼ºåˆ¶è®¾ç½®ä¸º1å¯èƒ½è¦†ç›–ç”¨æˆ·çš„æœ‰æ•ˆè¾“å…¥
    }
```

### 4. åˆå§‹åŒ–æ—¶æ•°æ®è·å–é—®é¢˜

é¡µé¢åˆå§‹åŒ–æ—¶ï¼Œå·²æœ‰æ•°æ®çš„æ•°é‡è·å–å¯èƒ½å­˜åœ¨é—®é¢˜ï¼š

**é—®é¢˜ä»£ç ç¤ºä¾‹ï¼š**
```javascript
// åˆå§‹åŒ–å·²æœ‰è¡Œæ•°æ® (ç¬¬2620è¡Œ)
function initializeExistingRows() {
    try {
        // åˆå§‹åŒ–æ‰¹ä»·å•è¡¨æ ¼çš„å·²æœ‰è¡Œ
        $('#pricingTable tbody tr').each(function() {
            var $row = $(this);
            var productName = $row.find('.product-name').val();
            
            if (productName && productName.trim()) {
                // ğŸ”¥ é—®é¢˜ï¼šæ²¡æœ‰éªŒè¯å’Œä¿®å¤æ•°é‡å­—æ®µçš„data-raw-value
                // åªå¤„ç†äº†ä»·æ ¼ç›¸å…³å­—æ®µï¼Œå¿½ç•¥äº†æ•°é‡å­—æ®µçš„åˆå§‹åŒ–
            }
        });
    }
}
```

## è§£å†³æ–¹æ¡ˆ

### 1. ç»Ÿä¸€æ•°é‡è·å–å‡½æ•°

åˆ›å»ºä¸€ä¸ªç»Ÿä¸€çš„æ•°é‡è·å–å‡½æ•°ï¼Œç¡®ä¿æ‰€æœ‰åœ°æ–¹éƒ½ä½¿ç”¨ç›¸åŒçš„é€»è¾‘ï¼š

```javascript
// ç»Ÿä¸€çš„æ•°é‡è·å–å‡½æ•°
function getQuantityValue($row) {
    try {
        const $quantityInput = $row.find('.quantity');
        let quantity = parseInt($quantityInput.val());
        
        // æ£€æŸ¥æ˜¯å¦ä¸ºæœ‰æ•ˆæ•°å­—
        if (isNaN(quantity) || quantity < 1) {
            // å°è¯•ä»data-raw-valueè·å–
            const rawValue = $quantityInput.data('raw-value');
            if (rawValue && !isNaN(rawValue) && rawValue >= 1) {
                quantity = parseInt(rawValue);
                $quantityInput.val(quantity); // åŒæ­¥æ˜¾ç¤ºå€¼
            } else {
                // æœ€åçš„é»˜è®¤å€¼
                quantity = 1;
                $quantityInput.val('1');
                $quantityInput.data('raw-value', 1);
            }
        } else {
            // ä¿å­˜æœ‰æ•ˆçš„åŸå§‹å€¼
            $quantityInput.data('raw-value', quantity);
        }
        
        return quantity;
    } catch (e) {
        console.error('è·å–æ•°é‡å€¼æ—¶å‡ºé”™:', e);
        return 1;
    }
}
```

### 2. ä¿®å¤æ•°é‡è¾“å…¥éªŒè¯é€»è¾‘

æ”¹è¿›æ•°é‡è¾“å…¥çš„éªŒè¯å’Œå¤„ç†é€»è¾‘ï¼š

```javascript
// æ”¹è¿›çš„æ•°é‡å˜æ›´äº‹ä»¶å¤„ç†
$('#pricingTable, #settlementTable').on('input change', '.quantity', function() {
    var $row = $(this).closest('tr');
    var $input = $(this);
    var inputValue = $input.val().trim();
    
    console.log('æ•°é‡è¾“å…¥å˜æ›´:', inputValue);
    
    // å¦‚æœè¾“å…¥ä¸ºç©ºï¼Œæš‚æ—¶ä¸å¤„ç†ï¼Œç­‰å¾…ç”¨æˆ·å®Œæˆè¾“å…¥
    if (inputValue === '') {
        return;
    }
    
    var quantity = parseInt(inputValue);
    
    // éªŒè¯æ•°é‡è¾“å…¥
    if (isNaN(quantity) || quantity < 1) {
        // æ¢å¤åˆ°ä¹‹å‰çš„æœ‰æ•ˆå€¼æˆ–é»˜è®¤å€¼1
        var previousValue = $input.data('raw-value') || 1;
        quantity = previousValue;
        $input.val(quantity);
        console.log('æ•°é‡è¾“å…¥æ— æ•ˆï¼Œæ¢å¤ä¸º:', quantity);
    } else {
        // ä¿å­˜æœ‰æ•ˆçš„åŸå§‹å€¼
        $input.data('raw-value', quantity);
        console.log('æ•°é‡è¾“å…¥æœ‰æ•ˆï¼Œä¿å­˜ä¸º:', quantity);
    }
    
    // é‡æ–°è®¡ç®—å°è®¡å’Œæ€»ä»·
    calculateSubtotal($row);
    updateTableTotals(true);
});
```

### 3. ä¿®å¤ç§»åŠ¨ç«¯åŒæ­¥é—®é¢˜

æ”¹è¿›ç§»åŠ¨ç«¯å’Œæ¡Œé¢ç«¯çš„æ•°é‡åŒæ­¥é€»è¾‘ï¼š

```javascript
// æ”¹è¿›çš„ç§»åŠ¨ç«¯æ•°é‡è¾“å…¥æ¡†äº‹ä»¶ç»‘å®š
$(document).on('input change', '.mobile-card-input.quantity', function() {
    const $input = $(this);
    const $card = $input.closest('.mobile-product-card');
    const detailId = $card.data('detail-id');
    
    // ä½¿ç”¨ç»Ÿä¸€çš„æ•°é‡è·å–é€»è¾‘
    const quantity = getQuantityValue($card);
    
    console.log('ç§»åŠ¨ç«¯æ•°é‡å˜æ›´:', quantity);
    
    // åŒæ­¥åˆ°æ¡Œé¢ç«¯è¡¨æ ¼
    if (detailId) {
        const $desktopRow = $(`#pricingTable tr[data-detail-id="${detailId}"], #settlementTable tr[data-detail-id="${detailId}"]`);
        if ($desktopRow.length) {
            $desktopRow.find('.quantity').val(quantity).data('raw-value', quantity);
            // é‡æ–°è®¡ç®—æ¡Œé¢ç«¯çš„å°è®¡
            calculateSubtotal($desktopRow);
        }
    }
    
    // é‡æ–°è®¡ç®—ç§»åŠ¨ç«¯çš„å°è®¡
    calculateMobileRowValues($card, 'quantity');
});
```

### 4. ä¿®å¤åˆå§‹åŒ–é€»è¾‘

æ”¹è¿›é¡µé¢åˆå§‹åŒ–æ—¶çš„æ•°æ®å¤„ç†ï¼š

```javascript
// æ”¹è¿›çš„åˆå§‹åŒ–å‡½æ•°
function initializeExistingRows() {
    try {
        console.log('åˆå§‹åŒ–å·²æœ‰è¡Œæ•°æ®...');
        
        // åˆå§‹åŒ–æ‰¹ä»·å•è¡¨æ ¼çš„å·²æœ‰è¡Œ
        $('#pricingTable tbody tr').each(function() {
            var $row = $(this);
            var productName = $row.find('.product-name').val();
            
            if (productName && productName.trim()) {
                // åˆå§‹åŒ–æ•°é‡å­—æ®µ
                var $quantityInput = $row.find('.quantity');
                var quantityValue = parseInt($quantityInput.val()) || 1;
                $quantityInput.data('raw-value', quantityValue);
                
                // åˆå§‹åŒ–å…¶ä»–å­—æ®µ...
                initializeRowData($row);
                
                console.log('å·²æœ‰è¡Œåˆå§‹åŒ–:', {
                    äº§å“: productName,
                    æ•°é‡: quantityValue
                });
            }
        });
        
        // åˆå§‹åŒ–ç»“ç®—å•è¡¨æ ¼çš„å·²æœ‰è¡Œ
        $('#settlementTable tbody tr').each(function() {
            var $row = $(this);
            var productName = $row.find('.product-name').val();
            
            if (productName && productName.trim()) {
                // åˆå§‹åŒ–æ•°é‡å­—æ®µ
                var $quantityInput = $row.find('.quantity');
                var quantityValue = parseInt($quantityInput.val()) || 1;
                $quantityInput.data('raw-value', quantityValue);
                
                // åˆå§‹åŒ–å…¶ä»–å­—æ®µ...
                initializeRowData($row);
            }
        });
        
        console.log('å·²æœ‰è¡Œæ•°æ®åˆå§‹åŒ–å®Œæˆ');
    } catch (e) {
        console.error('åˆå§‹åŒ–å·²æœ‰è¡Œæ•°æ®æ—¶å‡ºé”™:', e);
    }
}
```

### 5. ä¿®å¤è®¡ç®—å‡½æ•°ä¸­çš„æ•°é‡è·å–

æ›´æ–°æ‰€æœ‰è®¡ç®—å‡½æ•°ä½¿ç”¨ç»Ÿä¸€çš„æ•°é‡è·å–é€»è¾‘ï¼š

```javascript
// ä¿®å¤ calculateSubtotal å‡½æ•°
function calculateSubtotal($row) {
    try {
        var quantity = getQuantityValue($row); // ä½¿ç”¨ç»Ÿä¸€å‡½æ•°
        var unitPrice = parseFloat($row.find('.discounted-price').data('raw-value')) || 0;
        
        console.log('=== å°è®¡è®¡ç®—è°ƒè¯• ===');
        console.log('æ•°é‡:', quantity);
        console.log('å•ä»·:', unitPrice);
        
        // è®¡ç®—å°è®¡
        var subtotal = quantity * unitPrice;
        console.log('å°è®¡è®¡ç®—: ' + quantity + ' * ' + unitPrice + ' = ' + subtotal);
        
        // æ›´æ–°å°è®¡æ˜¾ç¤º
        var formattedSubtotal = formatNumber(subtotal);
        $row.find('.subtotal')
            .val(formattedSubtotal)
            .data('raw-value', subtotal)
            .attr('title', formattedSubtotal);
        
        console.log('å°è®¡å·²æ›´æ–°: data-raw-value=' + subtotal + ', æ˜¾ç¤ºå€¼=' + formattedSubtotal);
        
        // ç«‹å³æ›´æ–°æ€»è®¡
        updateTableTotals();
        
        console.log('=== å°è®¡è®¡ç®—è°ƒè¯•ç»“æŸ ===');
        return subtotal;
    } catch (e) {
        console.error('è®¡ç®—å°è®¡æ—¶å‡ºé”™:', e);
        return 0;
    }
}

// ä¿®å¤ updateTotalDiscount å‡½æ•°
function updateTotalDiscount(tabType, value) {
    console.log('æ›´æ–°æ€»æŠ˜æ‰£ç‡:', tabType, value);
    
    const discountRate = parseFloat(value) / 100;
    const tableId = tabType === 'pricing' ? '#pricingTable' : '#settlementTable';
    
    $(`${tableId} tbody tr`).each(function() {
        const $row = $(this);
        const productName = $row.find('.product-name').val();
        
        if (productName && productName.trim()) {
            const marketPrice = parseFloat($row.find('.product-price').data('raw-value')) || 0;
            const quantity = getQuantityValue($row); // ä½¿ç”¨ç»Ÿä¸€å‡½æ•°
            
            // è®¡ç®—æ–°çš„å•ä»·å’Œå°è®¡
            const newUnitPrice = marketPrice * discountRate;
            const newSubtotal = newUnitPrice * quantity;
            
            // æ›´æ–°æ˜¾ç¤º...
        }
    });
    
    // å…¶ä½™é€»è¾‘ä¿æŒä¸å˜...
}
```

## ä¿®å¤ä¼˜å…ˆçº§

1. **é«˜ä¼˜å…ˆçº§**ï¼šç»Ÿä¸€æ•°é‡è·å–å‡½æ•° - è§£å†³æ ¸å¿ƒé—®é¢˜
2. **é«˜ä¼˜å…ˆçº§**ï¼šä¿®å¤è®¡ç®—å‡½æ•°ä¸­çš„æ•°é‡è·å–é€»è¾‘
3. **ä¸­ä¼˜å…ˆçº§**ï¼šæ”¹è¿›æ•°é‡è¾“å…¥éªŒè¯é€»è¾‘
4. **ä¸­ä¼˜å…ˆçº§**ï¼šä¿®å¤ç§»åŠ¨ç«¯åŒæ­¥é—®é¢˜
5. **ä½ä¼˜å…ˆçº§**ï¼šæ”¹è¿›åˆå§‹åŒ–é€»è¾‘

## æµ‹è¯•å»ºè®®

1. **åŸºç¡€åŠŸèƒ½æµ‹è¯•**ï¼š
   - è¾“å…¥æ­£å¸¸æ•°é‡å€¼ï¼ŒéªŒè¯è®¡ç®—æ˜¯å¦æ­£ç¡®
   - è¾“å…¥æ— æ•ˆæ•°é‡å€¼ï¼ˆå¦‚0ã€è´Ÿæ•°ã€å­—æ¯ï¼‰ï¼ŒéªŒè¯æ˜¯å¦æ­£ç¡®å¤„ç†

2. **è¾¹ç•Œæƒ…å†µæµ‹è¯•**ï¼š
   - æ•°é‡è¾“å…¥æ¡†ä¸ºç©ºæ—¶çš„å¤„ç†
   - æ•°é‡ä¸ºå°æ•°æ—¶çš„å¤„ç†
   - æ•°é‡éå¸¸å¤§æ—¶çš„å¤„ç†

3. **åŒæ­¥æµ‹è¯•**ï¼š
   - ç§»åŠ¨ç«¯ä¿®æ”¹æ•°é‡ï¼ŒéªŒè¯æ¡Œé¢ç«¯æ˜¯å¦åŒæ­¥
   - æ¡Œé¢ç«¯ä¿®æ”¹æ•°é‡ï¼ŒéªŒè¯ç§»åŠ¨ç«¯æ˜¯å¦åŒæ­¥

4. **è®¡ç®—å‡†ç¡®æ€§æµ‹è¯•**ï¼š
   - ä¿®æ”¹æŠ˜æ‰£ç‡åéªŒè¯å°è®¡æ˜¯å¦æ­£ç¡®
   - ä¿®æ”¹æ€»æŠ˜æ‰£ç‡åéªŒè¯æ‰€æœ‰è¡Œçš„è®¡ç®—æ˜¯å¦æ­£ç¡®
   - éªŒè¯æ€»é‡‘é¢è®¡ç®—æ˜¯å¦å‡†ç¡®

## é¢„æœŸæ•ˆæœ

ä¿®å¤åï¼Œæ‰¹ä»·å•å’Œç»“ç®—å•çš„å‰ç«¯è®¡ç®—åº”è¯¥èƒ½å¤Ÿï¼š

1. **å‡†ç¡®è·å–æ•°é‡**ï¼šæ— è®ºåœ¨ä»»ä½•è®¡ç®—åœºæ™¯ä¸‹éƒ½èƒ½è·å–åˆ°æ­£ç¡®çš„äº§å“æ•°é‡
2. **æ­£ç¡®è®¡ç®—å°è®¡**ï¼šå°è®¡ = æ•°é‡ Ã— å•ä»·ï¼Œè®¡ç®—ç»“æœå‡†ç¡®
3. **å‡†ç¡®è®¡ç®—æ€»é¢**ï¼šæ‰€æœ‰è¡Œçš„å°è®¡ç´¯åŠ ç»“æœæ­£ç¡®
4. **åŒæ­¥æ˜¾ç¤º**ï¼šç§»åŠ¨ç«¯å’Œæ¡Œé¢ç«¯çš„æ•°é‡æ˜¾ç¤ºä¿æŒä¸€è‡´
5. **ç”¨æˆ·ä½“éªŒ**ï¼šè¾“å…¥éªŒè¯æ›´å‹å¥½ï¼Œä¸ä¼šæ„å¤–è¦†ç›–ç”¨æˆ·çš„æœ‰æ•ˆè¾“å…¥

ä¿®å¤å®Œæˆåï¼Œç”¨æˆ·åœ¨è°ƒæ•´ä»·æ ¼ã€æŠ˜æ‰£ç‡æˆ–æ€»æŠ˜æ‰£ç‡æ—¶ï¼Œå‰ç«¯è®¡ç®—å°†å‡†ç¡®åæ˜ å®é™…çš„äº§å“æ•°é‡ï¼Œç¡®ä¿è®¡ç®—ç»“æœçš„æ­£ç¡®æ€§ã€‚ 