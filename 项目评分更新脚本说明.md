# PMA项目评分更新脚本使用说明

## 概述

`update_project_scores.py` 是一个专门用于重新计算本地数据库中所有项目评分的脚本。该脚本基于最新的评分逻辑，重新计算所有项目的评分，确保评分结果准确反映项目的当前状态。

## 功能特性

### 🔍 评分配置验证
- 自动检查评分配置的完整性
- 验证所有必要的评分规则是否存在
- 显示当前活跃的评分配置项

### 📊 项目统计分析
- 显示项目总数和按阶段分布
- 统计已有评分记录的项目数量
- 分析有报价单的项目情况

### 🔄 智能批量更新
- 支持批量处理，避免内存溢出
- 只更新评分有变化的项目
- 详细记录每个项目的评分变化

### 🛡️ 安全性保障
- 提供试运行模式，不修改数据库
- 交互式确认机制
- 完整的错误处理和回滚机制

## 评分逻辑

### 信息完整性得分 (最高0.5分)
- **项目阶段** (0.1分): 项目设置了当前阶段
- **项目分类** (0.1分): 项目设置了类型
- **设计顾问** (0.1分): 项目有设计问题且获得授权编号
- **用户信息** (0.1分): 项目设置了最终用户
- **总承包商** (0.1分): 项目设置了承包商
- **集成商** (0.1分): 项目设置了系统集成商

**评分规则**: 当各项信息得分总和≥0.5时，获得0.5分；否则为0分

### 报价完整性得分 (最高0.5分)
- **审核通过的报价单** (0.5分): 项目有已审核通过的报价单

### 阶段得分 (最高1.5分)
- **招投标阶段** (0.5分): `tendering`
- **中标阶段** (1.0分): `awarded`
- **批价阶段** (1.5分): `quoted`

### 手动奖励得分 (最高0.5分)
- **上级奖励** (0.5分): 由管理员手动授予

### 星级计算
- 总分 ≤ 0: 0星
- 总分 > 0: 按0.5分为一个半星计算，最低0.5星，最高5.0星

## 使用方法

### 基本运行
```bash
python update_project_scores.py
```

### 运行模式选择

运行脚本后，会出现交互式菜单：

```
请选择操作模式:
1. 试运行模式 (只计算不保存)
2. 正式更新模式 (计算并保存)
3. 仅查看统计信息
```

#### 模式说明

**1. 试运行模式**
- 执行完整的评分计算
- 显示所有变化详情
- **不会保存到数据库**
- 适用于：验证评分逻辑、检查影响范围

**2. 正式更新模式**
- 执行完整的评分计算并保存
- 需要二次确认
- 会更新数据库中的评分记录
- 适用于：正式的评分更新操作

**3. 仅查看统计信息**
- 不执行计算，只显示当前评分统计
- 适用于：了解当前评分分布情况

## 输出信息

### 评分配置验证
```
=== 验证评分配置 ===
找到 11 个活跃的评分配置项:
  information: 6 项
    - project_stage: 0.10分 (项目阶段)
    - project_category: 0.10分 (项目分类)
    ...
✓ 所有必要的评分配置都已存在
```

### 项目统计信息
```
=== 项目统计信息 ===
项目总数: 435
按阶段分布:
  awarded: 79 个项目
  embed: 105 个项目
  discover: 35 个项目
  ...
已有评分记录的项目: 434
有报价单的项目: 263
```

### 评分更新过程
```
=== 开始重新计算项目评分 ===
待处理项目总数: 435
处理批次 1/9: 50 个项目
  ✓ 项目 [274] 金桥地铁上盖...
    评分变化: 1.50→0.50, 星级: 1.5→0.5
    详细得分: 信息(0.00) + 报价(0.50) + 阶段(0.00) + 手动(0.00)
```

### 最终结果统计
```
=== 评分更新完成 ===
总计处理: 435 个项目
成功计算: 435 个
评分更新: 18 个
评分未变: 417 个
计算失败: 0 个
```

### 评分分布验证
```
=== 验证评分结果 ===
评分分布:
  0-0.5分: 275 个项目
  0.5-1.0分: 70 个项目
  1.0-1.5分: 82 个项目
  ...
星级分布:
  0.0星: 275 个项目
  0.5星: 70 个项目
  1.0星: 82 个项目
  ...
```

## 日志文件

脚本运行时会生成日志文件 `project_scoring_update.log`，包含：
- 完整的运行过程记录
- 每个项目的评分变化详情
- 错误信息和异常处理记录

## 注意事项

### 🚨 安全警告
- **生产环境使用前请先备份数据库**
- **建议先在测试环境验证结果**
- **正式更新前请使用试运行模式检查**

### ⚠️ 使用限制
- 脚本需要在PMA项目根目录下运行
- 需要配置正确的数据库连接
- 确保数据库中存在完整的评分配置

### 📋 前置条件
- Python 3.7+
- PMA应用环境正确配置
- 数据库连接正常
- 评分配置数据完整

## 常见问题

### Q: 为什么有些项目评分为0？
A: 项目评分为0可能的原因：
- 项目信息不完整（信息完整性得分<0.5）
- 没有审核通过的报价单
- 项目阶段不在评分范围内
- 没有手动奖励

### Q: 评分更新后项目列表页面显示不一致？
A: 可能的原因：
- 浏览器缓存，请刷新页面
- 项目表的rating字段未同步，脚本会自动修复

### Q: 如何修改评分规则？
A: 评分规则在 `project_scoring_config` 表中配置，可通过管理界面或直接修改数据库

## 维护建议

### 定期执行
- **月度更新**: 每月执行一次完整的评分更新
- **重大变更后**: 修改评分规则后立即执行
- **数据导入后**: 批量导入项目数据后执行

### 监控指标
- 评分分布是否合理
- 0分项目数量是否异常
- 评分与实际项目状态是否匹配

---

**最后更新**: 2025-06-09  
**脚本版本**: 1.0  
**适用于**: PMA项目管理系统 v1.2+ 