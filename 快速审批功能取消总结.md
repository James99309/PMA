# å¿«é€Ÿå®¡æ‰¹åŠŸèƒ½å–æ¶ˆæ€»ç»“

## ğŸ“‹ ç”¨æˆ·éœ€æ±‚

ç”¨æˆ·è¦æ±‚ï¼š
1. **å–æ¶ˆå¿«é€Ÿå®¡æ‰¹é€šè¿‡åŠŸèƒ½**
2. **ä¿ç•™å®¡æ‰¹äººè¶…å‡ºæƒé™èŒƒå›´çš„å¾½ç« æç¤ºåŠŸèƒ½**

## âœ… å®ç°å†…å®¹

### 1. å–æ¶ˆå¿«é€Ÿå®¡æ‰¹åŠŸèƒ½

#### ä¿®æ”¹æ–‡ä»¶ï¼š`app/services/pricing_order_service.py`

**æ³¨é‡Šæ‰å¿«é€Ÿå®¡æ‰¹è§„åˆ™**ï¼š
```python
# å¿«é€Ÿé€šè¿‡æŠ˜æ‰£ç‡è§„åˆ™ - å·²å–æ¶ˆå¿«é€Ÿå®¡æ‰¹åŠŸèƒ½
# FAST_APPROVAL_RULES = {
#     'æ¸ é“ç»ç†': 40.5,
#     'è¥é”€æ€»ç›‘': 38.0,
#     'æœåŠ¡ç»ç†': 40.5,
#     'æ€»ç»ç†': 0.0  # æ€»ç»ç†æ— é™åˆ¶
# }
```

**ä¿®æ”¹å®¡æ‰¹æ­¥éª¤é€»è¾‘**ï¼š
```python
elif action == 'approve':
    # å·²å–æ¶ˆå¿«é€Ÿå®¡æ‰¹åŠŸèƒ½ï¼Œå®¡æ‰¹æ­¥éª¤éœ€è¦é€æ­¥è¿›è¡Œ
    # æ£€æŸ¥æ˜¯å¦è¿˜æœ‰ä¸‹ä¸€æ­¥
    next_step = PricingOrderApprovalRecord.query.filter_by(
        pricing_order_id=pricing_order_id,
        step_order=step_order + 1
    ).first()
    
    if next_step:
        # è¿›å…¥ä¸‹ä¸€æ­¥
        pricing_order.current_approval_step = step_order + 1
    else:
        # æœ€åä¸€æ­¥ï¼šå®Œæˆå®¡æ‰¹
        pricing_order.status = 'approved'
        pricing_order.approved_by = current_user_id
        pricing_order.approved_at = datetime.now()
        pricing_order.current_approval_step = 0
        
        PricingOrderService.complete_approval(pricing_order)
```

**æ³¨é‡Šæ‰å¿«é€Ÿå®¡æ‰¹ç›¸å…³æ–¹æ³•**ï¼š
```python
# å·²å–æ¶ˆå¿«é€Ÿå®¡æ‰¹åŠŸèƒ½ï¼Œæ³¨é‡Šæ‰ç›¸å…³æ–¹æ³•
# @staticmethod
# def auto_approve_remaining_steps(pricing_order, current_user_id, fast_approval_role):
#     ...
# 
# @staticmethod
# def check_fast_approval(approval_record, pricing_order):
#     ...
```

### 2. ä¿ç•™æƒé™æç¤ºå¾½ç« åŠŸèƒ½

#### ä¿®æ”¹æ–‡ä»¶ï¼š`app/helpers/approval_helpers.py`

**æ¢å¤æƒé™æ£€æŸ¥åŠŸèƒ½**ï¼š
```python
def get_approval_step_discount_status(pricing_order):
    """
    è·å–æ‰¹ä»·å•å®¡æ‰¹æµç¨‹ä¸­å„æ­¥éª¤çš„æŠ˜æ‰£æƒé™çŠ¶æ€
    
    æ³¨æ„ï¼šå¿«é€Ÿå®¡æ‰¹åŠŸèƒ½å·²å–æ¶ˆï¼Œä½†ä¿ç•™æƒé™æç¤ºå¾½ç« åŠŸèƒ½
    å½“å®¡æ‰¹äººè¶…å‡ºæƒé™èŒƒå›´æ—¶ï¼Œåœ¨å…¶æ‰€åœ¨çš„å®¡æ‰¹ç¯èŠ‚æ˜¾ç¤ºæƒé™å¾½ç« 
    """
    try:
        step_statuses = {}
        
        # æ£€æŸ¥æµç¨‹å‘èµ·äººï¼ˆåˆ›å»ºè€…ï¼‰çš„æƒé™
        if pricing_order.created_by:
            creator_status = check_step_discount_violations(
                pricing_order, 0, pricing_order.created_by
            )
            if creator_status['has_violation']:
                # ... è®°å½•å‘èµ·äººæƒé™è¿è§„
        
                 # æ£€æŸ¥å·²å®Œæˆçš„å®¡æ‰¹è®°å½•ï¼ˆåªæ£€æŸ¥å·²å®¡æ‰¹é€šè¿‡æˆ–æäº¤çš„æ­¥éª¤ï¼‰
         for record in pricing_order.approval_records:
             if record.action and record.approver_id:  # åªæ£€æŸ¥å·²å®¡æ‰¹çš„æ­¥éª¤
                 # ... æ£€æŸ¥æ¯ä¸ªå®¡æ‰¹æ­¥éª¤çš„æƒé™è¿è§„
         
         # æ³¨æ„ï¼šä¸æ£€æŸ¥å½“å‰å¾…å®¡æ‰¹æ­¥éª¤çš„æƒé™ï¼Œåªåœ¨å®¡æ‰¹æäº¤åæ‰æ˜¾ç¤ºæƒé™å¾½ç« 
         # è¿™æ ·ç¡®ä¿æƒé™å¾½ç« åªåœ¨å®¡æ‰¹äººå·²ç»åšå‡ºå†³ç­–åæ‰æ˜¾ç¤º
        
        return step_statuses
        
    except Exception as e:
        print(f"è·å–å®¡æ‰¹æ­¥éª¤æƒé™çŠ¶æ€å¤±è´¥: {str(e)}")
        return {}
```

#### ä¿®æ”¹å‰ç«¯æ¨¡æ¿ï¼š`app/templates/pricing_order/edit_pricing_order.html`

**æµç¨‹å‘èµ·èŠ‚ç‚¹æƒé™å¾½ç« **ï¼š
```html
<h6 class="timeline-title">
    æµç¨‹å‘èµ·
    {% if step_discount_statuses.get(0, {}).get('has_violation', False) %}
        <span class="badge bg-danger ms-2" title="å‘èµ·äººæƒé™ä¸è¶³ï¼Œå­˜åœ¨æŠ˜æ‰£è¶…å‡º">
            <i class="fas fa-exclamation-triangle"></i> æƒé™è¶…å‡º
        </span>
    {% endif %}
</h6>

{% if step_discount_statuses.get(0, {}).get('has_violation', False) %}
    <div class="mt-2 p-2 bg-danger-light rounded">
        <small class="text-danger">
            <i class="fas fa-exclamation-triangle me-1"></i>
            å‘èµ·äººè®¾ç½®çš„æŠ˜æ‰£ç‡ä½äºå…¶æƒé™ä¸‹é™ï¼Œéœ€è¦å®¡æ‰¹äººå…³æ³¨
        </small>
    </div>
{% endif %}
```

**å®¡æ‰¹æ­¥éª¤æƒé™å¾½ç« **ï¼š
```html
<h6 class="timeline-title">
    æ­¥éª¤ {{ record.step_order }}: {{ record.step_name }}
    {% if step_discount_statuses.get(record.step_order, {}).get('has_violation', False) %}
        <span class="badge bg-danger ms-2" title="å®¡æ‰¹äººæƒé™ä¸è¶³ï¼Œå­˜åœ¨æŠ˜æ‰£è¶…å‡º">
            <i class="fas fa-exclamation-triangle"></i> æƒé™è¶…å‡º
        </span>
    {% endif %}
</h6>
```

## ğŸ¯ åŠŸèƒ½å¯¹æ¯”

### ä¿®æ”¹å‰
- âœ… **å¿«é€Ÿå®¡æ‰¹**ï¼šæ»¡è¶³æŠ˜æ‰£ç‡æ¡ä»¶æ—¶è‡ªåŠ¨è·³è¿‡åç»­æ­¥éª¤
- âœ… **æƒé™å¾½ç« **ï¼šæ˜¾ç¤ºè¶…å‡ºæƒé™èŒƒå›´çš„å®¡æ‰¹æ­¥éª¤
- âŒ **é€æ­¥å®¡æ‰¹**ï¼šæ— æ³•å¼ºåˆ¶æ¯ä¸ªæ­¥éª¤éƒ½è¦å®¡æ‰¹

### ä¿®æ”¹å
- âŒ **å¿«é€Ÿå®¡æ‰¹**ï¼šå·²å–æ¶ˆï¼Œä¸å†è‡ªåŠ¨è·³è¿‡æ­¥éª¤
- âœ… **æƒé™å¾½ç« **ï¼šä¿ç•™ï¼Œç»§ç»­æ˜¾ç¤ºè¶…å‡ºæƒé™çš„æ­¥éª¤
- âœ… **é€æ­¥å®¡æ‰¹**ï¼šå¼ºåˆ¶æ¯ä¸ªå®¡æ‰¹æ­¥éª¤éƒ½è¦äººå·¥å®¡æ‰¹

## ğŸ” æƒé™å¾½ç« åŠŸèƒ½è¯´æ˜

### å¾½ç« æ˜¾ç¤ºæ¡ä»¶
å½“ä»¥ä¸‹æƒ…å†µå‘ç”Ÿæ—¶æ˜¾ç¤ºçº¢è‰²æƒé™å¾½ç« ï¼š

1. **å‘èµ·äººæƒé™è¶…å‡º**ï¼š
   - æ‰¹ä»·æ˜ç»†æŠ˜æ‰£ç‡ < å‘èµ·äººæ‰¹ä»·æƒé™ä¸‹é™
   - æ‰¹ä»·æ€»æŠ˜æ‰£ç‡ < å‘èµ·äººæ‰¹ä»·æƒé™ä¸‹é™
   - ç»“ç®—æ˜ç»†æŠ˜æ‰£ç‡ < å‘èµ·äººç»“ç®—æƒé™ä¸‹é™
   - ç»“ç®—æ€»æŠ˜æ‰£ç‡ < å‘èµ·äººç»“ç®—æƒé™ä¸‹é™

2. **å·²å®Œæˆå®¡æ‰¹æ­¥éª¤çš„æƒé™è¶…å‡º**ï¼š
   - åªæœ‰å·²å®¡æ‰¹é€šè¿‡æˆ–æäº¤çš„æ­¥éª¤æ‰æ˜¾ç¤ºæƒé™å¾½ç« 
   - å¾…å®¡æ‰¹çš„æ­¥éª¤ä¸æ˜¾ç¤ºæƒé™å¾½ç« ï¼Œç¡®ä¿åœ¨å®¡æ‰¹äººåšå‡ºå†³ç­–åæ‰æ˜¾ç¤º

### å¾½ç« æ ·å¼
- **é¢œè‰²**ï¼šçº¢è‰²èƒŒæ™¯ (`bg-danger`)
- **å›¾æ ‡**ï¼šè­¦å‘Šä¸‰è§’å½¢ (`fas fa-exclamation-triangle`)
- **æ–‡å­—**ï¼šæƒé™è¶…å‡º
- **æç¤º**ï¼šé¼ æ ‡æ‚¬åœæ˜¾ç¤ºè¯¦ç»†è¯´æ˜

### æ˜¾ç¤ºä½ç½®
- **æµç¨‹å‘èµ·èŠ‚ç‚¹**ï¼šåœ¨"æµç¨‹å‘èµ·"æ ‡é¢˜æ—æ˜¾ç¤º
- **å®¡æ‰¹æ­¥éª¤èŠ‚ç‚¹**ï¼šåœ¨"æ­¥éª¤X: æ­¥éª¤åç§°"æ ‡é¢˜æ—æ˜¾ç¤º
- **è¯¦æƒ…æç¤º**ï¼šåœ¨æ—¶é—´çº¿å†…å®¹åŒºåŸŸæ˜¾ç¤ºè§£é‡Šæ€§æ–‡å­—

## ğŸ“Š ä¸šåŠ¡å½±å“

### 1. å®¡æ‰¹æµç¨‹å˜åŒ–
- **æ›´ä¸¥æ ¼çš„å®¡æ‰¹**ï¼šæ‰€æœ‰æ­¥éª¤éƒ½éœ€è¦äººå·¥å®¡æ‰¹ï¼Œæé«˜å®¡æ‰¹è´¨é‡
- **é€æ˜çš„æƒé™ç®¡ç†**ï¼šæ¸…æ™°æ˜¾ç¤ºå“ªäº›ç¯èŠ‚å­˜åœ¨æƒé™é—®é¢˜
- **åˆè§„æ€§ä¿éšœ**ï¼šç¡®ä¿æŠ˜æ‰£æƒé™æ”¿ç­–å¾—åˆ°ä¸¥æ ¼æ‰§è¡Œ

### 2. ç”¨æˆ·ä½“éªŒä¼˜åŒ–
- **æ˜ç¡®çš„æƒé™æç¤º**ï¼šå®¡æ‰¹äººå¯ä»¥ç«‹å³è¯†åˆ«æƒé™è¶…å‡ºæƒ…å†µ
- **å†³ç­–æ”¯æŒ**ï¼šåŸºäºæƒé™æƒ…å†µåšå‡ºæ›´æ˜æ™ºçš„å®¡æ‰¹å†³ç­–
- **è¿‡ç¨‹å¯è¿½æº¯**ï¼šå®Œæ•´è®°å½•æƒé™è¿è§„çš„å®¡æ‰¹å†å²

### 3. é£é™©æ§åˆ¶åŠ å¼º
- **æ— å¿«é€Ÿé€šé“ç»•è¿‡**ï¼šé˜²æ­¢é€šè¿‡å¿«é€Ÿå®¡æ‰¹ç»•è¿‡å…³é”®å®¡æ‰¹ç¯èŠ‚
- **æƒé™é€æ˜åŒ–**ï¼šæ‰€æœ‰æƒé™é—®é¢˜éƒ½ä¼šæ˜ç¡®æ˜¾ç¤º
- **å®¡æ‰¹è´£ä»»æ˜ç¡®**ï¼šæ¯ä¸ªå®¡æ‰¹äººéƒ½è¦æ˜ç¡®è´Ÿè´£è‡ªå·±çš„å®¡æ‰¹å†³ç­–

## ğŸ§ª éªŒè¯è¦ç‚¹

### åŠŸèƒ½éªŒè¯æ¸…å•
- [ ] å¿«é€Ÿå®¡æ‰¹åŠŸèƒ½å·²å®Œå…¨å–æ¶ˆ
- [ ] å®¡æ‰¹æµç¨‹å¿…é¡»é€æ­¥è¿›è¡Œ
- [ ] æƒé™å¾½ç« æ­£å¸¸æ˜¾ç¤º
- [ ] å‘èµ·äººæƒé™è¶…å‡ºæ—¶æ˜¾ç¤ºçº¢è‰²å¾½ç« 
- [ ] å®¡æ‰¹äººæƒé™è¶…å‡ºæ—¶æ˜¾ç¤ºçº¢è‰²å¾½ç« 
- [ ] æƒé™æç¤ºæ–‡å­—æ­£ç¡®æ˜¾ç¤º
- [ ] æŠ˜æ‰£æƒé™æ£€æŸ¥é€»è¾‘æ­£å¸¸å·¥ä½œ

### æµ‹è¯•åœºæ™¯
1. **åˆ›å»ºè¶…å‡ºæƒé™çš„æ‰¹ä»·å•**ï¼šéªŒè¯å‘èµ·äººå¾½ç« æ˜¾ç¤º
2. **å®¡æ‰¹äººæƒé™ä¸è¶³**ï¼šéªŒè¯å®¡æ‰¹æ­¥éª¤å¾½ç« æ˜¾ç¤º
3. **æ­£å¸¸æƒé™èŒƒå›´**ï¼šéªŒè¯ä¸æ˜¾ç¤ºæƒé™å¾½ç« 
4. **å¤šæ­¥éª¤å®¡æ‰¹**ï¼šéªŒè¯æ¯ä¸ªæ­¥éª¤éƒ½éœ€è¦äººå·¥å®¡æ‰¹

## ğŸ“ ç›¸å…³æ–‡ä»¶æ¸…å•

### åç«¯æ–‡ä»¶
- `app/services/pricing_order_service.py` - å¿«é€Ÿå®¡æ‰¹é€»è¾‘æ³¨é‡Š
- `app/helpers/approval_helpers.py` - æƒé™æ£€æŸ¥åŠŸèƒ½æ¢å¤
- `app/routes/pricing_order_routes.py` - æƒé™çŠ¶æ€æ•°æ®ä¼ é€’

### å‰ç«¯æ–‡ä»¶
- `app/templates/pricing_order/edit_pricing_order.html` - æƒé™å¾½ç« æ˜¾ç¤º

### é…ç½®æ–‡ä»¶
- `å¿«é€Ÿå®¡æ‰¹åŠŸèƒ½å–æ¶ˆæ€»ç»“.md` - æœ¬æ–‡æ¡£

## âš ï¸ é‡è¦ä¿®æ­£

æ ¹æ®ç”¨æˆ·åé¦ˆï¼Œæƒé™å¾½ç« æ˜¾ç¤ºé€»è¾‘è¿›è¡Œäº†é‡è¦ä¿®æ­£ï¼š

**ä¿®æ­£å‰**ï¼šå½“å‰å¾…å®¡æ‰¹æ­¥éª¤ä¹Ÿä¼šæ˜¾ç¤ºæƒé™å¾½ç« 
**ä¿®æ­£å**ï¼šåªæœ‰å·²å®¡æ‰¹é€šè¿‡æˆ–æäº¤çš„æ­¥éª¤æ‰æ˜¾ç¤ºæƒé™å¾½ç« 

è¿™æ ·ç¡®ä¿ï¼š
- æƒé™å¾½ç« åªåœ¨å®¡æ‰¹äººåšå‡ºå†³ç­–**å**æ‰æ˜¾ç¤º
- å¾…å®¡æ‰¹çš„æ­¥éª¤ä¸ä¼šæå‰æ˜¾ç¤ºæƒé™è­¦å‘Š
- ç¬¦åˆä¸šåŠ¡é€»è¾‘ï¼šåªæœ‰åœ¨è¡Œä¸ºå‘ç”Ÿåæ‰è¿›è¡Œæƒé™æç¤º

## ğŸ‰ æ€»ç»“

é€šè¿‡æœ¬æ¬¡ä¿®æ”¹ï¼ŒæˆåŠŸå®ç°äº†ç”¨æˆ·çš„éœ€æ±‚ï¼š
1. âœ… **å®Œå…¨å–æ¶ˆå¿«é€Ÿå®¡æ‰¹åŠŸèƒ½**ï¼Œç¡®ä¿æ‰€æœ‰å®¡æ‰¹æ­¥éª¤éƒ½éœ€è¦äººå·¥å®¡æ‰¹
2. âœ… **ä¿ç•™æƒé™æç¤ºå¾½ç« **ï¼Œåœ¨å®¡æ‰¹å®Œæˆåæé†’ç›¸å…³äººå‘˜æ³¨æ„æƒé™è¶…å‡ºæƒ…å†µ
3. âœ… **ä¿æŒç°æœ‰æŠ˜æ‰£æƒé™æ£€æŸ¥**ï¼Œè¾“å…¥æ¡†çº¢è‰²è­¦å‘ŠåŠŸèƒ½ç»§ç»­æ­£å¸¸å·¥ä½œ
4. âœ… **ä¿®æ­£å¾½ç« æ˜¾ç¤ºæ—¶æœº**ï¼Œåªåœ¨å®¡æ‰¹å†³ç­–åæ˜¾ç¤ºï¼Œä¸åœ¨å¾…å®¡æ‰¹æ—¶æå‰æ˜¾ç¤º

è¿™æ ·çš„è®¾è®¡å¹³è¡¡äº†å®¡æ‰¹æ•ˆç‡å’Œé£é™©æ§åˆ¶ï¼Œæ—¢ä¿è¯äº†å®¡æ‰¹æµç¨‹çš„å®Œæ•´æ€§ï¼Œåˆæä¾›äº†å‡†ç¡®æ—¶æœºçš„æƒé™ç®¡ç†æç¤ºã€‚ 