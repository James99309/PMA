<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="csrf-token" content="ImMyYzcyOTkxMDhjYTY2NDhiYjE1NjQxYWFkMzViYjI3YjAzNDQwMTci.aEZIFg._o0f2LiUOUFgknXyMyvzDwrr9S4">
    <title>é¡¹ç›®ç®¡ç†</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --pa-blue: #16a0bf;
            --pa-dark-blue: #0e7c8f;
            --pa-light-blue: #1db0d3;
            --pa-bg-light: #f8f9fa;
        }
        body {
            background-color: #fff;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .top-nav {
            background-color: #17a2b8;
            color: white;
            padding: 0.5rem 1rem;
            font-size: 0.9rem;
        }
        .top-nav a {
            color: white;
            text-decoration: none;
            margin-left: 15px;
        }
        .top-nav .user-dropdown {
            position: relative;
            display: inline-block;
        }
        .top-nav .user-dropdown-toggle {
            cursor: pointer;
            display: flex;
            align-items: center;
            padding: 0 10px;
            min-width: 150px;
            text-align: right;
        }
        .top-nav .user-dropdown-toggle:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }
        .top-nav .user-dropdown-menu {
            position: absolute;
            right: 0;
            top: 100%;
            background-color: #fff;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: none;
            z-index: 1000;
            min-width: 160px;
        }
        .top-nav .user-dropdown-menu.show {
            display: block;
        }
        .top-nav .user-dropdown-item {
            display: block;
            padding: 8px 15px;
            color: #333;
            text-decoration: none;
        }
        .top-nav .user-dropdown-item:hover {
            background-color: #f5f5f5;
        }
        .top-nav .user-dropdown-item i {
            margin-right: 8px;
            width: 16px;
            text-align: center;
        }
        .top-nav .user-info {
            display: flex;
            align-items: center;
        }
        .top-nav .user-avatar {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background-color: #0b5ed7;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 8px;
            font-size: 12px;
        }
        .top-nav .badge {
            font-size: 0.7rem;
            font-weight: normal;
            padding: 0.2em 0.6em;
            margin-left: 5px;
        }
        .top-nav .user-info span {
            display: flex;
            align-items: center;
        }
        .logo {
            display: flex;
            align-items: center;
            font-size: 1.4rem;
            margin: 10px 0;
        }
        .logo img {
            height: 40px;
            margin-right: 10px;
        }
        .logo span {
            color: var(--pa-blue);
            font-weight: 300;
        }
        .logo strong {
            color: #333;
        }
        .main-nav {
            background: #16a0bf;
            margin-bottom: 20px;
            border-bottom: none;
        }
        .main-nav .nav-tabs {
            border-bottom: none;
        }
        .main-nav .nav-link {
            color: #fff !important;
            font-weight: 500;
            font-size: 14px;
            padding: 0.7rem 1.1rem;
            border-bottom: none;
            background: transparent;
            transition: color 0.2s;
            white-space: nowrap;
        }
        .main-nav .nav-link.active, .main-nav .nav-link:focus {
            color: var(--pa-blue) !important;
            background: #fff;
            border-radius: 6px 6px 0 0;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
        }
        .main-nav .nav-link:not(.active):hover {
            color: var(--pa-blue) !important;
            background: transparent;
        }
        .main-nav .nav-link:not(.active) {
            color: #fff !important;
            background: transparent;
        }
        .main-nav .nav-item {
            margin-bottom: 0;
        }
        .main-nav .user-dropdown-toggle, .main-nav .user-dropdown-menu {
            background: transparent;
        }
        .main-nav .user-dropdown-menu {
            min-width: 180px;
        }
        .main-nav .user-dropdown-item {
            color: #333;
        }
        .main-nav .user-dropdown-item:hover {
            background: #f5f5f5;
        }
        .main-nav .user-info {
            color: #fff;
            font-weight: 500;
            font-size: 14px;
            white-space: nowrap;
        }
        .main-nav .user-avatar {
            background: #0b5ed7;
            color: #fff;
        }
        .main-nav .user-dropdown-toggle {
            min-width: 0;
        }
        .main-nav .user-dropdown {
            margin-left: 1.5rem;
        }
        .main-nav .d-flex.align-items-center.ms-auto {
            gap: 0.5rem;
            flex-wrap: nowrap;
        }
        .main-nav .nav-link {
            display: inline-block;
            vertical-align: middle;
        }
        .btn-primary {
            background-color: var(--pa-blue);
            border-color: var(--pa-blue);
        }
        .btn-primary:hover {
            background-color: var(--pa-dark-blue);
            border-color: var(--pa-dark-blue);
        }
        .btn-outline-primary {
            color: var(--pa-blue);
            border-color: var(--pa-blue);
        }
        .btn-outline-primary:hover {
            background-color: var(--pa-blue);
            border-color: var(--pa-blue);
        }
        .card {
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            border: 1px solid #e7e7e7;
            margin-bottom: 20px;
        }
        .card-header {
            background-color: #fff;
            border-bottom: 1px solid #e7e7e7;
            font-weight: 500;
        }
        .dashboard-card {
            border-radius: 4px;
            border: 1px solid #e7e7e7;
            padding: 15px;
            height: 100%;
        }
        .dashboard-title {
            font-size: 1.1rem;
            font-weight: 500;
            margin-bottom: 15px;
            color: #333;
        }
        .card-title {
            font-size: 1.1rem;
            font-weight: 500;
            margin-bottom: 15px;
            color: #333;
        }
        
        /* å¤šçº§ä¸‹æ‹‰èœå•æ ·å¼ */
        .dropdown-submenu {
            position: absolute;
            left: 100%;
            top: 0;
            margin-top: 0;
            border-radius: 4px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: none;
        }
        
        .dropdown-item.dropdown-toggle {
            position: relative;
        }
        
        .dropdown-item.dropdown-toggle::after {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
        }
        
        .dropdown-item.dropdown-toggle:hover + .dropdown-submenu,
        .dropdown-submenu:hover {
            display: block;
        }
        
        .dropdown-item.dropdown-toggle:active,
        .dropdown-item.dropdown-toggle:focus {
            color: #fff;
            background-color: var(--pa-blue);
        }
    </style>
    <link href="/static/css/style.css" rel="stylesheet">
    
    
</head>
<body>
    <!-- å›ºå®šé¡¶éƒ¨ä¸»å¯¼èˆªï¼Œå«logoã€ç³»ç»Ÿåã€èœå•ã€è´¦æˆ· -->
    <nav class="main-nav navbar navbar-expand-lg navbar-dark" style="background-color: #16a0bf; z-index: 1040; position: fixed; top: 0; width: 100%;">
        <div class="container d-flex align-items-center justify-content-between flex-wrap">
            <div class="d-flex align-items-center logo-title-wrap w-100 w-lg-auto py-2 py-lg-0" style="min-height: 44px;">
                <img src="/static/img/logo.png" alt="Logo" class="main-logo" style="max-height: 48px; width: auto; margin-right: 8px; object-fit: contain;">
                <span class="logo-title text-truncate" style="font-size: 2rem; font-weight: bold; color: #fff; white-space: nowrap; overflow: visible; max-width: none;">ä¸šåŠ¡æœºä¼šç®¡ç†ç³»ç»Ÿ</span>
                <button class="navbar-toggler ms-auto" type="button" data-bs-toggle="collapse" data-bs-target="#mainNavbar" aria-controls="mainNavbar" aria-expanded="false" aria-label="åˆ‡æ¢å¯¼èˆª" style="border: none; box-shadow: none;">
                    <span class="navbar-toggler-icon"></span>
                </button>
            </div>
            <div class="collapse navbar-collapse" id="mainNavbar">
                <ul class="navbar-nav main-menu-list" style="width: 220px; max-width: 90vw;">
                    
                    <li class="nav-item">
                        <a class="nav-link text-sm py-2 " href="/">ä»ªè¡¨ç›˜</a>
                    </li>
                    
                    <li class="nav-item">
                        <a class="nav-link text-sm py-2 " href="/customer/">å®¢æˆ·ç®¡ç†</a>
                    </li>
                    
                    
                    <li class="nav-item">
                        <a class="nav-link text-sm py-2 active" href="/project/">é¡¹ç›®ç®¡ç†</a>
                    </li>
                    
                    
                    <li class="nav-item d-lg-none">
                        <details>
                            <summary class="nav-link text-sm py-2 mb-0 " style="cursor:pointer;display:flex;align-items:center;justify-content:space-between;">
                                <span>æŠ¥ä»·ç®¡ç†</span>
                                <svg class="ms-1" width="14" height="14" viewBox="0 0 20 20" fill="none"><path d="M6 8l4 4 4-4" stroke="#fff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
                            </summary>
                            <ul class="list-unstyled ps-3 mb-0">
                                <li><a class="nav-link text-sm py-2" href="/quotation/quotations">æŠ¥ä»·å•åˆ—è¡¨</a></li>
                                <li><a class="nav-link text-sm py-2" href="/product_analysis/analysis">äº§å“åˆ†æ</a></li>
                            </ul>
                        </details>
                    </li>
                    <li class="nav-item dropdown d-none d-lg-block">
                        <a class="nav-link dropdown-toggle text-sm py-2 "
                           href="#" id="quotationDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                            æŠ¥ä»·ç®¡ç†
                        </a>
                        <ul class="dropdown-menu" aria-labelledby="quotationDropdown">
                            <li><a class="dropdown-item" href="/quotation/quotations">æŠ¥ä»·å•åˆ—è¡¨</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="/product_analysis/analysis">äº§å“åˆ†æ</a></li>
                        </ul>
                    </li>
                    
                    
                    <li class="nav-item">
                        <a class="nav-link text-sm py-2 " href="/products">äº§å“åº“</a>
                    </li>
                    
                    
                    
                    
                    
                    
                </ul>
                <!-- PCç«¯è´¦æˆ·logoå’Œé€€å‡º -->
                
                <div class="d-none d-lg-flex align-items-center ms-auto">
                  <div class="dropdown">
                    <div class="user-avatar-capsule position-relative" id="userDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                      <div class="d-flex align-items-center">
                        <span class="avatar-initial">N</span>
                        <span class="user-name">NIJIE</span>
                        <i class="fas fa-caret-down dropdown-arrow"></i>
                      </div>
                      
                      
                      <span class="notification-badge">1</span>
                      
                    </div>
                    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="userDropdown">
                      <li>
                        <a class="dropdown-item" href="/user/profile">
                          <i class="fas fa-user-cog me-2"></i> ä¸ªäººè®¾ç½®
                        </a>
                      </li>
                      <li>
                        <a class="dropdown-item" href="/notification/center">
                          <i class="fas fa-bell me-2"></i> é€šçŸ¥ä¸­å¿ƒ
                        </a>
                      </li>
                      <li>
                        <a class="dropdown-item" href="/approval/center">
                          <i class="fas fa-tasks me-2"></i> å®¡æ‰¹ä¸­å¿ƒ
                          
                          
                          <span class="badge rounded-pill bg-danger ms-1">1</span>
                          
                        </a>
                      </li>
                      <li>
                        <a class="dropdown-item" href="/admin/history/">
                          <i class="fas fa-history me-2"></i> å†å²è®°å½•
                        </a>
                      </li>
                      <li><hr class="dropdown-divider"></li>
                      <li>
                        <a class="dropdown-item" href="/auth/logout">
                          <i class="fas fa-sign-out-alt me-2"></i> é€€å‡ºç³»ç»Ÿ
                        </a>
                      </li>
                    </ul>
                  </div>
                </div>
                <!-- ç§»åŠ¨ç«¯è´¦æˆ·logoå’Œé€€å‡º -->
                <div class="d-lg-none border-top border-light-subtle mt-2 pt-2 pb-1 px-2 user-info-mobile text-white text-sm" style="font-size: 0.95rem;">
                  <div class="d-flex align-items-center justify-content-between px-2 py-2">
                    <div class="user-avatar-capsule-mobile">
                      <span class="avatar-initial-mobile">N</span>
                      <span class="user-name-mobile">NIJIE</span>
                    </div>
                    <div class="d-flex align-items-center">
                      <a href="/user/profile" class="text-white me-3" title="ä¸ªäººè®¾ç½®">
                        <i class="fas fa-user-cog"></i>
                      </a>
                      <a href="/notification/center" class="text-white me-3 position-relative" title="é€šçŸ¥ä¸­å¿ƒ">
                        <i class="fas fa-bell"></i>
                      </a>
                      <a href="/approval/center" class="text-white me-3 position-relative" title="å®¡æ‰¹ä¸­å¿ƒ">
                        <i class="fas fa-tasks"></i>
                        
                        
                        <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger" style="font-size: 0.65rem; transform: translate(-50%, -50%);">
                          1
                          <span class="visually-hidden">æœªå¤„ç†å®¡æ‰¹</span>
                        </span>
                        
                      </a>
                      <a href="/admin/history/" class="text-white me-3" title="å†å²è®°å½•">
                        <i class="fas fa-history"></i>
                      </a>
                      <a href="/auth/logout" class="text-white text-decoration-none text-sm"><i class="fas fa-sign-out-alt"></i></a>
                    </div>
                  </div>
                </div>
                
            </div>
        </div>
    </nav>
    <style>
    .navbar-dark .navbar-toggler {
        border-color: transparent;
        box-shadow: none;
    }
    .navbar-dark .navbar-toggler-icon {
        background-image: url("data:image/svg+xml;charset=utf8,%3Csvg viewBox='0 0 30 30' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath stroke='rgba%28255,255,255,1%29' stroke-width='2' stroke-linecap='round' stroke-miterlimit='10' d='M4 7h22M4 15h22M4 23h22'/%3E%3C/svg%3E");
    }
    .navbar-nav .nav-link.active, .navbar-nav .nav-link:focus {
        color: #167ac6 !important;
        font-weight: bold !important;
        border-left: 0;
        border-bottom: 3px solid #167ac6;
        background: none !important;
    }
    .navbar-nav .nav-link {
        font-family: 'Microsoft YaHei', Arial, sans-serif;
        font-weight: 400;
        color: #fff !important;
        border-left: 0;
        border-bottom: 3px solid transparent;
        background: none !important;
    }
    /* å“åº”å¼èœå•é€‰ä¸­æ ·å¼ï¼šç§»åŠ¨ç«¯ä¸ºå·¦ä¾§ç«–çº¿ï¼ŒPCç«¯ä¸ºåº•éƒ¨æ¨ªçº¿ */
    @media (max-width: 991.98px) {
        .main-menu-list .nav-link.active, .main-menu-list .nav-link:focus {
            border-left: 4px solid #167ac6 !important;
            border-bottom: none !important;
            color: #167ac6 !important;
            font-weight: bold !important;
            background: none !important;
        }
    }
    @media (min-width: 992px) {
        .main-menu-list .nav-link.active, .main-menu-list .nav-link:focus {
            border-left: none !important;
            border-bottom: 3px solid #167ac6 !important;
            color: #167ac6 !important;
            font-weight: bold !important;
            background: none !important;
        }
    }
    /* ä¸»å†…å®¹åŒºé¡¶éƒ¨paddingï¼Œé¿å…èœå•é®æŒ¡ */
    body { padding-top: 80px !important; }
    @media (max-width: 991.98px) { body { padding-top: 120px !important; } }
    .main-nav.fixed-top { box-shadow: 0 2px 8px rgba(0,0,0,0.04); }
    
    /* èƒ¶å›Šå‹ç”¨æˆ·å¤´åƒæ ·å¼ */
    .user-avatar-capsule {
        background: #b13a5b;
        border-radius: 20px;
        padding: 6px 12px 6px 6px;
        cursor: pointer;
        transition: all 0.3s ease;
        white-space: nowrap;
        display: flex;
        align-items: center;
        min-height: 32px;
    }
    
    .user-avatar-capsule:hover {
        background: #9d2f4a;
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(177, 58, 91, 0.3);
    }
    
    .user-avatar-capsule .avatar-initial {
        background: rgba(255, 255, 255, 0.2);
        border-radius: 50%;
        width: 20px;
        height: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.75rem;
        font-weight: 600;
        color: #fff;
        margin-right: 8px;
    }
    
    .user-avatar-capsule .user-name {
        color: #fff;
        font-size: 0.9rem;
        font-weight: 500;
        margin-right: 6px;
    }
    
    .user-avatar-capsule .dropdown-arrow {
        color: #fff;
        font-size: 0.8rem;
        opacity: 0.8;
        transition: transform 0.2s ease;
    }
    
    .user-avatar-capsule[aria-expanded="true"] .dropdown-arrow {
        transform: rotate(180deg);
    }
    
    .user-avatar-capsule .notification-badge {
        position: absolute;
        top: -4px;
        right: -4px;
        background: #dc3545;
        color: white;
        border-radius: 10px;
        padding: 2px 6px;
        font-size: 0.65rem;
        font-weight: 600;
        min-width: 18px;
        text-align: center;
        border: 2px solid #16a0bf;
    }
    
    /* ç§»åŠ¨ç«¯èƒ¶å›Šå‹å¤´åƒæ ·å¼ */
    .user-avatar-capsule-mobile {
        background: #b13a5b;
        border-radius: 16px;
        padding: 4px 10px 4px 4px;
        display: flex;
        align-items: center;
        gap: 6px;
    }
    
    .user-avatar-capsule-mobile .avatar-initial-mobile {
        background: rgba(255, 255, 255, 0.2);
        border-radius: 50%;
        width: 16px;
        height: 16px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.7rem;
        font-weight: 600;
        color: #fff;
    }
    
    .user-avatar-capsule-mobile .user-name-mobile {
        color: #fff;
        font-size: 0.85rem;
        font-weight: 500;
    }
    </style>

    
        
    

    <main class="container mb-5">
        <style>
        body { padding-top: 90px !important; }
        @media (max-width: 991.98px) { body { padding-top: 120px !important; } }
        .main-nav.fixed-top { box-shadow: 0 2px 8px rgba(0,0,0,0.04); }
        </style>
        
<!--
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                               ğŸ”’ ä¿æŠ¤æ–‡ä»¶å£°æ˜ ğŸ”’                                â•‘
â•‘                                                                                â•‘
â•‘  æ­¤æ–‡ä»¶è¢«ç³»ç»Ÿæ ‡è®°ä¸ºå—ä¿æŠ¤æ–‡ä»¶ï¼Œæœªç»å€ªæ·æ˜ç¡®è®¸å¯ï¼Œä¸¥ç¦ä¿®æ”¹ä»»ä½•ä»£ç ï¼             â•‘
â•‘  ä¿®æ”¹æ­¤æ–‡ä»¶å¯èƒ½å¯¼è‡´æ•´ä¸ªé¡¹ç›®åˆ—è¡¨åŠŸèƒ½å¤±æ•ˆæˆ–æ˜¾ç¤ºå¼‚å¸¸ã€‚                            â•‘
â•‘                                                                                â•‘
â•‘  ğŸš« ç¦æ­¢ä¿®æ”¹å†…å®¹åŒ…æ‹¬ä½†ä¸é™äºï¼š                                                 â•‘
â•‘  - è¡¨æ ¼ç»“æ„å’Œæ ·å¼                                                              â•‘
â•‘  - å˜é‡åç§°å¼•ç”¨æ–¹å¼                                                            â•‘
â•‘  - CSSç±»åå’Œæ ·å¼å®šä¹‰                                                           â•‘
â•‘  - JavaScriptåŠŸèƒ½å‡½æ•°                                                          â•‘
â•‘                                                                                â•‘
â•‘  ğŸ“ å¦‚ç¡®å®éœ€è¦ä¿®æ”¹ï¼Œè¯·è”ç³»å€ªæ·è·å–æ˜ç¡®è®¸å¯ã€‚                                    â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-->

<!-- æ·»åŠ ä¸€ä¸ªéšè—çš„divç”¨äºæ£€æŸ¥å˜é‡æ˜¯å¦å­˜åœ¨ -->
<div style="display:none;">
    <!-- æ£€æŸ¥companiesæ˜¯å¦å·²å®šä¹‰ -->
    
        <span id="companies-check">companieså˜é‡æœªå®šä¹‰</span>
    

    <!-- æ£€æŸ¥projectsæ˜¯å¦å·²å®šä¹‰ -->
    
        <span id="projects-check">projectså˜é‡å·²å®šä¹‰</span>
    
</div>

<!--
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                                  âš ï¸ é‡è¦è­¦å‘Š âš ï¸                                  â•‘
â•‘                                                                                â•‘
â•‘  ä»¥ä¸‹ä»£ç ç»“æ„å’Œæ ·å¼æ˜¯ç»è¿‡ç²¾å¿ƒè®¾è®¡çš„ï¼Œç”¨äºç¡®ä¿é¡¹ç›®åˆ—è¡¨é¡µé¢çš„æ­£ç¡®æ˜¾ç¤ºå’ŒåŠŸèƒ½ã€‚        â•‘
â•‘  ç‰¹åˆ«æ˜¯è¡¨æ ¼çš„å¸ƒå±€ã€å›ºå®šåˆ—å’Œæ»šåŠ¨è¡Œä¸ºéƒ½éœ€è¦ä¿æŒå®Œæ•´æ€§ã€‚                            â•‘
â•‘                                                                                â•‘
â•‘  ğŸš« æœªç»å€ªæ·åŒæ„ï¼Œè¯·å‹¿ä¿®æ”¹ï¼š                                                    â•‘
â•‘  1. è¡¨æ ¼å®¹å™¨çš„ç»“æ„å’Œç±»å                                                       â•‘
â•‘  2. æ“ä½œåˆ—çš„å›ºå®šå®šä½æ ·å¼                                                       â•‘
â•‘  3. è¡¨æ ¼çš„å“åº”å¼å¸ƒå±€                                                          â•‘
â•‘  4. æ¡çº¹è¡Œå’Œæ‚¬åœæ•ˆæœçš„æ ·å¼                                                     â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-->
<div class="container-fluid mt-4">
    <div class="row page-title-container">
        <div class="col-6">
            <h1 class="page-title">é¡¹ç›®åˆ—è¡¨</h1>
        </div>
        <div class="col-6 text-end">
            
  
    <button type="button" class="btn bg-secondary text-white me-2 py-2 px-3 text-sm rounded-pill" style="" id="toggleStatisticsBtn">
        æ˜¾ç¤ºç»Ÿè®¡æ€»è§ˆ
    </button>
  

        </div>
    </div>
    <div class="row">
        <div class="col">
            <!-- æœç´¢å’Œæ·»åŠ æŒ‰é’®éƒ¨åˆ† -->
            <div id="dashboardWrapper" style="display:none;">
                <!-- é¡¹ç›®ç»Ÿè®¡æ€»è§ˆé¢æ¿ -->
<div id="projectStatisticsPanel" class="project-statistics-panel collapse">
    <div class="card">
        <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
            <div class="d-flex align-items-center">
                <span><i class="fas fa-chart-bar me-1"></i> é¡¹ç›®ç»Ÿè®¡æ€»è§ˆ</span>
            </div>
            <!-- åˆ é™¤æ—¶é—´å‘¨æœŸåˆ‡æ¢æŒ‰é’®ç»„ -->
        </div>
        <div class="card-body">
            <div class="row">
                <!-- åŠ è½½ä¸­æç¤º -->
                <div id="statisticsLoading" class="col-12 text-center py-3">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">åŠ è½½ä¸­...</span>
                    </div>
                    <p class="mt-2">æ­£åœ¨åŠ è½½ç»Ÿè®¡æ•°æ®...</p>
                </div>
                
                <!-- ç»Ÿè®¡å†…å®¹å®¹å™¨ -->
                <div id="statisticsCards" class="col-12 d-none">
                    <!-- é¡¹ç›®ç»Ÿè®¡æ¦‚è§ˆ - é¡¶éƒ¨æ°´å¹³å±•ç¤º -->
                    <div class="d-flex flex-wrap gap-3 mb-4" style="justify-content: space-between;">
                        <!-- æœ‰æ•ˆé¡¹ç›®æ€»è§ˆå¡ç‰‡ -->
                        <div style="flex: 1; min-width: 200px;">
                            <div class="card border-0 shadow-sm h-100 bg-light" id="validProjectsCard" style="cursor:pointer;" onclick="filterValidProjects()">
                                <div class="card-body">
                                    <h6 class="card-title text-primary">
                                        <i class="fas fa-project-diagram me-1"></i> æœ‰æ•ˆé¡¹ç›®
                                        <i class="fas fa-info-circle text-muted ms-1" 
                                           data-bs-toggle="tooltip" 
                                           title="å½“å‰æœ‰æ•ˆçš„é¡¹ç›®æ€»æ•°å’Œæ€»é‡‘é¢ï¼ˆæ’é™¤å¤±è´¥ã€ç­¾çº¦ã€æç½®ç­‰çŠ¶æ€ï¼‰"></i>
                                    </h6>
                                    <div class="d-flex justify-content-between align-items-center mt-3">
                                        <div>
                                            <span class="fs-5 fw-bold" id="validProjectsCount">0</span>
                                            <span class="text-muted ms-1">é¡¹</span>
                                        </div>
                                        <div>
                                            <span class="fs-5 fw-bold" id="validProjectsAmount">0</span>
                                            <span class="text-muted ms-1">ä¸‡å…ƒ</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- æ‹›æ ‡é¡¹ç›®å¡ç‰‡ -->
                        <div style="flex: 1; min-width: 200px;">
                            <div class="card border-0 shadow-sm h-100 bg-warning bg-opacity-10" id="tenderingProjectsCard" style="cursor:pointer;" onclick="filterTenderingProjects()">
                                <div class="card-body">
                                    <h6 class="card-title text-warning">
                                        <i class="fas fa-file-contract me-1"></i> æ‹›æ ‡ä¸­
                                        <i class="fas fa-info-circle text-muted ms-1" 
                                           data-bs-toggle="tooltip" 
                                           title="å½“å‰å¤„äºæ‹›æ ‡é˜¶æ®µçš„é¡¹ç›®ç»Ÿè®¡"></i>
                                    </h6>
                                    <div class="d-flex justify-content-between align-items-center mt-3">
                                        <div>
                                            <span class="fs-5 fw-bold" id="tenderingProjectsCount">0</span>
                                            <span class="text-muted ms-1">é¡¹</span>
                                        </div>
                                        <div>
                                            <span class="fs-5 fw-bold" id="tenderingProjectsAmount">0</span>
                                            <span class="text-muted ms-1">ä¸‡å…ƒ</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- ä¸­æ ‡é¡¹ç›®å¡ç‰‡ -->
                        <div style="flex: 1; min-width: 200px;">
                            <div class="card border-0 shadow-sm h-100 bg-success bg-opacity-10" id="wonProjectsCard" style="cursor:pointer;" onclick="filterWonProjects()">
                                <div class="card-body">
                                    <h6 class="card-title text-success">
                                        <i class="fas fa-award me-1"></i> ä¸­æ ‡
                                        <i class="fas fa-info-circle text-muted ms-1" 
                                           data-bs-toggle="tooltip" 
                                           title="å½“å‰ä¸­æ ‡é˜¶æ®µçš„é¡¹ç›®ç»Ÿè®¡"></i>
                                    </h6>
                                    <div class="d-flex justify-content-between align-items-center mt-3">
                                        <div>
                                            <span class="fs-5 fw-bold" id="wonProjectsCount">0</span>
                                            <span class="text-muted ms-1">é¡¹</span>
                                        </div>
                                        <div>
                                            <span class="fs-5 fw-bold" id="wonProjectsAmount">0</span>
                                            <span class="text-muted ms-1">ä¸‡å…ƒ</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- æ‰¹ä»·é¡¹ç›®å¡ç‰‡ -->
                        <div style="flex: 1; min-width: 200px;">
                            <div class="card border-0 shadow-sm h-100 bg-secondary bg-opacity-10" id="quotedProjectsCard" style="cursor:pointer;" onclick="filterQuotedProjects()">
                                <div class="card-body">
                                    <h6 class="card-title text-secondary">
                                        <i class="fas fa-file-invoice-dollar me-1"></i> æ‰¹ä»·
                                        <i class="fas fa-info-circle text-muted ms-1" 
                                           data-bs-toggle="tooltip" 
                                           title="å½“å‰æ‰¹ä»·é˜¶æ®µçš„é¡¹ç›®ç»Ÿè®¡"></i>
                                    </h6>
                                    <div class="d-flex justify-content-between align-items-center mt-3">
                                        <div>
                                            <span class="fs-5 fw-bold" id="quotedProjectsCount">0</span>
                                            <span class="text-muted ms-1">é¡¹</span>
                                        </div>
                                        <div>
                                            <span class="fs-5 fw-bold" id="quotedProjectsAmount">0</span>
                                            <span class="text-muted ms-1">ä¸‡å…ƒ</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- ä¸šåŠ¡æ¨è¿›å¡ç‰‡ -->
                        <div style="flex: 1; min-width: 200px;">
                            <div class="card border-0 shadow-sm h-100 bg-info bg-opacity-10" id="updatedProjectsCard" style="cursor:pointer;" onclick="filterUpdatedProjects()">
                                <div class="card-body">
                                    <h6 class="card-title text-info">
                                        <i class="fas fa-chart-line me-1"></i> ä¸šåŠ¡æ¨è¿›
                                        <i class="fas fa-info-circle text-muted ms-1" 
                                           data-bs-toggle="tooltip" 
                                           title="æœ¬æœˆå†…é¡¹ç›®çŠ¶æ€æœ‰æ¨è¿›çš„ç»Ÿè®¡"></i>
                                    </h6>
                                    <div class="d-flex justify-content-between align-items-center mt-3">
                                        <div>
                                            <span class="fs-5 fw-bold" id="updatedProjectsCount">0</span>
                                            <span class="text-muted ms-1">é¡¹</span>
                                        </div>
                                        <div>
                                            <span class="fs-5 fw-bold" id="updatedProjectsAmount">0</span>
                                            <span class="text-muted ms-1">ä¸‡å…ƒ</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- é˜¶æ®µåˆ†å¸ƒå’Œè¶‹åŠ¿ç»Ÿè®¡ - æ°´å¹³å¸ƒå±€ -->
                    <div class="row">
                        <!-- å·¦ä¾§é˜¶æ®µåˆ†å¸ƒåŒºåŸŸ (40%) -->
                        <div class="col-md-5">
                            <div class="card border-0 shadow-sm mb-3">
                                <div class="card-body">
                                    <h6 class="card-title text-primary mb-3">é˜¶æ®µåˆ†å¸ƒç»Ÿè®¡</h6>
                                    <div id="stageDistributionChart" style="height: 350px; min-height: 250px;">
                                        <div class="text-center py-5">
                                            <div class="spinner-border text-primary" role="status">
                                                <span class="visually-hidden">åŠ è½½ä¸­...</span>
                                            </div>
                                            <p class="mt-2">æ­£åœ¨åŠ è½½å›¾è¡¨æ•°æ®...</p>
                                        </div>
                                    </div>
                                    <!-- åˆ‡æ¢å™¨ -->
                                    <div class="text-center mt-2">
                                        <span class="chart-toggle-dot active" data-chart-type="count" title="é¡¹ç›®æ•°é‡åˆ†å¸ƒ"></span>
                                        <span class="chart-toggle-dot" data-chart-type="amount" title="é¡¹ç›®é‡‘é¢åˆ†å¸ƒ"></span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- å³ä¾§è¶‹åŠ¿åŒºåŸŸ (60%) -->
                        <div class="col-md-7">
                            <div class="card border-0 shadow-sm">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-center mb-3">
                                        <h6 class="card-title text-primary mb-0">é˜¶æ®µè¶‹åŠ¿åˆ†æ</h6>
                                        <div>
                                            <div class="btn-group btn-group-sm" role="group">
                                                <button type="button" class="btn btn-outline-primary trend-period-btn active" data-period="week">å‘¨è¶‹åŠ¿</button>
                                                <button type="button" class="btn btn-outline-primary trend-period-btn" data-period="month">æœˆè¶‹åŠ¿</button>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- è¶‹åŠ¿å›¾è¡¨å®¹å™¨ -->
                                    <div id="stageTrendChart" style="height: 300px; min-height: 250px;">
                                        <div class="text-center py-5">
                                            <div class="spinner-border text-primary" role="status">
                                                <span class="visually-hidden">åŠ è½½ä¸­...</span>
                                            </div>
                                            <p class="mt-2">æ­£åœ¨åŠ è½½è¶‹åŠ¿æ•°æ®...</p>
                                        </div>
                                    </div>
                                    
                                    <!-- é˜¶æ®µåˆ‡æ¢å™¨ -->
                                    <div class="text-center mt-3">
                                        <div id="stageTrendToggle" class="stage-toggle-container">
                                            <!-- åŠ¨æ€ç”Ÿæˆé˜¶æ®µåˆ‡æ¢ç‚¹ -->
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- é”™è¯¯æç¤º -->
                <div id="statisticsError" class="col-12 d-none">
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <span id="errorMessage">åŠ è½½ç»Ÿè®¡æ•°æ®å¤±è´¥</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>


<style>
/* é¡¹ç›®ç»Ÿè®¡é¢æ¿æ ·å¼ */
.project-statistics-panel {
    margin-bottom: 20px;
}



.project-statistics-panel .card {
    border: none;
    box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
    transition: all 0.2s ease-in-out;
}

.project-statistics-panel .card:hover {
    transform: translateY(-2px);
    box-shadow: 0 0.25rem 0.5rem rgba(0, 0, 0, 0.1);
}

.project-statistics-panel .card-header {
    padding: 0.75rem 1rem;
}

.project-statistics-panel .period-btn,
.project-statistics-panel .trend-period-btn {
    font-size: 0.75rem;
    padding: 0.25rem 0.5rem;
}

.project-statistics-panel .period-btn.active,
.project-statistics-panel .trend-period-btn.active {
    background-color: white;
    color: #0d6efd;
}

/* ç»Ÿè®¡å¡ç‰‡æ ·å¼ */
.project-statistics-panel .card-body {
    padding: 1rem;
}

.project-statistics-panel .card-title {
    margin-bottom: 0;
    font-size: 0.9rem;
    font-weight: 600;
}

/* æ•°å­—æ ¼å¼åŒ– */
.project-statistics-panel .fs-5 {
    font-size: 1.25rem!important;
}

/* åŠ¨ç”»æ•ˆæœ */
.project-statistics-panel.collapsing {
    transition: height .35s ease;
}

/* å›¾è¡¨åˆ‡æ¢ç‚¹æ ·å¼ */
.chart-toggle-dot {
    display: inline-block;
    width: 14px;
    height: 14px;
    margin: 0 8px;
    border-radius: 50%;
    border: 2px solid #1890ff;
    background: #fff;
    cursor: pointer;
    transition: background 0.3s, box-shadow 0.3s;
    box-shadow: 0 0 0 0 rgba(24,144,255,0.2);
    position: relative;
    top: -10px;
}
.chart-toggle-dot.active {
    background: #1890ff;
    box-shadow: 0 0 0 6px rgba(24,144,255,0.12);
    border-color: #1890ff;
    animation: dotPulse 0.4s;
}

/* é˜¶æ®µåˆ‡æ¢ç‚¹æ ·å¼ */
.stage-toggle-container {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    gap: 12px;
}
.stage-toggle-dot {
    display: inline-block;
    width: 16px;
    height: 16px;
    border-radius: 50%;
    cursor: pointer;
    transition: transform 0.3s, box-shadow 0.3s;
    box-shadow: 0 0 0 0 rgba(24,144,255,0.2);
    position: relative;
    border: 2px solid transparent;
}
.stage-toggle-dot.active {
    transform: scale(1.2);
    box-shadow: 0 0 0 4px rgba(24,144,255,0.12);
    animation: dotPulse 0.4s;
    border-color: #fff;
}
.stage-toggle-dot:hover {
    transform: scale(1.1);
}

.stage-toggle-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    margin: 0 5px;
    cursor: pointer;
}

.stage-toggle-label {
    font-size: 11px;
    margin-top: 4px;
    white-space: nowrap;
    transition: all 0.3s;
}

.stage-toggle-label.active {
    font-weight: bold;
}

@keyframes dotPulse {
    0% { box-shadow: 0 0 0 0 rgba(24,144,255,0.2); }
    70% { box-shadow: 0 0 0 8px rgba(24,144,255,0.12); }
    100% { box-shadow: 0 0 0 0 rgba(24,144,255,0.2); }
}

/* è¶‹åŠ¿å›¾æ§åˆ¶æ ·å¼ */
.trend-controls {
    margin-top: 5px;
    padding: 5px;
    display: none; /* éšè—æ§åˆ¶æŒ‰é’® */
}

.trend-controls button {
    display: none; /* éšè—æ§åˆ¶æŒ‰é’® */
}

/* ç¡®ä¿EChartsæ»šåŠ¨æ¡å¯è§ */
.project-statistics-panel .card-body .datazoom-slider-horizontal {
    height: 25px !important;
    margin-top: 10px;
}

/* å›¾è¡¨åŒºåŸŸå¢åŠ è¿‡æ¸¡æ•ˆæœ */
#stageTrendChart {
    transition: all 0.3s ease;
}

/* æ·»åŠ è´¦æˆ·é€‰æ‹©å™¨ç›¸å…³CSSæ ·å¼ */
.account-selector .dropdown-toggle {
    min-width: 120px;
    text-align: left;
}

.account-selector .dropdown-menu {
    max-height: 300px;
    overflow-y: auto;
}

/* ç‚¹å‡»åé¦ˆæ•ˆæœ */
@keyframes pulse {
    0% { transform: scale(1); }
    50% { transform: scale(0.98); }
    100% { transform: scale(1); }
}

.pulse-effect {
    animation: pulse 0.3s ease-in-out;
}

/* å¡ç‰‡è¿‡æ»¤æ¿€æ´»çŠ¶æ€ */
.card.active-filter {
    box-shadow: 0 0.25rem 0.5rem rgba(0, 0, 0, 0.15) !important;
}

/* æœ‰æ•ˆé¡¹ç›®å¡ç‰‡æ¿€æ´»æ ·å¼ */
#validProjectsCard.active-filter {
    background-color: #e6f0f5 !important;
    border-left: 4px solid #0d6efd !important;
}

/* æ‹›æ ‡ä¸­é¡¹ç›®å¡ç‰‡æ¿€æ´»æ ·å¼ */
#tenderingProjectsCard.active-filter {
    background-color: #fff8e6 !important;
    border-left: 4px solid #ffc107 !important;
}

/* ä¸­æ ‡é¡¹ç›®å¡ç‰‡æ¿€æ´»æ ·å¼ */
#wonProjectsCard.active-filter {
    background-color: #e6f5ec !important;
    border-left: 4px solid #198754 !important;
}

/* ä¸šåŠ¡æ¨è¿›å¡ç‰‡æ¿€æ´»æ ·å¼ */
#updatedProjectsCard.active-filter {
    background-color: #e6f5f9 !important;
    border-left: 4px solid #0dcaf0 !important;
}
</style>

<!-- ç»Ÿè®¡è„šæœ¬åœ¨æ­¤å¤„ -->
<script>
/**
 * è¿‡æ»¤æœ‰æ•ˆé¡¹ç›®å‡½æ•°ï¼Œç‚¹å‡»æœ‰æ•ˆé¡¹ç›®å¡ç‰‡æ—¶è§¦å‘
 * æœ‰æ•ˆé¡¹ç›®å®šä¹‰ä¸ºï¼šæœ‰æˆæƒçš„é¡¹ç›®ï¼Œä¸”çŠ¶æ€ä¸åœ¨å¤±è´¥ã€æç½®å’ŒæˆåŠŸçš„é¡¹ç›®
 */
function filterValidProjects() {
    // ç‚¹å‡»åé¦ˆæ•ˆæœ
    const card = document.getElementById('validProjectsCard');
    
    // æ·»åŠ åŠ¨ç”»æ•ˆæœ
    if (card) {
        card.classList.add('pulse-effect');
        setTimeout(() => {
            card.classList.remove('pulse-effect');
        }, 300);
        
        // æ£€æŸ¥å½“å‰URLæ˜¯å¦å·²ç»åº”ç”¨äº†æœ‰æ•ˆé¡¹ç›®è¿‡æ»¤
        const currentUrl = new URL(window.location.href);
        const params = new URLSearchParams(currentUrl.search);
        const hasAuthFilter = params.get('filter_has_authorization') === '1';
        const stageNotFilter = params.get('filter_stage_not') === 'lost,paused,signed';
        
        // å¦‚æœå·²ç»åº”ç”¨äº†è¿‡æ»¤ï¼Œåˆ™å–æ¶ˆè¿‡æ»¤ï¼ˆåˆ‡æ¢çŠ¶æ€ï¼‰
        if (hasAuthFilter && stageNotFilter) {
            // ç§»é™¤æœ‰æ•ˆé¡¹ç›®çš„è¿‡æ»¤æ¡ä»¶
            params.delete('filter_has_authorization');
            params.delete('filter_stage_not');
            
            // ç§»é™¤å¡ç‰‡çš„æ´»è·ƒçŠ¶æ€
            card.classList.remove('active-filter');
            
            // ä¿æŒç»Ÿè®¡é¢æ¿æ‰“å¼€çŠ¶æ€
            params.set('keep_panel', 'true');
            
            // é‡æ–°åŠ è½½é¡µé¢ä»¥åº”ç”¨ç­›é€‰æ¡ä»¶
            window.location.href = '/project/?' + params.toString();
            return;
        }
        
        // æ·»åŠ å¡ç‰‡çš„æ´»è·ƒçŠ¶æ€
        card.classList.add('active-filter');
    }
    
    // æ„å»ºæŸ¥è¯¢å‚æ•°ï¼Œç¡®ä¿åŒ…å«å½“å‰çš„å…¶ä»–æŸ¥è¯¢æ¡ä»¶
    const currentUrl = new URL(window.location.href);
    const params = new URLSearchParams(currentUrl.search);
    
    // æ·»åŠ æœ‰æ•ˆé¡¹ç›®çš„è¿‡æ»¤æ¡ä»¶
    params.set('filter_has_authorization', '1');  // æœ‰æˆæƒç¼–å·
    
    // æ’é™¤å¤±è´¥ã€æç½®å’ŒæˆåŠŸçš„é˜¶æ®µ
    params.set('filter_stage_not', 'lost,paused,signed');
    
    // ä¿æŒç»Ÿè®¡é¢æ¿æ‰“å¼€çŠ¶æ€
    params.set('keep_panel', 'true');
    
    // é‡æ–°åŠ è½½é¡µé¢ä»¥åº”ç”¨ç­›é€‰æ¡ä»¶
    window.location.href = '/project/?' + params.toString();
}

/**
 * è¿‡æ»¤æ‹›æ ‡ä¸­é¡¹ç›®å‡½æ•°ï¼Œç‚¹å‡»æ‹›æ ‡ä¸­å¡ç‰‡æ—¶è§¦å‘
 */
function filterTenderingProjects() {
    // ç‚¹å‡»åé¦ˆæ•ˆæœ
    const card = document.getElementById('tenderingProjectsCard');
    
    // æ·»åŠ åŠ¨ç”»æ•ˆæœ
    if (card) {
        card.classList.add('pulse-effect');
        setTimeout(() => {
            card.classList.remove('pulse-effect');
        }, 300);
        
        // æ£€æŸ¥å½“å‰URLæ˜¯å¦å·²ç»åº”ç”¨äº†æ‹›æ ‡ä¸­è¿‡æ»¤
        const currentUrl = new URL(window.location.href);
        const params = new URLSearchParams(currentUrl.search);
        const hasCurrentStageFilter = params.get('filter_current_stage') === 'tendering';
        
        // å¦‚æœå·²ç»åº”ç”¨äº†è¿‡æ»¤ï¼Œåˆ™å–æ¶ˆè¿‡æ»¤ï¼ˆåˆ‡æ¢çŠ¶æ€ï¼‰
        if (hasCurrentStageFilter) {
            // ç§»é™¤æ‹›æ ‡ä¸­çš„è¿‡æ»¤æ¡ä»¶
            params.delete('filter_current_stage');
            
            // ç§»é™¤å¡ç‰‡çš„æ´»è·ƒçŠ¶æ€
            card.classList.remove('active-filter');
            
            // ä¿æŒç»Ÿè®¡é¢æ¿æ‰“å¼€çŠ¶æ€
            params.set('keep_panel', 'true');
            
            // é‡æ–°åŠ è½½é¡µé¢ä»¥åº”ç”¨ç­›é€‰æ¡ä»¶
            window.location.href = '/project/?' + params.toString();
            return;
        }
        
        // æ·»åŠ å¡ç‰‡çš„æ´»è·ƒçŠ¶æ€
        card.classList.add('active-filter');
    }
    
    // æ„å»ºæŸ¥è¯¢å‚æ•°ï¼Œç¡®ä¿åŒ…å«å½“å‰çš„å…¶ä»–æŸ¥è¯¢æ¡ä»¶
    const currentUrl = new URL(window.location.href);
    const params = new URLSearchParams(currentUrl.search);
    
    // ç§»é™¤å¯èƒ½å­˜åœ¨çš„å…¶ä»–çŠ¶æ€è¿‡æ»¤å™¨
    params.delete('filter_current_stage');
    
    // æ·»åŠ æ‹›æ ‡ä¸­çš„è¿‡æ»¤æ¡ä»¶
    params.set('filter_current_stage', 'tendering');
    
    // ä¿æŒç»Ÿè®¡é¢æ¿æ‰“å¼€çŠ¶æ€
    params.set('keep_panel', 'true');
    
    // é‡æ–°åŠ è½½é¡µé¢ä»¥åº”ç”¨ç­›é€‰æ¡ä»¶
    window.location.href = '/project/?' + params.toString();
}

/**
 * è¿‡æ»¤ä¸­æ ‡é¡¹ç›®å‡½æ•°ï¼Œç‚¹å‡»ä¸­æ ‡å¡ç‰‡æ—¶è§¦å‘
 */
function filterWonProjects() {
    // ç‚¹å‡»åé¦ˆæ•ˆæœ
    const card = document.getElementById('wonProjectsCard');
    
    // æ·»åŠ åŠ¨ç”»æ•ˆæœ
    if (card) {
        card.classList.add('pulse-effect');
        setTimeout(() => {
            card.classList.remove('pulse-effect');
        }, 300);
        
        // æ£€æŸ¥å½“å‰URLæ˜¯å¦å·²ç»åº”ç”¨äº†ä¸­æ ‡è¿‡æ»¤
        const currentUrl = new URL(window.location.href);
        const params = new URLSearchParams(currentUrl.search);
        const hasCurrentStageFilter = params.get('filter_current_stage') === 'awarded';
        
        // å¦‚æœå·²ç»åº”ç”¨äº†è¿‡æ»¤ï¼Œåˆ™å–æ¶ˆè¿‡æ»¤ï¼ˆåˆ‡æ¢çŠ¶æ€ï¼‰
        if (hasCurrentStageFilter) {
            // ç§»é™¤ä¸­æ ‡çš„è¿‡æ»¤æ¡ä»¶
            params.delete('filter_current_stage');
            
            // ç§»é™¤å¡ç‰‡çš„æ´»è·ƒçŠ¶æ€
            card.classList.remove('active-filter');
            
            // ä¿æŒç»Ÿè®¡é¢æ¿æ‰“å¼€çŠ¶æ€
            params.set('keep_panel', 'true');
            
            // é‡æ–°åŠ è½½é¡µé¢ä»¥åº”ç”¨ç­›é€‰æ¡ä»¶
            window.location.href = '/project/?' + params.toString();
            return;
        }
        
        // æ·»åŠ å¡ç‰‡çš„æ´»è·ƒçŠ¶æ€
        card.classList.add('active-filter');
    }
    
    // æ„å»ºæŸ¥è¯¢å‚æ•°ï¼Œç¡®ä¿åŒ…å«å½“å‰çš„å…¶ä»–æŸ¥è¯¢æ¡ä»¶
    const currentUrl = new URL(window.location.href);
    const params = new URLSearchParams(currentUrl.search);
    
    // ç§»é™¤å¯èƒ½å­˜åœ¨çš„å…¶ä»–çŠ¶æ€è¿‡æ»¤å™¨
    params.delete('filter_current_stage');
    
    // æ·»åŠ ä¸­æ ‡çš„è¿‡æ»¤æ¡ä»¶
    params.set('filter_current_stage', 'awarded');
    
    // ä¿æŒç»Ÿè®¡é¢æ¿æ‰“å¼€çŠ¶æ€
    params.set('keep_panel', 'true');
    
    // é‡æ–°åŠ è½½é¡µé¢ä»¥åº”ç”¨ç­›é€‰æ¡ä»¶
    window.location.href = '/project/?' + params.toString();
}

/**
 * è¿‡æ»¤ä¸šåŠ¡æ¨è¿›é¡¹ç›®å‡½æ•°ï¼Œç‚¹å‡»ä¸šåŠ¡æ¨è¿›å¡ç‰‡æ—¶è§¦å‘
 * ä¸šåŠ¡æ¨è¿›é¡¹ç›®å®šä¹‰ä¸ºï¼šæœ¬æœˆå†…é˜¶æ®µæœ‰å˜æ›´çš„é¡¹ç›®
 */
function filterUpdatedProjects() {
    console.log("ä¸šåŠ¡æ¨è¿›ç­›é€‰å‡½æ•°è¢«è°ƒç”¨");
    
    // ç‚¹å‡»åé¦ˆæ•ˆæœ
    const card = document.getElementById('updatedProjectsCard');
    
    // æ·»åŠ åŠ¨ç”»æ•ˆæœ
    if (card) {
        card.classList.add('pulse-effect');
        setTimeout(() => {
            card.classList.remove('pulse-effect');
        }, 300);
        
        // æ£€æŸ¥å½“å‰URLæ˜¯å¦å·²ç»åº”ç”¨äº†ä¸šåŠ¡æ¨è¿›è¿‡æ»¤
        const currentUrl = new URL(window.location.href);
        const params = new URLSearchParams(currentUrl.search);
        const hasUpdatedFilter = params.get('filter_updated_this_month') === '1';
        
        console.log("å½“å‰URLä¸­æ˜¯å¦æœ‰ä¸šåŠ¡æ¨è¿›ç­›é€‰:", hasUpdatedFilter);
        
        // å¦‚æœå·²ç»åº”ç”¨äº†è¿‡æ»¤ï¼Œåˆ™å–æ¶ˆè¿‡æ»¤ï¼ˆåˆ‡æ¢çŠ¶æ€ï¼‰
        if (hasUpdatedFilter) {
            console.log("å–æ¶ˆä¸šåŠ¡æ¨è¿›ç­›é€‰");
            // ç§»é™¤ä¸šåŠ¡æ¨è¿›çš„è¿‡æ»¤æ¡ä»¶
            params.delete('filter_updated_this_month');
            
            // ç§»é™¤å¡ç‰‡çš„æ´»è·ƒçŠ¶æ€
            card.classList.remove('active-filter');
            
            // ä¿æŒç»Ÿè®¡é¢æ¿æ‰“å¼€çŠ¶æ€
            params.set('keep_panel', 'true');
            
            // é‡æ–°åŠ è½½é¡µé¢ä»¥åº”ç”¨ç­›é€‰æ¡ä»¶
            window.location.href = '/project/?' + params.toString();
            return;
        }
        
        console.log("åº”ç”¨ä¸šåŠ¡æ¨è¿›ç­›é€‰");
        // æ·»åŠ å¡ç‰‡çš„æ´»è·ƒçŠ¶æ€
        card.classList.add('active-filter');
    }
    
    // æ„å»ºæŸ¥è¯¢å‚æ•°ï¼Œç¡®ä¿åŒ…å«å½“å‰çš„å…¶ä»–æŸ¥è¯¢æ¡ä»¶
    const currentUrl = new URL(window.location.href);
    const params = new URLSearchParams(currentUrl.search);
    
    // æ·»åŠ ä¸šåŠ¡æ¨è¿›çš„è¿‡æ»¤æ¡ä»¶
    params.set('filter_updated_this_month', '1');
    
    // ä¿æŒç»Ÿè®¡é¢æ¿æ‰“å¼€çŠ¶æ€
    params.set('keep_panel', 'true');
    
    // é‡æ–°åŠ è½½é¡µé¢ä»¥åº”ç”¨ç­›é€‰æ¡ä»¶
    window.location.href = '/project/?' + params.toString();
}

/**
 * è¿‡æ»¤æ‰¹ä»·é¡¹ç›®å‡½æ•°ï¼Œç‚¹å‡»æ‰¹ä»·å¡ç‰‡æ—¶è§¦å‘
 */
function filterQuotedProjects() {
    // ç‚¹å‡»åé¦ˆæ•ˆæœ
    const card = document.getElementById('quotedProjectsCard');
    
    // æ·»åŠ åŠ¨ç”»æ•ˆæœ
    if (card) {
        card.classList.add('pulse-effect');
        setTimeout(() => {
            card.classList.remove('pulse-effect');
        }, 300);
        
        // æ£€æŸ¥å½“å‰URLæ˜¯å¦å·²ç»åº”ç”¨äº†æ‰¹ä»·è¿‡æ»¤
        const currentUrl = new URL(window.location.href);
        const params = new URLSearchParams(currentUrl.search);
        const hasCurrentStageFilter = params.get('filter_current_stage') === 'quoted';
        
        // å¦‚æœå·²ç»åº”ç”¨äº†è¿‡æ»¤ï¼Œåˆ™å–æ¶ˆè¿‡æ»¤ï¼ˆåˆ‡æ¢çŠ¶æ€ï¼‰
        if (hasCurrentStageFilter) {
            // ç§»é™¤æ‰¹ä»·çš„è¿‡æ»¤æ¡ä»¶
            params.delete('filter_current_stage');
            
            // ç§»é™¤å¡ç‰‡çš„æ´»è·ƒçŠ¶æ€
            card.classList.remove('active-filter');
            
            // ä¿æŒç»Ÿè®¡é¢æ¿æ‰“å¼€çŠ¶æ€
            params.set('keep_panel', 'true');
            
            // é‡æ–°åŠ è½½é¡µé¢ä»¥åº”ç”¨ç­›é€‰æ¡ä»¶
            window.location.href = '/project/?' + params.toString();
            return;
        }
        
        // æ·»åŠ å¡ç‰‡çš„æ´»è·ƒçŠ¶æ€
        card.classList.add('active-filter');
    }
    
    // æ„å»ºæŸ¥è¯¢å‚æ•°ï¼Œç¡®ä¿åŒ…å«å½“å‰çš„å…¶ä»–æŸ¥è¯¢æ¡ä»¶
    const currentUrl = new URL(window.location.href);
    const params = new URLSearchParams(currentUrl.search);
    
    // ç§»é™¤å¯èƒ½å­˜åœ¨çš„å…¶ä»–çŠ¶æ€è¿‡æ»¤å™¨
    params.delete('filter_current_stage');
    
    // æ·»åŠ æ‰¹ä»·çš„è¿‡æ»¤æ¡ä»¶
    params.set('filter_current_stage', 'quoted');
    
    // ä¿æŒç»Ÿè®¡é¢æ¿æ‰“å¼€çŠ¶æ€
    params.set('keep_panel', 'true');
    
    // é‡æ–°åŠ è½½é¡µé¢ä»¥åº”ç”¨ç­›é€‰æ¡ä»¶
    window.location.href = '/project/?' + params.toString();
}

/**
 * æ¢å¤æ‰€æœ‰è®°å½•æ˜¾ç¤ºçš„å‡½æ•°ï¼Œåœ¨é‡Šæ”¾ç­›é€‰æ—¶è°ƒç”¨
 */
function restoreAllRecords() {
    console.log("restoreAllRecordså‡½æ•°è¢«è°ƒç”¨"); // è°ƒè¯•æ—¥å¿—
    // è·å–æ‰€æœ‰è¡¨æ ¼è¡Œå’Œç§»åŠ¨ç«¯å¡ç‰‡
    const tableRows = document.querySelectorAll('.table tbody tr');
    const mobileCards = document.querySelectorAll('.d-block.d-lg-none .card');
    const tableBody = document.querySelector('.table tbody');
    const mobileContainer = document.querySelector('.d-block.d-lg-none');
    
    // æŒ‰æ›´æ–°æ—¶é—´é™åºæ’åºçš„å‡½æ•°
    const sortByUpdatedAtDesc = (a, b) => {
        // å°è¯•ä»å…ƒç´ ä¸­è·å–æ›´æ–°æ—¶é—´
        const getUpdatedAt = (el) => {
            // ä»è¡¨æ ¼è¡Œä¸­æå–æ›´æ–°æ—¶é—´ï¼ˆå‡è®¾åœ¨å€’æ•°ç¬¬äºŒåˆ—ï¼‰
            if (!el.classList.contains('card')) {
                // PCç«¯è¡¨æ ¼è§†å›¾
                const cells = el.querySelectorAll('td');
                if (cells.length > 2) {
                    const updatedAtCell = cells[cells.length - 2]; // å€’æ•°ç¬¬äºŒåˆ—æ˜¯æ›´æ–°æ—¶é—´
                    if (updatedAtCell) {
                        const dateText = updatedAtCell.textContent.trim();
                        if (dateText) {
                            return new Date(dateText).getTime();
                        }
                    }
                }
            } else {
                // ç§»åŠ¨ç«¯å¡ç‰‡è§†å›¾
                const updatedAtText = el.textContent.match(/æ›´æ–°: (\d{4}-\d{2}-\d{2})/);
                if (updatedAtText && updatedAtText[1]) {
                    return new Date(updatedAtText[1]).getTime();
                }
            }
            return 0; // é»˜è®¤æ—¶é—´æˆ³
        };
        
        const updatedAtA = getUpdatedAt(a);
        const updatedAtB = getUpdatedAt(b);
        return updatedAtB - updatedAtA; // é™åºæ’åˆ—ï¼ˆæ–°åˆ°æ—§ï¼‰
    };
    
    // å¤åˆ¶æ‰€æœ‰è¡Œå’Œå¡ç‰‡åˆ°æ•°ç»„
    const allRows = Array.from(tableRows);
    const allCards = Array.from(mobileCards);
    
    // æŒ‰æ›´æ–°æ—¶é—´æ’åº
    allRows.sort(sortByUpdatedAtDesc);
    allCards.sort(sortByUpdatedAtDesc);
    
    // é‡æ–°æ’åˆ—è¡¨æ ¼è¡Œ
    if (tableBody) {
        // æ¸…ç©ºè¡¨æ ¼
        while (tableBody.firstChild) {
            tableBody.removeChild(tableBody.firstChild);
        }
        
        // æ·»åŠ æ‰€æœ‰è¡Œ
        allRows.forEach(row => {
            row.classList.remove('filtered');
            row.style.display = '';
            tableBody.appendChild(row);
        });
    }
    
    // é‡æ–°æ’åˆ—ç§»åŠ¨ç«¯å¡ç‰‡
    if (mobileContainer) {
        // ä¿å­˜æ‰€æœ‰éå¡ç‰‡å…ƒç´ 
        const nonCardElements = Array.from(mobileContainer.children).filter(el => 
            !el.classList.contains('card')
        );
        
        // æ¸…ç©ºå®¹å™¨
        while (mobileContainer.firstChild) {
            mobileContainer.removeChild(mobileContainer.firstChild);
        }
        
        // é¦–å…ˆæ·»åŠ éå¡ç‰‡å…ƒç´ 
        nonCardElements.forEach(el => {
            mobileContainer.appendChild(el);
        });
        
        // æ·»åŠ æ‰€æœ‰å¡ç‰‡
        allCards.forEach(card => {
            card.classList.remove('filtered');
            card.style.display = '';
            mobileContainer.appendChild(card);
        });
    }
    
    // ç¡®ä¿æ²¡æœ‰å…¶ä»–ç­›é€‰çŠ¶æ€
    const activeFilters = document.querySelectorAll('.active-filter');
    activeFilters.forEach(filter => {
        filter.classList.remove('active-filter');
    });
    
    // åº”ç”¨ç©ºç­›é€‰æ¡ä»¶ï¼Œç¡®ä¿æ‰€æœ‰è®°å½•æ˜¾ç¤º
    clientSideFilter({});
    
    // è§¦å‘æŒ‰é’®çŠ¶æ€æ›´æ–°
    triggerFilterStatusUpdate();
}

// é¡µé¢åŠ è½½æ—¶æ£€æŸ¥URLå¹¶è®¾ç½®å¡ç‰‡çŠ¶æ€
document.addEventListener('DOMContentLoaded', function() {
    const validProjectsCard = document.getElementById('validProjectsCard');
    const tenderingProjectsCard = document.getElementById('tenderingProjectsCard');
    const wonProjectsCard = document.getElementById('wonProjectsCard');
    const quotedProjectsCard = document.getElementById('quotedProjectsCard');
    const updatedProjectsCard = document.getElementById('updatedProjectsCard');
    
    // è·å–URLå‚æ•°
    const params = new URLSearchParams(window.location.search);
    const hasAuthFilter = params.get('filter_has_authorization') === '1';
    const stageNotFilter = params.get('filter_stage_not') === 'lost,paused,signed';
    const currentStageFilter = params.get('filter_current_stage');
    const updatedThisMonthFilter = params.get('filter_updated_this_month') === '1';
    
    // è®¾ç½®æœ‰æ•ˆé¡¹ç›®å¡ç‰‡çŠ¶æ€
    if (validProjectsCard) {
        if (hasAuthFilter && stageNotFilter) {
            validProjectsCard.classList.add('active-filter');
        } else {
            validProjectsCard.classList.remove('active-filter');
        }
    }
    
    // è®¾ç½®æ‹›æ ‡ä¸­é¡¹ç›®å¡ç‰‡çŠ¶æ€
    if (tenderingProjectsCard) {
        if (currentStageFilter === 'tendering') {
            tenderingProjectsCard.classList.add('active-filter');
        } else {
            tenderingProjectsCard.classList.remove('active-filter');
        }
    }
    
    // è®¾ç½®ä¸­æ ‡é¡¹ç›®å¡ç‰‡çŠ¶æ€
    if (wonProjectsCard) {
        if (currentStageFilter === 'awarded') {
            wonProjectsCard.classList.add('active-filter');
        } else {
            wonProjectsCard.classList.remove('active-filter');
        }
    }
    
    // è®¾ç½®æ‰¹ä»·é¡¹ç›®å¡ç‰‡çŠ¶æ€
    if (quotedProjectsCard) {
        if (currentStageFilter === 'quoted') {
            quotedProjectsCard.classList.add('active-filter');
        } else {
            quotedProjectsCard.classList.remove('active-filter');
        }
    }
    
    // è®¾ç½®ä¸šåŠ¡æ¨è¿›å¡ç‰‡çŠ¶æ€
    if (updatedProjectsCard) {
        if (updatedThisMonthFilter) {
            updatedProjectsCard.classList.add('active-filter');
        } else {
            updatedProjectsCard.classList.remove('active-filter');
        }
    }
});

// æ·»åŠ é¡µé¢åŠ è½½æ—¶æ£€æŸ¥å¡ç‰‡çŠ¶æ€çš„å‡½æ•°
document.addEventListener('DOMContentLoaded', function() {
    // æ£€æŸ¥æœ‰æ•ˆé¡¹ç›®å¡ç‰‡
    checkCardActiveState('validProjectsCard', ['filter_has_authorization', 'filter_stage_not'], ['1', 'lost,paused,signed']);
    
    // æ£€æŸ¥æ‹›æ ‡ä¸­å¡ç‰‡
    checkCardActiveState('tenderingProjectsCard', ['filter_current_stage'], ['tendering']);
    
    // æ£€æŸ¥ä¸­æ ‡å¡ç‰‡
    checkCardActiveState('wonProjectsCard', ['filter_current_stage'], ['awarded']);
    
    // æ£€æŸ¥ä¸šåŠ¡æ¨è¿›å¡ç‰‡
    checkCardActiveState('updatedProjectsCard', ['filter_updated_this_month'], ['1']);
});

/**
 * å®¢æˆ·ç«¯è¿‡æ»¤å‡½æ•°ï¼Œå¤„ç†å„ç§è¿‡æ»¤æ¡ä»¶
 * @param {Object} filters - è¿‡æ»¤æ¡ä»¶å¯¹è±¡
 */
function clientSideFilter(filters) {
    // è·å–æ‰€æœ‰è¡¨æ ¼è¡Œå’Œç§»åŠ¨ç«¯å¡ç‰‡
    const tableRows = document.querySelectorAll('.table tbody tr');
    const mobileCards = document.querySelectorAll('.d-block.d-lg-none .card');
    const tableBody = document.querySelector('.table tbody');
    const mobileContainer = document.querySelector('.d-block.d-lg-none');
    
    // å¦‚æœæ²¡æœ‰è¿‡æ»¤æ¡ä»¶ï¼Œåˆ™ç›´æ¥æ¢å¤æ‰€æœ‰è¡Œå’Œå¡ç‰‡çš„æ˜¾ç¤º
    if (!filters || Object.keys(filters).length === 0) {
        // æŒ‰æ›´æ–°æ—¶é—´å¯¹æ‰€æœ‰è¡Œå’Œå¡ç‰‡è¿›è¡Œæ’åº
        const sortByUpdatedAtDesc = (a, b) => {
            // å°è¯•ä»å…ƒç´ ä¸­è·å–æ›´æ–°æ—¶é—´
            const getUpdatedAt = (el) => {
                // ä»è¡¨æ ¼è¡Œä¸­æå–æ›´æ–°æ—¶é—´ï¼ˆå‡è®¾åœ¨å€’æ•°ç¬¬äºŒåˆ—ï¼‰
                if (!el.classList.contains('card')) {
                    // PCç«¯è¡¨æ ¼è§†å›¾
                    const cells = el.querySelectorAll('td');
                    if (cells.length > 2) {
                        const updatedAtCell = cells[cells.length - 2]; // å€’æ•°ç¬¬äºŒåˆ—æ˜¯æ›´æ–°æ—¶é—´
                        if (updatedAtCell) {
                            const dateText = updatedAtCell.textContent.trim();
                            if (dateText) {
                                return new Date(dateText).getTime();
                            }
                        }
                    }
                } else {
                    // ç§»åŠ¨ç«¯å¡ç‰‡è§†å›¾
                    const updatedAtText = el.textContent.match(/æ›´æ–°: (\d{4}-\d{2}-\d{2})/);
                    if (updatedAtText && updatedAtText[1]) {
                        return new Date(updatedAtText[1]).getTime();
                    }
                }
                return 0; // é»˜è®¤æ—¶é—´æˆ³
            };
            
            const updatedAtA = getUpdatedAt(a);
            const updatedAtB = getUpdatedAt(b);
            return updatedAtB - updatedAtA; // é™åºæ’åˆ—ï¼ˆæ–°åˆ°æ—§ï¼‰
        };
        
        // å¤åˆ¶æ‰€æœ‰è¡Œå’Œå¡ç‰‡åˆ°æ•°ç»„
        const allRows = Array.from(tableRows);
        const allCards = Array.from(mobileCards);
        
        // æŒ‰æ›´æ–°æ—¶é—´æ’åº
        allRows.sort(sortByUpdatedAtDesc);
        allCards.sort(sortByUpdatedAtDesc);
        
        // é‡æ–°æ’åˆ—è¡¨æ ¼è¡Œ
        if (tableBody) {
            // æ¸…ç©ºè¡¨æ ¼
            while (tableBody.firstChild) {
                tableBody.removeChild(tableBody.firstChild);
            }
            
            // æ·»åŠ æ‰€æœ‰è¡Œ
            allRows.forEach(row => {
                row.classList.remove('filtered');
                row.style.display = '';
                tableBody.appendChild(row);
            });
        }
        
        // é‡æ–°æ’åˆ—ç§»åŠ¨ç«¯å¡ç‰‡
        if (mobileContainer) {
            // ä¿å­˜æ‰€æœ‰éå¡ç‰‡å…ƒç´ 
            const nonCardElements = Array.from(mobileContainer.children).filter(el => 
                !el.classList.contains('card')
            );
            
            // æ¸…ç©ºå®¹å™¨
            while (mobileContainer.firstChild) {
                mobileContainer.removeChild(mobileContainer.firstChild);
            }
            
            // é¦–å…ˆæ·»åŠ éå¡ç‰‡å…ƒç´ 
            nonCardElements.forEach(el => {
                mobileContainer.appendChild(el);
            });
            
            // æ·»åŠ æ‰€æœ‰å¡ç‰‡
            allCards.forEach(card => {
                card.classList.remove('filtered');
                card.style.display = '';
                mobileContainer.appendChild(card);
            });
        }
        
        // è§¦å‘list.htmlä¸­çš„æŒ‰é’®çŠ¶æ€æ›´æ–°
        triggerFilterStatusUpdate();
        return;
    }
    
    // ç”¨äºå­˜å‚¨ç­›é€‰åçš„è¡Œå’Œå¡ç‰‡
    const matchedRows = [];
    const filteredRows = [];
    const matchedCards = [];
    const filteredCards = [];
    
    // è¿‡æ»¤è¡¨æ ¼è¡Œ
    tableRows.forEach(row => {
        let shouldFilter = false;
        
        // æ£€æŸ¥"æœ‰æˆæƒ"è¿‡æ»¤æ¡ä»¶
        if (filters.hasAuthorization) {
            const authCell = row.querySelector('td:nth-child(3)'); // æˆæƒç¼–å·å•å…ƒæ ¼
            if (authCell) {
                // æ£€æŸ¥æ˜¯å¦æœ‰æˆæƒç¼–å·ï¼ˆä¸å«"æœªç”³è¯·"æˆ–"å®¡æ‰¹ä¸­"ç­‰æ ‡è®°ï¼‰
                const hasNoAuth = authCell.textContent.includes('æœªç”³è¯·') || 
                                 authCell.textContent.includes('å®¡æ‰¹ä¸­') ||
                                 authCell.textContent.includes('å·²é©³å›');
                if (hasNoAuth) {
                    shouldFilter = true;
                }
            }
        }
        
        // æ£€æŸ¥"é˜¶æ®µä¸åœ¨"è¿‡æ»¤æ¡ä»¶
        if (filters.stageNot && filters.stageNot.length) {
            const stageCell = row.querySelector('td:nth-child(5)'); // å½“å‰é˜¶æ®µå•å…ƒæ ¼
            if (stageCell) {
                const stageName = stageCell.textContent.trim();
                if (filters.stageNot.some(stage => {
                    if (stage === 'lost') return stageName.includes('å¤±è´¥');
                    if (stage === 'paused') return stageName.includes('æç½®');
                    if (stage === 'signed') return stageName.includes('ç­¾çº¦');
                    return false;
                })) {
                    shouldFilter = true;
                }
            }
        }
        
        // æ£€æŸ¥"å½“å‰é˜¶æ®µ"è¿‡æ»¤æ¡ä»¶
        if (filters.currentStage) {
            const stageCell = row.querySelector('td:nth-child(5)'); // å½“å‰é˜¶æ®µå•å…ƒæ ¼
            if (stageCell) {
                const stageName = stageCell.textContent.trim();
                let match = false;
                
                if (filters.currentStage === 'tendering' && stageName.includes('æ‹›æ ‡ä¸­')) {
                    match = true;
                } else if (filters.currentStage === 'awarded' && stageName.includes('ä¸­æ ‡')) {
                    match = true;
                }
                
                if (!match) {
                    shouldFilter = true;
                }
            }
        }
        
        // æ£€æŸ¥"æœ¬æœˆæ›´æ–°"è¿‡æ»¤æ¡ä»¶
        if (filters.updatedThisMonth) {
            // å¯¹PCç«¯è¡¨æ ¼è¡Œï¼Œä½¿ç”¨æ›´ç²¾ç¡®çš„å•å…ƒæ ¼é€‰æ‹©ç­–ç•¥
            const updatedAtCell = row.querySelector('td:nth-last-child(2)'); // å€’æ•°ç¬¬äºŒåˆ—æ˜¯æ›´æ–°æ—¶é—´
            
            if (updatedAtCell) {
                const dateText = updatedAtCell.textContent.trim();
                console.log("PCè¡¨æ ¼è¡Œæ›´æ–°æ—¶é—´å•å…ƒæ ¼å†…å®¹:", dateText);
                
                if (dateText) {
                    // è§£ææ—¥æœŸ
                    try {
                        const updatedDate = new Date(dateText);
                        const now = new Date();
                        
                        // æ£€æŸ¥æ˜¯å¦ä¸ºæœ¬æœˆæ›´æ–°
                        const isCurrentMonth = updatedDate.getMonth() === now.getMonth() && 
                                             updatedDate.getFullYear() === now.getFullYear();
                        
                        console.log("PCè¡¨æ ¼è¡Œæ›´æ–°æ—¶é—´æ£€æŸ¥:", dateText, 
                            "åŸå§‹æ—¥æœŸå¯¹è±¡:", updatedDate,
                            "æ˜¯å¦æœ¬æœˆ:", isCurrentMonth, 
                            "æ›´æ–°æœˆä»½:", updatedDate.getMonth() + 1, 
                            "å½“å‰æœˆä»½:", now.getMonth() + 1);
                        
                        if (!isCurrentMonth) {
                            shouldFilter = true;
                        }
                    } catch (e) {
                        console.error("PCè¡¨æ ¼è¡Œæ—¥æœŸè§£æé”™è¯¯:", dateText, e);
                        shouldFilter = true;
                    }
                } else {
                    // å¦‚æœæ²¡æœ‰æ›´æ–°æ—¥æœŸï¼Œåˆ™è¿‡æ»¤æ‰
                    console.warn("PCè¡¨æ ¼è¡Œæ›´æ–°æ—¶é—´å•å…ƒæ ¼å­˜åœ¨ä½†å†…å®¹ä¸ºç©º");
                    shouldFilter = true;
                }
            } else {
                // å¦‚æœæ‰¾ä¸åˆ°æ›´æ–°æ—¶é—´å•å…ƒæ ¼ï¼Œåˆ™è¿‡æ»¤æ‰
                console.warn("æœªæ‰¾åˆ°PCè¡¨æ ¼è¡Œæ›´æ–°æ—¶é—´å•å…ƒæ ¼");
                shouldFilter = true;
            }
        }
        
        // æ ¹æ®ç­›é€‰ç»“æœï¼Œå°†è¡Œåˆ†åˆ°åŒ¹é…æˆ–è¿‡æ»¤é›†åˆä¸­
        if (shouldFilter) {
            row.classList.add('filtered');
            filteredRows.push(row);
        } else {
            row.classList.remove('filtered');
            matchedRows.push(row);
        }
    });
    
    // è¿‡æ»¤ç§»åŠ¨ç«¯å¡ç‰‡
    mobileCards.forEach(card => {
        let shouldFilter = false;
        
        // æ£€æŸ¥"æœ‰æˆæƒ"è¿‡æ»¤æ¡ä»¶
        if (filters.hasAuthorization) {
            const authBadge = card.querySelector('.badge:first-child');
            if (authBadge) {
                // æ£€æŸ¥æ˜¯å¦æœ‰æˆæƒç¼–å·ï¼ˆä¸å«"æœªç”³è¯·"æˆ–"å®¡æ‰¹ä¸­"ç­‰æ ‡è®°ï¼‰
                const hasNoAuth = authBadge.textContent.includes('æœªç”³è¯·') || 
                                 authBadge.textContent.includes('å®¡æ‰¹ä¸­') ||
                                 authBadge.textContent.includes('å·²é©³å›');
                if (hasNoAuth) {
                    shouldFilter = true;
                }
            }
        }
        
        // æ£€æŸ¥"é˜¶æ®µä¸åœ¨"è¿‡æ»¤æ¡ä»¶
        if (filters.stageNot && filters.stageNot.length) {
            const stageBadge = card.querySelector('.badge:nth-child(2)');
            if (stageBadge) {
                const stageName = stageBadge.textContent.trim();
                if (filters.stageNot.some(stage => {
                    if (stage === 'lost') return stageName.includes('å¤±è´¥');
                    if (stage === 'paused') return stageName.includes('æç½®');
                    if (stage === 'signed') return stageName.includes('ç­¾çº¦');
                    return false;
                })) {
                    shouldFilter = true;
                }
            }
        }
        
        // æ£€æŸ¥"å½“å‰é˜¶æ®µ"è¿‡æ»¤æ¡ä»¶
        if (filters.currentStage) {
            const stageBadge = card.querySelector('.badge:nth-child(2)');
            if (stageBadge) {
                const stageName = stageBadge.textContent.trim();
                let match = false;
                
                if (filters.currentStage === 'tendering' && stageName.includes('æ‹›æ ‡ä¸­')) {
                    match = true;
                } else if (filters.currentStage === 'awarded' && stageName.includes('ä¸­æ ‡')) {
                    match = true;
                }
                
                if (!match) {
                    shouldFilter = true;
                }
            }
        }
        
        // æ£€æŸ¥"æœ¬æœˆæ›´æ–°"è¿‡æ»¤æ¡ä»¶
        if (filters.updatedThisMonth) {
            // é¦–å…ˆå°è¯•æ‰¾åˆ°æ›´æ–°æ—¥æœŸçš„DOMå…ƒç´ 
            let dateElement = card.querySelector('.small.text-muted:last-child');
            let dateText = '';
            
            if (dateElement) {
                dateText = dateElement.textContent.trim();
                console.log("ç§»åŠ¨å¡ç‰‡æ‰¾åˆ°æ›´æ–°æ—¥æœŸå…ƒç´ :", dateText);
                
                // ä½¿ç”¨æ­£åˆ™æå–æ—¥æœŸéƒ¨åˆ†
                const dateMatch = dateText.match(/æ›´æ–°:\s*(\d{4}-\d{2}-\d{2}(?:\s+\d{2}:\d{2})?)/);
                if (dateMatch && dateMatch[1]) {
                    dateText = dateMatch[1].trim();
                }
            }
            
            // å¦‚æœæ‰¾ä¸åˆ°æ›´æ–°æ—¥æœŸå…ƒç´ ï¼Œå°è¯•ä»æ•´ä¸ªå¡ç‰‡æ–‡æœ¬ä¸­åŒ¹é…
            if (!dateText) {
                const updatedTextMatch = card.textContent.match(/æ›´æ–°:\s*(\d{4}-\d{2}-\d{2}(?:\s+\d{2}:\d{2})?)/);
                if (updatedTextMatch && updatedTextMatch[1]) {
                    dateText = updatedTextMatch[1].trim();
                }
                console.log("ä»å¡ç‰‡æ–‡æœ¬ä¸­æå–çš„æ›´æ–°æ—¥æœŸ:", dateText);
            }
            
            if (dateText) {
                // è§£ææ—¥æœŸ
                try {
                    const updatedDate = new Date(dateText);
                    const now = new Date();
                    
                    // æ£€æŸ¥æ˜¯å¦ä¸ºæœ¬æœˆæ›´æ–°
                    const isCurrentMonth = updatedDate.getMonth() === now.getMonth() && 
                                         updatedDate.getFullYear() === now.getFullYear();
                    
                    console.log("ç§»åŠ¨å¡ç‰‡æ›´æ–°æ—¶é—´æ£€æŸ¥:", dateText, 
                        "åŸå§‹æ—¥æœŸå¯¹è±¡:", updatedDate,
                        "æ˜¯å¦æœ¬æœˆ:", isCurrentMonth, 
                        "æ›´æ–°æœˆä»½:", updatedDate.getMonth() + 1, 
                        "å½“å‰æœˆä»½:", now.getMonth() + 1);
                    
                    if (!isCurrentMonth) {
                        shouldFilter = true;
                    }
                } catch (e) {
                    console.error("ç§»åŠ¨å¡ç‰‡æ—¥æœŸè§£æé”™è¯¯:", dateText, e);
                    shouldFilter = true;
                }
            } else {
                // å¦‚æœæ²¡æœ‰æ‰¾åˆ°æ›´æ–°æ—¥æœŸï¼Œåˆ™è¿‡æ»¤æ‰
                console.warn("ç§»åŠ¨å¡ç‰‡æœªæ‰¾åˆ°æ›´æ–°æ—¥æœŸ");
                shouldFilter = true;
            }
        }
        
        // æ ¹æ®ç­›é€‰ç»“æœï¼Œå°†å¡ç‰‡åˆ†åˆ°åŒ¹é…æˆ–è¿‡æ»¤é›†åˆä¸­
        if (shouldFilter) {
            card.classList.add('filtered');
            filteredCards.push(card);
        } else {
            card.classList.remove('filtered');
            matchedCards.push(card);
        }
    });
    
    // é‡æ–°æ’åˆ—è¡¨æ ¼è¡Œï¼šåŒ¹é…çš„è¡Œåœ¨å‰ï¼Œè¢«è¿‡æ»¤çš„è¡Œä¸æ˜¾ç¤º
    if (tableBody) {
        // æ¸…ç©ºè¡¨æ ¼
        while (tableBody.firstChild) {
            tableBody.removeChild(tableBody.firstChild);
        }
        
        // æ·»åŠ åŒ¹é…çš„è¡Œ
        matchedRows.forEach(row => {
            tableBody.appendChild(row);
            row.style.display = '';
        });
        
        // è¢«è¿‡æ»¤çš„è¡Œä¸æ˜¾ç¤ºï¼Œä½†ä»ä¿ç•™åœ¨DOMä¸­
        filteredRows.forEach(row => {
            row.style.display = 'none';
            tableBody.appendChild(row);
        });
    }
    
    // é‡æ–°æ’åˆ—ç§»åŠ¨ç«¯å¡ç‰‡ï¼šåŒ¹é…çš„å¡ç‰‡åœ¨å‰ï¼Œè¢«è¿‡æ»¤çš„å¡ç‰‡ä¸æ˜¾ç¤º
    if (mobileContainer) {
        // ä¿å­˜æ‰€æœ‰éå¡ç‰‡å…ƒç´ 
        const nonCardElements = Array.from(mobileContainer.children).filter(el => 
            !el.classList.contains('card')
        );
        
        // æ¸…ç©ºå®¹å™¨
        while (mobileContainer.firstChild) {
            mobileContainer.removeChild(mobileContainer.firstChild);
        }
        
        // é¦–å…ˆæ·»åŠ éå¡ç‰‡å…ƒç´ ï¼ˆå¦‚è­¦å‘Šã€æç¤ºç­‰ï¼‰
        nonCardElements.forEach(el => {
            mobileContainer.appendChild(el);
        });
        
        // æ·»åŠ åŒ¹é…çš„å¡ç‰‡
        matchedCards.forEach(card => {
            mobileContainer.appendChild(card);
            card.style.display = '';
        });
        
        // è¢«è¿‡æ»¤çš„å¡ç‰‡ä¸æ˜¾ç¤ºï¼Œä½†ä»ä¿ç•™åœ¨DOMä¸­
        filteredCards.forEach(card => {
            card.style.display = 'none';
            mobileContainer.appendChild(card);
        });
    }
    
    // æ›´æ–°æŒ‰é’®çŠ¶æ€
    triggerFilterStatusUpdate();
}

/**
 * è§¦å‘list.htmlä¸­çš„è¿‡æ»¤çŠ¶æ€æ›´æ–°å‡½æ•°
 */
function triggerFilterStatusUpdate() {
    // å¦‚æœä¸»é¡µé¢ä¸­å®šä¹‰äº†æ›´æ–°å‡½æ•°ï¼Œè°ƒç”¨å®ƒ
    if (typeof window.updateClearButtonState === 'function') {
        setTimeout(window.updateClearButtonState, 0);
    } else {
        // å¦‚æœæ²¡æœ‰å®šä¹‰ï¼Œåˆ™ä½¿ç”¨è‡ªå®šä¹‰äº‹ä»¶é€šçŸ¥
        document.dispatchEvent(new CustomEvent('filterStatusChanged'));
    }
}

/**
 * æ¸…é™¤æ‰€æœ‰ç»Ÿè®¡å¡ç‰‡ç­›é€‰
 * è¿™ä¸ªå‡½æ•°å¯ä»¥ä»å¤–éƒ¨è°ƒç”¨ï¼Œç”¨äºé‡ç½®æ‰€æœ‰å¡ç‰‡çŠ¶æ€
 */
function clearAllCardFilters() {
    // ç§»é™¤æ‰€æœ‰å¡ç‰‡çš„active-filterç±»
    const cards = [
        document.getElementById('validProjectsCard'),
        document.getElementById('tenderingProjectsCard'),
        document.getElementById('wonProjectsCard'),
        document.getElementById('updatedProjectsCard')
    ];
    
    cards.forEach(card => {
        if (card) {
            card.classList.remove('active-filter');
        }
    });
    
    // æ›´æ–°URLå‚æ•°ï¼Œç§»é™¤ç­›é€‰æ¡ä»¶
    const currentUrl = new URL(window.location.href);
    const params = new URLSearchParams(currentUrl.search);
    
    // ç§»é™¤æ‰€æœ‰å¡ç‰‡ç›¸å…³çš„è¿‡æ»¤æ¡ä»¶
    params.delete('filter_has_authorization');
    params.delete('filter_stage_not');
    params.delete('filter_current_stage');
    params.delete('filter_updated_this_month');
    
    // ä¿æŒç»Ÿè®¡é¢æ¿æ‰“å¼€çŠ¶æ€
    params.set('keep_panel', 'true');
    
    // æ›´æ–°URLä½†ä¸åˆ·æ–°é¡µé¢
    window.history.replaceState(null, '', '/project/?' + params.toString());
    
    // è°ƒç”¨æ¢å¤æ‰€æœ‰è®°å½•çš„å‡½æ•°
    if (typeof restoreAllRecords === 'function') {
        restoreAllRecords();
    } else {
        // å¦‚æœæ²¡æœ‰æ¢å¤å‡½æ•°ï¼Œä»ç„¶åº”ç”¨ç©ºç­›é€‰æ¡ä»¶
        clientSideFilter({});
    }
}

// å°†æ¸…é™¤å‡½æ•°æš´éœ²ç»™å…¨å±€ï¼Œä»¥ä¾¿ä¸»é¡µé¢å¯ä»¥è°ƒç”¨
window.clearAllCardFilters = clearAllCardFilters;

// å°†æ¢å¤å‡½æ•°æš´éœ²ç»™å…¨å±€ï¼Œä»¥ä¾¿ä¸»é¡µé¢å¯ä»¥è°ƒç”¨
window.restoreAllRecords = restoreAllRecords;
</script> 
            </div>
            <!-- è´¦æˆ·é€‰æ‹©å™¨å’Œé˜¶æ®µç­›é€‰å™¨ -->
            <div class="d-flex justify-content-between align-items-center mb-3">
                <div class="d-flex align-items-center gap-3">
                    <div class="dropdown account-selector">
                        <button class="btn btn-sm btn-outline-primary dropdown-toggle" type="button" id="accountSelectorBtn" data-bs-toggle="dropdown" aria-expanded="false">
                            å…¨éƒ¨è´¦æˆ·
                        </button>
                        <ul class="dropdown-menu" id="accountSelectorMenu" aria-labelledby="accountSelectorBtn">
                            <li><a class="dropdown-item active" href="#" data-account-id="all">å…¨éƒ¨è´¦æˆ·</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item text-center"><div class="spinner-border spinner-border-sm text-primary" role="status"><span class="visually-hidden">åŠ è½½ä¸­...</span></div></a></li>
                        </ul>
                    </div>
                    
                    <div class="dropdown stage-selector">
                        <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" id="stageSelectorBtn" data-bs-toggle="dropdown" aria-expanded="false">
                            å…¨éƒ¨é˜¶æ®µ
                        </button>
                        <ul class="dropdown-menu" id="stageSelectorMenu" aria-labelledby="stageSelectorBtn">
                            <li><a class="dropdown-item active" href="#" data-stage="all">å…¨éƒ¨é˜¶æ®µ</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="#" data-stage="discover">å‘ç°</a></li>
                            <li><a class="dropdown-item" href="#" data-stage="embed">æ¤å…¥</a></li>
                            <li><a class="dropdown-item" href="#" data-stage="pre_tender">æ‹›æ ‡å‰</a></li>
                            <li><a class="dropdown-item" href="#" data-stage="tendering">æ‹›æ ‡ä¸­</a></li>
                            <li><a class="dropdown-item" href="#" data-stage="awarded">ä¸­æ ‡</a></li>
                            <li><a class="dropdown-item" href="#" data-stage="quoted">æ‰¹ä»·</a></li>
                            <li><a class="dropdown-item" href="#" data-stage="signed">ç­¾çº¦</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="#" data-stage="lost">å¤±è´¥</a></li>
                            <li><a class="dropdown-item" href="#" data-stage="paused">æç½®</a></li>
                        </ul>
                    </div>
                </div>
                
<script>
// ç»Ÿè®¡æ€»è§ˆæ˜¾ç¤º/éšè—æŒ‰é’®é€»è¾‘
document.addEventListener('DOMContentLoaded', function () {
  const toggleStatisticsBtn = document.getElementById('toggleStatisticsBtn');
  const dashboardWrapper = document.getElementById('dashboardWrapper');
  const statisticsPanel = document.getElementById('projectStatisticsPanel');

  if (toggleStatisticsBtn && dashboardWrapper) {
    // ç¡®ä¿åˆå§‹çŠ¶æ€ï¼šé¢æ¿æ˜¯éšè—çš„ï¼ŒæŒ‰é’®æ–‡æœ¬æ˜¾ç¤º"æ˜¾ç¤ºç»Ÿè®¡æ€»è§ˆ"
    toggleStatisticsBtn.innerHTML = 'æ˜¾ç¤ºç»Ÿè®¡æ€»è§ˆ';
    dashboardWrapper.style.display = 'none';

    toggleStatisticsBtn.addEventListener('click', function () {
      if (dashboardWrapper.style.display === 'none') {
        // æ˜¾ç¤ºé¢æ¿
        dashboardWrapper.style.display = 'block';
        toggleStatisticsBtn.innerHTML = 'éšè—ç»Ÿè®¡æ€»è§ˆ';
        
        // ç¡®ä¿Bootstrap collapseä¹Ÿå±•å¼€
        if (statisticsPanel && !statisticsPanel.classList.contains('show')) {
          statisticsPanel.classList.add('show');
        }
        
        // å¯åŠ¨è‡ªåŠ¨åˆ‡æ¢ï¼ˆå¦‚æœå­˜åœ¨è¿™ä¸ªå‡½æ•°ï¼‰
        if (typeof startAutoSwitch === 'function' && !window.autoSwitchTimer) {
          startAutoSwitch();
        }
      } else {
        // éšè—é¢æ¿
        dashboardWrapper.style.display = 'none';
        toggleStatisticsBtn.innerHTML = 'æ˜¾ç¤ºç»Ÿè®¡æ€»è§ˆ';
        
        // ç¡®ä¿Bootstrap collapseä¹Ÿæ”¶èµ·
        if (statisticsPanel && statisticsPanel.classList.contains('show')) {
          statisticsPanel.classList.remove('show');
        }
        
        // åœæ­¢è‡ªåŠ¨åˆ‡æ¢ï¼ˆå¦‚æœå­˜åœ¨è¿™ä¸ªå®šæ—¶å™¨ï¼‰
        if (window.autoSwitchTimer) {
          clearInterval(window.autoSwitchTimer);
          window.autoSwitchTimer = null;
        }
      }
    });
  }

  // ç§»é™¤äº†ç­›é€‰çŠ¶æ€æŒ‡ç¤ºå’Œè¿”å›æŒ‰é’®ç›¸å…³ä»£ç 
});
</script>
            </div>
            <div class="d-flex justify-content-between align-items-center mb-3">
                <div class="d-flex align-items-center">
                    <div class="input-group" style="max-width: 300px;">
                        <input type="text" class="form-control" id="searchInput" placeholder="æœç´¢é¡¹ç›®åç§°..." value="">
                        <button class="btn btn-outline-secondary" type="button" id="searchButton">
                            <i class="fas fa-search"></i>
                        </button>
                    </div>
                    <div class="d-inline-flex align-items-center gap-2 flex-nowrap ms-4">
                        
<style>
.toggle-switch {
  position: relative;
  display: inline-block;
  width: 60px;
  height: 30px;
}
.toggle-switch input {
  opacity: 0;
  width: 0;
  height: 0;
}
.toggle-slider {
  position: absolute;
  background-color: #000;
  transition: .4s;
  border-radius: 34px;
  width: 100%;
  height: 100%;
}
.toggle-slider::before {
  position: absolute;
  content: "OFF";
  color: white;
  font-size: 12px;
  right: 8px;
  top: 50%;
  transform: translateY(-50%);
  transition: .4s;
}
.toggle-slider::after {
  content: "";
  position: absolute;
  height: 22px;
  width: 22px;
  left: 4px;
  bottom: 4px;
  background-color: white;
  border-radius: 50%;
  transition: .4s;
}
.toggle-switch input:checked + .toggle-slider::after {
  transform: translateX(30px);
}
.toggle-switch input:checked + .toggle-slider::before {
  content: "ON";
  left: 8px;
}
</style>

<div class="d-inline-flex align-items-center ">
  <label class="toggle-switch mb-0">
    <input type="checkbox" name="showMyProjectsSwitch"  id="showMyProjectsSwitch">
    <span class="toggle-slider"></span>
  </label>
</div>

                        <span class="form-label mb-0 text-nowrap">åªçœ‹è‡ªå·±</span>
                    </div>
                </div>
                <div class="d-none d-lg-block">
                    
                    
  
    <a href="/project/add" class="btn text-white me-2 py-2 px-4 text-sm rounded-pill me-2" style="background-color: #0C7CD0;" >
        åˆ›å»ºé¡¹ç›®
    </a>
  

                    
                    
  
    <button type="button" class="btn text-white me-2 py-2 px-4 text-sm rounded-pill" style="background-color: #dc3545;" id="batchDeleteBtn" style="display: none;"><i class="fas fa-trash me-1"></i>
        <span class="d-none d-md-inline">æ‰¹é‡åˆ é™¤</span>
    </button>
  

                    
                </div>
            </div>

            <!-- ç§»åŠ¨ç«¯+å·æµ®åŠ¨æŒ‰é’®ï¼Œä»…å°å±å¹•æ˜¾ç¤º -->
            <div class="d-lg-none">
                <button id="mobileFabBtn" class="btn btn-primary rounded-circle shadow position-fixed" style="right: 24px; bottom: 24px; width: 56px; height: 56px; z-index: 1050; font-size: 2rem; display: flex; align-items: center; justify-content: center;">
                    <i class="fas fa-plus"></i>
                </button>
                <div id="mobileFabMenu" class="card shadow position-fixed" style="right: 24px; bottom: 90px; min-width: 140px; z-index: 1051; display: none;">
                    <ul class="list-group list-group-flush">
                        
                        <li class="list-group-item p-2">
                            <a href="/project/add" class="text-primary text-decoration-none"><i class="fas fa-plus me-2"></i>åˆ›å»ºé¡¹ç›®</a>
                        </li>
                    </ul>
                </div>
            </div>

            <script>
            document.addEventListener('DOMContentLoaded', function() {
                var fabBtn = document.getElementById('mobileFabBtn');
                var fabMenu = document.getElementById('mobileFabMenu');
                if (fabBtn && fabMenu) {
                    fabBtn.addEventListener('click', function() {
                        fabMenu.style.display = fabMenu.style.display === 'none' ? 'block' : 'none';
                    });
                    document.addEventListener('click', function(e) {
                        if (!fabBtn.contains(e.target) && !fabMenu.contains(e.target)) {
                            fabMenu.style.display = 'none';
                        }
                    });
                }
                var importBtn = document.getElementById('importProjectsBtn');
                var mobileImportBtn = document.getElementById('mobileImportBtn');
                if (importBtn && mobileImportBtn) {
                    mobileImportBtn.addEventListener('click', function(e) {
                        e.preventDefault();
                        importBtn.click();
                    });
                }
            });
            </script>


            <!-- ç§»åŠ¨ç«¯å¡ç‰‡è§†å›¾ - ä»…åœ¨å°å±å¹•æ˜¾ç¤º -->
            <div class="d-block d-lg-none mb-4">
                
                <div class="alert alert-info text-center">æš‚æ— é¡¹ç›®æ•°æ®</div>
                
                
            </div>
            <!-- PCç«¯è¡¨æ ¼è§†å›¾ - ä»…åœ¨å¤§å±å¹•æ˜¾ç¤º -->
            <div class="table-container d-none d-lg-block">
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                
                                <th style="width: 40px;">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="selectAll">
                                    </div>
                                </th>
                                

                                <th style="min-width: 100px;" data-sort="owner_id">
                                    <div class="th-content">
                                        <span class="th-text">æ‹¥æœ‰è€…</span>
                                        <div class="th-actions">
                                            <i class="fas fa-sort sort-icon" data-sort="owner_id"></i>
                                            <i class="fas fa-filter filter-icon" data-field="owner_id"></i>
                                        </div>
                                    </div>
                                </th>
                                <th style="min-width: 120px;" data-sort="vendor_sales_manager_id">
                                    <div class="th-content">
                                        <span class="th-text">å‚å•†è´Ÿè´£äºº</span>
                                        <div class="th-actions">
                                            <i class="fas fa-sort sort-icon" data-sort="vendor_sales_manager_id"></i>
                                            <i class="fas fa-filter filter-icon" data-field="vendor_sales_manager_id"></i>
                                        </div>
                                    </div>
                                </th>
                                <th style="min-width: 120px;" data-sort="authorization_code">
                                    <div class="th-content">
                                        <span class="th-text">æˆæƒç¼–å·</span>
                                        <div class="th-actions">
                                            <i class="fas fa-sort sort-icon" data-sort="authorization_code"></i>
                                            <i class="fas fa-filter filter-icon" data-field="authorization_code"></i>
                                        </div>
                                    </div>
                                </th>
                                <th style="min-width: 200px;" data-sort="project_name">
                                    <div class="th-content">
                                        <span class="th-text">é¡¹ç›®åç§°</span>
                                        <div class="th-actions">
                                            <i class="fas fa-sort sort-icon" data-sort="project_name"></i>
                                            <i class="fas fa-filter filter-icon" data-field="project_name"></i>
                                        </div>
                                    </div>
                                </th>
                                <th style="min-width: 80px;" data-sort="is_active">
                                    <div class="th-content">
                                        <span class="th-text">æ´»è·ƒçŠ¶æ€</span>
                                        <div class="th-actions">
                                            <i class="fas fa-sort sort-icon" data-sort="is_active"></i>
                                            <i class="fas fa-filter filter-icon" data-field="is_active"></i>
                                        </div>
                                    </div>
                                </th>
                                <th style="min-width: 100px;" data-sort="current_stage">
                                    <div class="th-content">
                                        <span class="th-text">å½“å‰é˜¶æ®µ</span>
                                        <div class="th-actions">
                                            <i class="fas fa-sort sort-icon" data-sort="current_stage"></i>
                                            <i class="fas fa-filter filter-icon" data-field="current_stage"></i>
                                        </div>
                                    </div>
                                </th>
                                <th style="min-width: 100px;" data-sort="project_type">
                                    <div class="th-content">
                                        <span class="th-text">é¡¹ç›®ç±»å‹</span>
                                        <div class="th-actions">
                                            <i class="fas fa-sort sort-icon" data-sort="project_type"></i>
                                            <i class="fas fa-filter filter-icon" data-field="project_type"></i>
                                        </div>
                                    </div>
                                </th>
                                <th style="min-width: 120px;" data-sort="quotation_customer">
                                    <div class="th-content">
                                        <span class="th-text">æŠ¥ä»·ï¼ˆå…ƒï¼‰</span>
                                        <div class="th-actions">
                                            <i class="fas fa-sort sort-icon" data-sort="quotation_customer"></i>
                                            <i class="fas fa-filter filter-icon" data-field="quotation_customer"></i>
                                        </div>
                                    </div>
                                </th>
                                <th style="min-width: 100px;" data-sort="report_source">
                                    <div class="th-content">
                                        <span class="th-text">æŠ¥å¤‡æ¥æº</span>
                                        <div class="th-actions">
                                            <i class="fas fa-sort sort-icon" data-sort="report_source"></i>
                                            <i class="fas fa-filter filter-icon" data-field="report_source"></i>
                                        </div>
                                    </div>
                                </th>
                                <th style="min-width: 150px;" data-sort="end_user">
                                    <div class="th-content">
                                        <span class="th-text">ç›´æ¥ç”¨æˆ·</span>
                                        <div class="th-actions">
                                            <i class="fas fa-sort sort-icon" data-sort="end_user"></i>
                                            <i class="fas fa-filter filter-icon" data-field="end_user"></i>
                                        </div>
                                    </div>
                                </th>
                                <th style="min-width: 150px;" data-sort="design_issues">
                                    <div class="th-content">
                                        <span class="th-text">è®¾è®¡é™¢åŠé¡¾é—®</span>
                                        <div class="th-actions">
                                            <i class="fas fa-sort sort-icon" data-sort="design_issues"></i>
                                            <i class="fas fa-filter filter-icon" data-field="design_issues"></i>
                                        </div>
                                    </div>
                                </th>
                                <th style="min-width: 150px;" data-sort="contractor">
                                    <div class="th-content">
                                        <span class="th-text">æ€»æ‰¿åŒ…å•ä½</span>
                                        <div class="th-actions">
                                            <i class="fas fa-sort sort-icon" data-sort="contractor"></i>
                                            <i class="fas fa-filter filter-icon" data-field="contractor"></i>
                                        </div>
                                    </div>
                                </th>
                                <th style="min-width: 150px;" data-sort="system_integrator">
                                    <div class="th-content">
                                        <span class="th-text">ç³»ç»Ÿé›†æˆå•†</span>
                                        <div class="th-actions">
                                            <i class="fas fa-sort sort-icon" data-sort="system_integrator"></i>
                                            <i class="fas fa-filter filter-icon" data-field="system_integrator"></i>
                                        </div>
                                    </div>
                                </th>
                                <th style="min-width: 120px;" data-sort="delivery_forecast">
                                    <div class="th-content">
                                        <span class="th-text">å‡ºè´§é¢„æœŸæ—¥æœŸ</span>
                                        <div class="th-actions">
                                            <i class="fas fa-sort sort-icon" data-sort="delivery_forecast"></i>
                                            <i class="fas fa-filter filter-icon" data-field="delivery_forecast"></i>
                                        </div>
                                    </div>
                                </th>
                                <th style="min-width: 120px;" data-sort="report_time">
                                    <div class="th-content">
                                        <span class="th-text">æŠ¥å¤‡æ—¥æœŸ</span>
                                        <div class="th-actions">
                                            <i class="fas fa-sort sort-icon" data-sort="report_time"></i>
                                            <i class="fas fa-filter filter-icon" data-field="report_time"></i>
                                        </div>
                                    </div>
                                </th>
                                <th style="min-width: 150px;" data-sort="updated_at">
                                    <div class="th-content">
                                        <span class="th-text">æ›´æ–°æ—¶é—´</span>
                                        <div class="th-actions">
                                            <i class="fas fa-sort sort-icon" data-sort="updated_at"></i>
                                            <i class="fas fa-filter filter-icon" data-field="updated_at"></i>
                                        </div>
                                    </div>
                                </th>
                                <th style="min-width: 150px;" data-sort="created_at">
                                    <div class="th-content">
                                        <span class="th-text">åˆ›å»ºæ—¥æœŸ</span>
                                        <div class="th-actions">
                                            <i class="fas fa-sort sort-icon" data-sort="created_at"></i>
                                            <i class="fas fa-filter filter-icon" data-field="created_at"></i>
                                        </div>
                                    </div>
                                </th>
                            </tr>
                            <tr class="filter-row" style="display: none;">
                                
                                <th style="width: 40px;">
                                    <!-- å¤é€‰æ¡†åˆ—çš„ç­›é€‰åŒºåŸŸä¿æŒç©ºç™½ -->
                                    <div style="height: 28px;"></div>
                                </th>
                                

                                <th><input type="text" class="form-control form-control-sm filter-input" data-field="owner_id" placeholder="ç­›é€‰..."></th>
                                <th><input type="text" class="form-control form-control-sm filter-input" data-field="vendor_sales_manager_id" placeholder="ç­›é€‰..."></th>
                                <th><input type="text" class="form-control form-control-sm filter-input" data-field="authorization_code" placeholder="ç­›é€‰..."></th>
                                <th><input type="text" class="form-control form-control-sm filter-input" data-field="project_name" placeholder="ç­›é€‰..."></th>
                                <th><input type="text" class="form-control form-control-sm filter-input" data-field="is_active" placeholder="ç­›é€‰..."></th>
                                <th><input type="text" class="form-control form-control-sm filter-input" data-field="current_stage" placeholder="ç­›é€‰..."></th>
                                <th><input type="text" class="form-control form-control-sm filter-input" data-field="project_type" placeholder="ç­›é€‰..."></th>
                                <th><input type="text" class="form-control form-control-sm filter-input" data-field="quotation_customer" placeholder="ç­›é€‰..."></th>
                                <th><input type="text" class="form-control form-control-sm filter-input" data-field="report_source" placeholder="ç­›é€‰..."></th>
                                <th><input type="text" class="form-control form-control-sm filter-input" data-field="end_user" placeholder="ç­›é€‰..."></th>
                                <th><input type="text" class="form-control form-control-sm filter-input" data-field="design_issues" placeholder="ç­›é€‰..."></th>
                                <th><input type="text" class="form-control form-control-sm filter-input" data-field="contractor" placeholder="ç­›é€‰..."></th>
                                <th><input type="text" class="form-control form-control-sm filter-input" data-field="system_integrator" placeholder="ç­›é€‰..."></th>
                                <th><input type="date" class="form-control form-control-sm filter-input" data-field="delivery_forecast"></th>
                                <th><input type="date" class="form-control form-control-sm filter-input" data-field="report_time"></th>
                                <th><input type="date" class="form-control form-control-sm filter-input" data-field="updated_at"></th>
                                <th><input type="date" class="form-control form-control-sm filter-input" data-field="created_at"></th>
                            </tr>
                        </thead>
                        <tbody>
                            
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- æ·»åŠ æ»šåŠ¨æ§åˆ¶æŒ‰é’® -->
<div class="scroll-controls">
    <button type="button" class="btn btn-sm btn-light scroll-top" title="æ»šåŠ¨åˆ°é¡¶éƒ¨">
        <i class="fas fa-chevron-up"></i>
    </button>
    <button type="button" class="btn btn-sm btn-light scroll-bottom" title="æ»šåŠ¨åˆ°åº•éƒ¨">
        <i class="fas fa-chevron-down"></i>
    </button>
</div>

<!--
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                              âš ï¸ å…³é”®æ ·å¼å®šä¹‰ âš ï¸                                 â•‘
â•‘                                                                                â•‘
â•‘  ä»¥ä¸‹æ ·å¼æ˜¯ä¿è¯è¡¨æ ¼æ­£ç¡®æ˜¾ç¤ºå’Œè¡Œä¸ºçš„å…³é”®ã€‚ä¿®æ”¹è¿™äº›æ ·å¼å¯èƒ½ä¼šç ´åï¼š               â•‘
â•‘  - è¡¨æ ¼çš„å“åº”å¼å¸ƒå±€                                                           â•‘
â•‘  - æ“ä½œåˆ—çš„å›ºå®šå®šä½                                                           â•‘
â•‘  - æ¡çº¹è¡Œå’Œæ‚¬åœæ•ˆæœ                                                           â•‘
â•‘                                                                                â•‘
â•‘  ğŸš« å¦‚éœ€ä¿®æ”¹ï¼Œè¯·å…ˆè·å¾—å€ªæ·çš„ç¡®è®¤                                               â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-->
<style>
/* !!! æ ¸å¿ƒå¸ƒå±€æ ·å¼ - ä¸è¦ä¿®æ”¹ !!! */
.table-container {
    position: relative;
    width: 100%;
    overflow: hidden;
    margin-bottom: 20px; /* æ·»åŠ åº•éƒ¨é—´è· */
}

.table-responsive {
    margin: 0;
    padding: 0;
    width: 100%;
    overflow-x: auto;
    max-height: 65vh; /* è®¾ç½®æœ€å¤§é«˜åº¦ä¸ºè§†å£é«˜åº¦çš„65% */
    overflow-y: auto; /* æ·»åŠ å‚ç›´æ»šåŠ¨ */
}

.table {
    margin-bottom: 0;
    font-size: 14px; /* å°†è¡¨æ ¼å­—ä½“å¤§å°è®¾ç½®ä¸º14px */
    border-collapse: separate;
    border-spacing: 0;
}

/* ä¸ºè¡¨æ ¼è¡Œå’Œå¡ç‰‡æ·»åŠ å¹³æ»‘è¿‡æ¸¡æ•ˆæœ */
.table tbody tr, .d-block.d-lg-none .card {
    transition: opacity 0.2s ease-in-out;
}

/* éšè—è¡Œæ—¶ä½¿ç”¨é€æ˜åº¦è€Œä¸æ˜¯display:noneï¼Œæä¾›æ›´å¥½çš„è§†è§‰ä½“éªŒ */
.table tbody tr.filtered, .d-block.d-lg-none .card.filtered {
    opacity: 0;
    height: 0;
    overflow: hidden;
    padding: 0;
    margin: 0;
    border: none;
}

/* !!! è¡¨å¤´å›ºå®šæ ·å¼ - ä¸è¦ä¿®æ”¹ !!! */
.table th {
    white-space: nowrap;
    background-color: #f8f9fa;
    position: sticky;
    top: 0;
    z-index: 2;
    box-shadow: 0 1px 1px rgba(0,0,0,0.1); /* æ·»åŠ é˜´å½±å¢å¼ºè¡¨å¤´åˆ†éš”æ•ˆæœ */
    height: 48px; /* è®¾ç½®å›ºå®šé«˜åº¦ */
    vertical-align: middle;
    padding: 8px 12px;
    border-bottom: 2px solid #dee2e6; /* åŠ å¼ºè¡¨å¤´åº•éƒ¨è¾¹æ¡† */
}

.table td {
    white-space: nowrap;
}

/* !!! æ‚¬åœæ•ˆæœæ ·å¼ - ä¸è¦ä¿®æ”¹ !!! */
.table-hover tbody tr:hover td {
    background-color: #e9ecef !important;
}

/* é¡¹ç›®åç§°é“¾æ¥æ ·å¼ */
.table td a.project-link {
    text-decoration: underline !important; /* ä¸ºé¡¹ç›®åç§°æ·»åŠ ä¸‹åˆ’çº¿ */
    color: #0d6efd; /* é“¾æ¥è“è‰² */
}

/* é¼ æ ‡æ‚¬åœæ—¶çš„æ ·å¼ */
.table td a.project-link:hover {
    color: #0a58ca; /* æ‚¬åœæ—¶æ·±è“è‰² */
    font-weight: 500; /* æ‚¬åœæ—¶ç¨å¾®åŠ ç²— */
}

.project-link:hover {
    text-decoration: underline;
    color: #0056b3;
}

/* æŠ¥ä»·é“¾æ¥æ ·å¼ */
.quotation-link {
    color: #0d6efd;
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    gap: 8px;
}

.quotation-link:hover {
    text-decoration: underline;
    color: #0056b3;
}

.quotation-link .badge {
    font-size: 0.75rem;
    padding: 0.25rem 0.5rem;
}

/* æ’åºå›¾æ ‡æ ·å¼ */
.sort-icon {
    margin-left: 3px;
    font-size: 0.75rem;
    color: #6c757d;
    cursor: pointer;
    opacity: 0.7;
    transition: all 0.2s;
}

.sort-icon:hover,
.sort-icon.fa-sort-up,
.sort-icon.fa-sort-down {
    color: #0d6efd;
    opacity: 1;
}

/* è¿‡æ»¤å›¾æ ‡æ ·å¼ */
.filter-icon {
    margin-left: 3px;
    font-size: 0.75rem;
    color: #6c757d;
    cursor: pointer;
    opacity: 0.7;
    transition: all 0.2s;
    padding: 4px; /* å¢åŠ å¯ç‚¹å‡»åŒºåŸŸ */
    border-radius: 3px; /* æ·»åŠ åœ†è§’ */
}

.filter-icon:hover {
    color: #0d6efd;
    opacity: 1;
    background-color: rgba(13, 110, 253, 0.1); /* æ‚¬åœèƒŒæ™¯è‰² */
}

.filter-icon.active {
    color: #0d6efd;
    opacity: 1;
    background-color: rgba(13, 110, 253, 0.2); /* æ¿€æ´»çŠ¶æ€èƒŒæ™¯è‰² */
}

/* è¡¨å¤´å†…å®¹å¸ƒå±€ */
.th-content {
    display: flex;
    align-items: center;
    justify-content: space-between;
    width: 100%;
    min-height: 32px; /* ç¡®ä¿è¡¨å¤´å†…å®¹æœ‰æœ€å°é«˜åº¦ */
}

.th-text {
    flex-grow: 1;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.th-actions {
    display: flex;
    gap: 6px;
    margin-left: 6px;
    flex-shrink: 0; /* é˜²æ­¢æ“ä½œæŒ‰é’®è¢«å‹ç¼© */
}

/* ç­›é€‰è¡Œæ ·å¼ */
.filter-row th {
    padding: 4px 8px;
    background-color: #f0f0f0;
    position: sticky;
    top: 48px; /* è°ƒæ•´ä¸ºå®é™…è¡¨å¤´é«˜åº¦ */
    z-index: 1;
    box-shadow: 0 1px 1px rgba(0,0,0,0.05);
    height: 40px; /* è®¾ç½®ç­›é€‰è¡Œå›ºå®šé«˜åº¦ */
    vertical-align: middle;
    border-bottom: 1px solid #dee2e6; /* æ·»åŠ åº•éƒ¨è¾¹æ¡† */
}

.filter-input {
    width: 100%;
    padding: 4px 8px;
    font-size: 12px;
    border: 1px solid #ddd;
    border-radius: 3px;
    height: 28px; /* è®¾ç½®è¾“å…¥æ¡†å›ºå®šé«˜åº¦ */
    box-sizing: border-box;
    background-color: #fff;
    transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
}

.filter-input:focus {
    border-color: #86b7fe;
    outline: 0;
    box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
}

/* æ»šåŠ¨æ¡æ ·å¼ç¾åŒ– */
.table-responsive::-webkit-scrollbar {
    width: 8px;
    height: 8px;
}

.table-responsive::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 4px;
}

.table-responsive::-webkit-scrollbar-thumb {
    background: #ccc;
    border-radius: 4px;
}

.table-responsive::-webkit-scrollbar-thumb:hover {
    background: #999;
}

/* è¡¨æ ¼å•å…ƒæ ¼æ ·å¼å¢å¼º */
.table td {
    white-space: nowrap;
    border-bottom: 1px solid #dee2e6;
    padding: 8px 12px;
    vertical-align: middle;
}

/* å¥‡å¶è¡Œé¢œè‰²åŒºåˆ†ï¼Œå¢å¼ºå¯è¯»æ€§ */
.table-striped > tbody > tr:nth-of-type(odd) > * {
    background-color: rgba(0, 0, 0, 0.02);
}

/* è¡¨å¤´è¾¹æ¡†å¤„ç† */
.table > :not(caption) > * > * {
    border-bottom-width: 1px;
}

/* æ»šåŠ¨é¡ºæ»‘æ•ˆæœ */
.table-responsive {
    scrollbar-width: thin;
    scroll-behavior: smooth;
}

/* æ·»åŠ è¡¨æ ¼æ–‘é©¬çº¹æ•ˆæœï¼Œæ¯äº”è¡ŒåŠ å¼ºä¸€æ¬¡ */
.table-striped > tbody > tr:nth-of-type(10n+5) > * {
    background-color: rgba(0, 0, 0, 0.04);
}

/* æ»šåŠ¨æ§åˆ¶æŒ‰é’®æ ·å¼ */
.scroll-controls {
    position: fixed;
    right: 20px;
    bottom: 50px;
    display: flex;
    flex-direction: column;
    gap: 5px;
    z-index: 1000;
    opacity: 0.7;
    transition: opacity 0.3s;
}

.scroll-controls:hover {
    opacity: 1;
}

.scroll-controls button {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    display: flex;
    align-items: center;
    justify-content: center;
}

.scroll-controls button:hover {
    background-color: #f0f0f0;
}

/* è¡Œç„¦ç‚¹æ•ˆæœ */
.table tbody tr.highlight-row {
    background-color: rgba(13, 110, 253, 0.08) !important;
    outline: 1px solid rgba(13, 110, 253, 0.3);
    box-shadow: 0 0 5px rgba(13, 110, 253, 0.2);
}

/* ç§»åŠ¨ç«¯å¡ç‰‡è§†å›¾æ ·å¼ */
@media (max-width: 991.98px) {
    .card-title {
        font-size: 1.1rem;
    }
    .card-body {
        padding: 0.75rem;
    }
    .btn-group-sm .btn {
        padding: 0.25rem 0.5rem;
        font-size: 0.75rem;
    }
    .shadow-sm {
        box-shadow: 0 .125rem .25rem rgba(0,0,0,.075)!important;
        border-radius: 0.5rem;
        border: none;
    }
    .fa-phone, .fa-envelope, .fa-user, .fa-clock,
    .fa-building, .fa-yen-sign, .fa-shipping-fast,
    .fa-calendar-plus, .fa-calendar-check {
        width: 16px;
        text-align: center;
    }
}
</style>

<!--
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                              âš ï¸ åŠŸèƒ½è„šæœ¬ âš ï¸                                    â•‘
â•‘                                                                                â•‘
â•‘  ä»¥ä¸‹JavaScriptä»£ç å¤„ç†è¡¨æ ¼çš„äº¤äº’åŠŸèƒ½ã€‚ä¿®æ”¹å¯èƒ½ä¼šå½±å“ï¼š                        â•‘
â•‘  - é¡¹ç›®æœç´¢åŠŸèƒ½                                                               â•‘
â•‘  - åˆ é™¤ç¡®è®¤åŠŸèƒ½                                                               â•‘
â•‘                                                                                â•‘
â•‘  ğŸš« å¦‚éœ€ä¿®æ”¹ï¼Œè¯·å…ˆè·å¾—å€ªæ·çš„ç¡®è®¤                                               â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-->
<script>
function deleteProject(id) {
    if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªé¡¹ç›®å—ï¼Ÿ')) {
        fetch(`/project/${id}/delete`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest',  // æ·»åŠ AJAXæ ‡è¯†
                'X-CSRFToken': 'ImMyYzcyOTkxMDhjYTY2NDhiYjE1NjQxYWFkMzViYjI3YjAzNDQwMTci.aEZIFg._o0f2LiUOUFgknXyMyvzDwrr9S4'  // æ·»åŠ CSRFä»¤ç‰Œ
            }
        })
        .then(response => {
            if (response.redirected) {
                window.location.href = response.url;
                return Promise.reject('é‡å®šå‘');
            }

            if (!response.ok) {
                throw new Error('åˆ é™¤å¤±è´¥');
            }

            window.location.reload();
        })
        .catch(error => {
            console.error('Error:', error);
            alert(typeof error === 'object' ? error.message : error);
        });
    }
}

document.addEventListener('DOMContentLoaded', function() {
    // æœç´¢æŒ‰é’®ç‚¹å‡»äº‹ä»¶
    const searchButton = document.getElementById('searchButton');
    const searchInput = document.getElementById('searchInput');
    
    searchButton.addEventListener('click', function() {
        performSearch();
    });
    
    searchInput.addEventListener('keypress', function(e) {
        if(e.key === 'Enter') {
            performSearch();
        }
    });
    
    // è·å–URLå‚æ•°
    const urlParams = new URLSearchParams(window.location.search);
    const searchParam = urlParams.get('search');
    const myProjectsParam = urlParams.get('my_projects');
    
    // åˆå§‹åŒ–æœç´¢æ¡†å€¼
    if (searchParam) {
        searchInput.value = searchParam;
    }
    
    // åˆå§‹åŒ–"åªçœ‹è‡ªå·±"è¿‡æ»¤
    const showMyProjectsSwitch = document.getElementById('showMyProjectsSwitch');
    
    // å¦‚æœURLåŒ…å«my_projects=1å‚æ•°ï¼Œåº”ç”¨å®¢æˆ·ç«¯è¿‡æ»¤
    if (myProjectsParam === '1' && showMyProjectsSwitch) {
        // ç¡®ä¿å¼€å…³çŠ¶æ€ä¸URLå‚æ•°ä¸€è‡´
        showMyProjectsSwitch.checked = true;
        
        // åº”ç”¨è¿‡æ»¤
        const currentUserId = parseInt("6");
        
        // PCç«¯è¡¨æ ¼è§†å›¾è¿‡æ»¤
        const tableRows = document.querySelectorAll('.table tbody tr');
        tableRows.forEach(row => {
            const ownerSpan = row.querySelector('td [data-owner-id]');
            const vendorSalesManagerSpan = row.querySelector('td [data-vendor-sales-manager-id]');
            
            let isMyProject = false;
            
            // æ£€æŸ¥æ˜¯å¦æ˜¯æ‹¥æœ‰äºº
            if (ownerSpan) {
                const ownerId = parseInt(ownerSpan.getAttribute('data-owner-id'));
                if (ownerId === currentUserId) {
                    isMyProject = true;
                }
            }
            
            // æ£€æŸ¥æ˜¯å¦æ˜¯å‚å•†è´Ÿè´£äºº
            if (!isMyProject && vendorSalesManagerSpan) {
                const vendorSalesManagerId = parseInt(vendorSalesManagerSpan.getAttribute('data-vendor-sales-manager-id'));
                if (vendorSalesManagerId === currentUserId) {
                    isMyProject = true;
                }
            }
            
            if (!isMyProject) {
                row.classList.add('filtered');
            }
        });
        
        // ç§»åŠ¨ç«¯å¡ç‰‡è§†å›¾è¿‡æ»¤
        const mobileCards = document.querySelectorAll('.d-block.d-lg-none .card');
        mobileCards.forEach(card => {
            const ownerSpan = card.querySelector('[data-owner-id]');
            const vendorSalesManagerSpan = card.querySelector('[data-vendor-sales-manager-id]');
            
            let isMyProject = false;
            
            // æ£€æŸ¥æ˜¯å¦æ˜¯æ‹¥æœ‰äºº
            if (ownerSpan) {
                const ownerId = parseInt(ownerSpan.getAttribute('data-owner-id'));
                if (ownerId === currentUserId) {
                    isMyProject = true;
                }
            }
            
            // æ£€æŸ¥æ˜¯å¦æ˜¯å‚å•†è´Ÿè´£äºº
            if (!isMyProject && vendorSalesManagerSpan) {
                const vendorSalesManagerId = parseInt(vendorSalesManagerSpan.getAttribute('data-vendor-sales-manager-id'));
                if (vendorSalesManagerId === currentUserId) {
                    isMyProject = true;
                }
            }
            
            if (!isMyProject) {
                card.classList.add('filtered');
            }
        });
    }
    
    // åªçœ‹è‡ªå·±å¼€å…³äº‹ä»¶
    showMyProjectsSwitch.addEventListener('change', function() {
        // ç›´æ¥è°ƒç”¨performSearchå‡½æ•°åº”ç”¨è¿‡æ»¤
        performSearch();
        
        // å¦‚æœå¼€å…³è¢«å…³é—­ï¼Œç¡®ä¿æ‰€æœ‰è¡Œæ˜¾ç¤ºï¼ˆæ¸…é™¤"åªçœ‹è‡ªå·±"çš„è¿‡æ»¤ï¼‰
        if (!this.checked) {
            // è·å–æ‰€æœ‰è¡¨æ ¼è¡Œå’Œç§»åŠ¨ç«¯å¡ç‰‡
            const tableRows = document.querySelectorAll('.table tbody tr');
            const mobileCards = document.querySelectorAll('.d-block.d-lg-none .card');
            const tableBody = document.querySelector('.table tbody');
            const mobileContainer = document.querySelector('.d-block.d-lg-none');
            
            // å…ˆæ£€æŸ¥æ˜¯å¦æœ‰æœç´¢æ¡ä»¶
            const searchText = searchInput.value.trim().toLowerCase();
            if (!searchText) {
                // å¦‚æœæ²¡æœ‰æœç´¢æ¡ä»¶ï¼Œé‡æ–°æ’åˆ—æ‰€æœ‰å…ƒç´ 
                const allRows = Array.from(tableRows);
                const allCards = Array.from(mobileCards);
                
                // æŒ‰æ›´æ–°æ—¶é—´é™åºæ’åºçš„å‡½æ•°
                const sortByUpdatedAtDesc = (a, b) => {
                  // å°è¯•ä»å…ƒç´ ä¸­è·å–æ›´æ–°æ—¶é—´
                  const getUpdatedAt = (el) => {
                    // ä»è¡¨æ ¼è¡Œä¸­æå–æ›´æ–°æ—¶é—´ï¼ˆå‡è®¾åœ¨å€’æ•°ç¬¬äºŒåˆ—ï¼‰
                    if (!el.classList.contains('card')) {
                      // PCç«¯è¡¨æ ¼è§†å›¾
                      const cells = el.querySelectorAll('td');
                      if (cells.length > 2) {
                        const updatedAtCell = cells[cells.length - 2]; // å€’æ•°ç¬¬äºŒåˆ—æ˜¯æ›´æ–°æ—¶é—´
                        if (updatedAtCell) {
                          const dateText = updatedAtCell.textContent.trim();
                          if (dateText) {
                            return new Date(dateText).getTime();
                          }
                        }
                      }
                    } else {
                      // ç§»åŠ¨ç«¯å¡ç‰‡è§†å›¾
                      const updatedAtText = el.textContent.match(/æ›´æ–°: (\d{4}-\d{2}-\d{2})/);
                      if (updatedAtText && updatedAtText[1]) {
                        return new Date(updatedAtText[1]).getTime();
                      }
                    }
                    return 0; // é»˜è®¤æ—¶é—´æˆ³
                  };
                  
                  const updatedAtA = getUpdatedAt(a);
                  const updatedAtB = getUpdatedAt(b);
                  return updatedAtB - updatedAtA; // é™åºæ’åˆ—ï¼ˆæ–°åˆ°æ—§ï¼‰
                };
                
                // æ’åºè¡Œå’Œå¡ç‰‡
                allRows.sort(sortByUpdatedAtDesc);
                allCards.sort(sortByUpdatedAtDesc);
                
                // é‡æ–°æ’åˆ—è¡¨æ ¼è¡Œ
                if (tableBody) {
                    // æ¸…ç©ºè¡¨æ ¼
                    while (tableBody.firstChild) {
                        tableBody.removeChild(tableBody.firstChild);
                    }
                    
                    // é‡æ–°æ·»åŠ æ‰€æœ‰è¡Œ
                    allRows.forEach(row => {
                        row.classList.remove('filtered');
                        row.style.display = '';
                        tableBody.appendChild(row);
                    });
                }
                
                // é‡æ–°æ’åˆ—ç§»åŠ¨ç«¯å¡ç‰‡
                if (mobileContainer) {
                    // ä¿å­˜éå¡ç‰‡å…ƒç´ 
                    const nonCardElements = Array.from(mobileContainer.children).filter(el => 
                        !el.classList.contains('card')
                    );
                    
                    // æ¸…ç©ºå®¹å™¨
                    while (mobileContainer.firstChild) {
                        mobileContainer.removeChild(mobileContainer.firstChild);
                    }
                    
                    // æ·»åŠ éå¡ç‰‡å…ƒç´ 
                    nonCardElements.forEach(el => {
                        mobileContainer.appendChild(el);
                    });
                    
                    // æ·»åŠ æ‰€æœ‰å¡ç‰‡
                    allCards.forEach(card => {
                        card.classList.remove('filtered');
                        card.style.display = '';
                        mobileContainer.appendChild(card);
                    });
                }
            }
        }
    });

// æ‰§è¡Œæœç´¢åŠŸèƒ½ï¼Œåœ¨å®¢æˆ·ç«¯è¿‡æ»¤ä¸åˆ·æ–°é¡µé¢
    function performSearch() {
    const searchText = searchInput.value.trim().toLowerCase();
    const isMyProjectsOnly = showMyProjectsSwitch.checked;
    
    // è·å–æ‰€æœ‰è¡¨æ ¼è¡Œå’Œç§»åŠ¨ç«¯å¡ç‰‡
    const tableRows = document.querySelectorAll('.table tbody tr');
    const mobileCards = document.querySelectorAll('.d-block.d-lg-none .card');
    const tableBody = document.querySelector('.table tbody');
    const mobileContainer = document.querySelector('.d-block.d-lg-none');
    
    // å¦‚æœæ²¡æœ‰ä»»ä½•ç­›é€‰æ¡ä»¶ï¼Œæ¢å¤æ‰€æœ‰å…ƒç´ æ˜¾ç¤º
    if (!searchText && !isMyProjectsOnly) {
        // æŒ‰æ›´æ–°æ—¶é—´é™åºæ’åºçš„å‡½æ•°
        const sortByUpdatedAtDesc = (a, b) => {
            // å°è¯•ä»å…ƒç´ ä¸­è·å–æ›´æ–°æ—¶é—´
            const getUpdatedAt = (el) => {
                // ä»è¡¨æ ¼è¡Œä¸­æå–æ›´æ–°æ—¶é—´ï¼ˆå‡è®¾åœ¨å€’æ•°ç¬¬äºŒåˆ—ï¼‰
                if (!el.classList.contains('card')) {
                    // PCç«¯è¡¨æ ¼è§†å›¾
                    const cells = el.querySelectorAll('td');
                    if (cells.length > 2) {
                        const updatedAtCell = cells[cells.length - 2]; // å€’æ•°ç¬¬äºŒåˆ—æ˜¯æ›´æ–°æ—¶é—´
                        if (updatedAtCell) {
                            const dateText = updatedAtCell.textContent.trim();
                            if (dateText) {
                                return new Date(dateText).getTime();
                            }
                        }
                    }
                } else {
                    // ç§»åŠ¨ç«¯å¡ç‰‡è§†å›¾
                    const updatedAtText = el.textContent.match(/æ›´æ–°: (\d{4}-\d{2}-\d{2})/);
                    if (updatedAtText && updatedAtText[1]) {
                        return new Date(updatedAtText[1]).getTime();
                    }
                }
                return 0; // é»˜è®¤æ—¶é—´æˆ³
            };
            
            const updatedAtA = getUpdatedAt(a);
            const updatedAtB = getUpdatedAt(b);
            return updatedAtB - updatedAtA; // é™åºæ’åˆ—ï¼ˆæ–°åˆ°æ—§ï¼‰
        };
        
        // å¤åˆ¶æ‰€æœ‰è¡Œå’Œå¡ç‰‡åˆ°æ•°ç»„ï¼Œä»¥ä¾¿æ’åº
        const allRows = Array.from(tableRows);
        const allCards = Array.from(mobileCards);
        
        // æŒ‰æ›´æ–°æ—¶é—´æ’åº
        allRows.sort(sortByUpdatedAtDesc);
        allCards.sort(sortByUpdatedAtDesc);
        
        // é‡æ–°å¡«å……è¡¨æ ¼
        if (tableBody) {
            // æ¸…ç©ºè¡¨æ ¼
            while (tableBody.firstChild) {
                tableBody.removeChild(tableBody.firstChild);
            }
            
            // æ·»åŠ æ‰€æœ‰è¡Œ
            allRows.forEach(row => {
                row.classList.remove('filtered');
                row.style.display = '';
                tableBody.appendChild(row);
            });
        }
        
        // é‡æ–°å¡«å……ç§»åŠ¨å®¹å™¨
        if (mobileContainer) {
            // ä¿å­˜æ‰€æœ‰éå¡ç‰‡å…ƒç´ 
            const nonCardElements = Array.from(mobileContainer.children).filter(el => 
                !el.classList.contains('card')
            );
            
            // æ¸…ç©ºå®¹å™¨
            while (mobileContainer.firstChild) {
                mobileContainer.removeChild(mobileContainer.firstChild);
            }
            
            // é¦–å…ˆæ·»åŠ éå¡ç‰‡å…ƒç´ 
            nonCardElements.forEach(el => {
                mobileContainer.appendChild(el);
            });
            
            // æ·»åŠ æ‰€æœ‰å¡ç‰‡
            allCards.forEach(card => {
                card.classList.remove('filtered');
                card.style.display = '';
                mobileContainer.appendChild(card);
            });
        }
        
        // æ›´æ–°URLå‚æ•°
        const searchUrlParams = new URLSearchParams(window.location.search);
        searchUrlParams.delete('search');
        searchUrlParams.delete('my_projects');
        const searchNewUrl = `${window.location.pathname}?${searchUrlParams.toString()}`;
        window.history.replaceState(null, '', searchNewUrl);
        
        // æ›´æ–°æŒ‰é’®çŠ¶æ€
        if (typeof updateClearButtonState === 'function') {
            setTimeout(updateClearButtonState, 0);
        }
        
        return;
    }
    
    // ç”¨äºå­˜å‚¨åŒ¹é…å’Œç­›é€‰çš„è¡Œå’Œå¡ç‰‡
    const matchedRows = [];
    const filteredRows = [];
    const matchedCards = [];
    const filteredCards = [];
    
    // æ£€æŸ¥æ¯ä¸€è¡Œæ˜¯å¦åŒ¹é…æœç´¢æ¡ä»¶
    tableRows.forEach(row => {
        let shouldFilter = false;
        
        // å…ˆæ£€æŸ¥æœç´¢æ–‡æœ¬
        if (searchText) {
            const projectNameLink = row.querySelector('a.project-link');
            if (projectNameLink) {
                const projectName = projectNameLink.textContent.toLowerCase();
                if (!projectName.includes(searchText)) {
                    shouldFilter = true;
                }
            }
        }
        
        // å†æ£€æŸ¥"åªçœ‹è‡ªå·±"æ¡ä»¶
        if (!shouldFilter && isMyProjectsOnly) {
            const currentUserId = parseInt("6");
            const ownerSpan = row.querySelector('td [data-owner-id]');
            const vendorSalesManagerSpan = row.querySelector('td [data-vendor-sales-manager-id]');
            
            let isMyProject = false;
            
            // æ£€æŸ¥æ˜¯å¦æ˜¯æ‹¥æœ‰äºº
            if (ownerSpan) {
                const ownerId = parseInt(ownerSpan.getAttribute('data-owner-id'));
                if (ownerId === currentUserId) {
                    isMyProject = true;
                }
            }
            
            // æ£€æŸ¥æ˜¯å¦æ˜¯å‚å•†è´Ÿè´£äºº
            if (!isMyProject && vendorSalesManagerSpan) {
                const vendorSalesManagerId = parseInt(vendorSalesManagerSpan.getAttribute('data-vendor-sales-manager-id'));
                if (vendorSalesManagerId === currentUserId) {
                    isMyProject = true;
                }
            }
            
            if (!isMyProject) {
                shouldFilter = true;
            }
        }
        
        // æ ¹æ®ç­›é€‰ç»“æœï¼Œåˆ†ç±»å­˜å‚¨
        if (shouldFilter) {
            row.classList.add('filtered');
            filteredRows.push(row);
        } else {
            row.classList.remove('filtered');
            matchedRows.push(row);
        }
    });
    
    // æ£€æŸ¥æ¯ä¸ªå¡ç‰‡æ˜¯å¦åŒ¹é…æœç´¢æ¡ä»¶
    mobileCards.forEach(card => {
        let shouldFilter = false;
        
        // å…ˆæ£€æŸ¥æœç´¢æ–‡æœ¬
        if (searchText) {
            const projectNameElem = card.querySelector('.card-title');
            if (projectNameElem) {
                const projectName = projectNameElem.textContent.toLowerCase();
                if (!projectName.includes(searchText)) {
                    shouldFilter = true;
                }
            }
        }
        
        // å†æ£€æŸ¥"åªçœ‹è‡ªå·±"æ¡ä»¶
        if (!shouldFilter && isMyProjectsOnly) {
            const currentUserId = parseInt("6");
            const ownerSpan = card.querySelector('[data-owner-id]');
            const vendorSalesManagerSpan = card.querySelector('[data-vendor-sales-manager-id]');
            
            let isMyProject = false;
            
            // æ£€æŸ¥æ˜¯å¦æ˜¯æ‹¥æœ‰äºº
            if (ownerSpan) {
                const ownerId = parseInt(ownerSpan.getAttribute('data-owner-id'));
                if (ownerId === currentUserId) {
                    isMyProject = true;
                }
            }
            
            // æ£€æŸ¥æ˜¯å¦æ˜¯å‚å•†è´Ÿè´£äºº
            if (!isMyProject && vendorSalesManagerSpan) {
                const vendorSalesManagerId = parseInt(vendorSalesManagerSpan.getAttribute('data-vendor-sales-manager-id'));
                if (vendorSalesManagerId === currentUserId) {
                    isMyProject = true;
                }
            }
            
            if (!isMyProject) {
                shouldFilter = true;
            }
        }
        
        // æ ¹æ®ç­›é€‰ç»“æœï¼Œåˆ†ç±»å­˜å‚¨
        if (shouldFilter) {
            card.classList.add('filtered');
            filteredCards.push(card);
        } else {
            card.classList.remove('filtered');
            matchedCards.push(card);
        }
    });
    
    // æŒ‰æ›´æ–°æ—¶é—´é™åºæ’åºåŒ¹é…çš„è¡Œå’Œå¡ç‰‡
    const sortByUpdatedAtDesc = (a, b) => {
        // å°è¯•ä»å…ƒç´ ä¸­è·å–æ›´æ–°æ—¶é—´
        const getUpdatedAt = (el) => {
            // ä»è¡¨æ ¼è¡Œä¸­æå–æ›´æ–°æ—¶é—´ï¼ˆå‡è®¾åœ¨å€’æ•°ç¬¬äºŒåˆ—ï¼‰
            if (!el.classList.contains('card')) {
                // PCç«¯è¡¨æ ¼è§†å›¾
                const cells = el.querySelectorAll('td');
                if (cells.length > 2) {
                    const updatedAtCell = cells[cells.length - 2]; // å€’æ•°ç¬¬äºŒåˆ—æ˜¯æ›´æ–°æ—¶é—´
                    if (updatedAtCell) {
                        const dateText = updatedAtCell.textContent.trim();
                        if (dateText) {
                            return new Date(dateText).getTime();
                        }
                    }
                }
            } else {
                // ç§»åŠ¨ç«¯å¡ç‰‡è§†å›¾
                const updatedAtText = el.textContent.match(/æ›´æ–°: (\d{4}-\d{2}-\d{2})/);
                if (updatedAtText && updatedAtText[1]) {
                    return new Date(updatedAtText[1]).getTime();
                }
            }
            return 0; // é»˜è®¤æ—¶é—´æˆ³
        };
        
        const updatedAtA = getUpdatedAt(a);
        const updatedAtB = getUpdatedAt(b);
        return updatedAtB - updatedAtA; // é™åºæ’åˆ—ï¼ˆæ–°åˆ°æ—§ï¼‰
    };
    
    // å¯¹åŒ¹é…çš„è¡Œå’Œå¡ç‰‡æŒ‰æ›´æ–°æ—¶é—´æ’åº
    matchedRows.sort(sortByUpdatedAtDesc);
    matchedCards.sort(sortByUpdatedAtDesc);
    
    // é‡æ–°æ’åˆ—è¡¨æ ¼è¡Œï¼šåŒ¹é…çš„è¡Œåœ¨å‰ï¼Œè¢«è¿‡æ»¤çš„è¡Œåœ¨å
    if (tableBody) {
        // æ¸…ç©ºè¡¨æ ¼
        while (tableBody.firstChild) {
            tableBody.removeChild(tableBody.firstChild);
        }
        
        // æ·»åŠ åŒ¹é…çš„è¡Œ
        matchedRows.forEach(row => {
            tableBody.appendChild(row);
            row.style.display = '';
        });
        
        // è¢«è¿‡æ»¤çš„è¡Œä¸å†æ·»åŠ å›DOM
        filteredRows.forEach(row => {
            // è¿™é‡Œé€‰æ‹©éšè—è€Œä¸æ˜¯ä¸æ·»åŠ ï¼Œé¿å…DOMèŠ‚ç‚¹ä¸¢å¤±
            row.style.display = 'none';
            tableBody.appendChild(row);
        });
    }
    
    // é‡æ–°æ’åˆ—ç§»åŠ¨ç«¯å¡ç‰‡ï¼šåŒ¹é…çš„å¡ç‰‡åœ¨å‰ï¼Œè¢«è¿‡æ»¤çš„å¡ç‰‡åœ¨å
    if (mobileContainer) {
        // ä¿å­˜æ‰€æœ‰éå¡ç‰‡å…ƒç´ 
        const nonCardElements = Array.from(mobileContainer.children).filter(el => 
            !el.classList.contains('card')
        );
        
        // æ¸…ç©ºå®¹å™¨
        while (mobileContainer.firstChild) {
            mobileContainer.removeChild(mobileContainer.firstChild);
        }
        
        // é¦–å…ˆæ·»åŠ éå¡ç‰‡å…ƒç´ ï¼ˆå¦‚è­¦å‘Šã€æç¤ºç­‰ï¼‰
        nonCardElements.forEach(el => {
            mobileContainer.appendChild(el);
        });
        
        // æ·»åŠ åŒ¹é…çš„å¡ç‰‡
        matchedCards.forEach(card => {
            mobileContainer.appendChild(card);
            card.style.display = '';
        });
        
        // è¢«è¿‡æ»¤çš„å¡ç‰‡éšè—ä½†ä»æ·»åŠ åˆ°DOM
        filteredCards.forEach(card => {
            card.style.display = 'none';
            mobileContainer.appendChild(card);
        });
    }
    
    // æ›´æ–°URLå‚æ•°ï¼Œä½†ä¸åˆ·æ–°é¡µé¢
    const searchUrlParams = new URLSearchParams(window.location.search);
    
    if (searchText) {
        searchUrlParams.set('search', searchText);
    } else {
        searchUrlParams.delete('search');
    }
    
    if (isMyProjectsOnly) {
        searchUrlParams.set('my_projects', '1');
    } else {
        searchUrlParams.delete('my_projects');
    }
    
    // æ›´æ–°URLï¼Œä¿ç•™å…¶ä»–å‚æ•°å¦‚æ’åº
    const searchNewUrl = `${window.location.pathname}?${searchUrlParams.toString()}`;
    window.history.replaceState(null, '', searchNewUrl);
    
    // å¦‚æœlist.htmlä¸­å·²ç»å®šä¹‰äº†æ›´æ–°æŒ‰é’®çŠ¶æ€çš„å‡½æ•°ï¼Œåˆ™è°ƒç”¨å®ƒ
    if (typeof updateClearButtonState === 'function') {
        setTimeout(updateClearButtonState, 0);
    }
}

// è¾“å…¥æ¡†å®æ—¶æœç´¢
searchInput.addEventListener('input', function() {
    performSearch();
    });

});

// ===================== ç‹¬ç«‹çš„ç­›é€‰åŠŸèƒ½åˆå§‹åŒ– =====================
document.addEventListener('DOMContentLoaded', function() {
    console.log('å¼€å§‹ç‹¬ç«‹åˆå§‹åŒ–åˆ—ç­›é€‰åŠŸèƒ½');

    // å»¶è¿Ÿåˆå§‹åŒ–ï¼Œç¡®ä¿å…¶ä»–åŠŸèƒ½å…ˆå®Œæˆ
    setTimeout(function() {
        console.log('å»¶è¿Ÿåˆå§‹åŒ–ç­›é€‰åŠŸèƒ½');
        
        // ç«‹å³ä¿å­˜åŸå§‹æ•°æ®
        saveOriginalData();
        console.log('ç­›é€‰åŠŸèƒ½ï¼šåŸå§‹æ•°æ®å·²ä¿å­˜');
        
        // è·å–ç­›é€‰åŠŸèƒ½å…ƒç´ 
        const filterIcons = document.querySelectorAll('.filter-icon');
        const filterRow = document.querySelector('.filter-row');
        const filterInputs = document.querySelectorAll('.filter-input');
        
        console.log('æ‰¾åˆ°ç­›é€‰å›¾æ ‡æ•°é‡:', filterIcons.length, 'ç­›é€‰è¾“å…¥æ¡†æ•°é‡:', filterInputs.length);
        console.log('ç­›é€‰è¡Œå…ƒç´ :', filterRow);
        
        if (filterIcons.length === 0 || filterInputs.length === 0) {
            console.error('æœªæ‰¾åˆ°ç­›é€‰åŠŸèƒ½å…ƒç´ ï¼Œå¯èƒ½DOMæœªå®Œå…¨åŠ è½½');
                return;
            }

    // è®°å½•ç­›é€‰çŠ¶æ€
        let isFilterRowVisible = filterRow && filterRow.style.display !== 'none';
        console.log('åˆå§‹ç­›é€‰è¡Œæ˜¾ç¤ºçŠ¶æ€:', isFilterRowVisible);

    // ç‚¹å‡»ç­›é€‰å›¾æ ‡æ—¶æ˜¾ç¤º/éšè—ç­›é€‰è¡Œ
        filterIcons.forEach((icon, index) => {
            console.log(`ç»‘å®šç­›é€‰å›¾æ ‡ ${index}ï¼Œå­—æ®µ:`, icon.getAttribute('data-field'));
            
        icon.addEventListener('click', function(e) {
            e.stopPropagation(); // é˜»æ­¢äº‹ä»¶å†’æ³¡åˆ°thå…ƒç´ 

            const field = this.getAttribute('data-field');
                console.log('ç‚¹å‡»ç­›é€‰å›¾æ ‡ï¼Œå­—æ®µ:', field);

            // åˆ‡æ¢ç­›é€‰è¡Œæ˜¾ç¤ºçŠ¶æ€
            if (!isFilterRowVisible) {
                filterRow.style.display = '';
                isFilterRowVisible = true;
                this.classList.add('active');
                    console.log('æ˜¾ç¤ºç­›é€‰è¡Œ');

                // èšç„¦å½“å‰åˆ—çš„è¾“å…¥æ¡†
                const input = document.querySelector(`.filter-input[data-field="${field}"]`);
                if (input) {
                    setTimeout(() => input.focus(), 100);
                }
            } else {
                // å¦‚æœå·²ç»æ˜¾ç¤ºï¼Œæ£€æŸ¥æ˜¯å¦æ˜¯åˆ‡æ¢å…¶ä»–åˆ—çš„ç­›é€‰
                const activeIcon = document.querySelector('.filter-icon.active');

                    // å¦‚æœç‚¹å‡»çš„æ˜¯åŒä¸€åˆ—ï¼Œå¹¶ä¸”æ²¡æœ‰è¾“å…¥å€¼ï¼Œåˆ™éšè—ç­›é€‰è¡Œå¹¶æ¢å¤æ‰€æœ‰å†…å®¹
                const currentInput = document.querySelector(`.filter-input[data-field="${field}"]`);
                if (activeIcon && activeIcon.getAttribute('data-field') === field &&
                    (!currentInput || !currentInput.value.trim())) {
                        
                        // æ¸…é™¤å½“å‰è¾“å…¥æ¡†çš„å€¼
                        if (currentInput) {
                            currentInput.value = '';
                        }
                        
                        // éšè—ç­›é€‰è¡Œ
                    filterRow.style.display = 'none';
                    isFilterRowVisible = false;
                    activeIcon.classList.remove('active');
                        console.log('éšè—ç­›é€‰è¡Œå¹¶æ¸…é™¤ç­›é€‰');
                        
                        // æ¢å¤æ‰€æœ‰é¡¹ç›®æ˜¾ç¤º
                        clearAllFilters();
                } else {
                    // æ¸…é™¤æ‰€æœ‰å›¾æ ‡çš„æ´»åŠ¨çŠ¶æ€
                    filterIcons.forEach(i => {
                        if (i.getAttribute('data-field') !== field &&
                            !document.querySelector(`.filter-input[data-field="${i.getAttribute('data-field')}"]`).value.trim()) {
                            i.classList.remove('active');
                        }
                    });

                    // è®¾ç½®å½“å‰å›¾æ ‡ä¸ºæ´»åŠ¨çŠ¶æ€
                    this.classList.add('active');

                    // èšç„¦å½“å‰åˆ—çš„è¾“å…¥æ¡†
                    if (currentInput) {
                        setTimeout(() => currentInput.focus(), 100);
                    }
                }
            }
        });
    });

    // å¤„ç†ç­›é€‰è¾“å…¥æ¡†çš„è¾“å…¥äº‹ä»¶
        filterInputs.forEach((input, index) => {
            console.log(`ç»‘å®šç­›é€‰è¾“å…¥æ¡† ${index}ï¼Œå­—æ®µ:`, input.getAttribute('data-field'));
            
        input.addEventListener('input', function() {
                console.log('ç­›é€‰è¾“å…¥äº‹ä»¶è§¦å‘ï¼Œå­—æ®µ:', this.getAttribute('data-field'), 'å€¼:', this.value);
                // å®æ—¶ç­›é€‰ï¼Œä¸æäº¤åˆ°æœåŠ¡å™¨
            performColumnFilter();
        });

        input.addEventListener('change', function() {
                console.log('ç­›é€‰changeäº‹ä»¶è§¦å‘ï¼Œå­—æ®µ:', this.getAttribute('data-field'), 'å€¼:', this.value);
                // å½“è¾“å…¥æ¡†å¤±å»ç„¦ç‚¹æ—¶ï¼Œä¹Ÿæ‰§è¡Œç­›é€‰
            performColumnFilter();
        });

        // é˜²æ­¢ç­›é€‰è¾“å…¥æ¡†çš„ç‚¹å‡»äº‹ä»¶å†’æ³¡ï¼Œé¿å…å½±å“ç­›é€‰è¡Œçš„æ˜¾ç¤º
        input.addEventListener('click', function(e) {
            e.stopPropagation();
        });

        input.addEventListener('keydown', function(e) {
            // æŒ‰ESCé”®æ¸…é™¤ç­›é€‰æ¡ä»¶
            if (e.key === 'Escape') {
                this.value = '';
                performColumnFilter();

                // æ£€æŸ¥æ˜¯å¦æ‰€æœ‰ç­›é€‰éƒ½ä¸ºç©ºï¼Œå¦‚æœæ˜¯åˆ™éšè—ç­›é€‰è¡Œ
                let allEmpty = true;
                filterInputs.forEach(inp => {
                    if (inp.value.trim()) allEmpty = false;
                });

                if (allEmpty) {
                    filterRow.style.display = 'none';
                    isFilterRowVisible = false;

                    // ç§»é™¤æ‰€æœ‰å›¾æ ‡çš„æ´»åŠ¨çŠ¶æ€
                    filterIcons.forEach(icon => icon.classList.remove('active'));
                        
                        // æ¢å¤æ‰€æœ‰é¡¹ç›®æ˜¾ç¤º
                        clearAllFilters();
                }
            }

                // æŒ‰å›è½¦é”®æ—¶ä»…åº”ç”¨ç­›é€‰ï¼Œä¸å‘æœåŠ¡å™¨æäº¤ï¼ˆé¿å…500é”™è¯¯ï¼‰
            if (e.key === 'Enter') {
                    e.preventDefault(); // é˜»æ­¢é»˜è®¤çš„è¡¨å•æäº¤è¡Œä¸º
                    performColumnFilter(); // åªæ‰§è¡Œå®¢æˆ·ç«¯ç­›é€‰
            }
        });
    });

        // æ·»åŠ ç‚¹å‡»å…¶ä»–åŒºåŸŸéšè—ç­›é€‰è¡Œçš„åŠŸèƒ½
        document.addEventListener('click', function(e) {
            // å¦‚æœç‚¹å‡»çš„ä¸æ˜¯ç­›é€‰ç›¸å…³å…ƒç´ ï¼Œåˆ™éšè—ç­›é€‰è¡Œ
            if (isFilterRowVisible &&
                !e.target.closest('.filter-row') &&
                !e.target.closest('.filter-icon')) {

                // æ£€æŸ¥æ˜¯å¦æœ‰ä»»ä½•ç­›é€‰æ¡ä»¶
                let hasActiveFilters = false;
                filterInputs.forEach(input => {
                    if (input.value.trim()) {
                        hasActiveFilters = true;
                        // ä¿æŒå¯¹åº”ç­›é€‰å›¾æ ‡é«˜äº®
                        const field = input.getAttribute('data-field');
                        const icon = document.querySelector(`.filter-icon[data-field="${field}"]`);
                        if (icon) icon.classList.add('active');
                    }
                });

                // å¦‚æœæ²¡æœ‰ç­›é€‰æ¡ä»¶ï¼Œéšè—ç­›é€‰è¡Œå¹¶æ¢å¤æ‰€æœ‰é¡¹ç›®æ˜¾ç¤º
                if (!hasActiveFilters) {
                    filterRow.style.display = 'none';
                    isFilterRowVisible = false;

                    // ç§»é™¤æ‰€æœ‰å›¾æ ‡çš„æ´»åŠ¨çŠ¶æ€
                    filterIcons.forEach(icon => icon.classList.remove('active'));
                    
                    // æ¢å¤æ‰€æœ‰é¡¹ç›®æ˜¾ç¤º
                    clearAllFilters();
                }
            }
        });
        
        console.log('åˆ—ç­›é€‰åŠŸèƒ½åˆå§‹åŒ–å®Œæˆ');
        
    }, 500); // å»¶è¿Ÿ500msç¡®ä¿ä¸»è¦åŠŸèƒ½å…ˆåˆå§‹åŒ–å®Œæˆ
});

// æ¢å¤æ‰€æœ‰é¡¹ç›®æ˜¾ç¤ºçš„å‡½æ•°
function restoreAllItems() {
    console.log('æ¢å¤æ‰€æœ‰é¡¹ç›®æ˜¾ç¤ºï¼ŒåŸå§‹è¡Œæ•°:', originalTableRows.length, 'åŸå§‹å¡ç‰‡æ•°:', originalMobileCards.length);
    
    // å¦‚æœåŸå§‹æ•°æ®æœªä¿å­˜ï¼Œé‡æ–°ä¿å­˜
    if (originalTableRows.length === 0) {
        console.log('åŸå§‹æ•°æ®ä¸ºç©ºï¼Œé‡æ–°ä¿å­˜');
        saveOriginalData();
    }
    
    // æ¢å¤PCç«¯è¡¨æ ¼è¡Œæ˜¾ç¤º
    originalTableRows.forEach(row => {
        row.classList.remove('filtered');
        row.style.display = '';
    });
    
    // æ¢å¤ç§»åŠ¨ç«¯å¡ç‰‡æ˜¾ç¤º
    originalMobileCards.forEach(card => {
        card.classList.remove('filtered');
        card.style.display = '';
    });
}

// æ¸…é™¤æ‰€æœ‰ç­›é€‰æ¡ä»¶çš„å‡½æ•°
function clearAllFilters() {
    console.log('æ¸…é™¤æ‰€æœ‰ç­›é€‰æ¡ä»¶');

    // æ¸…é™¤æ‰€æœ‰ç­›é€‰è¾“å…¥æ¡†çš„å€¼ï¼ˆä¸è§¦å‘inputäº‹ä»¶ï¼‰
    const filterInputs = document.querySelectorAll('.filter-input');
        filterInputs.forEach(input => {
        input.value = '';
    });
    
    // ç§»é™¤æ‰€æœ‰ç­›é€‰å›¾æ ‡çš„æ´»åŠ¨çŠ¶æ€
    const filterIcons = document.querySelectorAll('.filter-icon');
    filterIcons.forEach(icon => {
        icon.classList.remove('active');
        });

    // æ¢å¤æ‰€æœ‰é¡¹ç›®æ˜¾ç¤º
    restoreAllItems();
    }

    // æ‰§è¡Œåˆ—ç­›é€‰
    function performColumnFilter() {
    console.log('å¼€å§‹æ‰§è¡Œåˆ—ç­›é€‰');
    
    // å¦‚æœåŸå§‹æ•°æ®æœªä¿å­˜ï¼Œé‡æ–°ä¿å­˜
    if (originalTableRows.length === 0) {
        console.log('åŸå§‹æ•°æ®ä¸ºç©ºï¼Œé‡æ–°ä¿å­˜');
        saveOriginalData();
    }
    
    console.log('å½“å‰åŸå§‹æ•°æ®è¡Œæ•°:', originalTableRows.length, 'å¡ç‰‡æ•°:', originalMobileCards.length);
    
        const tableBody = document.querySelector('.table tbody');
    const mobileContainer = document.querySelector('.d-block.d-lg-none');
    const filterInputs = document.querySelectorAll('.filter-input');

        // æ”¶é›†æ‰€æœ‰ç­›é€‰æ¡ä»¶
        const filters = {};
        filterInputs.forEach(input => {
            const field = input.getAttribute('data-field');
            const value = input.value.trim().toLowerCase();
            if (value) {
                filters[field] = value;
            console.log('æ·»åŠ ç­›é€‰æ¡ä»¶:', field, '=', value);
            }
        });
        
    console.log('ç­›é€‰æ¡ä»¶æ•°é‡:', Object.keys(filters).length);
    
    // å¦‚æœæ²¡æœ‰ç­›é€‰æ¡ä»¶ï¼Œæ¢å¤æ‰€æœ‰é¡¹ç›®æ˜¾ç¤º
    if (Object.keys(filters).length === 0) {
        console.log('æ— ç­›é€‰æ¡ä»¶ï¼Œæ¢å¤æ‰€æœ‰é¡¹ç›®æ˜¾ç¤º');
        restoreAllItems();
        return;
    }
    
    // ç­›é€‰PCç«¯è¡¨æ ¼è¡Œ
    let visibleRowCount = 0;
    console.log('å¼€å§‹ç­›é€‰è¡¨æ ¼è¡Œï¼Œæ€»è¡Œæ•°:', originalTableRows.length);

    originalTableRows.forEach((row, index) => {
            let showRow = true;

            // æ£€æŸ¥æ¯ä¸ªç­›é€‰æ¡ä»¶
            for (const [field, filterValue] of Object.entries(filters)) {
                const columnIndex = getColumnIndexByField(field);
                if (columnIndex !== -1) {
                    const cell = row.cells[columnIndex];
                    if (cell) {
                        const cellValue = cell.textContent.toLowerCase();

                        // æ—¥æœŸå­—æ®µç‰¹æ®Šå¤„ç†
                        if (field === 'report_time' || field === 'delivery_forecast' ||
                            field === 'created_at' || field === 'updated_at') {

                            // æ¯”è¾ƒæ—¥æœŸï¼ˆYYYY-MM-DDæ ¼å¼ï¼‰
                            const cellDate = cellValue.match(/\d{4}-\d{2}-\d{2}/);

                            if (cellDate && cellDate[0] !== filterValue) {
                                showRow = false;
                                break;
                            } else if (!cellDate && filterValue) {
                                showRow = false;
                                break;
                            }
                        }
                        // æ•°å­—å­—æ®µç‰¹æ®Šå¤„ç†
                        else if (field === 'quotation_customer') {
                            // ç§»é™¤é€—å·åæ¯”è¾ƒæ•°å­—
                            const numericCellValue = cellValue.replace(/,/g, '');
                            if (!numericCellValue.includes(filterValue)) {
                                showRow = false;
                                break;
                            }
                        }
                        // æ™®é€šæ–‡æœ¬å­—æ®µ
                        else if (!cellValue.includes(filterValue)) {
                            showRow = false;
                            break;
                        }
                    }
            } else {
                console.log('æ— æ³•æ‰¾åˆ°å­—æ®µå¯¹åº”çš„åˆ—ç´¢å¼•:', field);
                }
            }

        // è®¾ç½®è¡Œçš„å¯è§æ€§
            if (showRow) {
            row.style.display = '';
                row.classList.remove('filtered');
            visibleRowCount++;
            } else {
            row.style.display = 'none';
                row.classList.add('filtered');
            }
        });

    // ç­›é€‰ç§»åŠ¨ç«¯å¡ç‰‡
    let visibleCardCount = 0;
    console.log('å¼€å§‹ç­›é€‰ç§»åŠ¨ç«¯å¡ç‰‡ï¼Œæ€»å¡ç‰‡æ•°:', originalMobileCards.length);
    
    originalMobileCards.forEach((card, index) => {
        let showCard = true;
        const cardText = card.textContent.toLowerCase();

        // æ£€æŸ¥æ¯ä¸ªç­›é€‰æ¡ä»¶ï¼ˆç§»åŠ¨ç«¯ä½¿ç”¨ç®€å•çš„æ–‡æœ¬åŒ¹é…ï¼‰
        for (const [field, filterValue] of Object.entries(filters)) {
            if (!cardText.includes(filterValue)) {
                showCard = false;
                break;
            }
        }

        // è®¾ç½®å¡ç‰‡çš„å¯è§æ€§
        if (showCard) {
            card.style.display = '';
            card.classList.remove('filtered');
            visibleCardCount++;
        } else {
            card.style.display = 'none';
            card.classList.add('filtered');
            }
    });

    console.log('ç­›é€‰å®Œæˆï¼Œå¯è§è¡Œæ•°:', visibleRowCount, 'å¯è§å¡ç‰‡æ•°:', visibleCardCount);

    // ç¡®ä¿æ‰€æœ‰åŸå§‹æ•°æ®éƒ½åœ¨DOMä¸­
    if (tableBody) {
        originalTableRows.forEach(row => {
            if (!tableBody.contains(row)) {
                tableBody.appendChild(row);
            }
        });
    }
    
    if (mobileContainer) {
        originalMobileCards.forEach(card => {
            if (!mobileContainer.contains(card)) {
                mobileContainer.appendChild(card);
            }
            });
        }

        // é«˜äº®æ´»åŠ¨çš„ç­›é€‰å›¾æ ‡
    const filterIcons = document.querySelectorAll('.filter-icon');
        filterIcons.forEach(icon => {
            const field = icon.getAttribute('data-field');
            const input = document.querySelector(`.filter-input[data-field="${field}"]`);

            if (input && input.value.trim()) {
                icon.classList.add('active');
            } else {
                icon.classList.remove('active');
            }
        });
        
        // æ›´æ–°æŒ‰é’®çŠ¶æ€
        if (typeof updateClearButtonState === 'function') {
            setTimeout(updateClearButtonState, 0);
        }
    }

    // æ ¹æ®å­—æ®µåè·å–åˆ—ç´¢å¼•
    function getColumnIndexByField(field) {
        // è®¡ç®—åˆ—åç§»é‡ï¼Œè€ƒè™‘åˆ°å¤é€‰æ¡†åˆ—
        const hasCheckbox = document.querySelector('th .form-check') !== null;
        const offset = hasCheckbox ? 1 : 0;

        // è·å–è¡¨å¤´å’Œå­—æ®µçš„æ˜ å°„å…³ç³»
        const thElements = document.querySelectorAll('th[data-sort]');
        for (let i = 0; i < thElements.length; i++) {
            if (thElements[i].getAttribute('data-sort') === field) {
                return i + offset;
            }
        }
        return -1;
    }

// æ·»åŠ æ’åºåŠŸèƒ½
    // æ’åºçŠ¶æ€å˜é‡
    let sortBy = 'id';  // é»˜è®¤æŒ‰IDæ’åº
    let sortOrder = 'desc';  // é»˜è®¤é™åº

    // è¡¨å¤´æ’åºç‚¹å‡»äº‹ä»¶
    document.querySelectorAll('.sort-icon').forEach(icon => {
        icon.addEventListener('click', function(e) {
            e.stopPropagation(); // é˜»æ­¢äº‹ä»¶å†’æ³¡

            const clickedSortBy = this.getAttribute('data-sort');

            // åˆ‡æ¢æ’åºæ–¹å‘æˆ–è®¾ç½®æ–°çš„æ’åºå­—æ®µ
            if (sortBy === clickedSortBy) {
                // åˆ‡æ¢æ’åºæ–¹å‘
                sortOrder = sortOrder === 'asc' ? 'desc' : 'asc';
            } else {
                // æ–°çš„æ’åºå­—æ®µï¼Œé»˜è®¤é™åº
                sortBy = clickedSortBy;
                sortOrder = 'desc';
            }

            // æ›´æ–°æ’åºå›¾æ ‡
            updateSortIcons();

            // é‡æ–°åŠ è½½é¡µé¢ï¼Œå¸¦ä¸Šæ’åºå‚æ•°
            const urlParams = new URLSearchParams(window.location.search);
            const searchParam = urlParams.get('search');

            let newUrl = window.location.pathname + '?sort=' + sortBy + '&order=' + sortOrder;
            if (searchParam) {
                newUrl += '&search=' + encodeURIComponent(searchParam);
            }

            // æ”¶é›†æ‰€æœ‰ç­›é€‰å‚æ•°
            const filterInputs = document.querySelectorAll('.filter-input');
            const activeFilters = {};
            filterInputs.forEach(input => {
                const value = input.value.trim();
                if (value) {
                    const field = input.getAttribute('data-field');
                    activeFilters[field] = value;
                }
            });

            // æ·»åŠ ç­›é€‰å‚æ•°åˆ°URL
            for (const [field, value] of Object.entries(activeFilters)) {
                newUrl += `&filter_${field}=${encodeURIComponent(value)}`;
            }

            window.location.href = newUrl;
        });
    });

    // æ›´æ–°æ’åºå›¾æ ‡
    function updateSortIcons() {
        // é‡ç½®æ‰€æœ‰å›¾æ ‡
        document.querySelectorAll('.sort-icon').forEach(icon => {
            icon.className = 'fas fa-sort sort-icon';
            icon.setAttribute('data-sort', icon.getAttribute('data-sort'));
        });

        // è®¾ç½®å½“å‰æ’åºåˆ—çš„å›¾æ ‡
        const currentSortHeader = document.querySelector(`.sort-icon[data-sort="${sortBy}"]`);
        if (currentSortHeader) {
            currentSortHeader.className = sortOrder === 'asc' ? 'fas fa-sort-up sort-icon' : 'fas fa-sort-down sort-icon';
        }
    }

    // åˆå§‹åŒ–æ—¶æ ¹æ®URLå‚æ•°è®¾ç½®æ’åºçŠ¶æ€
    const sortParams = new URLSearchParams(window.location.search);
    if (sortParams.has('sort')) {
        sortBy = sortParams.get('sort');
        if (sortParams.has('order')) {
            sortOrder = sortParams.get('order');
        }
        // æ›´æ–°æ’åºå›¾æ ‡
        updateSortIcons();
    }

    // åˆå§‹åŒ–ç­›é€‰å­—æ®µ
    for (const [key, value] of sortParams.entries()) {
        if (key.startsWith('filter_')) {
            const field = key.substring(7);  // ç§»é™¤ 'filter_' å‰ç¼€
            const input = document.querySelector(`.filter-input[data-field="${field}"]`);
            if (input) {
                input.value = value;

                // æ˜¾ç¤ºç­›é€‰è¡Œ
                document.querySelector('.filter-row').style.display = '';

                // é«˜äº®ç­›é€‰å›¾æ ‡
                const icon = document.querySelector(`.filter-icon[data-field="${field}"]`);
                if (icon) {
                    icon.classList.add('active');
                }
            }
        }
    }

// æ‰¹é‡é€‰æ‹©å’Œåˆ é™¤åŠŸèƒ½
    const selectAllCheckbox = document.getElementById('selectAll');
    const projectCheckboxes = document.querySelectorAll('.project-checkbox');
    const batchDeleteBtn = document.getElementById('batchDeleteBtn');

    if (selectAllCheckbox) {
        // å…¨é€‰/å–æ¶ˆå…¨é€‰
        selectAllCheckbox.addEventListener('change', function() {
            const isChecked = this.checked;

            projectCheckboxes.forEach(checkbox => {
                if (!checkbox.disabled) {
                    checkbox.checked = isChecked;
                }
            });

            updateBatchDeleteButton();
        });
    }

    // å•ä¸ªå¤é€‰æ¡†çŠ¶æ€å˜åŒ–
    projectCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            updateBatchDeleteButton();

            // æ›´æ–°å…¨é€‰æ¡†çŠ¶æ€
            if (selectAllCheckbox) {
                const enabledCheckboxes = Array.from(projectCheckboxes).filter(cb => !cb.disabled);
                const allChecked = enabledCheckboxes.every(cb => cb.checked);
                selectAllCheckbox.checked = allChecked && enabledCheckboxes.length > 0;
            }
        });
    });

    // æ‰¹é‡åˆ é™¤æŒ‰é’®ç‚¹å‡»äº‹ä»¶
    if (batchDeleteBtn) {
        batchDeleteBtn.addEventListener('click', function() {
            const selectedIds = Array.from(projectCheckboxes)
                .filter(checkbox => checkbox.checked)
                .map(checkbox => parseInt(checkbox.value));

            if (selectedIds.length === 0) {
                alert('è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªé¡¹ç›®');
                return;
            }

            if (confirm(`ç¡®å®šè¦åˆ é™¤å·²é€‰ä¸­çš„ ${selectedIds.length} ä¸ªé¡¹ç›®å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼`)) {
                // å‘é€æ‰¹é‡åˆ é™¤è¯·æ±‚
                fetch('/project/api/batch-delete', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest',
                        'X-CSRFToken': 'ImMyYzcyOTkxMDhjYTY2NDhiYjE1NjQxYWFkMzViYjI3YjAzNDQwMTci.aEZIFg._o0f2LiUOUFgknXyMyvzDwrr9S4'
                    },
                    body: JSON.stringify({
                        project_ids: selectedIds
                    })
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('è¯·æ±‚å¤±è´¥ï¼ŒçŠ¶æ€ç : ' + response.status);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        alert(data.message);
                        window.location.reload();
                    } else {
                        alert('åˆ é™¤å¤±è´¥: ' + data.message);
                        console.error('åˆ é™¤å¤±è´¥è¯¦æƒ…:', data.failure_reasons);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('æ“ä½œå¤±è´¥ï¼Œè¯·é‡è¯•: ' + error.message);
                });
            }
        });
    }

    // æ›´æ–°æ‰¹é‡åˆ é™¤æŒ‰é’®çŠ¶æ€
    function updateBatchDeleteButton() {
        if (batchDeleteBtn) {
            const anyChecked = Array.from(projectCheckboxes).some(checkbox => checkbox.checked);
            batchDeleteBtn.style.display = anyChecked ? 'inline-block' : 'none';
        }
    }

    // åˆå§‹åŒ–æ‰¹é‡åˆ é™¤æŒ‰é’®çŠ¶æ€
    updateBatchDeleteButton();

// æ·»åŠ è¡Œæ»šåŠ¨ç„¦ç‚¹æ•ˆæœ
const tableContainer = document.querySelector('.table-responsive');
if (tableContainer) {
    const rows = document.querySelectorAll('.table tbody tr');
    let lastHighlightedRow = null;

    // é¼ æ ‡æ»‘è¿‡è¡Œæ—¶æ·»åŠ é«˜äº®
    rows.forEach(row => {
        row.addEventListener('mouseenter', function() {
            if (lastHighlightedRow) {
                lastHighlightedRow.classList.remove('highlight-row');
            }
            this.classList.add('highlight-row');
            lastHighlightedRow = this;
        });
    });

    // é¼ æ ‡ç¦»å¼€è¡¨æ ¼åŒºåŸŸæ—¶ç§»é™¤é«˜äº®
    tableContainer.addEventListener('mouseleave', function() {
        if (lastHighlightedRow) {
            lastHighlightedRow.classList.remove('highlight-row');
            lastHighlightedRow = null;
        }
    });

    // æ»šåŠ¨æ—¶è®¡ç®—å¯è§è¡Œå¹¶é«˜äº®ä¸­å¿ƒè¡Œ
    tableContainer.addEventListener('scroll', function() {
        // èŠ‚æµæ»šåŠ¨äº‹ä»¶å¤„ç†ï¼Œé¿å…æ€§èƒ½é—®é¢˜
        if (window.scrollThrottled) return;
        window.scrollThrottled = true;

        setTimeout(() => {
            highlightCenterRow();
            window.scrollThrottled = false;
        }, 100);
    });

    // é«˜äº®ä¸­å¿ƒè¡Œå‡½æ•°
    function highlightCenterRow() {
        if (rows.length === 0) return;

        const containerRect = tableContainer.getBoundingClientRect();
        const containerMiddle = containerRect.top + containerRect.height / 2;

        let closestRow = null;
        let minDistance = Infinity;

        // æ‰¾å‡ºæœ€é è¿‘ä¸­å¿ƒçš„è¡Œ
        rows.forEach(row => {
            const rowRect = row.getBoundingClientRect();
            const rowMiddle = rowRect.top + rowRect.height / 2;
            const distance = Math.abs(rowMiddle - containerMiddle);

            // åªè€ƒè™‘å¯è§è¡Œ
            if (rowRect.top <= containerRect.bottom &&
                rowRect.bottom >= containerRect.top) {
                if (distance < minDistance) {
                    minDistance = distance;
                    closestRow = row;
                }
            }
        });

        // æ›´æ–°é«˜äº®
        if (closestRow && closestRow !== lastHighlightedRow) {
            if (lastHighlightedRow) {
                lastHighlightedRow.classList.remove('highlight-row');
            }
            closestRow.classList.add('highlight-row');
            lastHighlightedRow = closestRow;
        }
    }
}

// é¡¹ç›®æ‰¹é‡å¯¼å…¥åŠŸèƒ½
document.addEventListener('DOMContentLoaded', function() {
    const importProjectsBtn = document.getElementById('importProjectsBtn');
    const importModal = new bootstrap.Modal(document.getElementById('importProjectModal'));
    const ownerSelect = document.getElementById('ownerSelect');
    const projectExcelFile = document.getElementById('projectExcelFile');
    const parseExcelBtn = document.getElementById('parseExcelBtn');
    const importBtn = document.getElementById('importBtn');
    const previewDiv = document.getElementById('importPreview');
    const fieldMappingDiv = document.getElementById('fieldMapping');
    const conflictsDiv = document.getElementById('importConflicts');
    const progressDiv = document.getElementById('importProgress');
    const resultDiv = document.getElementById('importResult');
    const applyRecommendedActionsBtn = document.getElementById('applyRecommendedActions');
    const keepAllConflictsBtn = document.getElementById('keepAllConflicts');
    const ignoreAllConflictsBtn = document.getElementById('ignoreAllConflicts');

    let parsedData = [];
    let conflicts = [];
    let conflictActions = {};
    let fieldMapping = {};
    let userNameToId = {}; // æ–°å¢ï¼šé”€å”®è´Ÿè´£äººå§“ååˆ°IDçš„æ˜ å°„
    let unmatchedProjects = []; // æ–°å¢ï¼šæœªåŒ¹é…åˆ°é”€å”®è´Ÿè´£äººçš„é¡¹ç›®

    // æ‰“å¼€å¯¼å…¥æ¨¡æ€æ¡†
    if (importProjectsBtn) {
        importProjectsBtn.addEventListener('click', function(e) {
            e.preventDefault();

            // é‡ç½®çŠ¶æ€
            document.getElementById('importProjectForm').reset();
            previewDiv.style.display = 'none';
            fieldMappingDiv.style.display = 'none';
            conflictsDiv.style.display = 'none';
            progressDiv.style.display = 'none';
            resultDiv.style.display = 'none';
            document.getElementById('importErrorDetails').style.display = 'none';
            importBtn.style.display = 'none';
            parsedData = [];
            conflicts = [];
            conflictActions = {};
            fieldMapping = {};
            userNameToId = {};
            unmatchedProjects = [];

            // åŠ è½½ç”¨æˆ·åˆ—è¡¨
            fetch('/api/users/hierarchical')
                .then(response => response.json())
                .then(data => {
                    ownerSelect.innerHTML = '<option value="">è¯·é€‰æ‹©...</option>';

                    if (data.success) {
                        // ç”ŸæˆåµŒå¥—çš„é€‰æ‹©æ¡†é€‰é¡¹
                        data.data.forEach(company => {
                            const companyOptgroup = document.createElement('optgroup');
                            companyOptgroup.label = company.name + ' (ä¼ä¸š)';

                            company.users.forEach(user => {
                                const option = document.createElement('option');
                                option.value = user.id;
                                option.textContent = user.name;
                                companyOptgroup.appendChild(option);
                                // æ„å»ºå§“ååˆ°IDæ˜ å°„
                                userNameToId[user.name] = user.id;
                            });

                            ownerSelect.appendChild(companyOptgroup);
                        });
                    }
                })
                .catch(error => {
                    console.error('è·å–ç”¨æˆ·åˆ—è¡¨å¤±è´¥:', error);
                });

            // æ˜¾ç¤ºæ¨¡æ€æ¡†
            importModal.show();
        });
    }

    // è§£æExcelæ–‡ä»¶
    if (parseExcelBtn) {
        parseExcelBtn.addEventListener('click', function() {
            const fileInput = document.getElementById('projectExcelFile');
            const ownerIdSelect = document.getElementById('ownerSelect');

            /* ç§»é™¤å¿…é€‰éªŒè¯
            if (!ownerIdSelect.value) {
                alert('è¯·é€‰æ‹©å½’å±è´¦æˆ·');
                return;
            }
            */

            if (!fileInput.files.length) {
                alert('è¯·é€‰æ‹©Excelæ–‡ä»¶');
                return;
            }

            const file = fileInput.files[0];
            const reader = new FileReader();

            resultDiv.style.display = 'none';
            progressDiv.style.display = 'block';
            const progressBar = progressDiv.querySelector('.progress-bar');
            progressBar.style.width = '30%';

            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {type: 'array', cellDates: true, dateNF: 'yyyy-mm-dd'});

                    // è·å–ç¬¬ä¸€ä¸ªå·¥ä½œè¡¨
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];

                    // è½¬æ¢ä¸ºJSON
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, {
                        header: 1,
                        raw: false,
                        dateNF: 'YYYY-MM-DD'
                    });

                    if (jsonData.length <= 1) {
                        alert('å·¥ä½œè¡¨ä¸­æœªæ‰¾åˆ°è¶³å¤Ÿçš„æ•°æ®ï¼Œè¯·ç¡®ä¿è‡³å°‘æœ‰æ ‡é¢˜è¡Œå’Œä¸€è¡Œæ•°æ®');
                        progressDiv.style.display = 'none';
                        return;
                    }

                    // è·å–è¡¨å¤´
                    const headers = jsonData[0];

                    // å®šä¹‰æ•°æ®åº“å­—æ®µæ˜ å°„
                    const dbFields = {
                        "é¡¹ç›®åç§°": "project_name",
                        "æŠ¥å¤‡æ—¶é—´": "report_time",
                        "é¡¹ç›®åˆ†ç±»": "project_type",
                        "æŠ¥å¤‡æ¥æº": "report_source",
                        "å“ç‰Œæƒ…å†µ": "product_situation",
                        "ç”¨æˆ·": "end_user",
                        "è®¾è®¡é™¢åŠé¡¾é—®": "design_issues",
                        "ç»é”€å•†": "dealer",
                        "æ€»æ‰¿åŒ…å•†": "contractor",
                        "ç³»ç»Ÿé›†æˆå•†": "system_integrator",
                        "é˜¶æ®µçŠ¶æ€": "current_stage",
                        "é¡¹ç›®è·Ÿè¿›è®°å½•": "stage_description",
                        "æˆæƒç¼–å·": "authorization_code",
                        "é¢„æµ‹ç­¾çº¦æ—¶é—´": "delivery_forecast",
                        "æ›´æ–°æ—¶é—´": "updated_at",
                        "é”€å”®è´Ÿè´£äºº": "owner_id"
                    };

                    // å®šä¹‰æ•°æ®åº“å­—æ®µä¸­æ–‡åç§°
                    const dbFieldsChineseNames = {
                        "project_name": "é¡¹ç›®åç§°",
                        "report_time": "æŠ¥å¤‡æ—¶é—´",
                        "created_at": "åˆ›å»ºæ—¥æœŸ",
                        "project_type": "é¡¹ç›®åˆ†ç±»",
                        "report_source": "æŠ¥å¤‡æ¥æº",
                        "product_situation": "å“ç‰Œæƒ…å†µ",
                        "end_user": "ç”¨æˆ·",
                        "design_issues": "è®¾è®¡é™¢åŠé¡¾é—®",
                        "dealer": "ç»é”€å•†",
                        "contractor": "æ€»æ‰¿åŒ…å•†",
                        "system_integrator": "ç³»ç»Ÿé›†æˆå•†",
                        "current_stage": "é˜¶æ®µçŠ¶æ€",
                        "stage_description": "é¡¹ç›®è·Ÿè¿›è®°å½•",
                        "authorization_code": "æˆæƒç¼–å·",
                        "delivery_forecast": "é¢„æµ‹ç­¾çº¦æ—¶é—´",
                        "updated_at": "æ›´æ–°æ—¶é—´",
                        "owner_id": "é”€å”®è´Ÿè´£äºº"
                    };

                    // è‡ªåŠ¨æ˜ å°„å­—æ®µ
                    fieldMapping = {};
                    headers.forEach(header => {
                        const matchedField = dbFields[header] || '';
                        if (matchedField) {
                            fieldMapping[header] = matchedField;
                        }
                    });

                    // è½¬æ¢ä¸ºå¯¹è±¡æ•°ç»„
                    parsedData = [];
                    unmatchedProjects = [];
                    for (let i = 1; i < jsonData.length; i++) {
                        const rowData = {};
                        let rowIsEmpty = true;

                        headers.forEach((header, index) => {
                            const value = jsonData[i][index];
                            if (value !== undefined && value !== null && value !== '') {
                                rowData[header] = value;
                                rowIsEmpty = false;
                            }
                        });

                        // åªæ·»åŠ éç©ºè¡Œ
                        if (!rowIsEmpty) {
                            // æ–°å¢ï¼šé”€å”®è´Ÿè´£äººæ¯”å¯¹é€»è¾‘
                            const selectedOwnerId = ownerIdSelect.value;
                            const ownerHeader = Object.keys(fieldMapping).find(h => fieldMapping[h] === 'owner_id');
                            let ownerName = ownerHeader ? rowData[ownerHeader] : '';
                            if (!selectedOwnerId) {
                                if (ownerName && userNameToId[ownerName]) {
                                    rowData[ownerHeader] = ownerName; // ä¿ç•™åŸå§‹å
                                    rowData['owner_id'] = userNameToId[ownerName];
                            parsedData.push(rowData);
                                } else {
                                    unmatchedProjects.push(rowData['é¡¹ç›®åç§°'] || rowData['project_name'] || '(æ— é¡¹ç›®å)');
                                }
                            } else {
                                parsedData.push(rowData);
                            }
                        }
                    }

                    if (parsedData.length === 0) {
                        alert('æœªåœ¨å·¥ä½œè¡¨ä¸­æ‰¾åˆ°æœ‰æ•ˆæ•°æ®');
                        progressDiv.style.display = 'none';
                        return;
                    }

                    // å¤„ç†æˆæƒç¼–å·æ ¼å¼
                    function formatAuthCode(code) {
                        if (code && typeof code === 'string' && code.startsWith('HY-')) {
                            return code.substring(3);
                        }
                        return code;
                    }

                    // é¢„è§ˆè¡¨å¤´
                    const previewHeader = document.getElementById('previewHeader');
                    previewHeader.innerHTML = '';

                    // åˆ›å»ºåå‘æ˜ å°„ï¼Œä»æ•°æ®åº“å­—æ®µæ‰¾åˆ°Excelè¡¨å¤´
                    const reverseMapping = {};
                    for (const [excelHeader, dbField] of Object.entries(fieldMapping)) {
                        reverseMapping[dbField] = excelHeader;
                    }

                    // æŒ‡å®šéœ€è¦æ˜¾ç¤ºçš„å­—æ®µåŠå…¶é¡ºåº
                    const orderedFields = [
                        "authorization_code",  // æˆæƒç¼–ç 
                        "project_name",        // é¡¹ç›®åç§°
                        "report_source",       // æŠ¥å¤‡æ¥æº
                        "project_type",        // é¡¹ç›®ç±»å‹
                        "product_situation",   // å“ç‰Œæƒ…å†µ
                        "current_stage",       // å½“å‰é˜¶æ®µ
                        "delivery_forecast",   // å‡ºè´§é¢„æµ‹æ—¥æœŸ
                        "end_user",            // ç›´æ¥ç”¨æˆ·
                        "design_issues",       // è®¾è®¡é™¢åŠé¡¾é—®
                        "contractor",          // æ€»æ‰¿åŒ…å•ä½
                        "system_integrator",   // ç³»ç»Ÿé›†æˆå•†
                        "dealer",              // ç»é”€å•†
                        "stage_description",   // é˜¶æ®µè¯´æ˜
                        "report_time",         // æŠ¥å¤‡æ—¶é—´
                        "created_at",          // åˆ›å»ºæ—¥æœŸ
                        "updated_at",          // æ›´æ–°æ—¥æœŸ
                        "owner_id"             // é”€å”®è´Ÿè´£äºº
                    ];

                    // æ·»åŠ æ•°æ®åº“å­—æ®µä¸­æ–‡åç§°ä½œä¸ºè¡¨å¤´
                    orderedFields.forEach(dbField => {
                        const th = document.createElement('th');
                        const chineseName = dbFieldsChineseNames[dbField] || dbField;
                        th.textContent = chineseName;

                        // å¦‚æœæ˜¯æˆæƒç¼–å·å­—æ®µï¼Œæ·»åŠ æ ¼å¼åŒ–æç¤º
                        if (dbField === 'authorization_code') {
                            th.innerHTML = `${chineseName}<br><small class="text-success">(å°†è‡ªåŠ¨æ ¼å¼åŒ–)</small>`;
                        }

                        previewHeader.appendChild(th);
                    });

                    // æ¸…ç©ºé¢„è§ˆæ•°æ®
                    const previewBody = document.getElementById('previewBody');
                    previewBody.innerHTML = '';

                    // æ˜¾ç¤ºå‰5è¡Œæˆ–æ‰€æœ‰è¡Œï¼ˆå¦‚æœå°‘äº5è¡Œï¼‰
                    const rowsToShow = Math.min(5, parsedData.length);
                    for (let i = 0; i < rowsToShow; i++) {
                        const tr = document.createElement('tr');
                        const rowData = parsedData[i];

                        // æŒ‰æŒ‡å®šçš„å­—æ®µé¡ºåºæ·»åŠ å†…å®¹
                        orderedFields.forEach(dbField => {
                            const td = document.createElement('td');
                            const excelHeader = reverseMapping[dbField];

                            if (dbField === 'authorization_code') {
                                // æˆæƒç¼–å·ä¸“ç”¨é€»è¾‘
                                let rawValue = '';
                            if (excelHeader && rowData[excelHeader] !== undefined) {
                                    rawValue = rowData[excelHeader];
                                }
                                // æ ¼å¼åŒ–
                                const formatted = formatAuthCode(rawValue);
                                td.textContent = formatted || '';
                            } else if (dbField === 'owner_id') {
                                // æ–°å¢ï¼šæ˜¾ç¤ºé”€å”®è´Ÿè´£äººå§“åè€Œä¸æ˜¯ID
                                let id = rowData['owner_id'];
                                let name = '';
                                for (const uname in userNameToId) {
                                    if (userNameToId[uname] === id) {
                                        name = uname;
                                        break;
                                    }
                                }
                                td.textContent = name || id || '';
                            } else if (excelHeader && rowData[excelHeader] !== undefined) {
                                let value = rowData[excelHeader];
                                // æ ¼å¼åŒ–æ—¥æœŸå­—æ®µ
                                if ((dbField === 'report_time' || dbField === 'delivery_forecast' ||
                                     dbField === 'created_at' || dbField === 'updated_at') && value) {
                                    if (typeof value === 'string' && value.match(/^[0-9]+$/)) {
                                        const dateObj = XLSX.SSF.parse_date_code(parseInt(value));
                                        if (dateObj) {
                                            const year = dateObj.y;
                                            const month = dateObj.m.toString().padStart(2, '0');
                                            const day = dateObj.d.toString().padStart(2, '0');
                                            value = `${year}-${month}-${day}`;
                                        }
                                    }
                                }
                                        td.textContent = value;
                            } else if (dbField === 'created_at') {
                                // å¦‚æœæ˜¯åˆ›å»ºæ—¥æœŸå­—æ®µï¼Œä½¿ç”¨æŠ¥å¤‡æ—¶é—´çš„å€¼
                                const reportTimeHeader = reverseMapping['report_time'];
                                if (reportTimeHeader && rowData[reportTimeHeader]) {
                                    let value = rowData[reportTimeHeader];
                                    if (typeof value === 'string' && value.match(/^[0-9]+$/)) {
                                        const dateObj = XLSX.SSF.parse_date_code(parseInt(value));
                                        if (dateObj) {
                                            const year = dateObj.y;
                                            const month = dateObj.m.toString().padStart(2, '0');
                                            const day = dateObj.d.toString().padStart(2, '0');
                                            value = `${year}-${month}-${day}`;
                                        }
                                    }
                                    td.textContent = value;
                                } else {
                                    td.textContent = '';
                                }
                            } else {
                                td.textContent = '';
                            }
                            tr.appendChild(td);
                        });
                        previewBody.appendChild(tr);
                    }

                    previewDiv.style.display = 'block';
                    fieldMappingDiv.style.display = 'block';
                    progressBar.style.width = '70%';

                    // æ£€æŸ¥å†²çª
                    progressBar.style.width = '80%';

                    // åœ¨è¿™é‡Œå‘é€è¯·æ±‚æ£€æŸ¥å†²çªï¼Œæ­¤æ¬¡ç®€åŒ–ä¸ºå‰ç«¯æ¨¡æ‹Ÿ
                    fetch('/api/projects/check-conflicts', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': 'ImMyYzcyOTkxMDhjYTY2NDhiYjE1NjQxYWFkMzViYjI3YjAzNDQwMTci.aEZIFg._o0f2LiUOUFgknXyMyvzDwrr9S4'
                        },
                        body: JSON.stringify({
                            projects: parsedData,
                            field_mapping: fieldMapping
                        })
                    })
                    .then(response => response.json())
                    .then(data => {
                        progressBar.style.width = '100%';

                        if (data.success) {
                            conflicts = data.conflicts || [];

                            // æ˜¾ç¤ºå†²çª
                            if (conflicts.length > 0) {
                                const conflictsBody = document.getElementById('conflictsBody');
                                conflictsBody.innerHTML = '';

                                conflicts.forEach((conflict, index) => {
                                    const tr = document.createElement('tr');

                                    const tdName = document.createElement('td');
                                    tdName.textContent = conflict.project_name;
                                    tr.appendChild(tdName);

                                    const tdCode = document.createElement('td');
                                    tdCode.textContent = conflict.authorization_code || 'æœªæŒ‡å®š';
                                    tr.appendChild(tdCode);

                                    const tdType = document.createElement('td');
                                    tdType.textContent = conflict.conflict_type === 'code' ? 'æˆæƒç¼–å·å†²çª' : 'é¡¹ç›®åç§°ç›¸ä¼¼';
                                    tr.appendChild(tdType);

                                    const tdAction = document.createElement('td');
                                    const actionSelect = document.createElement('select');
                                    actionSelect.classList.add('form-select', 'form-select-sm');
                                    actionSelect.dataset.index = index;

                                    const ignoreOpt = document.createElement('option');
                                    ignoreOpt.value = 'ignore';
                                    ignoreOpt.textContent = 'å¿½ç•¥ä¸å¯¼å…¥';

                                    const newOpt = document.createElement('option');
                                    newOpt.value = 'new';
                                    newOpt.textContent = 'ä½œä¸ºæ–°é¡¹ç›®å¯¼å…¥';

                                    actionSelect.appendChild(ignoreOpt);
                                    actionSelect.appendChild(newOpt);

                                    // æ ¹æ®å†²çªç±»å‹è®¾ç½®é»˜è®¤é€‰æ‹©
                                    if (conflict.conflict_type === 'code') {
                                        // æˆæƒç¼–å·å†²çªé»˜è®¤å¿½ç•¥
                                        ignoreOpt.selected = true;
                                        conflictActions[index] = 'ignore';
                                    } else {
                                        // åç§°ç›¸ä¼¼é»˜è®¤æ–°å»º
                                        newOpt.selected = true;
                                        conflictActions[index] = 'new';
                                    }

                                    actionSelect.addEventListener('change', function() {
                                        conflictActions[this.dataset.index] = this.value;
                                    });

                                    tdAction.appendChild(actionSelect);
                                    tr.appendChild(tdAction);

                                    conflictsBody.appendChild(tr);
                                });

                                conflictsDiv.style.display = 'block';
                            }

                            // æ˜¾ç¤ºå¯¼å…¥æŒ‰é’®
                            importBtn.style.display = 'block';
                        } else {
                            resultDiv.className = 'alert alert-danger mt-3';
                            resultDiv.textContent = data.message || 'æ£€æŸ¥å†²çªæ—¶å‡ºç°é”™è¯¯';
                            resultDiv.style.display = 'block';
                        }

                        progressDiv.style.display = 'none';
                    })
                    .catch(error => {
                        console.error('å†²çªæ£€æŸ¥å‡ºé”™:', error);
                        progressBar.style.width = '100%';
                        progressDiv.style.display = 'none';

                        resultDiv.className = 'alert alert-danger mt-3';
                        resultDiv.textContent = 'è¯·æ±‚æœåŠ¡å™¨æ—¶å‡ºé”™ï¼Œè¯·é‡è¯•';
                        resultDiv.style.display = 'block';
                    });

                } catch (err) {
                    console.error('è§£æExcelå‡ºé”™:', err);

                    resultDiv.className = 'alert alert-danger mt-3';
                    resultDiv.textContent = 'è§£æExcelæ–‡ä»¶å¤±è´¥: ' + err.message;
                    resultDiv.style.display = 'block';

                    progressDiv.style.display = 'none';
                }
            };

            reader.onerror = function() {
                resultDiv.className = 'alert alert-danger mt-3';
                resultDiv.textContent = 'è¯»å–æ–‡ä»¶æ—¶å‡ºé”™';
                resultDiv.style.display = 'block';

                progressDiv.style.display = 'none';
            };

            reader.readAsArrayBuffer(file);
        });
    }

    // å¤„ç†å†²çªæ“ä½œæŒ‰é’®
    if (applyRecommendedActionsBtn) {
        applyRecommendedActionsBtn.addEventListener('click', function() {
            document.querySelectorAll('#conflictsBody select').forEach(select => {
                const index = parseInt(select.dataset.index);
                const conflict = conflicts[index];

                // åº”ç”¨æ™ºèƒ½æ¨è: å¯¹æˆæƒç¼–å·å†²çªå¿½ç•¥ï¼Œå¯¹åç§°ç›¸ä¼¼æ–°å»º
                if (conflict.conflict_type === 'code') {
                    select.value = 'ignore';
                } else {
                    select.value = 'new';
                }

                // æ›´æ–°é€‰æ‹©
                conflictActions[index] = select.value;
            });
        });
    }

    if (keepAllConflictsBtn) {
        keepAllConflictsBtn.addEventListener('click', function() {
            document.querySelectorAll('#conflictsBody select').forEach(select => {
                select.value = 'new';
                conflictActions[select.dataset.index] = 'new';
            });
        });
    }

    if (ignoreAllConflictsBtn) {
        ignoreAllConflictsBtn.addEventListener('click', function() {
            document.querySelectorAll('#conflictsBody select').forEach(select => {
                select.value = 'ignore';
                conflictActions[select.dataset.index] = 'ignore';
            });
        });
    }

    // ç¡®è®¤å¯¼å…¥
    if (importBtn) {
        importBtn.addEventListener('click', function() {
            const ownerId = ownerSelect.value;

            /* ç§»é™¤å¿…é€‰éªŒè¯
            if (!ownerId) {
                alert('è¯·é€‰æ‹©å½’å±è´¦æˆ·');
                return;
            }
            */

            if (parsedData.length === 0) {
                alert('æ²¡æœ‰å¯å¯¼å…¥çš„æ•°æ®');
                return;
            }

            // æ˜¾ç¤ºè¿›åº¦æ¡
            resultDiv.style.display = 'none';
            progressDiv.style.display = 'block';
            const progressBar = progressDiv.querySelector('.progress-bar');
            progressBar.style.width = '0%';

            // ç¦ç”¨å¯¼å…¥æŒ‰é’®ï¼Œé˜²æ­¢é‡å¤æäº¤
            importBtn.disabled = true;

            // å‘é€æ•°æ®åˆ°æœåŠ¡å™¨
            fetch('/api/projects/import', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': 'ImMyYzcyOTkxMDhjYTY2NDhiYjE1NjQxYWFkMzViYjI3YjAzNDQwMTci.aEZIFg._o0f2LiUOUFgknXyMyvzDwrr9S4'
                },
                body: JSON.stringify({
                    owner_id: ownerId,
                    projects: parsedData,
                    conflict_actions: conflictActions,
                    field_mapping: fieldMapping,
                    sync_report_time_to_created_at: true,  // æ·»åŠ æ ‡å¿—ä»¥åŒæ­¥æŠ¥å¤‡æ—¶é—´åˆ°åˆ›å»ºæ—¶é—´
                    use_excel_owner: !ownerId  // å¦‚æœæœªé€‰æ‹©å½’å±è´¦æˆ·ï¼Œåˆ™ä½¿ç”¨Excelä¸­çš„é”€å”®è´Ÿè´£äººå­—æ®µ
                })
            })
            .then(response => response.json())
            .then(data => {
                progressBar.style.width = '100%';

                // æ˜¾ç¤ºç»“æœ
                if (data.success) {
                    resultDiv.className = 'alert alert-success mt-3';
                    resultDiv.innerHTML = `å¯¼å…¥å®Œæˆï¼Œæ–°å¢: ${data.data.imported}ï¼Œè·³è¿‡: ${data.data.skipped}ï¼Œé”™è¯¯: ${data.data.error}`;

                    // å¦‚æœæœ‰é”™è¯¯ï¼Œæ˜¾ç¤ºé”™è¯¯è¯¦æƒ…
                    if (data.data.error > 0 && data.data.error_details && data.data.error_details.length > 0) {
                        const errorDetailsDiv = document.getElementById('importErrorDetails');
                        const errorTableBody = document.getElementById('errorDetailsTableBody');
                        errorTableBody.innerHTML = '';

                        data.data.error_details.forEach(error => {
                            const tr = document.createElement('tr');

                            const tdLine = document.createElement('td');
                            tdLine.textContent = error.line || 'N/A';
                            tr.appendChild(tdLine);

                            const tdName = document.createElement('td');
                            tdName.textContent = error.project_name || 'N/A';
                            tr.appendChild(tdName);

                            const tdReason = document.createElement('td');
                            tdReason.textContent = error.reason || 'æœªçŸ¥é”™è¯¯';
                            tr.appendChild(tdReason);

                            errorTableBody.appendChild(tr);
                        });

                        errorDetailsDiv.style.display = 'block';
                    }

                    // å¦‚æœå¯¼å…¥æˆåŠŸä¸”æ²¡æœ‰é”™è¯¯ï¼Œ1.5ç§’ååˆ·æ–°é¡µé¢
                    if (data.data.error === 0) {
                        setTimeout(() => {
                            window.location.reload();
                        }, 1500);
                    }
                } else {
                    resultDiv.className = 'alert alert-danger mt-3';
                    resultDiv.textContent = data.message || 'å¯¼å…¥å¤±è´¥';
                }

                resultDiv.style.display = 'block';
                progressDiv.style.display = 'none';

                // é‡æ–°å¯ç”¨å¯¼å…¥æŒ‰é’®
                importBtn.disabled = false;

                // æ–°å¢ï¼šå¯¼å…¥ç»“æœåŒºæ˜¾ç¤ºæœªå¯¼å…¥é¡¹ç›®
                const unmatchedDiv = document.getElementById('unmatchedProjectsResult');
                if (unmatchedDiv) {
                    if (unmatchedProjects.length > 0) {
                        unmatchedDiv.style.display = 'block';
                        unmatchedDiv.innerHTML =
                            '<div class="alert alert-warning mt-2">' +
                            '<b>ä»¥ä¸‹é¡¹ç›®å› é”€å”®è´Ÿè´£äººæœªåŒ¹é…åˆ°ç³»ç»Ÿè´¦æˆ·ï¼Œæœªå¯¼å…¥ï¼š</b>' +
                            '<table class="table table-sm table-bordered mt-2"><thead><tr><th>é¡¹ç›®åç§°</th><th>é”€å”®è´Ÿè´£äºº</th></tr></thead><tbody>' +
                            unmatchedProjects.map(n => `<tr><td>${n.project}</td><td>${n.owner}</td></tr>`).join('') +
                            '</tbody></table>' +
                            '<button id="unmatchedConfirmBtnResult" class="btn btn-primary btn-sm mt-2">ç¡®è®¤</button>' +
                            '</div>';
                        setTimeout(() => {
                            const btn = document.getElementById('unmatchedConfirmBtnResult');
                            if (btn) {
                                btn.onclick = function() {
                                    unmatchedDiv.style.display = 'none';
                                };
                            }
                        }, 100);
                    } else {
                        unmatchedDiv.style.display = 'none';
                        unmatchedDiv.innerHTML = '';
                    }
                }
            })
            .catch(error => {
                console.error('å¯¼å…¥å‡ºé”™:', error);

                resultDiv.className = 'alert alert-danger mt-3';
                resultDiv.textContent = 'è¯·æ±‚æœåŠ¡å™¨æ—¶å‡ºé”™ï¼Œè¯·é‡è¯•';
                resultDiv.style.display = 'block';

                progressDiv.style.display = 'none';
                importBtn.disabled = false;
            });
        });
    }
});
</script>

<!-- é¡¹ç›®æ‰¹é‡å¯¼å…¥æ¨¡æ€æ¡† -->
<div class="modal fade" id="importProjectModal" tabindex="-1" aria-labelledby="importProjectModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="importProjectModalLabel">æ‰¹é‡å¯¼å…¥é¡¹ç›®</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="importProjectForm" enctype="multipart/form-data">
                    <div class="mb-3">
                        <label for="ownerSelect" class="form-label">è¯·é€‰æ‹©å½’å±è´¦æˆ·</label>
                        <select class="form-select" id="ownerSelect" name="owner_id">
                            <option value="">ä¸æŒ‡å®š(ä½¿ç”¨Excelä¸­çš„é”€å”®è´Ÿè´£äººå­—æ®µ)</option>
                            <!-- é€‰é¡¹ä¼šé€šè¿‡JavaScriptåŠ¨æ€åŠ è½½ -->
                        </select>
                        <div class="form-text">å¦‚æœä¸é€‰æ‹©ï¼Œå°†ä½¿ç”¨Excelä¸­çš„é”€å”®è´Ÿè´£äººå­—æ®µä½œä¸ºé¡¹ç›®æ‹¥æœ‰è€…</div>
                    </div>

                    <div class="mb-3">
                        <label for="projectExcelFile" class="form-label">ä¸Šä¼ Excelæ–‡ä»¶ (.xlsxæˆ–.xls) <span class="text-danger">*</span></label>
                        <input class="form-control" type="file" id="projectExcelFile" name="projectExcelFile" accept=".xlsx, .xls" required>
                        <div class="form-text">è¯·ä¸Šä¼ åŒ…å«é¡¹ç›®æ•°æ®çš„Excelæ–‡ä»¶</div>
                    </div>

                    <!-- é¢„è§ˆåŒºåŸŸ -->
                    <div id="importPreview" style="display: none;">
                        <h6>æ•°æ®é¢„è§ˆï¼š</h6>
                        <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                            <table class="table table-sm table-bordered table-hover">
                                <thead class="table-light">
                                    <tr id="previewHeader">
                                        <!-- è¡¨å¤´ä¼šåŠ¨æ€ç”Ÿæˆ -->
                                    </tr>
                                </thead>
                                <tbody id="previewBody">
                                    <!-- é¢„è§ˆæ•°æ®ä¼šåŠ¨æ€ç”Ÿæˆ -->
                                </tbody>
                            </table>
                        </div>
                        <div id="unmatchedProjects" style="display:none;"></div>
                    </div>

                    <!-- å­—æ®µæ˜ å°„åŒºåŸŸ -->
                    <div id="fieldMapping" style="display: none;">
                        <div class="alert alert-info mt-3">
                            <small>ç³»ç»Ÿå·²è‡ªåŠ¨åŒ¹é…Excelåˆ—ä¸æ•°æ®åº“å­—æ®µï¼Œé¢„è§ˆæ˜¾ç¤ºäº†æ˜ å°„åçš„æ•°æ®</small>
                        </div>
                    </div>

                    <!-- å†²çªæ£€æµ‹åŒºåŸŸ -->
                    <div id="importConflicts" style="display: none;">
                        <h6 class="mt-3">æ£€æµ‹åˆ°å¯èƒ½çš„å†²çªï¼š</h6>
                        <div class="table-responsive" style="max-height: 300px; overflow-y: auto;">
                            <table class="table table-sm table-bordered table-hover">
                                <thead class="table-light">
                                    <tr>
                                        <th>é¡¹ç›®åç§°</th>
                                        <th>æˆæƒç¼–å·</th>
                                        <th>å†²çªç±»å‹</th>
                                        <th>æ“ä½œ</th>
                                    </tr>
                                </thead>
                                <tbody id="conflictsBody">
                                    <!-- å†²çªæ•°æ®ä¼šåŠ¨æ€ç”Ÿæˆ -->
                                </tbody>
                            </table>
                        </div>

                        <div class="d-flex flex-wrap justify-content-between align-items-center mt-3">
                            <div class="mb-2">
                                <span class="text-muted">æ‰¹é‡æ“ä½œ:</span>
                            </div>
                            <div class="mb-2">
                                <button type="button" class="btn btn-outline-primary btn-sm me-2" id="applyRecommendedActions">
                                    <i class="fas fa-magic"></i> åº”ç”¨æ™ºèƒ½æ¨è
                                </button>
                                <button type="button" class="btn btn-outline-success btn-sm me-2" id="keepAllConflicts">
                                    <i class="fas fa-plus"></i> å…¨éƒ¨å¯¼å…¥ä¸ºæ–°é¡¹ç›®
                                </button>
                                <button type="button" class="btn btn-outline-secondary btn-sm" id="ignoreAllConflicts">
                                    <i class="fas fa-times"></i> å…¨éƒ¨å¿½ç•¥ä¸å¯¼å…¥
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- è¿›åº¦æ¡ -->
                    <div id="importProgress" class="progress mt-3" style="display: none;">
                        <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%"></div>
                    </div>

                    <!-- å¯¼å…¥ç»“æœ -->
                    <div id="importResult" class="alert mt-3" style="display: none;"></div>
                    <div id="unmatchedProjectsResult" style="display:none;"></div>

                    <!-- é”™è¯¯è¯¦æƒ…åŒºåŸŸ -->
                    <div id="importErrorDetails" class="mt-3" style="display: none;">
                        <h6 class="text-danger">å¯¼å…¥é”™è¯¯è¯¦æƒ…:</h6>
                        <div class="table-responsive" style="max-height: 300px; overflow-y: auto;">
                            <table class="table table-sm table-bordered table-hover">
                                <thead class="table-light">
                                    <tr>
                                        <th>è¡Œå·</th>
                                        <th>é¡¹ç›®åç§°</th>
                                        <th>é”™è¯¯åŸå› </th>
                                    </tr>
                                </thead>
                                <tbody id="errorDetailsTableBody">
                                    <!-- é”™è¯¯è¯¦æƒ…ä¼šåŠ¨æ€åŠ è½½ -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                <button type="button" class="btn btn-primary" id="parseExcelBtn">è§£ææ–‡ä»¶</button>
                <button type="button" class="btn btn-success" id="importBtn" style="display: none;">ç¡®è®¤å¯¼å…¥</button>
            </div>
        </div>
    </div>
</div>


    </main>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // ç”¨æˆ·ä¸‹æ‹‰èœå•äº¤äº’
        document.addEventListener('DOMContentLoaded', function() {
            const userDropdown = document.getElementById('userDropdown');
            const userDropdownMenu = document.getElementById('userDropdownMenu');

            if(userDropdown && userDropdownMenu) {
                userDropdown.addEventListener('click', function(e) {
                    e.stopPropagation();
                    userDropdownMenu.classList.toggle('show');
                });

                // ç‚¹å‡»å…¶ä»–åŒºåŸŸå…³é—­ä¸‹æ‹‰èœå•
                document.addEventListener('click', function() {
                    userDropdownMenu.classList.remove('show');
                });

                // é˜²æ­¢ç‚¹å‡»èœå•å†…éƒ¨æ—¶å…³é—­èœå•
                userDropdownMenu.addEventListener('click', function(e) {
                    e.stopPropagation();
                });
            }
            
            // å¤„ç†å¤šçº§ä¸‹æ‹‰èœå•
            const dropdownItems = document.querySelectorAll('.dropdown-item.dropdown-toggle');
            dropdownItems.forEach(item => {
                item.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    // æ‰¾åˆ°ä¸‹ä¸€çº§èœå•
                    const submenu = this.nextElementSibling;
                    if (submenu && submenu.classList.contains('dropdown-menu')) {
                        submenu.classList.toggle('show');
                    }
                });
            });
            
            // ç‚¹å‡»å…¶ä»–åŒºåŸŸå…³é—­æ‰€æœ‰å­èœå•
            document.addEventListener('click', function() {
                const submenus = document.querySelectorAll('.dropdown-submenu.show');
                submenus.forEach(menu => menu.classList.remove('show'));
            });

            // è®¾ç½®AJAXè¯·æ±‚çš„CSRFä»¤ç‰Œ
            const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');

            // ä¸ºæ‰€æœ‰AJAXè¯·æ±‚æ·»åŠ CSRFä»¤ç‰Œ
            $(document).ajaxSend(function(e, xhr, options) {
                xhr.setRequestHeader("X-CSRFToken", csrfToken);
            });

            // ä¸ºfetchè¯·æ±‚å‡†å¤‡CSRFå¤´
            window.fetchWithCsrf = function(url, options = {}) {
                options.headers = options.headers || {};
                options.headers['X-CSRFToken'] = csrfToken;
                return fetch(url, options);
            };
        });

        // è¡¨å¤´ä¸‹æ‹‰ç­›é€‰äº¤äº’è„šæœ¬
        function toggleAll(allCheckbox, field) {
            const options = document.querySelectorAll(`#${field}_options input[type="checkbox"]`);
            options.forEach(cb => cb.checked = allCheckbox.checked);
        }

        function filterOptions(input) {
            const value = input.value.toLowerCase();
            const container = input.closest('.dropdown-menu').querySelector('.filter-options');
            const items = container.querySelectorAll('.form-check');
            items.forEach(item => {
                const label = item.querySelector('label');
                const text = label.textContent.toLowerCase();
                item.style.display = text.includes(value) ? '' : 'none';
            });
        }
    </script>
    
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/echarts@5.4.2/dist/echarts.min.js"></script>
<!-- å¼•ç”¨è´¦æˆ·åˆ‡æ¢åŠŸèƒ½æ¨¡å— -->
<script src="/static/js/project_statistics_account.js"></script>
<!-- å¼•ç”¨é¡¹ç›®åˆ—è¡¨è´¦æˆ·åŒæ­¥æ¨¡å— -->
<script src="/static/js/project_list_account.js"></script>
<script src="/static/js/project_statistics.js"></script>

</body>
</html>