{% extends "base.html" %}
{% from "macros/ui_helpers.html" import render_button %}

{% block head %}
{{ super() }}
<!-- é˜²æ­¢æµè§ˆå™¨ç¼“å­˜CSSå’ŒJS -->
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">
<link rel="stylesheet" href="https://code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css">
<style>
/* åˆ›å»ºè®¢å•é¡µé¢ä¸»å®¹å™¨é¡¶éƒ¨ç•™ç™½ï¼Œé¿å…è¢«fixedå¯¼èˆªé®æŒ¡ */
.container.page-with-fixed-nav {
    margin-top: 72px !important;
}
@media (max-width: 991.98px) {
    .container.page-with-fixed-nav {
        margin-top: 120px !important;
    }
}

/* ç¦ç”¨ç³»ç»Ÿé»˜è®¤çš„è‡ªåŠ¨å®ŒæˆåŠŸèƒ½ */
input.product-name {
    -webkit-appearance: none !important;
    -moz-appearance: none !important;
    appearance: none !important;
}

/* éšè—æµè§ˆå™¨é»˜è®¤çš„è‡ªåŠ¨å®Œæˆä¸‹æ‹‰æŒ‰é’® */
input.product-name::-webkit-contacts-auto-fill-button,
input.product-name::-webkit-credentials-auto-fill-button {
    visibility: hidden;
    display: none !important;
    pointer-events: none;
    position: absolute;
    right: 0;
}

/* æ•°é‡è¾“å…¥æ¡†æ ·å¼ */
input[type="number"].quantity {
    min-width: 80px !important;
    width: 80px !important;
    text-align: center !important;
    font-family: 'Roboto Mono', monospace !important;
    letter-spacing: -0.2px !important;
}

/* ä»·æ ¼è¾“å…¥æ¡†æ ·å¼ */
input[type="number"].product-price,
input[type="number"].discounted-price,
input[type="number"].subtotal {
    min-width: 120px;
    text-align: right;
    font-family: 'Roboto Mono', monospace;
    letter-spacing: -0.2px;
}

/* æŠ˜æ‰£ç‡è¾“å…¥æ¡†æ ·å¼ */
input[type="number"].discount-rate {
    min-width: 80px !important;
    width: 80px !important;
    text-align: right !important;
    font-family: 'Roboto Mono', monospace !important;
    letter-spacing: -0.2px !important;
}

/* äº§å“åç§°è¾“å…¥æ¡†å®¹å™¨æ ·å¼ */
.product-name-container {
    position: relative;
    width: 100%;
}

/* äº§å“åç§°è¾“å…¥æ¡†æ ·å¼ */
.product-name {
    width: 100% !important;
    border-radius: 4px !important;
    border: 1px solid #ced4da !important;
    background-color: #fff !important;
    padding: 0.375rem 2rem 0.375rem 0.75rem !important;
    line-height: 1.5 !important;
    appearance: none !important;
    -webkit-appearance: none !important;
    -moz-appearance: none !important;
}

/* ä¸‹æ‹‰ç®­å¤´æ ·å¼ */
.product-name-container::after {
    content: 'â–¼';
    position: absolute;
    right: 10px;
    top: 50%;
    transform: translateY(-50%);
    font-size: 12px;
    color: #666;
    pointer-events: none;
}

.product-name:focus {
    background-color: #fff !important;
    border-color: #80bdff !important;
    outline: 0;
    box-shadow: 0 0 0 0.2rem rgba(0,123,255,.25);
}

/* äº§å“é€‰æ‹©èœå•æ ·å¼ */
.product-menu-container {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    z-index: 1000;
    background: white;
    border: 1px solid #ddd;
    border-radius: 4px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    max-height: 400px;
    overflow: hidden;
    min-width: 800px; /* ç¡®ä¿èœå•æœ‰è¶³å¤Ÿå®½åº¦ */
}

.product-menu-content {
    display: flex;
    height: 400px;
}

.menu-column {
    flex: 1;
    border-right: 1px solid #eee;
    overflow-y: auto;
    min-width: 200px; /* æ¯åˆ—æœ€å°å®½åº¦ï¼Œç¡®ä¿12ä¸ªä¸­æ–‡å­—ç¬¦å®½åº¦ */
}

.menu-column:last-child {
    border-right: none;
}

.menu-item {
    padding: 8px 12px;
    cursor: pointer;
    border-bottom: 1px solid #f5f5f5;
    font-size: 14px;
    white-space: normal; /* å…è®¸æ¢è¡Œ */
    word-wrap: break-word; /* é•¿æ–‡æœ¬æ¢è¡Œ */
    line-height: 1.4;
    min-height: 36px; /* æœ€å°é«˜åº¦ç¡®ä¿ä¸€è‡´æ€§ */
    display: flex;
    align-items: center;
}

.menu-item:hover {
    background-color: #f8f9fa;
}

.menu-item.active {
    background-color: #007bff;
    color: white;
}

.menu-loading {
    padding: 20px;
    text-align: center;
    color: #666;
}

/* è¡¨æ ¼å®¹å™¨æ ·å¼ */
.table-container {
    position: relative;
    margin-right: 60px;
}

.table-responsive {
    overflow-x: auto;
    margin-right: -60px;
}

/* è¡¨æ ¼åŸºç¡€æ ·å¼ */
.table {
    margin-bottom: 0;
    font-size: 0.875rem;
}

.table th,
.table td {
    white-space: nowrap;
    vertical-align: middle;
    padding: 0.4rem 0.5rem;
}

/* å›ºå®šæ“ä½œåˆ—æ ·å¼ */
.action-column,
.table td:last-child {
    position: sticky;
    right: 0;
    background-color: #fff;
    z-index: 1;
    width: 60px;
    min-width: 60px;
    text-align: center;
    border-left: 1px solid #dee2e6;
}

.action-column {
    background-color: #f8f9fa;
}

/* è¾“å…¥æ¡†æ ·å¼ä¼˜åŒ– */
.form-control {
    padding: 0.25rem 0.5rem;
    font-size: 0.875rem;
    min-height: 30px;
    height: calc(1.5em + 0.5rem + 2px);
    text-overflow: ellipsis;
    white-space: nowrap;
    overflow: hidden;
}

/* æ•°å­—è¾“å…¥æ¡†å³å¯¹é½ */
input[type="number"].form-control {
    text-align: right;
    font-family: 'Roboto Mono', monospace;
    letter-spacing: -0.2px;
    background-color: #fff !important;
}

/* è¡¨å¤´æ ·å¼è°ƒæ•´ */
.table thead th {
    background-color: #f8f9fa;
    border-bottom: 2px solid #dee2e6;
    text-align: center;
    font-size: 0.875rem;
    font-weight: 600;
    padding: 0.5rem;
}

/* è°ƒæ•´æŒ‰é’®æ ·å¼ */
.btn-sm {
    padding: 0.2rem 0.4rem;
    font-size: 0.875rem;
}

/* äº§å“åç§°åˆ—å®½åº¦è°ƒæ•´ - æ”¾å®½ä»¥ç¡®ä¿å†…å®¹æ­£å¸¸å±•ç¤º */
.table th.name-column,
.table td.name-column {
    min-width: 250px !important;
    width: 250px !important;
}

/* äº§å“å‹å·åˆ—å®½åº¦è°ƒæ•´ - æ”¾å®½ä»¥ç¡®ä¿å†…å®¹æ­£å¸¸å±•ç¤º */
.table th.model-column,
.table td.model-column {
    min-width: 200px !important;
    width: 200px !important;
}

/* äº§å“è§„æ ¼åˆ—å®½åº¦è°ƒæ•´ */
.table th.desc-column,
.table td.desc-column {
    min-width: 200px;
    width: 200px;
}

/* ä»·æ ¼ç›¸å…³åˆ—å®½åº¦è°ƒæ•´ */
.table th.price-column,
.table td.price-column {
    min-width: 120px;
    width: 120px;
    text-align: right;
}

/* MNåˆ—å®½åº¦è°ƒæ•´ */
.table th.mn-column,
.table td.mn-column {
    min-width: 130px;
    width: 130px;
}

/* å“ç‰Œåˆ—å®½åº¦è°ƒæ•´ */
.table th:nth-child(4),
.table td:nth-child(4) {
    min-width: 100px;
    width: 100px;
}

/* å•ä½åˆ—å®½åº¦è°ƒæ•´ */
.table th:nth-child(5),
.table td:nth-child(5) {
    min-width: 80px;
    width: 80px;
}

/* æŠ˜æ‰£ç‡åˆ—å®½åº¦è°ƒæ•´ */
.table th:nth-child(7),
.table td:nth-child(7) {
    min-width: 100px;
    width: 100px;
}

/* æ•°é‡åˆ—å®½åº¦è°ƒæ•´ */
.table th:nth-child(9),
.table td:nth-child(9) {
    min-width: 80px;
    width: 80px;
}

/* å¤‡æ³¨åˆ—å®½åº¦è°ƒæ•´ */
.table th:nth-child(12),
.table td:nth-child(12) {
    min-width: 120px;
    width: 120px;
}

/* æ“ä½œåˆ—å®½åº¦è°ƒæ•´ */
.table th.action-column,
.table td.action-column {
    min-width: 80px;
    width: 80px;
    text-align: center;
}

/* ç¡®ä¿è¡¨æ ¼è¾“å…¥æ¡†å¡«æ»¡å•å…ƒæ ¼ */
.table input.form-control {
    width: 100%;
    border: 1px solid #dee2e6;
    padding: 0.375rem 0.5rem;
    font-size: 0.875rem;
}

/* æ•°å­—è¾“å…¥æ¡†å³å¯¹é½ */
.table input[type="number"] {
    text-align: right;
}

/* æŠ˜æ‰£ç‡è¾“å…¥æ¡†æ ·å¼ */
.discount-rate {
    text-align: right !important;
    padding-right: 8px !important;
}

/* å…¬å¸é€‰æ‹©å™¨æ ·å¼ */
.company-selector {
    background: linear-gradient(135deg, #007bff, #0056b3);
    color: white;
    border: none;
    border-radius: 8px;
    padding: 1rem;
    margin-bottom: 1rem;
}

.company-selector .form-select {
    font-size: 1rem;
    font-weight: 500;
    background-color: white;
    color: #495057;
    border: 1px solid #ced4da;
}

/* è®¢å•ä¿¡æ¯å¡ç‰‡æ ·å¼ */
.order-info-card {
    background: linear-gradient(135deg, #28a745, #20c997);
    color: white;
    border: none;
    border-radius: 8px;
    padding: 1rem;
    margin-bottom: 1rem;
}

.order-info-card .form-control,
.order-info-card .form-select {
    background-color: white;
    color: #495057;
    border: 1px solid #ced4da;
}

/* æ€»è®¡æ˜¾ç¤ºæ ·å¼ */
.total-summary {
    background: linear-gradient(135deg, #ffc107, #e0a800);
    color: #212529;
    border: none;
    border-radius: 8px;
    padding: 1rem;
    margin-top: 1rem;
    font-weight: bold;
}

.total-amount {
    font-size: 1.5rem;
    color: #dc3545;
    font-weight: bold;
}

/* å“åº”å¼è°ƒæ•´ */
@media (max-width: 768px) {
    .table-container {
        margin-right: 0;
    }
    
    .table-responsive {
        margin-right: 0;
    }
    
    .action-column,
    .table td:last-child {
        position: static;
        background-color: transparent;
    }
}

/* åŠ è½½çŠ¶æ€æ ·å¼ */
.loading {
    opacity: 0.6;
    pointer-events: none;
}

.spinner-border-sm {
    width: 1rem;
    height: 1rem;
}

/* PCç«¯æ—¥æœŸé€‰æ‹©å™¨å¢å¼ºæ ·å¼ - è¾“å…¥æ¡†ä¿æŒæ­£å¸¸ï¼Œä½†æ—¥å†ç•Œé¢æ”¾å¤§ */
@media (min-width: 768px) {
    /* è¾“å…¥æ¡†ä¿æŒæ­£å¸¸å¤§å°ï¼Œåªå¢å¼ºæ—¥å†å›¾æ ‡ */
    .date-picker-enhanced::-webkit-calendar-picker-indicator {
        width: 20px !important;
        height: 20px !important;
        cursor: pointer;
        filter: invert(0.5);
    }
    
    /* æ”¾å¤§æ—¥æœŸé€‰æ‹©å™¨å¼¹å‡ºçš„æ—¥å†ç•Œé¢ */
    .date-picker-enhanced::-webkit-calendar-picker-indicator:hover {
        transform: scale(1.1);
        transition: transform 0.2s ease;
    }
}

/* å…¨å±€æ—¥æœŸé€‰æ‹©å™¨å¼¹å‡ºç•Œé¢æ ·å¼å¢å¼º */
@media (min-width: 768px) {
    /* é€šè¿‡CSSå˜é‡æ¥å½±å“æ—¥æœŸé€‰æ‹©å™¨çš„æ˜¾ç¤º */
    input[type="date"]::-webkit-calendar-picker-indicator {
        background-size: 18px 18px;
        background-repeat: no-repeat;
        background-position: center;
    }
    
    /* å½“æ—¥æœŸé€‰æ‹©å™¨è·å¾—ç„¦ç‚¹æ—¶ï¼Œå¢åŠ è§†è§‰åé¦ˆ */
    input[type="date"]:focus::-webkit-calendar-picker-indicator {
        filter: invert(0.3);
        transform: scale(1.05);
    }
}

/* æ—¥æœŸé€‰æ‹©å™¨æ¿€æ´»çŠ¶æ€æ ·å¼ */
.date-picker-active {
    border-color: #0C7CD0 !important;
    box-shadow: 0 0 0 0.2rem rgba(12, 124, 208, 0.25) !important;
    transform: scale(1.02);
    transition: all 0.2s ease;
}

/* ä½¿ç”¨CSSå˜é‡æ¥å°è¯•å½±å“æ—¥æœŸé€‰æ‹©å™¨å¼¹å‡ºç•Œé¢ */
:root {
    --date-picker-scale: 1;
}

/* é’ˆå¯¹æ”¯æŒçš„æµè§ˆå™¨ï¼Œå°è¯•æ”¾å¤§æ—¥æœŸé€‰æ‹©å™¨å¼¹å‡ºç•Œé¢ */
@media (min-width: 768px) {
    /* å½“æ—¥æœŸé€‰æ‹©å™¨å¤„äºæ´»åŠ¨çŠ¶æ€æ—¶çš„æ ·å¼ */
    .date-picker-enhanced.date-picker-active {
        position: relative;
        z-index: 1050;
    }
    
    /* å°è¯•é€šè¿‡ä¼ªå…ƒç´ æ¥æç¤ºç”¨æˆ·æ—¥æœŸé€‰æ‹©å™¨å·²å¢å¼º */
    .date-picker-enhanced:focus::after {
        content: "ğŸ“… ç‚¹å‡»é€‰æ‹©æ—¥æœŸ";
        position: absolute;
        top: -25px;
        left: 0;
        font-size: 12px;
        color: #0C7CD0;
        background: white;
        padding: 2px 6px;
        border-radius: 4px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        white-space: nowrap;
        z-index: 1000;
        pointer-events: none;
    }
    
    /* ä¸ºæ—¥æœŸè¾“å…¥æ¡†æ·»åŠ æ›´å¥½çš„è§†è§‰åé¦ˆ */
    .date-picker-enhanced:hover {
        border-color: #0C7CD0;
        transition: border-color 0.2s ease;
    }
    
    /* å¢å¼ºæ—¥æœŸé€‰æ‹©å™¨å›¾æ ‡çš„å¯è§æ€§ */
    .date-picker-enhanced::-webkit-calendar-picker-indicator {
        opacity: 0.8;
        transition: opacity 0.2s ease, transform 0.2s ease;
    }
    
    .date-picker-enhanced:hover::-webkit-calendar-picker-indicator {
        opacity: 1;
        transform: scale(1.1);
    }
}

/* jQuery UI Datepicker å¢å¼ºæ ·å¼ - PCç«¯æ”¾å¤§æ—¥å†ç•Œé¢ */
@media (min-width: 768px) {
    .enhanced-datepicker {
        transform: scale(1.3) !important;
        transform-origin: top left !important;
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15) !important;
        border-radius: 8px !important;
        border: 2px solid #0C7CD0 !important;
        background: white !important;
        z-index: 9999 !important;
    }
    
    .enhanced-datepicker .ui-datepicker-header {
        background: linear-gradient(135deg, #0C7CD0, #0056b3) !important;
        color: white !important;
        border: none !important;
        border-radius: 6px 6px 0 0 !important;
        padding: 8px !important;
    }
    
    .enhanced-datepicker .ui-datepicker-title {
        color: white !important;
        font-weight: 600 !important;
        font-size: 14px !important;
    }
    
    .enhanced-datepicker .ui-datepicker-prev,
    .enhanced-datepicker .ui-datepicker-next {
        background: rgba(255, 255, 255, 0.2) !important;
        border: 1px solid rgba(255, 255, 255, 0.3) !important;
        border-radius: 4px !important;
    }
    
    .enhanced-datepicker .ui-datepicker-prev:hover,
    .enhanced-datepicker .ui-datepicker-next:hover {
        background: rgba(255, 255, 255, 0.3) !important;
    }
    
    .enhanced-datepicker .ui-datepicker-calendar {
        border-collapse: separate !important;
        border-spacing: 2px !important;
        margin: 8px !important;
    }
    
    .enhanced-datepicker .ui-datepicker-calendar td {
        padding: 2px !important;
    }
    
    .enhanced-datepicker .ui-datepicker-calendar td a {
        display: block !important;
        padding: 8px !important;
        text-align: center !important;
        border-radius: 6px !important;
        border: 1px solid transparent !important;
        font-size: 13px !important;
        font-weight: 500 !important;
        transition: all 0.2s ease !important;
    }
    
    .enhanced-datepicker .ui-datepicker-calendar td a:hover {
        background: #e3f2fd !important;
        border-color: #0C7CD0 !important;
        color: #0C7CD0 !important;
    }
    
    .enhanced-datepicker .ui-datepicker-calendar td.ui-datepicker-today a {
        background: #fff3cd !important;
        border-color: #ffc107 !important;
        color: #856404 !important;
    }
    
    .enhanced-datepicker .ui-datepicker-calendar td.ui-datepicker-current-day a,
    .enhanced-datepicker .ui-datepicker-calendar td a.ui-state-active {
        background: #0C7CD0 !important;
        border-color: #0C7CD0 !important;
        color: white !important;
    }
    
    .enhanced-datepicker .ui-datepicker-buttonpane {
        background: #f8f9fa !important;
        border-top: 1px solid #dee2e6 !important;
        padding: 8px !important;
        border-radius: 0 0 6px 6px !important;
    }
    
    .enhanced-datepicker .ui-datepicker-buttonpane button {
        background: #0C7CD0 !important;
        color: white !important;
        border: none !important;
        padding: 6px 12px !important;
        border-radius: 4px !important;
        font-size: 12px !important;
        margin: 0 4px !important;
        cursor: pointer !important;
    }
    
    .enhanced-datepicker .ui-datepicker-buttonpane button:hover {
        background: #0056b3 !important;
    }
}

/* æ—¥æœŸé€‰æ‹©å™¨å›¾æ ‡æ ·å¼ */
.date-picker-icon {
    position: absolute;
    right: 10px;
    top: 50%;
    transform: translateY(-50%);
    color: #6c757d;
    cursor: pointer;
    font-size: 16px;
    transition: color 0.2s ease;
    pointer-events: auto;
    z-index: 10;
}

.date-picker-icon:hover {
    color: #0C7CD0;
}

/* è°ƒæ•´åŒ…å«æ—¥æœŸé€‰æ‹©å™¨çš„å®¹å™¨ */
.col-md-4:has(.date-picker-enhanced) {
    position: relative;
}
</style>
{% endblock %}

{% block content %}
<div class="container mt-4 page-with-fixed-nav">
    <!-- é¡µé¢æ ‡é¢˜ -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <h2 class="mb-0">
                    <i class="fas fa-plus-circle me-2"></i>åˆ›å»ºè®¢å•
                </h2>
                <div>
                    {{ render_button('è¿”å›è®¢å•åˆ—è¡¨', href=url_for('inventory.order_list'), color='secondary', icon='fas fa-arrow-left') }}
                </div>
            </div>
        </div>
    </div>

    <form id="orderForm" method="POST" action="{{ url_for('inventory.create_order') }}">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
        <!-- è®¢å•åŸºæœ¬ä¿¡æ¯ -->
        <div class="card order-info-card mb-4">
            <div class="card-body">
                <h5 class="card-title text-white mb-3">
                    <i class="fas fa-info-circle me-2"></i>è®¢å•åŸºæœ¬ä¿¡æ¯
                </h5>
                <div class="row">
                    <div class="col-md-4 mb-3">
                        <label for="company_id" class="form-label text-white">è®¢å•ç›®æ ‡å…¬å¸ *</label>
                        <select class="form-select" id="company_id" name="company_id" required>
                            <option value="">è¯·é€‰æ‹©å…¬å¸</option>
                            {% for company in companies %}
                            <option value="{{ company.id }}">{{ company.company_name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-4 mb-3">
                        <label for="expected_date" class="form-label text-white">é¢„æœŸåˆ°è´§æ—¶é—´</label>
                        <input type="date" class="form-control" id="expected_date" name="expected_date">
                    </div>
                    <div class="col-md-4 mb-3">
                        <label for="payment_terms" class="form-label text-white">ä»˜æ¬¾æ¡ä»¶</label>
                        <input type="text" class="form-control" id="payment_terms" name="payment_terms" placeholder="å¦‚ï¼š30å¤©ä»˜æ¬¾">
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="delivery_address" class="form-label text-white">äº¤ä»˜åœ°å€</label>
                        <textarea class="form-control" id="delivery_address" name="delivery_address" rows="2" placeholder="è¯·è¾“å…¥è¯¦ç»†çš„äº¤ä»˜åœ°å€"></textarea>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="description" class="form-label text-white">è®¢å•è¯´æ˜</label>
                        <textarea class="form-control" id="description" name="description" rows="2" placeholder="è®¢å•å¤‡æ³¨ä¿¡æ¯"></textarea>
                    </div>
                </div>
            </div>
        </div>

        <!-- äº§å“æ˜ç»† -->
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="fas fa-list me-2"></i>äº§å“æ˜ç»†
                </h5>
                {{ render_button('æ·»åŠ äº§å“', type='button', color='success', size='sm', icon='fas fa-plus', attrs='id="addProductBtn"') }}
            </div>
            <div class="card-body p-0">
                <div class="table-container">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0" id="productTable">
                            <thead>
                                <tr>
                                    <th class="name-column">äº§å“åç§°</th>
                                    <th class="model-column">äº§å“å‹å·</th>
                                    <th class="desc-column">äº§å“è§„æ ¼</th>
                                    <th style="min-width: 90px;">å“ç‰Œ</th>
                                    <th style="min-width: 70px;">å•ä½</th>
                                    <th class="price-column">å¸‚åœºå•ä»·</th>
                                    <th style="min-width: 90px;">æŠ˜æ‰£ç‡%</th>
                                    <th class="price-column">å•ä»·</th>
                                    <th style="min-width: 70px;">æ•°é‡</th>
                                    <th class="price-column">å°è®¡</th>
                                    <th class="mn-column">MN</th>
                                    <th>å¤‡æ³¨</th>
                                    <th class="action-column" style="min-width: 50px;">æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody id="productTableBody">
                                <!-- äº§å“è¡Œå°†é€šè¿‡JavaScriptåŠ¨æ€æ·»åŠ  -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- è®¢å•æ€»è®¡ -->
        <div class="card mb-4" style="background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);">
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <h5 class="mb-0 text-white">è®¢å•æ€»è®¡</h5>
                        <small class="text-white">æ€»æ•°é‡ï¼š<span id="totalQuantity">0</span> ä»¶</small>
                    </div>
                    <div class="col-md-4 text-end">
                        <div class="total-amount text-white">
                            <h4 class="mb-0">Â¥ <span id="totalAmount">0.00</span></h4>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- æ“ä½œæŒ‰é’® -->
        <div class="row mt-4 mb-5">
            <div class="col-12 text-center">
                {{ render_button('åˆ›å»ºè®¢å•', type='submit', color='primary', icon='fas fa-save', attrs='id="submitBtn"') }}
            </div>
        </div>
    </form>
</div>

{% endblock %}

{% block scripts %}
<script>
$(document).ready(function() {
    console.log('åˆ›å»ºè®¢å•é¡µé¢JavaScriptå·²åŠ è½½');
    
    // æ·»åŠ äº§å“è¡Œ
    $('#addProductBtn').click(function() {
        console.log('æ·»åŠ äº§å“æŒ‰é’®è¢«ç‚¹å‡»');
        addProductRow();
    });
    
    // åˆ é™¤äº§å“è¡Œ
    $(document).on('click', '.remove-product', function() {
        $(this).closest('tr').remove();
        updateGrandTotal();
    });
    
    // æ•°é‡ã€æŠ˜æ‰£ç‡ã€å•ä»·å˜åŒ–æ—¶é‡æ–°è®¡ç®—
    $(document).on('input', '.quantity, .discount-rate, .discounted-price', function() {
        const $row = $(this).closest('tr');
        console.log('è¾“å…¥äº‹ä»¶è§¦å‘ï¼Œå­—æ®µç±»å‹:', $(this).attr('class'), 'å€¼:', $(this).val());
        
        // å¦‚æœæ˜¯å•ä»·å˜åŒ–ï¼Œé‡æ–°è®¡ç®—æŠ˜æ‰£ç‡
        if ($(this).hasClass('discounted-price')) {
            const marketPrice = parseFloat($row.find('.product-price').data('raw-value')) || 0;
            const unitPrice = parseFloat($(this).val()) || 0;
            
            console.log('å•ä»·å˜åŒ–äº‹ä»¶ - å¸‚åœºä»·:', marketPrice, 'è¾“å…¥å•ä»·:', unitPrice);
            
            if (marketPrice > 0) {
                const discountRate = (unitPrice / marketPrice * 100).toFixed(1);
                $row.find('.discount-rate').val(discountRate);
                console.log('æ›´æ–°æŠ˜æ‰£ç‡ä¸º:', discountRate);
            }
            
            // æ›´æ–°dataå±æ€§
            $row.find('.discounted-price').data('raw-value', unitPrice);
            
            // è®¡ç®—å°è®¡
            const quantity = parseInt($row.find('.quantity').val()) || 1;
            const subtotal = unitPrice * quantity;
            $row.find('.subtotal')
                .val(formatNumber(subtotal))
                .data('raw-value', subtotal);
            
            updateGrandTotal();
            return;
        }
        
        // å¦‚æœæ˜¯æŠ˜æ‰£ç‡æˆ–æ•°é‡å˜åŒ–ï¼Œé‡æ–°è®¡ç®—å•ä»·å’Œå°è®¡
        console.log('è§¦å‘calculateRowTotal');
        calculateRowTotal($row);
    });
    
    // è¡¨å•æäº¤
    $('#orderForm').submit(function(e) {
        e.preventDefault();
        
        // éªŒè¯æ˜¯å¦æœ‰äº§å“
        if ($('#productTableBody tr').length === 0) {
            alert('è¯·è‡³å°‘æ·»åŠ ä¸€ä¸ªäº§å“');
            return;
        }
        
        // éªŒè¯æ‰€æœ‰äº§å“è¡Œ
        let isValid = true;
        $('#productTableBody tr').each(function() {
            const $row = $(this);
            const productName = $row.find('.product-name').val();
            if (!productName) {
                isValid = false;
                $row.find('.product-name').addClass('is-invalid');
            }
        });
        
        if (!isValid) {
            alert('è¯·å®Œæ•´é€‰æ‹©æ‰€æœ‰äº§å“ä¿¡æ¯');
            return;
        }
        
        // æ”¶é›†è¡¨å•æ•°æ®
        const formData = collectFormData();
        
        // æäº¤è¡¨å•
        $('#submitBtn').prop('disabled', true).html('<i class="fas fa-spinner fa-spin me-1"></i>åˆ›å»ºä¸­...');
        
        // åˆ›å»ºéšè—å­—æ®µæäº¤æ•°æ®
        createHiddenFields(formData);
        
        // æäº¤åŸç”Ÿè¡¨å•
        this.submit();
    });
    
    // æ·»åŠ äº§å“è¡Œ
    function addProductRow() {
        console.log('å¼€å§‹æ·»åŠ äº§å“è¡Œ...');
        
        const $newRow = $(`
            <tr class="product-row">
                <td>
                    <div class="product-name-container">
                        <input type="text" class="form-control product-name" name="product_name[]" required placeholder="ç‚¹å‡»é€‰æ‹©äº§å“...">
                    </div>
                </td>
                <td>
                    <div class="product-model-container">
                        <input type="text" class="form-control product-model" name="product_model[]" readonly>
                    </div>
                </td>
                <td>
                    <input type="text" class="form-control product-spec" name="product_spec[]" readonly>
                </td>
                <td>
                    <input type="text" class="form-control product-brand" name="brand[]" readonly>
                </td>
                <td>
                    <input type="text" class="form-control product-unit" name="unit[]" readonly>
                </td>
                <td>
                    <input type="text" class="form-control product-price" name="market_price[]" readonly>
                </td>
                <td>
                    <div class="discount-rate-container">
                        <input type="number" class="form-control discount-rate" name="discount_rate[]" value="100.0" min="0" step="0.1" max="1000" required>
                    </div>
                </td>
                <td>
                    <input type="number" class="form-control discounted-price" name="unit_price[]" step="0.01" min="0" required>
                </td>
                <td>
                    <input type="number" class="form-control quantity" name="quantity[]" value="1" min="1" required>
                </td>
                <td>
                    <input type="text" class="form-control subtotal" name="total_price[]" readonly>
                </td>
                <td>
                    <input type="text" class="form-control product-mn" name="product_mn[]" readonly>
                </td>
                <td>
                    <input type="text" class="form-control" name="notes[]" placeholder="å¤‡æ³¨">
                </td>
                <td class="action-column">
                    <button type="button" class="btn btn-danger btn-sm remove-product">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
                <input type="hidden" class="product-id" name="product_id[]" value="">
            </tr>
        `);
        
        $('#productTableBody').append($newRow);
        console.log('äº§å“è¡Œå·²æ·»åŠ åˆ°è¡¨æ ¼');
        
        // åˆå§‹åŒ–äº§å“é€‰æ‹©åŠŸèƒ½
        initializeProductSelection($newRow.find('.product-name'));
    }
    
    // åˆå§‹åŒ–äº§å“é€‰æ‹©åŠŸèƒ½
    function initializeProductSelection($input) {
        $input.on('click', function() {
            // ç§»é™¤å·²å­˜åœ¨çš„èœå•
            $('.product-menu-container').remove();
            
            const $menu = $('<div class="product-menu-container"></div>');
            const $content = $('<div class="product-menu-content"></div>');
            const $categories = $('<div class="menu-column"></div>');
            const $products = $('<div class="menu-column"></div>');
            const $models = $('<div class="menu-column"></div>');
            const $specs = $('<div class="menu-column"></div>');
            
            $content.append($categories, $products, $models, $specs);
            $menu.append($content);
            
            // å®šä½èœå•
            const inputOffset = $input.offset();
            const inputHeight = $input.outerHeight();
            
            $menu.css({
                position: 'absolute',
                top: inputOffset.top + inputHeight + 'px',
                left: inputOffset.left + 'px',
                width: $input.outerWidth() * 4 + 'px',
                zIndex: 1000
            });
            
            $('body').append($menu);
            
            // åŠ è½½äº§å“ç±»åˆ«
            $categories.html('<div class="menu-loading">åŠ è½½ä¸­...</div>');
            
                         $.ajax({
                 url: '/inventory/api/products/categories',
                 method: 'GET',
                 success: function(categories) {
                    $categories.empty();
                    
                    categories.forEach(function(category) {
                        $('<div class="menu-item"></div>')
                            .text(category)
                            .on('click', function() {
                                $('.menu-item').removeClass('active');
                                $(this).addClass('active');
                                
                                // åŠ è½½è¯¥ç±»åˆ«çš„äº§å“
                                $products.html('<div class="menu-loading">åŠ è½½ä¸­...</div>');
                                $models.empty();
                                $specs.empty();
                                
                                                                 $.ajax({
                                     url: '/inventory/api/products/by-category',
                                     method: 'GET',
                                     data: { category: category },
                                     success: function(products) {
                                        $products.empty();
                                        
                                        // æŒ‰äº§å“åç§°åˆ†ç»„
                                        const productGroups = {};
                                        products.forEach(function(product) {
                                            if (!productGroups[product.product_name]) {
                                                productGroups[product.product_name] = [];
                                            }
                                            productGroups[product.product_name].push(product);
                                        });
                                        
                                        // æ˜¾ç¤ºäº§å“åç§°
                                        Object.keys(productGroups).forEach(function(productName) {
                                            $('<div class="menu-item"></div>')
                                                .text(productName)
                                                .data('products', productGroups[productName])
                                                .on('click', function() {
                                                    $('.menu-item').removeClass('active');
                                                    $(this).addClass('active');
                                                    
                                                    const products = $(this).data('products');
                                                    
                                                    // æ˜¾ç¤ºå‹å·
                                                    $models.empty();
                                                    $specs.empty();
                                                    
                                                    // æŒ‰å‹å·åˆ†ç»„
                                                    const modelGroups = {};
                                                    products.forEach(function(product) {
                                                        if (!modelGroups[product.model]) {
                                                            modelGroups[product.model] = [];
                                                        }
                                                        modelGroups[product.model].push(product);
                                                    });
                                                    
                                                    Object.keys(modelGroups).forEach(function(model) {
                                                        $('<div class="menu-item"></div>')
                                                            .text(model)
                                                            .data('products', modelGroups[model])
                                                            .on('click', function() {
                                                                $('.menu-item').removeClass('active');
                                                                $(this).addClass('active');
                                                                
                                                                const modelProducts = $(this).data('products');
                                                                
                                                                // æ˜¾ç¤ºè§„æ ¼
                                                                $specs.empty();
                                                                
                                                                modelProducts.forEach(function(product) {
                                                                    const $specItem = $('<div class="menu-item"></div>');
                                                                    $specItem.data('product', product);
                                                                    
                                                                    const $text = $('<div></div>').css({
                                                                        whiteSpace: 'normal',
                                                                        wordBreak: 'break-word',
                                                                        flex: '1'
                                                                    });
                                                                    $text.text(product.specification || 'æ ‡å‡†è§„æ ¼');
                                                                    $specItem.append($text);
                                                                    
                                                                    $specItem.on('click', function() {
                                                                        const selectedProduct = $(this).data('product');
                                                                        $input.val(selectedProduct.product_name);
                                                                        const $row = $input.closest('tr');
                                                                        clearProductDetails($row, true);
                                                                        fillProductDetails($row, selectedProduct);
                                                                        $menu.remove();
                                                                    });
                                                                    
                                                                    $specs.append($specItem);
                                                                });
                                                            })
                                                            .appendTo($models);
                                                    });
                                                })
                                                .appendTo($products);
                                        });
                                    },
                                    error: function(xhr, status, error) {
                                        console.error('åŠ è½½äº§å“å¤±è´¥:', error);
                                        $products.html('<div class="menu-loading">åŠ è½½äº§å“å¤±è´¥</div>');
                                    }
                                });
                            })
                            .appendTo($categories);
                    });
                    
                    // é»˜è®¤é€‰ä¸­ç¬¬ä¸€ä¸ªç±»åˆ«å¹¶è§¦å‘ç‚¹å‡»äº‹ä»¶
                    $categories.find('.menu-item:first').click();
                },
                error: function(xhr, status, error) {
                    console.error('åŠ è½½ç±»åˆ«å¤±è´¥:', error);
                    $categories.html('<div class="menu-loading">åŠ è½½ç±»åˆ«å¤±è´¥</div>');
                }
            });
            
            // ç‚¹å‡»å…¶ä»–åŒºåŸŸå…³é—­èœå•
            $(document).one('click', function(e) {
                if (!$(e.target).closest('.product-menu-container, .product-name').length) {
                    $menu.remove();
                }
            });
        });
    }
    
    // æ¸…ç©ºäº§å“è¯¦æƒ…å­—æ®µ
    function clearProductDetails($row, keepName = false) {
        if (!keepName) {
            $row.find('.product-name').val('');
        }
        
        // æ¸…ç©ºå…¶ä»–å­—æ®µ
        $row.find('.product-model').val('');
        $row.find('.product-spec').val('');
        $row.find('.product-brand').val('');
        $row.find('.product-unit').val('');
        $row.find('.product-price').val('').data('raw-value', 0);
        $row.find('.product-mn').val('');
        $row.find('.discount-rate').val('100.0');
        $row.find('.discounted-price').val('').data('raw-value', 0);
        $row.find('.subtotal').val('').data('raw-value', 0);
        $row.find('.product-id').val('');
    }
    
    // å¡«å……äº§å“è¯¦æƒ…
    function fillProductDetails($row, product) {
        console.log('å¡«å……äº§å“è¯¦æƒ…ï¼Œå®Œæ•´äº§å“æ•°æ®:', JSON.stringify(product, null, 2));
        
        // å¡«å……äº§å“å‹å·
        $row.find('.product-model').val(product.model || '');
        
        // å¡«å……äº§å“è§„æ ¼
        $row.find('.product-spec').val(product.specification || '');
        
        // å¡«å……å“ç‰Œ
        $row.find('.product-brand').val(product.brand || '');
        
        // å¡«å……å•ä½
        $row.find('.product-unit').val(product.unit || '');
        
        // å¡«å……MN
        $row.find('.product-mn').val(product.product_mn || '');
        
        // å¡«å……äº§å“ID
        $row.find('.product-id').val(product.id);
        
        // è®¾ç½®å¸‚åœºä»·æ ¼
        let price = parseFloat(product.retail_price) || 0;
        console.log('åŸå§‹å¸‚åœºä»·æ ¼:', product.retail_price, 'è§£æå:', price);
        
        // è®¾ç½®å¸‚åœºä»·æ ¼å­—æ®µ
        $row.find('.product-price').val(price);
        $row.find('.product-price').data('raw-value', price);
        
        // è®¾ç½®å•ä»·å­—æ®µï¼ˆåˆå§‹æŠ˜æ‰£ç‡100%ï¼‰
        const $unitPriceField = $row.find('.discounted-price');
        console.log('è®¾ç½®å•ä»·å­—æ®µ: åŸå§‹ä»·æ ¼=', price);
        
        // å…³é”®ä¿®å¤ï¼šå¯¹äºnumberç±»å‹çš„inputï¼Œç›´æ¥è®¾ç½®æ•°å€¼ï¼Œä¸è¦æ ¼å¼åŒ–
        if ($unitPriceField.length > 0) {
            const field = $unitPriceField[0];
            console.log('å­—æ®µç±»å‹:', field.type);
            
            // ç›´æ¥è®¾ç½®æ•°å€¼ï¼Œä¸æ ¼å¼åŒ–
            console.log('è®¾ç½®å‰çš„å€¼:', field.value);
            field.value = price; // ç›´æ¥è®¾ç½®æ•°å€¼ï¼Œä¸æ˜¯æ ¼å¼åŒ–å­—ç¬¦ä¸²
            console.log('è®¾ç½®åçš„å€¼:', field.value);
            
            // åŒæ—¶è®¾ç½®dataå±æ€§ç”¨äºè®¡ç®—
            $unitPriceField.data('raw-value', price);
            
            console.log('å•ä»·å­—æ®µè®¾ç½®æˆåŠŸ:', price);
        }
        
        // è®¾ç½®æ•°é‡ä¸º1
        $row.find('.quantity').val(1);
        
        // è®¡ç®—å°è®¡
        calculateRowTotal($row);
        
        console.log('è®¾ç½®å®Œæˆ - å•ä»·:', price, 'å°è®¡:', $row.find('.subtotal').val());
    }
    
    // è®¡ç®—è¡Œä»·æ ¼ï¼ˆé‡‡ç”¨æŠ¥ä»·å•çš„é€»è¾‘ï¼‰
    function calculateRowTotal($row, eventSource) {
        try {
            console.log('è®¡ç®—è¡Œä»·æ ¼');
            
            // è·å–å¸‚åœºä»·æ ¼å’Œå…¶ä»–å€¼
            var marketPriceStr = $row.find('.product-price').val() || '0';
            var marketPrice = parseFloat(marketPriceStr.replace(/,/g, '')) || 0;
            
            var discountStr = $row.find('.discount-rate').val() || '100';
            var discount = parseFloat(discountStr.replace(/,/g, '')) || 100;
            
            var quantityStr = $row.find('.quantity').val() || '0';
            var quantity = parseFloat(quantityStr.replace(/,/g, '')) || 0;
            
            // æ£€æŸ¥äº‹ä»¶æ¥æº
            var fromDiscountRate = false;
            if (eventSource) {
                fromDiscountRate = $(eventSource).hasClass('discount-rate');
            }
            
            // è·å–å½“å‰çš„æŠ˜åä»·
            var discountedPriceStr = $row.find('.discounted-price').val() || '0';
            var currentDiscountedPrice = parseFloat(discountedPriceStr.replace(/,/g, '')) || 0;
            
            // è®¡ç®—å•ä»· (æŠ˜åä»·)
            var unitPrice = marketPrice * (discount / 100);
            
            // å¦‚æœä»·æ ¼å˜æ›´æ˜¯ä»æŠ˜æ‰£ç‡å˜æ›´è§¦å‘çš„ï¼Œæˆ–è€…å•ä»·ä¸º0ï¼Œæ‰æ›´æ–°å•ä»·
            if (fromDiscountRate || currentDiscountedPrice <= 0) {
                $row.find('.discounted-price').val(formatNumber(unitPrice.toFixed(2)));
                $row.find('.discounted-price').data('raw-value', unitPrice);
            } else {
                // å¦åˆ™ä½¿ç”¨è¾“å…¥çš„æŠ˜åä»·
                unitPrice = currentDiscountedPrice;
            }
            
            // è®¡ç®—å°è®¡
            var subtotal = unitPrice * quantity;
            $row.find('.subtotal').val(formatNumber(subtotal.toFixed(2)));
            $row.find('.subtotal').data('raw-value', subtotal);
        
            // è°ƒç”¨æ€»è®¡æ›´æ–°å‡½æ•°
        updateGrandTotal();
            
            console.log('è¡Œä»·æ ¼è®¡ç®—å®Œæˆ: å¸‚åœºä»·=', marketPrice, 'æŠ˜æ‰£=', discount, 'å•ä»·=', unitPrice, 'æ•°é‡=', quantity, 'å°è®¡=', subtotal);
        } catch (error) {
            console.error('è®¡ç®—è¡Œä»·æ ¼æ—¶å‡ºé”™:', error);
        }
    }
    
    // æ›´æ–°æ€»è®¡
    function updateGrandTotal() {
        let totalQuantity = 0;
        let totalAmount = 0;
        
        $('#productTableBody tr').each(function() {
            const $row = $(this);
            const quantity = parseInt($row.find('.quantity').val()) || 0;
            const subtotal = parseFloat($row.find('.subtotal').data('raw-value')) || 0;
            
            totalQuantity += quantity;
            totalAmount += subtotal;
        });
        
        $('#totalQuantity').text(totalQuantity);
        $('#totalAmount').text(formatNumber(totalAmount));
    }
    
    // æ ¼å¼åŒ–æ•°å­—ä¸ºå¸¦åƒä½åˆ†éš”ç¬¦å’Œä¸¤ä½å°æ•°çš„å­—ç¬¦ä¸²
    function formatNumber(number) {
        try {
            let num = parseFloat(number);
            if (isNaN(num)) {
                return '0.00';
            }
            
            return num.toLocaleString('zh-CN', { 
                minimumFractionDigits: 2, 
                maximumFractionDigits: 2 
            });
        } catch (e) {
            console.error('æ ¼å¼åŒ–æ•°å­—æ—¶å‡ºé”™:', e, 'è¾“å…¥å€¼:', number);
            return '0.00';
        }
    }
    
    // æ”¶é›†è¡¨å•æ•°æ®
    function collectFormData() {
        const details = [];
        
        $('#productTableBody tr').each(function() {
            const $row = $(this);
            const productName = $row.find('.product-name').val();
            
            if (!productName) {
                return true; // è·³è¿‡ç©ºè¡Œ
            }
            
            const detail = {
                product_id: $row.find('.product-id').val(),
                product_name: productName,
                product_model: $row.find('.product-model').val() || '',
                product_desc: $row.find('.product-spec').val() || '',
                brand: $row.find('.product-brand').val() || '',
                unit: $row.find('.product-unit').val() || '',
                market_price: parseFloat($row.find('.product-price').data('raw-value')) || 0,
                discount_rate: parseFloat($row.find('.discount-rate').val()) || 100,
                unit_price: parseFloat($row.find('.discounted-price').data('raw-value')) || 0,
                quantity: parseInt($row.find('.quantity').val()) || 1,
                total_price: parseFloat($row.find('.subtotal').data('raw-value')) || 0,
                product_mn: $row.find('.product-mn').val() || '',
                notes: $row.find('input[name="notes[]"]').val() || ''
            };
            
            details.push(detail);
        });
        
        return { details: details };
    }
    
    // åˆ›å»ºéšè—å­—æ®µ
    function createHiddenFields(formData) {
        // ç§»é™¤ä¹‹å‰çš„éšè—å­—æ®µ
        $('input[name^="product_id[]"], input[name^="quantity[]"], input[name^="unit_price[]"], input[name^="discount[]"]').remove();
        
        // ä¸ºæ¯ä¸ªäº§å“æ˜ç»†åˆ›å»ºéšè—å­—æ®µ
        formData.details.forEach(function(detail, index) {
            $('<input>').attr({
                type: 'hidden',
                name: 'product_id[]',
                value: detail.product_id
            }).appendTo('#orderForm');
            
            $('<input>').attr({
                type: 'hidden',
                name: 'quantity[]',
                value: detail.quantity
            }).appendTo('#orderForm');
            
            $('<input>').attr({
                type: 'hidden',
                name: 'unit_price[]',
                value: detail.unit_price
            }).appendTo('#orderForm');
            
            $('<input>').attr({
                type: 'hidden',
                name: 'discount[]',
                value: detail.discount_rate
            }).appendTo('#orderForm');
        });
    }
    
    // åˆå§‹åŒ–æ—¶æ·»åŠ ä¸€è¡Œ
    addProductRow();
});
</script>
{% endblock %}