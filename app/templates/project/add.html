{% extends "base.html" %}
{% from 'macros/ui_helpers.html' import render_authorization_code %}
{% import 'macros/ui_helpers.html' as ui %}

{% block head %}
{{ super() }}
<style>
    /* 项目添加页面主容器顶部留白，避免被fixed导航遮挡 */
    .container.page-with-fixed-nav {
        margin-top: 72px !important; /* 72px为主导航高度+安全间距 */
    }
    @media (max-width: 991.98px) {
        .container.page-with-fixed-nav {
            margin-top: 120px !important;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4 page-with-fixed-nav">
    <h2 class="mb-4">{{ _('添加项目') }}</h2>

    <form method="POST">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <!-- 项目信息卡片 -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="card-title mb-0">{{ _('项目信息') }}</h5>
            </div>
            <div class="card-body">
                <div class="row mb-4">
                    <div class="col-md-6">
                        <label for="project_name" class="form-label mb-2">{{ _('项目名称') }}</label>
                        <input type="text" class="form-control" id="project_name" name="project_name" required>
                    </div>
                    <div class="col-md-6">
                        <label for="report_time" class="form-label mb-2">{{ _('报备日期') }}</label>
                        <input type="date" class="form-control" id="report_time" name="report_time" required value="{{ (request.form.report_time or (now().strftime('%Y-%m-%d'))) }}">
                    </div>
                </div>

                <div class="row mb-4">
                    <div class="col-md-6">
                        <label for="report_source" class="form-label mb-2">{{ _('报备来源') }}</label>
                        <select class="form-select" id="report_source" name="report_source">
                            <option value="">{{ _('请选择报备来源') }}</option>
                            {% for k, v in REPORT_SOURCE_OPTIONS %}
                            <option value="{{ k }}">{{ v }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label for="project_type" class="form-label mb-2">{{ _('项目类型') }}</label>
                        <select class="form-select" id="project_type" name="project_type">
                            <option value="">-- {{ _('请选择项目类型') }} --</option>
                            {% for k, v in PROJECT_TYPE_OPTIONS %}
                            <option value="{{ k }}">{{ v }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>

                <div class="row mb-4">
                    <div class="col-md-6">
                        <label for="product_situation" class="form-label mb-2">{{ _('品牌情况') }}</label>
                        <select class="form-select" id="product_situation" name="product_situation">
                            <option value="">{{ _('请选择品牌情况') }}</option>
                            {% for k, v in PRODUCT_SITUATION_OPTIONS %}
                            <option value="{{ k }}">{{ v }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label for="current_stage" class="form-label mb-2">{{ _('当前阶段') }}</label>
                        <input type="text" class="form-control" id="current_stage_display" value="{{ project_stage_label('discover') }}" readonly>
                        <input type="hidden" name="current_stage" value="discover">
                    </div>
                </div>

                <div class="row mb-4">
                    <div class="col-md-6">
                        <label for="quotation_customer" class="form-label mb-2">{{ _('报价') }}（{{ _('元') }}）</label>
                        <input type="text" class="form-control" id="quotation_customer" name="quotation_customer"
                            placeholder="{{ _('不可编辑') }}"
                            disabled>
                    </div>
                    <div class="col-md-6">
                        <label for="delivery_forecast" class="form-label mb-2">{{ _('出货预测日期') }}</label>
                        <input type="date" class="form-control" id="delivery_forecast" name="delivery_forecast" value="">
                    </div>
                </div>
                
                <!-- 销售负责人字段 -->
                <div class="row mb-4">
                    <div class="col-md-6">
                        <label for="vendor_sales_manager_id" class="form-label mb-2">{{ _('厂商销售负责人') }}</label>
                        <select class="form-select" id="vendor_sales_manager_id" name="vendor_sales_manager_id">
                            <option value="">{{ _('请选择厂商销售负责人') }}</option>
                            <!-- 这里将通过JavaScript动态加载厂商用户 -->
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label for="industry" class="form-label mb-2">{{ _('项目行业') }} <span class="text-danger">*</span></label>
                        <select class="form-select" id="industry" name="industry" required>
                            <option value="">{{ _('请选择项目行业') }}</option>
                            <option value="manufacturing">{{ _('制造业') }}</option>
                            <option value="healthcare">{{ _('医疗健康') }}</option>
                            <option value="education">{{ _('教育') }}</option>
                            <option value="finance">{{ _('金融') }}</option>
                            <option value="real_estate">{{ _('房地产') }}</option>
                            <option value="retail">{{ _('零售') }}</option>
                            <option value="transportation">{{ _('交通运输') }}</option>
                            <option value="energy">{{ _('能源') }}</option>
                            <option value="technology">{{ _('科技') }}</option>
                            <option value="government">{{ _('政府') }}</option>
                            <option value="hospitality">{{ _('酒店服务') }}</option>
                            <option value="agriculture">{{ _('农业') }}</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>

        <!-- 参与单位卡片 -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="card-title mb-0">{{ _('参与单位') }}</h5>
            </div>
            <div class="card-body">
                <div class="row mb-4">
                    <div class="col-md-6">
                        <label for="end_user" class="form-label mb-2">{{ _('直接用户') }}</label>
                        <select class="form-select" id="end_user" name="end_user">
                            <option value="">{{ _('请选择用户') }}</option>
                            {% for user in user %}
                            <option value="{{ user.company_name }}">{{ user.company_name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label for="design_issues" class="form-label mb-2">{{ _('设计院及顾问') }}</label>
                        <select class="form-select" id="design_issues" name="design_issues">
                            <option value="">{{ _('请选择设计院及顾问') }}</option>
                            {% for designer in designer %}
                            <option value="{{ designer.company_name }}">{{ designer.company_name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>

                <div class="row mb-4">
                    <div class="col-md-6">
                        <label for="contractor" class="form-label mb-2">{{ _('总承包单位') }}</label>
                        <select class="form-select" id="contractor" name="contractor">
                            <option value="">{{ _('请选择总承包单位') }}</option>
                            {% for contractor in contractor %}
                            <option value="{{ contractor.company_name }}">{{ contractor.company_name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label for="system_integrator" class="form-label mb-2">{{ _('系统集成商') }}</label>
                        <select class="form-select" id="system_integrator" name="system_integrator">
                            <option value="">{{ _('请选择系统集成商') }}</option>
                            {% for integrator in integrator %}
                            <option value="{{ integrator.company_name }}">{{ integrator.company_name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6">
                        <label for="dealer" class="form-label mb-2">{{ _('经销商') }}</label>
                        <select class="form-select" id="dealer" name="dealer">
                            <option value="">{{ _('请选择经销商') }}</option>
                            {% for dealer in dealer %}
                            <option value="{{ dealer.company_name }}">{{ dealer.company_name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
            </div>
        </div>

        <!-- 阶段说明卡片 -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="card-title mb-0">{{ _('阶段说明') }}</h5>
            </div>
            <div class="card-body">
                <div class="mb-4">
                    <label for="stage_description" class="form-label mb-2">{{ _('当前阶段情况说明') }}</label>
                    <textarea class="form-control" id="stage_description" name="stage_description" rows="3"></textarea>
                </div>

                <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                    {{ ui.render_button(_("保存"), type="submit", color="primary", extra_class="me-md-2") }}
                    {{ ui.render_button(_("取消"), href=url_for('project.list_projects'), color="secondary") }}
                </div>
            </div>
        </div>
    </form>
</div>

<!-- 添加日期格式化脚本 -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    function formatDateInput(input) {
        input.addEventListener('input', function(e) {
            let value = e.target.value;
            if (value) {
                let date = new Date(value);
                let year = date.getFullYear();
                let month = String(date.getMonth() + 1).padStart(2, '0');
                let day = String(date.getDate()).padStart(2, '0');
                e.target.value = `${year}-${month}-${day}`;
            }
        });
    }

    let dateInputs = document.querySelectorAll('input[type="date"]');
    dateInputs.forEach(formatDateInput);

    // 金额格式化函数
    window.formatAmount = function(input) {
        let value = input.value.replace(/[^\d.]/g, '');
        if (value) {
            // 确保只有一个小数点
            let parts = value.split('.');
            if (parts.length > 2) {
                parts = [parts[0], parts.slice(1).join('')];
            }
            
            // 格式化整数部分
            let integerPart = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ',');
            
            // 重组金额
            if (parts.length === 2) {
                // 最多保留两位小数
                let decimalPart = parts[1].substring(0, 2);
                input.value = integerPart + '.' + decimalPart;
            } else {
                input.value = integerPart;
            }
        }
    };

    // 加载各类型公司数据的函数
    async function loadCompanies(type, selectId) {
        try {
            console.log(`正在加载${type}类型的公司数据...`);
            const response = await fetch(`/api/companies/${type}`);
            const data = await response.json();

            const select = document.getElementById(selectId);
            select.innerHTML = '<option value="">请选择</option>';

            (data.companies || data).forEach(company => {
                const option = document.createElement('option');
                option.value = company.name;
                option.textContent = company.name;
                option.setAttribute('data-id', company.id);
                option.setAttribute('data-contact', company.contact);
                option.setAttribute('data-phone', company.phone);
                select.appendChild(option);
            });
            var companies = data.companies || data;
            console.log(`成功加载了${companies.length}个${type}类型的公司`);
        } catch (error) {
            console.error(`加载${type}类型公司数据失败:`, error);
        }
    }

    // 初始化加载所有类型的公司数据
    loadCompanies('user', 'end_user');
    loadCompanies('designer', 'design_issues');
    loadCompanies('contractor', 'contractor');
    loadCompanies('integrator', 'system_integrator');
    loadCompanies('dealer', 'dealer');
    
    // 加载销售负责人数据
    loadSalesManagers();
});

// 加载销售负责人数据的函数
async function loadSalesManagers() {
    try {
        // 使用标准的用户层级API获取所有用户
        const response = await fetch('/api/users/hierarchical');
        const data = await response.json();
        
        const vendorSelect = document.getElementById('vendor_sales_manager_id');
        
        vendorSelect.innerHTML = '<option value="">请选择厂商销售负责人</option>';
        
        if (data.success && data.data) {
            // 按企业分组用户，根据企业的厂商标识过滤
            data.data.forEach(company => {
                // 使用is_vendor字段判断是否为厂商企业
                const isVendorCompany = company.is_vendor === true;
                
                if (company.users && company.users.length > 0) {
                    if (isVendorCompany) {
                        // 厂商下拉菜单：不显示企业级，只显示部门级和账户（账户包括真实姓名和角色）
                        company.users.forEach(user => {
                            const option = document.createElement('option');
                            option.value = user.id;
                            // 使用真实姓名和中文角色显示
                            const displayName = user.real_name || user.name;
                            const roleDisplay = user.role_display || user.role;
                            option.textContent = `${displayName} (${roleDisplay})`;
                            vendorSelect.appendChild(option);
                        });
                    }
                }
            });
        }
        
        // 如果当前用户是厂商企业的账户，自动选择当前用户作为厂商负责人  
        const currentUserIsVendor = {% if current_user.is_vendor_user() %}true{% else %}false{% endif %};
        const currentUserId = '{{ current_user.id }}';
        
        if (currentUserIsVendor && currentUserId) {
            vendorSelect.value = currentUserId;
        }
        
    } catch (error) {
        console.error('加载销售负责人数据失败:', error);
    }
}
</script>

{% endblock %}
