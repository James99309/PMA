<!-- 项目统计总览面板 -->
<div id="projectStatisticsPanel" class="project-statistics-panel collapse">
    <div class="card">
        <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
            <div class="d-flex align-items-center">
                <span><i class="fas fa-chart-bar me-1"></i> 项目统计总览</span>
            </div>
            <!-- 删除时间周期切换按钮组 -->
        </div>
        <div class="card-body">
            <div class="row">
                <!-- 加载中提示 -->
                <div id="statisticsLoading" class="col-12 text-center py-3">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">加载中...</span>
                    </div>
                    <p class="mt-2">正在加载统计数据...</p>
                </div>
                
                <!-- 统计内容容器 -->
                <div id="statisticsCards" class="col-12 d-none">
                    <!-- 项目统计概览 - 顶部水平展示 -->
                    <div class="d-flex flex-wrap gap-3 mb-4" style="justify-content: space-between;">
                        <!-- 有效项目总览卡片 -->
                        <div style="flex: 1; min-width: 200px;">
                            <div class="card border-0 shadow-sm h-100 bg-light" id="validProjectsCard" style="cursor:pointer;" onclick="filterValidProjects()">
                                <div class="card-body">
                                    <h6 class="card-title text-primary">
                                        <i class="fas fa-project-diagram me-1"></i> 有效项目
                                        <i class="fas fa-info-circle text-muted ms-1" 
                                           data-bs-toggle="tooltip" 
                                           title="当前有效的项目总数和总金额（排除失败、签约、搁置等状态）"></i>
                                    </h6>
                                    <div class="d-flex justify-content-between align-items-center mt-3">
                                        <div>
                                            <span class="fs-5 fw-bold" id="validProjectsCount">0</span>
                                            <span class="text-muted ms-1">项</span>
                                        </div>
                                        <div>
                                            <span class="fs-5 fw-bold" id="validProjectsAmount">0</span>
                                            <span class="text-muted ms-1">万元</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 招标项目卡片 -->
                        <div style="flex: 1; min-width: 200px;">
                            <div class="card border-0 shadow-sm h-100 bg-warning bg-opacity-10" id="tenderingProjectsCard" style="cursor:pointer;" onclick="filterTenderingProjects()">
                                <div class="card-body">
                                    <h6 class="card-title text-warning">
                                        <i class="fas fa-file-contract me-1"></i> 招标中
                                        <i class="fas fa-info-circle text-muted ms-1" 
                                           data-bs-toggle="tooltip" 
                                           title="当前处于招标阶段的项目统计"></i>
                                    </h6>
                                    <div class="d-flex justify-content-between align-items-center mt-3">
                                        <div>
                                            <span class="fs-5 fw-bold" id="tenderingProjectsCount">0</span>
                                            <span class="text-muted ms-1">项</span>
                                        </div>
                                        <div>
                                            <span class="fs-5 fw-bold" id="tenderingProjectsAmount">0</span>
                                            <span class="text-muted ms-1">万元</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 中标项目卡片 -->
                        <div style="flex: 1; min-width: 200px;">
                            <div class="card border-0 shadow-sm h-100 bg-success bg-opacity-10" id="wonProjectsCard" style="cursor:pointer;" onclick="filterWonProjects()">
                                <div class="card-body">
                                    <h6 class="card-title text-success">
                                        <i class="fas fa-award me-1"></i> 中标
                                        <i class="fas fa-info-circle text-muted ms-1" 
                                           data-bs-toggle="tooltip" 
                                           title="当前中标阶段的项目统计"></i>
                                    </h6>
                                    <div class="d-flex justify-content-between align-items-center mt-3">
                                        <div>
                                            <span class="fs-5 fw-bold" id="wonProjectsCount">0</span>
                                            <span class="text-muted ms-1">项</span>
                                        </div>
                                        <div>
                                            <span class="fs-5 fw-bold" id="wonProjectsAmount">0</span>
                                            <span class="text-muted ms-1">万元</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 批价项目卡片 -->
                        <div style="flex: 1; min-width: 200px;">
                            <div class="card border-0 shadow-sm h-100 bg-secondary bg-opacity-10" id="quotedProjectsCard" style="cursor:pointer;" onclick="filterQuotedProjects()">
                                <div class="card-body">
                                    <h6 class="card-title text-secondary">
                                        <i class="fas fa-file-invoice-dollar me-1"></i> 批价
                                        <i class="fas fa-info-circle text-muted ms-1" 
                                           data-bs-toggle="tooltip" 
                                           title="当前批价阶段的项目统计"></i>
                                    </h6>
                                    <div class="d-flex justify-content-between align-items-center mt-3">
                                        <div>
                                            <span class="fs-5 fw-bold" id="quotedProjectsCount">0</span>
                                            <span class="text-muted ms-1">项</span>
                                        </div>
                                        <div>
                                            <span class="fs-5 fw-bold" id="quotedProjectsAmount">0</span>
                                            <span class="text-muted ms-1">万元</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 业务推进卡片 -->
                        <div style="flex: 1; min-width: 200px;">
                            <div class="card border-0 shadow-sm h-100 bg-info bg-opacity-10" id="updatedProjectsCard" style="cursor:pointer;" onclick="filterUpdatedProjects()">
                                <div class="card-body">
                                    <h6 class="card-title text-info">
                                        <i class="fas fa-chart-line me-1"></i> 业务推进
                                        <i class="fas fa-info-circle text-muted ms-1" 
                                           data-bs-toggle="tooltip" 
                                           title="本月内项目状态有推进的统计"></i>
                                    </h6>
                                    <div class="d-flex justify-content-between align-items-center mt-3">
                                        <div>
                                            <span class="fs-5 fw-bold" id="updatedProjectsCount">0</span>
                                            <span class="text-muted ms-1">项</span>
                                        </div>
                                        <div>
                                            <span class="fs-5 fw-bold" id="updatedProjectsAmount">0</span>
                                            <span class="text-muted ms-1">万元</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 第二行：新增阶段选项卡 -->
                    <div class="d-flex flex-wrap gap-3 mb-4" style="justify-content: space-between;">
                        <!-- 发现阶段卡片 -->
                        <div style="flex: 1; min-width: 200px;">
                            <div class="card border-0 shadow-sm h-100 bg-primary bg-opacity-10" id="discoverProjectsCard" style="cursor:pointer;" onclick="filterDiscoverProjects()">
                                <div class="card-body">
                                    <h6 class="card-title text-primary">
                                        <i class="fas fa-search me-1"></i> 发现
                                        <i class="fas fa-info-circle text-muted ms-1" 
                                           data-bs-toggle="tooltip" 
                                           title="当前处于发现阶段的项目统计"></i>
                                    </h6>
                                    <div class="d-flex justify-content-between align-items-center mt-3">
                                        <div>
                                            <span class="fs-5 fw-bold" id="discoverProjectsCount">0</span>
                                            <span class="text-muted ms-1">项</span>
                                        </div>
                                        <div>
                                            <span class="fs-5 fw-bold" id="discoverProjectsAmount">0</span>
                                            <span class="text-muted ms-1">万元</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 植入阶段卡片 -->
                        <div style="flex: 1; min-width: 200px;">
                            <div class="card border-0 shadow-sm h-100 bg-info bg-opacity-10" id="embedProjectsCard" style="cursor:pointer;" onclick="filterEmbedProjects()">
                                <div class="card-body">
                                    <h6 class="card-title text-info">
                                        <i class="fas fa-seedling me-1"></i> 植入
                                        <i class="fas fa-info-circle text-muted ms-1" 
                                           data-bs-toggle="tooltip" 
                                           title="当前处于植入阶段的项目统计"></i>
                                    </h6>
                                    <div class="d-flex justify-content-between align-items-center mt-3">
                                        <div>
                                            <span class="fs-5 fw-bold" id="embedProjectsCount">0</span>
                                            <span class="text-muted ms-1">项</span>
                                        </div>
                                        <div>
                                            <span class="fs-5 fw-bold" id="embedProjectsAmount">0</span>
                                            <span class="text-muted ms-1">万元</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 招标前阶段卡片 -->
                        <div style="flex: 1; min-width: 200px;">
                            <div class="card border-0 shadow-sm h-100 bg-warning bg-opacity-10" id="preTenderProjectsCard" style="cursor:pointer;" onclick="filterPreTenderProjects()">
                                <div class="card-body">
                                    <h6 class="card-title text-warning">
                                        <i class="fas fa-clock me-1"></i> 招标前
                                        <i class="fas fa-info-circle text-muted ms-1" 
                                           data-bs-toggle="tooltip" 
                                           title="当前处于招标前阶段的项目统计"></i>
                                    </h6>
                                    <div class="d-flex justify-content-between align-items-center mt-3">
                                        <div>
                                            <span class="fs-5 fw-bold" id="preTenderProjectsCount">0</span>
                                            <span class="text-muted ms-1">项</span>
                                        </div>
                                        <div>
                                            <span class="fs-5 fw-bold" id="preTenderProjectsAmount">0</span>
                                            <span class="text-muted ms-1">万元</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 失败阶段卡片 -->
                        <div style="flex: 1; min-width: 200px;">
                            <div class="card border-0 shadow-sm h-100 bg-danger bg-opacity-10" id="lostProjectsCard" style="cursor:pointer;" onclick="filterLostProjects()">
                                <div class="card-body">
                                    <h6 class="card-title text-danger">
                                        <i class="fas fa-times-circle me-1"></i> 失败
                                        <i class="fas fa-info-circle text-muted ms-1" 
                                           data-bs-toggle="tooltip" 
                                           title="当前处于失败状态的项目统计"></i>
                                    </h6>
                                    <div class="d-flex justify-content-between align-items-center mt-3">
                                        <div>
                                            <span class="fs-5 fw-bold" id="lostProjectsCount">0</span>
                                            <span class="text-muted ms-1">项</span>
                                        </div>
                                        <div>
                                            <span class="fs-5 fw-bold" id="lostProjectsAmount">0</span>
                                            <span class="text-muted ms-1">万元</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 搁置阶段卡片 -->
                        <div style="flex: 1; min-width: 200px;">
                            <div class="card border-0 shadow-sm h-100 bg-secondary bg-opacity-10" id="pausedProjectsCard" style="cursor:pointer;" onclick="filterPausedProjects()">
                                <div class="card-body">
                                    <h6 class="card-title text-secondary">
                                        <i class="fas fa-pause-circle me-1"></i> 搁置
                                        <i class="fas fa-info-circle text-muted ms-1" 
                                           data-bs-toggle="tooltip" 
                                           title="当前处于搁置状态的项目统计"></i>
                                    </h6>
                                    <div class="d-flex justify-content-between align-items-center mt-3">
                                        <div>
                                            <span class="fs-5 fw-bold" id="pausedProjectsCount">0</span>
                                            <span class="text-muted ms-1">项</span>
                                        </div>
                                        <div>
                                            <span class="fs-5 fw-bold" id="pausedProjectsAmount">0</span>
                                            <span class="text-muted ms-1">万元</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 阶段分布和趋势统计 - 水平布局 -->
                    <div class="row">
                        <!-- 左侧阶段分布区域 (40%) -->
                        <div class="col-md-5">
                            <div class="card border-0 shadow-sm mb-3">
                                <div class="card-body">
                                    <h6 class="card-title text-primary mb-3">阶段分布统计</h6>
                                    <div id="stageDistributionChart" style="height: 350px; min-height: 250px;">
                                        <div class="text-center py-5">
                                            <div class="spinner-border text-primary" role="status">
                                                <span class="visually-hidden">加载中...</span>
                                            </div>
                                            <p class="mt-2">正在加载图表数据...</p>
                                        </div>
                                    </div>
                                    <!-- 切换器 -->
                                    <div class="text-center mt-2">
                                        <span class="chart-toggle-dot active" data-chart-type="count" title="项目数量分布"></span>
                                        <span class="chart-toggle-dot" data-chart-type="amount" title="项目金额分布"></span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 右侧趋势区域 (60%) -->
                        <div class="col-md-7">
                            <div class="card border-0 shadow-sm">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-center mb-3">
                                        <h6 class="card-title text-primary mb-0">阶段趋势分析</h6>
                                        <div>
                                            <div class="btn-group btn-group-sm" role="group">
                                                <button type="button" class="btn btn-outline-primary trend-period-btn active" data-period="week">周趋势</button>
                                                <button type="button" class="btn btn-outline-primary trend-period-btn" data-period="month">月趋势</button>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- 趋势图表容器 -->
                                    <div id="stageTrendChart" style="height: 300px; min-height: 250px;">
                                        <div class="text-center py-5">
                                            <div class="spinner-border text-primary" role="status">
                                                <span class="visually-hidden">加载中...</span>
                                            </div>
                                            <p class="mt-2">正在加载趋势数据...</p>
                                        </div>
                                    </div>
                                    
                                    <!-- 阶段切换器 -->
                                    <div class="text-center mt-3">
                                        <div id="stageTrendToggle" class="stage-toggle-container">
                                            <!-- 动态生成阶段切换点 -->
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 错误提示 -->
                <div id="statisticsError" class="col-12 d-none">
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <span id="errorMessage">加载统计数据失败</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>


<style>
/* 项目统计面板样式 */
.project-statistics-panel {
    margin-bottom: 20px;
}



.project-statistics-panel .card {
    border: none;
    box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
    transition: all 0.2s ease-in-out;
}

.project-statistics-panel .card:hover {
    transform: translateY(-2px);
    box-shadow: 0 0.25rem 0.5rem rgba(0, 0, 0, 0.1);
}

.project-statistics-panel .card-header {
    padding: 0.75rem 1rem;
}

.project-statistics-panel .period-btn,
.project-statistics-panel .trend-period-btn {
    font-size: 0.75rem;
    padding: 0.25rem 0.5rem;
}

.project-statistics-panel .period-btn.active,
.project-statistics-panel .trend-period-btn.active {
    background-color: white;
    color: #0d6efd;
}

/* 统计卡片样式 */
.project-statistics-panel .card-body {
    padding: 1rem;
}

.project-statistics-panel .card-title {
    margin-bottom: 0;
    font-size: 0.9rem;
    font-weight: 600;
}

/* 数字格式化 */
.project-statistics-panel .fs-5 {
    font-size: 1.25rem!important;
}

/* 动画效果 */
.project-statistics-panel.collapsing {
    transition: height .35s ease;
}

/* 图表切换点样式 */
.chart-toggle-dot {
    display: inline-block;
    width: 14px;
    height: 14px;
    margin: 0 8px;
    border-radius: 50%;
    border: 2px solid #1890ff;
    background: #fff;
    cursor: pointer;
    transition: background 0.3s, box-shadow 0.3s;
    box-shadow: 0 0 0 0 rgba(24,144,255,0.2);
    position: relative;
    top: -10px;
}
.chart-toggle-dot.active {
    background: #1890ff;
    box-shadow: 0 0 0 6px rgba(24,144,255,0.12);
    border-color: #1890ff;
    animation: dotPulse 0.4s;
}

/* 阶段切换点样式 */
.stage-toggle-container {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    gap: 12px;
}
.stage-toggle-dot {
    display: inline-block;
    width: 16px;
    height: 16px;
    border-radius: 50%;
    cursor: pointer;
    transition: transform 0.3s, box-shadow 0.3s;
    box-shadow: 0 0 0 0 rgba(24,144,255,0.2);
    position: relative;
    border: 2px solid transparent;
}
.stage-toggle-dot.active {
    transform: scale(1.2);
    box-shadow: 0 0 0 4px rgba(24,144,255,0.12);
    animation: dotPulse 0.4s;
    border-color: #fff;
}
.stage-toggle-dot:hover {
    transform: scale(1.1);
}

.stage-toggle-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    margin: 0 5px;
    cursor: pointer;
}

.stage-toggle-label {
    font-size: 11px;
    margin-top: 4px;
    white-space: nowrap;
    transition: all 0.3s;
}

.stage-toggle-label.active {
    font-weight: bold;
}

@keyframes dotPulse {
    0% { box-shadow: 0 0 0 0 rgba(24,144,255,0.2); }
    70% { box-shadow: 0 0 0 8px rgba(24,144,255,0.12); }
    100% { box-shadow: 0 0 0 0 rgba(24,144,255,0.2); }
}

/* 趋势图控制样式 */
.trend-controls {
    margin-top: 5px;
    padding: 5px;
    display: none; /* 隐藏控制按钮 */
}

.trend-controls button {
    display: none; /* 隐藏控制按钮 */
}

/* 确保ECharts滚动条可见 */
.project-statistics-panel .card-body .datazoom-slider-horizontal {
    height: 25px !important;
    margin-top: 10px;
}

/* 图表区域增加过渡效果 */
#stageTrendChart {
    transition: all 0.3s ease;
}

/* 添加账户选择器相关CSS样式 */
.account-selector .dropdown-toggle {
    min-width: 120px;
    text-align: left;
}

.account-selector .dropdown-menu {
    max-height: 300px;
    overflow-y: auto;
}

/* 点击反馈效果 */
@keyframes pulse {
    0% { transform: scale(1); }
    50% { transform: scale(0.98); }
    100% { transform: scale(1); }
}

.pulse-effect {
    animation: pulse 0.3s ease-in-out;
}

/* 卡片过滤激活状态 */
.card.active-filter {
    box-shadow: 0 0.25rem 0.5rem rgba(0, 0, 0, 0.15) !important;
}

/* 有效项目卡片激活样式 */
#validProjectsCard.active-filter {
    background-color: #e6f0f5 !important;
    border-left: 4px solid #0d6efd !important;
}

/* 招标中项目卡片激活样式 */
#tenderingProjectsCard.active-filter {
    background-color: #fff8e6 !important;
    border-left: 4px solid #ffc107 !important;
}

/* 中标项目卡片激活样式 */
#wonProjectsCard.active-filter {
    background-color: #e6f5ec !important;
    border-left: 4px solid #198754 !important;
}

/* 业务推进卡片激活样式 */
#updatedProjectsCard.active-filter {
    background-color: #e6f5f9 !important;
    border-left: 4px solid #0dcaf0 !important;
}

/* 阶段选项卡选中状态样式 */
.stage-card-selected {
    border-left: 4px solid #0d6efd !important;
    background-color: rgba(13, 110, 253, 0.05) !important;
    transform: translateX(2px);
    transition: all 0.3s ease;
}

/* 各个阶段卡片的选中状态样式 */
#discoverProjectsCard.stage-card-selected {
    border-left: 4px solid #0d6efd !important;
    background-color: rgba(13, 110, 253, 0.08) !important;
}

#embedProjectsCard.stage-card-selected {
    border-left: 4px solid #0dcaf0 !important;
    background-color: rgba(13, 202, 240, 0.08) !important;
}

#preTenderProjectsCard.stage-card-selected {
    border-left: 4px solid #ffc107 !important;
    background-color: rgba(255, 193, 7, 0.08) !important;
}

#tenderingProjectsCard.stage-card-selected {
    border-left: 4px solid #ffc107 !important;
    background-color: rgba(255, 193, 7, 0.08) !important;
}

#wonProjectsCard.stage-card-selected {
    border-left: 4px solid #198754 !important;
    background-color: rgba(25, 135, 84, 0.08) !important;
}

#quotedProjectsCard.stage-card-selected {
    border-left: 4px solid #6c757d !important;
    background-color: rgba(108, 117, 125, 0.08) !important;
}

#lostProjectsCard.stage-card-selected {
    border-left: 4px solid #dc3545 !important;
    background-color: rgba(220, 53, 69, 0.08) !important;
}

#pausedProjectsCard.stage-card-selected {
    border-left: 4px solid #6c757d !important;
    background-color: rgba(108, 117, 125, 0.08) !important;
}
</style>

<!-- 统计脚本在此处 -->
<script>
/**
 * 过滤有效项目函数，点击有效项目卡片时触发
 * 有效项目定义为：有授权的项目，且状态不在失败、搁置和成功的项目
 */
function filterValidProjects() {
    // 点击反馈效果
    const card = document.getElementById('validProjectsCard');
    
    // 添加动画效果
    if (card) {
        card.classList.add('pulse-effect');
        setTimeout(() => {
            card.classList.remove('pulse-effect');
        }, 300);
        
        // 检查当前URL是否已经应用了有效项目过滤
        const currentUrl = new URL(window.location.href);
        const params = new URLSearchParams(currentUrl.search);
        const hasAuthFilter = params.get('filter_has_authorization') === '1';
        const stageNotFilter = params.get('filter_stage_not') === 'lost,paused,signed';
        
        // 如果已经应用了过滤，则取消过滤（切换状态）
        if (hasAuthFilter && stageNotFilter) {
            // 移除有效项目的过滤条件
            params.delete('filter_has_authorization');
            params.delete('filter_stage_not');
            
            // 移除卡片的活跃状态
            card.classList.remove('active-filter');
            
            // 保持统计面板打开状态
            params.set('keep_panel', 'true');
            
            // 重新加载页面以应用筛选条件
            window.location.href = '/project/?' + params.toString();
            return;
        }
        
        // 添加卡片的活跃状态
        card.classList.add('active-filter');
    }
    
    // 构建查询参数，确保包含当前的其他查询条件
    const currentUrl = new URL(window.location.href);
    const params = new URLSearchParams(currentUrl.search);
    
    // 添加有效项目的过滤条件
    params.set('filter_has_authorization', '1');  // 有授权编号
    
    // 排除失败、搁置和成功的阶段
    params.set('filter_stage_not', 'lost,paused,signed');
    
    // 保持统计面板打开状态
    params.set('keep_panel', 'true');
    
    // 重新加载页面以应用筛选条件
    window.location.href = '/project/?' + params.toString();
}

/**
 * 过滤发现阶段项目函数
 */
function filterDiscoverProjects() {
    filterProjectsByStage('discover', 'discoverProjectsCard');
}

/**
 * 过滤植入阶段项目函数
 */
function filterEmbedProjects() {
    filterProjectsByStage('embed', 'embedProjectsCard');
}

/**
 * 过滤招标前阶段项目函数
 */
function filterPreTenderProjects() {
    filterProjectsByStage('pre_tender', 'preTenderProjectsCard');
}

/**
 * 过滤失败阶段项目函数
 */
function filterLostProjects() {
    filterProjectsByStage('lost', 'lostProjectsCard');
}

/**
 * 过滤搁置阶段项目函数
 */
function filterPausedProjects() {
    filterProjectsByStage('paused', 'pausedProjectsCard');
}

/**
 * 通用阶段筛选函数
 */
function filterProjectsByStage(stage, cardId) {
    // 点击反馈效果
    const card = document.getElementById(cardId);
    
    // 添加动画效果
    if (card) {
        card.classList.add('pulse-effect');
        setTimeout(() => {
            card.classList.remove('pulse-effect');
        }, 300);
        
        // 检查当前URL是否已经应用了该阶段过滤
        const currentUrl = new URL(window.location.href);
        const params = new URLSearchParams(currentUrl.search);
        const hasCurrentStageFilter = params.get('filter_current_stage') === stage;
        
        // 移除所有阶段卡片的选中状态
        const allStageCards = [
            'discoverProjectsCard', 'embedProjectsCard', 'preTenderProjectsCard',
            'tenderingProjectsCard', 'wonProjectsCard', 'quotedProjectsCard',
            'lostProjectsCard', 'pausedProjectsCard'
        ];
        allStageCards.forEach(id => {
            const stageCard = document.getElementById(id);
            if (stageCard) {
                stageCard.classList.remove('stage-card-selected');
                stageCard.classList.remove('active-filter');
            }
        });
        
        // 如果已经应用了过滤，则取消过滤（切换状态）
        if (hasCurrentStageFilter) {
            // 移除该阶段的过滤条件
            params.delete('filter_current_stage');
            
            // 保持统计面板打开状态
            params.set('keep_panel', 'true');
            
            // 重新加载页面以应用筛选条件
            window.location.href = '/project/?' + params.toString();
            return;
        }
        
        // 添加当前卡片的选中状态
        card.classList.add('stage-card-selected');
        card.classList.add('active-filter');
    }
    
    // 构建查询参数，确保包含当前的其他查询条件
    const currentUrl = new URL(window.location.href);
    const params = new URLSearchParams(currentUrl.search);
    
    // 移除可能存在的其他状态过滤器
    params.delete('filter_current_stage');
    
    // 添加该阶段的过滤条件
    params.set('filter_current_stage', stage);
    
    // 保持统计面板打开状态
    params.set('keep_panel', 'true');
    
    // 重新加载页面以应用筛选条件
    window.location.href = '/project/?' + params.toString();
}

/**
 * 过滤招标中项目函数，点击招标中卡片时触发
 */
function filterTenderingProjects() {
    filterProjectsByStage('tendering', 'tenderingProjectsCard');
}

/**
 * 过滤中标项目函数，点击中标卡片时触发
 */
function filterWonProjects() {
    filterProjectsByStage('awarded', 'wonProjectsCard');
}

/**
 * 过滤业务推进项目函数，点击业务推进卡片时触发
 * 业务推进项目定义为：本月内阶段有变更的项目
 */
function filterUpdatedProjects() {
    console.log("业务推进筛选函数被调用");
    
    // 点击反馈效果
    const card = document.getElementById('updatedProjectsCard');
    
    // 添加动画效果
    if (card) {
        card.classList.add('pulse-effect');
        setTimeout(() => {
            card.classList.remove('pulse-effect');
        }, 300);
        
        // 检查当前URL是否已经应用了业务推进过滤
        const currentUrl = new URL(window.location.href);
        const params = new URLSearchParams(currentUrl.search);
        const hasUpdatedFilter = params.get('filter_updated_this_month') === '1';
        
        console.log("当前URL中是否有业务推进筛选:", hasUpdatedFilter);
        
        // 如果已经应用了过滤，则取消过滤（切换状态）
        if (hasUpdatedFilter) {
            console.log("取消业务推进筛选");
            // 移除业务推进的过滤条件
            params.delete('filter_updated_this_month');
            
            // 移除卡片的活跃状态
            card.classList.remove('active-filter');
            
            // 保持统计面板打开状态
            params.set('keep_panel', 'true');
            
            // 重新加载页面以应用筛选条件
            window.location.href = '/project/?' + params.toString();
            return;
        }
        
        console.log("应用业务推进筛选");
        // 添加卡片的活跃状态
        card.classList.add('active-filter');
    }
    
    // 构建查询参数，确保包含当前的其他查询条件
    const currentUrl = new URL(window.location.href);
    const params = new URLSearchParams(currentUrl.search);
    
    // 添加业务推进的过滤条件
    params.set('filter_updated_this_month', '1');
    
    // 保持统计面板打开状态
    params.set('keep_panel', 'true');
    
    // 重新加载页面以应用筛选条件
    window.location.href = '/project/?' + params.toString();
}

/**
 * 过滤批价项目函数，点击批价卡片时触发
 */
function filterQuotedProjects() {
    filterProjectsByStage('quoted', 'quotedProjectsCard');
}

/**
 * 恢复所有记录显示的函数，在释放筛选时调用
 */
function restoreAllRecords() {
    console.log("restoreAllRecords函数被调用"); // 调试日志
    // 获取所有表格行和移动端卡片
    const tableRows = document.querySelectorAll('.table tbody tr');
    const mobileCards = document.querySelectorAll('.d-block.d-lg-none .card');
    const tableBody = document.querySelector('.table tbody');
    const mobileContainer = document.querySelector('.d-block.d-lg-none');
    
    // 按更新时间降序排序的函数
    const sortByUpdatedAtDesc = (a, b) => {
        // 尝试从元素中获取更新时间
        const getUpdatedAt = (el) => {
            // 从表格行中提取更新时间（假设在倒数第二列）
            if (!el.classList.contains('card')) {
                // PC端表格视图
                const cells = el.querySelectorAll('td');
                if (cells.length > 2) {
                    const updatedAtCell = cells[cells.length - 2]; // 倒数第二列是更新时间
                    if (updatedAtCell) {
                        const dateText = updatedAtCell.textContent.trim();
                        if (dateText) {
                            return new Date(dateText).getTime();
                        }
                    }
                }
            } else {
                // 移动端卡片视图
                const updatedAtText = el.textContent.match(/更新: (\d{4}-\d{2}-\d{2})/);
                if (updatedAtText && updatedAtText[1]) {
                    return new Date(updatedAtText[1]).getTime();
                }
            }
            return 0; // 默认时间戳
        };
        
        const updatedAtA = getUpdatedAt(a);
        const updatedAtB = getUpdatedAt(b);
        return updatedAtB - updatedAtA; // 降序排列（新到旧）
    };
    
    // 复制所有行和卡片到数组
    const allRows = Array.from(tableRows);
    const allCards = Array.from(mobileCards);
    
    // 按更新时间排序
    allRows.sort(sortByUpdatedAtDesc);
    allCards.sort(sortByUpdatedAtDesc);
    
    // 重新排列表格行
    if (tableBody) {
        // 清空表格
        while (tableBody.firstChild) {
            tableBody.removeChild(tableBody.firstChild);
        }
        
        // 添加所有行
        allRows.forEach(row => {
            row.classList.remove('filtered');
            row.style.display = '';
            tableBody.appendChild(row);
        });
    }
    
    // 重新排列移动端卡片
    if (mobileContainer) {
        // 保存所有非卡片元素
        const nonCardElements = Array.from(mobileContainer.children).filter(el => 
            !el.classList.contains('card')
        );
        
        // 清空容器
        while (mobileContainer.firstChild) {
            mobileContainer.removeChild(mobileContainer.firstChild);
        }
        
        // 首先添加非卡片元素
        nonCardElements.forEach(el => {
            mobileContainer.appendChild(el);
        });
        
        // 添加所有卡片
        allCards.forEach(card => {
            card.classList.remove('filtered');
            card.style.display = '';
            mobileContainer.appendChild(card);
        });
    }
    
    // 确保没有其他筛选状态
    const activeFilters = document.querySelectorAll('.active-filter');
    activeFilters.forEach(filter => {
        filter.classList.remove('active-filter');
    });
    
    // 应用空筛选条件，确保所有记录显示
    clientSideFilter({});
    
    // 触发按钮状态更新
    triggerFilterStatusUpdate();
}

// 页面加载时检查URL并设置卡片状态
document.addEventListener('DOMContentLoaded', function() {
    const validProjectsCard = document.getElementById('validProjectsCard');
    const tenderingProjectsCard = document.getElementById('tenderingProjectsCard');
    const wonProjectsCard = document.getElementById('wonProjectsCard');
    const quotedProjectsCard = document.getElementById('quotedProjectsCard');
    const updatedProjectsCard = document.getElementById('updatedProjectsCard');
    
    // 新增的阶段卡片
    const discoverProjectsCard = document.getElementById('discoverProjectsCard');
    const embedProjectsCard = document.getElementById('embedProjectsCard');
    const preTenderProjectsCard = document.getElementById('preTenderProjectsCard');
    const lostProjectsCard = document.getElementById('lostProjectsCard');
    const pausedProjectsCard = document.getElementById('pausedProjectsCard');
    
    // 获取URL参数
    const params = new URLSearchParams(window.location.search);
    const hasAuthFilter = params.get('filter_has_authorization') === '1';
    const stageNotFilter = params.get('filter_stage_not') === 'lost,paused,signed';
    const currentStageFilter = params.get('filter_current_stage');
    const updatedThisMonthFilter = params.get('filter_updated_this_month') === '1';
    
    // 设置有效项目卡片状态
    if (validProjectsCard) {
        if (hasAuthFilter && stageNotFilter) {
            validProjectsCard.classList.add('active-filter');
        } else {
            validProjectsCard.classList.remove('active-filter');
        }
    }
    
    // 移除所有阶段卡片的选中状态
    const allStageCards = [tenderingProjectsCard, wonProjectsCard, quotedProjectsCard, 
                          discoverProjectsCard, embedProjectsCard, preTenderProjectsCard, 
                          lostProjectsCard, pausedProjectsCard];
    
    allStageCards.forEach(card => {
        if (card) {
            card.classList.remove('active-filter');
            card.classList.remove('stage-card-selected');
        }
    });
    
    // 根据当前阶段过滤器设置对应的卡片选中状态
    if (currentStageFilter) {
        const stageToCardMap = {
            'tendering': tenderingProjectsCard,
            'awarded': wonProjectsCard,
            'quoted': quotedProjectsCard,
            'discover': discoverProjectsCard,
            'embed': embedProjectsCard,
            'pre_tender': preTenderProjectsCard,
            'lost': lostProjectsCard,
            'paused': pausedProjectsCard
        };
        
        const selectedCard = stageToCardMap[currentStageFilter];
        if (selectedCard) {
            selectedCard.classList.add('active-filter');
            selectedCard.classList.add('stage-card-selected');
        }
    }
    
    // 设置业务推进卡片状态
    if (updatedProjectsCard) {
        if (updatedThisMonthFilter) {
            updatedProjectsCard.classList.add('active-filter');
        } else {
            updatedProjectsCard.classList.remove('active-filter');
        }
    }
});

// 添加页面加载时检查卡片状态的函数
document.addEventListener('DOMContentLoaded', function() {
    // 检查有效项目卡片
    checkCardActiveState('validProjectsCard', ['filter_has_authorization', 'filter_stage_not'], ['1', 'lost,paused,signed']);
    
    // 检查招标中卡片
    checkCardActiveState('tenderingProjectsCard', ['filter_current_stage'], ['tendering']);
    
    // 检查中标卡片
    checkCardActiveState('wonProjectsCard', ['filter_current_stage'], ['awarded']);
    
    // 检查业务推进卡片
    checkCardActiveState('updatedProjectsCard', ['filter_updated_this_month'], ['1']);
});

/**
 * 客户端过滤函数，处理各种过滤条件
 * @param {Object} filters - 过滤条件对象
 */
function clientSideFilter(filters) {
    // 获取所有表格行和移动端卡片
    const tableRows = document.querySelectorAll('.table tbody tr');
    const mobileCards = document.querySelectorAll('.d-block.d-lg-none .card');
    const tableBody = document.querySelector('.table tbody');
    const mobileContainer = document.querySelector('.d-block.d-lg-none');
    
    // 如果没有过滤条件，则直接恢复所有行和卡片的显示
    if (!filters || Object.keys(filters).length === 0) {
        // 按更新时间对所有行和卡片进行排序
        const sortByUpdatedAtDesc = (a, b) => {
            // 尝试从元素中获取更新时间
            const getUpdatedAt = (el) => {
                // 从表格行中提取更新时间（假设在倒数第二列）
                if (!el.classList.contains('card')) {
                    // PC端表格视图
                    const cells = el.querySelectorAll('td');
                    if (cells.length > 2) {
                        const updatedAtCell = cells[cells.length - 2]; // 倒数第二列是更新时间
                        if (updatedAtCell) {
                            const dateText = updatedAtCell.textContent.trim();
                            if (dateText) {
                                return new Date(dateText).getTime();
                            }
                        }
                    }
                } else {
                    // 移动端卡片视图
                    const updatedAtText = el.textContent.match(/更新: (\d{4}-\d{2}-\d{2})/);
                    if (updatedAtText && updatedAtText[1]) {
                        return new Date(updatedAtText[1]).getTime();
                    }
                }
                return 0; // 默认时间戳
            };
            
            const updatedAtA = getUpdatedAt(a);
            const updatedAtB = getUpdatedAt(b);
            return updatedAtB - updatedAtA; // 降序排列（新到旧）
        };
        
        // 复制所有行和卡片到数组
        const allRows = Array.from(tableRows);
        const allCards = Array.from(mobileCards);
        
        // 按更新时间排序
        allRows.sort(sortByUpdatedAtDesc);
        allCards.sort(sortByUpdatedAtDesc);
        
        // 重新排列表格行
        if (tableBody) {
            // 清空表格
            while (tableBody.firstChild) {
                tableBody.removeChild(tableBody.firstChild);
            }
            
            // 添加所有行
            allRows.forEach(row => {
                row.classList.remove('filtered');
                row.style.display = '';
                tableBody.appendChild(row);
            });
        }
        
        // 重新排列移动端卡片
        if (mobileContainer) {
            // 保存所有非卡片元素
            const nonCardElements = Array.from(mobileContainer.children).filter(el => 
                !el.classList.contains('card')
            );
            
            // 清空容器
            while (mobileContainer.firstChild) {
                mobileContainer.removeChild(mobileContainer.firstChild);
            }
            
            // 首先添加非卡片元素
            nonCardElements.forEach(el => {
                mobileContainer.appendChild(el);
            });
            
            // 添加所有卡片
            allCards.forEach(card => {
                card.classList.remove('filtered');
                card.style.display = '';
                mobileContainer.appendChild(card);
            });
        }
        
        // 触发list.html中的按钮状态更新
        triggerFilterStatusUpdate();
        return;
    }
    
    // 用于存储筛选后的行和卡片
    const matchedRows = [];
    const filteredRows = [];
    const matchedCards = [];
    const filteredCards = [];
    
    // 过滤表格行
    tableRows.forEach(row => {
        let shouldFilter = false;
        
        // 检查"有授权"过滤条件
        if (filters.hasAuthorization) {
            const authCell = row.querySelector('td:nth-child(3)'); // 授权编号单元格
            if (authCell) {
                // 检查是否有授权编号（不含"未申请"或"审批中"等标记）
                const hasNoAuth = authCell.textContent.includes('未申请') || 
                                 authCell.textContent.includes('审批中') ||
                                 authCell.textContent.includes('已驳回');
                if (hasNoAuth) {
                    shouldFilter = true;
                }
            }
        }
        
        // 检查"阶段不在"过滤条件
        if (filters.stageNot && filters.stageNot.length) {
            const stageCell = row.querySelector('td:nth-child(5)'); // 当前阶段单元格
            if (stageCell) {
                const stageName = stageCell.textContent.trim();
                if (filters.stageNot.some(stage => {
                    if (stage === 'lost') return stageName.includes('失败');
                    if (stage === 'paused') return stageName.includes('搁置');
                    if (stage === 'signed') return stageName.includes('签约');
                    return false;
                })) {
                    shouldFilter = true;
                }
            }
        }
        
        // 检查"当前阶段"过滤条件
        if (filters.currentStage) {
            const stageCell = row.querySelector('td:nth-child(5)'); // 当前阶段单元格
            if (stageCell) {
                const stageName = stageCell.textContent.trim();
                let match = false;
                
                if (filters.currentStage === 'discover' && stageName.includes('发现')) {
                    match = true;
                } else if (filters.currentStage === 'embed' && stageName.includes('植入')) {
                    match = true;
                } else if (filters.currentStage === 'pre_tender' && stageName.includes('招标前')) {
                    match = true;
                } else if (filters.currentStage === 'tendering' && stageName.includes('招标中')) {
                    match = true;
                } else if (filters.currentStage === 'awarded' && stageName.includes('中标')) {
                    match = true;
                } else if (filters.currentStage === 'quoted' && stageName.includes('批价')) {
                    match = true;
                } else if (filters.currentStage === 'lost' && stageName.includes('失败')) {
                    match = true;
                } else if (filters.currentStage === 'paused' && stageName.includes('搁置')) {
                    match = true;
                }
                
                if (!match) {
                    shouldFilter = true;
                }
            }
        }
        
        // 检查"本月更新"过滤条件
        if (filters.updatedThisMonth) {
            // 对PC端表格行，使用更精确的单元格选择策略
            const updatedAtCell = row.querySelector('td:nth-last-child(2)'); // 倒数第二列是更新时间
            
            if (updatedAtCell) {
                const dateText = updatedAtCell.textContent.trim();
                console.log("PC表格行更新时间单元格内容:", dateText);
                
                if (dateText) {
                    // 解析日期
                    try {
                        const updatedDate = new Date(dateText);
                        const now = new Date();
                        
                        // 检查是否为本月更新
                        const isCurrentMonth = updatedDate.getMonth() === now.getMonth() && 
                                             updatedDate.getFullYear() === now.getFullYear();
                        
                        console.log("PC表格行更新时间检查:", dateText, 
                            "原始日期对象:", updatedDate,
                            "是否本月:", isCurrentMonth, 
                            "更新月份:", updatedDate.getMonth() + 1, 
                            "当前月份:", now.getMonth() + 1);
                        
                        if (!isCurrentMonth) {
                            shouldFilter = true;
                        }
                    } catch (e) {
                        console.error("PC表格行日期解析错误:", dateText, e);
                        shouldFilter = true;
                    }
                } else {
                    // 如果没有更新日期，则过滤掉
                    console.warn("PC表格行更新时间单元格存在但内容为空");
                    shouldFilter = true;
                }
            } else {
                // 如果找不到更新时间单元格，则过滤掉
                console.warn("未找到PC表格行更新时间单元格");
                shouldFilter = true;
            }
        }
        
        // 根据筛选结果，将行分到匹配或过滤集合中
        if (shouldFilter) {
            row.classList.add('filtered');
            filteredRows.push(row);
        } else {
            row.classList.remove('filtered');
            matchedRows.push(row);
        }
    });
    
    // 过滤移动端卡片
    mobileCards.forEach(card => {
        let shouldFilter = false;
        
        // 检查"有授权"过滤条件
        if (filters.hasAuthorization) {
            const authBadge = card.querySelector('.badge:first-child');
            if (authBadge) {
                // 检查是否有授权编号（不含"未申请"或"审批中"等标记）
                const hasNoAuth = authBadge.textContent.includes('未申请') || 
                                 authBadge.textContent.includes('审批中') ||
                                 authBadge.textContent.includes('已驳回');
                if (hasNoAuth) {
                    shouldFilter = true;
                }
            }
        }
        
        // 检查"阶段不在"过滤条件
        if (filters.stageNot && filters.stageNot.length) {
            const stageBadge = card.querySelector('.badge:nth-child(2)');
            if (stageBadge) {
                const stageName = stageBadge.textContent.trim();
                if (filters.stageNot.some(stage => {
                    if (stage === 'lost') return stageName.includes('失败');
                    if (stage === 'paused') return stageName.includes('搁置');
                    if (stage === 'signed') return stageName.includes('签约');
                    return false;
                })) {
                    shouldFilter = true;
                }
            }
        }
        
        // 检查"当前阶段"过滤条件
        if (filters.currentStage) {
            const stageBadge = card.querySelector('.badge:nth-child(2)');
            if (stageBadge) {
                const stageName = stageBadge.textContent.trim();
                let match = false;
                
                if (filters.currentStage === 'discover' && stageName.includes('发现')) {
                    match = true;
                } else if (filters.currentStage === 'embed' && stageName.includes('植入')) {
                    match = true;
                } else if (filters.currentStage === 'pre_tender' && stageName.includes('招标前')) {
                    match = true;
                } else if (filters.currentStage === 'tendering' && stageName.includes('招标中')) {
                    match = true;
                } else if (filters.currentStage === 'awarded' && stageName.includes('中标')) {
                    match = true;
                } else if (filters.currentStage === 'quoted' && stageName.includes('批价')) {
                    match = true;
                } else if (filters.currentStage === 'lost' && stageName.includes('失败')) {
                    match = true;
                } else if (filters.currentStage === 'paused' && stageName.includes('搁置')) {
                    match = true;
                }
                
                if (!match) {
                    shouldFilter = true;
                }
            }
        }
        
        // 检查"本月更新"过滤条件
        if (filters.updatedThisMonth) {
            // 首先尝试找到更新日期的DOM元素
            let dateElement = card.querySelector('.small.text-muted:last-child');
            let dateText = '';
            
            if (dateElement) {
                dateText = dateElement.textContent.trim();
                console.log("移动卡片找到更新日期元素:", dateText);
                
                // 使用正则提取日期部分
                const dateMatch = dateText.match(/更新:\s*(\d{4}-\d{2}-\d{2}(?:\s+\d{2}:\d{2})?)/);
                if (dateMatch && dateMatch[1]) {
                    dateText = dateMatch[1].trim();
                }
            }
            
            // 如果找不到更新日期元素，尝试从整个卡片文本中匹配
            if (!dateText) {
                const updatedTextMatch = card.textContent.match(/更新:\s*(\d{4}-\d{2}-\d{2}(?:\s+\d{2}:\d{2})?)/);
                if (updatedTextMatch && updatedTextMatch[1]) {
                    dateText = updatedTextMatch[1].trim();
                }
                console.log("从卡片文本中提取的更新日期:", dateText);
            }
            
            if (dateText) {
                // 解析日期
                try {
                    const updatedDate = new Date(dateText);
                    const now = new Date();
                    
                    // 检查是否为本月更新
                    const isCurrentMonth = updatedDate.getMonth() === now.getMonth() && 
                                         updatedDate.getFullYear() === now.getFullYear();
                    
                    console.log("移动卡片更新时间检查:", dateText, 
                        "原始日期对象:", updatedDate,
                        "是否本月:", isCurrentMonth, 
                        "更新月份:", updatedDate.getMonth() + 1, 
                        "当前月份:", now.getMonth() + 1);
                    
                    if (!isCurrentMonth) {
                        shouldFilter = true;
                    }
                } catch (e) {
                    console.error("移动卡片日期解析错误:", dateText, e);
                    shouldFilter = true;
                }
            } else {
                // 如果没有找到更新日期，则过滤掉
                console.warn("移动卡片未找到更新日期");
                shouldFilter = true;
            }
        }
        
        // 根据筛选结果，将卡片分到匹配或过滤集合中
        if (shouldFilter) {
            card.classList.add('filtered');
            filteredCards.push(card);
        } else {
            card.classList.remove('filtered');
            matchedCards.push(card);
        }
    });
    
    // 重新排列表格行：匹配的行在前，被过滤的行不显示
    if (tableBody) {
        // 清空表格
        while (tableBody.firstChild) {
            tableBody.removeChild(tableBody.firstChild);
        }
        
        // 添加匹配的行
        matchedRows.forEach(row => {
            tableBody.appendChild(row);
            row.style.display = '';
        });
        
        // 被过滤的行不显示，但仍保留在DOM中
        filteredRows.forEach(row => {
            row.style.display = 'none';
            tableBody.appendChild(row);
        });
    }
    
    // 重新排列移动端卡片：匹配的卡片在前，被过滤的卡片不显示
    if (mobileContainer) {
        // 保存所有非卡片元素
        const nonCardElements = Array.from(mobileContainer.children).filter(el => 
            !el.classList.contains('card')
        );
        
        // 清空容器
        while (mobileContainer.firstChild) {
            mobileContainer.removeChild(mobileContainer.firstChild);
        }
        
        // 首先添加非卡片元素（如警告、提示等）
        nonCardElements.forEach(el => {
            mobileContainer.appendChild(el);
        });
        
        // 添加匹配的卡片
        matchedCards.forEach(card => {
            mobileContainer.appendChild(card);
            card.style.display = '';
        });
        
        // 被过滤的卡片不显示，但仍保留在DOM中
        filteredCards.forEach(card => {
            card.style.display = 'none';
            mobileContainer.appendChild(card);
        });
    }
    
    // 更新按钮状态
    triggerFilterStatusUpdate();
}

/**
 * 触发list.html中的过滤状态更新函数
 */
function triggerFilterStatusUpdate() {
    // 如果主页面中定义了更新函数，调用它
    if (typeof window.updateClearButtonState === 'function') {
        setTimeout(window.updateClearButtonState, 0);
    } else {
        // 如果没有定义，则使用自定义事件通知
        document.dispatchEvent(new CustomEvent('filterStatusChanged'));
    }
}

/**
 * 清除所有统计卡片筛选
 * 这个函数可以从外部调用，用于重置所有卡片状态
 */
function clearAllCardFilters() {
    // 移除所有卡片的active-filter类
    const cards = [
        document.getElementById('validProjectsCard'),
        document.getElementById('tenderingProjectsCard'),
        document.getElementById('wonProjectsCard'),
        document.getElementById('quotedProjectsCard'),
        document.getElementById('updatedProjectsCard'),
        document.getElementById('discoverProjectsCard'),
        document.getElementById('embedProjectsCard'),
        document.getElementById('preTenderProjectsCard'),
        document.getElementById('lostProjectsCard'),
        document.getElementById('pausedProjectsCard')
    ];
    
    cards.forEach(card => {
        if (card) {
            card.classList.remove('active-filter');
        }
    });
    
    // 更新URL参数，移除筛选条件
    const currentUrl = new URL(window.location.href);
    const params = new URLSearchParams(currentUrl.search);
    
    // 移除所有卡片相关的过滤条件
    params.delete('filter_has_authorization');
    params.delete('filter_stage_not');
    params.delete('filter_current_stage');
    params.delete('filter_updated_this_month');
    
    // 保持统计面板打开状态
    params.set('keep_panel', 'true');
    
    // 更新URL但不刷新页面
    window.history.replaceState(null, '', '/project/?' + params.toString());
    
    // 调用恢复所有记录的函数
    if (typeof restoreAllRecords === 'function') {
        restoreAllRecords();
    } else {
        // 如果没有恢复函数，仍然应用空筛选条件
        clientSideFilter({});
    }
}

// 将清除函数暴露给全局，以便主页面可以调用
window.clearAllCardFilters = clearAllCardFilters;

// 将恢复函数暴露给全局，以便主页面可以调用
window.restoreAllRecords = restoreAllRecords;

/**
 * 检查URL参数并设置阶段卡片的选中状态
 */
function checkAndSetStageCardSelection() {
    const currentUrl = new URL(window.location.href);
    const params = new URLSearchParams(currentUrl.search);
    const currentStage = params.get('filter_current_stage');
    
    // 阶段到卡片ID的映射
    const stageToCardMap = {
        'discover': 'discoverProjectsCard',
        'embed': 'embedProjectsCard',
        'pre_tender': 'preTenderProjectsCard',
        'tendering': 'tenderingProjectsCard',
        'awarded': 'wonProjectsCard',
        'quoted': 'quotedProjectsCard',
        'lost': 'lostProjectsCard',
        'paused': 'pausedProjectsCard'
    };
    
    // 移除所有阶段卡片的选中状态
    Object.values(stageToCardMap).forEach(cardId => {
        const card = document.getElementById(cardId);
        if (card) {
            card.classList.remove('stage-card-selected');
        }
    });
    
    // 如果URL中有当前阶段参数，设置对应卡片为选中状态
    if (currentStage && stageToCardMap[currentStage]) {
        const selectedCard = document.getElementById(stageToCardMap[currentStage]);
        if (selectedCard) {
            selectedCard.classList.add('stage-card-selected');
        }
    }
}

// 页面加载完成后检查并设置选中状态
document.addEventListener('DOMContentLoaded', function() {
    // 延迟执行，确保所有元素都已渲染
    setTimeout(checkAndSetStageCardSelection, 100);
});

// 将函数暴露给全局，以便外部调用
window.checkAndSetStageCardSelection = checkAndSetStageCardSelection;
</script> 