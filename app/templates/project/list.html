{% extends "base.html" %}
{% from 'macros/ui_helpers.html' import render_project_type, render_owner, render_date, render_authorization_code, render_datetime, render_project_stage, render_status_badge, render_project_rating, render_confirmation_badge %}
{% import 'macros/ui_helpers.html' as ui %}

{% block title %}{{ _('项目管理') }}{% endblock %}

{% block content %}
<!--
╔════════════════════════════════════════════════════════════════════════════════╗
║                               🔒 保护文件声明 🔒                                ║
║                                                                                ║
║  此文件被系统标记为受保护文件，未经倪捷明确许可，严禁修改任何代码！             ║
║  修改此文件可能导致整个项目列表功能失效或显示异常。                            ║
║                                                                                ║
║  🚫 禁止修改内容包括但不限于：                                                 ║
║  - 表格结构和样式                                                              ║
║  - 变量名称引用方式                                                            ║
║  - CSS类名和样式定义                                                           ║
║  - JavaScript功能函数                                                          ║
║                                                                                ║
║  📝 如确实需要修改，请联系倪捷获取明确许可。                                    ║
╚════════════════════════════════════════════════════════════════════════════════╝
-->

<!-- 添加一个隐藏的div用于检查变量是否存在 -->
<div style="display:none;">
    <!-- 检查companies是否已定义 -->
    {% if companies is defined %}
        <span id="companies-check">companies变量已定义</span>
    {% else %}
        <span id="companies-check">companies变量未定义</span>
    {% endif %}

    <!-- 检查projects是否已定义 -->
    {% if projects is defined %}
        <span id="projects-check">projects变量已定义</span>
    {% else %}
        <span id="projects-check">projects变量未定义</span>
    {% endif %}
</div>

<!--
╔════════════════════════════════════════════════════════════════════════════════╗
║                                  ⚠️ 重要警告 ⚠️                                  ║
║                                                                                ║
║  以下代码结构和样式是经过精心设计的，用于确保项目列表页面的正确显示和功能。        ║
║  特别是表格的布局、固定列和滚动行为都需要保持完整性。                            ║
║                                                                                ║
║  🚫 未经倪捷同意，请勿修改：                                                    ║
║  1. 表格容器的结构和类名                                                       ║
║  2. 操作列的固定定位样式                                                       ║
║  3. 表格的响应式布局                                                          ║
║  4. 条纹行和悬停效果的样式                                                     ║
╚════════════════════════════════════════════════════════════════════════════════╝
-->
<div class="container-fluid mt-4">
    <div class="row page-title-container">
        <div class="col-6">
            <h1 class="page-title">{{ _('项目列表') }}</h1>
        </div>
        <div class="col-6 text-end">
            {{ ui.render_button(_("显示统计总览"), type="button", color="secondary", attrs='id="toggleStatisticsBtn"', size='sm') }}
        </div>
    </div>
    <div class="row">
        <div class="col">
            <!-- 搜索和添加按钮部分 -->
            <div id="dashboardWrapper" style="display:none;">
                {% include 'project/statistics_dashboard.html' %}
            </div>
            <!-- 账户选择器 -->
            <div class="d-flex justify-content-between align-items-center mb-3">
                <div class="d-flex align-items-center gap-3">
                    <div class="dropdown account-selector">
                        <button class="btn btn-sm btn-outline-primary dropdown-toggle" type="button" id="accountSelectorBtn" data-bs-toggle="dropdown" aria-expanded="false">
                            {{ _('全部账户') }}
                        </button>
                        <ul class="dropdown-menu" id="accountSelectorMenu" aria-labelledby="accountSelectorBtn">
                            <li><a class="dropdown-item active" href="#" data-account-id="all">{{ _('全部账户') }}</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item text-center"><div class="spinner-border spinner-border-sm text-primary" role="status"><span class="visually-hidden">{{ _('加载中...') }}</span></div></a></li>
                        </ul>
                    </div>
                </div>
                {# 统计总览按钮已移至标题区，此处删除避免重复 #}
<script>
// 统计总览显示/隐藏按钮逻辑
document.addEventListener('DOMContentLoaded', function () {
  const toggleStatisticsBtn = document.getElementById('toggleStatisticsBtn');
  const dashboardWrapper = document.getElementById('dashboardWrapper');
  const statisticsPanel = document.getElementById('projectStatisticsPanel');

  // 定义翻译文本
  const showText = "{{ _('显示项目总览') }}";
  const hideText = "{{ _('隐藏项目总览') }}";

  if (toggleStatisticsBtn && dashboardWrapper) {
    // 确保初始状态：面板是隐藏的，按钮文本显示"显示统计总览"
    toggleStatisticsBtn.innerHTML = showText;
    dashboardWrapper.style.display = 'none';

    toggleStatisticsBtn.addEventListener('click', function () {
      if (dashboardWrapper.style.display === 'none') {
        // 显示面板
        dashboardWrapper.style.display = 'block';
        toggleStatisticsBtn.innerHTML = hideText;
        
        // 确保Bootstrap collapse也展开
        if (statisticsPanel && !statisticsPanel.classList.contains('show')) {
          statisticsPanel.classList.add('show');
        }
        
        // 启动自动切换（如果存在这个函数）
        if (typeof startAutoSwitch === 'function' && !window.autoSwitchTimer) {
          startAutoSwitch();
        }
      } else {
        // 隐藏面板
        dashboardWrapper.style.display = 'none';
        toggleStatisticsBtn.innerHTML = showText;
        
        // 确保Bootstrap collapse也收起
        if (statisticsPanel && statisticsPanel.classList.contains('show')) {
          statisticsPanel.classList.remove('show');
        }
        
        // 停止自动切换（如果存在这个定时器）
        if (window.autoSwitchTimer) {
          clearInterval(window.autoSwitchTimer);
          window.autoSwitchTimer = null;
        }
      }
    });
  }

  // 移除了筛选状态指示和返回按钮相关代码
});
</script>
            </div>
            <div class="d-flex justify-content-between align-items-center mb-3">
                <div class="d-flex align-items-center">
                    <div class="input-group" style="max-width: 300px;">
                        <input type="text" class="form-control" id="searchInput" placeholder="{{ _('搜索项目名称...') }}" value="{{ search_term }}">
                        <button class="btn btn-outline-secondary" type="button" id="searchButton">
                            <i class="fas fa-search"></i>
                        </button>
                    </div>
                    <div class="d-inline-flex align-items-center gap-2 flex-nowrap ms-4">
                        {{ ui.render_toggle_switch('showMyProjectsSwitch',
                                                   checked=request.args.get('my_projects') == '1',
                                                   label_on='ON',
                                                   label_off='OFF',
                                                   attrs='id="showMyProjectsSwitch"') }}
                        <span class="form-label mb-0 text-nowrap">{{ _('只看自己') }}</span>
                    </div>
                </div>
                <div class="d-none d-lg-block">
                    {% if current_user.role == 'admin' %}
                        {{ ui.render_button(_("批量导入"), type="button", color="info", icon="fas fa-file-import", attrs='id="importProjectsBtn"', extra_class="me-2") }}
                    {% endif %}
                    {{ ui.render_button(_("创建项目"), href=url_for('project.add_project'), color="primary", attrs='', extra_class="me-2") }}
                    {% if has_permission('project', 'delete') %}
                    {{ ui.render_button(_("批量删除"), type="button", color="danger", icon="fas fa-trash", attrs='id="batchDeleteBtn" style="display: none;"') }}
                    {% endif %}
                </div>
            </div>

            <!-- 移动端+号浮动按钮，仅小屏幕显示 -->
            <div class="d-lg-none">
                <button id="mobileFabBtn" class="btn btn-primary rounded-circle shadow position-fixed" style="right: 24px; bottom: 24px; width: 56px; height: 56px; z-index: 1050; font-size: 2rem; display: flex; align-items: center; justify-content: center;">
                    <i class="fas fa-plus"></i>
                </button>
                <div id="mobileFabMenu" class="card shadow position-fixed" style="right: 24px; bottom: 90px; min-width: 140px; z-index: 1051; display: none;">
                    <ul class="list-group list-group-flush">
                        {% if current_user.role == 'admin' %}
                        <li class="list-group-item p-2">
                            <a href="#" id="mobileImportBtn" class="text-info text-decoration-none"><i class="fas fa-file-import me-2"></i>{{ _('批量导入') }}</a>
                        </li>
                        {% endif %}
                        <li class="list-group-item p-2">
                            <a href="{{ url_for('project.add_project') }}" class="text-primary text-decoration-none"><i class="fas fa-plus me-2"></i>{{ _('创建项目') }}</a>
                        </li>
                    </ul>
                </div>
            </div>

            <script>
            document.addEventListener('DOMContentLoaded', function() {
                var fabBtn = document.getElementById('mobileFabBtn');
                var fabMenu = document.getElementById('mobileFabMenu');
                if (fabBtn && fabMenu) {
                    fabBtn.addEventListener('click', function() {
                        fabMenu.style.display = fabMenu.style.display === 'none' ? 'block' : 'none';
                    });
                    document.addEventListener('click', function(e) {
                        if (!fabBtn.contains(e.target) && !fabMenu.contains(e.target)) {
                            fabMenu.style.display = 'none';
                        }
                    });
                }
                var importBtn = document.getElementById('importProjectsBtn');
                var mobileImportBtn = document.getElementById('mobileImportBtn');
                if (importBtn && mobileImportBtn) {
                    mobileImportBtn.addEventListener('click', function(e) {
                        e.preventDefault();
                        importBtn.click();
                    });
                }
            });
            </script>


            <!-- 移动端卡片视图 - 仅在小屏幕显示 -->
            <div class="d-block d-lg-none mb-4">
                {% if not projects %}
                <div class="alert alert-info text-center">{{ _('暂无项目数据') }}</div>
                {% endif %}
                {% for project in projects %}
                <div class="card mb-3 shadow-sm">
                    <div class="card-body p-3">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span class="badge bg-info">{{ project.authorization_code or _('无编号') }}</span>
                            <div>
                                {{ render_status_badge('active' if project.is_active else 'inactive') }}
                                {{ render_project_stage(project.current_stage|project_stage_label('zh')) if project.current_stage else render_project_stage(_('未设置')) }}
                            </div>
                        </div>
                        <h5 class="card-title mb-2">
                            <a href="{{ url_for('project.view_project', project_id=project.id) }}" class="text-decoration-none">
                                {{ project.project_name }}
                            </a>
                            {{ render_project_rating(project.rating, style="list") }}
                        </h5>
                        <div class="small text-muted mb-2">
                            {{ render_project_type(project.project_type) }}
                            {% if project.product_situation %} · {{ project.product_situation }}{% endif %}
                        </div>
                        <div class="small mb-1">
                            <i class="fas fa-user text-secondary me-1"></i>{{ render_owner(project.owner) }}
                            <span class="d-none" data-owner-id="{{ project.owner_id }}"></span>
                        </div>
                        {% if project.vendor_sales_manager_id %}
                        <div class="small mb-1">
                            <i class="fas fa-user-tie text-secondary me-1"></i>{{ _('厂商负责人') }}: {{ render_owner(project.vendor_sales_manager) }}
                            <span class="d-none" data-vendor-sales-manager-id="{{ project.vendor_sales_manager_id }}"></span>
                        </div>
                        {% else %}
                        <span class="d-none" data-vendor-sales-manager-id=""></span>
                        {% endif %}
                        {% if project.quotation_customer %}
                        <div class="small mb-1 d-flex align-items-center">
                            <span>
                                <i class="fas fa-yen-sign text-secondary me-1"></i>{{ _('报价') }}: {{ '{:,.2f}'.format(project.quotation_customer) }}{{ _('元') }}
                            </span>
                            {% if project.quotations.count() > 0 %}
                            {% set latest_quotation = project.quotations.order_by(Quotation.created_at.desc()).first() %}
                            {{ render_confirmation_badge(latest_quotation) }}
                            {% endif %}
                        </div>
                        {% endif %}
                        <div class="small mb-1">
                            <i class="fas fa-building text-secondary me-1"></i>{{ _('直接用户') }}: {{ project.end_user or _('未设置') }}
                        </div>
                        <div class="small mb-1">
                            <i class="fas fa-clock text-secondary me-1"></i>{{ _('报备') }}: {{ render_date(project.report_time) }}
                            {% if project.report_source %} ({{ project.report_source }}){% endif %}
                        </div>
                        {% if project.delivery_forecast %}
                        <div class="small mb-1">
                            <i class="fas fa-shipping-fast text-secondary me-1"></i>{{ _('出货预测') }}: {{ render_date(project.delivery_forecast) }}
                        </div>
                        {% endif %}
                        <div class="small text-muted mt-2">
                            <i class="fas fa-calendar-plus me-1"></i>{{ _('创建') }}: {{ render_datetime(project.created_at) }}
                        </div>
                        <div class="small text-muted mt-1">
                            <i class="fas fa-calendar-check me-1"></i>{{ _('更新') }}: {{ render_datetime(project.updated_at) }}
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            <!-- PC端表格视图 - 仅在大屏幕显示 -->
            <div class="table-container d-none d-lg-block">
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                {% if has_permission('project', 'delete') %}
                                <th style="width: 40px;">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="selectAll">
                                    </div>
                                </th>
                                {% endif %}

                                <th style="min-width: 100px;" data-sort="owner_id">
                                    <div class="th-content">
                                        <span class="th-text">{{ _('拥有者') }}</span>
                                        <div class="th-actions">
                                            <i class="fas fa-sort sort-icon" data-sort="owner_id"></i>
                                        </div>
                                    </div>
                                </th>
                                <th style="min-width: 120px;" data-sort="vendor_sales_manager_id">
                                    <div class="th-content">
                                        <span class="th-text">{{ _('厂商负责人') }}</span>
                                        <div class="th-actions">
                                            <i class="fas fa-sort sort-icon" data-sort="vendor_sales_manager_id"></i>
                                        </div>
                                    </div>
                                </th>
                                <th style="min-width: 120px;" data-sort="authorization_code">
                                    <div class="th-content">
                                        <span class="th-text">{{ _('授权编号') }}</span>
                                        <div class="th-actions">
                                            <i class="fas fa-sort sort-icon" data-sort="authorization_code"></i>
                                        </div>
                                    </div>
                                </th>
                                <th style="min-width: 200px;" data-sort="project_name">
                                    <div class="th-content">
                                        <span class="th-text">{{ _('项目名称') }}</span>
                                        <div class="th-actions">
                                            <i class="fas fa-sort sort-icon" data-sort="project_name"></i>
                                        </div>
                                    </div>
                                </th>
                                <th style="min-width: 80px;" data-sort="is_active">
                                    <div class="th-content">
                                        <span class="th-text">{{ _('活跃状态') }}</span>
                                        <div class="th-actions">
                                            <i class="fas fa-sort sort-icon" data-sort="is_active"></i>
                                        </div>
                                    </div>
                                </th>
                                <th style="min-width: 100px;" data-sort="current_stage">
                                    <div class="th-content">
                                        <span class="th-text">{{ _('当前阶段') }}</span>
                                        <div class="th-actions">
                                            <i class="fas fa-sort sort-icon" data-sort="current_stage"></i>
                                        </div>
                                    </div>
                                </th>
                                <th style="min-width: 100px;" data-sort="project_type">
                                    <div class="th-content">
                                        <span class="th-text">{{ _('项目类型') }}</span>
                                        <div class="th-actions">
                                            <i class="fas fa-sort sort-icon" data-sort="project_type"></i>
                                        </div>
                                    </div>
                                </th>
                                <th style="min-width: 120px;" data-sort="quotation_customer">
                                    <div class="th-content">
                                        <span class="th-text">{{ _('报价') }}（{{ _('元') }}）</span>
                                        <div class="th-actions">
                                            <i class="fas fa-sort sort-icon" data-sort="quotation_customer"></i>
                                        </div>
                                    </div>
                                </th>
                                <th style="min-width: 100px;" data-sort="report_source">
                                    <div class="th-content">
                                        <span class="th-text">{{ _('报备来源') }}</span>
                                        <div class="th-actions">
                                            <i class="fas fa-sort sort-icon" data-sort="report_source"></i>
                                        </div>
                                    </div>
                                </th>
                                <th style="min-width: 150px;" data-sort="end_user">
                                    <div class="th-content">
                                        <span class="th-text">{{ _('直接用户') }}</span>
                                        <div class="th-actions">
                                            <i class="fas fa-sort sort-icon" data-sort="end_user"></i>
                                        </div>
                                    </div>
                                </th>
                                <th style="min-width: 150px;" data-sort="design_issues">
                                    <div class="th-content">
                                        <span class="th-text">{{ _('设计院及顾问') }}</span>
                                        <div class="th-actions">
                                            <i class="fas fa-sort sort-icon" data-sort="design_issues"></i>
                                        </div>
                                    </div>
                                </th>
                                <th style="min-width: 150px;" data-sort="contractor">
                                    <div class="th-content">
                                        <span class="th-text">{{ _('总承包单位') }}</span>
                                        <div class="th-actions">
                                            <i class="fas fa-sort sort-icon" data-sort="contractor"></i>
                                        </div>
                                    </div>
                                </th>
                                <th style="min-width: 150px;" data-sort="system_integrator">
                                    <div class="th-content">
                                        <span class="th-text">{{ _('系统集成商') }}</span>
                                        <div class="th-actions">
                                            <i class="fas fa-sort sort-icon" data-sort="system_integrator"></i>
                                        </div>
                                    </div>
                                </th>
                                <th style="min-width: 120px;" data-sort="delivery_forecast">
                                    <div class="th-content">
                                        <span class="th-text">{{ _('出货预期日期') }}</span>
                                        <div class="th-actions">
                                            <i class="fas fa-sort sort-icon" data-sort="delivery_forecast"></i>
                                        </div>
                                    </div>
                                </th>
                                <th style="min-width: 120px;" data-sort="report_time">
                                    <div class="th-content">
                                        <span class="th-text">{{ _('报备日期') }}</span>
                                        <div class="th-actions">
                                            <i class="fas fa-sort sort-icon" data-sort="report_time"></i>
                                        </div>
                                    </div>
                                </th>
                                <th style="min-width: 150px;" data-sort="updated_at">
                                    <div class="th-content">
                                        <span class="th-text">{{ _('更新时间') }}</span>
                                        <div class="th-actions">
                                            <i class="fas fa-sort sort-icon" data-sort="updated_at"></i>
                                        </div>
                                    </div>
                                </th>
                                <th style="min-width: 150px;" data-sort="created_at">
                                    <div class="th-content">
                                        <span class="th-text">{{ _('创建日期') }}</span>
                                        <div class="th-actions">
                                            <i class="fas fa-sort sort-icon" data-sort="created_at"></i>
                                        </div>
                                    </div>
                                </th>
                            </tr>
                            <tr class="filter-row" style="display: none;">
                                {% if has_permission('project', 'delete') %}
                                <th style="width: 40px;">
                                    <!-- 复选框列的筛选区域保持空白 -->
                                    <div style="height: 28px;"></div>
                                </th>
                                {% endif %}

                                <th><input type="text" class="form-control form-control-sm filter-input" data-field="owner_id" placeholder="{{ _('筛选...') }}"></th>
                                <th><input type="text" class="form-control form-control-sm filter-input" data-field="vendor_sales_manager_id" placeholder="{{ _('筛选...') }}"></th>
                                <th><input type="text" class="form-control form-control-sm filter-input" data-field="authorization_code" placeholder="{{ _('筛选...') }}"></th>
                                <th><input type="text" class="form-control form-control-sm filter-input" data-field="project_name" placeholder="{{ _('筛选...') }}"></th>
                                <th><input type="text" class="form-control form-control-sm filter-input" data-field="is_active" placeholder="{{ _('筛选...') }}"></th>
                                <th><input type="text" class="form-control form-control-sm filter-input" data-field="current_stage" placeholder="{{ _('筛选...') }}"></th>
                                <th><input type="text" class="form-control form-control-sm filter-input" data-field="project_type" placeholder="{{ _('筛选...') }}"></th>
                                <th><input type="text" class="form-control form-control-sm filter-input" data-field="quotation_customer" placeholder="{{ _('筛选...') }}"></th>
                                <th><input type="text" class="form-control form-control-sm filter-input" data-field="report_source" placeholder="{{ _('筛选...') }}"></th>
                                <th><input type="text" class="form-control form-control-sm filter-input" data-field="end_user" placeholder="{{ _('筛选...') }}"></th>
                                <th><input type="text" class="form-control form-control-sm filter-input" data-field="design_issues" placeholder="{{ _('筛选...') }}"></th>
                                <th><input type="text" class="form-control form-control-sm filter-input" data-field="contractor" placeholder="{{ _('筛选...') }}"></th>
                                <th><input type="text" class="form-control form-control-sm filter-input" data-field="system_integrator" placeholder="{{ _('筛选...') }}"></th>
                                <th><input type="date" class="form-control form-control-sm filter-input" data-field="delivery_forecast"></th>
                                <th><input type="date" class="form-control form-control-sm filter-input" data-field="report_time"></th>
                                <th><input type="date" class="form-control form-control-sm filter-input" data-field="updated_at"></th>
                                <th><input type="date" class="form-control form-control-sm filter-input" data-field="created_at"></th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for project in projects %}
                            <tr>
                                {% if has_permission('project', 'delete') %}
                                <td>
                                    <div class="form-check">
                                        <input class="form-check-input project-checkbox" type="checkbox" value="{{ project.id }}"
                                               {% if current_user.role != 'admin' and current_user.id != project.owner_id %}disabled{% endif %}>
                                    </div>
                                </td>
                                {% endif %}

                                <td>{{ render_owner(project.owner) if project.owner else '' }}
                                  <span class="d-none" data-owner-id="{{ project.owner_id }}"></span>
                                </td>
                                <td>
                                    {% if project.vendor_sales_manager_id %}
                                        {{ render_owner(project.vendor_sales_manager) if project.vendor_sales_manager else '' }}
                                        <span class="d-none" data-vendor-sales-manager-id="{{ project.vendor_sales_manager_id }}"></span>
                                    {% else %}
                                        <span class="badge bg-secondary">{{ _('未设置') }}</span>
                                        <span class="d-none" data-vendor-sales-manager-id=""></span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if project.authorization_code %}
                                        {{ render_authorization_code(project.authorization_code, project.project_type) }}
                                    {% elif project.authorization_status == 'pending' %}
                                        <span class="badge bg-warning">{{ _('审批中') }}</span>
                                    {% elif project.authorization_status == 'rejected' %}
                                        <span class="badge bg-danger">{{ _('已驳回') }}</span>
                                    {% else %}
                                        <span class="badge bg-secondary">{{ _('未申请') }}</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <a href="{{ url_for('project.view_project', project_id=project.id) }}" class="project-link">
                                        {{ project.project_name }}
                                    </a>
                                    {{ render_project_rating(project.rating, style="list") }}
                                </td>
                                <td>{{ render_status_badge('active' if project.is_active else 'inactive') }}</td>
                                <td>{{ render_project_stage(project.current_stage|project_stage_label('zh')) if project.current_stage else render_project_stage(_('未设置')) }}</td>
                                <td>{{ render_project_type(project.project_type) if project.project_type else '' }}</td>
                                <td>
                                    {% if project.quotation_customer and project.quotations.count() > 0 %}
                                    <div class="d-flex align-items-center">
                                        <a href="{{ url_for('quotation.view_quotation', id=project.quotations.order_by(Quotation.created_at.desc()).first().id) }}"
                                           class="quotation-link" title="{{ _('查看报价单详情') }}">
                                            {{ '{:,.2f}'.format(project.quotation_customer) }}
                                        </a>
                                        {% set latest_quotation = project.quotations.order_by(Quotation.created_at.desc()).first() %}
                                        {{ render_confirmation_badge(latest_quotation) }}
                                    </div>
                                    {% else %}
                                    {{ '{:,.2f}'.format(project.quotation_customer) if project.quotation_customer else '' }}
                                    {% endif %}
                                </td>
                                <td>{{ project.report_source|report_source_label('zh') }}</td>
                                <td>{{ project.end_user if project.end_user else '' }}</td>
                                <td>{{ project.design_issues if project.design_issues else '' }}</td>
                                <td>{{ project.contractor if project.contractor else '' }}</td>
                                <td>{{ project.system_integrator if project.system_integrator else '' }}</td>
                                <td>{{ render_date(project.delivery_forecast) }}</td>
                                <td>{{ render_date(project.report_time) }}</td>
                                <td>{{ render_datetime(project.updated_at) }}</td>
                                <td>{{ render_datetime(project.created_at) }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 添加滚动控制按钮 -->
<div class="scroll-controls">
    <button type="button" class="btn btn-sm btn-light scroll-top" title="{{ _('滚动到顶部') }}">
        <i class="fas fa-chevron-up"></i>
    </button>
    <button type="button" class="btn btn-sm btn-light scroll-bottom" title="{{ _('滚动到底部') }}">
        <i class="fas fa-chevron-down"></i>
    </button>
</div>

<!--
╔════════════════════════════════════════════════════════════════════════════════╗
║                              ⚠️ 关键样式定义 ⚠️                                 ║
║                                                                                ║
║  以下样式是保证表格正确显示和行为的关键。修改这些样式可能会破坏：               ║
║  - 表格的响应式布局                                                           ║
║  - 操作列的固定定位                                                           ║
║  - 条纹行和悬停效果                                                           ║
║                                                                                ║
║  🚫 如需修改，请先获得倪捷的确认                                               ║
╚════════════════════════════════════════════════════════════════════════════════╝
-->
<style>
/* !!! 核心布局样式 - 不要修改 !!! */
.table-container {
    position: relative;
    width: 100%;
    overflow: hidden;
    margin-bottom: 20px; /* 添加底部间距 */
}

.table-responsive {
    margin: 0;
    padding: 0;
    width: 100%;
    overflow-x: auto;
    max-height: 65vh; /* 设置最大高度为视口高度的65% */
    overflow-y: auto; /* 添加垂直滚动 */
}

.table {
    margin-bottom: 0;
    font-size: 14px; /* 将表格字体大小设置为14px */
    border-collapse: separate;
    border-spacing: 0;
}

/* 为表格行和卡片添加平滑过渡效果 */
.table tbody tr, .d-block.d-lg-none .card {
    transition: opacity 0.2s ease-in-out;
}

/* 隐藏行时使用透明度而不是display:none，提供更好的视觉体验 */
.table tbody tr.filtered, .d-block.d-lg-none .card.filtered {
    opacity: 0;
    height: 0;
    overflow: hidden;
    padding: 0;
    margin: 0;
    border: none;
}

/* !!! 表头固定样式 - 不要修改 !!! */
.table th {
    white-space: nowrap;
    background-color: #f8f9fa;
    position: sticky;
    top: 0;
    z-index: 2;
    box-shadow: 0 1px 1px rgba(0,0,0,0.1); /* 添加阴影增强表头分隔效果 */
    height: 48px; /* 设置固定高度 */
    vertical-align: middle;
    padding: 8px 12px;
    border-bottom: 2px solid #dee2e6; /* 加强表头底部边框 */
}

.table td {
    white-space: nowrap;
}

/* !!! 悬停效果样式 - 不要修改 !!! */
.table-hover tbody tr:hover td {
    background-color: #e9ecef !important;
}

/* 项目名称链接样式 */
.table td a.project-link {
    text-decoration: underline !important; /* 为项目名称添加下划线 */
    color: #0d6efd; /* 链接蓝色 */
}

/* 鼠标悬停时的样式 */
.table td a.project-link:hover {
    color: #0a58ca; /* 悬停时深蓝色 */
    font-weight: 500; /* 悬停时稍微加粗 */
}

.project-link:hover {
    text-decoration: underline;
    color: #0056b3;
}

/* 报价链接样式 */
.quotation-link {
    color: #0d6efd;
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    gap: 8px;
}

.quotation-link:hover {
    text-decoration: underline;
    color: #0056b3;
}

.quotation-link .badge {
    font-size: 0.75rem;
    padding: 0.25rem 0.5rem;
}

/* 排序图标样式 */
.sort-icon {
    margin-left: 3px;
    font-size: 0.75rem;
    color: #6c757d;
    cursor: pointer;
    opacity: 0.7;
    transition: all 0.2s;
}

.sort-icon:hover,
.sort-icon.fa-sort-up,
.sort-icon.fa-sort-down {
    color: #0d6efd;
    opacity: 1;
}

/* 过滤图标样式 */
.filter-icon {
    margin-left: 3px;
    font-size: 0.75rem;
    color: #6c757d;
    cursor: pointer;
    opacity: 0.7;
    transition: all 0.2s;
    padding: 4px; /* 增加可点击区域 */
    border-radius: 3px; /* 添加圆角 */
}

.filter-icon:hover {
    color: #0d6efd;
    opacity: 1;
    background-color: rgba(13, 110, 253, 0.1); /* 悬停背景色 */
}

.filter-icon.active {
    color: #0d6efd;
    opacity: 1;
    background-color: rgba(13, 110, 253, 0.2); /* 激活状态背景色 */
}

/* 表头内容布局 */
.th-content {
    display: flex;
    align-items: center;
    justify-content: space-between;
    width: 100%;
    min-height: 32px; /* 确保表头内容有最小高度 */
}

.th-text {
    flex-grow: 1;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.th-actions {
    display: flex;
    gap: 6px;
    margin-left: 6px;
    flex-shrink: 0; /* 防止操作按钮被压缩 */
}

/* 筛选行样式 */
.filter-row th {
    padding: 4px 8px;
    background-color: #f0f0f0;
    position: sticky;
    top: 48px; /* 调整为实际表头高度 */
    z-index: 1;
    box-shadow: 0 1px 1px rgba(0,0,0,0.05);
    height: 40px; /* 设置筛选行固定高度 */
    vertical-align: middle;
    border-bottom: 1px solid #dee2e6; /* 添加底部边框 */
}

.filter-input {
    width: 100%;
    padding: 4px 8px;
    font-size: 12px;
    border: 1px solid #ddd;
    border-radius: 3px;
    height: 28px; /* 设置输入框固定高度 */
    box-sizing: border-box;
    background-color: #fff;
    transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
}

.filter-input:focus {
    border-color: #86b7fe;
    outline: 0;
    box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
}

/* 滚动条样式美化 */
.table-responsive::-webkit-scrollbar {
    width: 8px;
    height: 8px;
}

.table-responsive::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 4px;
}

.table-responsive::-webkit-scrollbar-thumb {
    background: #ccc;
    border-radius: 4px;
}

.table-responsive::-webkit-scrollbar-thumb:hover {
    background: #999;
}

/* 表格单元格样式增强 */
.table td {
    white-space: nowrap;
    border-bottom: 1px solid #dee2e6;
    padding: 8px 12px;
    vertical-align: middle;
}

/* 奇偶行颜色区分，增强可读性 */
.table-striped > tbody > tr:nth-of-type(odd) > * {
    background-color: rgba(0, 0, 0, 0.02);
}

/* 表头边框处理 */
.table > :not(caption) > * > * {
    border-bottom-width: 1px;
}

/* 滚动顺滑效果 */
.table-responsive {
    scrollbar-width: thin;
    scroll-behavior: smooth;
}

/* 添加表格斑马纹效果，每五行加强一次 */
.table-striped > tbody > tr:nth-of-type(10n+5) > * {
    background-color: rgba(0, 0, 0, 0.04);
}

/* 滚动控制按钮样式 */
.scroll-controls {
    position: fixed;
    right: 20px;
    bottom: 50px;
    display: flex;
    flex-direction: column;
    gap: 5px;
    z-index: 1000;
    opacity: 0.7;
    transition: opacity 0.3s;
}

.scroll-controls:hover {
    opacity: 1;
}

.scroll-controls button {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    display: flex;
    align-items: center;
    justify-content: center;
}

.scroll-controls button:hover {
    background-color: #f0f0f0;
}

/* 行焦点效果 */
.table tbody tr.highlight-row {
    background-color: rgba(13, 110, 253, 0.08) !important;
    outline: 1px solid rgba(13, 110, 253, 0.3);
    box-shadow: 0 0 5px rgba(13, 110, 253, 0.2);
}

/* 移动端卡片视图样式 */
@media (max-width: 991.98px) {
    .card-title {
        font-size: 1.1rem;
    }
    .card-body {
        padding: 0.75rem;
    }
    .btn-group-sm .btn {
        padding: 0.25rem 0.5rem;
        font-size: 0.75rem;
    }
    .shadow-sm {
        box-shadow: 0 .125rem .25rem rgba(0,0,0,.075)!important;
        border-radius: 0.5rem;
        border: none;
    }
    .fa-phone, .fa-envelope, .fa-user, .fa-clock,
    .fa-building, .fa-yen-sign, .fa-shipping-fast,
    .fa-calendar-plus, .fa-calendar-check {
        width: 16px;
        text-align: center;
    }
}

/* 审批徽章样式已迁移到标准UI函数，不再需要自定义样式 */
</style>

<!--
╔════════════════════════════════════════════════════════════════════════════════╗
║                              ⚠️ 功能脚本 ⚠️                                    ║
║                                                                                ║
║  以下JavaScript代码处理表格的交互功能。修改可能会影响：                        ║
║  - 项目搜索功能                                                               ║
║  - 删除确认功能                                                               ║
║                                                                                ║
║  🚫 如需修改，请先获得倪捷的确认                                               ║
╚════════════════════════════════════════════════════════════════════════════════╝
-->
<script>
function deleteProject(id) {
    if (confirm('确定要删除这个项目吗？')) {
        fetch(`/project/${id}/delete`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest',  // 添加AJAX标识
                'X-CSRFToken': '{{ csrf_token() }}'  // 添加CSRF令牌
            }
        })
        .then(response => {
            if (response.redirected) {
                window.location.href = response.url;
                return Promise.reject('重定向');
            }

            if (!response.ok) {
                throw new Error('删除失败');
            }

            window.location.reload();
        })
        .catch(error => {
            console.error('Error:', error);
            alert(typeof error === 'object' ? error.message : error);
        });
    }
}

document.addEventListener('DOMContentLoaded', function() {
    // 搜索按钮点击事件
    const searchButton = document.getElementById('searchButton');
    const searchInput = document.getElementById('searchInput');
    
    searchButton.addEventListener('click', function() {
        performSearch();
    });
    
    searchInput.addEventListener('keypress', function(e) {
        if(e.key === 'Enter') {
            performSearch();
        }
    });
    
    // 获取URL参数
    const urlParams = new URLSearchParams(window.location.search);
    const searchParam = urlParams.get('search');
    const myProjectsParam = urlParams.get('my_projects');
    
    // 初始化搜索框值
    if (searchParam) {
        searchInput.value = searchParam;
    }
    
    // 初始化"只看自己"过滤
    const showMyProjectsSwitch = document.getElementById('showMyProjectsSwitch');
    
    // 如果URL包含my_projects=1参数，应用客户端过滤
    if (myProjectsParam === '1' && showMyProjectsSwitch) {
        // 确保开关状态与URL参数一致
        showMyProjectsSwitch.checked = true;
        
        // 应用过滤
        const currentUserId = parseInt("{{ current_user.id }}");
        
        // PC端表格视图过滤
        const tableRows = document.querySelectorAll('.table tbody tr');
        tableRows.forEach(row => {
            const ownerSpan = row.querySelector('td [data-owner-id]');
            const vendorSalesManagerSpan = row.querySelector('td [data-vendor-sales-manager-id]');
            
            let isMyProject = false;
            
            // 检查是否是拥有人
            if (ownerSpan) {
                const ownerId = parseInt(ownerSpan.getAttribute('data-owner-id'));
                if (ownerId === currentUserId) {
                    isMyProject = true;
                }
            }
            
            // 检查是否是厂商负责人
            if (!isMyProject && vendorSalesManagerSpan) {
                const vendorSalesManagerId = parseInt(vendorSalesManagerSpan.getAttribute('data-vendor-sales-manager-id'));
                if (vendorSalesManagerId === currentUserId) {
                    isMyProject = true;
                }
            }
            
            if (!isMyProject) {
                row.classList.add('filtered');
            }
        });
        
        // 移动端卡片视图过滤
        const mobileCards = document.querySelectorAll('.d-block.d-lg-none .card');
        mobileCards.forEach(card => {
            const ownerSpan = card.querySelector('[data-owner-id]');
            const vendorSalesManagerSpan = card.querySelector('[data-vendor-sales-manager-id]');
            
            let isMyProject = false;
            
            // 检查是否是拥有人
            if (ownerSpan) {
                const ownerId = parseInt(ownerSpan.getAttribute('data-owner-id'));
                if (ownerId === currentUserId) {
                    isMyProject = true;
                }
            }
            
            // 检查是否是厂商负责人
            if (!isMyProject && vendorSalesManagerSpan) {
                const vendorSalesManagerId = parseInt(vendorSalesManagerSpan.getAttribute('data-vendor-sales-manager-id'));
                if (vendorSalesManagerId === currentUserId) {
                    isMyProject = true;
                }
            }
            
            if (!isMyProject) {
                card.classList.add('filtered');
            }
        });
    }
    
    // 只看自己开关事件
    showMyProjectsSwitch.addEventListener('change', function() {
        // 直接调用performSearch函数应用过滤
        performSearch();
        
        // 如果开关被关闭，确保所有行显示（清除"只看自己"的过滤）
        if (!this.checked) {
            // 获取所有表格行和移动端卡片
            const tableRows = document.querySelectorAll('.table tbody tr');
            const mobileCards = document.querySelectorAll('.d-block.d-lg-none .card');
            const tableBody = document.querySelector('.table tbody');
            const mobileContainer = document.querySelector('.d-block.d-lg-none');
            
            // 先检查是否有搜索条件
            const searchText = searchInput.value.trim().toLowerCase();
            if (!searchText) {
                // 如果没有搜索条件，重新排列所有元素
                const allRows = Array.from(tableRows);
                const allCards = Array.from(mobileCards);
                
                // 按更新时间降序排序的函数
                const sortByUpdatedAtDesc = (a, b) => {
                  // 尝试从元素中获取更新时间
                  const getUpdatedAt = (el) => {
                    // 从表格行中提取更新时间（假设在倒数第二列）
                    if (!el.classList.contains('card')) {
                      // PC端表格视图
                      const cells = el.querySelectorAll('td');
                      if (cells.length > 2) {
                        const updatedAtCell = cells[cells.length - 2]; // 倒数第二列是更新时间
                        if (updatedAtCell) {
                          const dateText = updatedAtCell.textContent.trim();
                          if (dateText) {
                            return new Date(dateText).getTime();
                          }
                        }
                      }
                    } else {
                      // 移动端卡片视图
                      const updatedAtText = el.textContent.match(/更新: (\d{4}-\d{2}-\d{2})/);
                      if (updatedAtText && updatedAtText[1]) {
                        return new Date(updatedAtText[1]).getTime();
                      }
                    }
                    return 0; // 默认时间戳
                  };
                  
                  const updatedAtA = getUpdatedAt(a);
                  const updatedAtB = getUpdatedAt(b);
                  return updatedAtB - updatedAtA; // 降序排列（新到旧）
                };
                
                // 排序行和卡片
                allRows.sort(sortByUpdatedAtDesc);
                allCards.sort(sortByUpdatedAtDesc);
                
                // 重新排列表格行
                if (tableBody) {
                    // 清空表格
                    while (tableBody.firstChild) {
                        tableBody.removeChild(tableBody.firstChild);
                    }
                    
                    // 重新添加所有行
                    allRows.forEach(row => {
                        row.classList.remove('filtered');
                        row.style.display = '';
                        tableBody.appendChild(row);
                    });
                }
                
                // 重新排列移动端卡片
                if (mobileContainer) {
                    // 保存非卡片元素
                    const nonCardElements = Array.from(mobileContainer.children).filter(el => 
                        !el.classList.contains('card')
                    );
                    
                    // 清空容器
                    while (mobileContainer.firstChild) {
                        mobileContainer.removeChild(mobileContainer.firstChild);
                    }
                    
                    // 添加非卡片元素
                    nonCardElements.forEach(el => {
                        mobileContainer.appendChild(el);
                    });
                    
                    // 添加所有卡片
                    allCards.forEach(card => {
                        card.classList.remove('filtered');
                        card.style.display = '';
                        mobileContainer.appendChild(card);
                    });
                }
            }
        }
    });

// 执行搜索功能，在客户端过滤不刷新页面
    function performSearch() {
    const searchText = searchInput.value.trim().toLowerCase();
    const isMyProjectsOnly = showMyProjectsSwitch.checked;
    
    // 获取所有表格行和移动端卡片
    const tableRows = document.querySelectorAll('.table tbody tr');
    const mobileCards = document.querySelectorAll('.d-block.d-lg-none .card');
    const tableBody = document.querySelector('.table tbody');
    const mobileContainer = document.querySelector('.d-block.d-lg-none');
    
    // 如果没有任何筛选条件，恢复所有元素显示
    if (!searchText && !isMyProjectsOnly) {
        // 按更新时间降序排序的函数
        const sortByUpdatedAtDesc = (a, b) => {
            // 尝试从元素中获取更新时间
            const getUpdatedAt = (el) => {
                // 从表格行中提取更新时间（假设在倒数第二列）
                if (!el.classList.contains('card')) {
                    // PC端表格视图
                    const cells = el.querySelectorAll('td');
                    if (cells.length > 2) {
                        const updatedAtCell = cells[cells.length - 2]; // 倒数第二列是更新时间
                        if (updatedAtCell) {
                            const dateText = updatedAtCell.textContent.trim();
                            if (dateText) {
                                return new Date(dateText).getTime();
                            }
                        }
                    }
                } else {
                    // 移动端卡片视图
                    const updatedAtText = el.textContent.match(/更新: (\d{4}-\d{2}-\d{2})/);
                    if (updatedAtText && updatedAtText[1]) {
                        return new Date(updatedAtText[1]).getTime();
                    }
                }
                return 0; // 默认时间戳
            };
            
            const updatedAtA = getUpdatedAt(a);
            const updatedAtB = getUpdatedAt(b);
            return updatedAtB - updatedAtA; // 降序排列（新到旧）
        };
        
        // 复制所有行和卡片到数组，以便排序
        const allRows = Array.from(tableRows);
        const allCards = Array.from(mobileCards);
        
        // 按更新时间排序
        allRows.sort(sortByUpdatedAtDesc);
        allCards.sort(sortByUpdatedAtDesc);
        
        // 重新填充表格
        if (tableBody) {
            // 清空表格
            while (tableBody.firstChild) {
                tableBody.removeChild(tableBody.firstChild);
            }
            
            // 添加所有行
            allRows.forEach(row => {
                row.classList.remove('filtered');
                row.style.display = '';
                tableBody.appendChild(row);
            });
        }
        
        // 重新填充移动容器
        if (mobileContainer) {
            // 保存所有非卡片元素
            const nonCardElements = Array.from(mobileContainer.children).filter(el => 
                !el.classList.contains('card')
            );
            
            // 清空容器
            while (mobileContainer.firstChild) {
                mobileContainer.removeChild(mobileContainer.firstChild);
            }
            
            // 首先添加非卡片元素
            nonCardElements.forEach(el => {
                mobileContainer.appendChild(el);
            });
            
            // 添加所有卡片
            allCards.forEach(card => {
                card.classList.remove('filtered');
                card.style.display = '';
                mobileContainer.appendChild(card);
            });
        }
        
        // 更新URL参数
        const searchUrlParams = new URLSearchParams(window.location.search);
        searchUrlParams.delete('search');
        searchUrlParams.delete('my_projects');
        const searchNewUrl = `${window.location.pathname}?${searchUrlParams.toString()}`;
        window.history.replaceState(null, '', searchNewUrl);
        
        // 更新按钮状态
        if (typeof updateClearButtonState === 'function') {
            setTimeout(updateClearButtonState, 0);
        }
        
        return;
    }
    
    // 用于存储匹配和筛选的行和卡片
    const matchedRows = [];
    const filteredRows = [];
    const matchedCards = [];
    const filteredCards = [];
    
    // 检查每一行是否匹配搜索条件
    tableRows.forEach(row => {
        let shouldFilter = false;
        
        // 先检查搜索文本
        if (searchText) {
            const projectNameLink = row.querySelector('a.project-link');
            if (projectNameLink) {
                const projectName = projectNameLink.textContent.toLowerCase();
                if (!projectName.includes(searchText)) {
                    shouldFilter = true;
                }
            }
        }
        
        // 再检查"只看自己"条件
        if (!shouldFilter && isMyProjectsOnly) {
            const currentUserId = parseInt("{{ current_user.id }}");
            const ownerSpan = row.querySelector('td [data-owner-id]');
            const vendorSalesManagerSpan = row.querySelector('td [data-vendor-sales-manager-id]');
            
            let isMyProject = false;
            
            // 检查是否是拥有人
            if (ownerSpan) {
                const ownerId = parseInt(ownerSpan.getAttribute('data-owner-id'));
                if (ownerId === currentUserId) {
                    isMyProject = true;
                }
            }
            
            // 检查是否是厂商负责人
            if (!isMyProject && vendorSalesManagerSpan) {
                const vendorSalesManagerId = parseInt(vendorSalesManagerSpan.getAttribute('data-vendor-sales-manager-id'));
                if (vendorSalesManagerId === currentUserId) {
                    isMyProject = true;
                }
            }
            
            if (!isMyProject) {
                shouldFilter = true;
            }
        }
        
        // 根据筛选结果，分类存储
        if (shouldFilter) {
            row.classList.add('filtered');
            filteredRows.push(row);
        } else {
            row.classList.remove('filtered');
            matchedRows.push(row);
        }
    });
    
    // 检查每个卡片是否匹配搜索条件
    mobileCards.forEach(card => {
        let shouldFilter = false;
        
        // 先检查搜索文本
        if (searchText) {
            const projectNameElem = card.querySelector('.card-title');
            if (projectNameElem) {
                const projectName = projectNameElem.textContent.toLowerCase();
                if (!projectName.includes(searchText)) {
                    shouldFilter = true;
                }
            }
        }
        
        // 再检查"只看自己"条件
        if (!shouldFilter && isMyProjectsOnly) {
            const currentUserId = parseInt("{{ current_user.id }}");
            const ownerSpan = card.querySelector('[data-owner-id]');
            const vendorSalesManagerSpan = card.querySelector('[data-vendor-sales-manager-id]');
            
            let isMyProject = false;
            
            // 检查是否是拥有人
            if (ownerSpan) {
                const ownerId = parseInt(ownerSpan.getAttribute('data-owner-id'));
                if (ownerId === currentUserId) {
                    isMyProject = true;
                }
            }
            
            // 检查是否是厂商负责人
            if (!isMyProject && vendorSalesManagerSpan) {
                const vendorSalesManagerId = parseInt(vendorSalesManagerSpan.getAttribute('data-vendor-sales-manager-id'));
                if (vendorSalesManagerId === currentUserId) {
                    isMyProject = true;
                }
            }
            
            if (!isMyProject) {
                shouldFilter = true;
            }
        }
        
        // 根据筛选结果，分类存储
        if (shouldFilter) {
            card.classList.add('filtered');
            filteredCards.push(card);
        } else {
            card.classList.remove('filtered');
            matchedCards.push(card);
        }
    });
    
    // 按更新时间降序排序匹配的行和卡片
    const sortByUpdatedAtDesc = (a, b) => {
        // 尝试从元素中获取更新时间
        const getUpdatedAt = (el) => {
            // 从表格行中提取更新时间（假设在倒数第二列）
            if (!el.classList.contains('card')) {
                // PC端表格视图
                const cells = el.querySelectorAll('td');
                if (cells.length > 2) {
                    const updatedAtCell = cells[cells.length - 2]; // 倒数第二列是更新时间
                    if (updatedAtCell) {
                        const dateText = updatedAtCell.textContent.trim();
                        if (dateText) {
                            return new Date(dateText).getTime();
                        }
                    }
                }
            } else {
                // 移动端卡片视图
                const updatedAtText = el.textContent.match(/更新: (\d{4}-\d{2}-\d{2})/);
                if (updatedAtText && updatedAtText[1]) {
                    return new Date(updatedAtText[1]).getTime();
                }
            }
            return 0; // 默认时间戳
        };
        
        const updatedAtA = getUpdatedAt(a);
        const updatedAtB = getUpdatedAt(b);
        return updatedAtB - updatedAtA; // 降序排列（新到旧）
    };
    
    // 对匹配的行和卡片按更新时间排序
    matchedRows.sort(sortByUpdatedAtDesc);
    matchedCards.sort(sortByUpdatedAtDesc);
    
    // 重新排列表格行：匹配的行在前，被过滤的行在后
    if (tableBody) {
        // 清空表格
        while (tableBody.firstChild) {
            tableBody.removeChild(tableBody.firstChild);
        }
        
        // 添加匹配的行
        matchedRows.forEach(row => {
            tableBody.appendChild(row);
            row.style.display = '';
        });
        
        // 被过滤的行不再添加回DOM
        filteredRows.forEach(row => {
            // 这里选择隐藏而不是不添加，避免DOM节点丢失
            row.style.display = 'none';
            tableBody.appendChild(row);
        });
    }
    
    // 重新排列移动端卡片：匹配的卡片在前，被过滤的卡片在后
    if (mobileContainer) {
        // 保存所有非卡片元素
        const nonCardElements = Array.from(mobileContainer.children).filter(el => 
            !el.classList.contains('card')
        );
        
        // 清空容器
        while (mobileContainer.firstChild) {
            mobileContainer.removeChild(mobileContainer.firstChild);
        }
        
        // 首先添加非卡片元素（如警告、提示等）
        nonCardElements.forEach(el => {
            mobileContainer.appendChild(el);
        });
        
        // 添加匹配的卡片
        matchedCards.forEach(card => {
            mobileContainer.appendChild(card);
            card.style.display = '';
        });
        
        // 被过滤的卡片隐藏但仍添加到DOM
        filteredCards.forEach(card => {
            card.style.display = 'none';
            mobileContainer.appendChild(card);
        });
    }
    
    // 更新URL参数，但不刷新页面
    const searchUrlParams = new URLSearchParams(window.location.search);
    
    if (searchText) {
        searchUrlParams.set('search', searchText);
    } else {
        searchUrlParams.delete('search');
    }
    
    if (isMyProjectsOnly) {
        searchUrlParams.set('my_projects', '1');
    } else {
        searchUrlParams.delete('my_projects');
    }
    
    // 更新URL，保留其他参数如排序
    const searchNewUrl = `${window.location.pathname}?${searchUrlParams.toString()}`;
    window.history.replaceState(null, '', searchNewUrl);
    
    // 如果list.html中已经定义了更新按钮状态的函数，则调用它
    if (typeof updateClearButtonState === 'function') {
        setTimeout(updateClearButtonState, 0);
    }
}

// 输入框实时搜索
searchInput.addEventListener('input', function() {
    performSearch();
    });

});

// ===================== 独立的筛选功能初始化 =====================
document.addEventListener('DOMContentLoaded', function() {
    console.log('开始独立初始化列筛选功能');

    // 延迟初始化，确保其他功能先完成
    setTimeout(function() {
        console.log('延迟初始化筛选功能');
        
        // 立即保存原始数据
        saveOriginalData();
        console.log('筛选功能：原始数据已保存');
        
        // 获取筛选功能元素
        const filterIcons = document.querySelectorAll('.filter-icon');
        const filterRow = document.querySelector('.filter-row');
        const filterInputs = document.querySelectorAll('.filter-input');
        
        console.log('找到筛选图标数量:', filterIcons.length, '筛选输入框数量:', filterInputs.length);
        console.log('筛选行元素:', filterRow);
        
        if (filterIcons.length === 0 || filterInputs.length === 0) {
            console.error('未找到筛选功能元素，可能DOM未完全加载');
                return;
            }

    // 记录筛选状态
        let isFilterRowVisible = filterRow && filterRow.style.display !== 'none';
        console.log('初始筛选行显示状态:', isFilterRowVisible);

    // 点击筛选图标时显示/隐藏筛选行
        filterIcons.forEach((icon, index) => {
            console.log(`绑定筛选图标 ${index}，字段:`, icon.getAttribute('data-field'));
            
        icon.addEventListener('click', function(e) {
            e.stopPropagation(); // 阻止事件冒泡到th元素

            const field = this.getAttribute('data-field');
                console.log('点击筛选图标，字段:', field);

            // 切换筛选行显示状态
            if (!isFilterRowVisible) {
                filterRow.style.display = '';
                isFilterRowVisible = true;
                this.classList.add('active');
                    console.log('显示筛选行');

                // 聚焦当前列的输入框
                const input = document.querySelector(`.filter-input[data-field="${field}"]`);
                if (input) {
                    setTimeout(() => input.focus(), 100);
                }
            } else {
                // 如果已经显示，检查是否是切换其他列的筛选
                const activeIcon = document.querySelector('.filter-icon.active');

                    // 如果点击的是同一列，并且没有输入值，则隐藏筛选行并恢复所有内容
                const currentInput = document.querySelector(`.filter-input[data-field="${field}"]`);
                if (activeIcon && activeIcon.getAttribute('data-field') === field &&
                    (!currentInput || !currentInput.value.trim())) {
                        
                        // 清除当前输入框的值
                        if (currentInput) {
                            currentInput.value = '';
                        }
                        
                        // 隐藏筛选行
                    filterRow.style.display = 'none';
                    isFilterRowVisible = false;
                    activeIcon.classList.remove('active');
                        console.log('隐藏筛选行并清除筛选');
                        
                        // 恢复所有项目显示
                        clearAllFilters();
                } else {
                    // 清除所有图标的活动状态
                    filterIcons.forEach(i => {
                        if (i.getAttribute('data-field') !== field &&
                            !document.querySelector(`.filter-input[data-field="${i.getAttribute('data-field')}"]`).value.trim()) {
                            i.classList.remove('active');
                        }
                    });

                    // 设置当前图标为活动状态
                    this.classList.add('active');

                    // 聚焦当前列的输入框
                    if (currentInput) {
                        setTimeout(() => currentInput.focus(), 100);
                    }
                }
            }
        });
    });

    // 处理筛选输入框的输入事件
        filterInputs.forEach((input, index) => {
            console.log(`绑定筛选输入框 ${index}，字段:`, input.getAttribute('data-field'));
            
        input.addEventListener('input', function() {
                console.log('筛选输入事件触发，字段:', this.getAttribute('data-field'), '值:', this.value);
                // 实时筛选，不提交到服务器
            performColumnFilter();
        });

        input.addEventListener('change', function() {
                console.log('筛选change事件触发，字段:', this.getAttribute('data-field'), '值:', this.value);
                // 当输入框失去焦点时，也执行筛选
            performColumnFilter();
        });

        // 防止筛选输入框的点击事件冒泡，避免影响筛选行的显示
        input.addEventListener('click', function(e) {
            e.stopPropagation();
        });

        input.addEventListener('keydown', function(e) {
            // 按ESC键清除筛选条件
            if (e.key === 'Escape') {
                this.value = '';
                performColumnFilter();

                // 检查是否所有筛选都为空，如果是则隐藏筛选行
                let allEmpty = true;
                filterInputs.forEach(inp => {
                    if (inp.value.trim()) allEmpty = false;
                });

                if (allEmpty) {
                    filterRow.style.display = 'none';
                    isFilterRowVisible = false;

                    // 移除所有图标的活动状态
                    filterIcons.forEach(icon => icon.classList.remove('active'));
                        
                        // 恢复所有项目显示
                        clearAllFilters();
                }
            }

                // 按回车键时仅应用筛选，不向服务器提交（避免500错误）
            if (e.key === 'Enter') {
                    e.preventDefault(); // 阻止默认的表单提交行为
                    performColumnFilter(); // 只执行客户端筛选
            }
        });
    });

        // 添加点击其他区域隐藏筛选行的功能
        document.addEventListener('click', function(e) {
            // 如果点击的不是筛选相关元素，则隐藏筛选行
            if (isFilterRowVisible &&
                !e.target.closest('.filter-row') &&
                !e.target.closest('.filter-icon')) {

                // 检查是否有任何筛选条件
                let hasActiveFilters = false;
                filterInputs.forEach(input => {
                    if (input.value.trim()) {
                        hasActiveFilters = true;
                        // 保持对应筛选图标高亮
                        const field = input.getAttribute('data-field');
                        const icon = document.querySelector(`.filter-icon[data-field="${field}"]`);
                        if (icon) icon.classList.add('active');
                    }
                });

                // 如果没有筛选条件，隐藏筛选行并恢复所有项目显示
                if (!hasActiveFilters) {
                    filterRow.style.display = 'none';
                    isFilterRowVisible = false;

                    // 移除所有图标的活动状态
                    filterIcons.forEach(icon => icon.classList.remove('active'));
                    
                    // 恢复所有项目显示
                    clearAllFilters();
                }
            }
        });
        
        console.log('列筛选功能初始化完成');
        
    }, 500); // 延迟500ms确保主要功能先初始化完成
});

// 恢复所有项目显示的函数
function restoreAllItems() {
    console.log('恢复所有项目显示，原始行数:', originalTableRows.length, '原始卡片数:', originalMobileCards.length);
    
    // 如果原始数据未保存，重新保存
    if (originalTableRows.length === 0) {
        console.log('原始数据为空，重新保存');
        saveOriginalData();
    }
    
    // 恢复PC端表格行显示
    originalTableRows.forEach(row => {
        row.classList.remove('filtered');
        row.style.display = '';
    });
    
    // 恢复移动端卡片显示
    originalMobileCards.forEach(card => {
        card.classList.remove('filtered');
        card.style.display = '';
    });
}

// 清除所有筛选条件的函数
function clearAllFilters() {
    console.log('清除所有筛选条件');

    // 清除所有筛选输入框的值（不触发input事件）
    const filterInputs = document.querySelectorAll('.filter-input');
        filterInputs.forEach(input => {
        input.value = '';
    });
    
    // 移除所有筛选图标的活动状态
    const filterIcons = document.querySelectorAll('.filter-icon');
    filterIcons.forEach(icon => {
        icon.classList.remove('active');
        });

    // 恢复所有项目显示
    restoreAllItems();
    }

    // 执行列筛选
    function performColumnFilter() {
    console.log('开始执行列筛选');
    
    // 如果原始数据未保存，重新保存
    if (originalTableRows.length === 0) {
        console.log('原始数据为空，重新保存');
        saveOriginalData();
    }
    
    console.log('当前原始数据行数:', originalTableRows.length, '卡片数:', originalMobileCards.length);
    
        const tableBody = document.querySelector('.table tbody');
    const mobileContainer = document.querySelector('.d-block.d-lg-none');
    const filterInputs = document.querySelectorAll('.filter-input');

        // 收集所有筛选条件
        const filters = {};
        filterInputs.forEach(input => {
            const field = input.getAttribute('data-field');
            const value = input.value.trim().toLowerCase();
            if (value) {
                filters[field] = value;
            console.log('添加筛选条件:', field, '=', value);
            }
        });
        
    console.log('筛选条件数量:', Object.keys(filters).length);
    
    // 如果没有筛选条件，恢复所有项目显示
    if (Object.keys(filters).length === 0) {
        console.log('无筛选条件，恢复所有项目显示');
        restoreAllItems();
        return;
    }
    
    // 筛选PC端表格行
    let visibleRowCount = 0;
    console.log('开始筛选表格行，总行数:', originalTableRows.length);

    originalTableRows.forEach((row, index) => {
            let showRow = true;

            // 检查每个筛选条件
            for (const [field, filterValue] of Object.entries(filters)) {
                const columnIndex = getColumnIndexByField(field);
                if (columnIndex !== -1) {
                    const cell = row.cells[columnIndex];
                    if (cell) {
                        const cellValue = cell.textContent.toLowerCase();

                        // 日期字段特殊处理
                        if (field === 'report_time' || field === 'delivery_forecast' ||
                            field === 'created_at' || field === 'updated_at') {

                            // 比较日期（YYYY-MM-DD格式）
                            const cellDate = cellValue.match(/\d{4}-\d{2}-\d{2}/);

                            if (cellDate && cellDate[0] !== filterValue) {
                                showRow = false;
                                break;
                            } else if (!cellDate && filterValue) {
                                showRow = false;
                                break;
                            }
                        }
                        // 数字字段特殊处理
                        else if (field === 'quotation_customer') {
                            // 移除逗号后比较数字
                            const numericCellValue = cellValue.replace(/,/g, '');
                            if (!numericCellValue.includes(filterValue)) {
                                showRow = false;
                                break;
                            }
                        }
                        // 普通文本字段
                        else if (!cellValue.includes(filterValue)) {
                            showRow = false;
                            break;
                        }
                    }
            } else {
                console.log('无法找到字段对应的列索引:', field);
                }
            }

        // 设置行的可见性
            if (showRow) {
            row.style.display = '';
                row.classList.remove('filtered');
            visibleRowCount++;
            } else {
            row.style.display = 'none';
                row.classList.add('filtered');
            }
        });

    // 筛选移动端卡片
    let visibleCardCount = 0;
    console.log('开始筛选移动端卡片，总卡片数:', originalMobileCards.length);
    
    originalMobileCards.forEach((card, index) => {
        let showCard = true;
        const cardText = card.textContent.toLowerCase();

        // 检查每个筛选条件（移动端使用简单的文本匹配）
        for (const [field, filterValue] of Object.entries(filters)) {
            if (!cardText.includes(filterValue)) {
                showCard = false;
                break;
            }
        }

        // 设置卡片的可见性
        if (showCard) {
            card.style.display = '';
            card.classList.remove('filtered');
            visibleCardCount++;
        } else {
            card.style.display = 'none';
            card.classList.add('filtered');
            }
    });

    console.log('筛选完成，可见行数:', visibleRowCount, '可见卡片数:', visibleCardCount);

    // 确保所有原始数据都在DOM中
    if (tableBody) {
        originalTableRows.forEach(row => {
            if (!tableBody.contains(row)) {
                tableBody.appendChild(row);
            }
        });
    }
    
    if (mobileContainer) {
        originalMobileCards.forEach(card => {
            if (!mobileContainer.contains(card)) {
                mobileContainer.appendChild(card);
            }
            });
        }

        // 高亮活动的筛选图标
    const filterIcons = document.querySelectorAll('.filter-icon');
        filterIcons.forEach(icon => {
            const field = icon.getAttribute('data-field');
            const input = document.querySelector(`.filter-input[data-field="${field}"]`);

            if (input && input.value.trim()) {
                icon.classList.add('active');
            } else {
                icon.classList.remove('active');
            }
        });
        
        // 更新按钮状态
        if (typeof updateClearButtonState === 'function') {
            setTimeout(updateClearButtonState, 0);
        }
    }

    // 根据字段名获取列索引
    function getColumnIndexByField(field) {
        // 计算列偏移量，考虑到复选框列
        const hasCheckbox = document.querySelector('th .form-check') !== null;
        const offset = hasCheckbox ? 1 : 0;

        // 获取表头和字段的映射关系
        const thElements = document.querySelectorAll('th[data-sort]');
        for (let i = 0; i < thElements.length; i++) {
            if (thElements[i].getAttribute('data-sort') === field) {
                return i + offset;
            }
        }
        return -1;
    }

// 添加排序功能
    // 排序状态变量
    let sortBy = 'id';  // 默认按ID排序
    let sortOrder = 'desc';  // 默认降序

    // 表头排序点击事件
    document.querySelectorAll('.sort-icon').forEach(icon => {
        icon.addEventListener('click', function(e) {
            e.stopPropagation(); // 阻止事件冒泡

            const clickedSortBy = this.getAttribute('data-sort');

            // 切换排序方向或设置新的排序字段
            if (sortBy === clickedSortBy) {
                // 切换排序方向
                sortOrder = sortOrder === 'asc' ? 'desc' : 'asc';
            } else {
                // 新的排序字段，默认降序
                sortBy = clickedSortBy;
                sortOrder = 'desc';
            }

            // 更新排序图标
            updateSortIcons();

            // 重新加载页面，带上排序参数
            const urlParams = new URLSearchParams(window.location.search);
            const searchParam = urlParams.get('search');

            let newUrl = window.location.pathname + '?sort=' + sortBy + '&order=' + sortOrder;
            if (searchParam) {
                newUrl += '&search=' + encodeURIComponent(searchParam);
            }

            // 收集所有筛选参数
            const filterInputs = document.querySelectorAll('.filter-input');
            const activeFilters = {};
            filterInputs.forEach(input => {
                const value = input.value.trim();
                if (value) {
                    const field = input.getAttribute('data-field');
                    activeFilters[field] = value;
                }
            });

            // 添加筛选参数到URL
            for (const [field, value] of Object.entries(activeFilters)) {
                newUrl += `&filter_${field}=${encodeURIComponent(value)}`;
            }

            window.location.href = newUrl;
        });
    });

    // 更新排序图标
    function updateSortIcons() {
        // 重置所有图标
        document.querySelectorAll('.sort-icon').forEach(icon => {
            icon.className = 'fas fa-sort sort-icon';
            icon.setAttribute('data-sort', icon.getAttribute('data-sort'));
        });

        // 设置当前排序列的图标
        const currentSortHeader = document.querySelector(`.sort-icon[data-sort="${sortBy}"]`);
        if (currentSortHeader) {
            currentSortHeader.className = sortOrder === 'asc' ? 'fas fa-sort-up sort-icon' : 'fas fa-sort-down sort-icon';
        }
    }

    // 初始化时根据URL参数设置排序状态
    const sortParams = new URLSearchParams(window.location.search);
    if (sortParams.has('sort')) {
        sortBy = sortParams.get('sort');
        if (sortParams.has('order')) {
            sortOrder = sortParams.get('order');
        }
        // 更新排序图标
        updateSortIcons();
    }

    // 初始化筛选字段
    for (const [key, value] of sortParams.entries()) {
        if (key.startsWith('filter_')) {
            const field = key.substring(7);  // 移除 'filter_' 前缀
            const input = document.querySelector(`.filter-input[data-field="${field}"]`);
            if (input) {
                input.value = value;

                // 显示筛选行
                document.querySelector('.filter-row').style.display = '';

                // 高亮筛选图标
                const icon = document.querySelector(`.filter-icon[data-field="${field}"]`);
                if (icon) {
                    icon.classList.add('active');
                }
            }
        }
    }

// 批量选择和删除功能
    const selectAllCheckbox = document.getElementById('selectAll');
    const projectCheckboxes = document.querySelectorAll('.project-checkbox');
    const batchDeleteBtn = document.getElementById('batchDeleteBtn');

    if (selectAllCheckbox) {
        // 全选/取消全选
        selectAllCheckbox.addEventListener('change', function() {
            const isChecked = this.checked;

            projectCheckboxes.forEach(checkbox => {
                if (!checkbox.disabled) {
                    checkbox.checked = isChecked;
                }
            });

            updateBatchDeleteButton();
        });
    }

    // 单个复选框状态变化
    projectCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            updateBatchDeleteButton();

            // 更新全选框状态
            if (selectAllCheckbox) {
                const enabledCheckboxes = Array.from(projectCheckboxes).filter(cb => !cb.disabled);
                const allChecked = enabledCheckboxes.every(cb => cb.checked);
                selectAllCheckbox.checked = allChecked && enabledCheckboxes.length > 0;
            }
        });
    });

    // 批量删除按钮点击事件
    if (batchDeleteBtn) {
        batchDeleteBtn.addEventListener('click', function() {
            const selectedIds = Array.from(projectCheckboxes)
                .filter(checkbox => checkbox.checked)
                .map(checkbox => parseInt(checkbox.value));

            if (selectedIds.length === 0) {
                alert('请至少选择一个项目');
                return;
            }

            if (confirm(`确定要删除已选中的 ${selectedIds.length} 个项目吗？此操作不可恢复！`)) {
                // 发送批量删除请求
                fetch('/project/api/batch-delete', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest',
                        'X-CSRFToken': '{{ csrf_token() }}'
                    },
                    body: JSON.stringify({
                        project_ids: selectedIds
                    })
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('请求失败，状态码: ' + response.status);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        alert(data.message);
                        window.location.reload();
                    } else {
                        alert('删除失败: ' + data.message);
                        console.error('删除失败详情:', data.failure_reasons);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('操作失败，请重试: ' + error.message);
                });
            }
        });
    }

    // 更新批量删除按钮状态
    function updateBatchDeleteButton() {
        if (batchDeleteBtn) {
            const anyChecked = Array.from(projectCheckboxes).some(checkbox => checkbox.checked);
            batchDeleteBtn.style.display = anyChecked ? 'inline-block' : 'none';
        }
    }

    // 初始化批量删除按钮状态
    updateBatchDeleteButton();

// 添加行滚动焦点效果
const tableContainer = document.querySelector('.table-responsive');
if (tableContainer) {
    const rows = document.querySelectorAll('.table tbody tr');
    let lastHighlightedRow = null;

    // 鼠标滑过行时添加高亮
    rows.forEach(row => {
        row.addEventListener('mouseenter', function() {
            if (lastHighlightedRow) {
                lastHighlightedRow.classList.remove('highlight-row');
            }
            this.classList.add('highlight-row');
            lastHighlightedRow = this;
        });
    });

    // 鼠标离开表格区域时移除高亮
    tableContainer.addEventListener('mouseleave', function() {
        if (lastHighlightedRow) {
            lastHighlightedRow.classList.remove('highlight-row');
            lastHighlightedRow = null;
        }
    });

    // 滚动时计算可见行并高亮中心行
    tableContainer.addEventListener('scroll', function() {
        // 节流滚动事件处理，避免性能问题
        if (window.scrollThrottled) return;
        window.scrollThrottled = true;

        setTimeout(() => {
            highlightCenterRow();
            window.scrollThrottled = false;
        }, 100);
    });

    // 高亮中心行函数
    function highlightCenterRow() {
        if (rows.length === 0) return;

        const containerRect = tableContainer.getBoundingClientRect();
        const containerMiddle = containerRect.top + containerRect.height / 2;

        let closestRow = null;
        let minDistance = Infinity;

        // 找出最靠近中心的行
        rows.forEach(row => {
            const rowRect = row.getBoundingClientRect();
            const rowMiddle = rowRect.top + rowRect.height / 2;
            const distance = Math.abs(rowMiddle - containerMiddle);

            // 只考虑可见行
            if (rowRect.top <= containerRect.bottom &&
                rowRect.bottom >= containerRect.top) {
                if (distance < minDistance) {
                    minDistance = distance;
                    closestRow = row;
                }
            }
        });

        // 更新高亮
        if (closestRow && closestRow !== lastHighlightedRow) {
            if (lastHighlightedRow) {
                lastHighlightedRow.classList.remove('highlight-row');
            }
            closestRow.classList.add('highlight-row');
            lastHighlightedRow = closestRow;
        }
    }
}

// 项目批量导入功能
document.addEventListener('DOMContentLoaded', function() {
    const importProjectsBtn = document.getElementById('importProjectsBtn');
    const importModal = new bootstrap.Modal(document.getElementById('importProjectModal'));
    const ownerSelect = document.getElementById('ownerSelect');
    const projectExcelFile = document.getElementById('projectExcelFile');
    const parseExcelBtn = document.getElementById('parseExcelBtn');
    const importBtn = document.getElementById('importBtn');
    const previewDiv = document.getElementById('importPreview');
    const fieldMappingDiv = document.getElementById('fieldMapping');
    const conflictsDiv = document.getElementById('importConflicts');
    const progressDiv = document.getElementById('importProgress');
    const resultDiv = document.getElementById('importResult');
    const applyRecommendedActionsBtn = document.getElementById('applyRecommendedActions');
    const keepAllConflictsBtn = document.getElementById('keepAllConflicts');
    const ignoreAllConflictsBtn = document.getElementById('ignoreAllConflicts');

    let parsedData = [];
    let conflicts = [];
    let conflictActions = {};
    let fieldMapping = {};
    let userNameToId = {}; // 新增：销售负责人姓名到ID的映射
    let unmatchedProjects = []; // 新增：未匹配到销售负责人的项目

    // 打开导入模态框
    if (importProjectsBtn) {
        importProjectsBtn.addEventListener('click', function(e) {
            e.preventDefault();

            // 重置状态
            document.getElementById('importProjectForm').reset();
            previewDiv.style.display = 'none';
            fieldMappingDiv.style.display = 'none';
            conflictsDiv.style.display = 'none';
            progressDiv.style.display = 'none';
            resultDiv.style.display = 'none';
            document.getElementById('importErrorDetails').style.display = 'none';
            importBtn.style.display = 'none';
            parsedData = [];
            conflicts = [];
            conflictActions = {};
            fieldMapping = {};
            userNameToId = {};
            unmatchedProjects = [];

            // 加载用户列表
            fetch('/api/users/hierarchical')
                .then(response => response.json())
                .then(data => {
                    ownerSelect.innerHTML = '<option value="">请选择...</option>';

                    if (data.success) {
                        // 生成嵌套的选择框选项
                        data.data.forEach(company => {
                            const companyOptgroup = document.createElement('optgroup');
                            companyOptgroup.label = company.name + ' (企业)';

                            company.users.forEach(user => {
                                const option = document.createElement('option');
                                option.value = user.id;
                                option.textContent = user.name;
                                companyOptgroup.appendChild(option);
                                // 构建姓名到ID映射
                                userNameToId[user.name] = user.id;
                            });

                            ownerSelect.appendChild(companyOptgroup);
                        });
                    }
                })
                .catch(error => {
                    console.error('获取用户列表失败:', error);
                });

            // 显示模态框
            importModal.show();
        });
    }

    // 解析Excel文件
    if (parseExcelBtn) {
        parseExcelBtn.addEventListener('click', function() {
            const fileInput = document.getElementById('projectExcelFile');
            const ownerIdSelect = document.getElementById('ownerSelect');

            /* 移除必选验证
            if (!ownerIdSelect.value) {
                alert('请选择归属账户');
                return;
            }
            */

            if (!fileInput.files.length) {
                alert('请选择Excel文件');
                return;
            }

            const file = fileInput.files[0];
            const reader = new FileReader();

            resultDiv.style.display = 'none';
            progressDiv.style.display = 'block';
            const progressBar = progressDiv.querySelector('.progress-bar');
            progressBar.style.width = '30%';

            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {type: 'array', cellDates: true, dateNF: 'yyyy-mm-dd'});

                    // 获取第一个工作表
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];

                    // 转换为JSON
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, {
                        header: 1,
                        raw: false,
                        dateNF: 'YYYY-MM-DD'
                    });

                    if (jsonData.length <= 1) {
                        alert('工作表中未找到足够的数据，请确保至少有标题行和一行数据');
                        progressDiv.style.display = 'none';
                        return;
                    }

                    // 获取表头
                    const headers = jsonData[0];

                    // 定义数据库字段映射
                    const dbFields = {
                        "项目名称": "project_name",
                        "报备时间": "report_time",
                        "项目分类": "project_type",
                        "报备来源": "report_source",
                        "品牌情况": "product_situation",
                        "用户": "end_user",
                        "设计院及顾问": "design_issues",
                        "经销商": "dealer",
                        "总承包商": "contractor",
                        "系统集成商": "system_integrator",
                        "阶段状态": "current_stage",
                        "项目跟进记录": "stage_description",
                        "授权编号": "authorization_code",
                        "预测签约时间": "delivery_forecast",
                        "更新时间": "updated_at",
                        "销售负责人": "owner_id"
                    };

                    // 定义数据库字段中文名称
                    const dbFieldsChineseNames = {
                        "project_name": "项目名称",
                        "report_time": "报备时间",
                        "created_at": "创建日期",
                        "project_type": "项目分类",
                        "report_source": "报备来源",
                        "product_situation": "品牌情况",
                        "end_user": "用户",
                        "design_issues": "设计院及顾问",
                        "dealer": "经销商",
                        "contractor": "总承包商",
                        "system_integrator": "系统集成商",
                        "current_stage": "阶段状态",
                        "stage_description": "项目跟进记录",
                        "authorization_code": "授权编号",
                        "delivery_forecast": "预测签约时间",
                        "updated_at": "更新时间",
                        "owner_id": "销售负责人"
                    };

                    // 自动映射字段
                    fieldMapping = {};
                    headers.forEach(header => {
                        const matchedField = dbFields[header] || '';
                        if (matchedField) {
                            fieldMapping[header] = matchedField;
                        }
                    });

                    // 转换为对象数组
                    parsedData = [];
                    unmatchedProjects = [];
                    for (let i = 1; i < jsonData.length; i++) {
                        const rowData = {};
                        let rowIsEmpty = true;

                        headers.forEach((header, index) => {
                            const value = jsonData[i][index];
                            if (value !== undefined && value !== null && value !== '') {
                                rowData[header] = value;
                                rowIsEmpty = false;
                            }
                        });

                        // 只添加非空行
                        if (!rowIsEmpty) {
                            // 新增：销售负责人比对逻辑
                            const selectedOwnerId = ownerIdSelect.value;
                            const ownerHeader = Object.keys(fieldMapping).find(h => fieldMapping[h] === 'owner_id');
                            let ownerName = ownerHeader ? rowData[ownerHeader] : '';
                            if (!selectedOwnerId) {
                                if (ownerName && userNameToId[ownerName]) {
                                    rowData[ownerHeader] = ownerName; // 保留原始名
                                    rowData['owner_id'] = userNameToId[ownerName];
                            parsedData.push(rowData);
                                } else {
                                    unmatchedProjects.push(rowData['项目名称'] || rowData['project_name'] || '(无项目名)');
                                }
                            } else {
                                parsedData.push(rowData);
                            }
                        }
                    }

                    if (parsedData.length === 0) {
                        alert('未在工作表中找到有效数据');
                        progressDiv.style.display = 'none';
                        return;
                    }

                    // 处理授权编号格式
                    function formatAuthCode(code) {
                        if (code && typeof code === 'string' && code.startsWith('HY-')) {
                            return code.substring(3);
                        }
                        return code;
                    }

                    // 预览表头
                    const previewHeader = document.getElementById('previewHeader');
                    previewHeader.innerHTML = '';

                    // 创建反向映射，从数据库字段找到Excel表头
                    const reverseMapping = {};
                    for (const [excelHeader, dbField] of Object.entries(fieldMapping)) {
                        reverseMapping[dbField] = excelHeader;
                    }

                    // 指定需要显示的字段及其顺序
                    const orderedFields = [
                        "authorization_code",  // 授权编码
                        "project_name",        // 项目名称
                        "report_source",       // 报备来源
                        "project_type",        // 项目类型
                        "product_situation",   // 品牌情况
                        "current_stage",       // 当前阶段
                        "delivery_forecast",   // 出货预测日期
                        "end_user",            // 直接用户
                        "design_issues",       // 设计院及顾问
                        "contractor",          // 总承包单位
                        "system_integrator",   // 系统集成商
                        "dealer",              // 经销商
                        "stage_description",   // 阶段说明
                        "report_time",         // 报备时间
                        "created_at",          // 创建日期
                        "updated_at",          // 更新日期
                        "owner_id"             // 销售负责人
                    ];

                    // 添加数据库字段中文名称作为表头
                    orderedFields.forEach(dbField => {
                        const th = document.createElement('th');
                        const chineseName = dbFieldsChineseNames[dbField] || dbField;
                        th.textContent = chineseName;

                        // 如果是授权编号字段，添加格式化提示
                        if (dbField === 'authorization_code') {
                            th.innerHTML = `${chineseName}<br><small class="text-success">(将自动格式化)</small>`;
                        }

                        previewHeader.appendChild(th);
                    });

                    // 清空预览数据
                    const previewBody = document.getElementById('previewBody');
                    previewBody.innerHTML = '';

                    // 显示前5行或所有行（如果少于5行）
                    const rowsToShow = Math.min(5, parsedData.length);
                    for (let i = 0; i < rowsToShow; i++) {
                        const tr = document.createElement('tr');
                        const rowData = parsedData[i];

                        // 按指定的字段顺序添加内容
                        orderedFields.forEach(dbField => {
                            const td = document.createElement('td');
                            const excelHeader = reverseMapping[dbField];

                            if (dbField === 'authorization_code') {
                                // 授权编号专用逻辑
                                let rawValue = '';
                            if (excelHeader && rowData[excelHeader] !== undefined) {
                                    rawValue = rowData[excelHeader];
                                }
                                // 格式化
                                const formatted = formatAuthCode(rawValue);
                                td.textContent = formatted || '';
                            } else if (dbField === 'owner_id') {
                                // 新增：显示销售负责人姓名而不是ID
                                let id = rowData['owner_id'];
                                let name = '';
                                for (const uname in userNameToId) {
                                    if (userNameToId[uname] === id) {
                                        name = uname;
                                        break;
                                    }
                                }
                                td.textContent = name || id || '';
                            } else if (excelHeader && rowData[excelHeader] !== undefined) {
                                let value = rowData[excelHeader];
                                // 格式化日期字段
                                if ((dbField === 'report_time' || dbField === 'delivery_forecast' ||
                                     dbField === 'created_at' || dbField === 'updated_at') && value) {
                                    if (typeof value === 'string' && value.match(/^[0-9]+$/)) {
                                        const dateObj = XLSX.SSF.parse_date_code(parseInt(value));
                                        if (dateObj) {
                                            const year = dateObj.y;
                                            const month = dateObj.m.toString().padStart(2, '0');
                                            const day = dateObj.d.toString().padStart(2, '0');
                                            value = `${year}-${month}-${day}`;
                                        }
                                    }
                                }
                                        td.textContent = value;
                            } else if (dbField === 'created_at') {
                                // 如果是创建日期字段，使用报备时间的值
                                const reportTimeHeader = reverseMapping['report_time'];
                                if (reportTimeHeader && rowData[reportTimeHeader]) {
                                    let value = rowData[reportTimeHeader];
                                    if (typeof value === 'string' && value.match(/^[0-9]+$/)) {
                                        const dateObj = XLSX.SSF.parse_date_code(parseInt(value));
                                        if (dateObj) {
                                            const year = dateObj.y;
                                            const month = dateObj.m.toString().padStart(2, '0');
                                            const day = dateObj.d.toString().padStart(2, '0');
                                            value = `${year}-${month}-${day}`;
                                        }
                                    }
                                    td.textContent = value;
                                } else {
                                    td.textContent = '';
                                }
                            } else {
                                td.textContent = '';
                            }
                            tr.appendChild(td);
                        });
                        previewBody.appendChild(tr);
                    }

                    previewDiv.style.display = 'block';
                    fieldMappingDiv.style.display = 'block';
                    progressBar.style.width = '70%';

                    // 检查冲突
                    progressBar.style.width = '80%';

                    // 在这里发送请求检查冲突，此次简化为前端模拟
                    fetch('/api/projects/check-conflicts', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': '{{ csrf_token() }}'
                        },
                        body: JSON.stringify({
                            projects: parsedData,
                            field_mapping: fieldMapping
                        })
                    })
                    .then(response => response.json())
                    .then(data => {
                        progressBar.style.width = '100%';

                        if (data.success) {
                            conflicts = data.conflicts || [];

                            // 显示冲突
                            if (conflicts.length > 0) {
                                const conflictsBody = document.getElementById('conflictsBody');
                                conflictsBody.innerHTML = '';

                                conflicts.forEach((conflict, index) => {
                                    const tr = document.createElement('tr');

                                    const tdName = document.createElement('td');
                                    tdName.textContent = conflict.project_name;
                                    tr.appendChild(tdName);

                                    const tdCode = document.createElement('td');
                                    tdCode.textContent = conflict.authorization_code || '未指定';
                                    tr.appendChild(tdCode);

                                    const tdType = document.createElement('td');
                                    tdType.textContent = conflict.conflict_type === 'code' ? '授权编号冲突' : '项目名称相似';
                                    tr.appendChild(tdType);

                                    const tdAction = document.createElement('td');
                                    const actionSelect = document.createElement('select');
                                    actionSelect.classList.add('form-select', 'form-select-sm');
                                    actionSelect.dataset.index = index;

                                    const ignoreOpt = document.createElement('option');
                                    ignoreOpt.value = 'ignore';
                                    ignoreOpt.textContent = '忽略不导入';

                                    const newOpt = document.createElement('option');
                                    newOpt.value = 'new';
                                    newOpt.textContent = '作为新项目导入';

                                    actionSelect.appendChild(ignoreOpt);
                                    actionSelect.appendChild(newOpt);

                                    // 根据冲突类型设置默认选择
                                    if (conflict.conflict_type === 'code') {
                                        // 授权编号冲突默认忽略
                                        ignoreOpt.selected = true;
                                        conflictActions[index] = 'ignore';
                                    } else {
                                        // 名称相似默认新建
                                        newOpt.selected = true;
                                        conflictActions[index] = 'new';
                                    }

                                    actionSelect.addEventListener('change', function() {
                                        conflictActions[this.dataset.index] = this.value;
                                    });

                                    tdAction.appendChild(actionSelect);
                                    tr.appendChild(tdAction);

                                    conflictsBody.appendChild(tr);
                                });

                                conflictsDiv.style.display = 'block';
                            }

                            // 显示导入按钮
                            importBtn.style.display = 'block';
                        } else {
                            resultDiv.className = 'alert alert-danger mt-3';
                            resultDiv.textContent = data.message || '检查冲突时出现错误';
                            resultDiv.style.display = 'block';
                        }

                        progressDiv.style.display = 'none';
                    })
                    .catch(error => {
                        console.error('冲突检查出错:', error);
                        progressBar.style.width = '100%';
                        progressDiv.style.display = 'none';

                        resultDiv.className = 'alert alert-danger mt-3';
                        resultDiv.textContent = '请求服务器时出错，请重试';
                        resultDiv.style.display = 'block';
                    });

                } catch (err) {
                    console.error('解析Excel出错:', err);

                    resultDiv.className = 'alert alert-danger mt-3';
                    resultDiv.textContent = '解析Excel文件失败: ' + err.message;
                    resultDiv.style.display = 'block';

                    progressDiv.style.display = 'none';
                }
            };

            reader.onerror = function() {
                resultDiv.className = 'alert alert-danger mt-3';
                resultDiv.textContent = '读取文件时出错';
                resultDiv.style.display = 'block';

                progressDiv.style.display = 'none';
            };

            reader.readAsArrayBuffer(file);
        });
    }

    // 处理冲突操作按钮
    if (applyRecommendedActionsBtn) {
        applyRecommendedActionsBtn.addEventListener('click', function() {
            document.querySelectorAll('#conflictsBody select').forEach(select => {
                const index = parseInt(select.dataset.index);
                const conflict = conflicts[index];

                // 应用智能推荐: 对授权编号冲突忽略，对名称相似新建
                if (conflict.conflict_type === 'code') {
                    select.value = 'ignore';
                } else {
                    select.value = 'new';
                }

                // 更新选择
                conflictActions[index] = select.value;
            });
        });
    }

    if (keepAllConflictsBtn) {
        keepAllConflictsBtn.addEventListener('click', function() {
            document.querySelectorAll('#conflictsBody select').forEach(select => {
                select.value = 'new';
                conflictActions[select.dataset.index] = 'new';
            });
        });
    }

    if (ignoreAllConflictsBtn) {
        ignoreAllConflictsBtn.addEventListener('click', function() {
            document.querySelectorAll('#conflictsBody select').forEach(select => {
                select.value = 'ignore';
                conflictActions[select.dataset.index] = 'ignore';
            });
        });
    }

    // 确认导入
    if (importBtn) {
        importBtn.addEventListener('click', function() {
            const ownerId = ownerSelect.value;

            /* 移除必选验证
            if (!ownerId) {
                alert('请选择归属账户');
                return;
            }
            */

            if (parsedData.length === 0) {
                alert('没有可导入的数据');
                return;
            }

            // 显示进度条
            resultDiv.style.display = 'none';
            progressDiv.style.display = 'block';
            const progressBar = progressDiv.querySelector('.progress-bar');
            progressBar.style.width = '0%';

            // 禁用导入按钮，防止重复提交
            importBtn.disabled = true;

            // 发送数据到服务器
            fetch('/api/projects/import', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token() }}'
                },
                body: JSON.stringify({
                    owner_id: ownerId,
                    projects: parsedData,
                    conflict_actions: conflictActions,
                    field_mapping: fieldMapping,
                    sync_report_time_to_created_at: true,  // 添加标志以同步报备时间到创建时间
                    use_excel_owner: !ownerId  // 如果未选择归属账户，则使用Excel中的销售负责人字段
                })
            })
            .then(response => response.json())
            .then(data => {
                progressBar.style.width = '100%';

                // 显示结果
                if (data.success) {
                    resultDiv.className = 'alert alert-success mt-3';
                    resultDiv.innerHTML = `导入完成，新增: ${data.data.imported}，跳过: ${data.data.skipped}，错误: ${data.data.error}`;

                    // 如果有错误，显示错误详情
                    if (data.data.error > 0 && data.data.error_details && data.data.error_details.length > 0) {
                        const errorDetailsDiv = document.getElementById('importErrorDetails');
                        const errorTableBody = document.getElementById('errorDetailsTableBody');
                        errorTableBody.innerHTML = '';

                        data.data.error_details.forEach(error => {
                            const tr = document.createElement('tr');

                            const tdLine = document.createElement('td');
                            tdLine.textContent = error.line || 'N/A';
                            tr.appendChild(tdLine);

                            const tdName = document.createElement('td');
                            tdName.textContent = error.project_name || 'N/A';
                            tr.appendChild(tdName);

                            const tdReason = document.createElement('td');
                            tdReason.textContent = error.reason || '未知错误';
                            tr.appendChild(tdReason);

                            errorTableBody.appendChild(tr);
                        });

                        errorDetailsDiv.style.display = 'block';
                    }

                    // 如果导入成功且没有错误，1.5秒后刷新页面
                    if (data.data.error === 0) {
                        setTimeout(() => {
                            window.location.reload();
                        }, 1500);
                    }
                } else {
                    resultDiv.className = 'alert alert-danger mt-3';
                    resultDiv.textContent = data.message || '导入失败';
                }

                resultDiv.style.display = 'block';
                progressDiv.style.display = 'none';

                // 重新启用导入按钮
                importBtn.disabled = false;

                // 新增：导入结果区显示未导入项目
                const unmatchedDiv = document.getElementById('unmatchedProjectsResult');
                if (unmatchedDiv) {
                    if (unmatchedProjects.length > 0) {
                        unmatchedDiv.style.display = 'block';
                        unmatchedDiv.innerHTML =
                            '<div class="alert alert-warning mt-2">' +
                            '<b>以下项目因销售负责人未匹配到系统账户，未导入：</b>' +
                            '<table class="table table-sm table-bordered mt-2"><thead><tr><th>项目名称</th><th>销售负责人</th></tr></thead><tbody>' +
                            unmatchedProjects.map(n => `<tr><td>${n.project}</td><td>${n.owner}</td></tr>`).join('') +
                            '</tbody></table>' +
                            '<button id="unmatchedConfirmBtnResult" class="btn btn-primary btn-sm mt-2">确认</button>' +
                            '</div>';
                        setTimeout(() => {
                            const btn = document.getElementById('unmatchedConfirmBtnResult');
                            if (btn) {
                                btn.onclick = function() {
                                    unmatchedDiv.style.display = 'none';
                                };
                            }
                        }, 100);
                    } else {
                        unmatchedDiv.style.display = 'none';
                        unmatchedDiv.innerHTML = '';
                    }
                }
            })
            .catch(error => {
                console.error('导入出错:', error);

                resultDiv.className = 'alert alert-danger mt-3';
                resultDiv.textContent = '请求服务器时出错，请重试';
                resultDiv.style.display = 'block';

                progressDiv.style.display = 'none';
                importBtn.disabled = false;
            });
        });
    }
});
</script>

<!-- 项目批量导入模态框 -->
<div class="modal fade" id="importProjectModal" tabindex="-1" aria-labelledby="importProjectModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="importProjectModalLabel">批量导入项目</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="importProjectForm" enctype="multipart/form-data">
                    <div class="mb-3">
                        <label for="ownerSelect" class="form-label">请选择归属账户</label>
                        <select class="form-select" id="ownerSelect" name="owner_id">
                            <option value="">不指定(使用Excel中的销售负责人字段)</option>
                            <!-- 选项会通过JavaScript动态加载 -->
                        </select>
                        <div class="form-text">如果不选择，将使用Excel中的销售负责人字段作为项目拥有者</div>
                    </div>

                    <div class="mb-3">
                        <label for="projectExcelFile" class="form-label">上传Excel文件 (.xlsx或.xls) <span class="text-danger">*</span></label>
                        <input class="form-control" type="file" id="projectExcelFile" name="projectExcelFile" accept=".xlsx, .xls" required>
                        <div class="form-text">请上传包含项目数据的Excel文件</div>
                    </div>

                    <!-- 预览区域 -->
                    <div id="importPreview" style="display: none;">
                        <h6>数据预览：</h6>
                        <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                            <table class="table table-sm table-bordered table-hover">
                                <thead class="table-light">
                                    <tr id="previewHeader">
                                        <!-- 表头会动态生成 -->
                                    </tr>
                                </thead>
                                <tbody id="previewBody">
                                    <!-- 预览数据会动态生成 -->
                                </tbody>
                            </table>
                        </div>
                        <div id="unmatchedProjects" style="display:none;"></div>
                    </div>

                    <!-- 字段映射区域 -->
                    <div id="fieldMapping" style="display: none;">
                        <div class="alert alert-info mt-3">
                            <small>系统已自动匹配Excel列与数据库字段，预览显示了映射后的数据</small>
                        </div>
                    </div>

                    <!-- 冲突检测区域 -->
                    <div id="importConflicts" style="display: none;">
                        <h6 class="mt-3">检测到可能的冲突：</h6>
                        <div class="table-responsive" style="max-height: 300px; overflow-y: auto;">
                            <table class="table table-sm table-bordered table-hover">
                                <thead class="table-light">
                                    <tr>
                                        <th>项目名称</th>
                                        <th>授权编号</th>
                                        <th>冲突类型</th>
                                        <th>操作</th>
                                    </tr>
                                </thead>
                                <tbody id="conflictsBody">
                                    <!-- 冲突数据会动态生成 -->
                                </tbody>
                            </table>
                        </div>

                        <div class="d-flex flex-wrap justify-content-between align-items-center mt-3">
                            <div class="mb-2">
                                <span class="text-muted">批量操作:</span>
                            </div>
                            <div class="mb-2">
                                <button type="button" class="btn btn-outline-primary btn-sm me-2" id="applyRecommendedActions">
                                    <i class="fas fa-magic"></i> 应用智能推荐
                                </button>
                                <button type="button" class="btn btn-outline-success btn-sm me-2" id="keepAllConflicts">
                                    <i class="fas fa-plus"></i> 全部导入为新项目
                                </button>
                                <button type="button" class="btn btn-outline-secondary btn-sm" id="ignoreAllConflicts">
                                    <i class="fas fa-times"></i> 全部忽略不导入
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- 进度条 -->
                    <div id="importProgress" class="progress mt-3" style="display: none;">
                        <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%"></div>
                    </div>

                    <!-- 导入结果 -->
                    <div id="importResult" class="alert mt-3" style="display: none;"></div>
                    <div id="unmatchedProjectsResult" style="display:none;"></div>

                    <!-- 错误详情区域 -->
                    <div id="importErrorDetails" class="mt-3" style="display: none;">
                        <h6 class="text-danger">导入错误详情:</h6>
                        <div class="table-responsive" style="max-height: 300px; overflow-y: auto;">
                            <table class="table table-sm table-bordered table-hover">
                                <thead class="table-light">
                                    <tr>
                                        <th>行号</th>
                                        <th>项目名称</th>
                                        <th>错误原因</th>
                                    </tr>
                                </thead>
                                <tbody id="errorDetailsTableBody">
                                    <!-- 错误详情会动态加载 -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" id="parseExcelBtn">解析文件</button>
                <button type="button" class="btn btn-success" id="importBtn" style="display: none;">确认导入</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/echarts@5.4.2/dist/echarts.min.js"></script>
<!-- 引用账户切换功能模块 -->
<script src="{{ url_for('static', filename='js/project_statistics_account.js') }}"></script>
<!-- 引用项目列表账户同步模块 -->
<script src="{{ url_for('static', filename='js/project_list_account.js') }}"></script>
<script src="{{ url_for('static', filename='js/project_statistics.js') }}"></script>
{% endblock %}

<!-- 在页面加载时保存原始数据结构 -->
<script>
let originalTableRows = [];
let originalMobileCards = [];

// 保存原始数据结构
function saveOriginalData() {
    const tableRows = document.querySelectorAll('.table tbody tr');
    const mobileCards = document.querySelectorAll('.d-block.d-lg-none .card');
    
    originalTableRows = Array.from(tableRows);
    originalMobileCards = Array.from(mobileCards);
    
    console.log('已保存原始数据，表格行数:', originalTableRows.length, '移动端卡片数:', originalMobileCards.length);
    
    // 额外验证：检查保存的数据是否有效
    if (originalTableRows.length > 0) {
        console.log('第一行数据示例:', originalTableRows[0].textContent.substring(0, 100));
    }
    if (originalMobileCards.length > 0) {
        console.log('第一个卡片数据示例:', originalMobileCards[0].textContent.substring(0, 100));
    }
}

// 检查卡片激活状态的函数
function checkCardActiveState(cardId, paramNames, expectedValues) {
    const card = document.getElementById(cardId);
    if (!card) return;
    
    const params = new URLSearchParams(window.location.search);
    let allMatch = true;
    
    for (let i = 0; i < paramNames.length; i++) {
        const paramValue = params.get(paramNames[i]);
        if (paramValue !== expectedValues[i]) {
            allMatch = false;
            break;
        }
    }
    
    if (allMatch) {
        card.classList.add('active-filter');
    } else {
        card.classList.remove('active-filter');
    }
}

// 在页面加载完成后立即保存原始数据，并在筛选功能初始化前确保数据已保存
document.addEventListener('DOMContentLoaded', function() {
    // 立即保存原始数据
    console.log('页面加载完成，开始保存原始数据');
    saveOriginalData();
    
    // 如果第一次保存失败（可能因为DOM还未完全准备好），稍后再试
    if (originalTableRows.length === 0) {
        console.log('首次保存失败，1秒后重试');
        setTimeout(function() {
            saveOriginalData();
            if (originalTableRows.length === 0) {
                console.error('重试后仍无法保存原始数据，可能表格还未渲染');
            }
        }, 1000);
    }
    

});


</script>

<!-- 筛选功能调试代码 -->
<script>


// 添加全局调试函数，可在浏览器控制台中调用
window.debugFilterFunction = function() {
    console.log('=== 筛选功能调试信息 ===');
    
    const filterIcons = document.querySelectorAll('.filter-icon');
    const filterRow = document.querySelector('.filter-row');
    const filterInputs = document.querySelectorAll('.filter-input');
    
    console.log('筛选图标数量:', filterIcons.length);
    console.log('筛选行元素:', filterRow);
    console.log('筛选输入框数量:', filterInputs.length);
    console.log('原始数据行数:', originalTableRows.length);
    console.log('原始卡片数:', originalMobileCards.length);
    
    if (filterIcons.length > 0) {
        console.log('第一个筛选图标:', filterIcons[0]);
        console.log('第一个筛选图标的data-field:', filterIcons[0].getAttribute('data-field'));
        
        // 检查事件监听器
        console.log('第一个筛选图标的事件监听器数量:', getEventListeners ? getEventListeners(filterIcons[0]) : '无法检查(需要在开发者工具中运行)');
    }
    
    if (filterInputs.length > 0) {
        console.log('第一个筛选输入框:', filterInputs[0]);
        console.log('第一个筛选输入框的data-field:', filterInputs[0].getAttribute('data-field'));
    }
    
    // 测试点击第一个筛选图标
    if (filterIcons.length > 0) {
        console.log('测试点击第一个筛选图标...');
        filterIcons[0].click();
        
        // 检查筛选行是否显示
        setTimeout(() => {
            const isVisible = filterRow && filterRow.style.display !== 'none';
            console.log('点击后筛选行是否显示:', isVisible);
        }, 100);
    }
    
    console.log('=== 调试信息结束 ===');
};

// 测试筛选功能的简化版本
window.testFilter = function() {
    console.log('开始测试筛选功能...');
    const firstIcon = document.querySelector('.filter-icon');
    if (firstIcon) {
        console.log('找到第一个筛选图标，准备点击');
        firstIcon.click();
    } else {
        console.error('未找到筛选图标');
    }
};



// 在页面完全加载后自动运行一次调试
window.addEventListener('load', function() {
    setTimeout(function() {
        console.log('页面完全加载，自动运行筛选功能调试');
        console.log('您可以在控制台中运行以下命令:');
        console.log('  debugFilterFunction() - 查看详细调试信息');
        console.log('  testFilter() - 测试筛选功能');

        
        if (typeof window.debugFilterFunction === 'function') {
            window.debugFilterFunction();
        }
    }, 1000);
});
</script>