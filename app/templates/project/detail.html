{% extends "base.html" %}
{% from 'macros/ui_helpers.html' import render_project_type, render_owner, render_date, render_datetime, render_authorization_code, render_currency, render_quotation_number, render_project_stage, render_project_rating, render_rating_input, render_confirmation_badge %}
{% import 'macros/ui_helpers.html' as ui %}
{% from 'macros/approval_macros.html' import render_approval_timeline, render_approval_form, render_start_approval_button, render_approval_section %}
{% from 'macros/ui_modals.html' import render_change_project_owner_modal %}

{% block title %}{{ _('项目详情') }}{% endblock %}

{% block head %}
<!-- 引入项目阶段进度条样式 -->
<link rel="stylesheet" href="{{ url_for('static', filename='css/project_stages.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/approval_timeline.css') }}">
<style>
    /* 仅项目详情页主容器顶部留白，避免被fixed导航遮挡 */
    .container.project-detail-main {
        margin-top: 72px !important; /* 72px为主导航高度+安全间距 */
    }
    @media (max-width: 991.98px) {
        .container.project-detail-main {
            margin-top: 120px !important;
        }
    }
    
    /* 统一字体大小样式 */
    .standard-font {
        font-size: 0.95rem !important;
    }
    
    /* 标题保持原有大小，其他文本元素统一使用standard-font类 */
    h4.timeline-title {
        font-size: 1.1rem !important;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4 project-detail-main">
    <div class="row mb-3">
        <div class="col-md-12">
            <div class="d-flex align-items-start justify-content-between">
                <div class="flex-grow-1" style="max-width: 60%; min-width: 0;">
                    <div class="d-flex align-items-center flex-wrap">
                        <h2 class="mb-0 me-3 text-truncate" style="max-width: 100%;" title="{{ project.project_name }}">{{ project.project_name }}</h2>
                        <!-- 五星评分显示在标题旁边 -->
                        <div class="d-flex align-items-center title-rating mt-1">
                            {% if current_user.has_permission('project_rating', 'create') %}
                            <!-- 可交互的星星评分 -->
                            <div class="clickable-stars d-flex" id="clickableStars">
                                {% for i in range(1, 6) %}
                                    <i class="fas fa-star clickable-star" 
                                       data-rating="{{ i }}"
                                       style="color: #dee2e6; font-size: 1.1rem; margin-right: 1px; cursor: pointer; transition: all 0.2s ease;"
                                       onclick="toggleManualAward()"
                                       onmouseover="this.style.transform='scale(1.1)'"
                                       onmouseout="this.style.transform='scale(1)'"></i>
                                {% endfor %}
                            </div>
                            {% else %}
                            <!-- 只读的星星显示 -->
                            <div class="readonly-stars d-flex" id="readonlyStars">
                                {% for i in range(1, 6) %}
                                    <i class="fas fa-star" 
                                       style="color: #dee2e6; font-size: 1.1rem; margin-right: 1px;"></i>
                                {% endfor %}
                            </div>
                            {% endif %}
                            <!-- 查看评分详情按钮 - 对所有用户开放 -->
                            <button type="button" class="btn btn-link btn-sm p-0 ms-2" onclick="showScoringDetails()" title="{{ _('查看评分详情') }}">
                                <i class="fas fa-info-circle text-muted"></i>
                            </button>
                        </div>
                    </div>
                </div>
                <div class="d-flex flex-wrap align-items-center gap-2 flex-shrink-0">
                    {{ ui.render_button(_('返回列表'), href=url_for('project.list_projects'), color='secondary') }}
                    {% if current_stage_key != 'signed' and current_user.has_permission('project', 'edit') and (current_user.role == 'admin' or current_user.id == project.owner_id) and (not project.is_locked or current_user.role == 'admin') %}
                        {{ ui.render_button(_('编辑项目'), href=url_for('project.edit_project', project_id=project.id), color='primary') }}
                    {% endif %}
                    {% if current_stage_key != 'signed' and current_user.has_permission('project', 'delete') and (current_user.role == 'admin' or current_user.id == project.owner_id) and (not project.is_locked or current_user.role == 'admin') %}
                        {{ ui.render_button(_('删除项目'), type='button', color='danger', attrs='onclick="confirmDeleteProject(' ~ project.id ~ ')"') }}
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- 项目阶段进度条 -->
    <div class="row mb-3">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header bg-light">
                    <h5 class="card-title mb-0">{{ _('项目阶段跟踪') }}</h5>
                </div>
                <div class="card-body">
                    <div id="projectStageProgress"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- 主要内容区域：左侧信息(2/3)、右侧行动记录(1/3) -->
    <div class="row">
        <!-- 左侧信息区域 (占2/3) -->
        <div class="col-md-8">
            <!-- 项目基本信息卡片 -->
            <div class="card mb-3">
                <div class="card-header bg-light">
                    <h5 class="card-title mb-0">{{ _('项目基本信息') }}</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="row mb-2">
                                <div class="col-md-4"><strong>{{ _('项目名称') }}：</strong></div>
                                <div class="col-md-8 text-break" style="word-wrap: break-word;">{{ project.project_name }}</div>
                            </div>
                            <div class="row mb-2">
                                <div class="col-md-4"><strong>{{ _('报备时间') }}：</strong></div>
                                <div class="col-md-8">{{ render_date(project.report_time) }}</div>
                            </div>
                            <div class="row mb-2">
                                <div class="col-md-4"><strong>{{ _('报备来源') }}：</strong></div>
                                <div class="col-md-8">{% if project.report_source %}{{ project.report_source|report_source_label('zh') }}{% else %}{{ _('无') }}{% endif %}</div>
                            </div>
                            <div class="row mb-2">
                                <div class="col-md-4"><strong>{{ _('品牌情况') }}：</strong></div>
                                <div class="col-md-8">{% if project.product_situation %}{{ project.product_situation|product_situation_label('zh') }}{% else %}{{ _('无') }}{% endif %}</div>
                            </div>
                            <div class="row mb-2">
                                <div class="col-md-4"><strong>{{ _('当前阶段') }}：</strong></div>
                                <div class="col-md-8" id="currentStageText">
                                    {{ render_project_stage(project.current_stage|project_stage_label('zh')) }}
                                </div>
                            </div>
                            <div class="row mb-2">
                                <div class="col-md-4"><strong>报价总额：</strong></div>
                                <div class="col-md-8">
{% if project.quotations.count() > 0 %}
    {% set latest_quotation = project.quotations.order_by(Quotation.created_at.desc()).first() %}
    <a href="{{ url_for('quotation.view_quotation', id=latest_quotation.id) }}"
       class="quotation-link" title="查看报价单详情">
        {{ render_currency(project.quotation_customer) }}
    </a>
    {{ render_confirmation_badge(latest_quotation, "报价单产品明细已确认") }}
    {% if current_stage_key != 'signed' %}
        <!-- 这里插入报价单的编辑和删除按钮（如有） -->
        {# 例如：#}
        {# {{ ui.render_button("编辑报价单", href=url_for('quotation.edit_quotation', id=latest_quotation.id), color="primary", icon="fas fa-edit", extra_class="btn-sm ms-2") }} #}
        {# {{ ui.render_button("删除报价单", href=url_for('quotation.delete_quotation', id=latest_quotation.id), color="danger", icon="fas fa-trash", extra_class="btn-sm ms-2") }} #}
    {% endif %}
{% else %}
    {% if current_user.has_permission('quotation', 'create') %}
    <form action="{{ url_for('quotation.create_quotation') }}" method="GET" style="display:inline;">
        <input type="hidden" name="project_id" value="{{ project.id }}">
        <input type="hidden" name="return_to" value="{{ url_for('project.view_project', project_id=project.id) }}">
        <button type="submit" class="btn btn-link p-0">添加报价</button>
    </form>
    {% endif %}
{% endif %}
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="row mb-2">
                                <div class="col-md-4"><strong>项目类型：</strong></div>
                                <div class="col-md-8">{% if project.project_type %}{{ project.project_type|project_type_label('zh') }}{% else %}无{% endif %}</div>
                            </div>
                            <div class="row mb-2">
                                <div class="col-md-4"><strong>拥有人：</strong></div>
                                <div class="col-md-8">
                                    {{ render_owner(project.owner) }}
                                    {% if has_change_owner_permission and (not project.is_locked or current_user.role == 'admin') %}
                                        <button class="btn btn-link btn-sm p-0 ms-2" data-bs-toggle="modal" data-bs-target="#changeOwnerModal">修改</button>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="row mb-2">
                                <div class="col-md-4"><strong>厂商销售负责人：</strong></div>
                                <div class="col-md-8">
                                    {% if project.vendor_sales_manager %}
                                        {{ render_owner(project.vendor_sales_manager) }}
                                    {% else %}
                                        <span class="text-muted">未设置</span>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="row mb-2">
                                <div class="col-md-4"><strong>预计交付时间：</strong></div>
                                <div class="col-md-8">{{ render_date(project.delivery_forecast) }}</div>
                            </div>
                            <div class="row mb-2">
                                <div class="col-md-4"><strong>创建时间：</strong></div>
                                <div class="col-md-8">{{ render_datetime(project.created_at) }}</div>
                            </div>
                            <div class="row mb-2">
                                <div class="col-md-4"><strong>最后更新：</strong></div>
                                <div class="col-md-8">{{ render_datetime(project.updated_at) }}</div>
                            </div>
                            <div class="row mb-2">
                                <div class="col-md-4"><strong>活跃状态：</strong></div>
                                <div class="col-md-8">
                                    {% if project.is_active %}
                                        <span class="badge bg-success">活跃</span>
                                    {% else %}
                                        <span class="badge bg-secondary">不活跃</span>
                                    {% endif %}
                                    <small class="ms-2 text-muted">阈值: {{ settings.project_activity_threshold|default(7) }}天</small>
                                </div>
                            </div>
                            <div class="row mb-2">
                                <div class="col-md-4"><strong>锁定状态：</strong></div>
                                <div class="col-md-8">
                                    {% if project.is_locked %}
                                        <span class="badge bg-warning text-dark">
                                            <i class="fas fa-lock me-1"></i>已锁定
                                        </span>
                                    {% else %}
                                        <span class="badge bg-success">
                                            <i class="fas fa-unlock me-1"></i>未锁定
                                        </span>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="row mb-2">
                                <div class="col-md-4"><strong>最后活动：</strong></div>
                                <div class="col-md-8">
                                    {{ render_datetime(project.last_activity_date) }}
                                    {% if project.activity_reason %}
                                        <span class="badge bg-info ms-2">{{ project.activity_reason }}</span>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 相关单位卡片 -->
            <div class="card mb-3">
                <div class="card-header bg-light">
                    <h5 class="card-title mb-0">{{ _('相关单位') }}</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="row mb-2">
                                <div class="col-md-4"><strong>{{ _('直接用户:') }}</strong></div>
                                <div class="col-md-8">
                                    {% if project.end_user %}
                                        {% if related_companies.end_user %}
                                            <a href="{{ url_for('customer.view_company', company_id=related_companies.end_user) }}" class="company-link">
                                                {{ project.end_user }}
                                            </a>
                                        {% else %}
                                            {{ project.end_user }}
                                        {% endif %}
                                    {% else %}
                                        无
                                    {% endif %}
                                </div>
                            </div>
                            <div class="row mb-2">
                                <div class="col-md-4"><strong>{{ _('设计院及顾问:') }}</strong></div>
                                <div class="col-md-8">
                                    {% if project.design_issues %}
                                        {% if related_companies.design_issues %}
                                            <a href="{{ url_for('customer.view_company', company_id=related_companies.design_issues) }}" class="company-link">
                                                {{ project.design_issues }}
                                            </a>
                                        {% else %}
                                            {{ project.design_issues }}
                                        {% endif %}
                                    {% else %}
                                        无
                                    {% endif %}
                                </div>
                            </div>
                            <div class="row mb-2">
                                <div class="col-md-4"><strong>经销商：</strong></div>
                                <div class="col-md-8">
                                    {% if project.dealer %}
                                        {% if related_companies.dealer %}
                                            <a href="{{ url_for('customer.view_company', company_id=related_companies.dealer) }}" class="company-link">
                                                {{ project.dealer }}
                                            </a>
                                        {% else %}
                                            {{ project.dealer }}
                                        {% endif %}
                                    {% else %}
                                        无
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="row mb-2">
                                <div class="col-md-4"><strong>总承包单位：</strong></div>
                                <div class="col-md-8">
                                    {% if project.contractor %}
                                        {% if related_companies.contractor %}
                                            <a href="{{ url_for('customer.view_company', company_id=related_companies.contractor) }}" class="company-link">
                                                {{ project.contractor }}
                                            </a>
                                        {% else %}
                                            {{ project.contractor }}
                                        {% endif %}
                                    {% else %}
                                        无
                                    {% endif %}
                                </div>
                            </div>
                            <div class="row mb-2">
                                <div class="col-md-4"><strong>系统集成商：</strong></div>
                                <div class="col-md-8">
                                    {% if project.system_integrator %}
                                        {% if related_companies.system_integrator %}
                                            <a href="{{ url_for('customer.view_company', company_id=related_companies.system_integrator) }}" class="company-link">
                                                {{ project.system_integrator }}
                                            </a>
                                        {% else %}
                                            {{ project.system_integrator }}
                                        {% endif %}
                                    {% else %}
                                        无
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 项目说明卡片 -->
            <div class="card">
                <div class="card-header bg-light">
                    <h5 class="card-title mb-0">项目说明</h5>
                </div>
                <div class="card-body">
                    <div id="formatted-description">
                        {% if project.stage_description %}
                            <div id="original-description" style="display: none;">{{ project.stage_description }}</div>
                        {% else %}
                            <p>无相关说明</p>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- 右侧行动记录区域 (占1/3) -->
        <div class="col-md-4">
            <div class="card" style="height: calc(100% - 0.75rem);">
                <div class="card-header bg-light d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">行动记录</h5>
                    <a href="{{ url_for('project.add_action_for_project', project_id=project.id) }}"
                       class="btn btn-link text-primary p-0 ms-1" title="添加行动">
                        <i class="fas fa-plus-circle me-1"></i> 添加
                    </a>
                </div>
                <div class="card-body p-0">
                    <div class="timeline-container action-records-scroll" style="height: calc(100vh - 350px); overflow-y: auto; padding: 15px;">
                        {% if project_actions %}
                            {% for action in project_actions %}
                            <div class="timeline-item">
                                <div class="timeline-marker"></div>
                                <div class="timeline-content">
                                    <div class="card mb-3 action-record" data-action-id="{{ action.id }}">
                                        <div class="card-header d-flex justify-content-between align-items-center bg-light py-2">
                                            <div>
                                                {% if action.contact_id %}
                                                <i class="fas fa-user me-1"></i> 
                                                <a href="{{ url_for('customer.view_contact', contact_id=action.contact_id) }}" class="text-primary">
                                                    {{ action.contact.name }}
                                                </a>
                                                {% endif %}
                                                {% if action.company_id %}
                                                <span class="badge bg-info ms-2">{{ action.company.company_name }}</span>
                                                {% endif %}
                                            </div>
                                        </div>
                                        <div class="card-body py-2">
                                            <p class="mb-1" style="white-space: pre-wrap;">{{ action.communication }}</p>
                                            <div class="d-flex justify-content-between align-items-center mt-2">
                                                <small class="text-muted">{{ action.date.strftime('%Y-%m-%d') }} {{ action.created_at.strftime('%H:%M:%S') }}</small>
                                                <div class="d-flex align-items-center">
                                                    <small class="text-muted me-2">{{ render_owner(action.owner) }}</small>
                                                    {% if has_permission('customer', 'delete') and (action.owner_id == current_user.id or current_user.role == 'admin') %}
                                                    <button type="button" class="btn btn-link text-danger p-0 ms-1 delete-action-btn"
                                                            data-action-id="{{ action.id }}" title="删除行动记录">
                                                        <i class="fas fa-trash-alt"></i>
                                                    </button>
                                                    {% endif %}
                                                </div>
                                            </div>
                                            <!-- 回复区 -->
                                            <div class="replies-container mt-2" id="replies-{{ action.id }}">
                                                <!-- AJAX加载回复树 -->
                                            </div>
                                            {% if action.replies.count() > 0 %}
                                            <button class="btn btn-link btn-sm mt-1 p-0 reply-toggle-btn" data-action-id="{{ action.id }}">展开</button>
                                            {% endif %}
                                            <div class="reply-form mt-2" id="reply-form-{{ action.id }}" style="display:none">
                                                <textarea class="form-control mb-2" rows="2" placeholder="输入回复内容..."></textarea>
                                                <button class="btn btn-primary btn-sm submit-reply">提交</button>
                                                <button class="btn btn-secondary btn-sm cancel-reply">取消</button>
                                            </div>
                                            <button class="btn btn-link btn-sm mt-1 p-0 show-reply-form-btn" data-action-id="{{ action.id }}">回复</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        {% else %}
                            <div class="text-center py-4 text-muted">
                                <i class="fas fa-inbox fa-3x mb-3"></i>
                                <p>暂无行动记录</p>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 审批流程区域 -->
    {% set approval_instance = get_object_approval_instance('project', project.id) if get_object_approval_instance is defined %}
    {{ render_approval_section('project', project.id, approval_instance, current_user) }}
</div>


{% if has_change_owner_permission %}
{{ render_change_project_owner_modal('changeOwnerModal', url_for('project.change_project_owner', project_id=project.id), all_users, project.owner_id, user_tree_data) }}
{% endif %}

<!-- 评分详情模态框 -->
<div class="modal fade" id="ratingDetailsModal" tabindex="-1" aria-labelledby="ratingDetailsModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="ratingDetailsModalLabel">
                    <i class="fas fa-star text-warning me-2"></i>项目评分详情
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <h6>当前评分：<span id="modalCurrentRating">0</span>/5星</h6>
                    <div id="modalStarDisplay" class="mb-3"></div>
                </div>
                <div id="ratingRecordsList">
                    <h6>评分记录：</h6>
                    <div id="ratingRecordsContent">
                        <div class="text-center text-muted">
                            <i class="fas fa-spinner fa-spin"></i> 加载中...
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<!-- 引入项目阶段进度条脚本 -->
<script src="{{ url_for('static', filename='js/project_stages.js') }}"></script>
<script src="/static/js/project_action_reply.js"></script>

<script>
    $(document).ready(function() {
        // 格式化项目说明，按日期分行
        function formatDescription() {
            const originalText = $('#original-description').text();
            if (!originalText) return;

            // 日期匹配正则表达式 (YYYY/MM/DD 或 YYYY/M/D) 可能跟随时间格式 (HH:MM:SS)
            const datePattern = /(\d{4}\/\d{1,2}\/\d{1,2}(?:\s+\d{1,2}:\d{1,2}:\d{1,2})?)/g;

            // 查找所有匹配的内容和位置
            let matches = [];
            let match;

            while ((match = datePattern.exec(originalText)) !== null) {
                matches.push({
                    text: match[0],
                    index: match.index
                });
            }

            // 如果没有找到日期，直接显示原文
            if (matches.length === 0) {
                $('#formatted-description').html('<p>' + originalText + '</p>');
                return;
            }

            // 提取每个日期所在的段落
            let formattedHtml = '';
            for (let i = 0; i < matches.length; i++) {
                const currentMatch = matches[i];
                const nextIndex = (i < matches.length - 1) ? matches[i + 1].index : originalText.length;

                // 提取日期和内容
                const date = currentMatch.text;
                const content = originalText.substring(currentMatch.index + date.length, nextIndex);

                formattedHtml += '<div class="description-entry">';
                formattedHtml += '<strong class="description-date">' + date + '</strong>';
                formattedHtml += '<span class="description-content">' + content + '</span>';
                formattedHtml += '</div>';
            }

            // 设置格式化后的HTML内容
            $('#formatted-description').html(formattedHtml);
        }

        // 执行格式化
        formatDescription();

        // 审批模态框打开时检查相似项目
        $('#approveAuthorizationModal').on('show.bs.modal', function (e) {
            $.ajax({
                url: "{{ url_for('project.check_similar_projects') }}",
                type: "POST",
                contentType: "application/json",
                data: JSON.stringify({
                    project_name: "{{ project.project_name }}",
                    exclude_id: "{{ project.id }}"
                }),
                success: function(data) {
                    if (data.similar_projects && data.similar_projects.length > 0) {
                        $('#similarProjectsWarning').removeClass('d-none');
                        let projectsList = '<ul>';
                        data.similar_projects.forEach(function(proj) {
                            projectsList += '<li><span style="font-weight:bold;color:#d35400;">' + proj.name + '</span>' +
                                         ' (授权编号: ' + (proj.authorization_code || '') +
                                         ', 拥有人: ' + proj.owner_name +
                                         ', 状态: ' + (proj.status || '未知') +
                                         ', 相似度: ' + proj.similarity + '%)</li>';
                        });
                        projectsList += '</ul>';
                        $('#similarProjectsList').html(projectsList);
                    } else {
                        $('#similarProjectsWarning').addClass('d-none');
                    }
                },
                error: function(xhr, status, error) {
                    console.error('检查相似项目失败:', error);
                    $('#similarProjectsWarning').addClass('d-none');
                }
            });
        });

        // 申请授权模态框打开时检查相似项目
        $('#applyAuthorizationModal').on('show.bs.modal', function (e) {
            $.ajax({
                url: "{{ url_for('project.check_similar_projects') }}",
                type: "POST",
                contentType: "application/json",
                data: JSON.stringify({
                    project_name: "{{ project.project_name }}",
                    exclude_id: "{{ project.id }}"
                }),
                success: function(data) {
                    if (data.similar_projects && data.similar_projects.length > 0) {
                        $('#applySimilarProjectsWarning').removeClass('d-none');
                        let projectsList = '<ul>';
                        data.similar_projects.forEach(function(proj) {
                            projectsList += '<li><span style="font-weight:bold;color:#d35400;">' + proj.name + '</span>' +
                                         ' (授权编号: ' + (proj.authorization_code || '') +
                                         ', 拥有人: ' + proj.owner_name +
                                         ', 状态: ' + (proj.status || '未知') +
                                         ', 相似度: ' + proj.similarity + '%)</li>';
                        });
                        projectsList += '</ul>';
                        $('#applySimilarProjectsList').html(projectsList);
                    } else {
                        $('#applySimilarProjectsWarning').addClass('d-none');
                    }
                },
                error: function(xhr, status, error) {
                    console.error('检查相似项目失败:', error);
                    $('#applySimilarProjectsWarning').addClass('d-none');
                }
            });
        });

        // 初始化项目阶段进度条
        console.log('项目阶段进度条初始化参数:');
        console.log('- 当前阶段:', '{{ current_stage_key }}');
        console.log('- 阶段历史:', {{ stageHistory|tojson }});
        console.log('- 阶段配置:', {{ project_stages_config()|tojson }});
        
        const projectStageProgress = new ProjectStageProgress({
            containerId: 'projectStageProgress',
            projectId: {{ project.id }},
            currentStage: '{{ current_stage_key }}',
            csrfToken: '{{ csrf_token() }}',
            updateUrl: '{{ url_for("project.update_project_stage") }}',
            canEdit: {{ can_edit_stage|lower }},
            isLocked: {{ project.is_locked|lower }},
            userRole: '{{ current_user.role }}',
            {% if stageHistory %}stageHistory: {{ stageHistory|tojson }},{% endif %}
            stageDefs: {{ project_stages_config()|tojson }}
        });

        // 绑定删除按钮事件
        $(document).on('click', '.delete-action-btn', function () {
            const actionId = $(this).data('action-id');
            deleteAction(actionId);
        });
    });

    // 删除行动记录函数
    function deleteAction(actionId) {
        if (confirm('确定要删除这条行动记录吗？')) {
            const csrfToken = $('meta[name="csrf-token"]').attr('content');
            $.ajax({
                url: `/customer/api/actions/${actionId}/delete`,
                type: 'POST',
                headers: {
                    'X-CSRFToken': csrfToken,
                    'X-Requested-With': 'XMLHttpRequest'
                },
                success: function(response) {
                    if (response.success) {
                        // 删除成功后刷新页面
                        window.location.reload();
                    } else {
                        alert('删除失败: ' + (response.message || '未知错误'));
                    }
                },
                error: function(xhr, status, error) {
                    alert('删除失败，请重试！');
                }
            });
        }
    }

    // 确认删除项目函数
    function confirmDeleteProject(projectId) {
        if (confirm('确定要删除这个项目吗？删除后将无法恢复，请谨慎操作！')) {
            // 创建表单并提交
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = `/project/delete/${projectId}`;
            
            // 添加CSRF令牌
            const csrfInput = document.createElement('input');
            csrfInput.type = 'hidden';
            csrfInput.name = 'csrf_token';
            csrfInput.value = '{{ csrf_token() }}';
            form.appendChild(csrfInput);
            
            // 提交表单
            document.body.appendChild(form);
            form.submit();
        }
    }
</script>

<script>
// 页面加载时初始化评分状态
let currentProjectRating = {{ project.rating or 0 }};
let userHasAwarded = false;
let scoringData = null;

document.addEventListener('DOMContentLoaded', function() {
    // 加载评分状态
    loadScoringStatus();
});

// 加载评分状态
function loadScoringStatus() {
    fetch(`/api/project/{{ project.id }}/scoring/status`, {
        method: 'GET',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').getAttribute('content')
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            scoringData = data.data;
            currentProjectRating = data.data.star_rating;
            userHasAwarded = data.data.user_has_awarded;
            updateRatingDisplay();
        } else {
            console.error('加载评分状态失败:', data.message);
        }
    })
    .catch(error => {
        console.error('加载评分状态失败:', error);
    });
}

// 切换手动奖励
function toggleManualAward() {
    // 添加点击反馈效果
    const clickableStars = document.querySelector('#clickableStars');
    if (clickableStars) {
        clickableStars.style.opacity = '0.6';
        setTimeout(() => {
            if (clickableStars) clickableStars.style.opacity = '1';
        }, 200);
    }
    
    const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
    
    fetch(`/api/project/{{ project.id }}/scoring/manual-award`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        },
        body: JSON.stringify({
            action: 'toggle',
            award_type: 'supervisor_award',
            notes: '手动奖励切换'
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // 更新页面显示
            currentProjectRating = data.data.star_rating;
            userHasAwarded = data.data.user_has_awarded;
            updateRatingDisplay();
            
            // 简单的视觉反馈
            const stars = document.querySelectorAll('.clickable-star, .readonly-stars i');
            stars.forEach(star => {
                star.style.transform = 'scale(1.2)';
                setTimeout(() => {
                    star.style.transform = 'scale(1)';
                }, 150);
            });
        } else {
            console.error('手动奖励操作失败:', data.message);
        }
    })
    .catch(error => {
        console.error('手动奖励操作失败:', error);
    });
}

// 更新评分显示 - 支持半星显示
function updateRatingDisplay() {
    console.log(`开始更新评分显示: ${currentProjectRating}星, 用户已奖励: ${userHasAwarded}`);
    
    // 更新可点击星星
    const clickableStars = document.querySelectorAll('#clickableStars i.clickable-star');
    const readonlyStars = document.querySelectorAll('#readonlyStars i');
    
    const allStars = [...clickableStars, ...readonlyStars];
    
    console.log(`找到星星数量: 可点击=${clickableStars.length}, 只读=${readonlyStars.length}`);
    
    // 更新星星颜色，支持半星
    allStars.forEach((star, index) => {
        const starValue = index + 1;
        const rating = parseFloat(currentProjectRating);
        
        // 先清除所有图标类
        star.classList.remove('fas', 'far', 'fa-star', 'fa-star-half-alt');
        
        if (rating >= starValue) {
            // 完整星星：评分大于等于当前星星位置
            star.classList.add('fas', 'fa-star');
            star.style.color = '#ffc107';
        } else if (rating >= starValue - 0.5 && rating < starValue) {
            // 半星：评分在当前星星位置减0.5到当前位置之间
            star.classList.add('fas', 'fa-star-half-alt');
            star.style.color = '#ffc107';
        } else {
            // 空星
            star.classList.add('far', 'fa-star');
            star.style.color = '#dee2e6';
        }
        
        // 恢复原有的属性和事件（只对可点击星星）
        if (star.classList.contains('clickable-star') || (clickableStars.length > 0 && index < clickableStars.length)) {
            // 确保添加 clickable-star 类
            star.classList.add('clickable-star');
            star.setAttribute('data-rating', starValue);
            star.setAttribute('onclick', 'toggleManualAward()');
            star.setAttribute('onmouseover', "this.style.transform='scale(1.1)'");
            star.setAttribute('onmouseout', "this.style.transform='scale(1)'");
            star.style.cursor = 'pointer';
            star.style.transition = 'all 0.2s ease';
        }
        
        // 保持原有样式
        star.style.fontSize = '1.1rem';
        star.style.marginRight = '1px';
    });
    
    console.log(`评分已更新: ${currentProjectRating}星, 用户已奖励: ${userHasAwarded}`);
}

// 显示评分详情
function showScoringDetails() {
    // 加载详细评分信息
    fetch(`/api/project/{{ project.id }}/scoring/details`, {
        method: 'GET',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').getAttribute('content')
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            displayScoringDetailsModal(data.data);
        } else {
            showMessage('获取评分详情失败', 'error');
        }
    })
    .catch(error => {
        console.error('获取评分详情失败:', error);
        showMessage('获取评分详情失败', 'error');
    });
}

// 显示评分详情扩张信息框
function displayScoringDetailsModal(data) {
    const expandedInfoHtml = `
        <div class="modal fade" id="scoringDetailsModal" tabindex="-1">
            <div class="modal-dialog modal-xl">
                <div class="modal-content" style="background-color: #f8f9fa; border: none; border-radius: 15px;">
                    <div class="modal-header border-0" style="background-color: #f8f9fa;">
                        <h5 class="modal-title text-dark">
                            项目评分详情 - ${data.project_name}
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body" style="background-color: #f8f9fa; padding: 30px;">
                        <!-- 总评分显示 -->
                        <div class="text-center mb-4">
                            <div class="mb-3">
                                        ${generateStarsHtml(data.star_rating)}
                                    </div>
                            <h6 class="text-muted">总评分：${data.total_score.toFixed(2)}分</h6>
                        </div>
                        
                        <!-- 分类评分展示 -->
                        <div class="row g-4">
                            ${generateExpandedScoringCategoriesHtml(data)}
                        </div>
                        
                        <div class="text-center mt-4">
                            <small class="text-muted">最后计算时间：${new Date(data.last_calculated).toLocaleString('zh-CN')}</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // 移除已存在的模态框
    const existingModal = document.getElementById('scoringDetailsModal');
    if (existingModal) {
        existingModal.remove();
    }
    
    // 添加新模态框
    document.body.insertAdjacentHTML('beforeend', expandedInfoHtml);
    
    // 显示模态框
    const modal = new bootstrap.Modal(document.getElementById('scoringDetailsModal'));
    modal.show();
}

// 生成扩张式评分分类HTML
function generateExpandedScoringCategoriesHtml(data) {
    const categories = {
        'information': { 
            label: '信息完整性', 
            score: data.score_breakdown.information_score,
            items: [
                { key: 'project_stage', name: '项目阶段' },
                { key: 'project_category', name: '项目类别' },
                { key: 'design_consultant', name: '设计顾问' },
                { key: 'user_info', name: '用户信息' },
                { key: 'general_contractor', name: '总承包商' },
                { key: 'system_integrator', name: '系统集成商' }
            ]
        },
        'quotation': { 
            label: '报价完整性', 
            score: data.score_breakdown.quotation_score,
            items: [
                { key: 'quotation_exists', name: '报价单' }
            ]
        },
        'stage': { 
            label: '阶段得分', 
            score: data.score_breakdown.stage_score,
            items: [
                { key: 'stage_bidding', name: '招投标阶段' },
                { key: 'stage_awarded', name: '中标阶段' },
                { key: 'stage_pricing', name: '批价阶段' }
            ]
        },
        'manual': { 
            label: '手动奖励', 
            score: data.score_breakdown.manual_score,
            items: [
                { key: 'supervisor_award', name: '主管奖励' }
            ]
        }
    };
    
    let html = '';
    Object.keys(categories).forEach(category => {
            const categoryInfo = categories[category];
        const categoryRecords = data.scoring_records[category] || [];
        
        // 计算该分类的最大可能得分
        let maxPossibleScore = 1.0; // 默认值
        if (category === 'information') {
            maxPossibleScore = 0.5; // 信息完整性最多0.5分（阈值逻辑）
        } else if (category === 'quotation') {
            maxPossibleScore = 0.5; // 报价完整性最多0.5分
        } else if (category === 'stage') {
            maxPossibleScore = 1.5; // 阶段得分最多1.5分（批价）
        } else if (category === 'manual') {
            maxPossibleScore = 2.0; // 手动奖励理论上可以很高，设定为2.0分
        }
        
            html += `
            <div class="col-md-6 mb-4">
                <div class="card h-100" style="border: none; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); max-width: 100%;">
                    <div class="card-header text-center" style="background-color: white; border-bottom: 1px solid #e9ecef; border-radius: 12px 12px 0 0; padding: 1rem;">
                        <h6 class="mb-2 text-dark" style="font-size: 0.95rem;">${categoryInfo.label}</h6>
                        <div class="mb-2" style="display: flex; justify-content: center; flex-wrap: wrap;">
                            ${generateCategoryStarsHtml(categoryInfo.score, maxPossibleScore)}
                        </div>
                    </div>
                    <div class="card-body" style="background-color: white; border-radius: 0 0 12px 12px; padding: 1rem; overflow: hidden;">
                        <div class="row g-2" style="margin: 0;">
                            ${generateCategoryItemsHtml(categoryInfo.items, categoryRecords, category, categoryInfo.score)}
                        </div>
                    </div>
                </div>
            </div>
        `;
    });
    
    return html;
}

// 生成分类星级HTML - 根据分类最大得分显示对应数量的星星
function generateCategoryStarsHtml(score, maxScore) {
    maxScore = maxScore || 1.0;
    let html = '';
    const ratingFloat = parseFloat(score);
    
    // 计算完整星星数量
    const fullStars = Math.floor(ratingFloat);
    // 计算是否有半星
    const hasHalfStar = (ratingFloat % 1) >= 0.5;
    // 计算最大星星数量
    const maxStarsCount = Math.ceil(maxScore);
    
    // 生成完整星星
    for (let i = 0; i < fullStars; i++) {
        html += '<i class="fas fa-star" style="color: #ffc107; font-size: 1.2rem; margin-right: 2px;"></i>';
    }
    
    // 生成半星
    if (hasHalfStar && fullStars < maxStarsCount) {
        html += '<i class="fas fa-star-half-alt" style="color: #ffc107; font-size: 1.2rem; margin-right: 2px;"></i>';
    }
    
    // 生成空星
    const totalShownStars = fullStars + (hasHalfStar ? 1 : 0);
    for (let i = totalShownStars; i < maxStarsCount; i++) {
        html += '<i class="far fa-star" style="color: #dee2e6; font-size: 1.2rem; margin-right: 2px;"></i>';
    }
    
    return html;
}

// 生成分类项目HTML（改进版，支持手动奖励详情显示）
function generateCategoryItemsHtml(items, records, category = '', score = 0) {
    let html = '';
    
    // 如果是手动奖励分类，需要特殊处理
    if (category === 'manual') {
        // 显示所有手动奖励记录
        if (records && records.length > 0) {
            records.forEach(record => {
                if (record.score_value > 0) {
                    const awardedBy = record.awarded_by ? record.awarded_by.name : '未知用户';
                    const createdDate = new Date(record.created_at).toLocaleDateString('zh-CN');
                    
                    html += `
                        <div class="col-12 mb-3">
                            <div class="d-flex align-items-start">
                                <div class="me-3">
                                    <div class="rounded-circle d-flex align-items-center justify-content-center" style="width: 24px; height: 24px; background-color: #28a745;">
                                        <i class="fas fa-check" style="color: white; font-size: 12px;"></i>
                        </div>
                        </div>
                                <div class="flex-grow-1">
                                    <div class="d-flex justify-content-between align-items-start">
                                        <div>
                                            <span class="text-dark fw-bold" style="font-size: 14px;">手动奖励</span>
                                            <div class="text-muted" style="font-size: 12px;">
                                                由 <strong>${awardedBy}</strong> 于 ${createdDate} 给予
                    </div>
                                            ${record.notes ? `<div class="text-muted" style="font-size: 11px; font-style: italic;">${record.notes}</div>` : ''}
                                        </div>
                                        <span class="badge bg-success" style="font-size: 11px;">+${record.score_value}分</span>
                    </div>
                </div>
            </div>
        </div>
    `;
                }
            });
        }
        
        if (!html) {
            html = '<div class="col-12"><span class="text-muted" style="font-size: 14px;">暂无手动奖励</span></div>';
        }
        } else {
        // 其他分类的原有逻辑
        items.forEach(item => {
            let hasRecord = false;
            
            // 特殊处理阶段得分
            if (category === 'stage') {
                // 获取当前项目的阶段得分，如果有得分说明达到了某个阶段
                if (score > 0) {
                    // 根据得分判断当前达到的阶段
                    if (item.key === 'stage_bidding' && score >= 0.5) {
                        hasRecord = true; // 招投标阶段：0.5分
                    } else if (item.key === 'stage_awarded' && score >= 1.0) {
                        hasRecord = true; // 中标阶段：1.0分
                    } else if (item.key === 'stage_pricing' && score >= 1.5) {
                        hasRecord = true; // 批价阶段：1.5分
                    }
                }
            } else {
                // 检查该项目是否有得分记录
                // 特殊处理报价完整性：如果分类得分大于0，说明报价单存在
                if (category === 'quotation') {
                    hasRecord = score > 0; // 直接根据分类得分判断
                } else {
                    hasRecord = records.some(record => record.field_name === item.key && record.score_value > 0);
                }
            }
            
            html += `
                <div class="col-12 mb-2">
                    <div class="d-flex align-items-center">
                        <div class="me-3">
                            ${hasRecord ? 
                                '<div class="rounded-circle d-flex align-items-center justify-content-center" style="width: 24px; height: 24px; background-color: #28a745;"><i class="fas fa-check" style="color: white; font-size: 12px;"></i></div>' :
                                '<div class="rounded-circle" style="width: 24px; height: 24px; background-color: #dee2e6; border: 2px solid #adb5bd;"></div>'
                            }
                        </div>
                        <span class="text-dark" style="font-size: 14px;">${item.name}</span>
                    </div>
                </div>
            `;
        });
        
        if (!html) {
            html = '<div class="col-12"><span class="text-muted" style="font-size: 14px;">暂无项目</span></div>';
        }
    }
    
    return html;
}

// 生成星星HTML - 支持半星
function generateStarsHtml(rating) {
    let html = '';
    const ratingFloat = parseFloat(rating);
    
    for (let i = 1; i <= 5; i++) {
        if (ratingFloat >= i) {
            // 完整星星：评分大于等于当前星星位置
            html += `<i class="fas fa-star" style="color: #ffc107; font-size: 2rem; margin-right: 5px;"></i>`;
        } else if (ratingFloat >= i - 0.5 && ratingFloat < i) {
            // 半星：评分在当前星星位置减0.5到当前位置之间
            html += `<i class="fas fa-star-half-alt" style="color: #ffc107; font-size: 2rem; margin-right: 5px;"></i>`;
        } else {
            // 空星
            html += `<i class="far fa-star" style="color: #dee2e6; font-size: 2rem; margin-right: 5px;"></i>`;
        }
    }
    return html;
}

// 显示消息提示
function showMessage(message, type = 'info') {
    // 创建消息元素
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type === 'error' ? 'danger' : type} alert-dismissible fade show position-fixed`;
    alertDiv.style.cssText = 'top: 100px; right: 20px; z-index: 9999; min-width: 300px;';
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    // 添加到页面
    document.body.appendChild(alertDiv);
    
    // 3秒后自动移除
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.parentNode.removeChild(alertDiv);
        }
    }, 3000);
}
</script>

{% endblock %}

{% block styles %}
{{ super() }}
<style>
/* 报价链接样式 */
.quotation-link {
    color: #0d6efd;
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    gap: 8px;
}

.quotation-link:hover {
    text-decoration: underline;
    color: #0056b3;
}

.quotation-link .badge {
    font-size: 0.75rem;
    padding: 0.25rem 0.5rem;
}

/* 公司链接样式 */
.company-link {
    color: #0d6efd;
    text-decoration: none;
    display: inline-flex;
    align-items: center;
}

.company-link:hover {
    text-decoration: underline;
    color: #0a58ca;
    font-weight: 500;
}

/* 项目说明格式化样式 */
#formatted-description {
    line-height: 1.6;
}

.description-entry {
    margin-bottom: 15px;
    padding-bottom: 10px;
    border-bottom: 1px dashed #eee;
}

.description-entry:last-child {
    border-bottom: none;
    margin-bottom: 0;
}

.description-date {
    color: #0d6efd;
    font-weight: 600;
    display: block;
    margin-bottom: 5px;
}

.description-content {
    display: block;
    padding-left: 5px;
}

/* 可点击星星样式 */
.clickable-star {
    transition: all 0.2s ease;
}

.clickable-star:hover {
    transform: scale(1.2);
    filter: brightness(1.2);
}

.clickable-stars {
    user-select: none;
}

/* 标题旁边的星星样式 */
.title-rating {
    user-select: none;
}

.title-rating .clickable-star {
    transition: all 0.15s ease;
}

.title-rating .clickable-star:hover {
    transform: scale(1.15);
    filter: brightness(1.1);
}

/* 时间线样式 */
.timeline-container {
    position: relative;
    padding-left: 30px;
}

.timeline-item {
    position: relative;
    padding-bottom: 20px;
}

.timeline-marker {
    position: absolute;
    top: 0;
    left: -30px;
    width: 20px;
    height: 20px;
    border-radius: 50%;
    background-color: #0d6efd;
    z-index: 10;
}

.timeline-marker::before {
    content: '';
    position: absolute;
    left: 50%;
    top: 20px;
    bottom: -20px;
    width: 2px;
    background-color: #dee2e6;
    transform: translateX(-50%);
}

.timeline-item:last-child .timeline-marker::before {
    display: none;
}

.timeline-content {
    padding-left: 15px;
}

.action-records-scroll::-webkit-scrollbar {
    width: 6px;
}

.action-records-scroll::-webkit-scrollbar-track {
    background: #f1f1f1;
}

.action-records-scroll::-webkit-scrollbar-thumb {
    background: #888;
    border-radius: 3px;
}

.action-records-scroll::-webkit-scrollbar-thumb:hover {
    background: #555;
}

/* 确保卡片占满高度 */
.card-with-full-height {
    height: 100%;
}

/* 审批流程时间线样式 */
.timeline {
    position: relative;
    margin: 0 0 30px 0;
    padding: 0;
    list-style: none;
}

.timeline:before {
    content: '';
    position: absolute;
    top: 0;
    bottom: 0;
    width: 3px;
    background: #dee2e6;
    left: 25px;
    margin-left: -1.5px;
}

.timeline-item {
    position: relative;
    margin-bottom: 30px;
}

.timeline-marker {
    position: absolute;
    width: 16px;
    height: 16px;
    left: 25px;
    margin-left: -8px;
    border-radius: 50%;
    border: 2px solid #fff;
    z-index: 100;
}

.timeline-content {
    padding-left: 50px;
    position: relative;
    min-height: 60px;
}

.progress {
    border-radius: 0.5rem;
}
</style>
{% endblock %}