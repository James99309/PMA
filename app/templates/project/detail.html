{% extends "base.html" %}
{% from 'macros/ui_helpers.html' import render_project_type, render_owner, render_date, render_datetime, render_authorization_code, render_currency, render_quotation_number %}

{% block title %}项目详情{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row mb-3">
        <div class="col-md-12">
            <div class="d-flex justify-content-between align-items-center">
                <h2>项目详情</h2>
                <div>
                    <a href="{{ url_for('project.list_projects') }}" class="btn btn-secondary">
                        <i class="fas fa-arrow-left"></i> 返回列表
                    </a>
                    {% if current_user.has_permission('project', 'edit') and (current_user.role == 'admin' or current_user.id == project.owner_id) %}
                    <a href="{{ url_for('project.edit_project', project_id=project.id) }}" class="btn btn-primary">
                        <i class="fas fa-edit"></i> 编辑项目
                    </a>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <div class="row mb-3">
        <div class="col-md-6">
            <div class="card h-100">
                <div class="card-header bg-primary text-white">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="card-title mb-0">授权编号</h5>
                        <div>
                            {% if project.authorization_status == 'pending' %}
                                <span class="badge bg-warning">审批中</span>
                            {% elif project.authorization_status == 'rejected' %}
                                <span class="badge bg-danger">已驳回</span>
                            {% elif project.authorization_code %}
                                <span class="badge bg-success">已授权</span>
                            {% else %}
                                <span class="badge bg-secondary">未申请</span>
                            {% endif %}
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    {% if project.authorization_code %}
                    <h4 class="text-center">
                        {{ render_authorization_code(project.authorization_code, project.project_type, size="large") }}
                    </h4>
                    {% else %}
                    <h4 class="text-center">{{ project.authorization_code or '' }}</h4>
                    {% endif %}

                    {% if project.authorization_status == 'rejected' and project.feedback %}
                    <div class="alert alert-danger mt-3">
                        <strong>驳回原因：</strong> {{ project.feedback }}
                    </div>
                    {% endif %}

                    <div class="text-center mt-3">
                        {% if not project.authorization_code and project.authorization_status != 'pending' %}
                            {% if current_user.id == project.owner_id or current_user.role == 'admin' %}
                            <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#applyAuthorizationModal">
                                <i class="fas fa-file-signature"></i> 申请授权编号
                            </button>
                            {% endif %}
                        {% endif %}

                        {% if project.authorization_status == 'pending' %}
                            {% if current_user.role in ['channel_manager', 'marketing_director', 'admin', 'service', 'service_manager'] %}
                            <div class="btn-group">
                                <!-- 根据项目类型和用户角色决定是否显示批准按钮 -->
                                {% if current_user.role == 'admin' or
                                     (current_user.role == 'channel_manager' and project.project_type == '渠道跟进') or
                                     (current_user.role == 'marketing_director' and project.project_type in ['渠道跟进', '销售重点']) or
                                     (current_user.role in ['service', 'service_manager'] and project.project_type == '业务机会') %}
                                <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#approveAuthorizationModal">
                                    <i class="fas fa-check"></i> 批准
                                </button>
                                <button type="button" class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#rejectAuthorizationModal">
                                    <i class="fas fa-times"></i> 驳回
                                </button>
                                {% endif %}
                            </div>
                            {% elif current_user.id == project.owner_id or current_user.role == 'admin' %}
                            <!-- 添加撤回授权按钮 -->
                            <button type="button" class="btn btn-warning" data-bs-toggle="modal" data-bs-target="#revokeAuthorizationModal">
                                <i class="fas fa-undo"></i> 撤回申请
                            </button>
                            {% else %}
                            <p class="text-muted">申请已提交，等待审批中...</p>
                            {% endif %}
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-6">
            <div class="card h-100">
                <div class="card-header bg-light">
                    <h5 class="card-title mb-0">项目编号</h5>
                </div>
                <div class="card-body d-flex flex-column justify-content-center">
                    <h4 class="text-center">{{ project.id }}</h4>
                </div>
            </div>
        </div>
    </div>

    <div class="row mb-3">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header bg-light">
                    <h5 class="card-title mb-0">项目基本信息</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="row mb-2">
                                <div class="col-md-4"><strong>项目名称：</strong></div>
                                <div class="col-md-8">{{ project.project_name }}</div>
                            </div>
                            <div class="row mb-2">
                                <div class="col-md-4"><strong>报备时间：</strong></div>
                                <div class="col-md-8">{{ render_date(project.report_time) }}</div>
                            </div>
                            <div class="row mb-2">
                                <div class="col-md-4"><strong>报备来源：</strong></div>
                                <div class="col-md-8">{{ project.report_source or '无' }}</div>
                            </div>
                            <div class="row mb-2">
                                <div class="col-md-4"><strong>品牌情况：</strong></div>
                                <div class="col-md-8">{{ project.product_situation or '无' }}</div>
                            </div>
                            <div class="row mb-2">
                                <div class="col-md-4"><strong>当前阶段：</strong></div>
                                <div class="col-md-8">{{ project.current_stage or '无' }}</div>
                            </div>
                            <div class="row mb-2">
                                <div class="col-md-4"><strong>报价总额：</strong></div>
                                <div class="col-md-8">
                                    {% if project.quotation_customer and project.quotations.count() > 0 %}
                                    <a href="{{ url_for('quotation.view_quotation', id=project.quotations.order_by(Quotation.created_at.desc()).first().id) }}"
                                       class="quotation-link" title="查看报价单详情">
                                        {{ render_currency(project.quotation_customer) }}
                                    </a>
                                    {% else %}
                                    <div class="d-flex align-items-center">
                                        <span class="me-3">{{ render_currency(project.quotation_customer) if project.quotation_customer else '无' }}</span>
                                        {% if current_user.has_permission('quotation', 'create') %}
                                        <a href="{{ url_for('quotation.create_quotation') }}?project_id={{ project.id }}&return_to={{ url_for('project.view_project', project_id=project.id) }}"
                                           class="btn btn-sm btn-primary">
                                            <i class="fas fa-plus"></i> 添加报价
                                        </a>
                                        {% endif %}
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="row mb-2">
                                <div class="col-md-4"><strong>项目类型：</strong></div>
                                <div class="col-md-8">{{ render_project_type(project.project_type) }}</div>
                            </div>
                            <div class="row mb-2">
                                <div class="col-md-4"><strong>拥有人：</strong></div>
                                <div class="col-md-8">{{ render_owner(project.owner) }}</div>
                            </div>
                            <div class="row mb-2">
                                <div class="col-md-4"><strong>预计交付时间：</strong></div>
                                <div class="col-md-8">{{ render_date(project.delivery_forecast) }}</div>
                            </div>
                            <div class="row mb-2">
                                <div class="col-md-4"><strong>创建时间：</strong></div>
                                <div class="col-md-8">{{ render_datetime(project.created_at) }}</div>
                            </div>
                            <div class="row mb-2">
                                <div class="col-md-4"><strong>最后更新：</strong></div>
                                <div class="col-md-8">{{ render_datetime(project.updated_at) }}</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row mb-3">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header bg-light">
                    <h5 class="card-title mb-0">相关单位</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="row mb-2">
                                <div class="col-md-4"><strong>直接用户：</strong></div>
                                <div class="col-md-8">
                                    {% if project.end_user %}
                                        {% if related_companies.end_user %}
                                            <a href="{{ url_for('customer.view_company', company_id=related_companies.end_user) }}" class="company-link">
                                                {{ project.end_user }}
                                            </a>
                                        {% else %}
                                            <a href="{{ url_for('customer.list_companies', search=project.end_user) }}" class="company-link">
                                                {{ project.end_user }}
                                            </a>
                                        {% endif %}
                                    {% else %}
                                        无
                                    {% endif %}
                                </div>
                            </div>
                            <div class="row mb-2">
                                <div class="col-md-4"><strong>设计院及顾问：</strong></div>
                                <div class="col-md-8">
                                    {% if project.design_issues %}
                                        {% if related_companies.design_issues %}
                                            <a href="{{ url_for('customer.view_company', company_id=related_companies.design_issues) }}" class="company-link">
                                                {{ project.design_issues }}
                                            </a>
                                        {% else %}
                                            <a href="{{ url_for('customer.list_companies', search=project.design_issues) }}" class="company-link">
                                                {{ project.design_issues }}
                                            </a>
                                        {% endif %}
                                    {% else %}
                                        无
                                    {% endif %}
                                </div>
                            </div>
                            <div class="row mb-2">
                                <div class="col-md-4"><strong>经销商：</strong></div>
                                <div class="col-md-8">
                                    {% if project.dealer %}
                                        {% if related_companies.dealer %}
                                            <a href="{{ url_for('customer.view_company', company_id=related_companies.dealer) }}" class="company-link">
                                                {{ project.dealer }}
                                            </a>
                                        {% else %}
                                            <a href="{{ url_for('customer.list_companies', search=project.dealer) }}" class="company-link">
                                                {{ project.dealer }}
                                            </a>
                                        {% endif %}
                                    {% else %}
                                        无
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="row mb-2">
                                <div class="col-md-4"><strong>总承包单位：</strong></div>
                                <div class="col-md-8">
                                    {% if project.contractor %}
                                        {% if related_companies.contractor %}
                                            <a href="{{ url_for('customer.view_company', company_id=related_companies.contractor) }}" class="company-link">
                                                {{ project.contractor }}
                                            </a>
                                        {% else %}
                                            <a href="{{ url_for('customer.list_companies', search=project.contractor) }}" class="company-link">
                                                {{ project.contractor }}
                                            </a>
                                        {% endif %}
                                    {% else %}
                                        无
                                    {% endif %}
                                </div>
                            </div>
                            <div class="row mb-2">
                                <div class="col-md-4"><strong>系统集成商：</strong></div>
                                <div class="col-md-8">
                                    {% if project.system_integrator %}
                                        {% if related_companies.system_integrator %}
                                            <a href="{{ url_for('customer.view_company', company_id=related_companies.system_integrator) }}" class="company-link">
                                                {{ project.system_integrator }}
                                            </a>
                                        {% else %}
                                            <a href="{{ url_for('customer.list_companies', search=project.system_integrator) }}" class="company-link">
                                                {{ project.system_integrator }}
                                            </a>
                                        {% endif %}
                                    {% else %}
                                        无
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row mb-3">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header bg-light">
                    <h5 class="card-title mb-0">项目说明</h5>
                </div>
                <div class="card-body">
                    <div id="formatted-description">
                        {% if project.stage_description %}
                            <div id="original-description" style="display: none;">{{ project.stage_description }}</div>
                        {% else %}
                            <p>无相关说明</p>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 报价总额 -->
    <div class="row mb-3">
        <div class="col-md-6">
            <div class="card custom-card">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <h6 class="card-title mb-0">报价总额</h6>
                        {% if current_user.has_permission('quotation', 'create') %}
                        <div class="d-flex">
                            {% if project.quotation_total and project.quotation_count > 0 %}
                            <a href="{{ url_for('quotation.list_quotations', project_id=project.id) }}" class="btn btn-outline-primary btn-sm">
                                <i class="fas fa-list"></i> 查看报价单
                            </a>
                            {% else %}
                            <a href="{{ url_for('quotation.create_quotation', project_id=project.id, return_to=url_for('project.view_project', project_id=project.id)) }}" class="btn btn-primary btn-sm">
                                <i class="fas fa-plus"></i> 添加报价
                            </a>
                            {% endif %}
                        </div>
                        {% endif %}
                    </div>
                    <div class="mt-3">
                        {% if project.quotation_total and project.quotation_count > 0 %}
                        <h3 class="mb-0">¥ {{ "{:,.2f}".format(project.quotation_total) }}</h3>
                        <small class="text-muted">总计 {{ project.quotation_count }} 个报价单</small>
                        {% else %}
                        <p class="text-muted mb-0">暂无报价信息</p>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    {% if current_user.has_permission('project', 'delete') and (current_user.role == 'admin' or current_user.id == project.owner_id) %}
    <div class="row mb-3">
        <div class="col-md-12 text-center">
            <form action="{{ url_for('project.delete_project', project_id=project.id) }}" method="post" style="display:inline;" onsubmit="return confirm('确定要删除此项目吗？此操作不可恢复。');">
                <button type="submit" class="btn btn-danger">
                    <i class="fas fa-trash"></i> 删除项目
                </button>
            </form>
        </div>
    </div>
    {% endif %}
</div>

<!-- 申请授权编号模态框 -->
<div class="modal fade" id="applyAuthorizationModal" tabindex="-1" aria-labelledby="applyAuthorizationModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form action="{{ url_for('project.apply_authorization', project_id=project.id) }}" method="post" id="applyAuthorizationForm">
                <div class="modal-header">
                    <h5 class="modal-title" id="applyAuthorizationModalLabel">申请授权编号</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p class="text-danger">请确认项目信息已经完整填写，包括项目名称、相关单位和项目说明等。</p>
                    <p>系统将对项目名称进行查重，如有重复或相似项目，申请可能会被驳回。</p>

                    <!-- 相似项目警告 -->
                    <div id="applySimilarProjectsWarning" class="d-none alert alert-warning mb-3">
                        <p><strong>警告：</strong>系统检测到存在相似项目，请确认是否继续申请。</p>
                        <div id="applySimilarProjectsList"></div>
                    </div>

                    <div class="form-group">
                        <label for="apply_note" class="form-label">申请说明（可选）：</label>
                        <textarea id="apply_note" name="apply_note" class="form-control" rows="3"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="submit" class="btn btn-primary">提交申请</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- 批准授权编号模态框 -->
<div class="modal fade" id="approveAuthorizationModal" tabindex="-1" aria-labelledby="approveAuthorizationModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form action="{{ url_for('project.approve_authorization', project_id=project.id) }}" method="post">
                <div class="modal-header">
                    <h5 class="modal-title" id="approveAuthorizationModalLabel">批准授权编号申请</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>您确认批准此项目的授权编号申请吗？批准后系统将自动生成授权编号。</p>
                    <div id="similarProjectsWarning" class="d-none alert alert-warning">
                        <p><strong>警告：</strong>系统检测到可能存在相似项目，请确认是否继续批准。</p>
                        <div id="similarProjectsList"></div>
                    </div>
                    <div class="form-group">
                        <label for="approval_note" class="form-label">批准备注（可选）：</label>
                        <textarea id="approval_note" name="approval_note" class="form-control" rows="3"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="submit" class="btn btn-success">确认批准</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- 驳回授权编号模态框 -->
<div class="modal fade" id="rejectAuthorizationModal" tabindex="-1" aria-labelledby="rejectAuthorizationModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form action="{{ url_for('project.reject_authorization', project_id=project.id) }}" method="post">
                <div class="modal-header">
                    <h5 class="modal-title" id="rejectAuthorizationModalLabel">驳回授权编号申请</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>您确认要驳回此项目的授权编号申请吗？</p>
                    <div class="form-group">
                        <label for="reject_reason" class="form-label">驳回原因（必填）：</label>
                        <textarea id="reject_reason" name="reject_reason" class="form-control" rows="3" required></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="submit" class="btn btn-danger">确认驳回</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- 撤回授权申请模态框 -->
<div class="modal fade" id="revokeAuthorizationModal" tabindex="-1" aria-labelledby="revokeAuthorizationModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-warning text-dark">
                <h5 class="modal-title" id="revokeAuthorizationModalLabel">撤回授权申请</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form action="{{ url_for('project.revoke_authorization', project_id=project.id) }}" method="POST">
                <div class="modal-body">
                    <p>您确定要撤回此项目的授权申请吗？</p>
                    <div class="mb-3">
                        <label for="revoke_reason" class="form-label">撤回原因（可选）</label>
                        <textarea class="form-control" id="revoke_reason" name="revoke_reason" rows="3" placeholder="请输入撤回原因..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="submit" class="btn btn-warning">确认撤回</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
    $(document).ready(function() {
        // 格式化项目说明，按日期分行
        function formatDescription() {
            const originalText = $('#original-description').text();
            if (!originalText) return;

            // 日期匹配正则表达式 (YYYY/MM/DD 或 YYYY/M/D) 可能跟随时间格式 (HH:MM:SS)
            const datePattern = /(\d{4}\/\d{1,2}\/\d{1,2}(?:\s+\d{1,2}:\d{1,2}:\d{1,2})?)/g;

            // 查找所有匹配的内容和位置
            let matches = [];
            let match;

            while ((match = datePattern.exec(originalText)) !== null) {
                matches.push({
                    text: match[0],
                    index: match.index
                });
            }

            // 如果没有找到日期，直接显示原文
            if (matches.length === 0) {
                $('#formatted-description').html('<p>' + originalText + '</p>');
                return;
            }

            // 提取每个日期所在的段落
            let formattedHtml = '';
            for (let i = 0; i < matches.length; i++) {
                const currentMatch = matches[i];
                const nextIndex = (i < matches.length - 1) ? matches[i + 1].index : originalText.length;

                // 提取日期和内容
                const date = currentMatch.text;
                const content = originalText.substring(currentMatch.index + date.length, nextIndex);

                formattedHtml += '<div class="description-entry">';
                formattedHtml += '<strong class="description-date">' + date + '</strong>';
                formattedHtml += '<span class="description-content">' + content + '</span>';
                formattedHtml += '</div>';
            }

            // 设置格式化后的HTML内容
            $('#formatted-description').html(formattedHtml);
        }

        // 执行格式化
        formatDescription();

        // 审批模态框打开时检查相似项目
        $('#approveAuthorizationModal').on('show.bs.modal', function (e) {
            $.ajax({
                url: "{{ url_for('project.check_similar_projects') }}",
                type: "POST",
                contentType: "application/json",
                data: JSON.stringify({
                    project_name: "{{ project.project_name }}",
                    exclude_id: "{{ project.id }}"
                }),
                success: function(data) {
                    if (data.similar_projects && data.similar_projects.length > 0) {
                        $('#similarProjectsWarning').removeClass('d-none');
                        let projectsList = '<ul>';
                        data.similar_projects.forEach(function(proj) {
                            projectsList += '<li><strong>' + proj.name +
                                         '</strong> (授权编号: ' + (proj.authorization_code || '') +
                                         ', 拥有人: ' + proj.owner_name +
                                         ', 状态: ' + (proj.status || '未知') +
                                         ', 相似度: ' + proj.similarity + '%)</li>';
                        });
                        projectsList += '</ul>';
                        $('#similarProjectsList').html(projectsList);
                    } else {
                        $('#similarProjectsWarning').addClass('d-none');
                    }
                },
                error: function(xhr, status, error) {
                    console.error('检查相似项目失败:', error);
                    $('#similarProjectsWarning').addClass('d-none');
                }
            });
        });

        // 申请授权模态框打开时检查相似项目
        $('#applyAuthorizationModal').on('show.bs.modal', function (e) {
            $.ajax({
                url: "{{ url_for('project.check_similar_projects') }}",
                type: "POST",
                contentType: "application/json",
                data: JSON.stringify({
                    project_name: "{{ project.project_name }}",
                    exclude_id: "{{ project.id }}"
                }),
                success: function(data) {
                    if (data.similar_projects && data.similar_projects.length > 0) {
                        $('#applySimilarProjectsWarning').removeClass('d-none');
                        let projectsList = '<ul>';
                        data.similar_projects.forEach(function(proj) {
                            projectsList += '<li><strong>' + proj.name +
                                         '</strong> (授权编号: ' + (proj.authorization_code || '') +
                                         ', 拥有人: ' + proj.owner_name +
                                         ', 状态: ' + (proj.status || '未知') +
                                         ', 相似度: ' + proj.similarity + '%)</li>';
                        });
                        projectsList += '</ul>';
                        $('#applySimilarProjectsList').html(projectsList);
                    } else {
                        $('#applySimilarProjectsWarning').addClass('d-none');
                    }
                },
                error: function(xhr, status, error) {
                    console.error('检查相似项目失败:', error);
                    $('#applySimilarProjectsWarning').addClass('d-none');
                }
            });
        });
    });
</script>
{% endblock %}

{% block styles %}
{{ super() }}
<style>
/* 报价链接样式 */
.quotation-link {
    color: #0d6efd;
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    gap: 8px;
}

.quotation-link:hover {
    text-decoration: underline;
    color: #0056b3;
}

.quotation-link .badge {
    font-size: 0.75rem;
    padding: 0.25rem 0.5rem;
}

/* 公司链接样式 */
.company-link {
    color: #0d6efd;
    text-decoration: none;
    display: inline-flex;
    align-items: center;
}

.company-link:hover {
    text-decoration: underline;
    color: #0a58ca;
    font-weight: 500;
}

/* 项目说明格式化样式 */
#formatted-description {
    line-height: 1.6;
}

.description-entry {
    margin-bottom: 15px;
    padding-bottom: 10px;
    border-bottom: 1px dashed #eee;
}

.description-entry:last-child {
    border-bottom: none;
    margin-bottom: 0;
}

.description-date {
    color: #0d6efd;
    font-weight: 600;
    display: block;
    margin-bottom: 5px;
}

.description-content {
    display: block;
    padding-left: 5px;
}
</style>
{% endblock %}
