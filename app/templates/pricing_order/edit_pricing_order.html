{% extends "base.html" %}
{% from 'macros/ui_helpers.html' import render_button, render_animated_alert_script, render_pricing_order_number, render_project_type %}

{% block title %}批价单编辑 - {{ pricing_order.order_number }}{% endblock %}

{% block head %}
<meta name="csrf-token" content="{{ csrf_token() }}">
<!-- 引入审批时间线样式 -->
<link rel="stylesheet" href="{{ url_for('static', filename='css/approval_timeline.css') }}">

<!-- 折扣权限检查样式 -->
<style>
.discount-warning {
    background-color: #dc3545 !important;
    color: white !important;
    border-color: #dc3545 !important;
}

.discount-warning:focus {
    background-color: #dc3545 !important;
    color: white !important;
    border-color: #dc3545 !important;
    box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25) !important;
}

.discount-info {
    font-size: 0.875rem;
    margin-top: 0.25rem;
}

.discount-limit-info {
    color: #6c757d;
    font-size: 0.875rem;
    margin-top: 0.5rem;
}

/* 搜索下拉框样式 */
.searchable-select-wrapper {
    position: relative;
}

.searchable-select-input {
    cursor: pointer;
}

.searchable-select-dropdown {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    z-index: 1000;
    background: white;
    border: 1px solid #ced4da;
    border-top: none;
    border-radius: 0 0 0.375rem 0.375rem;
    max-height: 200px;
    overflow-y: auto;
    display: none;
}

.searchable-select-wrapper.open .searchable-select-dropdown {
    display: block;
}

.searchable-select-option {
    padding: 8px 12px;
    cursor: pointer;
    border-bottom: 1px solid #f1f3f4;
}

.searchable-select-option:hover {
    background-color: #f8f9fa;
}

.searchable-select-option.selected {
    background-color: #007bff;
    color: white;
}

.searchable-select-option.readonly {
    color: #6c757d;
    font-style: italic;
}

.searchable-select-loading {
    padding: 8px 12px;
    text-align: center;
    color: #6c757d;
}

.searchable-select-no-results {
    padding: 8px 12px;
    text-align: center;
    color: #6c757d;
    font-style: italic;
}

.searchable-select-wrapper.open .searchable-select-input {
    border-radius: 0.375rem 0.375rem 0 0;
}

/* 禁用状态样式 */
.searchable-select-wrapper.disabled {
    opacity: 0.6;
    cursor: not-allowed;
}

.searchable-select-wrapper.disabled .searchable-select-input {
    background-color: #e9ecef;
    cursor: not-allowed;
}
</style>
{% endblock %}

{% block content %}
<!-- 引入标准提示函数 -->
{{ render_animated_alert_script() }}

<div class="container-fluid">
    <!-- 页面标题 -->
    <div class="row mb-4 mt-3">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h2 class="mb-2">
                        {% if pricing_order.status == 'draft' %}
                            批价单编辑
                        {% else %}
                            批价单
                        {% endif %}
                    </h2>
                    <div class="mb-2">
                        {{ render_pricing_order_number(pricing_order.order_number) }}
                        {% if pricing_order.project and pricing_order.project.project_type %}
                            {{ render_project_type(pricing_order.project.project_type) }}
                        {% else %}
                            <span class="badge bg-secondary rounded-pill">未知类型</span>
                        {% endif %}
                    </div>
                </div>
                <div class="d-flex gap-2">
                    {% if pricing_order.created_by == current_user.id and pricing_order.status == 'draft' %}
                        {{ render_button('删除批价单', color='danger', icon='fas fa-trash', type='button', attrs='data-bs-toggle="modal" data-bs-target="#deletePricingOrderModal"') }}
                    {% endif %}
                    
                    <!-- PDF导出按钮 - 仅在审批通过后且有权限时显示 -->
                    {% if pricing_order.status == 'approved' %}
                        {% set can_export_pricing = (current_user.role in ['admin', 'business_admin', 'finance_director']) or (pricing_order.created_by == current_user.id) or (pricing_order.project and pricing_order.project.vendor_sales_manager_id == current_user.id) %}
                        {% set can_export_settlement = current_user.role in ['admin', 'business_admin', 'finance_director'] %}
                        
                        {% if can_export_pricing or can_export_settlement %}
                        <div class="dropdown">
                            {{ render_button('PDF导出', color='outline-primary', icon='fas fa-file-pdf', type='button', size='sm', extra_class='dropdown-toggle', attrs='data-bs-toggle="dropdown" aria-expanded="false"') }}
                            <ul class="dropdown-menu">
                                {% if can_export_pricing %}
                                <li>
                                    <a class="dropdown-item" 
                                       href="{{ url_for('pricing_order.export_pdf', order_id=pricing_order.id, pdf_type='pricing') }}" 
                                       target="_blank">
                                        <i class="fas fa-file-pdf text-primary me-2"></i>批价单PDF
                                    </a>
                                </li>
                                {% endif %}
                                {% if can_export_settlement %}
                                <li>
                                    <a class="dropdown-item" 
                                       href="{{ url_for('pricing_order.export_pdf', order_id=pricing_order.id, pdf_type='settlement') }}" 
                                       target="_blank">
                                        <i class="fas fa-file-pdf text-success me-2"></i>结算单PDF
                                    </a>
                                </li>
                                {% endif %}
                            </ul>
                        </div>
                        {% endif %}
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- 项目信息区域 -->
    <div class="card mb-3">
        <div class="card-header">
            <h5><i class="fas fa-project-diagram"></i> 项目信息</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <p><strong>关联项目：</strong>
                        <a href="{{ url_for('project.view_project', project_id=pricing_order.project.id) }}" 
                           class="text-primary" target="_blank">
                            {{ pricing_order.project.project_name }}
                        </a>
                    </p>
                </div>
                <div class="col-md-6">
                    <p><strong>报价单：</strong>
                        <a href="{{ url_for('quotation.view_quotation', id=pricing_order.quotation.id) }}" 
                           class="badge rounded-pill" 
                           style="background-color: #e6e6e6; color: #0056b3; font-family: 'Helvetica Neue', sans-serif; font-size: 0.85rem; font-weight: normal; padding: 0.3em 0.75em; text-decoration: none;" 
                           target="_blank">{{ pricing_order.quotation.quotation_number }}</a>
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- 渠道信息区域 -->
    <div class="card mb-3">
        <div class="card-header">
            <h5><i class="fas fa-users"></i> 渠道信息</h5>
        </div>
        <div class="card-body">
            <form id="basicInfoForm">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group mb-3">
                            <label for="dealerSelect">经销商</label>
                            <div class="searchable-select-wrapper" data-type="dealer" data-name="dealer_id" id="dealerSelectWrapper" data-can-edit="{% if can_edit_pricing %}true{% else %}false{% endif %}">
                                <input type="text" class="form-control searchable-select-input" id="dealerSelectInput" placeholder="请选择或搜索经销商" autocomplete="off" 
                                       {% if not can_edit_pricing %}readonly{% endif %}
                                       value="{% if pricing_order.dealer and pricing_order.dealer.company_name %}{{ pricing_order.dealer.company_name }}{% endif %}">
                                <input type="hidden" name="dealer_id" class="searchable-select-value" id="dealerSelect" 
                                       value="{% if pricing_order.dealer_id %}{{ pricing_order.dealer_id }}{% endif %}">
                                <div class="searchable-select-dropdown">
                                    <div class="searchable-select-loading">加载中...</div>
                                </div>
                                {% if not can_edit_pricing %}
                                <div class="searchable-select-disabled-overlay"></div>
                                {% endif %}
                            </div>
                        </div>
                        
                        <!-- 厂商直签开关 -->
                        <div class="form-group mb-4">
                            <div class="d-inline-flex align-items-center gap-3 flex-nowrap">
                                <div class="toggle-switch">
                                    <input type="checkbox" id="directContractSwitch" 
                                           {% if pricing_order.is_direct_contract %}checked{% endif %}
                                           {% if not can_edit_pricing %}disabled{% endif %}>
                                    <span class="toggle-slider" onclick="toggleDirectContractSwitch()"></span>
                                </div>
                                <span class="form-label mb-0 text-nowrap">厂商直签</span>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group mb-3">
                            <label for="distributorSelect">分销商</label>
                            <div class="searchable-select-wrapper" data-type="distributor" data-name="distributor_id" id="distributorSelectWrapper" data-can-edit="{% if can_edit_pricing %}true{% else %}false{% endif %}">
                                <input type="text" class="form-control searchable-select-input" id="distributorSelectInput" placeholder="请选择或搜索分销商" autocomplete="off" 
                                       {% if not can_edit_pricing %}readonly{% endif %}
                                       value="{% if pricing_order.distributor and pricing_order.distributor.company_name %}{{ pricing_order.distributor.company_name }}{% endif %}">
                                <input type="hidden" name="distributor_id" class="searchable-select-value" id="distributorSelect" 
                                       value="{% if pricing_order.distributor_id %}{{ pricing_order.distributor_id }}{% endif %}">
                                <div class="searchable-select-dropdown">
                                    <div class="searchable-select-loading">加载中...</div>
                                </div>
                                {% if not can_edit_pricing %}
                                <div class="searchable-select-disabled-overlay"></div>
                                {% endif %}
                            </div>
                        </div>
                        
                        <!-- 厂家提货开关 -->
                        <div class="form-group mb-4">
                            <div class="d-inline-flex align-items-center gap-3 flex-nowrap">
                                <div class="toggle-switch">
                                    <input type="checkbox" id="factoryPickupSwitch" 
                                           {% if pricing_order.is_factory_pickup %}checked{% endif %}
                                           {% if not can_edit_pricing %}disabled{% endif %}>
                                    <span class="toggle-slider" onclick="toggleFactoryPickupSwitch()"></span>
                                </div>
                                <span class="form-label mb-0 text-nowrap">从厂家提货</span>
                            </div>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- 产品明细页签区域 -->
    <div class="card mb-3">
        <div class="card-header">
            <ul class="nav nav-tabs card-header-tabs" id="productTabs" role="tablist">
                <li class="nav-item">
                    <a class="nav-link active" id="pricing-tab" data-bs-toggle="tab" href="#pricing-content" 
                       role="tab" aria-controls="pricing-content" aria-selected="true">
                        批价单产品明细
                    </a>
                </li>
                {% if can_view_settlement %}
                <li class="nav-item">
                    <a class="nav-link" id="settlement-tab" data-bs-toggle="tab" href="#settlement-content" 
                       role="tab" aria-controls="settlement-content" aria-selected="false">
                        结算单产品明细
                    </a>
                </li>
                {% endif %}
            </ul>
        </div>
        <div class="card-body">
            <div class="tab-content" id="productTabContent">
                <!-- 批价单产品明细 -->
                <div class="tab-pane fade show active" id="pricing-content" role="tabpanel" aria-labelledby="pricing-tab">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h6>批价单产品明细</h6>
                    </div>
                    
                    <div class="table-container">
                    <!-- 批量操作按钮区域 - 默认隐藏，选中多选框后才显示 -->
                    {% if can_edit_pricing and pricing_order.status != 'pending' %}
                    <div class="mb-3 d-flex align-items-center gap-2" id="batchActionsArea" style="display: none;">
                        <button type="button" class="btn btn-danger btn-sm" id="batchDeleteBtn" onclick="batchDeleteProducts()">
                            <i class="fas fa-trash me-1"></i>删除选中项 (<span id="selectedCount">0</span>)
                        </button>
                        <small class="text-muted">已选择 <span id="selectedCountText">0</span> 个产品</small>
                    </div>
                    {% endif %}
                    
                    <div class="table-responsive">
                            <table class="table table-bordered table-hover" id="pricingTable">
                                <thead>
                                    <tr>
                                    {% if can_edit_pricing and pricing_order.status != 'pending' %}
                                        <th style="width: 40px;">
                                            <input type="checkbox" id="selectAllPricing" class="form-check-input" title="全选/取消全选">
                                        </th>
                                    {% endif %}
                                        <th class="name-column">产品名称</th>
                                        <th style="min-width: 130px;">产品型号</th>
                                        <th class="desc-column">产品规格</th>
                                        <th style="min-width: 90px;">品牌</th>
                                        <th style="min-width: 70px;">单位</th>
                                        <th class="price-column">市场单价</th>
                                        <th style="min-width: 90px;">折扣率%</th>
                                        <th class="price-column">单价</th>
                                        <th style="min-width: 70px;">数量</th>
                                        <th class="price-column">小计</th>
                                        <th class="mn-column">MN</th>
                                    {% if can_edit_pricing and pricing_order.status != 'pending' %}
                                        <th class="action-column" style="min-width: 50px;">操作</th>
                                    {% endif %}
                                </tr>
                            </thead>
                            <tbody>
                                    {% if pricing_order.pricing_details %}
                                {% for detail in pricing_order.pricing_details %}
                                <tr data-detail-id="{{ detail.id }}">
                                    {% if can_edit_pricing and pricing_order.status != 'pending' %}
                                        <td class="text-center">
                                            <input type="checkbox" class="form-check-input pricing-detail-checkbox" 
                                                   value="{{ detail.id }}" data-detail-id="{{ detail.id }}">
                                        </td>
                                    {% endif %}
                                        <td>
                                            {% if can_edit_pricing %}
                                            <div class="product-name-container">
                                                <input type="text" class="form-control product-name" 
                                                       value="{{ detail.product_name }}" 
                                                       required placeholder="点击选择产品...">
                                            </div>
                                            {% else %}
                                            {{ detail.product_name }}
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if can_edit_pricing %}
                                            <div class="product-model-container">
                                                <input type="text" class="form-control product-model" 
                                                       value="{{ detail.product_model or '' }}" readonly>
                                            </div>
                                            {% else %}
                                            {{ detail.product_model or '-' }}
                                            {% endif %}
                                        </td>
                                    <td>
                                            {% if can_edit_pricing %}
                                            <input type="text" class="form-control product-spec" 
                                                   value="{{ detail.product_desc or '' }}" readonly>
                                            {% else %}
                                            {{ detail.product_desc or '-' }}
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if can_edit_pricing %}
                                            <input type="text" class="form-control product-brand" 
                                                   value="{{ detail.brand or '' }}" readonly>
                                            {% else %}
                                        {{ detail.brand or '-' }}
                                            {% endif %}
                                    </td>
                                    <td>
                                        {% if can_edit_pricing %}
                                            <input type="text" class="form-control product-unit" 
                                                   value="{{ detail.unit or '' }}" readonly>
                                        {% else %}
                                            {{ detail.unit or '-' }}
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if can_edit_pricing %}
                                            <input type="text" class="form-control product-price" 
                                                   value="{{ '%.2f'|format(detail.market_price) }}" 
                                                   data-raw-value="{{ detail.market_price }}" readonly>
                                            {% else %}
                                            ¥{{ "{:,.2f}".format(detail.market_price) }}
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if can_edit_discount_price %}
                                            <div class="discount-rate-container">
                                                <input type="number" class="form-control discount-rate" 
                                                       value="{{ '%.1f'|format(detail.discount_rate * 100) }}" 
                                                       min="0" step="0.1" max="1000" required>
                                            </div>
                                        {% else %}
                                        {{ "{:.2f}".format(detail.discount_rate * 100) }}%
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if can_edit_discount_price %}
                                            <input type="text" class="form-control discounted-price" 
                                                   value="{{ '%.2f'|format(detail.unit_price) }}" 
                                                   data-raw-value="{{ detail.unit_price }}" placeholder="输入单价">
                                        {% else %}
                                        ¥{{ "{:,.2f}".format(detail.unit_price) }}
                                        {% endif %}
                                    </td>
                                        <td>
                                    {% if can_edit_quantity %}
                                            <input type="number" class="form-control quantity" 
                                                   value="{{ detail.quantity }}" min="1" step="1" required 
                                                   data-raw-value="{{ detail.quantity }}">
                                            {% else %}
                                            <!-- 隐藏的输入框保留数量值供JavaScript使用 -->
                                            <input type="hidden" class="quantity" 
                                                   value="{{ detail.quantity }}" 
                                                   data-raw-value="{{ detail.quantity }}">
                                            <!-- 显示数量文本 -->
                                            <span class="quantity-display">{{ detail.quantity }}</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if can_edit_pricing %}
                                            <input type="text" class="form-control subtotal" 
                                                   value="{{ '%.2f'|format(detail.total_price) }}" 
                                                   data-raw-value="{{ detail.total_price }}" readonly>
                                            {% else %}
                                            ¥{{ "{:,.2f}".format(detail.total_price) }}
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if can_edit_pricing %}
                                            <input type="text" class="form-control product-mn" 
                                                   value="{{ detail.product_mn or '' }}" readonly>
                                            {% else %}
                                            {{ detail.product_mn or '-' }}
                                            {% endif %}
                                        </td>
                                        {% if can_edit_pricing and pricing_order.status != 'pending' %}
                                        <td class="text-center">
                                            <button type="button" class="btn btn-danger btn-sm remove-row" 
                                                data-detail-id="{{ detail.id }}">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </td>
                                    {% endif %}
                                </tr>
                                {% endfor %}
                                    {% else %}
                                    {% if can_edit_pricing %}
                                    <tr>
                                        <td>
                                            <div class="product-name-container">
                                                <input type="text" class="form-control product-name" 
                                                       required placeholder="点击选择产品...">
                                            </div>
                                        </td>
                                        <td>
                                            <div class="product-model-container">
                                                <input type="text" class="form-control product-model" readonly>
                                            </div>
                                        </td>
                                        <td>
                                            <input type="text" class="form-control product-spec" readonly>
                                        </td>
                                        <td>
                                            <input type="text" class="form-control product-brand" readonly>
                                        </td>
                                        <td>
                                            <input type="text" class="form-control product-unit" readonly>
                                        </td>
                                        <td>
                                            <input type="text" class="form-control product-price" readonly>
                                        </td>
                                        <td>
                                            <div class="discount-rate-container">
                                                <input type="number" class="form-control discount-rate" 
                                                       value="100.0" min="0" step="0.1" max="1000" required>
                                            </div>
                                        </td>
                                        <td>
                                            <input type="text" class="form-control discounted-price" 
                                                   placeholder="输入单价">
                                        </td>
                                        <td>
                                            <input type="number" class="form-control quantity" 
                                                   value="1" min="1" step="1" required>
                                        </td>
                                        <td>
                                            <input type="text" class="form-control subtotal" readonly>
                                        </td>
                                        <td>
                                            <input type="text" class="form-control product-mn" readonly>
                                        </td>
                                        <td class="text-center">
                                            <button type="button" class="btn btn-danger btn-sm remove-row">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </td>
                                    </tr>
                                    {% endif %}
                                    {% endif %}
                            </tbody>
                        </table>
                        </div>
                    </div>
                    
                    <!-- 移动端卡片视图 - 批价单产品明细 -->
                    <div class="mobile-card-container">
                        {% if pricing_order.pricing_details %}
                        {% for detail in pricing_order.pricing_details %}
                        <div class="mobile-product-card" data-detail-id="{{ detail.id }}">
                            <!-- 卡片头部 -->
                            <div class="mobile-card-header">
                                <h6 class="mobile-card-title">{{ detail.product_name }}</h6>
                                {% if can_edit_pricing and pricing_order.status != 'pending' %}
                                <div class="mobile-card-actions">
                                    <button type="button" class="mobile-delete-btn remove-row" data-detail-id="{{ detail.id }}">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                                {% endif %}
                            </div>
                            
                            <!-- 卡片主要内容 -->
                            <div class="mobile-card-body">
                                <div class="mobile-card-row">
                                    <span class="mobile-card-label">型号</span>
                                    <div class="mobile-card-value">
                                        {% if can_edit_pricing %}
                                        <input type="text" class="mobile-card-input product-model" 
                                               value="{{ detail.product_model or '' }}" readonly>
                                        {% else %}
                                        {{ detail.product_model or '-' }}
                                        {% endif %}
                                    </div>
                                </div>
                                
                                <div class="mobile-card-row">
                                    <span class="mobile-card-label">品牌</span>
                                    <div class="mobile-card-value">
                                        {% if can_edit_pricing %}
                                        <input type="text" class="mobile-card-input product-brand" 
                                               value="{{ detail.brand or '' }}" readonly>
                                        {% else %}
                                        {{ detail.brand or '-' }}
                                        {% endif %}
                                    </div>
                                </div>
                                
                                <div class="mobile-card-row">
                                    <span class="mobile-card-label">数量</span>
                                    <div class="mobile-card-value">
                                        {% if can_edit_quantity %}
                                        <input type="number" class="mobile-card-input quantity" 
                                               value="{{ detail.quantity }}" min="1" step="1" required>
                                        {% else %}
                                        {{ detail.quantity }} {{ detail.unit or '台' }}
                                        {% endif %}
                                    </div>
                                </div>
                                
                                <div class="mobile-card-row">
                                    <span class="mobile-card-label">折扣率</span>
                                    <div class="mobile-card-value">
                                        {% if can_edit_discount_price %}
                                        <input type="number" class="mobile-card-input discount-rate" 
                                               value="{{ '%.1f'|format(detail.discount_rate * 100) }}" 
                                               min="0" step="0.1" max="1000" required>%
                                        {% else %}
                                        {{ "{:.1f}".format(detail.discount_rate * 100) }}%
                                        {% endif %}
                                    </div>
                                </div>
                                
                                <div class="mobile-card-row">
                                    <span class="mobile-card-label">单价</span>
                                    <div class="mobile-card-value mobile-price-highlight">
                                        {% if can_edit_pricing %}
                                        <input type="text" class="mobile-card-input discounted-price" 
                                               value="{{ '%.2f'|format(detail.unit_price) }}" 
                                               data-raw-value="{{ detail.unit_price }}" placeholder="输入单价">
                                        {% else %}
                                        {{ "{:,.2f}".format(detail.unit_price) }}
                                        {% endif %}
                                    </div>
                                </div>
                                
                                <div class="mobile-card-row">
                                    <span class="mobile-card-label">小计</span>
                                    <div class="mobile-card-value mobile-subtotal-highlight">
                                        {% if can_edit_pricing %}
                                        <input type="text" class="mobile-card-input subtotal" 
                                               value="{{ '%.2f'|format(detail.total_price) }}" 
                                               data-raw-value="{{ detail.total_price }}" readonly>
                                        {% else %}
                                        {{ "{:,.2f}".format(detail.total_price) }}
                                        {% endif %}
                                    </div>
                                </div>
                                
                                <!-- 展开按钮 -->
                                <button class="mobile-expand-btn" onclick="toggleMobileDetails(this)">
                                    <i class="fas fa-chevron-down"></i> 查看详情
                                </button>
                                
                                <!-- 隐藏的详细信息 -->
                                <div class="mobile-card-details">
                                    <div class="mobile-card-row">
                                        <span class="mobile-card-label">规格</span>
                                        <div class="mobile-card-value">
                                            {% if can_edit_pricing %}
                                            <input type="text" class="mobile-card-input product-spec" 
                                                   value="{{ detail.product_desc or '' }}" readonly>
                                            {% else %}
                                            {{ detail.product_desc or '-' }}
                                            {% endif %}
                                        </div>
                                    </div>
                                    
                                    <div class="mobile-card-row">
                                        <span class="mobile-card-label">单位</span>
                                        <div class="mobile-card-value">
                                            {% if can_edit_pricing %}
                                            <input type="text" class="mobile-card-input product-unit" 
                                                   value="{{ detail.unit or '' }}" readonly>
                                            {% else %}
                                            {{ detail.unit or '-' }}
                                            {% endif %}
                                        </div>
                                    </div>
                                    
                                    <div class="mobile-card-row">
                                        <span class="mobile-card-label">市场价</span>
                                        <div class="mobile-card-value">
                                            {% if can_edit_pricing %}
                                            <input type="text" class="mobile-card-input product-price" 
                                                   value="{{ '%.2f'|format(detail.market_price) }}" 
                                                   data-raw-value="{{ detail.market_price }}" readonly>
                                            {% else %}
                                            {{ "{:,.2f}".format(detail.market_price) }}
                                            {% endif %}
                                        </div>
                                    </div>
                                    
                                    <div class="mobile-card-row">
                                        <span class="mobile-card-label">MN</span>
                                        <div class="mobile-card-value">
                                            {% if can_edit_pricing %}
                                            <input type="text" class="mobile-card-input product-mn" 
                                                   value="{{ detail.product_mn or '' }}" readonly>
                                            {% else %}
                                            {{ detail.product_mn or '-' }}
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                        {% else %}
                        <!-- 空状态 -->
                        <div class="text-center py-4">
                            <i class="fas fa-box-open fa-3x text-muted mb-3"></i>
                            <p class="text-muted">暂无产品明细</p>
                        </div>
                        {% endif %}
                    </div>

                    
                    <!-- 批价单总额显示 - 加入总折扣率 -->
                    <div class="row mt-3">
                        <div class="col-md-6 offset-md-6">
                            <div class="card bg-light">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between mb-2">
                                        <span><strong>批价单总折扣率：</strong></span>
                                        <div>
                                            {% if can_edit_discount_price %}
                                            <input type="number" class="form-control form-control-sm d-inline-block discount-rate" 
                                                   style="width: 100px;" value="{{ pricing_order.pricing_discount_percentage }}"
                                                   min="0" max="1000" step="0.1" id="pricingTotalDiscount"
                                                   onchange="updateTotalDiscount('pricing', this.value)">
                                            <span class="ml-1">%</span>
                                            {% else %}
                                            <span class="text-primary" id="pricingTotalDiscount">
                                                {{ pricing_order.pricing_discount_percentage }}%
                                            </span>
                                            {% endif %}
                                        </div>
                                    </div>
                                    <div class="d-flex justify-content-between">
                                        <span><strong>批价单总金额：</strong></span>
                                        <span class="text-primary" id="pricingTotalAmount">
                                            ¥{{ pricing_order.formatted_pricing_total_amount }}
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    

                </div>

                <!-- 结算单产品明细 -->
                {% if can_view_settlement %}
                <div class="tab-pane fade" id="settlement-content" role="tabpanel" aria-labelledby="settlement-tab">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h6>结算单产品明细</h6>
                    </div>
                    
                    <div class="table-container">
                    <div class="table-responsive">
                            <table class="table table-bordered table-hover" id="settlementTable">
                                <thead>
                                    <tr>
                                        <th class="name-column">产品名称</th>
                                        <th style="min-width: 130px;">产品型号</th>
                                        <th class="desc-column">产品规格</th>
                                        <th style="min-width: 90px;">品牌</th>
                                        <th style="min-width: 70px;">单位</th>
                                        <th class="price-column">市场单价</th>
                                        <th style="min-width: 90px;">折扣率%</th>
                                        <th class="price-column">单价</th>
                                        <th style="min-width: 70px;">数量</th>
                                        <th class="price-column">小计</th>
                                        <th class="mn-column">MN</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for detail in pricing_order.settlement_details %}
                                <tr data-detail-id="{{ detail.id }}">
                                        <td>
                                            {% if can_edit_settlement %}
                                            <div class="product-name-container">
                                                <input type="text" class="form-control product-name" 
                                                       value="{{ detail.product_name }}" 
                                                       required placeholder="点击选择产品...">
                                            </div>
                                            {% else %}
                                            {{ detail.product_name }}
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if can_edit_settlement %}
                                            <div class="product-model-container">
                                                <input type="text" class="form-control product-model" 
                                                       value="{{ detail.product_model or '' }}" readonly>
                                            </div>
                                            {% else %}
                                            {{ detail.product_model or '-' }}
                                            {% endif %}
                                        </td>
                                    <td>
                                            {% if can_edit_settlement %}
                                            <input type="text" class="form-control product-spec" 
                                                   value="{{ detail.product_desc or '' }}" readonly>
                                            {% else %}
                                            {{ detail.product_desc or '-' }}
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if can_edit_settlement %}
                                            <input type="text" class="form-control product-brand" 
                                                   value="{{ detail.brand or '' }}" readonly>
                                            {% else %}
                                        {{ detail.brand or '-' }}
                                            {% endif %}
                                    </td>
                                    <td>
                                        {% if can_edit_settlement %}
                                            <input type="text" class="form-control product-unit" 
                                                   value="{{ detail.unit or '' }}" readonly>
                                            {% else %}
                                            {{ detail.quantity }}
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if can_edit_settlement %}
                                            <input type="text" class="form-control product-price" 
                                                   value="{{ '%.2f'|format(detail.market_price) }}" 
                                                   data-raw-value="{{ detail.market_price }}" readonly>
                                            {% else %}
                                            ¥{{ "{:,.2f}".format(detail.market_price) }}
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if can_edit_discount_price %}
                                            <div class="discount-rate-container">
                                                <input type="number" class="form-control discount-rate" 
                                                       value="{{ '%.1f'|format(detail.discount_rate * 100) }}" 
                                                       min="0" step="0.1" max="1000" required>
                                            </div>
                                        {% else %}
                                        {{ "{:.2f}".format(detail.discount_rate * 100) }}%
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if can_edit_discount_price %}
                                            <input type="text" class="form-control discounted-price" 
                                                   value="{{ '%.2f'|format(detail.unit_price) }}" 
                                                   data-raw-value="{{ detail.unit_price }}" placeholder="输入单价">
                                        {% else %}
                                        ¥{{ "{:,.2f}".format(detail.unit_price) }}
                                        {% endif %}
                                    </td>
                                        <td>
                                            {% if can_edit_quantity %}
                                            <input type="number" class="form-control quantity" 
                                                   value="{{ detail.quantity }}" min="1" step="1" required>
                                            {% else %}
                                            {{ detail.quantity }}
                                            <input type="hidden" class="quantity" value="{{ detail.quantity }}">
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if can_edit_settlement %}
                                            <input type="text" class="form-control subtotal" 
                                                   value="{{ '%.2f'|format(detail.total_price) }}" 
                                                   data-raw-value="{{ detail.total_price }}" readonly>
                                            {% else %}
                                            ¥{{ "{:,.2f}".format(detail.total_price) }}
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if can_edit_settlement %}
                                            <input type="text" class="form-control product-mn" 
                                                   value="{{ detail.product_mn or '' }}" readonly>
                                            {% else %}
                                            {{ detail.product_mn or '-' }}
                                            {% endif %}
                                        </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                        </div>
                    </div>
                    
                    <!-- 移动端卡片视图 - 结算单产品明细 -->
                    <div class="mobile-card-container">
                        {% if pricing_order.settlement_details %}
                        {% for detail in pricing_order.settlement_details %}
                        <div class="mobile-product-card" data-detail-id="{{ detail.id }}">
                            <!-- 卡片头部 -->
                            <div class="mobile-card-header">
                                <h6 class="mobile-card-title">{{ detail.product_name }}</h6>
                            </div>
                            
                            <!-- 卡片主要内容 -->
                            <div class="mobile-card-body">
                                <div class="mobile-card-row">
                                    <span class="mobile-card-label">型号</span>
                                    <div class="mobile-card-value">
                                        {% if can_edit_settlement %}
                                        <input type="text" class="mobile-card-input product-model" 
                                               value="{{ detail.product_model or '' }}" readonly>
                                        {% else %}
                                        {{ detail.product_model or '-' }}
                                        {% endif %}
                                    </div>
                                </div>
                                
                                <div class="mobile-card-row">
                                    <span class="mobile-card-label">品牌</span>
                                    <div class="mobile-card-value">
                                        {% if can_edit_settlement %}
                                        <input type="text" class="mobile-card-input product-brand" 
                                               value="{{ detail.brand or '' }}" readonly>
                                        {% else %}
                                        {{ detail.brand or '-' }}
                                        {% endif %}
                                    </div>
                                </div>
                                
                                <div class="mobile-card-row">
                                    <span class="mobile-card-label">数量</span>
                                    <div class="mobile-card-value">
                                        {% if can_edit_quantity %}
                                        <input type="number" class="mobile-card-input quantity" 
                                               value="{{ detail.quantity }}" min="1" step="1" required>
                                        {% else %}
                                        {{ detail.quantity }} {{ detail.unit or '台' }}
                                        {% endif %}
                                    </div>
                                </div>
                                
                                <div class="mobile-card-row">
                                    <span class="mobile-card-label">折扣率</span>
                                    <div class="mobile-card-value">
                                        {% if can_edit_discount_price %}
                                        <input type="number" class="mobile-card-input discount-rate" 
                                               value="{{ '%.1f'|format(detail.discount_rate * 100) }}" 
                                               min="0" step="0.1" max="1000" required>%
                                        {% else %}
                                        {{ "{:.1f}".format(detail.discount_rate * 100) }}%
                                        {% endif %}
                                    </div>
                                </div>
                                
                                <div class="mobile-card-row">
                                    <span class="mobile-card-label">单价</span>
                                    <div class="mobile-card-value mobile-price-highlight">
                                        {% if can_edit_settlement %}
                                        <input type="text" class="mobile-card-input discounted-price" 
                                               value="{{ '%.2f'|format(detail.unit_price) }}" 
                                               data-raw-value="{{ detail.unit_price }}" placeholder="输入单价">
                                        {% else %}
                                        {{ "{:,.2f}".format(detail.unit_price) }}
                                        {% endif %}
                                    </div>
                                </div>
                                
                                <div class="mobile-card-row">
                                    <span class="mobile-card-label">小计</span>
                                    <div class="mobile-card-value mobile-subtotal-highlight">
                                        {% if can_edit_settlement %}
                                        <input type="text" class="mobile-card-input subtotal" 
                                               value="{{ '%.2f'|format(detail.total_price) }}" 
                                               data-raw-value="{{ detail.total_price }}" readonly>
                                        {% else %}
                                        {{ "{:,.2f}".format(detail.total_price) }}
                                        {% endif %}
                                    </div>
                                </div>
                                
                                <!-- 展开按钮 -->
                                <button class="mobile-expand-btn" onclick="toggleMobileDetails(this)">
                                    <i class="fas fa-chevron-down"></i> 查看详情
                                </button>
                                
                                <!-- 隐藏的详细信息 -->
                                <div class="mobile-card-details">
                                    <div class="mobile-card-row">
                                        <span class="mobile-card-label">规格</span>
                                        <div class="mobile-card-value">
                                            {% if can_edit_settlement %}
                                            <input type="text" class="mobile-card-input product-spec" 
                                                   value="{{ detail.product_desc or '' }}" readonly>
                                            {% else %}
                                            {{ detail.product_desc or '-' }}
                                            {% endif %}
                                        </div>
                                    </div>
                                    
                                    <div class="mobile-card-row">
                                        <span class="mobile-card-label">单位</span>
                                        <div class="mobile-card-value">
                                            {% if can_edit_settlement %}
                                            <input type="text" class="mobile-card-input product-unit" 
                                                   value="{{ detail.unit or '' }}" readonly>
                                            {% else %}
                                            {{ detail.unit or '-' }}
                                            {% endif %}
                                        </div>
                                    </div>
                                    
                                                                         <div class="mobile-card-row">
                                         <span class="mobile-card-label">市场价</span>
                                         <div class="mobile-card-value">
                                             {% if can_edit_settlement %}
                                             <input type="text" class="mobile-card-input product-price" 
                                                    value="{{ '%.2f'|format(detail.market_price) }}" 
                                                    data-raw-value="{{ detail.market_price }}" readonly>
                                             {% else %}
                                             {{ "{:,.2f}".format(detail.market_price) }}
                                             {% endif %}
                                         </div>
                                     </div>
                                    
                                    <div class="mobile-card-row">
                                        <span class="mobile-card-label">MN</span>
                                        <div class="mobile-card-value">
                                            {% if can_edit_settlement %}
                                            <input type="text" class="mobile-card-input product-mn" 
                                                   value="{{ detail.product_mn or '' }}" readonly>
                                            {% else %}
                                            {{ detail.product_mn or '-' }}
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                        {% else %}
                        <!-- 空状态 -->
                        <div class="text-center py-4">
                            <i class="fas fa-box-open fa-3x text-muted mb-3"></i>
                            <p class="text-muted">暂无结算单明细</p>
                            <small class="text-muted">结算单明细将从批价单同步</small>
                        </div>
                        {% endif %}
                    </div>

                    
                    <!-- 分销利润显示 -->
                    <div class="row mt-3">
                        <div class="col-md-6 offset-md-6">
                            <div class="card bg-info text-white">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between">
                                        <span><strong>分销利润：</strong></span>
                                        <span id="distributionProfit">¥0.00</span>
                                    </div>
                                    <div class="d-flex justify-content-between mt-2">
                                        <span><strong>利润率：</strong></span>
                                        <span id="profitMargin">0.00%</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 结算单总额显示 -->
                    <div class="row mt-3">
                        <div class="col-md-6 offset-md-6">
                            <div class="card bg-light">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between">
                                        <span><strong>结算单总折扣率：</strong></span>
                                        <div>
                                            {% if can_edit_settlement %}
                                            <input type="number" class="form-control form-control-sm d-inline-block discount-rate" 
                                                   style="width: 100px;" value="{{ pricing_order.settlement_discount_percentage }}"
                                                   min="0" max="1000" step="0.1" id="settlementTotalDiscount"
                                                   onchange="updateTotalDiscount('settlement', this.value)">
                                            <span>%</span>
                                            {% else %}
                                            <span class="text-success" id="settlementTotalDiscount">
                                                {{ pricing_order.settlement_discount_percentage }}%
                                            </span>
                                            {% endif %}
                                        </div>
                                    </div>
                                    <div class="d-flex justify-content-between mt-2">
                                        <span><strong>结算单总金额：</strong></span>
                                        <span class="text-success" id="settlementTotalAmount">
                                            ¥{{ pricing_order.formatted_settlement_total_amount }}
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- 审批流程模块 -->
    <div class="card">
        <div class="card-header bg-dark text-white">
            <h6 class="mb-0"><i class="fas fa-sitemap me-2"></i>审批流程图</h6>
        </div>
        <div class="card-body">
            <!-- 只有非草稿状态且有审批记录时才显示审批流程图 -->
            {% if pricing_order.status not in ['draft'] and pricing_order.approval_records|length > 0 %}
            <div class="approval-workflow">
                <div class="timeline">
                    {% set visible_records = pricing_order.approval_records|selectattr('action', '!=', 'recall')|list|sort(attribute='step_order') %}
                    
                    <!-- 流程发起节点（第0步） -->
                    <div class="timeline-item">
                        <div class="timeline-marker bg-info"></div>
                        <div class="timeline-content">
                            <div class="d-flex justify-content-between">
                                <h6 class="timeline-title">
                                    流程发起
                                    {% if step_discount_statuses.get(0, {}).get('has_violation', False) %}
                                        <span class="badge bg-danger ms-2" title="发起人权限不足，存在折扣超出">
                                            <i class="fas fa-exclamation-triangle"></i> 权限超出
                                        </span>
                                    {% endif %}
                                </h6>
                                <span class="badge bg-info">已发起</span>
                            </div>
                            <p class="standard-font mb-1">
                                发起人: <strong>{{ pricing_order.creator.real_name or pricing_order.creator.username }}</strong>
                            </p>
                            <p class="text-muted standard-font">
                                发起时间: {{ format_datetime(pricing_order.created_at) }}
                            </p>
                            {% if step_discount_statuses.get(0, {}).get('has_violation', False) %}
                                <div class="mt-2 p-2 bg-danger-light rounded">
                                    <small class="text-danger">
                                        <i class="fas fa-exclamation-triangle me-1"></i>
                                        发起人设置的折扣率低于其权限下限，需要审批人关注
                                    </small>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                    
                    {% for record in visible_records %}
                        <div class="timeline-item">
                            <div class="timeline-marker{% if record.action == 'approve' %} bg-success{% elif record.action == 'reject' %} bg-danger{% elif record.step_order == pricing_order.current_approval_step and pricing_order.status == 'pending' %} bg-warning{% else %} bg-secondary{% endif %}"></div>
                            <div class="timeline-content">
                                <div class="d-flex justify-content-between">
                                    <h6 class="timeline-title">
                                        步骤 {{ record.step_order }}: {{ record.step_name }}
                                        {% if step_discount_statuses.get(record.step_order, {}).get('has_violation', False) %}
                                            <span class="badge bg-danger ms-2" title="审批人权限不足，存在折扣超出">
                                                <i class="fas fa-exclamation-triangle"></i> 权限超出
                                            </span>
                                        {% endif %}
                                    </h6>
                                    {% if record.step_order == pricing_order.current_approval_step and pricing_order.status == 'pending' %}
                                        <span class="badge bg-warning">当前步骤</span>
                                    {% elif record.action == 'approve' %}
                                        <span class="badge bg-success">已通过</span>
                                    {% elif record.action == 'reject' %}
                                        <span class="badge bg-danger">已拒绝</span>
                                    {% elif pricing_order.status == 'approved' and not record.action %}
                                        <span class="badge bg-info">自动审批</span>
                                    {% else %}
                                        <span class="badge bg-secondary">待审批</span>
                                    {% endif %}
                                </div>
                                
                                <p class="standard-font mb-1">审批人: {{ record.approver.real_name or record.approver.username if record.approver else '未指定' }}</p>
                                
                                {% if record.approved_at %}
                                    <p class="text-muted standard-font mb-1">审批时间: {{ record.formatted_approved_at }}</p>
                                    
                                    {% if record.is_fast_approval %}
                                        <div class="mt-2 p-2 bg-success border border-success rounded">
                                            <i class="fas fa-bolt text-white me-2"></i>
                                            <span class="standard-font text-white">{{ record.fast_approval_reason }}</span>
                                        </div>
                                    {% endif %}
                                    
                                    {% if record.comment %}
                                        <div class="mt-2 p-2 bg-light rounded">
                                            <i class="fas fa-comment text-muted me-2"></i><span class="standard-font">{{ record.comment }}</span>
                                        </div>
                                    {% endif %}
                                {% endif %}
                            </div>
                        </div>
                    {% endfor %}
                    
                    <!-- 最终结果 - 只有在流程真正结束时才显示 -->
                    {% if pricing_order.status in ['approved', 'rejected'] %}
                    <div class="timeline-item">
                        <div class="timeline-marker 
                            {% if pricing_order.status == 'approved' %}
                                bg-success
                            {% elif pricing_order.status == 'rejected' %}
                                bg-danger
                            {% endif %}
                        "></div>
                        <div class="timeline-content">
                            <h6 class="timeline-title">流程结束</h6>
                            <p class="standard-font">
                                {% if pricing_order.status == 'approved' %}
                                    <span class="text-success"><i class="fas fa-check-circle me-1"></i>审批已通过</span>
                                {% elif pricing_order.status == 'rejected' %}
                                    <span class="text-danger"><i class="fas fa-times-circle me-1"></i>审批已拒绝</span>
                                {% endif %}
                            </p>
                            {% if pricing_order.approved_at %}
                                <p class="text-muted standard-font">完成时间: {{ pricing_order.approved_at.strftime('%Y-%m-%d %H:%M') }}</p>
                            {% endif %}
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endif %}
            
            <!-- 当前审批人操作区 -->
            {% if current_approval_record and pricing_order.status == 'pending' %}
            <div class="mt-4 p-3 border rounded bg-light">
                <div class="alert alert-primary mb-3">
                    <h6><i class="fas fa-bell me-2"></i>您有待审批的批价单</h6>
                    <p class="mb-0">当前步骤：{{ current_approval_record.step_name }}</p>
                    {% if can_edit_pricing or can_edit_settlement %}
                    <p class="mb-0 text-info"><i class="fas fa-edit me-1"></i>您可以在审批过程中编辑产品明细和折扣率</p>
                    {% endif %}
                </div>
                
                <form id="approvalForm">
                    <div class="mb-3">
                        <label for="approvalComment" class="form-label">审批意见</label>
                        <textarea class="form-control" id="approvalComment" rows="3" 
                                  placeholder="请输入审批意见..."></textarea>
                    </div>
                    <div class="d-flex gap-2">
                        {{ render_button('通过', type='button', color='success', icon='fas fa-check', attrs='onclick="openApprovalModal(\'approve\')"') }}
                        {{ render_button('拒绝', type='button', color='danger', icon='fas fa-times', attrs='onclick="openApprovalModal(\'reject\')"') }}
                    </div>
                </form>
            </div>
            {% endif %}

            <!-- 操作按钮区域 -->
            {% if pricing_order.created_by == current_user.id %}
                {% if pricing_order.status == 'draft' %}
                <!-- 草稿状态：显示保存和提交按钮 -->
                <div class="submit-approval-section">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i>
                        批价单编辑完成后，请点击"保存批价单"保存修改，或直接"提交审批"进入审批流程。
                    </div>
                    <div class="action-buttons">
                        {{ render_button('保存批价单', type='button', color='primary', icon='fas fa-save', attrs='id="savePricingOrderBtn"') }}
                        {{ render_button('提交审批', type='button', color='info', icon='fas fa-paper-plane', attrs='id="submitApprovalBtn"') }}
                    </div>
                </div>
                {% elif pricing_order.status == 'pending' %}
                <!-- 审批中状态：显示召回按钮 -->
                <div class="submit-approval-section">
                    <div class="alert alert-warning">
                        <i class="fas fa-clock"></i>
                        批价单正在审批中，您可以召回进行修改。
                    </div>
                    <div class="action-buttons">
                        {{ render_button('召回批价单', type='button', color='warning', icon='fas fa-undo', attrs='id="recallPricingOrderBtn" data-bs-toggle="modal" data-bs-target="#recallPricingOrderModal"') }}
                    </div>
                </div>
                {% elif pricing_order.status == 'rejected' %}
                <!-- 被拒绝状态：显示重新发起审批按钮 -->
                <div class="submit-approval-section">
                    <div class="alert alert-danger">
                        <i class="fas fa-times-circle"></i>
                        批价单审批已被拒绝，您可以修改后重新发起审批。
                    </div>
                    <div class="action-buttons">
                        {{ render_button('保存批价单', type='button', color='primary', icon='fas fa-save', attrs='id="savePricingOrderBtn"') }}
                        {{ render_button('重新发起审批', type='button', color='info', icon='fas fa-redo', attrs='id="resubmitApprovalBtn"') }}
                    </div>
                </div>
                {% endif %}
            {% endif %}
            

            
            <!-- 管理员退回按钮 - 只有管理员或CEO可以看到，且仅限于已通过的批价单 -->
            {% if is_admin_or_ceo and pricing_order.status == 'approved' %}
            <div class="submit-approval-section">
                <div class="alert alert-secondary">
                    <i class="fas fa-shield-alt me-2"></i>
                    <strong>管理员操作区域</strong>
                    <br>当前批价单已通过审批，您可以将其退回到草稿状态重新审批。
                </div>
                <div class="action-buttons">
                    {{ render_button('退回审批', type='button', color='warning', icon='fas fa-undo', attrs='onclick="showAdminRollbackModal()"') }}
                    <small class="text-muted ms-2">管理员权限：将已通过的批价单退回到草稿状态（清除所有审批记录）</small>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>



<!-- 召回确认模态框 -->
<div class="modal fade" id="recallPricingOrderModal" tabindex="-1" aria-labelledby="recallPricingOrderModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="recallPricingOrderModalLabel">确认召回批价单</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p class="text-warning">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    您确定要召回此批价单吗？召回后审批流程将被终止，需要重新提交审批。
                </p>
                <div class="mb-3">
                    <label for="recallReason" class="form-label">召回原因（可选）</label>
                    <textarea class="form-control" id="recallReason" rows="3" placeholder="请输入召回原因..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                {{ render_button('取消', type='button', color='secondary', attrs='data-bs-dismiss="modal"') }}
                {{ render_button('确认召回', type='button', color='warning', icon='fas fa-undo', attrs='onclick="confirmRecallPricingOrder()"') }}
            </div>
        </div>
    </div>
</div>

<!-- 删除确认模态框 -->
<div class="modal fade" id="deletePricingOrderModal" tabindex="-1" aria-labelledby="deletePricingOrderModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deletePricingOrderModalLabel">确认删除批价单</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p class="text-danger">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    您确定要删除此批价单吗？删除后将无法恢复，请谨慎操作。
                </p>
                <div class="alert alert-warning">
                    <strong>注意：</strong>只有草稿状态且未发起审批的批价单才能删除。
                </div>
                <div class="mb-3">
                    <label for="deleteReason" class="form-label">删除原因（可选）</label>
                    <textarea class="form-control" id="deleteReason" rows="3" placeholder="请输入删除原因..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                {{ render_button('取消', type='button', color='secondary', attrs='data-bs-dismiss="modal"') }}
                {{ render_button('确认删除', type='button', color='danger', icon='fas fa-trash', attrs='onclick="confirmDeletePricingOrder()"') }}
            </div>
        </div>
    </div>
</div>

<!-- 管理员退回确认模态框 -->
{% if is_admin_or_ceo and pricing_order.status == 'approved' %}
<div class="modal fade" id="adminRollbackModal" tabindex="-1" aria-labelledby="adminRollbackModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="adminRollbackModalLabel">
                    <i class="fas fa-exclamation-triangle text-warning me-2"></i>
                    确认退回批价单审批
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-warning">
                    <i class="fas fa-shield-alt me-2"></i>
                    <strong>管理员操作</strong>：您即将将已通过的批价单审批退回到草稿状态
                </div>
                <p>确定要退回批价单 <strong>{{ pricing_order.order_number }}</strong> 的审批吗？</p>
                <p class="text-danger">
                    <i class="fas fa-exclamation-circle me-1"></i>
                    <strong>注意：</strong>此操作将：
                </p>
                <ul class="text-danger">
                    <li>将批价单状态重置为草稿</li>
                    <li>清除所有审批记录（不留痕迹）</li>
                    <li>解锁相关的项目和报价单</li>
                    <li>需要重新提交审批</li>
                </ul>
                
                <div class="mb-3">
                    <label for="adminRollbackReason" class="form-label">退回原因（可选）：</label>
                    <textarea class="form-control" id="adminRollbackReason" rows="3" placeholder="请说明退回原因..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                {{ render_button('取消', type='button', color='secondary', attrs='data-bs-dismiss="modal"') }}
                {{ render_button('确认退回', type='button', color='warning', icon='fas fa-undo', attrs='id="confirmAdminRollbackBtn" onclick="confirmAdminRollback()"') }}
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- 审批确认模态框 -->
<div class="modal fade" id="approvalModal" tabindex="-1" aria-labelledby="approvalModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="approvalModalLabel">审批确认</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="approvalActionDisplay" class="alert mb-3">
                    <!-- 动态内容 -->
                </div>
                <div class="mb-3">
                    <label for="modalApprovalComment" class="form-label">审批意见</label>
                    <textarea class="form-control" id="modalApprovalComment" rows="3" placeholder="请输入您的审批意见..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                {{ render_button('取消', type='button', color='secondary', attrs='data-bs-dismiss="modal"') }}
                {{ render_button('确认', type='button', color='primary', attrs='id="confirmApprovalBtn" onclick="confirmApproval()"') }}
            </div>
        </div>
    </div>
</div>

<!-- 样式 -->
<style>

/* 表格容器样式 */
.table-container {
    position: relative;
    margin-right: 60px; /* 为固定的操作列留出空间 */
}

.table-responsive {
    overflow-x: auto;
    margin-right: -60px; /* 补偿容器的margin-right */
}

/* 表格基础样式 */
.table {
    margin-bottom: 0;
    font-size: 0.875rem;
}

.table th,
.table td {
    white-space: nowrap;
    vertical-align: middle;
    padding: 0.4rem 0.5rem;
}

/* 操作列样式 - 取消固定，允许和其他列一起滚动 */
.action-column,
.table td:last-child {
    width: 60px;
    min-width: 60px;
    text-align: center;
    border-left: 1px solid #dee2e6;
}

.action-column {
    background-color: #f8f9fa;
}

/* MN列样式，确保有足够的宽度 */
.mn-column {
    min-width: 130px;
    max-width: 160px;
}

/* 输入框样式优化 */
.form-control {
    padding: 0.25rem 0.5rem;
    font-size: 0.875rem;
    min-height: 30px;
    height: calc(1.5em + 0.5rem + 2px);
}

/* 数字输入框特殊样式 */
input[type="number"].form-control {
    text-align: right;
    font-family: 'Roboto Mono', monospace;
    letter-spacing: -0.2px;
}

/* 表头样式调整 */
.table thead th {
    background-color: #f8f9fa;
    border-bottom: 2px solid #dee2e6;
    font-weight: 600;
    position: sticky;
    top: 0;
    z-index: 2;
}

/* 列宽度控制 */
.name-column {
    min-width: 180px;
    max-width: 220px;
}

.desc-column {
    min-width: 200px;
    max-width: 250px;
}

.price-column {
    min-width: 120px;
    max-width: 150px;
    text-align: right;
}

/* 产品名称输入框容器 */
.product-name-container {
    position: relative;
}

.product-name-container .form-control {
    cursor: pointer;
}

.product-name-container .form-control:focus {
    border-color: #007bff;
    box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
}

/* 产品型号容器 */
.product-model-container {
    position: relative;
}

/* 折扣率输入框组 */
.discount-rate-container {
    position: relative;
}

.discount-rate-container .form-control {
    padding-right: 20px;
}

.discount-rate-container::after {
    content: '%';
    position: absolute;
    right: 8px;
    top: 50%;
    transform: translateY(-50%);
    pointer-events: none;
    color: #6c757d;
    font-size: 0.875rem;
}

/* 悬停效果 */
.table-hover tbody tr:hover {
    background-color: rgba(0, 123, 255, 0.075);
}

/* 焦点状态 */
.form-control:focus {
    border-color: #80bdff;
    outline: 0;
    box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
}

/* 只读输入框样式 */
.form-control[readonly] {
    background-color: #f8f9fa;
    opacity: 1;
    color: #495057;
}

/* 删除按钮样式 */
.btn-sm {
    padding: 0.25rem 0.5rem;
    font-size: 0.75rem;
    line-height: 1.5;
    border-radius: 0.2rem;
}

/* 响应式调整 */
@media (max-width: 1200px) {
    .table-container {
        margin-right: 0;
    }
    
    .table-responsive {
        margin-right: 0;
    }
    
    .action-column,
    .table td:last-child {
        position: static;
        background-color: transparent;
    }
}



/* 移动端卡片风格样式 */
@media (max-width: 768px) {
    /* 隐藏桌面端表格，显示移动端卡片 */
    .table-responsive {
        display: none;
    }
    
    /* 移动端卡片容器 */
    .mobile-card-container {
        display: block;
    }
    
    /* 移动端产品卡片样式 */
    .mobile-product-card {
        background: #fff;
        border: 1px solid #e9ecef;
        border-radius: 8px;
        margin-bottom: 1rem;
        padding: 1rem;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        transition: box-shadow 0.2s ease;
    }
    
    .mobile-product-card:hover {
        box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    }
    
    /* 卡片头部 */
    .mobile-card-header {
        display: flex;
        justify-content: between;
        align-items: flex-start;
        margin-bottom: 0.75rem;
        padding-bottom: 0.5rem;
        border-bottom: 1px solid #e9ecef;
    }
    
    .mobile-card-title {
        font-weight: 600;
        font-size: 0.95rem;
        color: #333;
        margin: 0;
        flex: 1;
        line-height: 1.3;
    }
    
    .mobile-card-actions {
        margin-left: 0.5rem;
    }
    
    /* 卡片内容区域 */
    .mobile-card-body {
        font-size: 0.85rem;
    }
    
    .mobile-card-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.5rem;
        min-height: 32px;
    }
    
    .mobile-card-row:last-child {
        margin-bottom: 0;
    }
    
    .mobile-card-label {
        font-weight: 500;
        color: #666;
        width: 80px;
        flex-shrink: 0;
    }
    
    .mobile-card-value {
        flex: 1;
        text-align: right;
    }
    
    .mobile-card-input {
        width: 100%;
        max-width: 120px;
        font-size: 0.85rem;
        padding: 0.25rem 0.5rem;
        border: 1px solid #ddd;
        border-radius: 4px;
    }
    
    .mobile-card-input:focus {
        border-color: #16a0bf;
        box-shadow: 0 0 0 2px rgba(22, 160, 191, 0.2);
        outline: none;
    }
    
    .mobile-card-input[readonly] {
        background-color: #f8f9fa;
        color: #6c757d;
    }
    
    /* 价格突出显示 */
    .mobile-price-highlight {
        font-weight: 600;
        color: #16a0bf;
        font-size: 0.9rem;
    }
    
    .mobile-subtotal-highlight {
        font-weight: 700;
        color: #28a745;
        font-size: 1rem;
    }
    
    /* 徽章样式 */
    .mobile-badge {
        display: inline-block;
        padding: 0.25rem 0.5rem;
        font-size: 0.75rem;
        font-weight: 500;
        line-height: 1;
        text-align: center;
        white-space: nowrap;
        vertical-align: baseline;
        border-radius: 0.375rem;
        background-color: #6c757d;
        color: #fff;
    }
    
    .mobile-badge.badge-brand {
        background-color: #17a2b8;
    }
    
    /* 删除按钮 */
    .mobile-delete-btn {
        background: #dc3545;
        color: white;
        border: none;
        border-radius: 50%;
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.75rem;
    }
    
    /* 展开/收起按钮 */
    .mobile-expand-btn {
        background: transparent;
        border: none;
        color: #16a0bf;
        font-size: 0.8rem;
        padding: 0.25rem 0.5rem;
        margin-top: 0.5rem;
        width: 100%;
        text-align: center;
    }
    
    /* 隐藏的详细信息 */
    .mobile-card-details {
        margin-top: 0.75rem;
        padding-top: 0.75rem;
        border-top: 1px solid #e9ecef;
        display: none;
    }
    
    .mobile-card-details.show {
        display: block;
    }
    
    /* 页面布局调整 */
    .container-fluid {
        padding-left: 0.5rem;
        padding-right: 0.5rem;
    }
    
    .card {
        border-radius: 8px;
        margin-bottom: 1rem;
    }
    
    .card-header {
        padding: 0.75rem 1rem;
        font-size: 0.9rem;
    }
    
    .card-body {
        padding: 1rem;
    }
    
    /* 页签样式优化 */
    
    /* 移动端输入框优化 */
    .mobile-card-input:read-only {
        background-color: #f8f9fa;
        border-color: #e9ecef;
    }
    
    /* 移动端数字输入框去掉spinner */
    .mobile-card-input[type="number"] {
        -webkit-appearance: none;
        -moz-appearance: textfield;
    }
    
    .mobile-card-input[type="number"]::-webkit-outer-spin-button,
    .mobile-card-input[type="number"]::-webkit-inner-spin-button {
        -webkit-appearance: none;
        margin: 0;
    }
    
    /* 移动端锁定图标样式 */
    .mobile-lock-icon {
        font-size: 14px;
        color: #6c757d;
        margin-left: 0.5rem;
    }
    .nav-tabs .nav-link {
        font-size: 0.85rem;
        padding: 0.5rem 0.75rem;
    }
    
    /* 总额显示卡片 */
    .bg-light {
        border-radius: 8px;
    }
    
    /* 响应式表单控件 */
    .form-control {
        font-size: 0.85rem;
        padding: 0.5rem 0.75rem;
    }
    
    .form-select {
        font-size: 0.85rem;
        padding: 0.5rem 0.75rem;
    }
    

    
    /* 隐藏number输入框的滚动按键 */
    .mobile-card-input[type="number"]::-webkit-outer-spin-button,
    .mobile-card-input[type="number"]::-webkit-inner-spin-button {
        -webkit-appearance: none;
        margin: 0;
    }
    
    .mobile-card-input[type="number"] {
        -moz-appearance: textfield;
    }
    
    /* 隐藏总折扣率输入框的滚动按键 */
    #pricingTotalDiscount::-webkit-outer-spin-button,
    #pricingTotalDiscount::-webkit-inner-spin-button,
    #settlementTotalDiscount::-webkit-outer-spin-button,
    #settlementTotalDiscount::-webkit-inner-spin-button {
        -webkit-appearance: none;
        margin: 0;
    }
    
    #pricingTotalDiscount,
    #settlementTotalDiscount {
        -moz-appearance: textfield;
    }
}

/* 大屏幕时隐藏移动端卡片 */
@media (min-width: 769px) {
    .mobile-card-container {
        display: none;
    }
}

/* 自定义滚动条样式 */
.table-responsive::-webkit-scrollbar {
    height: 8px;
}

.table-responsive::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 10px;
}

.table-responsive::-webkit-scrollbar-thumb {
    background: #c1c1c1;
    border-radius: 10px;
}

.table-responsive::-webkit-scrollbar-thumb:hover {
    background: #a8a8a8;
}

/* 加载状态 */
.loading-spinner {
    display: inline-block;
    width: 16px;
    height: 16px;
    border: 2px solid #f3f3f3;
    border-top: 2px solid #007bff;
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* 错误状态 */
.has-error .form-control {
    border-color: #dc3545;
    box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25);
}

/* 成功状态 */
.has-success .form-control {
    border-color: #28a745;
    box-shadow: 0 0 0 0.2rem rgba(40, 167, 69, 0.25);
}

/* 隐藏批价单编辑界面产品明细中数量字段和折扣率字段的上下滚动按键 */
input[type="number"].quantity::-webkit-outer-spin-button,
input[type="number"].quantity::-webkit-inner-spin-button,
input[type="number"].discount-rate::-webkit-outer-spin-button,
input[type="number"].discount-rate::-webkit-inner-spin-button {
    -webkit-appearance: none;
    margin: 0;
}

input[type="number"].quantity,
input[type="number"].discount-rate {
    -moz-appearance: textfield;
}

/* Toggle Switch 样式 - 与项目列表页保持一致 */
.toggle-switch {
  position: relative;
  display: inline-block;
  width: 60px;
  height: 30px;
}
.toggle-switch input {
  opacity: 0;
  width: 0;
  height: 0;
}
.toggle-slider {
  position: absolute;
  background-color: #000;
  transition: .4s;
  border-radius: 34px;
  width: 100%;
  height: 100%;
  cursor: pointer;
}
.toggle-slider::before {
  position: absolute;
  content: "OFF";
  color: white;
  font-size: 12px;
  right: 8px;
  top: 50%;
  transform: translateY(-50%);
  transition: .4s;
}
.toggle-slider::after {
  content: "";
  position: absolute;
  height: 22px;
  width: 22px;
  left: 4px;
  bottom: 4px;
  background-color: white;
  border-radius: 50%;
  transition: .4s;
}
.toggle-switch input:checked + .toggle-slider::after {
  transform: translateX(30px);
}
.toggle-switch input:checked + .toggle-slider::before {
  content: "ON";
  left: 8px;
}

/* 禁用状态样式 */
.toggle-switch input:disabled + .toggle-slider {
  background-color: #ccc;
  cursor: not-allowed;
  opacity: 0.6;
}
.toggle-switch input:disabled + .toggle-slider::before {
  color: #999;
}
.toggle-switch input:disabled + .toggle-slider::after {
  background-color: #f5f5f5;
}

/* 悬停效果 */
.toggle-slider:hover {
  box-shadow: 0 0 8px rgba(0,0,0,0.3);
}
.toggle-switch input:disabled + .toggle-slider:hover {
  box-shadow: none;
}
</style>

{% endblock %}

{% block scripts %}
<script>
// 设置全局变量
const PRICING_ORDER_ID = "{{ pricing_order.id }}";
const PRICING_ORDER_STATUS = "{{ pricing_order.status }}";

// 更新基本信息（前端缓存）
function updateBasicInfo(field, value) {
    console.log('更新基本信息（前端缓存）:', field, value);
    
    // 记录到前端缓存，不立即保存到数据库
    if (!window.pricingOrderCache) {
        window.pricingOrderCache = {};
    }
    
    window.pricingOrderCache[field] = value;
    console.log('当前缓存:', window.pricingOrderCache);
}

// 厂商直签开关点击处理
function toggleDirectContractSwitch() {
    const directContractSwitch = document.getElementById('directContractSwitch');
    
    // 如果开关被禁用，不执行任何操作
    if (directContractSwitch.disabled) {
        return;
    }
    
    // 切换开关状态
    directContractSwitch.checked = !directContractSwitch.checked;
    
    // 调用原有的处理逻辑
    toggleDirectContract();
}

// 厂商直签开关处理
function toggleDirectContract() {
    const directContractSwitch = document.getElementById('directContractSwitch');
    const factoryPickupSwitch = document.getElementById('factoryPickupSwitch');
    
    // 获取SearchableSelect实例
    const dealerSelect = window.searchableSelects?.dealer_id;
    const distributorSelect = window.searchableSelects?.distributor_id;
    
    console.log('厂商直签开关状态:', directContractSwitch.checked);
    console.log('SearchableSelect实例:', {dealerSelect, distributorSelect});
    
    if (directContractSwitch.checked) {
        // 厂商直签开启：禁用经销商和分销商选择，清空内容
        if (dealerSelect) {
            dealerSelect.disable();
            dealerSelect.clear(true); // 抑制change事件
        }
        if (distributorSelect) {
            distributorSelect.disable();
            distributorSelect.clear(true); // 抑制change事件
        }
        
        // 同时禁用厂家提货开关
        factoryPickupSwitch.disabled = true;
        factoryPickupSwitch.checked = false;
        
        // 更新缓存
        updateBasicInfo('dealer_id', '');
        updateBasicInfo('distributor_id', '');
        updateBasicInfo('is_direct_contract', true);
        updateBasicInfo('is_factory_pickup', false);
    } else {
        // 厂商直签关闭：启用经销商和分销商选择
        if (dealerSelect) {
            dealerSelect.enable();
            dealerSelect.clear(true); // 抑制change事件，避免触发updateSwitchesBasedOnDealer
        }
        if (distributorSelect) {
            distributorSelect.enable(); // 明确启用分销商输入框
            distributorSelect.clear(true); // 抑制change事件
        }
        
        // 启用厂家提货开关
        factoryPickupSwitch.disabled = false;
        
        updateBasicInfo('dealer_id', '');
        updateBasicInfo('distributor_id', '');
        updateBasicInfo('is_direct_contract', false);
        
        console.log('厂商直签关闭：已启用经销商和分销商输入框，启用厂家提货开关');
    }
}

// 厂家提货开关点击处理
function toggleFactoryPickupSwitch() {
    const factoryPickupSwitch = document.getElementById('factoryPickupSwitch');
    
    // 如果开关被禁用，不执行任何操作
    if (factoryPickupSwitch.disabled) {
        return;
    }
    
    // 切换开关状态
    factoryPickupSwitch.checked = !factoryPickupSwitch.checked;
    
    // 调用原有的处理逻辑
    toggleFactoryPickup();
}

// 厂家提货开关处理
function toggleFactoryPickup() {
    const factoryPickupSwitch = document.getElementById('factoryPickupSwitch');
    
    // 获取SearchableSelect实例
    const distributorSelect = window.searchableSelects?.distributor_id;
    
    console.log('厂家提货开关状态:', factoryPickupSwitch.checked);
    console.log('DistributorSelect实例:', distributorSelect);
    
    if (factoryPickupSwitch.checked) {
        // 厂家提货开启：禁用分销商选择，清空内容
        if (distributorSelect) {
            distributorSelect.disable();
            distributorSelect.clear(true); // 抑制change事件
        }
        
        updateBasicInfo('distributor_id', '');
        updateBasicInfo('is_factory_pickup', true);
    } else {
        // 厂家提货关闭：启用分销商选择
        if (distributorSelect) {
            distributorSelect.enable();
        }
        
        updateBasicInfo('is_factory_pickup', false);
    }
}

// 经销商选择变化时的处理
function onDealerChange() {
    const dealerSelect = window.searchableSelects?.dealer_id;
    
    if (dealerSelect) {
        // 更新缓存
        updateBasicInfo('dealer_id', dealerSelect.hiddenInput.value);
        
        // 检查是否在厂商直签模式
        const directContractSwitch = document.getElementById('directContractSwitch');
        if (!directContractSwitch.checked) {
            // 非厂商直签模式下，根据经销商选择状态更新开关
            updateSwitchesBasedOnDealer();
        }
    }
}

// 分销商选择变化时的处理
function onDistributorChange() {
    const distributorSelect = window.searchableSelects?.distributor_id;
    
    if (distributorSelect) {
        // 更新缓存
        updateBasicInfo('distributor_id', distributorSelect.hiddenInput.value);
        
        // 更新厂家提货开关状态
        updateFactoryPickupSwitchState();
    }
}

// 页面加载时初始化开关状态
function initializeSwitches() {
    const directContractSwitch = document.getElementById('directContractSwitch');
    const factoryPickupSwitch = document.getElementById('factoryPickupSwitch');
    
    // 等待SearchableSelect实例初始化完成
    setTimeout(() => {
        console.log('初始化开关状态...');
        
        // 初始化厂商直签状态
        if (directContractSwitch.checked) {
            toggleDirectContract();
        }
        
        // 根据经销商输入框内容控制开关状态
        updateSwitchesBasedOnDealer();
        
        // 初始化厂家提货状态
        if (factoryPickupSwitch.checked) {
            toggleFactoryPickup();
        }
    }, 1000); // 延迟1秒确保SearchableSelect实例已创建
}

// 根据经销商输入框内容更新开关状态
function updateSwitchesBasedOnDealer() {
    const dealerSelect = window.searchableSelects?.dealer_id;
    const distributorSelect = window.searchableSelects?.distributor_id;
    const factoryPickupSwitch = document.getElementById('factoryPickupSwitch');
    const directContractSwitch = document.getElementById('directContractSwitch');
    
    const hasDealer = dealerSelect && dealerSelect.hiddenInput.value && dealerSelect.hiddenInput.value.trim() !== '';
    const isDirectContract = directContractSwitch.checked;
    
    console.log('经销商选择状态:', hasDealer, '经销商值:', dealerSelect?.hiddenInput.value, '厂商直签:', isDirectContract);
    
    // 如果是厂商直签模式，不执行任何操作
    if (isDirectContract) {
        console.log('厂商直签模式下，跳过经销商状态更新');
        return;
    }
    
    if (!hasDealer) {
        // 没有经销商时：厂家提货开关应该被禁用
        factoryPickupSwitch.disabled = true;
        factoryPickupSwitch.checked = false;
        
        // 分销商输入框在非直签模式下保持启用
        if (distributorSelect) {
            distributorSelect.enable();
        }
        
        // 更新缓存
        updateBasicInfo('is_factory_pickup', false);
    } else {
        // 有经销商时：启用分销商选择框和厂家提货开关
        if (distributorSelect) {
            distributorSelect.enable();
        }
        // 厂家提货开关根据分销商内容决定是否启用
        updateFactoryPickupSwitchState();
    }
}

// 更新厂家提货开关状态
function updateFactoryPickupSwitchState() {
    const distributorSelect = window.searchableSelects?.distributor_id;
    const factoryPickupSwitch = document.getElementById('factoryPickupSwitch');
    const dealerSelect = window.searchableSelects?.dealer_id;
    
    const hasDealer = dealerSelect && dealerSelect.hiddenInput.value && dealerSelect.hiddenInput.value.trim() !== '';
    const hasDistributor = distributorSelect && distributorSelect.hiddenInput.value && distributorSelect.hiddenInput.value.trim() !== '';
    
    if (hasDealer) {
        // 有经销商时，厂家提货开关可以启用
        factoryPickupSwitch.disabled = false;
    } else {
        // 没有经销商时，禁用厂家提货开关
        factoryPickupSwitch.disabled = true;
        factoryPickupSwitch.checked = false;
        updateBasicInfo('is_factory_pickup', false);
    }
}

// 验证渠道信息
function validateChannelInfo() {
    const directContractSwitch = document.getElementById('directContractSwitch');
    const factoryPickupSwitch = document.getElementById('factoryPickupSwitch');
    const dealerSelect = window.searchableSelects?.dealer_id;
    const distributorSelect = window.searchableSelects?.distributor_id;
    
    const isDirectContract = directContractSwitch.checked;
    const isFactoryPickup = factoryPickupSwitch.checked;
    const hasDealer = dealerSelect && dealerSelect.hiddenInput.value && dealerSelect.hiddenInput.value.trim() !== '';
    const hasDistributor = distributorSelect && distributorSelect.hiddenInput.value && distributorSelect.hiddenInput.value.trim() !== '';
    
    // 构建条件检查列表
    const conditions = [
        {
            text: '开启厂商直签',
            passed: isDirectContract
        },
        {
            text: '同时选择经销商和分销商',
            passed: hasDealer && hasDistributor
        },
        {
            text: '选择经销商并开启从厂家提货',
            passed: hasDealer && isFactoryPickup
        }
    ];
    
    // 检查是否有任何条件通过
    const isValid = conditions.some(condition => condition.passed);
    
    return {
        valid: isValid,
        conditions: conditions,
        message: isValid ? '渠道信息验证通过' : '提交条件不满足，请确保以下条件之一成立：'
    };
}

// 更新批价单明细
function updatePricingDetail(detailId, field, value) {
    const data = {
        detail_id: detailId
    };
    data[field] = parseFloat(value);
    
    fetch(`/pricing_order/${PRICING_ORDER_ID}/update_pricing_detail`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // 更新总额显示，不刷新页面
            $('#pricingTotalAmount').text('¥' + data.pricing_total_amount);
            if ($('#pricingTotalDiscount').length) {
                $('#pricingTotalDiscount').val(data.pricing_discount_percentage);
            }
            $('#settlementTotalAmount').text('¥' + data.settlement_total_amount);
            if ($('#settlementTotalDiscount').length) {
                $('#settlementTotalDiscount').val(data.settlement_discount_percentage);
            }
            
            // 更新当前行的单价和小计（避免刷新）
            updateRowDisplay(detailId, data);
            
            showAlert('success', '明细更新成功');
        } else {
            showAlert('error', data.message);
        }
    })
    .catch(error => {
        showAlert('error', '更新失败: ' + error.message);
    });
}

// 更新批价单明细单价（反算折扣率）
function updatePricingDetailUnitPrice(detailId, unitPrice) {
    const data = {
        detail_id: detailId,
        unit_price: parseFloat(unitPrice)
    };
    
    fetch(`/pricing_order/${PRICING_ORDER_ID}/update_pricing_detail`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // 更新总额显示
            $('#pricingTotalAmount').text('¥' + data.pricing_total_amount);
            if ($('#pricingTotalDiscount').length) {
                $('#pricingTotalDiscount').val(data.pricing_discount_percentage);
            }
            
            // 更新当前行的折扣率和小计
            updateRowDisplay(detailId, data);
            
            showAlert('success', '单价更新成功');
        } else {
            showAlert('error', data.message);
        }
    })
    .catch(error => {
        showAlert('error', '更新失败: ' + error.message);
    });
}

// 更新结算单明细
function updateSettlementDetail(detailId, field, value) {
    const data = {
        detail_id: detailId
    };
    data[field] = parseFloat(value);
    
    fetch(`/pricing_order/${PRICING_ORDER_ID}/update_settlement_detail`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // 更新总额显示，不刷新页面
            $('#settlementTotalAmount').text('¥' + data.settlement_total_amount);
            if ($('#settlementTotalDiscount').length) {
                $('#settlementTotalDiscount').val(data.settlement_discount_percentage);
            }
            
            // 更新当前行显示
            updateSettlementRowDisplay(detailId, data);
            
            showAlert('success', '结算单明细更新成功');
        } else {
            showAlert('error', data.message);
        }
    })
    .catch(error => {
        showAlert('error', '更新失败: ' + error.message);
    });
}

// 更新总折扣率（纯前端计算，联动所有明细）
function updateTotalDiscount(tabType, value) {
    console.log('更新总折扣率:', tabType, value);
    
    const discountRate = parseFloat(value) / 100; // 转换为小数
    const tableId = tabType === 'pricing' ? '#pricingTable' : '#settlementTable';
    
    // 更新表格中所有行的折扣率和价格
    $(`${tableId} tbody tr`).each(function() {
        const $row = $(this);
        const productName = $row.find('.product-name').val();
        
        // 只处理有产品名称的行
        if (productName && productName.trim()) {
            // 🔥 修复：获取市场价，支持从显示值解析
            const $marketPriceInput = $row.find('.product-price');
            let marketPrice = parseFloat($marketPriceInput.data('raw-value')) || 0;
            
            // 如果没有data-raw-value，尝试从显示值解析
            if (marketPrice === 0) {
                const displayPrice = $marketPriceInput.val() || $marketPriceInput.text();
                if (displayPrice) {
                    const cleanPrice = displayPrice.replace(/[^\d.]/g, '');
                    marketPrice = parseFloat(cleanPrice) || 0;
                    if (marketPrice > 0) {
                        $marketPriceInput.data('raw-value', marketPrice);
                    }
                }
            }
            
            // 🔥 修复：使用正确的数量获取方法，支持审批状态
            const quantity = getQuantityValue($row);
            
            console.log(`=== 行计算开始 ===`);
            console.log(`产品: ${productName}`);
            console.log(`市场价: ${marketPrice}`);
            console.log(`数量: ${quantity}`);
            console.log(`折扣率: ${discountRate * 100}%`);
            
            // 计算新的单价和小计
            const newUnitPrice = marketPrice * discountRate;
            const newSubtotal = newUnitPrice * quantity;
            
            console.log(`计算单价: ${marketPrice} × ${discountRate} = ${newUnitPrice}`);
            console.log(`计算小计: ${newUnitPrice} × ${quantity} = ${newSubtotal}`);
            
            // 更新折扣率显示（保留一位小数）
            $row.find('.discount-rate').val((discountRate * 100).toFixed(1));
            
            // 更新单价显示
            const formattedUnitPrice = formatNumber(newUnitPrice);
            $row.find('.discounted-price')
                .val(formattedUnitPrice)
                .data('raw-value', newUnitPrice);
            
            // 更新小计显示
            const formattedSubtotal = formatNumber(newSubtotal);
            $row.find('.subtotal')
                .val(formattedSubtotal)
                .data('raw-value', newSubtotal);
            
            console.log(`单价显示: ${formattedUnitPrice}`);
            console.log(`小计显示: ${formattedSubtotal}`);
            console.log(`=== 行计算结束 ===`);
            
            // 同步到移动端卡片
            const detailId = $row.data('detail-id');
            if (detailId) {
                const $mobileCard = $(`.mobile-product-card[data-detail-id="${detailId}"]`);
                if ($mobileCard.length) {
                    $mobileCard.find('.discount-rate').val((discountRate * 100).toFixed(1));
                    $mobileCard.find('.discounted-price')
                        .val(formattedUnitPrice)
                        .data('raw-value', newUnitPrice);
                    $mobileCard.find('.subtotal')
                        .val(formattedSubtotal)
                        .data('raw-value', newSubtotal);
                }
            }
        }
    });
    
    // 🔥 关键修复：只重新计算当前调整的表格，绝不影响其他表格
    if (tabType === 'pricing') {
        // 只重新计算批价单总金额
        updatePricingTableTotal();
    } else if (tabType === 'settlement') {
        // 只重新计算结算单总金额
        updateSettlementTableTotal();
    }
    
    // 更新分销利润和利润率
    updateDistributionProfit();
    
    // 🔥 关键修复：完全移除自动保存逻辑，只做前端计算，不自动保存到数据库
    console.log(`总折扣率 ${value}% 已在前端计算完成，不自动保存到数据库。需要手动保存或审批通过时保存。`);
    
    console.log(`总折扣率已更新为 ${value}%，所有明细已重新计算`);
    
    // 🔥 重要：在总折扣率更新后检查折扣权限
    const totalDiscountInputId = tabType === 'pricing' ? '#pricingTotalDiscount' : '#settlementTotalDiscount';
    const inputElement = document.querySelector(totalDiscountInputId);
    if (inputElement && typeof checkDiscountPermission === 'function') {
        console.log('正在检查总折扣率权限...');
        checkDiscountPermission(inputElement);
    } else {
        console.log('无法检查总折扣率权限: 元素或函数不存在');
    }
}

// 🔥 新增：只更新批价单表格总额
function updatePricingTableTotal() {
    try {
        console.log('更新批价单表格总额');
        
        let pricingTotal = 0;
        let pricingRowCount = 0;
        $('#pricingTable tbody tr').each(function() {
            const $row = $(this);
            const productName = $row.find('.product-name').val();
            
            // 只计算有产品名称的行
            if (productName && productName.trim()) {
                const subtotalValue = $row.find('.subtotal').data('raw-value');
                if (subtotalValue && !isNaN(subtotalValue)) {
                    pricingTotal += subtotalValue;
                    pricingRowCount++;
                } else {
                    // 如果没有data值，尝试从显示值解析
                    const displayValue = $row.find('.subtotal').val();
                    if (displayValue) {
                        const parsed = parseFloat(displayValue.replace(/[^\d.]/g, ''));
                        if (!isNaN(parsed)) {
                            pricingTotal += parsed;
                            pricingRowCount++;
                            // 保存解析出的原始值
                            $row.find('.subtotal').data('raw-value', parsed);
                        }
                    }
                }
            }
        });
        
        // 更新批价单总额显示
        $('#pricingTotalAmount').text('¥' + formatNumber(pricingTotal));
        console.log('批价单总额已更新:', pricingTotal, '有效行数:', pricingRowCount);
        
    } catch (e) {
        console.error('更新批价单表格总额时出错:', e);
    }
}

// 🔥 新增：只更新结算单表格总额
function updateSettlementTableTotal() {
    try {
        console.log('更新结算单表格总额');
        
        let settlementTotal = 0;
        let settlementRowCount = 0;
        $('#settlementTable tbody tr').each(function() {
            const $row = $(this);
            const productName = $row.find('.product-name').val();
            
            // 只计算有产品名称的行
            if (productName && productName.trim()) {
                const subtotalValue = $row.find('.subtotal').data('raw-value');
                if (subtotalValue && !isNaN(subtotalValue)) {
                    settlementTotal += subtotalValue;
                    settlementRowCount++;
                } else {
                    // 如果没有data值，尝试从显示值解析
                    const displayValue = $row.find('.subtotal').val();
                    if (displayValue) {
                        const parsed = parseFloat(displayValue.replace(/[^\d.]/g, ''));
                        if (!isNaN(parsed)) {
                            settlementTotal += parsed;
                            settlementRowCount++;
                            // 保存解析出的原始值
                            $row.find('.subtotal').data('raw-value', parsed);
                        }
                    }
                }
            }
        });
        
        // 更新结算单总额显示
        $('#settlementTotalAmount').text('¥' + formatNumber(settlementTotal));
        console.log('结算单总额已更新:', settlementTotal, '有效行数:', settlementRowCount);
        
    } catch (e) {
        console.error('更新结算单表格总额时出错:', e);
    }
}

// 计算并更新总折扣率（基于明细折扣率的加权平均）
function calculateAndUpdateTotalDiscountRate(tabType, shouldUpdateDisplay = true) {
    const tableId = tabType === 'pricing' ? '#pricingTable' : '#settlementTable';
    const totalDiscountInputId = tabType === 'pricing' ? '#pricingTotalDiscount' : '#settlementTotalDiscount';
    
    let totalMarketValue = 0;
    let totalDiscountedValue = 0;
    let validRowCount = 0;
    
    // 遍历所有行计算加权平均折扣率
    $(`${tableId} tbody tr`).each(function() {
        const $row = $(this);
        const productName = $row.find('.product-name').val();
        
        if (productName && productName.trim()) {
            const marketPrice = parseFloat($row.find('.product-price').data('raw-value')) || 0;
            const quantity = getQuantityValue($row); // 🔥 使用统一函数
            const discountRate = parseFloat($row.find('.discount-rate').val()) || 0;
            
            if (marketPrice > 0) {
                const rowMarketValue = marketPrice * quantity;
                const rowDiscountedValue = rowMarketValue * (discountRate / 100);
                
                totalMarketValue += rowMarketValue;
                totalDiscountedValue += rowDiscountedValue;
                validRowCount++;
            }
        }
    });
    
    // 计算加权平均折扣率
    let averageDiscountRate = 0;
    if (totalMarketValue > 0) {
        averageDiscountRate = (totalDiscountedValue / totalMarketValue) * 100;
    }
    
    // 只在需要更新显示时才更新（用户编辑时）
    if (shouldUpdateDisplay) {
        $(totalDiscountInputId).val(averageDiscountRate.toFixed(1));
        console.log(`${tabType}表格总折扣率已更新为: ${averageDiscountRate.toFixed(1)}% (基于${validRowCount}行数据)`);
        
        // 更新后检查总折扣率权限
        const totalDiscountInput = document.querySelector(totalDiscountInputId);
        if (totalDiscountInput && typeof checkDiscountPermission === 'function') {
            console.log(`正在检查${tabType}总折扣率权限...`);
            checkDiscountPermission(totalDiscountInput);
        } else {
            console.log(`无法检查${tabType}总折扣率权限: 元素或函数不存在`);
        }
    } else {
        console.log(`${tabType}表格总折扣率计算完成但未更新显示: ${averageDiscountRate.toFixed(1)}% (保持数据库值)`);
    }
    
    return averageDiscountRate;
}

// 根据明细数据更新表格行
function updateRowFromDetailData(detail, tabType) {
    const tableId = tabType === 'pricing' ? '#pricingTable' : '#settlementTable';
    const $row = $(`${tableId} tr[data-detail-id="${detail.id}"]`);
    
    if ($row.length > 0) {
        // 更新折扣率
        $row.find('.discount-rate').val((detail.discount_rate * 100).toFixed(1));
        
        // 更新单价
        const formattedUnitPrice = formatNumber(detail.unit_price);
        $row.find('.discounted-price')
            .val(formattedUnitPrice)
            .data('raw-value', detail.unit_price);
        
        // 更新小计
        const formattedTotalPrice = formatNumber(detail.total_price);
        $row.find('.subtotal')
            .val(formattedTotalPrice)
            .data('raw-value', detail.total_price);
        
        console.log(`已更新${tabType}表格行${detail.id}:`, {
            折扣率: detail.discount_rate * 100,
            单价: detail.unit_price,
            小计: detail.total_price
        });
    }
}

// 更新行显示（批价单）
function updateRowDisplay(detailId, responseData) {
    const row = $(`tr[data-detail-id="${detailId}"]`);
    if (row.length && responseData.updated_detail) {
        const detail = responseData.updated_detail;
        // 更新折扣率（保留一位小数）
        row.find('.discount-rate').val((detail.discount_rate * 100).toFixed(1));
        // 更新单价
        row.find('.discounted-price')
            .val(detail.unit_price.toFixed(2))
            .data('raw-value', detail.unit_price);
        // 更新小计
        row.find('.subtotal')
            .val(detail.total_price.toFixed(2))
            .data('raw-value', detail.total_price);
        
        // 同步到移动端卡片
        const mobileCard = $(`.mobile-product-card[data-detail-id="${detailId}"]`);
        if (mobileCard.length) {
            mobileCard.find('.discount-rate').val((detail.discount_rate * 100).toFixed(1));
            mobileCard.find('.discounted-price')
                .val(detail.unit_price.toFixed(2))
                .data('raw-value', detail.unit_price);
            mobileCard.find('.subtotal')
                .val(detail.total_price.toFixed(2))
                .data('raw-value', detail.total_price);
        }
    }
}

// 更新行显示（结算单）
function updateSettlementRowDisplay(detailId, responseData) {
    const row = $(`#settlementTable tr[data-detail-id="${detailId}"]`);
    if (row.length && responseData.updated_detail) {
        const detail = responseData.updated_detail;
        // 更新折扣率（保留一位小数）
        row.find('.discount-rate').val((detail.discount_rate * 100).toFixed(1));
        // 更新单价
        row.find('.discounted-price')
            .val(detail.unit_price.toFixed(2))
            .data('raw-value', detail.unit_price);
        // 更新小计
        row.find('.subtotal')
            .val(detail.total_price.toFixed(2))
            .data('raw-value', detail.total_price);
        
        // 同步到移动端卡片
        const mobileCard = $(`.mobile-product-card[data-detail-id="${detailId}"]`);
        if (mobileCard.length) {
            mobileCard.find('.discount-rate').val((detail.discount_rate * 100).toFixed(1));
            mobileCard.find('.discounted-price')
                .val(detail.unit_price.toFixed(2))
                .data('raw-value', detail.unit_price);
            mobileCard.find('.subtotal')
                .val(detail.total_price.toFixed(2))
                .data('raw-value', detail.total_price);
        }
    }
}

// 实时计算行的单价和小计（前端即时更新）
/*
function calculateRowValues(row, triggerType) {
    const marketPrice = parseFloat(row.find('td:nth-child(5)').text().replace(/[^\d.]/g, '')) || 0;
    let quantity = parseInt(row.find('.quantity').val()) || 1;
    
    let discountRate, unitPrice;
    
    if (triggerType === 'discount_rate') {
        // 从折扣率计算单价
        discountRate = parseFloat(row.find('.discount-rate').val()) / 100;
        unitPrice = marketPrice * discountRate;
        // 更新单价显示
        row.find('.discounted-price').val(unitPrice.toFixed(2));
    } else if (triggerType === 'unit_price') {
        // 从单价计算折扣率
        unitPrice = parseFloat(row.find('.discounted-price').val()) || 0;
        discountRate = marketPrice > 0 ? unitPrice / marketPrice : 1;
        // 更新折扣率显示
        row.find('.discount-rate').val((discountRate * 100).toFixed(2));
    } else if (triggerType === 'quantity') {
        // 数量变化，使用当前的单价重新计算小计
        unitPrice = parseFloat(row.find('.discounted-price').val()) || 0;
        // 如果单价为0，使用折扣率和市场价计算单价
        if (unitPrice === 0) {
            discountRate = parseFloat(row.find('.discount-rate').val()) / 100 || 1;
            unitPrice = marketPrice * discountRate;
            row.find('.discounted-price').val(unitPrice.toFixed(2));
        }
    }
    
    // 计算小计（数量 × 单价）
    const subtotal = unitPrice * quantity;
    
    // 更新小计显示 - 根据表格类型选择正确的列
    if (row.closest('#pricingTable').length > 0) {
        // 批价单表格：小计是第9列
        row.find('td:nth-child(9)').text('¥' + subtotal.toLocaleString('zh-CN', {minimumFractionDigits: 2}));
    } else if (row.closest('#settlementTable').length > 0) {
        // 结算单表格：小计是第8列
        row.find('td:nth-child(8)').text('¥' + subtotal.toLocaleString('zh-CN', {minimumFractionDigits: 2}));
    }
    
    // 重新计算总额（用户编辑时需要重新计算）
    updateTableTotals(true);
    
    // 添加调试信息
    console.log(`计算更新 - 类型: ${triggerType}, 数量: ${quantity}, 单价: ${unitPrice}, 小计: ${subtotal}`);
}
*/

// 初始化已有行的数据
function initializeExistingRows() {
    try {
        console.log('初始化已有行的数据');
        
        // 初始化批价单表格的已有行
        $('#pricingTable tbody tr').each(function() {
            var $row = $(this);
            var productName = $row.find('.product-name').val();
            
            if (productName && productName.trim()) {
                // 🔥 确保数量字段有正确的data-raw-value
                var $quantityInput = $row.find('.quantity');
                var quantityValue = parseInt($quantityInput.val()) || 1;
                $quantityInput.data('raw-value', quantityValue);

                // 确保市场价格有正确的data-raw-value
                var $priceInput = $row.find('.product-price');
                var priceValue = $priceInput.data('raw-value');
                if (!priceValue) {
                    var displayPrice = $priceInput.val().replace(/[^\d.]/g, '');
                    if (displayPrice) {
                        priceValue = parseFloat(displayPrice);
                        $priceInput.data('raw-value', priceValue);
                    }
                }
                
                // 确保单价有正确的data-raw-value
                var $unitPriceInput = $row.find('.discounted-price');
                var unitPriceValue = $unitPriceInput.data('raw-value');
                if (!unitPriceValue) {
                    var displayUnitPrice = $unitPriceInput.val().replace(/[^\d.]/g, '');
                    if (displayUnitPrice) {
                        unitPriceValue = parseFloat(displayUnitPrice);
                        $unitPriceInput.data('raw-value', unitPriceValue);
                    }
                }
                
                // 确保小计有正确的data-raw-value
                var $subtotalInput = $row.find('.subtotal');
                var subtotalValue = $subtotalInput.data('raw-value');
                if (!subtotalValue) {
                    var displaySubtotal = $subtotalInput.val().replace(/[^\d.]/g, '');
                    if (displaySubtotal) {
                        subtotalValue = parseFloat(displaySubtotal);
                        $subtotalInput.data('raw-value', subtotalValue);
                    }
                }
                
                console.log('已有行初始化:', {
                    产品: productName,
                    数量: quantityValue,
                    市场价: priceValue,
                    单价: unitPriceValue,
                    小计: subtotalValue
                });
            }
        });
        
        // 初始化结算单表格的已有行
        $('#settlementTable tbody tr').each(function() {
            var $row = $(this);
            var productName = $row.find('.product-name').val();
            
            if (productName && productName.trim()) {
                // 🔥 确保数量字段有正确的data-raw-value
                var $quantityInput = $row.find('.quantity');
                var quantityValue = parseInt($quantityInput.val()) || 1;
                $quantityInput.data('raw-value', quantityValue);

                // 确保市场价格有正确的data-raw-value
                var $priceInput = $row.find('.product-price');
                var priceValue = $priceInput.data('raw-value');
                if (!priceValue) {
                    var displayPrice = $priceInput.val().replace(/[^\d.]/g, '');
                    if (displayPrice) {
                        priceValue = parseFloat(displayPrice);
                        $priceInput.data('raw-value', priceValue);
                    }
                }
                
                // 确保单价有正确的data-raw-value
                var $unitPriceInput = $row.find('.discounted-price');
                var unitPriceValue = $unitPriceInput.data('raw-value');
                if (!unitPriceValue) {
                    var displayUnitPrice = $unitPriceInput.val().replace(/[^\d.]/g, '');
                    if (displayUnitPrice) {
                        unitPriceValue = parseFloat(displayUnitPrice);
                        $unitPriceInput.data('raw-value', unitPriceValue);
                    }
                }
                
                // 确保小计有正确的data-raw-value
                var $subtotalInput = $row.find('.subtotal');
                var subtotalValue = $subtotalInput.data('raw-value');
                if (!subtotalValue) {
                    var displaySubtotal = $subtotalInput.val().replace(/[^\d.]/g, '');
                    if (displaySubtotal) {
                        subtotalValue = parseFloat(displaySubtotal);
                        $subtotalInput.data('raw-value', subtotalValue);
                    }
                }
            }
        });
        
        console.log('已有行数据初始化完成');
    } catch (e) {
        console.error('初始化已有行数据时出错:', e);
    }
}

// 更新表格总额 (总价 = 所有行小计之和)
function updateTableTotals(forceRecalculate = false) {
    try {
        console.log('更新表格总额, 强制重新计算:', forceRecalculate);
        
        // 如果不是强制重新计算，则跳过（保持数据库中的值）
        if (!forceRecalculate) {
            console.log('跳过总金额重新计算，保持数据库中的值');
            // 仍然更新分销利润，因为它基于显示的总金额
            updateDistributionProfit();
            return;
        }
        
        // 计算批价单总额
        let pricingTotal = 0;
        let pricingRowCount = 0;
        $('#pricingTable tbody tr').each(function() {
            var $row = $(this);
            var productName = $row.find('.product-name').val();
            
            // 只计算有产品名称的行
            if (productName && productName.trim()) {
                var subtotalValue = $row.find('.subtotal').data('raw-value');
                if (subtotalValue && !isNaN(subtotalValue)) {
                    pricingTotal += subtotalValue;
                    pricingRowCount++;
                } else {
                    // 如果没有data值，尝试从显示值解析
                    var displayValue = $row.find('.subtotal').val();
                    if (displayValue) {
                        var parsed = parseFloat(displayValue.replace(/[^\d.]/g, ''));
                        if (!isNaN(parsed)) {
                            pricingTotal += parsed;
                            pricingRowCount++;
                            // 保存解析出的原始值
                            $row.find('.subtotal').data('raw-value', parsed);
                        }
                    }
                }
            }
        });
        
        // 更新批价单总额显示
        $('#pricingTotalAmount').text('¥' + formatNumber(pricingTotal));
        
        // 计算结算单总额（如果存在）
        if ($('#settlementTable tbody tr').length > 0) {
            let settlementTotal = 0;
            let settlementRowCount = 0;
            $('#settlementTable tbody tr').each(function() {
                var $row = $(this);
                var productName = $row.find('.product-name').val();
                
                // 只计算有产品名称的行
                if (productName && productName.trim()) {
                    var subtotalValue = $row.find('.subtotal').data('raw-value');
                    if (subtotalValue && !isNaN(subtotalValue)) {
                        settlementTotal += subtotalValue;
                        settlementRowCount++;
                    } else {
                        // 如果没有data值，尝试从显示值解析
                        var displayValue = $row.find('.subtotal').val();
                        if (displayValue) {
                            var parsed = parseFloat(displayValue.replace(/[^\d.]/g, ''));
                            if (!isNaN(parsed)) {
                                settlementTotal += parsed;
                                settlementRowCount++;
                                // 保存解析出的原始值
                                $row.find('.subtotal').data('raw-value', parsed);
                            }
                        }
                    }
                }
            });
            // 更新结算单总额显示
            $('#settlementTotalAmount').text('¥' + formatNumber(settlementTotal));
            console.log('结算单总额:', settlementTotal, '有效行数:', settlementRowCount);
        }
        
        console.log('批价单总额:', pricingTotal, '有效行数:', pricingRowCount);
        
        // 更新分销利润和利润率
        updateDistributionProfit();
    } catch (e) {
        console.error('更新表格总额时出错:', e);
    }
}

// 更新分销利润和利润率
function updateDistributionProfit() {
    try {
        // 获取批价单总额
        let pricingTotal = 0;
        const pricingTotalText = $('#pricingTotalAmount').text();
        if (pricingTotalText) {
            pricingTotal = parseFloat(pricingTotalText.replace(/[^\d.]/g, '')) || 0;
        }
        
        // 获取结算单总额
        let settlementTotal = 0;
        const settlementTotalText = $('#settlementTotalAmount').text();
        if (settlementTotalText) {
            settlementTotal = parseFloat(settlementTotalText.replace(/[^\d.]/g, '')) || 0;
        }
        
        // 计算分销利润 = 批价单总额 - 结算单总额
        const distributionProfit = pricingTotal - settlementTotal;
        
        // 计算利润率 = (批价单总额 - 结算单总额) / 批价单总额 * 100%
        let profitMargin = 0;
        if (pricingTotal > 0) {
            profitMargin = (distributionProfit / pricingTotal) * 100;
        }
        
        // 更新显示
        $('#distributionProfit').text('¥' + formatNumber(distributionProfit));
        $('#profitMargin').text(profitMargin.toFixed(2) + '%');
        
        console.log('分销利润计算:', {
            pricingTotal: pricingTotal,
            settlementTotal: settlementTotal,
            distributionProfit: distributionProfit,
            profitMargin: profitMargin.toFixed(2) + '%'
        });
        
    } catch (e) {
        console.error('更新分销利润时出错:', e);
        $('#distributionProfit').text('¥0.00');
        $('#profitMargin').text('0.00%');
    }
}

// 绑定输入事件监听器
$(document).ready(function() {
    // 批价单和结算单的实时计算事件
    $('#pricingTable, #settlementTable').on('input', '.discount-rate', function() {
        var $row = $(this).closest('tr');
        var marketPrice = parseFloat($row.find('.product-price').data('raw-value')) || 0;
        var discountRate = parseFloat($(this).val());
        
        // 增加详细的调试信息
        console.log('=== 折扣率变更调试 ===');
        console.log('市场价格字段:', $row.find('.product-price'));
        console.log('市场价格 data-raw-value:', $row.find('.product-price').data('raw-value'));
        console.log('市场价格显示值:', $row.find('.product-price').val());
        console.log('解析后的市场价格:', marketPrice);
        console.log('输入的折扣率:', discountRate);
        
        // 如果市场价格为0，尝试从显示值获取
        if (marketPrice === 0) {
            var displayPrice = $row.find('.product-price').val();
            if (displayPrice) {
                var cleanPrice = displayPrice.replace(/[^\d.]/g, '');
                marketPrice = parseFloat(cleanPrice) || 0;
                console.log('从显示值获取市场价格:', displayPrice, '清理后:', cleanPrice, '解析后:', marketPrice);
                
                // 更新data-raw-value
                if (marketPrice > 0) {
                    $row.find('.product-price').data('raw-value', marketPrice);
                    console.log('已更新市场价格 data-raw-value:', marketPrice);
                }
            }
        }
        
        // 验证折扣率输入
        if (isNaN(discountRate) || discountRate < 0) {
            discountRate = 0;
            $(this).val('0.0');
            console.log('折扣率无效，重置为0');
        }
        if (discountRate > 1000) {
            discountRate = 1000;
            $(this).val('1000.0');
            console.log('折扣率超过上限，重置为1000');
        }
        
        // 计算折扣后价格 (单价 = 市场价 * 折扣率%)
        var discountedPrice = marketPrice * (discountRate / 100);
        console.log('计算公式: ' + marketPrice + ' * (' + discountRate + ' / 100) = ' + discountedPrice);
        
        // 更新单价显示
        $row.find('.discounted-price')
            .data('raw-value', discountedPrice)
            .val(formatNumber(discountedPrice));
        
        console.log('单价已更新: data-raw-value=' + discountedPrice + ', 显示值=' + formatNumber(discountedPrice));
        
        // 重新计算小计和总价
        calculateSubtotal($row);
        
        // 🔥 修复：只更新当前表格的总金额，不影响其他表格
        const tabType = $row.closest('#pricingTable').length > 0 ? 'pricing' : 'settlement';
        if (tabType === 'pricing') {
            updatePricingTableTotal();
        } else if (tabType === 'settlement') {
            updateSettlementTableTotal();
        }
        
        // 根据明细折扣率重新计算总折扣率（用户编辑时才更新显示）
        calculateAndUpdateTotalDiscountRate(tabType, true);
        
        console.log('=== 折扣率变更调试结束 ===');
    });

    // 监听单价输入变化，更新折扣率
    $('#pricingTable, #settlementTable').on('input', '.discounted-price', function() {
        var $row = $(this).closest('tr');
        var rawValue = $(this).val().replace(/[^\d.]/g, '');
        
        if (rawValue) {
            // 处理可能的多个小数点
            let parts = rawValue.split('.');
            if (parts.length > 2) {
                rawValue = parts[0] + '.' + parts.slice(1).join('');
            }
            
            var discountedPrice = parseFloat(rawValue);
            if (!isNaN(discountedPrice) && discountedPrice >= 0) {
                // 保存原始值
                $(this).data('raw-value', discountedPrice);
                
                // 反算折扣率 (折扣率% = 单价 / 市场价 * 100)
                var marketPrice = parseFloat($row.find('.product-price').data('raw-value')) || 0;
                if (marketPrice > 0) {
                    var discountRate = (discountedPrice / marketPrice) * 100;
                    discountRate = Math.max(0, Math.min(1000, discountRate)); // 限制在0-1000%之间
                    $row.find('.discount-rate').val(discountRate.toFixed(1));
                    console.log('单价变化: 单价=', discountedPrice, '市场价=', marketPrice, '折扣率=', discountRate.toFixed(1) + '%');
                }
                
                // 重新计算小计和总价
                calculateSubtotal($row);
                
                // 🔥 修复：只更新当前表格的总金额，不影响其他表格
                const tabType = $row.closest('#pricingTable').length > 0 ? 'pricing' : 'settlement';
                if (tabType === 'pricing') {
                    updatePricingTableTotal();
                } else if (tabType === 'settlement') {
                    updateSettlementTableTotal();
                }
                
                // 根据明细折扣率重新计算总折扣率（用户编辑时才更新显示）
                calculateAndUpdateTotalDiscountRate(tabType, true);
            }
        }
    });

    // 单价失去焦点时格式化
    $('#pricingTable, #settlementTable').on('blur', '.discounted-price', function() {
        var $input = $(this);
        var rawValue = $input.data('raw-value');
        if (rawValue && !isNaN(rawValue)) {
            $input.val(formatNumber(rawValue));
        }
    });

    // 监听数量变更事件 (小计 = 数量 * 单价) - 🔥 优化同步逻辑
    $('#pricingTable, #settlementTable').on('input change', '.quantity', function() {
        var $row = $(this).closest('tr');
        var $input = $(this);
        var inputValue = $input.val().trim();
        var quantity = parseInt(inputValue, 10);
        // 只在明确无效时才回退为1
        if (isNaN(quantity) || quantity < 1) {
            quantity = 1;
        }
        // 始终同步data-raw-value
        $input.data('raw-value', quantity);
        $input.val(quantity); // 保证输入框显示的也是有效值
        // 重新计算小计和总价
        calculateSubtotal($row);
        // 🔥 修复：只更新当前表格的总金额，不影响其他表格
        const tabType = $row.closest('#pricingTable').length > 0 ? 'pricing' : 'settlement';
        if (tabType === 'pricing') {
            updatePricingTableTotal();
        } else if (tabType === 'settlement') {
            updateSettlementTableTotal();
        }
    });
    
    // 删除产品按钮事件
    $(document).on('click', '.remove-row', function() {
        const detailId = $(this).data('detail-id');
        if (detailId) {
        deleteProduct(detailId);
        } else {
            // 如果没有detailId，说明是新添加的行，直接删除
            if ($('#pricingTable tbody tr').length > 1 || $('#settlementTable tbody tr').length > 1) {
                $(this).closest('tr').remove();
                updateTableTotals(true); // 删除行后需要重新计算
            }
        }
    });
    


    // 保存和提交按钮事件
    $('#savePricingOrderBtn').on('click', function() {
        savePricingOrder();
    });

    $('#submitApprovalBtn').on('click', function() {
        submitForApproval();
    });
    
    // 绑定重新发起审批按钮
    $('#resubmitApprovalBtn').on('click', function() {
        resubmitForApproval();
    });

    // 页面加载时初始化已有行的数据
    initializeExistingRows();
    
    // 页面加载时计算一次总额
    updateTableTotals();

    // 初始化产品自动完成功能
    initializeProductAutocomplete();
    

    
    // 调试：显示绑定成功信息
    console.log('批价单事件绑定完成 - 使用改进的联动逻辑');

    // 绑定分销商和经销商选择事件（前端缓存）
    $('#distributorSelect').on('change', function() {
        const value = $(this).val();
        updateBasicInfo('distributor_id', value || null);
    });
    
    // 经销商选择
    $('#dealerSelect').on('change', function() {
        const value = $(this).val();
        updateBasicInfo('dealer_id', value || null);
    });
    
    // 初始化前端缓存
    window.pricingOrderCache = {};
    
    // 移动端数量输入框事件绑定 - 🔥 优化同步逻辑
    $(document).on('input change', '.mobile-card-input.quantity', function() {
        const $input = $(this);
        const $card = $input.closest('.mobile-product-card');
        const detailId = $card.data('detail-id');
        let inputValue = $input.val().trim();
        let quantity = parseInt(inputValue, 10);
        if (isNaN(quantity) || quantity < 1) {
            quantity = 1;
        }
        $input.data('raw-value', quantity);
        $input.val(quantity);
        // 同步到桌面端表格
        if (detailId) {
            const $desktopRow = $(`#pricingTable tr[data-detail-id="${detailId}"], #settlementTable tr[data-detail-id="${detailId}"]`);
            if ($desktopRow.length) {
                $desktopRow.find('.quantity').val(quantity).data('raw-value', quantity);
                calculateSubtotal($desktopRow);
            }
        }
        // 实时计算（前端计算，不调用数据库）
        calculateMobileRowValues($card, 'quantity');
        // 重新计算总折扣率
        const currentTab = $('.nav-tabs .nav-link.active').attr('id');
        const tabType = currentTab === 'pricing-tab' ? 'pricing' : 'settlement';
        calculateAndUpdateTotalDiscountRate(tabType);
    });
    
    // 移动端折扣率输入框事件绑定 - 使用PC端逻辑
    $(document).on('input change', '.mobile-card-input.discount-rate', function() {
        const $input = $(this);
        const $card = $input.closest('.mobile-product-card');
        const detailId = $card.data('detail-id');
        const newDiscountRate = parseFloat($input.val()) || 0;
        
        // 同步到桌面端表格
        if (detailId) {
            const $desktopRow = $(`#pricingTable tr[data-detail-id="${detailId}"], #settlementTable tr[data-detail-id="${detailId}"]`);
            if ($desktopRow.length) {
                $desktopRow.find('.discount-rate').val(newDiscountRate);
            }
        }
        
        // 实时计算（前端计算，不调用数据库）
        calculateMobileRowValues($card, 'discount_rate');
        
        // 重新计算总折扣率
        const currentTab = $('.nav-tabs .nav-link.active').attr('id');
        const tabType = currentTab === 'pricing-tab' ? 'pricing' : 'settlement';
        calculateAndUpdateTotalDiscountRate(tabType);
    });
});



// 初始化产品自动完成功能
function initializeProductAutocomplete() {
    // 移除所有现有菜单
    $('.product-menu-container').remove();
    
    // 添加必要的样式
    if (!$('#product-menu-styles').length) {
        $('head').append(`
            <style id="product-menu-styles">
                .product-menu-container {
                    position: absolute;
                    background: white;
                    border: 1px solid #ddd;
                    box-shadow: 0 2px 10px rgba(0,0,0,0.2);
                    z-index: 9999;
                    display: flex;
                }
                .menu-item {
                    font-size: 0.75rem;
                }
                .menu-item img {
                    flex-shrink: 0;
                    width: 40px;
                    height: 40px;
                    object-fit: contain;
                    margin-right: 10px;
                    border-radius: 4px;
                }
                .menu-item .text-wrap {
                    white-space: normal !important;
                    word-break: break-word;
                    flex: 1;
                }
                .menu-list {
                    border-right: 1px solid #eee;
                    max-height: 350px;
                    overflow-y: auto;
                }
                .category-list {
                    width: 180px;
                }
                .product-list {
                    width: 220px;
                    display: none;
                }
                .model-list {
                    width: 220px;
                    display: none;
                }
                .spec-list {
                    width: 240px;
                    display: none;
                }
                .menu-item {
                    padding: 8px 12px;
                    cursor: pointer;
                    border-bottom: 1px solid #f0f0f0;
                    position: relative;
                    white-space: nowrap;
                    overflow: hidden;
                    text-overflow: ellipsis;
                }
                .menu-item:after {
                    content: "▶";
                    position: absolute;
                    right: 10px;
                    font-size: 10px;
                    color: #999;
                }
                .menu-item:hover {
                    background-color: #f0f7ff;
                }
                .menu-item.active {
                    background-color: #e0f0ff;
                }
                .menu-item.no-arrow:after {
                    content: "";
                }
                .menu-loading {
                    padding: 8px 12px;
                    color: #888;
                    font-style: italic;
                }
            </style>
        `);
    }
    
    // 为产品名称输入框添加事件
    $('.product-name').each(function() {
        var $input = $(this);
        
        // 移除之前的事件和自动完成功能
        $input.off('click focus');
        if ($input.data('uiAutocomplete')) {
            $input.autocomplete('destroy');
        }
        
        // 点击或获取焦点时显示菜单
        $input.on('click focus', function(e) {
            e.stopPropagation();
            console.log('点击产品名称输入框');
            
            // 移除现有菜单
            $('.product-menu-container').remove();
            
            // 创建菜单结构
            var $menu = $('<div class="product-menu-container"></div>');
            var $categories = $('<div class="category-list menu-list"></div>');
            var $products = $('<div class="product-list menu-list"></div>');
            var $models = $('<div class="model-list menu-list"></div>');
            var $specs = $('<div class="spec-list menu-list"></div>');
            
            $categories.html('<div class="menu-loading">加载中...</div>');
            $products.html('<div class="menu-loading">请选择左侧类别</div>');
            $models.html('<div class="menu-loading">请选择产品名称</div>');
            $specs.html('<div class="menu-loading">请选择产品型号</div>');
            
            $menu.append($categories).append($products).append($models).append($specs);
            
            // 定位菜单
            var pos = $input.offset();
            $menu.css({
                top: pos.top + $input.outerHeight() + 'px',
                left: pos.left + 'px'
            });
            
            // 添加到页面
            $('body').append($menu);
            
            // 加载产品类别
            $.ajax({
                url: '/quotation/products/categories',
                method: 'GET',
                cache: false,
                headers: {
                    'Pragma': 'no-cache',
                    'Cache-Control': 'no-cache, no-store, must-revalidate'
                },
                data: {
                    '_': new Date().getTime()
                },
                success: function(categories) {
                    console.log('获取到产品类别数组:', categories);
                    $categories.empty();
                    
                    if (!categories || categories.length === 0) {
                        $categories.html('<div class="menu-loading">无产品类别</div>');
                        return;
                    }
                    
                    // 添加类别选项
                    categories.forEach(function(category) {
                        var $item = $('<div class="menu-item"></div>')
                            .text(category)
                            .data('category', category);
                        
                        $item.on('click', function() {
                            // 高亮当前类别
                            $('.category-list .menu-item').removeClass('active');
                            $(this).addClass('active');
                            
                            // 隐藏型号和规格列表
                            $models.hide();
                            $specs.hide();
                            
                            // 显示产品列表并加载数据
                            $products.show();
                            $products.html('<div class="menu-loading">加载中...</div>');
                            
                            var selectedCategory = $(this).data('category');
                            console.log('选中类别:', selectedCategory);
                            
                            // 加载该类别下的产品
                            $.ajax({
                                url: '/quotation/products/by-category',
                                method: 'GET',
                                data: { category: selectedCategory },
                                success: function(products) {
                                    console.log('获取到产品列表:', products);
                                    $products.empty();
                                    
                                    if (!products || products.length === 0) {
                                        $products.html('<div class="menu-loading">该类别无产品</div>');
                                        return;
                                    }
                                    
                                    products.forEach(function(product) {
                                        var $item = $('<div class="menu-item"></div>')
                                            .text(product.name)
                                            .data('product', product);
                                        
                                        $item.on('click', function() {
                                            $('.product-list .menu-item').removeClass('active');
                                            $(this).addClass('active');
                                            
                                            $specs.hide();
                                            $models.show();
                                            $models.html('<div class="menu-loading">加载中...</div>');
                                            
                                            var selectedProduct = $(this).data('product');
                                            
                                            // 加载产品型号
                                            $.ajax({
                                                url: '/quotation/products/models',
                                                method: 'GET',
                                                data: { 
                                                    category: selectedCategory,
                                                    product_name: selectedProduct.name
                                                },
                                                success: function(models) {
                                                    $models.empty();
                                                    
                                                    if (!models || models.length === 0) {
                                                        $models.html('<div class="menu-loading">该产品无型号</div>');
                                                        return;
                                                    }
                                                    
                                                    models.forEach(function(model) {
                                                        var $item = $('<div class="menu-item"></div>')
                                                            .text(model.model)
                                                            .data('model', model);
                                                        
                                                        $item.on('click', function() {
                                                            $('.model-list .menu-item').removeClass('active');
                                                            $(this).addClass('active');
                                                            
                                                            $specs.show();
                                                            $specs.html('<div class="menu-loading">加载中...</div>');
                                                            
                                                            var selectedModel = $(this).data('model');
                                                            
                                                            // 加载产品规格
                                                            $.ajax({
                                                                url: '/quotation/products/specifications',
                                                                method: 'GET',
                                                                data: {
                                                                    category: selectedCategory,
                                                                    product_name: selectedProduct.name,
                                                                    model: selectedModel.model
                                                                },
                                                                success: function(specs) {
                                                                    $specs.empty();
                                                                    
                                                                    if (!specs || specs.length === 0) {
                                                                        $specs.html('<div class="menu-loading">该型号无规格</div>');
                                                                        return;
                                                                    }
                                                                    
                                                                    specs.forEach(function(spec) {
                                                                        var $item = $('<div class="menu-item no-arrow"></div>')
                                                                            .text(spec.specification || '标准规格')
                                                                            .data('spec', spec);
                                                                        
                                                                        $item.on('click', function() {
                                                                            var selectedSpec = $(this).data('spec');
                                                                            
                                                                            // 填充产品信息
                                                                            var $row = $input.closest('tr');
                                                                            $input.val(selectedProduct.name);
                                                                            fillProductDetails($row, selectedSpec);
                                                                            
                                                                            // 关闭菜单
                                                                            $('.product-menu-container').remove();
                                                                        });
                                                                        
                                                                        $specs.append($item);
                                                                    });
                                                                },
                                                                error: function() {
                                                                    $specs.html('<div class="menu-loading">加载规格失败</div>');
                                                                }
                                                            });
                                                        });
                                                        
                                                        $models.append($item);
                                                    });
                                                },
                                                error: function() {
                                                    $models.html('<div class="menu-loading">加载型号失败</div>');
                                                }
                                            });
                                        });
                                        
                                        $products.append($item);
                                    });
                                },
                                error: function() {
                                    $products.html('<div class="menu-loading">加载产品失败</div>');
                                }
                            });
                        });
                        
                        $categories.append($item);
                    });
                },
                error: function() {
                    $categories.html('<div class="menu-loading">加载类别失败</div>');
                }
            });
        });
    });
}

// 填充产品详情
function fillProductDetails($row, product) {
    console.log('填充产品详情，完整产品数据:', JSON.stringify(product, null, 2));
    
    // 填充产品型号
    $row.find('.product-model').val(product.model || '');
    
    // 填充产品规格
    $row.find('.product-spec').val(product.specification || '');
    
    // 填充品牌
    $row.find('.product-brand').val(product.brand || '');
    
    // 填充单位
    $row.find('.product-unit').val(product.unit || '');
    
    // 填充MN
    let mnValue = product.product_mn || '';
    $row.find('.product-mn').val(mnValue);
    
    // 设置市场价格
    let price = parseFloat(product.retail_price) || 0;
    $row.find('.product-price')
        .val(formatNumber(price))
        .data('raw-value', price);
    
    // 设置初始折扣率为100%
    $row.find('.discount-rate').val('100.0');
    
    // 设置初始折扣后单价等于市场价格
    let $discountedInput = $row.find('.discounted-price');
    $discountedInput
        .val(formatNumber(price))
        .data('raw-value', price);
    
    // 设置初始数量为1
    let $quantityInput = $row.find('.quantity');
    $quantityInput.val('1');
    
    // 计算并设置小计
    let subtotal = price * 1;
    let formattedSubtotal = formatNumber(subtotal);
    $row.find('.subtotal')
        .val(formattedSubtotal)
        .data('raw-value', subtotal)
        .attr('title', formattedSubtotal);
    
    // 更新总计
    updateTableTotals();
}

// 格式化数字为带千位分隔符和两位小数的字符串
function formatNumber(number) {
    try {
        let num = parseFloat(number);
        if (isNaN(num)) {
            console.warn('formatNumber接收到无效的数值:', number);
            return '0.00';
        }
        
        return num.toLocaleString('zh-CN', { 
            minimumFractionDigits: 2, 
            maximumFractionDigits: 2 
        });
    } catch (e) {
        console.error('格式化数字时出错:', e, '输入值:', number);
        return '0.00';
    }
}

// 🔥 优化后的数量获取函数 - 支持审批状态下的文本显示
function getQuantityValue($row) {
    try {
        // 首先尝试从隐藏的input获取（审批状态下的隐藏字段）
        const $hiddenQuantity = $row.find('input.quantity[type="hidden"]');
        if ($hiddenQuantity.length > 0) {
            let quantity = parseInt($hiddenQuantity.val(), 10);
            if (!isNaN(quantity) && quantity >= 1) {
                return quantity;
            }
        }
        
        // 然后尝试从可见的input获取（可编辑状态）
        const $quantityInput = $row.find('input.quantity:not([type="hidden"])');
        if ($quantityInput.length > 0) {
            let quantity = parseInt($quantityInput.val(), 10);
            if (!isNaN(quantity) && quantity >= 1) {
                $quantityInput.data('raw-value', quantity);
                return quantity;
            }
        }
        
        // 最后尝试从显示文本获取（审批状态下的纯文本显示）
        const $quantityDisplay = $row.find('.quantity-display');
        if ($quantityDisplay.length > 0) {
            let displayText = $quantityDisplay.text().trim();
            let numberMatch = displayText.match(/\d+/);
            if (numberMatch) {
                let quantity = parseInt(numberMatch[0], 10);
                if (!isNaN(quantity) && quantity >= 1) {
                    return quantity;
                }
            }
        }
        
        // 从包含数量的td单元格获取（回退方案）
        const $cells = $row.find('td');
        for (let i = 0; i < $cells.length; i++) {
            const cellText = $cells.eq(i).text().trim();
            // 查找只包含数字的单元格（可能是数量）
            if (/^\d+$/.test(cellText)) {
                let quantity = parseInt(cellText, 10);
                if (quantity >= 1) {
                    return quantity;
                }
            }
        }
        
        console.warn('无法获取有效数量，使用默认值1');
        return 1; // 默认值
    } catch (e) {
        console.error('获取数量值时出错:', e);
        return 1;
    }
}

// 计算小计 (小计 = 数量 * 单价)
function calculateSubtotal($row) {
    try {
        var quantity = getQuantityValue($row); // 🔥 使用统一函数
        var unitPrice = parseFloat($row.find('.discounted-price').data('raw-value')) || 0;
        
        console.log('=== 小计计算调试 ===');
        console.log('数量输入值:', $row.find('.quantity').val(), '解析后:', quantity);
        console.log('单价 data-raw-value:', $row.find('.discounted-price').data('raw-value'), '解析后:', unitPrice);
        console.log('单价显示值:', $row.find('.discounted-price').val());
        
        // 🔥 新增详细调试信息
        const $quantityInput = $row.find('.quantity');
        const $priceInput = $row.find('.discounted-price');
        const $subtotalInput = $row.find('.subtotal');
        
        console.log('小计计算开始', {
            '行信息': {
                '行索引': $row.index(),
                '产品名称': $row.find('.product-name').val(),
                '表格类型': $row.closest('#pricingTable').length > 0 ? '批价单' : '结算单'
            },
            '数量字段': {
                '显示值': $quantityInput.val(),
                'data-raw-value': $quantityInput.data('raw-value'),
                '解析后数量': quantity
            },
            '单价字段': {
                '显示值': $priceInput.val(),
                'data-raw-value': $priceInput.data('raw-value'),
                '解析后单价': unitPrice
            },
            '小计字段': {
                '当前显示值': $subtotalInput.val(),
                '当前data-raw-value': $subtotalInput.data('raw-value')
            }
        });
        
        // 如果没有原始值，尝试从显示值解析
        if (unitPrice === 0) {
            var displayValue = $row.find('.discounted-price').val().replace(/[^\d.]/g, '');
            unitPrice = parseFloat(displayValue) || 0;
            console.log('从显示值解析单价:', displayValue, '解析后:', unitPrice);
            console.log('单价解析', {
                '原始显示值': $row.find('.discounted-price').val(),
                '清理后': displayValue,
                '解析后': unitPrice
            });
            if (unitPrice > 0) {
                $row.find('.discounted-price').data('raw-value', unitPrice);
                console.log('已更新单价 data-raw-value:', unitPrice);
            }
        }
        
        // 计算小计
        var subtotal = quantity * unitPrice;
        console.log('小计计算: ' + quantity + ' * ' + unitPrice + ' = ' + subtotal);
        
        // 🔥 新增计算验证
                 console.log('小计计算验证', {
             '计算公式': quantity + ' × ' + unitPrice + ' = ' + subtotal,
             '数量是否有效': !isNaN(quantity) && quantity > 0,
             '单价是否有效': !isNaN(unitPrice) && unitPrice >= 0,
             '小计是否有效': !isNaN(subtotal) && subtotal >= 0,
             '计算前小计值': $subtotalInput.val(),
             '计算后小计值': subtotal
         });
        
        // 更新小计显示
        var formattedSubtotal = formatNumber(subtotal);
        $row.find('.subtotal')
            .val(formattedSubtotal)
            .data('raw-value', subtotal)
            .attr('title', formattedSubtotal);
        
        console.log('小计已更新: data-raw-value=' + subtotal + ', 显示值=' + formattedSubtotal);
        
        // 🔥 验证更新结果
        console.log('小计更新验证', {
            '格式化后': formattedSubtotal,
            '更新后显示值': $row.find('.subtotal').val(),
            '更新后data-raw-value': $row.find('.subtotal').data('raw-value'),
            '更新后title': $row.find('.subtotal').attr('title')
        });
        
        // 立即更新总计
        updateTableTotals();
        
        console.log('=== 小计计算调试结束 ===');
        return subtotal;
    } catch (e) {
        console.error('计算小计时出错:', e);
        console.log('小计计算异常', {
            '错误信息': e.message,
            '错误堆栈': e.stack
        });
        return 0;
    }
}





// 点击其他地方关闭产品选择菜单
$(document).on('click', function(e) {
    if (!$(e.target).closest('.product-menu-container, .product-name').length) {
        $('.product-menu-container').remove();
    }
});





// 删除产品
function deleteProduct(detailId) {
    if (!confirm('确定要删除这个产品吗？')) {
        return;
    }
    
    fetch(`/pricing_order/${PRICING_ORDER_ID}/delete_product/${detailId}`, {
        method: 'DELETE',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // 移除相关的DOM元素而不刷新页面
            removePricingDetailFromDOM(detailId);
            
            // 重新计算总额
            updateTableTotals(true);
            
            // 显示成功提示
            showAlert('success', '产品已删除');
        } else {
            showAlert('error', data.message);
        }
    })
    .catch(error => {
        showAlert('error', '删除失败: ' + error.message);
    });
}

// 移除产品明细的DOM元素
function removePricingDetailFromDOM(detailId) {
    // 移除桌面端表格行
    $(`#pricingTable tr[data-detail-id="${detailId}"]`).remove();
    $(`#settlementTable tr[data-detail-id="${detailId}"]`).remove();
    
    // 移除移动端卡片
    $(`.mobile-product-card[data-detail-id="${detailId}"]`).remove();
    
    console.log(`已移除产品明细 ${detailId} 的DOM元素`);
}

// 批量删除产品明细
function batchDeleteProducts() {
    const selectedCheckboxes = $('.pricing-detail-checkbox:checked');
    const selectedCount = selectedCheckboxes.length;
    
    if (selectedCount === 0) {
        showAlert('warning', '请先选择要删除的产品');
        return;
    }
    
    if (!confirm(`确定要删除选中的 ${selectedCount} 个产品吗？`)) {
        return;
    }
    
    const detailIds = [];
    selectedCheckboxes.each(function() {
        detailIds.push(parseInt($(this).val()));
    });
    
    fetch(`/pricing_order/${PRICING_ORDER_ID}/batch_delete_products`, {
        method: 'DELETE',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            detail_ids: detailIds
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // 移除选中的DOM元素
            detailIds.forEach(detailId => {
                removePricingDetailFromDOM(detailId);
            });
            
            // 重新计算总额
            updateTableTotals(true);
            
            // 更新选择状态
            updateBatchActionButtons();
            
            // 显示成功提示
            showAlert('success', data.message);
        } else {
            showAlert('error', data.message);
        }
    })
    .catch(error => {
        showAlert('error', '批量删除失败: ' + error.message);
    });
}

// 更新批量操作按钮状态
function updateBatchActionButtons() {
    const selectedCount = $('.pricing-detail-checkbox:checked').length;
    const $batchActionsArea = $('#batchActionsArea');
    const $selectedCount = $('#selectedCount');
    const $selectedCountText = $('#selectedCountText');
    
    console.log(`批量操作状态更新: 选中 ${selectedCount} 个项目`);
    
    if (selectedCount > 0) {
        $batchActionsArea.css('display', 'flex');
        $selectedCount.text(selectedCount);
        $selectedCountText.text(selectedCount);
        console.log('显示批量操作按钮');
    } else {
        $batchActionsArea.css('display', 'none');
        console.log('隐藏批量操作按钮');
    }
}

// 全选/取消全选
function toggleSelectAllPricing() {
    const $selectAll = $('#selectAllPricing');
    const $checkboxes = $('.pricing-detail-checkbox');
    const isChecked = $selectAll.prop('checked');
    
    $checkboxes.prop('checked', isChecked);
    updateBatchActionButtons();
}

// 移动端实时计算函数（不调用数据库）
function calculateMobileRowValues($element, triggerType) {
    console.log('移动端实时计算:', triggerType);
    
    // 判断是移动端卡片还是桌面端表格行
    const isMobileCard = $element.hasClass('mobile-product-card');
    const $container = isMobileCard ? $element : $element.closest('tr');
    
    // 获取基础数据
    const marketPrice = parseFloat($container.find('.product-price').data('raw-value')) || 0;
    const quantity = parseInt($container.find('.quantity').val()) || 1;
    
    let discountRate, unitPrice;
    
    if (triggerType === 'discount_rate') {
        // 从折扣率计算单价
        discountRate = parseFloat($container.find('.discount-rate').val()) / 100;
        unitPrice = marketPrice * discountRate;
        
        // 更新单价显示
        $container.find('.discounted-price')
            .val(unitPrice.toFixed(2))
            .data('raw-value', unitPrice);
            
    } else if (triggerType === 'quantity') {
        // 数量变化，使用当前的单价重新计算小计
        unitPrice = parseFloat($container.find('.discounted-price').data('raw-value')) || 0;
        
        // 如果单价为0，使用折扣率和市场价计算单价
        if (unitPrice === 0) {
            discountRate = parseFloat($container.find('.discount-rate').val()) / 100 || 1;
            unitPrice = marketPrice * discountRate;
            $container.find('.discounted-price')
                .val(unitPrice.toFixed(2))
                .data('raw-value', unitPrice);
        }
    }
    
    // 计算小计（数量 × 单价）
    const subtotal = unitPrice * quantity;
    
    // 更新小计显示
    $container.find('.subtotal')
        .val(subtotal.toFixed(2))
        .data('raw-value', subtotal);
    
    // 如果是移动端卡片，同步到对应的桌面端表格行
    if (isMobileCard) {
        const detailId = $container.data('detail-id');
        if (detailId) {
            const $desktopRow = $(`#pricingTable tr[data-detail-id="${detailId}"], #settlementTable tr[data-detail-id="${detailId}"]`);
            if ($desktopRow.length) {
                $desktopRow.find('.discounted-price')
                    .val(unitPrice.toFixed(2))
                    .data('raw-value', unitPrice);
                $desktopRow.find('.subtotal')
                    .val(subtotal.toFixed(2))
                    .data('raw-value', subtotal);
            }
        }
    }
    
    // 更新总额显示（用户编辑时需要重新计算）
    updateTableTotals(true);
    
    console.log(`移动端计算完成 - 类型: ${triggerType}, 数量: ${quantity}, 单价: ${unitPrice.toFixed(2)}, 小计: ${subtotal.toFixed(2)}`);
}



// 审批相关变量
let currentApprovalAction = '';

// 打开审批模态框
function openApprovalModal(action) {
    console.log('=== 打开审批模态框 ===');
    console.log('审批动作:', action);
    
    currentApprovalAction = action;
    
    // 如果是审批通过，先进行金额校验
    if (action === 'approve') {
        console.log('审批通过操作，开始金额校验...');
        // 先进行金额校验，校验失败则不打开模态框
        if (!validateAmountBeforeApproval()) {
            console.log('❌ 金额校验失败，阻止打开审批模态框');
            return; // 校验失败，不打开模态框
        }
        console.log('✅ 金额校验通过，继续打开审批模态框');
    }
    
    const actionDisplay = document.getElementById('approvalActionDisplay');
    const confirmBtn = document.getElementById('confirmApprovalBtn');
    const modalComment = document.getElementById('modalApprovalComment');
    
    // 同步当前的审批意见到模态框
    const currentComment = document.getElementById('approvalComment').value;
    modalComment.value = currentComment;
    
    if (action === 'approve') {
        actionDisplay.className = 'alert alert-success mb-3';
        actionDisplay.innerHTML = '<i class="fas fa-check me-2"></i>您确定要通过此批价单吗？';
        // 使用标准按钮样式类，确保与系统一致
        confirmBtn.className = 'btn btn-success';
        confirmBtn.innerHTML = '<i class="fas fa-check me-1"></i>确认通过';
    } else {
        actionDisplay.className = 'alert alert-danger mb-3';
        actionDisplay.innerHTML = '<i class="fas fa-times me-2"></i>您确定要拒绝此批价单吗？';
        // 使用标准按钮样式类，确保与系统一致
        confirmBtn.className = 'btn btn-danger';
        confirmBtn.innerHTML = '<i class="fas fa-times me-1"></i>确认拒绝';
    }
    
    const modal = new bootstrap.Modal(document.getElementById('approvalModal'));
    modal.show();
}

// 确认审批操作
function confirmApproval() {
    const comment = document.getElementById('modalApprovalComment').value;
    
    // 同步审批意见回主表单
    document.getElementById('approvalComment').value = comment;
    
    // 🔥 关键修复：如果是通过审批，需要传递当前的结算单数据确保用户修改的折扣率被保存
    const data = {
        action: currentApprovalAction,
        comment: comment
    };
    
    // 如果是通过审批，收集当前的数据（特别是结算单数据）
    if (currentApprovalAction === 'approve') {
        console.log('审批通过，收集当前结算单数据...');
        data.basic_info = window.pricingOrderCache || {};
        data.pricing_details = collectPricingDetails();
        data.settlement_details = collectSettlementDetails();
        console.log('审批时传递的数据:', data);
    }
    
    // 显示处理中状态
    const confirmBtn = document.getElementById('confirmApprovalBtn');
    const originalText = confirmBtn.innerHTML;
    confirmBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>处理中...';
    confirmBtn.disabled = true;
    
    fetch(`/pricing_order/${PRICING_ORDER_ID}/approve`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // 关闭模态框
            const modal = bootstrap.Modal.getInstance(document.getElementById('approvalModal'));
            modal.hide();
            
            // 显示成功消息
            const actionText = currentApprovalAction === 'approve' ? '通过' : '拒绝';
            showStandardAlert('success', `批价单审批${actionText}成功！`, [], '.card:has(#dealerSelect)', 2000);
            
            // 延迟刷新页面
            setTimeout(() => {
                location.reload();
            }, 2000);
        } else {
            showStandardAlert('error', data.message || '审批失败', [], '.card:has(#dealerSelect)');
            // 恢复按钮状态
            confirmBtn.innerHTML = originalText;
            confirmBtn.disabled = false;
        }
    })
    .catch(error => {
        showStandardAlert('error', '审批失败: ' + error.message, [], '.card:has(#dealerSelect)');
        // 恢复按钮状态
        confirmBtn.innerHTML = originalText;
        confirmBtn.disabled = false;
    });
}

// 保持原有的submitApproval函数以兼容性（已弃用）
function submitApproval(action) {
    openApprovalModal(action);
}

// 使用标准提示函数替换原有的showAlert
function showAlert(type, message, conditions = []) {
    showStandardAlert(type, message, conditions, '.card:has(#dealerSelect)');
}

// 保存批价单（包含基本信息和明细）
function savePricingOrder() {
    console.log('开始保存批价单...');
    
    // 收集所有数据
    const saveData = {
        basic_info: window.pricingOrderCache || {},
        pricing_details: collectPricingDetails(),
        settlement_details: collectSettlementDetails()
    };
    
    console.log('保存数据:', saveData);
    
    // 显示保存中状态
    const $saveBtn = $('#savePricingOrderBtn');
    const originalText = $saveBtn.html();
    $saveBtn.html('<i class="fas fa-spinner fa-spin"></i> 保存中...').prop('disabled', true);
    
    fetch(`/pricing_order/${PRICING_ORDER_ID}/save_all`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(saveData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('success', '批价单保存成功！');
            // 清空缓存
            window.pricingOrderCache = {};
            // 延迟后返回上一页
            setTimeout(() => {
                window.history.back();
            }, 1000);
        } else {
            showAlert('error', data.message || '保存失败');
            // 恢复按钮状态
            $saveBtn.html(originalText).prop('disabled', false);
        }
    })
    .catch(error => {
        console.error('保存失败:', error);
        showAlert('error', '保存失败: ' + error.message);
        // 恢复按钮状态
        $saveBtn.html(originalText).prop('disabled', false);
    });
}



// 收集批价单明细数据（前端）
function collectPricingDetails() {
    const details = [];
    
    // 检查批价单表格是否存在
    const $pricingTable = $('#pricingTable');
    if ($pricingTable.length === 0) {
        console.log('批价单表格不存在，返回空数组');
        return details;
    }
    
    $pricingTable.find('tbody tr').each(function() {
        const $row = $(this);
        const $productNameInput = $row.find('.product-name');
        
        // 检查产品名称输入框是否存在
        if ($productNameInput.length === 0) {
            console.log('产品名称输入框不存在，跳过此行');
            return true; // 继续下一行
        }
        
        const productName = $productNameInput.val();
        if (!productName || !productName.trim()) {
            return true; // 跳过空行
        }
        
        // 获取当前行的实际计算值
        const marketPrice = parseFloat($row.find('.product-price').data('raw-value')) || parseFloat($row.find('.product-price').val().replace(/[^\\d.]/g, '')) || 0;
        const unitPrice = parseFloat($row.find('.discounted-price').data('raw-value')) || parseFloat($row.find('.discounted-price').val().replace(/[^\\d.]/g, '')) || 0;
        const quantity = parseInt($row.find('.quantity').val()) || 1;
        const discountRate = parseFloat($row.find('.discount-rate').val()) || 100;
        
        console.log(`收集明细 - 产品: ${productName}, 市场价: ${marketPrice}, 单价: ${unitPrice}, 数量: ${quantity}, 折扣率: ${discountRate}%`);
        
        details.push({
            product_name: productName.trim(),
            product_model: $row.find('.product-model').val() || '',
            product_desc: $row.find('.product-spec').val() || '',
            brand: $row.find('.product-brand').val() || '',
            unit: $row.find('.product-unit').val() || '台',
            product_mn: $row.find('.product-mn').val() || '',
            market_price: marketPrice,
            unit_price: unitPrice,  // 添加单价字段
            quantity: quantity,
            discount_rate: discountRate  // 保持百分比形式，后端会处理转换
        });
    });
    
    console.log('收集到的批价单明细:', details);
    return details;
}

// 收集结算单明细数据（前端）
function collectSettlementDetails() {
    const details = [];
    
    // 检查结算单表格是否存在
    const $settlementTable = $('#settlementTable');
    if ($settlementTable.length === 0) {
        console.log('结算单表格不存在，返回空数组');
        return details;
    }
    
    $settlementTable.find('tbody tr').each(function() {
        const $row = $(this);
        const $productNameInput = $row.find('.product-name');
        
        // 检查产品名称输入框是否存在
        if ($productNameInput.length === 0) {
            console.log('产品名称输入框不存在，跳过此行');
            return true; // 继续下一行
        }
        
        const productName = $productNameInput.val();
        if (!productName || !productName.trim()) {
            return true; // 跳过空行
        }
        
        const id = $row.data('id');
        
                // 获取当前行的实际计算值
        const marketPrice = parseFloat($row.find('.product-price').data('raw-value')) || parseFloat($row.find('.product-price').val().replace(/[^\\d.]/g, '')) || 0;
        const unitPrice = parseFloat($row.find('.discounted-price').data('raw-value')) || parseFloat($row.find('.discounted-price').val().replace(/[^\\d.]/g, '')) || 0;
        const quantity = parseInt($row.find('.quantity').val()) || 1;
        const discountRate = parseFloat($row.find('.discount-rate').val()) || 100;
        
        console.log(`收集结算单明细 - 产品: ${productName}, 市场价: ${marketPrice}, 单价: ${unitPrice}, 数量: ${quantity}, 折扣率: ${discountRate}%`);
        
        details.push({
            id: id,
            product_name: productName.trim(),
            product_model: $row.find('.product-model').val() || '',
            product_desc: $row.find('.product-spec').val() || '',
            brand: $row.find('.product-brand').val() || '',
            unit: $row.find('.product-unit').val() || '台',
            product_mn: $row.find('.product-mn').val() || '',
            market_price: marketPrice,
            quantity: quantity,
            discount_rate: discountRate,  // 保持百分比形式
            unit_price: unitPrice
        });
    });
    
    console.log('收集到的结算单明细:', details);
    return details;
}

// 提交审批函数
function submitForApproval() {
    // 验证渠道信息
    const validationResult = validateChannelInfo();
    if (!validationResult.valid) {
        showChannelValidationAlert(validationResult);
        return;
    }
    
    if (!confirm('确定要提交批价单审批吗？提交后将无法修改。')) {
        return;
    }
    
    console.log('开始提交审批...');
    
    // 收集所有数据
    const submitData = {
        basic_info: window.pricingOrderCache || {},
        pricing_details: collectPricingDetails()
    };
    
    console.log('提交数据:', submitData);
    
    // 简单验证
    if (submitData.pricing_details.length === 0) {
        showAlert('error', '请至少添加一个产品明细');
        return;
    }
    
    // 显示提交中状态
    const $submitBtn = $('#submitApprovalBtn');
    const originalText = $submitBtn.html();
    $submitBtn.html('<i class="fas fa-spinner fa-spin"></i> 提交中...').prop('disabled', true);
    
    fetch(`/pricing_order/${PRICING_ORDER_ID}/save_and_submit`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(submitData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('success', '批价单已提交审批！');
            // 清空缓存
            window.pricingOrderCache = {};
            // 延迟跳转到审批中心
            setTimeout(() => {
                window.location.href = '/approval/center?tab=created&object_type=pricing_order';
            }, 1500);
        } else {
            showAlert('error', data.message || '提交审批失败');
            // 恢复按钮状态
            $submitBtn.html(originalText).prop('disabled', false);
        }
    })
    .catch(error => {
        console.error('提交审批错误:', error);
        showAlert('error', '提交审批失败，请稍后重试');
        // 恢复按钮状态
        $submitBtn.html(originalText).prop('disabled', false);
    });
}

// 重新发起审批函数
function resubmitForApproval() {
    // 验证渠道信息
    const validationResult = validateChannelInfo();
    if (!validationResult.valid) {
        showChannelValidationAlert(validationResult);
        return;
    }
    
    if (!confirm('确定要重新发起审批吗？这将清除之前的审批记录并开始新的审批流程。')) {
        return;
    }
    
    console.log('开始重新发起审批...');
    
    // 收集所有数据
    const submitData = {
        basic_info: window.pricingOrderCache || {},
        pricing_details: collectPricingDetails()
    };
    
    console.log('重新提交数据:', submitData);
    
    // 简单验证
    if (submitData.pricing_details.length === 0) {
        showAlert('error', '请至少添加一个产品明细');
        return;
    }
    
    // 显示提交中状态
    const $submitBtn = $('#resubmitApprovalBtn');
    const originalText = $submitBtn.html();
    $submitBtn.html('<i class="fas fa-spinner fa-spin"></i> 重新提交中...').prop('disabled', true);
    
    fetch(`/pricing_order/${PRICING_ORDER_ID}/save_and_submit`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(submitData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('success', '批价单已重新提交审批！');
            // 清空缓存
            window.pricingOrderCache = {};
            // 延迟跳转到审批中心
            setTimeout(() => {
                window.location.href = '/approval/center?tab=created&object_type=pricing_order';
            }, 1500);
        } else {
            showAlert('error', data.message || '重新提交审批失败');
            // 恢复按钮状态
            $submitBtn.html(originalText).prop('disabled', false);
        }
    })
    .catch(error => {
        console.error('重新提交审批错误:', error);
        showAlert('error', '重新提交审批失败，请稍后重试');
        // 恢复按钮状态
        $submitBtn.html(originalText).prop('disabled', false);
    });
}

// 召回批价单函数
function confirmRecallPricingOrder() {
    const reason = document.getElementById('recallReason').value;
    
    // 关闭模态框
    const modal = bootstrap.Modal.getInstance(document.getElementById('recallPricingOrderModal'));
    modal.hide();
    
    // 显示加载状态
    showAlert('info', '正在召回批价单...');
    
    fetch(`/pricing_order/${PRICING_ORDER_ID}/recall`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            reason: reason
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('success', '批价单已成功召回！');
            // 延迟刷新页面显示新状态
            setTimeout(() => {
                location.reload();
            }, 1500);
        } else {
            showAlert('error', '召回失败: ' + (data.message || '未知错误'));
        }
    })
    .catch(error => {
        console.error('召回失败:', error);
        showAlert('error', '召回失败，请稍后重试');
    });
}

// 删除批价单函数
function confirmDeletePricingOrder() {
    const reason = document.getElementById('deleteReason').value;
    
    // 关闭模态框
    const modal = bootstrap.Modal.getInstance(document.getElementById('deletePricingOrderModal'));
    modal.hide();
    
    // 显示加载状态
    showAlert('info', '正在删除批价单...');
    
    fetch(`/pricing_order/${PRICING_ORDER_ID}/delete`, {
        method: 'DELETE',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            reason: reason
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('success', '批价单已成功删除！');
            // 延迟跳转到项目详情页面
            setTimeout(() => {
                if (data.project_id) {
                    window.location.href = `/project/view/${data.project_id}`;
                } else {
                    window.location.href = '/pricing_order/list';
                }
            }, 1500);
        } else {
            showAlert('error', '删除失败: ' + (data.message || '未知错误'));
        }
    })
    .catch(error => {
        console.error('删除失败:', error);
        showAlert('error', '删除失败，请稍后重试');
    });
}

// 管理员退回批价单功能
{% if is_admin_or_ceo and pricing_order.status == 'approved' %}
function showAdminRollbackModal() {
    const modal = new bootstrap.Modal(document.getElementById('adminRollbackModal'));
    modal.show();
}

function confirmAdminRollback() {
    const reason = document.getElementById('adminRollbackReason').value;
    const button = document.getElementById('confirmAdminRollbackBtn');
    const originalText = button.innerHTML;
    
    // 显示处理中状态
    button.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>处理中...';
    button.disabled = true;
    
    fetch(`/pricing_order/${PRICING_ORDER_ID}/admin_rollback`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            reason: reason
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // 关闭模态框
            const modal = bootstrap.Modal.getInstance(document.getElementById('adminRollbackModal'));
            modal.hide();
            
            // 显示成功消息
            showAlert('success', '批价单审批已成功退回！');
            
            // 延迟刷新页面显示新状态
            setTimeout(() => {
                location.reload();
            }, 2000);
        } else {
            showAlert('error', '退回失败: ' + (data.message || '未知错误'));
            // 恢复按钮状态
            button.innerHTML = originalText;
            button.disabled = false;
        }
    })
    .catch(error => {
        console.error('退回失败:', error);
        showAlert('error', '退回失败，请稍后重试');
        // 恢复按钮状态
        button.innerHTML = originalText;
        button.disabled = false;
    });
}
{% else %}
// 非管理员用户，不显示退回功能
function showAdminRollbackModal() {
    console.warn('权限不足：只有管理员可以退回批价单');
}

function confirmAdminRollback() {
    console.warn('权限不足：只有管理员可以退回批价单');
}
{% endif %}

// 审批前金额校验函数
function validateAmountBeforeApproval() {
    console.log('=== 开始审批前金额校验 ===');
    
    // 检查必要的DOM元素是否存在
    const pricingTotalElement = document.getElementById('pricingTotalAmount');
    const settlementTotalElement = document.getElementById('settlementTotalAmount');
    
    console.log('DOM元素检查:');
    console.log('批价单总金额元素存在:', !!pricingTotalElement);
    console.log('结算单总金额元素存在:', !!settlementTotalElement);
    
    if (!pricingTotalElement) {
        console.log('❌ 批价单总金额元素不存在');
        // 滚动到页面顶部显示错误提示
        window.scrollTo({ top: 0, behavior: 'smooth' });
        setTimeout(() => {
            showStandardAlert('error', '页面错误：无法找到批价单总金额显示元素', [], '.card:has(#dealerSelect)', 8000);
        }, 300);
        return false;
    }
    
    if (!settlementTotalElement) {
        console.log('❌ 结算单总金额元素不存在（可能是权限问题）');
        // 滚动到页面顶部显示错误提示
        window.scrollTo({ top: 0, behavior: 'smooth' });
        setTimeout(() => {
            showStandardAlert('error', '无法进行金额校验：您没有查看结算单的权限，请联系管理员', [], '.card:has(#dealerSelect)', 8000);
        }, 300);
        return false;
    }
    
    // 获取批价单总金额和结算单总金额
    const pricingTotalText = pricingTotalElement.textContent;
    const settlementTotalText = settlementTotalElement.textContent;
    
    console.log('原始文本内容:');
    console.log('批价单总金额文本:', pricingTotalText);
    console.log('结算单总金额文本:', settlementTotalText);
    
    // 从文本中提取数字（修复正则表达式）
    const pricingTotal = parseFloat(pricingTotalText.replace(/[^\d.-]/g, '')) || 0;
    const settlementTotal = parseFloat(settlementTotalText.replace(/[^\d.-]/g, '')) || 0;
    
    console.log('提取的数字:');
    console.log('批价单总金额:', pricingTotal);
    console.log('结算单总金额:', settlementTotal);
    
    // 检查结算单总额是否大于批价单总额
    if (settlementTotal > pricingTotal) {
        console.log('❌ 金额校验失败: 结算单总额大于批价单总额');
        
        // 使用标准消息提示函数显示错误
        const errorMessage = `审批失败：结算单总金额 ¥${settlementTotal.toLocaleString('zh-CN', {minimumFractionDigits: 2, maximumFractionDigits: 2})} 大于批价单总金额 ¥${pricingTotal.toLocaleString('zh-CN', {minimumFractionDigits: 2, maximumFractionDigits: 2})}，不能通过审批`;
        
        console.log('错误消息:', errorMessage);
        
        // 滚动到页面顶部，确保用户能看到错误提示
        window.scrollTo({
            top: 0,
            behavior: 'smooth'
        });
        
        // 延迟显示提示，确保页面已滚动
        setTimeout(() => {
            showStandardAlert('error', errorMessage, [], '.card:has(#dealerSelect)', 8000);
        }, 300);
        
        return false;
    }
    
    console.log('✅ 金额校验通过');
    console.log('=== 审批前金额校验结束 ===');
    return true;
}
</script>

<!-- 初始化数据 -->
<script type="text/javascript">
// 初始化前端缓存
window.pricingOrderCache = {
    distributor_id: null,
    dealer_id: null
};

// 折扣权限配置
window.discountLimits = {
    pricing_discount_limit: {% if discount_limits.pricing_discount_limit is not none %}{{ discount_limits.pricing_discount_limit }}{% else %}null{% endif %},
    settlement_discount_limit: {% if discount_limits.settlement_discount_limit is not none %}{{ discount_limits.settlement_discount_limit }}{% else %}null{% endif %}
};

// 🔥 增强调试信息
console.log('=== 折扣权限调试信息 ===');
console.log('1. 设置window.discountLimits:', window.discountLimits);
console.log('2. window.discountLimits类型:', typeof window.discountLimits);
console.log('3. 模板discount_limits变量是否存在:', '{% if discount_limits %}true{% else %}false{% endif %}');
console.log('4. 模板中的原始discount_limits:', JSON.stringify({
    pricing_discount_limit: {% if discount_limits.pricing_discount_limit is not none %}{{ discount_limits.pricing_discount_limit }}{% else %}null{% endif %},
    settlement_discount_limit: {% if discount_limits.settlement_discount_limit is not none %}{{ discount_limits.settlement_discount_limit }}{% else %}null{% endif %}
}));
console.log('5. pricing_discount_limit值:', {{ discount_limits.pricing_discount_limit|default('null') }});
console.log('6. settlement_discount_limit值:', {% if discount_limits.settlement_discount_limit is not none %}{{ discount_limits.settlement_discount_limit }}{% else %}null{% endif %});
console.log('7. window.discountLimits是否存在:', !!window.discountLimits);
console.log('8. window.discountLimits.pricing_discount_limit:', window.discountLimits.pricing_discount_limit);
console.log('========================');

// 🔥 重要调试：检查折扣权限数据是否正确
if (window.discountLimits) {
    console.log('✅ 折扣权限数据已加载:', window.discountLimits);
    if (window.discountLimits.pricing_discount_limit !== null) {
        console.log(`📊 批价单折扣下限: ${window.discountLimits.pricing_discount_limit}%`);
    } else {
        console.log('⚠️ 批价单折扣下限未设置');
    }
    if (window.discountLimits.settlement_discount_limit !== null) {
        console.log(`📊 结算单折扣下限: ${window.discountLimits.settlement_discount_limit}%`);
    } else {
        console.log('⚠️ 结算单折扣下限未设置');
    }
} else {
    console.log('❌ 折扣权限数据未加载！');
}

// 初始化Bootstrap页签切换
document.addEventListener('DOMContentLoaded', function() {
    // 确保Bootstrap页签能正常工作
    const triggerTabList = document.querySelectorAll('#productTabs button[data-bs-toggle="tab"], #productTabs a[data-bs-toggle="tab"]');
    triggerTabList.forEach(triggerEl => {
        const tabTrigger = new bootstrap.Tab(triggerEl);
        
        triggerEl.addEventListener('click', event => {
            event.preventDefault();
            tabTrigger.show();
        });
    });
    
    // 初始化开关状态
    initializeSwitches();
    
    // 初始化已有行的数据（重要：确保data-raw-value正确设置）
    initializeExistingRows();
    
    // 页面加载时重新计算总折扣率（基于明细数据），但不重新计算总金额
    calculateAndUpdateTotalDiscountRate('pricing', true);
    calculateAndUpdateTotalDiscountRate('settlement', true);
    
    // 页面加载时不重新计算总金额，直接使用数据库中的值
    // updateTableTotals(); // 注释掉这行，避免页面加载时重新计算总金额
    
    // 初始化分销利润计算（基于数据库中的总金额）
    updateDistributionProfit();
    
    // 初始化折扣权限检查
    initializeDiscountPermissionCheck();
    
    console.log('页签初始化完成，总折扣率已重新计算，总金额使用数据库值');
    
    // 初始化批量操作功能
    console.log('开始初始化批量操作功能');
    initializeBatchOperations();
    
    // 确保批量操作按钮初始状态为隐藏
    updateBatchActionButtons();
    
    // 初始化搜索下拉框
    console.log('开始初始化搜索下拉框');
    
    // 添加详细调试信息
    console.log('=== 搜索下拉框调试信息 ===');
    const wrappers = document.querySelectorAll('.searchable-select-wrapper');
    console.log('找到的搜索下拉框容器数量:', wrappers.length);
    
    wrappers.forEach((wrapper, index) => {
        console.log(`容器 ${index + 1}:`, {
            type: wrapper.dataset.type,
            name: wrapper.dataset.name,
            input: wrapper.querySelector('.searchable-select-input'),
            hiddenInput: wrapper.querySelector('.searchable-select-value'),
            dropdown: wrapper.querySelector('.searchable-select-dropdown')
        });
    });
    
    if (wrappers.length === 0) {
        console.error('❌ 没有找到搜索下拉框容器！检查HTML结构...');
        // 检查是否有传统的select元素
        const oldSelects = document.querySelectorAll('#dealerSelect, #distributorSelect');
        console.log('找到的传统select元素:', oldSelects.length);
        oldSelects.forEach((select, index) => {
            console.log(`传统select ${index + 1}:`, select);
        });
    } else {
        console.log('✅ 开始初始化搜索下拉框...');
        initializeSearchableSelects();
    }
});

// 初始化批量操作功能
function initializeBatchOperations() {
    console.log('批量操作功能初始化中...');
    
    // 检查必要元素是否存在
    console.log('全选复选框:', $('#selectAllPricing').length);
    console.log('批量操作区域:', $('#batchActionsArea').length);
    console.log('明细复选框:', $('.pricing-detail-checkbox').length);
    
    // 全选复选框事件
    $(document).on('change', '#selectAllPricing', function() {
        console.log('全选复选框状态变化');
        toggleSelectAllPricing();
    });
    
    // 单个复选框事件
    $(document).on('change', '.pricing-detail-checkbox', function() {
        console.log('单个复选框状态变化');
        updateBatchActionButtons();
        
        // 更新全选复选框状态
        const totalCheckboxes = $('.pricing-detail-checkbox').length;
        const checkedCheckboxes = $('.pricing-detail-checkbox:checked').length;
        const $selectAll = $('#selectAllPricing');
        
        if (checkedCheckboxes === 0) {
            $selectAll.prop('indeterminate', false);
            $selectAll.prop('checked', false);
        } else if (checkedCheckboxes === totalCheckboxes) {
            $selectAll.prop('indeterminate', false);
            $selectAll.prop('checked', true);
        } else {
            $selectAll.prop('indeterminate', true);
            $selectAll.prop('checked', false);
        }
    });
}

// 移动端卡片展开/收起功能
function toggleMobileDetails(button) {
    const card = button.closest('.mobile-product-card');
    const details = card.querySelector('.mobile-card-details');
    const icon = button.querySelector('i');
    
    if (details.classList.contains('show')) {
        // 收起
        details.classList.remove('show');
        icon.className = 'fas fa-chevron-down';
        button.innerHTML = '<i class="fas fa-chevron-down"></i> 查看详情';
    } else {
        // 展开
        details.classList.add('show');
        icon.className = 'fas fa-chevron-up';
        button.innerHTML = '<i class="fas fa-chevron-up"></i> 收起详情';
    }
}

// 移动端事件绑定已整合到主$(document).ready函数中

// 折扣权限检查函数
function initializeDiscountPermissionCheck() {
    // 🔥 确保权限数据正确初始化
    console.log('初始化折扣权限检查...');
    
    if (!window.discountLimits) {
        window.discountLimits = {
            pricing_discount_limit: {% if discount_limits.pricing_discount_limit is not none %}{{ discount_limits.pricing_discount_limit }}{% else %}null{% endif %},
            settlement_discount_limit: {% if discount_limits.settlement_discount_limit is not none %}{{ discount_limits.settlement_discount_limit }}{% else %}null{% endif %}
        };
        console.log('✅ 折扣权限数据已初始化:', window.discountLimits);
    } else {
        console.log('✅ 折扣权限数据已存在:', window.discountLimits);
    }
    
    // 为所有折扣率输入框添加事件监听
    const discountInputs = document.querySelectorAll('input.discount-rate, input[id$="TotalDiscount"]');
    console.log(`🔍 找到 ${discountInputs.length} 个折扣率输入框`);
    
    // 详细列出所有找到的输入框
    Array.from(discountInputs).forEach((input, index) => {
        console.log(`📝 第${index + 1}个折扣率输入框:`, {
            id: input.id || '无ID',
            className: input.className,
            value: input.value,
            parentTable: input.closest('table')?.id || '无父表格'
        });
    });
    
    discountInputs.forEach((input, index) => {
        console.log(`🔧 为第${index + 1}个折扣率输入框绑定事件: ID=${input.id || '无ID'}`);
        
        // 为每个输入框添加输入事件
        input.addEventListener('input', function() {
            console.log('📝 明细折扣率输入事件触发:', this.id || '无ID', this.value);
            checkDiscountPermissionWithLinkage(this);
        });
        
        // 为每个输入框添加change事件（确保事件触发）
        input.addEventListener('change', function() {
            console.log('📝 明细折扣率change事件触发:', this.id || '无ID', this.value);
            checkDiscountPermissionWithLinkage(this);
        });
        
        // 页面加载时检查一次
        console.log(`🚀 页面加载时为第${index + 1}个输入框检查权限...`);
        checkDiscountPermission(input);
    });
    
    // 🔥 使用事件委托确保动态添加的明细也能触发权限检查
    document.addEventListener('input', function(event) {
        if (event.target.classList.contains('discount-rate')) {
            console.log('📝 通过事件委托触发折扣率权限检查:', event.target.id || '无ID', event.target.value);
            checkDiscountPermissionWithLinkage(event.target);
        }
    });
}

// 带联动检查的折扣权限检查函数
function checkDiscountPermissionWithLinkage(inputElement) {
    // 先检查当前输入框
    checkDiscountPermission(inputElement);
    
    // 判断是明细折扣率还是总折扣率
    const isTotalDiscountInput = inputElement.id && inputElement.id.includes('TotalDiscount');
    
    if (isTotalDiscountInput) {
        // 总折扣率变化，检查所有明细折扣率
        const orderType = inputElement.id.includes('pricing') ? 'pricing' : 'settlement';
        const tableId = orderType === 'pricing' ? '#pricingTable' : '#settlementTable';
        
        // 检查当前页签的所有明细折扣率
        document.querySelectorAll(`${tableId} input.discount-rate`).forEach(detailInput => {
            checkDiscountPermission(detailInput);
        });
        
        console.log(`总折扣率变化，已联动检查${orderType}表格所有明细折扣率权限`);
    } else {
        // 明细折扣率变化，重新计算并检查总折扣率
        const orderType = inputElement.closest('#pricing-content') ? 'pricing' : 'settlement';
        
        // 延迟一点执行，确保总折扣率已经重新计算
        setTimeout(() => {
            const totalDiscountInputId = orderType === 'pricing' ? '#pricingTotalDiscount' : '#settlementTotalDiscount';
            const totalDiscountInput = document.querySelector(totalDiscountInputId);
            
            if (totalDiscountInput) {
                checkDiscountPermission(totalDiscountInput);
                console.log(`明细折扣率变化，已联动检查${orderType}总折扣率权限`);
            }
        }, 100);
    }
}

// 检查单个输入框的折扣权限（增强调试版本）
function checkDiscountPermission(inputElement) {
    if (!inputElement) {
        console.log('❌ 折扣权限检查跳过: 输入框元素缺失');
        return;
    }
    
    console.log(`🔧 开始检查折扣权限 - 元素信息:`, {
        id: inputElement.id,
        className: inputElement.className,
        value: inputElement.value,
        tagName: inputElement.tagName
    });
    
    // 🔥 确保权限数据存在，如果不存在则设置默认值
    if (!window.discountLimits) {
        window.discountLimits = {
            pricing_discount_limit: {% if discount_limits.pricing_discount_limit is not none %}{{ discount_limits.pricing_discount_limit }}{% else %}null{% endif %},
            settlement_discount_limit: {% if discount_limits.settlement_discount_limit is not none %}{{ discount_limits.settlement_discount_limit }}{% else %}null{% endif %}
        };
        console.log('🔧 重新设置折扣权限数据:', window.discountLimits);
    }
    
    const discountRate = parseFloat(inputElement.value);
    console.log(`📊 折扣率解析结果: 原始值="${inputElement.value}", 解析值=${discountRate}, 是否有效=${!isNaN(discountRate)}`);
    
    if (isNaN(discountRate) || discountRate === '') {
        // 清除警告样式
        inputElement.classList.remove('discount-warning');
        console.log('⏭️ 折扣权限检查跳过: 折扣率为空或无效');
        return;
    }
    
    // 判断是批价单还是结算单（修复订单类型判断逻辑）
    let orderType = 'pricing'; // 默认为批价单
    
    // 🔥 优先通过表格ID进行准确判断
    const pricingTable = inputElement.closest('#pricingTable');
    const settlementTable = inputElement.closest('#settlementTable');
    
    console.log(`🔍 父元素查找结果:`, {
        pricingTable: !!pricingTable,
        settlementTable: !!settlementTable,
        settlementContent: !!inputElement.closest('#settlement-content'),
        pricingContent: !!inputElement.closest('#pricing-content'),
        elementId: inputElement.id
    });
    
    if (settlementTable || 
        inputElement.closest('#settlement-content') ||
        inputElement.id === 'settlementTotalDiscount') {
        orderType = 'settlement';
    } else if (pricingTable || 
               inputElement.closest('#pricing-content') ||
               inputElement.id === 'pricingTotalDiscount') {
        orderType = 'pricing';
    }
    
    console.log(`🎯 订单类型判断结果: ${orderType}`);
    
    const limit = orderType === 'pricing' ? 
        window.discountLimits.pricing_discount_limit : 
        window.discountLimits.settlement_discount_limit;
    
    console.log(`🚦 权限检查参数: 类型=${orderType}, 折扣率=${discountRate}%, 下限=${limit}%`);
    
    // 如果没有设置权限下限，则不检查
    if (limit === null || limit === undefined) {
        inputElement.classList.remove('discount-warning');
        console.log('⏭️ 折扣权限检查跳过: 未设置权限下限');
        return;
    }
    
    // 检查是否超出权限（折扣率低于下限）
    const exceedsLimit = discountRate < limit;
    console.log(`🔎 权限比较: ${discountRate}% < ${limit}% = ${exceedsLimit}`);
    
    if (exceedsLimit) {
        // 超出权限，显示红色警告
        inputElement.classList.add('discount-warning');
        console.log(`⚠️ 添加折扣权限警告CSS类: ${discountRate}% < ${limit}% (应显示红色背景)`);
        
        // 验证CSS类是否成功添加
        const hasWarningClass = inputElement.classList.contains('discount-warning');
        console.log(`✅ CSS类添加验证: discount-warning类=${hasWarningClass}`);
    } else {
        // 权限范围内，移除警告样式
        inputElement.classList.remove('discount-warning');
        console.log(`✅ 折扣权限正常: ${discountRate}% >= ${limit}% (移除警告样式)`);
    }
}

// 批量检查所有折扣率（支持联动）
function checkAllDiscountRates() {
    const discountInputs = document.querySelectorAll('input.discount-rate, input[id$="TotalDiscount"]');
    discountInputs.forEach(input => {
        checkDiscountPermission(input);
    });
}

// ===============================
// 搜索下拉框功能
// ===============================

// 简化版拼音转换表
const pinyinMap = {
    '阿': 'a', '啊': 'a', '安': 'an', '按': 'an', '暗': 'an',
    '八': 'ba', '白': 'bai', '百': 'bai', '拜': 'bai', '班': 'ban', '办': 'ban', '半': 'ban',
    '帮': 'bang', '包': 'bao', '报': 'bao', '北': 'bei', '被': 'bei', '本': 'ben',
    '比': 'bi', '必': 'bi', '边': 'bian', '变': 'bian', '表': 'biao', '别': 'bie',
    '并': 'bing', '不': 'bu', '部': 'bu',
    '才': 'cai', '参': 'can', '草': 'cao', '层': 'ceng', '查': 'cha', '产': 'chan',
    '长': 'chang', '常': 'chang', '场': 'chang', '车': 'che', '成': 'cheng', '城': 'cheng',
    '出': 'chu', '初': 'chu', '处': 'chu', '川': 'chuan', '传': 'chuan', '创': 'chuang',
    '从': 'cong', '村': 'cun',
    '大': 'da', '打': 'da', '带': 'dai', '单': 'dan', '当': 'dang', '道': 'dao',
    '得': 'de', '的': 'de', '地': 'di', '第': 'di', '点': 'dian', '电': 'dian',
    '定': 'ding', '东': 'dong', '动': 'dong', '都': 'du', '度': 'du', '对': 'dui',
    '多': 'duo',
    '二': 'er',
    '发': 'fa', '法': 'fa', '反': 'fan', '方': 'fang', '房': 'fang', '放': 'fang',
    '非': 'fei', '分': 'fen', '风': 'feng', '服': 'fu', '府': 'fu', '副': 'fu',
    '该': 'gai', '改': 'gai', '感': 'gan', '干': 'gan', '刚': 'gang', '高': 'gao',
    '告': 'gao', '个': 'ge', '给': 'gei', '根': 'gen', '更': 'geng', '工': 'gong',
    '公': 'gong', '功': 'gong', '共': 'gong', '关': 'guan', '管': 'guan', '光': 'guang',
    '广': 'guang', '国': 'guo', '过': 'guo',
    '还': 'hai', '海': 'hai', '汉': 'han', '好': 'hao', '号': 'hao', '和': 'he',
    '合': 'he', '河': 'he', '黑': 'hei', '很': 'hen', '红': 'hong', '后': 'hou',
    '湖': 'hu', '花': 'hua', '华': 'hua', '化': 'hua', '话': 'hua', '环': 'huan',
    '回': 'hui', '会': 'hui', '活': 'huo', '火': 'huo',
    '机': 'ji', '基': 'ji', '及': 'ji', '集': 'ji', '几': 'ji', '计': 'ji',
    '记': 'ji', '技': 'ji', '际': 'ji', '加': 'jia', '家': 'jia', '价': 'jia',
    '间': 'jian', '见': 'jian', '建': 'jian', '江': 'jiang', '将': 'jiang', '交': 'jiao',
    '教': 'jiao', '接': 'jie', '结': 'jie', '解': 'jie', '介': 'jie', '金': 'jin',
    '进': 'jin', '近': 'jin', '京': 'jing', '经': 'jing', '精': 'jing', '就': 'jiu',
    '九': 'jiu', '局': 'ju', '具': 'ju', '决': 'jue',
    '开': 'kai', '看': 'kan', '可': 'ke', '科': 'ke', '空': 'kong', '口': 'kou',
    '快': 'kuai',
    '来': 'lai', '老': 'lao', '了': 'le', '类': 'lei', '里': 'li', '理': 'li',
    '力': 'li', '立': 'li', '利': 'li', '连': 'lian', '联': 'lian', '两': 'liang',
    '量': 'liang', '林': 'lin', '流': 'liu', '六': 'liu', '龙': 'long', '路': 'lu',
    '绿': 'lv',
    '马': 'ma', '吗': 'ma', '买': 'mai', '卖': 'mai', '满': 'man', '没': 'mei',
    '美': 'mei', '每': 'mei', '门': 'men', '们': 'men', '民': 'min', '明': 'ming',
    '名': 'ming', '目': 'mu',
    '那': 'na', '哪': 'na', '南': 'nan', '难': 'nan', '内': 'nei', '能': 'neng',
    '你': 'ni', '年': 'nian', '宁': 'ning', '农': 'nong',
    '欧': 'ou',
    '派': 'pai', '跑': 'pao', '培': 'pei', '朋': 'peng', '片': 'pian', '平': 'ping',
    '七': 'qi', '其': 'qi', '起': 'qi', '气': 'qi', '千': 'qian', '前': 'qian',
    '强': 'qiang', '青': 'qing', '清': 'qing', '情': 'qing', '请': 'qing', '区': 'qu',
    '全': 'quan', '群': 'qun',
    '然': 'ran', '让': 'rang', '人': 'ren', '认': 'ren', '日': 'ri', '如': 'ru',
    '三': 'san', '色': 'se', '山': 'shan', '商': 'shang', '上': 'shang', '少': 'shao',
    '社': 'she', '设': 'she', '深': 'shen', '什': 'shen', '生': 'sheng', '省': 'sheng',
    '十': 'shi', '时': 'shi', '实': 'shi', '市': 'shi', '事': 'shi', '是': 'shi',
    '手': 'shou', '首': 'shou', '受': 'shou', '书': 'shu', '数': 'shu', '水': 'shui',
    '说': 'shuo', '四': 'si', '司': 'si', '思': 'si', '所': 'suo',
    '他': 'ta', '她': 'ta', '它': 'ta', '太': 'tai', '台': 'tai', '谈': 'tan',
    '特': 'te', '天': 'tian', '田': 'tian', '条': 'tiao', '听': 'ting', '通': 'tong',
    '同': 'tong', '头': 'tou', '图': 'tu', '土': 'tu',
    '外': 'wai', '完': 'wan', '万': 'wan', '王': 'wang', '网': 'wang', '为': 'wei',
    '位': 'wei', '文': 'wen', '问': 'wen', '我': 'wo', '无': 'wu', '五': 'wu',
    '物': 'wu',
    '西': 'xi', '系': 'xi', '下': 'xia', '先': 'xian', '现': 'xian', '县': 'xian',
    '想': 'xiang', '向': 'xiang', '项': 'xiang', '小': 'xiao', '校': 'xiao', '新': 'xin',
    '心': 'xin', '信': 'xin', '星': 'xing', '行': 'xing', '形': 'xing', '学': 'xue',
    '也': 'ye', '一': 'yi', '以': 'yi', '用': 'yong', '有': 'you', '又': 'you',
    '于': 'yu', '与': 'yu', '元': 'yuan', '原': 'yuan', '院': 'yuan', '月': 'yue',
    '在': 'zai', '再': 'zai', '早': 'zao', '怎': 'zen', '增': 'zeng', '展': 'zhan',
    '站': 'zhan', '张': 'zhang', '长': 'zhang', '找': 'zhao', '这': 'zhe', '着': 'zhe',
    '真': 'zhen', '正': 'zheng', '政': 'zheng', '之': 'zhi', '知': 'zhi', '直': 'zhi',
    '制': 'zhi', '中': 'zhong', '重': 'zhong', '主': 'zhu', '住': 'zhu', '注': 'zhu',
    '专': 'zhuan', '转': 'zhuan', '准': 'zhun', '资': 'zi', '自': 'zi', '总': 'zong',
    '走': 'zou', '组': 'zu', '最': 'zui', '作': 'zuo', '做': 'zuo'
};

// 拼音转换函数
function toPinyin(str) {
    return str.split('').map(char => pinyinMap[char] || char).join('');
}

// 搜索匹配函数
function matchesSearch(text, searchTerm) {
    if (!searchTerm) return true;
    
    const lowerSearchTerm = searchTerm.toLowerCase();
    const lowerText = text.toLowerCase();
    
    // 直接文本匹配
    if (lowerText.includes(lowerSearchTerm)) {
        return true;
    }
    
    // 拼音匹配
    const pinyinText = toPinyin(text).toLowerCase();
    if (pinyinText.includes(lowerSearchTerm)) {
        return true;
    }
    
    // 拼音首字母匹配
    const pinyinInitials = text.split('').map(char => {
        const pinyin = pinyinMap[char];
        return pinyin ? pinyin[0] : char;
    }).join('').toLowerCase();
    
    if (pinyinInitials.includes(lowerSearchTerm)) {
        return true;
    }
    
    return false;
}

// 搜索下拉框类
class SearchableSelect {
    constructor(wrapper) {
        console.log('🔧 SearchableSelect 构造函数被调用:', wrapper);
        
        this.wrapper = wrapper;
        this.input = wrapper.querySelector('.searchable-select-input');
        this.hiddenInput = wrapper.querySelector('.searchable-select-value');
        this.dropdown = wrapper.querySelector('.searchable-select-dropdown');
        this.type = wrapper.dataset.type;
        this.name = wrapper.dataset.name;
        this.isOpen = false;
        this.options = [];
        
        console.log('📝 SearchableSelect 初始化信息:', {
            type: this.type,
            name: this.name,
            input: this.input,
            hiddenInput: this.hiddenInput,
            dropdown: this.dropdown,
            inputDisabled: this.input ? this.input.disabled : 'input不存在'
        });
        
        if (!this.input || !this.hiddenInput || !this.dropdown) {
            console.error('❌ SearchableSelect 初始化失败：缺少必要的DOM元素');
            return;
        }
        
        this.bindEvents();
        this.loadOptions();
    }
    
    bindEvents() {
        console.log('🔗 开始绑定事件:', this.type);
        
        // 检查是否可以编辑
        const canEdit = this.wrapper.dataset.canEdit === 'true';
        console.log('📝 编辑权限检查:', {
            canEdit: canEdit,
            inputDisabled: this.input.disabled,
            inputReadonly: this.input.readOnly
        });
        
        if (!canEdit) {
            console.log('⚠️ 用户无编辑权限，但仍绑定查看事件');
            // 即使无编辑权限，也绑定点击事件以显示选项（只读模式）
        } else {
            console.log('✅ 用户有编辑权限，绑定完整功能');
        }
        
        // 点击显示输入框时展开下拉框
        this.input.addEventListener('click', (e) => {
            console.log('🖱️ 输入框被点击:', this.type, 'isOpen:', this.isOpen, 'options数量:', this.options.length);
            // 如果输入框被禁用，不响应点击
            if (this.input.disabled || this.input.readOnly) {
                console.log('输入框已禁用，忽略点击事件');
                e.preventDefault();
                return;
            }
            e.preventDefault();
            this.toggle();
        });
        
        // 聚焦时展开下拉框
        this.input.addEventListener('focus', () => {
            if (!this.input.disabled) {
                this.open();
            }
        });
        
        // 输入时过滤选项
        this.input.addEventListener('input', () => {
            if (!this.input.disabled) {
                this.filterOptions();
            }
        });
        
        // 键盘事件
        this.input.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && !this.input.disabled) {
                this.close();
            }
        });
        
        // 点击外部关闭
        document.addEventListener('click', (e) => {
            if (!this.wrapper.contains(e.target)) {
                this.close();
            }
        });
    }
    
    toggle() {
        console.log('🔄 toggle方法被调用, 当前isOpen:', this.isOpen, 'type:', this.type);
        if (this.isOpen) {
            this.close();
        } else {
            this.open();
        }
    }
    
    open() {
        console.log(`📂 打开 ${this.type} 下拉框, 当前options数量:`, this.options.length);
        this.isOpen = true;
        this.wrapper.classList.add('open');
        if (this.options.length === 0) {
            console.log(`${this.type} 选项为空，开始加载...`);
            this.loadOptions();
        } else {
            console.log(`${this.type} 已有选项，直接显示`);
        }
    }
    
    close() {
        this.isOpen = false;
        this.wrapper.classList.remove('open');
    }
    
    filterOptions() {
        const searchTerm = this.input.value;
        const filteredOptions = this.options.filter(option => 
            matchesSearch(option.name + (option.owner_name ? ' | ' + option.owner_name : ''), searchTerm)
        );
        this.renderOptions(filteredOptions);
    }
    
    renderOptions(options) {
        if (options.length === 0) {
            this.dropdown.innerHTML = '<div class="searchable-select-no-results">未找到匹配的选项</div>';
            return;
        }
        
        this.dropdown.innerHTML = '';
        options.forEach(option => {
            const optionEl = document.createElement('div');
            optionEl.className = 'searchable-select-option';
            
            // 构建显示文本
            let displayText = option.name;
            if (option.owner_name) {
                displayText += ' | ' + option.owner_name;
            }
            // 修正逻辑：is_readable为false时才是只读，需要显示[只读]标记
            if (!option.is_readable) {
                displayText += ' [只读]';
                optionEl.classList.add('readonly');
            }
            
            optionEl.textContent = displayText;
            optionEl.dataset.value = option.id;
            optionEl.dataset.name = option.name;
            
            optionEl.addEventListener('click', () => {
                this.selectOption(option);
            });
            
            this.dropdown.appendChild(optionEl);
        });
    }
    
    selectOption(option) {
        // 设置显示文本
        let displayText = option.name;
        if (option.owner_name) {
            displayText += ' | ' + option.owner_name;
        }
        // 修正逻辑：is_readable为false时才是只读，需要显示[只读]标记
        if (!option.is_readable) {
            displayText += ' [只读]';
        }
        
        this.input.value = displayText;
        this.hiddenInput.value = option.id;
        
        this.close();
        
        // 触发change事件以兼容原有逻辑
        this.triggerChangeEvent();
    }
    
    triggerChangeEvent() {
        // 根据不同类型触发不同的change事件
        if (this.type === 'dealer') {
            if (typeof onDealerChange === 'function') {
                onDealerChange();
            }
        } else if (this.type === 'distributor') {
            if (typeof onDistributorChange === 'function') {
                onDistributorChange();
            }
        }
        
        // 触发原生change事件
        const event = new Event('change', { bubbles: true });
        this.hiddenInput.dispatchEvent(event);
    }
    
    // 启用输入框
    enable() {
        this.input.disabled = false;
        this.input.readOnly = false;
        this.wrapper.classList.remove('disabled');
        console.log(`${this.type} 输入框已启用`);
    }
    
    // 禁用输入框
    disable() {
        this.input.disabled = true;
        this.input.readOnly = true;
        this.wrapper.classList.add('disabled');
        this.close(); // 关闭下拉框
        console.log(`${this.type} 输入框已禁用`);
    }
    
    // 清空输入框内容
    clear(suppressChangeEvent = false) {
        this.input.value = '';
        this.hiddenInput.value = '';
        console.log(`${this.type} 输入框内容已清空`);
        
        // 根据参数决定是否触发change事件
        if (!suppressChangeEvent) {
            this.triggerChangeEvent();
        }
    }
    
    loadOptions() {
        console.log(`开始加载 ${this.type} 选项...`);
        this.dropdown.innerHTML = '<div class="searchable-select-loading">加载中...</div>';
        
        // 分销商使用经销商的API端点
        const apiType = this.type === 'distributor' ? 'dealer' : this.type;
        const apiUrl = `/pricing_order/api/companies/${apiType}`;
        console.log(`API URL: ${apiUrl}`);
        
        fetch(apiUrl)
            .then(response => {
                console.log(`API响应状态 (${this.type}):`, response.status);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                console.log(`${this.type} 数据:`, data);
                this.options = Array.isArray(data) ? data : [];
                this.renderOptions(this.options);
                console.log(`${this.type} 选项加载完成，共 ${this.options.length} 个选项`);
            })
            .catch(error => {
                console.error(`加载 ${this.type} 选项失败:`, error);
                this.dropdown.innerHTML = '<div class="searchable-select-no-results">加载失败</div>';
            });
    }
}

// 全局变量存储SearchableSelect实例
window.searchableSelects = {};

// 初始化所有搜索下拉框
function initializeSearchableSelects() {
    const wrappers = document.querySelectorAll('.searchable-select-wrapper');
    wrappers.forEach(wrapper => {
        const instance = new SearchableSelect(wrapper);
        const name = wrapper.dataset.name;
        if (name) {
            window.searchableSelects[name] = instance;
            console.log(`已存储 ${name} 的SearchableSelect实例`);
        }
    });
}

// 在现有的DOMContentLoaded事件中添加搜索下拉框初始化
</script>
{% endblock %}