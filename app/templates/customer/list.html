{% extends "base.html" %}
{% from 'macros/ui_helpers.html' import render_owner, render_date, render_button %}

{% block title %}å®¢æˆ·ç®¡ç†{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row mb-4 mt-5">
        <div class="col-12">
            <h1 class="fw-bold" style="color:#222;">å®¢æˆ·åˆ—è¡¨</h1>
        </div>
    </div>
    <!-- åˆ é™¤åŸæœ‰çš„ä¼ä¸šåˆ—è¡¨æ ‡é¢˜ -->
    <!-- <div class="row mb-3">
        <div class="col">
            <h2 class="text-primary">ä¼ä¸šåˆ—è¡¨</h2>
        </div>
        <div class="col text-end"> ... </div>
    </div> -->

    <div class="row mb-3">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4">
                            <div class="position-relative">
                                <input type="text" class="form-control" id="companySearch" placeholder="æœç´¢ä¼ä¸šåç§°..." autocomplete="off">
                                <span class="position-absolute top-50 end-0 translate-middle-y pe-3" id="searchCompany">
                                    <i class="fas fa-search search-icon"></i>
                                </span>
                                <div id="companySearchResults" class="dropdown-menu w-100" style="max-height: 300px; overflow-y: auto; left: 0; top: 100%; margin-top: 2px;"></div>
                            </div>
                            <div class="form-text small text-muted">è¾“å…¥ä¼ä¸šåç§°è¿›è¡Œæœç´¢ï¼Œå¯æŸ¥çœ‹æ‰€æœ‰ä¼ä¸š</div>
                        </div>
                        <div class="col-md-4">
                            <div class="position-relative">
                                <input type="text" class="form-control" id="contactSearch" placeholder="æœç´¢è”ç³»äºº..." autocomplete="off">
                                <span class="position-absolute top-50 end-0 translate-middle-y pe-3" id="searchContact">
                                    <i class="fas fa-search search-icon"></i>
                                </span>
                                <div id="contactSearchResults" class="dropdown-menu w-100" style="max-height: 300px; overflow-y: auto; left: 0; top: 100%; margin-top: 2px;"></div>
                            </div>
                            <div class="form-text small text-muted">è¾“å…¥è”ç³»äººå§“åæœç´¢ï¼Œç‚¹å‡»è·³è½¬åˆ°å¯¹åº”ä¼ä¸š</div>
                        </div>
                        <div class="col-md-4 text-end">
                            {% if has_permission('customer', 'create') %}
                            {% if current_user.role == 'admin' %}
                            <div class="btn-group">
                                {{ render_button('å¯¼å…¥æ•°æ®', '#', color='info', icon='fas fa-file-import', extra_class='dropdown-toggle', type='a') }}
                                <ul class="dropdown-menu">
                                    <li>{{ render_button('ğŸ“¥ å¯¼å…¥å®¢æˆ·', '#', color='info', icon='fas fa-upload', extra_class='dropdown-item', type='a') }}</li>
                                    <li>{{ render_button('ğŸ“¥ å¯¼å…¥è”ç³»äºº', '#', color='info', icon='fas fa-user-plus', extra_class='dropdown-item', type='a') }}</li>
                                </ul>
                            </div>
                            {% endif %}
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ç§»åŠ¨ç«¯å¡ç‰‡è§†å›¾ - ä»…åœ¨å°å±å¹•æ˜¾ç¤º -->
    <div class="d-block d-lg-none">
        {% if companies|length == 0 %}
        <div class="alert alert-info text-center">
            æš‚æ— å¯è§ä¼ä¸šæ•°æ®ã€‚{% if has_permission('customer', 'create') %}æ‚¨å¯ä»¥ç‚¹å‡»å³ä¸Šè§’"æ·»åŠ ä¼ä¸š"æ–°å»ºè‡ªå·±çš„å®¢æˆ·ã€‚{% endif %}
        </div>
        {% endif %}
        
        {% for company in companies %}
        <div class="card mb-3 shadow-sm">
            <div class="card-body p-3">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <span class="badge bg-info">{{ company.company_code }}</span>
                    <span class="badge {% if company.status == 'æ´»è·ƒ' %}bg-success{% else %}bg-secondary{% endif %}">
                        {{ company.status }}
                    </span>
                </div>
                <h5 class="card-title mb-2">
                    <a href="{{ url_for('customer.view_company', company_id=company.id) }}" class="text-decoration-none text-dark">
                        {{ company.company_name }}
                    </a>
                </h5>
                <div class="small text-muted mb-2">
                    {{ company.company_type }} Â· {{ company.industry }}
                </div>
                <div class="small mb-1">
                    <i class="fas fa-map-marker-alt text-secondary me-1"></i>
                    {{ country_code_to_name[company.country] if company.country in country_code_to_name else company.country }} {{ company.region }}
                </div>
                {% if company.address %}
                <div class="small mb-1">
                    <i class="fas fa-location-arrow text-secondary me-1"></i>{{ company.address }}
                </div>
                {% endif %}
                <div class="small text-muted mt-2">
                    <i class="fas fa-user me-1"></i>{{ render_owner(company.owner) }}
                    <span class="mx-1">Â·</span>
                    <i class="fas fa-clock me-1"></i>{{ render_date(company.updated_at) }}
                </div>
                {% if company.notes %}
                <div class="mt-2 small">
                    <i class="fas fa-sticky-note text-muted me-1"></i>{{ company.notes }}
                </div>
                {% endif %}
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- PCç«¯è¡¨æ ¼è§†å›¾ - ä»…åœ¨å¤§å±å¹•æ˜¾ç¤º -->
    <div class="card d-none d-lg-block">
        <div class="card-body p-0">
            {% if has_permission('customer', 'delete') %}
            <div class="d-flex justify-content-end align-items-center px-3 py-2">
                <button id="batchDeleteBtn" class="btn btn-danger" style="display: none;">
                    <i class="fas fa-trash"></i> æ‰¹é‡åˆ é™¤
                </button>
            </div>
            {% endif %}
            <div class="table-responsive">
                <table class="table table-striped table-hover align-middle" style="font-size: 14px;">
                    <thead>
                        <tr class="bg-light text-dark">
                            {% if has_permission('customer', 'delete') %}
                            <th class="px-3 py-3" style="width: 40px;">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="selectAll">
                                </div>
                            </th>
                            {% endif %}
                            <th class="px-3 py-3" style="min-width: 130px;">
                                <a href="{{ url_for('customer.list_companies', sort='company_code', order='asc' if sort_field == 'company_code' and sort_order == 'desc' else 'desc', search=search_term) }}" class="text-dark d-flex align-items-center {{ 'current-sort' if sort_field == 'company_code' }}">
                                    ä¼ä¸šä»£ç 
                                    {% if sort_field == 'company_code' %}
                                    <i class="fas fa-sort-{{ 'down' if sort_order == 'desc' else 'up' }} ms-1"></i>
                                    {% else %}
                                    <i class="fas fa-sort ms-1 text-muted"></i>
                                    {% endif %}
                                </a>
                            </th>
                            <th class="px-3 py-3" style="min-width: 200px;">
                                <a href="{{ url_for('customer.list_companies', sort='company_name', order='asc' if sort_field == 'company_name' and sort_order == 'desc' else 'desc', search=search_term) }}" class="text-dark d-flex align-items-center {{ 'current-sort' if sort_field == 'company_name' }}">
                                    ä¼ä¸šåç§°
                                    {% if sort_field == 'company_name' %}
                                    <i class="fas fa-sort-{{ 'down' if sort_order == 'desc' else 'up' }} ms-1"></i>
                                    {% else %}
                                    <i class="fas fa-sort ms-1 text-muted"></i>
                                    {% endif %}
                                </a>
                            </th>
                            <th class="px-3 py-3" style="min-width: 100px;">
                                <a href="{{ url_for('customer.list_companies', sort='company_type', order='asc' if sort_field == 'company_type' and sort_order == 'desc' else 'desc', search=search_term) }}" class="text-dark d-flex align-items-center {{ 'current-sort' if sort_field == 'company_type' }}">
                                    ä¼ä¸šç±»å‹
                                    {% if sort_field == 'company_type' %}
                                    <i class="fas fa-sort-{{ 'down' if sort_order == 'desc' else 'up' }} ms-1"></i>
                                    {% else %}
                                    <i class="fas fa-sort ms-1 text-muted"></i>
                                    {% endif %}
                                </a>
                            </th>
                            <th class="px-3 py-3" style="min-width: 100px;">
                                <a href="{{ url_for('customer.list_companies', sort='industry', order='asc' if sort_field == 'industry' and sort_order == 'desc' else 'desc', search=search_term) }}" class="text-dark d-flex align-items-center {{ 'current-sort' if sort_field == 'industry' }}">
                                    è¡Œä¸š
                                    {% if sort_field == 'industry' %}
                                    <i class="fas fa-sort-{{ 'down' if sort_order == 'desc' else 'up' }} ms-1"></i>
                                    {% else %}
                                    <i class="fas fa-sort ms-1 text-muted"></i>
                                    {% endif %}
                                </a>
                            </th>
                            <th class="px-3 py-3" style="min-width: 100px;">
                                <a href="{{ url_for('customer.list_companies', sort='country', order='asc' if sort_field == 'country' and sort_order == 'desc' else 'desc', search=search_term) }}" class="text-dark d-flex align-items-center {{ 'current-sort' if sort_field == 'country' }}">
                                    å›½å®¶/åœ°åŒº
                                    {% if sort_field == 'country' %}
                                    <i class="fas fa-sort-{{ 'down' if sort_order == 'desc' else 'up' }} ms-1"></i>
                                    {% else %}
                                    <i class="fas fa-sort ms-1 text-muted"></i>
                                    {% endif %}
                                </a>
                            </th>
                            <th class="px-3 py-3" style="min-width: 100px;">
                                <a href="{{ url_for('customer.list_companies', sort='region', order='asc' if sort_field == 'region' and sort_order == 'desc' else 'desc', search=search_term) }}" class="text-dark d-flex align-items-center {{ 'current-sort' if sort_field == 'region' }}">
                                    çœ/å·
                                    {% if sort_field == 'region' %}
                                    <i class="fas fa-sort-{{ 'down' if sort_order == 'desc' else 'up' }} ms-1"></i>
                                    {% else %}
                                    <i class="fas fa-sort ms-1 text-muted"></i>
                                    {% endif %}
                                </a>
                            </th>
                            <th class="px-3 py-3" style="min-width: 200px;">è¯¦ç»†åœ°å€</th>
                            <th class="px-3 py-3" style="min-width: 80px;">
                                <a href="{{ url_for('customer.list_companies', sort='status', order='asc' if sort_field == 'status' and sort_order == 'desc' else 'desc', search=search_term) }}" class="text-dark d-flex align-items-center {{ 'current-sort' if sort_field == 'status' }}">
                                    çŠ¶æ€
                                    {% if sort_field == 'status' %}
                                    <i class="fas fa-sort-{{ 'down' if sort_order == 'desc' else 'up' }} ms-1"></i>
                                    {% else %}
                                    <i class="fas fa-sort ms-1 text-muted"></i>
                                    {% endif %}
                                </a>
                            </th>
                            <th class="px-3 py-3" style="min-width: 200px;">å¤‡æ³¨</th>
                            <th class="px-3 py-3" style="min-width: 100px;">
                                <a href="{{ url_for('customer.list_companies', sort='owner_id', order='asc' if sort_field == 'owner_id' and sort_order == 'desc' else 'desc', search=search_term) }}" class="text-dark d-flex align-items-center {{ 'current-sort' if sort_field == 'owner_id' }}">
                                    æ‹¥æœ‰äºº
                                    {% if sort_field == 'owner_id' %}
                                    <i class="fas fa-sort-{{ 'down' if sort_order == 'desc' else 'up' }} ms-1"></i>
                                    {% else %}
                                    <i class="fas fa-sort ms-1 text-muted"></i>
                                    {% endif %}
                                </a>
                            </th>
                            <th class="px-3 py-3" style="min-width: 120px;">
                                <a href="{{ url_for('customer.list_companies', sort='updated_at', order='asc' if sort_field == 'updated_at' and sort_order == 'desc' else 'desc', search=search_term) }}" class="text-dark d-flex align-items-center {{ 'current-sort' if sort_field == 'updated_at' }}">
                                    æ›´æ–°æ—¶é—´
                                    {% if sort_field == 'updated_at' %}
                                    <i class="fas fa-sort-{{ 'down' if sort_order == 'desc' else 'up' }} ms-1"></i>
                                    {% else %}
                                    <i class="fas fa-sort ms-1 text-muted"></i>
                                    {% endif %}
                                </a>
                            </th>
                            <th class="px-3 py-3" style="min-width: 120px;">
                                <a href="{{ url_for('customer.list_companies', sort='created_at', order='asc' if sort_field == 'created_at' and sort_order == 'desc' else 'desc', search=search_term) }}" class="text-dark d-flex align-items-center {{ 'current-sort' if sort_field == 'created_at' }}">
                                    åˆ›å»ºæ—¶é—´
                                    {% if sort_field == 'created_at' %}
                                    <i class="fas fa-sort-{{ 'down' if sort_order == 'desc' else 'up' }} ms-1"></i>
                                    {% else %}
                                    <i class="fas fa-sort ms-1 text-muted"></i>
                                    {% endif %}
                                </a>
                            </th>
                        </tr>
                    </thead>
                    <tbody>
                        {% if companies|length == 0 %}
                        <tr>
                            <td colspan="100" class="text-center text-muted py-5">
                                æš‚æ— å¯è§ä¼ä¸šæ•°æ®ã€‚{% if has_permission('customer', 'create') %}æ‚¨å¯ä»¥ç‚¹å‡»å³ä¸Šè§’"æ·»åŠ ä¼ä¸š"æ–°å»ºè‡ªå·±çš„å®¢æˆ·ã€‚{% endif %}
                            </td>
                        </tr>
                        {% endif %}
                        {% for company in companies %}
                        <tr>
                            {% if has_permission('customer', 'delete') %}
                            <td class="px-3">
                                <div class="form-check">
                                    <input class="form-check-input company-checkbox" type="checkbox" value="{{ company.id }}" 
                                           {% if company.owner_id != current_user.id and current_user.role != 'admin' %}disabled{% endif %}>
                                </div>
                            </td>
                            {% endif %}
                            <td class="px-3"><span class="badge bg-info">{{ company.company_code }}</span></td>
                            <td class="px-3">
                                <a href="{{ url_for('customer.view_company', company_id=company.id) }}" class="text-decoration-none">
                                    {{ company.company_name }}
                                </a>
                            </td>
                            <td class="px-3">{{ company.company_type }}</td>
                            <td class="px-3">{{ company.industry }}</td>
                            <td class="px-3">{{ country_code_to_name[company.country] if company.country in country_code_to_name else company.country }}</td>
                            <td class="px-3">{{ company.region }}</td>
                            <td class="px-3">{{ company.address }}</td>
                            <td class="px-3">
                                <span class="badge {% if company.status == 'æ´»è·ƒ' %}bg-success{% else %}bg-secondary{% endif %}">
                                    {{ company.status }}
                                </span>
                            </td>
                            <td class="px-3">{{ company.notes }}</td>
                            <td class="px-3">{{ render_owner(company.owner) }}</td>
                            <td class="px-3">{{ render_date(company.updated_at) }}</td>
                            <td class="px-3">{{ render_date(company.created_at) }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- æ·»åŠ Font Awesomeå›¾æ ‡åº“ -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">

<!-- æ·»åŠ è‡ªå®šä¹‰æ ·å¼ -->
<style>
    /* è¡¨æ ¼åŸºç¡€æ ·å¼ - åº”ç”¨äºæ‰€æœ‰è¡¨æ ¼å•å…ƒæ ¼ */
    .table th,
    .table td {
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: 200px;
        position: relative;
        vertical-align: middle !important;
        height: 50px;
        padding: 0.5rem 0.75rem;
    }
    
    /* ç»Ÿä¸€è¡¨å¤´æ ·å¼å’Œå‚ç›´å¯¹é½ */
    .table th {
        font-weight: 600;
        background-color: #f8f9fa;
        position: relative;
        vertical-align: middle !important;
        height: 55px;
        padding: 0.5rem 0.75rem;
    }
    
    /* è°ƒæ•´ä¼ä¸šä»£ç å¾½ç« æ ·å¼ï¼Œç¡®ä¿æ°´å¹³å¯¹é½ */
    .table td .badge {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        min-width: 70px;
        height: 24px;
        margin: 0;
        vertical-align: middle;
    }
    
    /* æ’åºè¡¨å¤´æ ·å¼ */
    .table th a.text-dark {
        text-decoration: none;
        display: flex;
        align-items: center;
        height: 100%;
        color: #333 !important;
    }
    
    .table th a.text-dark:hover {
        color: #0d6efd !important;
    }
    
    .table th a.current-sort {
        color: #0d6efd !important;
        font-weight: 700;
    }
    
    .table th a.current-sort i {
        color: #0d6efd !important;
    }
    
    /* ç»Ÿä¸€æ’åºå›¾æ ‡æ ·å¼ */
    .fa-sort, .fa-sort-up, .fa-sort-down {
        margin-left: 5px;
        width: 10px;
        text-align: center;
    }

    /* ç¡®ä¿æ‰€æœ‰è¡¨å¤´åˆ—å¯¹é½ä¸€è‡´ */
    .table thead tr th {
        border-bottom: 2px solid #dee2e6;
        vertical-align: middle !important;
    }
    
    .table-responsive {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
        position: relative;
    }
    
    .btn-group-sm > .btn {
        padding: .25rem .5rem;
    }
    
    /* è¡¨æ ¼è¡Œæ ·å¼ */
    .table tr {
        height: 50px;
    }
    
    /* ç¦ç”¨æŒ‰é’®æ ·å¼ */
    .btn.disabled, .btn:disabled {
        opacity: 0.4;
        cursor: not-allowed;
        pointer-events: all !important;
    }
    
    /* ç¦ç”¨æŒ‰é’®æ‚¬åœæç¤º */
    [title] {
        position: relative;
    }

    /* æ— æƒé™ä¼ä¸šæ ·å¼ */
    .no-permission-company {
        opacity: 0.85;
        background-color: #f8f9fa;
    }
    
    .no-permission-company:hover {
        background-color: #f0f0f0;
    }
    
    /* ä¸‹æ‹‰èœå•æ ·å¼ä¼˜åŒ– */
    .dropdown-menu.show {
        display: block;
        margin-top: 2px;
        border-radius: 0.375rem;
        border: 1px solid rgba(0,0,0,0.1);
        box-shadow: 0 0.25rem 0.75rem rgba(0,0,0,0.12);
        z-index: 1000;
        width: 100%;
        left: 0 !important;
    }
    
    .dropdown-item {
        padding: 0.625rem 1rem;
        border-bottom: 1px solid #f0f0f0;
        white-space: normal;
        line-height: 1.4;
    }
    
    .dropdown-item:last-child {
        border-bottom: none;
    }
    
    .dropdown-item.text-muted {
        cursor: not-allowed;
        background-color: #f8f9fa;
    }
    
    .dropdown-item:not(.text-muted):hover {
        background-color: #e9ecef;
    }
    
    /* æœç´¢æ¡†æ ·å¼ä¼˜åŒ– */
    #companySearch, #contactSearch {
        padding-right: 2.5rem;
        height: calc(1.5em + 0.75rem + 2px);
    }
    
    .search-icon {
        cursor: pointer;
        color: #6c757d;
        transition: color 0.15s ease-in-out;
    }
    
    .search-icon:hover {
        color: #495057;
    }

    .company-search-item {
        padding: 8px 12px;
        border-bottom: 1px solid #eee;
        color: #6c757d;
        cursor: pointer; /* æ›´æ”¹ä¸ºæŒ‡é’ˆå…‰æ ‡ï¼Œè¡¨ç¤ºå¯ç‚¹å‡» */
    }
    .company-search-item:hover {
        background-color: #f8f9fa;
    }
    .company-name {
        font-weight: 500;
        display: inline;
        font-size: 0.9em;
    }
    .company-location, .company-owner {
        color: #6c757d;
        font-size: 0.8em;
        display: inline;
        margin-left: 3px;
    }
    .reference-notice {
        font-size: 0.85em;
        color: #6c757d;
        padding: 8px 12px;
        border-top: 1px dashed #dee2e6;
        background-color: #f8f9fa;
        font-weight: 500;
        text-align: center;
    }
    .reference-badge {
        font-size: 0.7em;
        padding: 0.2em 0.4em;
        background-color: #6c757d;
        color: white;
        border-radius: 0.25rem;
        margin-right: 5px;
    }
    .suggestions-header {
        padding: 8px 12px;
        background-color: #e9ecef;
        font-size: 0.9em;
        color: #495057;
        font-weight: 500;
        text-align: center;
        border-bottom: 1px solid #dee2e6;
    }
</style>

<!-- é¡µé¢æœ€åº•éƒ¨ï¼Œæ·»åŠ å¯¼å…¥æ¨¡æ€æ¡† -->
<!-- å®¢æˆ·å¯¼å…¥æ¨¡æ€æ¡† -->
<div class="modal fade" id="importCustomerModal" tabindex="-1" aria-labelledby="importCustomerModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="importCustomerModalLabel">å¯¼å…¥å®¢æˆ·æ•°æ®</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="importCustomerForm" enctype="multipart/form-data">
                    <div class="mb-3">
                        <label for="ownerSelect" class="form-label">è¯·é€‰æ‹©å½’å±è´¦æˆ· <span class="text-danger">*</span></label>
                        <select class="form-select" id="ownerSelect" name="owner_id" required>
                            <option value="">è¯·é€‰æ‹©...</option>
                            <!-- é€‰é¡¹ä¼šé€šè¿‡JavaScriptåŠ¨æ€åŠ è½½ -->
                        </select>
                        <div class="form-text">æ‰€æœ‰å¯¼å…¥çš„å®¢æˆ·å°†å½’å±äºè¯¥è´¦æˆ·</div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="excelFile" class="form-label">ä¸Šä¼ Excelæ–‡ä»¶ (.xlsxæˆ–.xls) <span class="text-danger">*</span></label>
                        <input class="form-control" type="file" id="excelFile" name="excelFile" accept=".xlsx, .xls" required>
                        <div class="form-text">è¯·ä¸Šä¼ åŒ…å«å®¢æˆ·æ•°æ®çš„Excelæ–‡ä»¶ï¼Œç³»ç»Ÿå°†æŸ¥æ‰¾åä¸º"customer database"çš„å·¥ä½œè¡¨è¿›è¡Œå¯¼å…¥</div>
                    </div>
                    
                    <div class="alert alert-info">
                        <h6 class="alert-heading">å¯¼å…¥è¯´æ˜:</h6>
                        <p class="mb-0">ç³»ç»Ÿå°†æŒ‰ä»¥ä¸‹å­—æ®µæ˜ å°„å¯¼å…¥æ•°æ®:</p>
                        <ul class="mb-0">
                            <li>å…¬å¸åç§° â†’ ä¼ä¸šåç§°</li>
                            <li>å›½å®¶å’Œåœ°åŒº â†’ å›½å®¶/åœ°åŒº</li>
                            <li>åŸå¸‚ â†’ çœä»½/åŸå¸‚</li>
                            <li>å•ä½åœ°å€ â†’ è¯¦ç»†åœ°å€</li>
                            <li>ç§ç±» â†’ ä¼ä¸šç±»å‹</li>
                            <li>çŠ¶æ€ â†’ çŠ¶æ€ï¼ˆé»˜è®¤ä¸º"æ´»è·ƒ"ï¼‰</li>
                            <li>å¤‡æ³¨ â†’ å¤‡æ³¨ï¼ˆå¦‚ä¸º"none"åˆ™å¯¼å…¥ä¸ºç©ºï¼‰</li>
                            <li>åˆ›å»ºæ—¶é—´ â†’ åˆ›å»ºæ—¶é—´ï¼ˆä¿ç•™åŸå§‹åˆ›å»ºæ—¥æœŸï¼Œå¯¼å…¥æ—¶é—´å°†è®°å½•åœ¨"æ›´æ–°æ—¶é—´"å­—æ®µï¼‰</li>
                        </ul>
                    </div>
                </form>
                
                <div id="importPreview" class="mt-3" style="display: none;">
                    <h6>æ•°æ®é¢„è§ˆ:</h6>
                    <div class="table-responsive">
                        <table class="table table-sm table-bordered" id="previewTable">
                            <thead>
                                <tr>
                                    <th>ä¼ä¸šåç§°</th>
                                    <th>å›½å®¶/åœ°åŒº</th>
                                    <th>çœä»½/åŸå¸‚</th>
                                    <th>è¯¦ç»†åœ°å€</th>
                                    <th>ä¼ä¸šç±»å‹</th>
                                    <th>åˆ›å»ºæ—¶é—´</th>
                                </tr>
                            </thead>
                            <tbody id="previewTableBody">
                                <!-- é¢„è§ˆæ•°æ®ä¼šåŠ¨æ€åŠ è½½ -->
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <div id="importConflicts" class="mt-3" style="display: none;">
                    <h6 class="text-warning">å‘ç°å¯èƒ½çš„é‡å¤ä¼ä¸š:</h6>
                    <div class="alert alert-info mb-2">
                        <strong>æ™ºèƒ½æ¨è:</strong> ç³»ç»Ÿä¼šæ ¹æ®ç›¸ä¼¼åº¦è‡ªåŠ¨æ¨èæ“ä½œ:
                        <ul class="mb-0">
                            <li>ç›¸ä¼¼åº¦ â‰¥ 80% çš„ä¼ä¸š: <span class="badge bg-secondary">å»ºè®®è·³è¿‡</span></li>
                            <li>ç›¸ä¼¼åº¦ < 80% çš„ä¼ä¸š: <span class="badge bg-primary">å»ºè®®å¯¼å…¥</span> ä¸ºæ–°ç”¨æˆ·</li>
                        </ul>
                        <div class="mt-2" id="conflictsSummary"></div>
                    </div>
                    <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                        <table class="table table-sm table-bordered table-hover" id="conflictsTable">
                            <thead class="sticky-top bg-light">
                                <tr>
                                    <th style="width: 120px;">æ“ä½œ</th>
                                    <th>å¯¼å…¥ä¼ä¸šåç§°</th>
                                    <th>å·²å­˜åœ¨ä¼ä¸šåç§°</th>
                                    <th style="width: 150px;">ç›¸ä¼¼åº¦</th>
                                </tr>
                            </thead>
                            <tbody id="conflictsTableBody">
                                <!-- å†²çªæ•°æ®ä¼šåŠ¨æ€åŠ è½½ -->
                            </tbody>
                        </table>
                    </div>
                    <div class="d-flex flex-wrap justify-content-between align-items-center mt-3">
                        <div class="mb-2">
                            <span class="text-muted">æ‰¹é‡æ“ä½œ:</span>
                        </div>
                        <div class="mb-2">
                            <button type="button" class="btn btn-outline-primary btn-sm me-2" id="applyRecommendedActions">
                                <i class="fas fa-magic"></i> åº”ç”¨æ™ºèƒ½æ¨è
                            </button>
                            <button type="button" class="btn btn-outline-success btn-sm me-2" id="keepAllConflicts">
                                <i class="fas fa-plus"></i> å…¨éƒ¨å¯¼å…¥ä¸ºæ–°ç”¨æˆ·
                            </button>
                            <button type="button" class="btn btn-outline-secondary btn-sm" id="ignoreAllConflicts">
                                <i class="fas fa-times"></i> å…¨éƒ¨å¿½ç•¥ä¸å¯¼å…¥
                            </button>
                        </div>
                    </div>
                </div>
                
                <div id="importProgress" class="progress mt-3" style="display: none;">
                    <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%"></div>
                </div>
                
                <div id="importResult" class="alert mt-3" style="display: none;"></div>
                
                <!-- æ·»åŠ é”™è¯¯è¯¦æƒ…åŒºåŸŸ -->
                <div id="importErrorDetails" class="mt-3" style="display: none;">
                    <h6 class="text-danger">å¯¼å…¥é”™è¯¯è¯¦æƒ…:</h6>
                    <div class="table-responsive" style="max-height: 300px; overflow-y: auto;">
                        <table class="table table-sm table-bordered table-hover">
                            <thead class="sticky-top bg-light">
                                <tr>
                                    <th>ä¼ä¸šåç§°</th>
                                    <th>é”™è¯¯åŸå› </th>
                                </tr>
                            </thead>
                            <tbody id="errorDetailsTableBody">
                                <!-- é”™è¯¯è¯¦æƒ…ä¼šåŠ¨æ€åŠ è½½ -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                <button type="button" class="btn btn-primary" id="parseExcelBtn">è§£ææ–‡ä»¶</button>
                <button type="button" class="btn btn-success" id="importBtn" style="display: none;">ç¡®è®¤å¯¼å…¥</button>
            </div>
        </div>
    </div>
</div>

<!-- è”ç³»äººå¯¼å…¥æ¨¡æ€æ¡† -->
<div class="modal fade" id="importContactModal" tabindex="-1" aria-labelledby="importContactModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="importContactModalLabel">å¯¼å…¥è”ç³»äººæ•°æ®</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="importContactForm" enctype="multipart/form-data">
                    <div class="mb-3">
                        <label for="contactOwnerSelect" class="form-label">è¯·é€‰æ‹©å½’å±è´¦æˆ· <span class="text-danger">*</span></label>
                        <select class="form-select" id="contactOwnerSelect" name="owner_id" required>
                            <option value="">è¯·é€‰æ‹©...</option>
                            <!-- é€‰é¡¹ä¼šé€šè¿‡JavaScriptåŠ¨æ€åŠ è½½ -->
                        </select>
                        <div class="form-text">æ‰€æœ‰å¯¼å…¥çš„è”ç³»äººå°†å½’å±äºè¯¥è´¦æˆ·</div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="contactExcelFile" class="form-label">ä¸Šä¼ Excelæ–‡ä»¶ (.xlsxæˆ–.xls) <span class="text-danger">*</span></label>
                        <input class="form-control" type="file" id="contactExcelFile" name="contactExcelFile" accept=".xlsx, .xls" required>
                        <div class="form-text">è¯·ä¸Šä¼ åŒ…å«è”ç³»äººæ•°æ®çš„Excelæ–‡ä»¶ï¼Œç³»ç»Ÿå°†æŸ¥æ‰¾åä¸º"contact database"çš„å·¥ä½œè¡¨è¿›è¡Œå¯¼å…¥</div>
                    </div>
                    
                    <div class="alert alert-info">
                        <h6 class="alert-heading">å¯¼å…¥è¯´æ˜:</h6>
                        <p class="mb-0">ç³»ç»Ÿå°†æŒ‰ä»¥ä¸‹å­—æ®µæ˜ å°„å¯¼å…¥æ•°æ®:</p>
                        <ul class="mb-0">
                            <li>å…¬å¸åç§° â†’ æ‰€å±ä¼ä¸šï¼ˆå¿…é¡»åœ¨ç³»ç»Ÿä¸­å­˜åœ¨ï¼Œç”¨äºåŒ¹é…ä¼ä¸šï¼‰</li>
                            <li>è”ç³»äºº â†’ å§“å</li>
                            <li>éƒ¨é—¨ â†’ éƒ¨é—¨</li>
                            <li>èŒä½ â†’ èŒä½</li>
                            <li>è”ç³»ç”µè¯ â†’ ç”µè¯</li>
                            <li>é‚®ä»¶ä¿¡ç®± â†’ é‚®ç®±</li>
                            <li>åˆ›å»ºæ—¶é—´ â†’ åˆ›å»ºæ—¶é—´ï¼ˆä¿ç•™åŸå§‹åˆ›å»ºæ—¥æœŸï¼Œå¯¼å…¥æ—¶é—´å°†è®°å½•åœ¨"æ›´æ–°æ—¶é—´"å­—æ®µï¼‰</li>
                        </ul>
                    </div>
                </form>
                
                <div id="contactImportPreview" class="mt-3" style="display: none;">
                    <h6>æ•°æ®é¢„è§ˆ:</h6>
                    <div class="alert alert-info mb-2" id="contactImportStats">
                        <div class="d-flex justify-content-between">
                            <div>
                                <strong>å¯¼å…¥ç»Ÿè®¡:</strong>
                                <ul class="mb-0 mt-1">
                                    <li>å…±<span id="totalContactsCount" class="fw-bold text-primary">0</span>æ¡è”ç³»äººè®°å½•</li>
                                    <li>å…¶ä¸­<span id="companyNotFoundCount" class="fw-bold text-danger">0</span>æ¡è”ç³»äººæ— æ³•æ‰¾åˆ°åŒ¹é…ä¼ä¸š</li>
                                </ul>
                            </div>
                            <div>
                                <span class="text-muted small">ä»…æ˜¾ç¤ºå‰5æ¡è®°å½•ï¼Œå®é™…å¯¼å…¥å…¨éƒ¨è®°å½•</span>
                            </div>
                        </div>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-sm table-bordered" id="contactPreviewTable">
                            <thead>
                                <tr>
                                    <th>å…¬å¸åç§°</th>
                                    <th>å§“å</th>
                                    <th>éƒ¨é—¨</th>
                                    <th>èŒä½</th>
                                    <th>ç”µè¯</th>
                                    <th>é‚®ç®±</th>
                                    <th>åˆ›å»ºæ—¶é—´</th>
                                </tr>
                            </thead>
                            <tbody id="contactPreviewTableBody">
                                <!-- é¢„è§ˆæ•°æ®ä¼šåŠ¨æ€åŠ è½½ -->
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <div id="contactImportConflicts" class="mt-3" style="display: none;">
                    <h6 class="text-warning">å‘ç°å¯èƒ½çš„é‡å¤è”ç³»äºº:</h6>
                    <div class="alert alert-info mb-2">
                        <strong>æç¤º:</strong> ç³»ç»Ÿå·²æ ¹æ®å§“åæ£€æµ‹å¯èƒ½çš„é‡å¤è”ç³»äººï¼Œè¯·é€‰æ‹©å¤„ç†æ–¹å¼:
                        <ul class="mb-0">
                            <li><span class="badge bg-primary">è¦†ç›–</span>: ä½¿ç”¨æ–°æ•°æ®æ›´æ–°å·²å­˜åœ¨çš„è”ç³»äºº</li>
                            <li><span class="badge bg-success">ä¿ç•™</span>: è·³è¿‡å·²å­˜åœ¨çš„è”ç³»äººï¼Œä¸å¯¼å…¥</li>
                        </ul>
                        <div class="mt-2" id="contactConflictsSummary"></div>
                    </div>
                    <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                        <table class="table table-sm table-bordered table-hover" id="contactConflictsTable">
                            <thead class="sticky-top bg-light">
                                <tr>
                                    <th style="width: 120px;">æ“ä½œ</th>
                                    <th>å¯¼å…¥è”ç³»äººå§“å</th>
                                    <th>æ‰€å±ä¼ä¸š</th>
                                    <th>å·²å­˜åœ¨è”ç³»äººå§“å</th>
                                </tr>
                            </thead>
                            <tbody id="contactConflictsTableBody">
                                <!-- å†²çªæ•°æ®ä¼šåŠ¨æ€åŠ è½½ -->
                            </tbody>
                        </table>
                    </div>
                    <div class="d-flex flex-wrap justify-content-between align-items-center mt-3">
                        <div class="mb-2">
                            <span class="text-muted">æ‰¹é‡æ“ä½œ:</span>
                        </div>
                        <div class="mb-2">
                            <button type="button" class="btn btn-outline-primary btn-sm me-2" id="overrideAllConflicts">
                                <i class="fas fa-sync-alt"></i> å…¨éƒ¨è¦†ç›–
                            </button>
                            <button type="button" class="btn btn-outline-success btn-sm" id="keepAllContactConflicts">
                                <i class="fas fa-check"></i> å…¨éƒ¨ä¿ç•™ç°æœ‰æ•°æ®
                            </button>
                        </div>
                    </div>
                </div>
                
                <div id="contactImportProgress" class="progress mt-3" style="display: none;">
                    <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%"></div>
                </div>
                
                <div id="contactImportResult" class="alert mt-3" style="display: none;"></div>
                
                <!-- æ·»åŠ å…¬å¸ä¸å­˜åœ¨æç¤ºåŒºåŸŸ -->
                <div id="companyNotFoundDetails" class="mt-3" style="display: none;">
                    <div class="alert alert-warning">
                        <h6 class="alert-heading"><i class="fas fa-exclamation-triangle"></i> è­¦å‘Šï¼šæœªæ‰¾åˆ°åŒ¹é…ä¼ä¸š</h6>
                        <p class="mb-0">ä»¥ä¸‹è”ç³»äººæ— æ³•å¯¼å…¥ï¼Œå› ä¸ºç³»ç»Ÿä¸­æ‰¾ä¸åˆ°ä¸ä¹‹å…³è”çš„ä¼ä¸šåç§°ã€‚è¯·å…ˆåœ¨ç³»ç»Ÿä¸­æ·»åŠ è¿™äº›ä¼ä¸šï¼Œæˆ–ç¡®ä¿ä¼ä¸šåç§°å®Œå…¨åŒ¹é…ã€‚</p>
                    </div>
                    <div class="table-responsive" style="max-height: 300px; overflow-y: auto;">
                        <table class="table table-sm table-bordered table-hover">
                            <thead class="sticky-top bg-light">
                                <tr>
                                    <th>è”ç³»äººå§“å</th>
                                    <th>å…¬å¸åç§°</th>
                                    <th>åŸå› </th>
                                </tr>
                            </thead>
                            <tbody id="companyNotFoundTableBody">
                                <!-- å…¬å¸åŒ¹é…å¤±è´¥è¯¦æƒ…ä¼šåŠ¨æ€åŠ è½½ -->
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- æ·»åŠ é”™è¯¯è¯¦æƒ…åŒºåŸŸ -->
                <div id="contactImportErrorDetails" class="mt-3" style="display: none;">
                    <h6 class="text-danger">å¯¼å…¥é”™è¯¯è¯¦æƒ…:</h6>
                    <div class="table-responsive" style="max-height: 300px; overflow-y: auto;">
                        <table class="table table-sm table-bordered table-hover">
                            <thead class="sticky-top bg-light">
                                <tr>
                                    <th>è”ç³»äººå§“å</th>
                                    <th>å…¬å¸åç§°</th>
                                    <th>é”™è¯¯åŸå› </th>
                                </tr>
                            </thead>
                            <tbody id="contactErrorDetailsTableBody">
                                <!-- é”™è¯¯è¯¦æƒ…ä¼šåŠ¨æ€åŠ è½½ -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                <button type="button" class="btn btn-primary" id="parseContactExcelBtn">è§£ææ–‡ä»¶</button>
                <button type="button" class="btn btn-success" id="importContactBtn" style="display: none;">ç¡®è®¤å¯¼å…¥</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[title]'));
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });
    
    // åˆå§‹åŒ–ä¼ä¸šæœç´¢è‡ªåŠ¨å®Œæˆ
    initCompanySearch();
    
    // åˆå§‹åŒ–è”ç³»äººæœç´¢è‡ªåŠ¨å®Œæˆ
    initContactSearch();

    // å¯¼å…¥å®¢æˆ·åŠŸèƒ½
    const importCustomersBtn = document.getElementById('importCustomers');
    const importModal = new bootstrap.Modal(document.getElementById('importCustomerModal'));
    const ownerSelect = document.getElementById('ownerSelect');
    const excelFileInput = document.getElementById('excelFile');
    const parseExcelBtn = document.getElementById('parseExcelBtn');
    const importBtn = document.getElementById('importBtn');
    const previewDiv = document.getElementById('importPreview');
    const conflictsDiv = document.getElementById('importConflicts');
    const progressDiv = document.getElementById('importProgress');
    const resultDiv = document.getElementById('importResult');
    const skipAllConflictsBtn = document.getElementById('skipAllConflicts');
    const ignoreAllConflictsBtn = document.getElementById('ignoreAllConflicts');
    
    let parsedData = [];
    let unmatchedCustomers = [];
    let userNameToId = {};
    let conflicts = [];
    let conflictActions = {};
    
    // åŠ è½½ç”¨æˆ·åˆ—è¡¨ï¼ˆåˆ†ç»„+çœŸå®å§“åï¼‰
    function loadUsers(selectElement) {
        fetch('/api/users/hierarchical', {
            headers: {
                'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').content
            }
        })
            .then(response => response.json())
            .then(data => {
            selectElement.innerHTML = '<option value="">è¯·é€‰æ‹©...</option>';
            if (data.success) {
                data.data.forEach(company => {
                    const companyOptgroup = document.createElement('optgroup');
                    companyOptgroup.label = company.name + ' (ä¼ä¸š)';
                    company.users.forEach(user => {
                    const option = document.createElement('option');
                    option.value = user.id;
                        option.textContent = user.name;
                        companyOptgroup.appendChild(option);
                });
                    selectElement.appendChild(companyOptgroup);
                });
            }
            })
            .catch(error => console.error('åŠ è½½ç”¨æˆ·å¤±è´¥:', error));
    }
    
    // æ‰“å¼€å¯¼å…¥æ¨¡æ€æ¡†
    if (importCustomersBtn) {
        importCustomersBtn.addEventListener('click', function(e) {
            e.preventDefault();
            
            // é‡ç½®çŠ¶æ€
            document.getElementById('importCustomerForm').reset();
            previewDiv.style.display = 'none';
            conflictsDiv.style.display = 'none';
            progressDiv.style.display = 'none';
            resultDiv.style.display = 'none';
            importBtn.style.display = 'none';
            parsedData = [];
            unmatchedCustomers = [];
            userNameToId = {};
            conflicts = [];
            conflictActions = {};
            
            // åŠ è½½ç”¨æˆ·åˆ—è¡¨ï¼ˆåˆ†ç»„+çœŸå®å§“åï¼‰
            loadUsers(ownerSelect);
            
            // æ˜¾ç¤ºæ¨¡æ€æ¡†
            importModal.show();
        });
    }
    
    // è§£æExcelæ–‡ä»¶
    if (parseExcelBtn) {
        parseExcelBtn.addEventListener('click', function() {
            const fileInput = document.getElementById('excelFile');
            const ownerIdSelect = document.getElementById('ownerSelect');
            unmatchedCustomers = [];
            // ç§»é™¤æ­¤å¤„çš„"è¯·é€‰æ‹©å½’å±è´¦æˆ·"å¼ºåˆ¶æ ¡éªŒ
            // if (!ownerIdSelect.value) {
            //     alert('è¯·é€‰æ‹©å½’å±è´¦æˆ·');
            //     return;
            // }
            if (!fileInput.files.length) {
                alert('è¯·é€‰æ‹©Excelæ–‡ä»¶');
                return;
            }
            
            const file = fileInput.files[0];
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {type: 'array'});
                    
                    // æŸ¥æ‰¾customer databaseå·¥ä½œè¡¨
                    const sheetName = workbook.SheetNames.find(name => 
                        name.toLowerCase().includes('customer database'));
                    
                    if (!sheetName) {
                        alert('æœªæ‰¾åˆ°åä¸º"customer database"çš„å·¥ä½œè¡¨');
                        return;
                    }
                    
                    const worksheet = workbook.Sheets[sheetName];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet);
                    
                    if (jsonData.length === 0) {
                        alert('å·¥ä½œè¡¨ä¸­æœªæ‰¾åˆ°æ•°æ®');
                        return;
                    }
                    
                    // å¤„ç†æ•°æ®
                    parsedData = [];
                    unmatchedCustomers = [];
                    jsonData.forEach(row => {
                        console.log("è§£æè¡Œæ•°æ®:", row);
                        let createdAt = null;
                        
                        // å°è¯•è§£æåˆ›å»ºæ—¶é—´
                        if (row['åˆ›å»ºæ—¶é—´']) {
                            try {
                                // å¢å¼ºæ—¥æœŸæ ¼å¼å¤„ç†
                                let dateValue = row['åˆ›å»ºæ—¶é—´'];
                                console.log("åŸå§‹Excelæ—¥æœŸå€¼:", dateValue, "ç±»å‹:", typeof dateValue);
                                
                                // æ£€æŸ¥æ˜¯å¦ä¸ºExcelæ•°å€¼æ—¥æœŸï¼ˆè‡ª1900å¹´ä»¥æ¥çš„å¤©æ•°ï¼‰
                                if (typeof dateValue === 'number' || (typeof dateValue === 'string' && !isNaN(dateValue) && dateValue.trim() !== '')) {
                                    // å°è¯•å°†Excelæ•°å€¼æ—¥æœŸè½¬æ¢ä¸ºJSæ—¥æœŸ
                                    // Excelæ—¥æœŸæ˜¯ä»1900å¹´1æœˆ1æ—¥èµ·çš„å¤©æ•°ï¼Œä½†Excelæœ‰ä¸€ä¸ªé”™è¯¯ï¼Œè®¤ä¸º1900æ˜¯é—°å¹´
                                    // æ‰€ä»¥æˆ‘ä»¬éœ€è¦å‡å»1ï¼ˆé’ˆå¯¹1900å¹´2æœˆ28æ—¥ä¹‹åçš„æ—¥æœŸï¼‰
                                    let excelDateValue = parseFloat(dateValue);
                                    if (excelDateValue > 59) { // 1900å¹´2æœˆ28æ—¥ä¹‹å
                                        excelDateValue -= 1;
                                    }
                                    // å°†Excelæ—¥æœŸè½¬æ¢ä¸ºJavaScriptæ—¥æœŸ
                                    const millisecondsPerDay = 24 * 60 * 60 * 1000;
                                    let jsDate = new Date(Date.UTC(1900, 0, 1) + excelDateValue * millisecondsPerDay);
                                    if (jsDate.toString() !== 'Invalid Date') {
                                        createdAt = jsDate;
                                        console.log("ä»Excelæ•°å€¼è½¬æ¢:", dateValue, "->", createdAt);
                                    }
                                } else if (typeof dateValue === 'string') {
                                    // å°è¯•å¸¸è§æ—¥æœŸæ ¼å¼
                                    createdAt = new Date(dateValue);
                                    if (createdAt.toString() === 'Invalid Date') {
                                        // å°è¯•è§£æDD/MM/YYYYæ ¼å¼
                                        const parts = dateValue.split(/[\/-]/);
                                        if (parts.length === 3) {
                                            // å°è¯•DD/MM/YYYY
                                            if (parts[0].length <= 2 && parts[1].length <= 2) {
                                                createdAt = new Date(parts[2], parts[1]-1, parts[0]);
                                            }
                                            // å°è¯•MM/DD/YYYY
                                            else if (parts[1].length <= 2 && parts[0].length <= 2) {
                                                createdAt = new Date(parts[2], parts[0]-1, parts[1]);
                                            }
                                            // å°è¯•YYYY/MM/DD
                                            else if (parts[0].length === 4) {
                                                createdAt = new Date(parts[0], parts[1]-1, parts[2]);
                                            }
                                            console.log("ä»åˆ†å‰²æ ¼å¼è½¬æ¢:", dateValue, "->", createdAt);
                                        }
                                    }
                                }
                                
                                if (createdAt && createdAt.toString() !== 'Invalid Date') {
                                    console.log("æœ€ç»ˆè§£æåçš„æ—¥æœŸ:", createdAt, "ISOæ ¼å¼:", createdAt.toISOString());
                                } else {
                                    console.error("æ— æ³•è§£ææ—¥æœŸï¼Œä½¿ç”¨å½“å‰æ—¶é—´");
                                    createdAt = new Date();
                                }
                            } catch (e) {
                                console.error("åˆ›å»ºæ—¶é—´è§£æé”™è¯¯:", e);
                                createdAt = new Date();
                            }
                        } else {
                            createdAt = new Date();
                        }
                        
                        let ownerId = ownerIdSelect.value;
                        let salesName = row['é”€å”®è´Ÿè´£äºº'] ? String(row['é”€å”®è´Ÿè´£äºº']).trim() : '';
                        if (!ownerId) {
                            if (salesName && userNameToId[salesName]) {
                                ownerId = userNameToId[salesName];
                            } else {
                                unmatchedCustomers.push({company_name: row['å…¬å¸åç§°'] || '', sales_name: salesName});
                                return;
                            }
                        }
                        
                        parsedData.push({
                            company_name: row['å…¬å¸åç§°'] || '',
                            country: row['å›½å®¶å’Œåœ°åŒº'] ? (row['å›½å®¶å’Œåœ°åŒº'].toString().toLowerCase() === 'none' ? '' : row['å›½å®¶å’Œåœ°åŒº']) : '',
                            city: row['åŸå¸‚'] ? (row['åŸå¸‚'].toString().toLowerCase() === 'none' ? '' : row['åŸå¸‚']) : '',
                            address: row['å•ä½åœ°å€'] ? (row['å•ä½åœ°å€'].toString().toLowerCase() === 'none' ? '' : row['å•ä½åœ°å€']) : '',
                            company_type: row['ç§ç±»'] ? (row['ç§ç±»'].toString().toLowerCase() === 'none' ? '' : row['ç§ç±»']) : '',
                            created_at: createdAt.toISOString(),
                            status: row['çŠ¶æ€'] ? (row['çŠ¶æ€'].toString().toLowerCase() === 'none' ? 'æ´»è·ƒ' : row['çŠ¶æ€']) : 'æ´»è·ƒ',
                            notes: row['å¤‡æ³¨'] ? (row['å¤‡æ³¨'].toString().toLowerCase() === 'none' ? '' : row['å¤‡æ³¨']) : '',
                            owner_id: parseInt(ownerId)
                        });
                    });
                    
                    // æ˜¾ç¤ºé¢„è§ˆ
                    const previewBody = document.getElementById('previewTableBody');
                    previewBody.innerHTML = '';
                    
                    parsedData.slice(0, 5).forEach(item => {
                        const row = document.createElement('tr');
                        // ç¡®ä¿æ˜¾ç¤ºç©ºå­—ç¬¦ä¸²è€Œä¸æ˜¯'none'æˆ–undefined
                        const displayValue = (val) => {
                            if (val === undefined || val === null || val === 'none' || (val.toString && val.toString().toLowerCase() === 'none')) {
                                return '';
                            }
                            return val;
                        };
                        
                        row.innerHTML = `
                            <td>${displayValue(item.company_name)}</td>
                            <td>${displayValue(item.country)}</td>
                            <td>${displayValue(item.city)}</td>
                            <td>${displayValue(item.address)}</td>
                            <td>${displayValue(item.company_type)}</td>
                            <td>${item.created_at ? new Date(item.created_at).toLocaleString('zh-CN') : ''}</td>
                        `;
                        previewBody.appendChild(row);
                    });
                    
                    if (parsedData.length > 5) {
                        const row = document.createElement('tr');
                        row.innerHTML = `<td colspan="6" class="text-center">... å…±${parsedData.length}æ¡è®°å½• ...</td>`;
                        previewBody.appendChild(row);
                    }
                    
                    previewDiv.style.display = 'block';
                    
                    // æ£€æŸ¥å¯èƒ½çš„é‡å¤ä¼ä¸š
                    checkDuplicates();
                    
                    // é¢„è§ˆåŒºä¸‹æ–¹æ˜¾ç¤ºæœªåŒ¹é…å®¢æˆ·
                    const unmatchedDiv = document.getElementById('unmatchedCustomersDiv') || (function(){
                        const div = document.createElement('div');
                        div.id = 'unmatchedCustomersDiv';
                        previewDiv.parentNode.insertBefore(div, previewDiv.nextSibling);
                        return div;
                    })();
                    if (unmatchedCustomers.length > 0) {
                        let html = '<div class="alert alert-warning mt-2"><b>ä»¥ä¸‹å®¢æˆ·æœªåŒ¹é…åˆ°é”€å”®è´Ÿè´£äººï¼Œæ— æ³•å¯¼å…¥ï¼š</b><table class="table table-sm mt-2"><thead><tr><th>å…¬å¸åç§°</th><th>é”€å”®è´Ÿè´£äºº</th></tr></thead><tbody>';
                        unmatchedCustomers.forEach(item => {
                            html += `<tr><td>${item.company_name}</td><td>${item.sales_name}</td></tr>`;
                        });
                        html += '</tbody></table></div>';
                        unmatchedDiv.innerHTML = html;
                        unmatchedDiv.style.display = 'block';
                    } else {
                        unmatchedDiv.innerHTML = '';
                        unmatchedDiv.style.display = 'none';
                    }
                    
                } catch (error) {
                    console.error('è§£æExcelæ–‡ä»¶å¤±è´¥:', error);
                    alert('è§£ææ–‡ä»¶å¤±è´¥ï¼Œè¯·ç¡®ä¿æ–‡ä»¶æ ¼å¼æ­£ç¡®');
                }
            };
            
            reader.onerror = function() {
                alert('è¯»å–æ–‡ä»¶å¤±è´¥');
            };
            
            reader.readAsArrayBuffer(file);
        });
    }
    
    // æ£€æŸ¥é‡å¤ä¼ä¸š
    function checkDuplicates() {
        if (parsedData.length === 0) return;
        
        // æ¸…ç†å’Œè¿‡æ»¤å…¬å¸åç§°æ•°æ®
        let companyNames = [];
        
        // é¦–å…ˆç¡®ä¿æ‰€æœ‰å…¬å¸åç§°éƒ½æ˜¯æœ‰æ•ˆçš„å­—ç¬¦ä¸²
        for (let i = 0; i < parsedData.length; i++) {
            let item = parsedData[i];
            let name = "";
            
            try {
                // ç¡®ä¿å…¬å¸åç§°æ˜¯å­—ç¬¦ä¸²
                if (item.company_name) {
                    name = String(item.company_name).trim();
                }
            } catch (e) {
                console.warn("å¤„ç†å…¬å¸åç§°æ—¶å‡ºé”™:", e);
            }
            
            if (name) {
                companyNames.push(name);
            }
        }
        
        if (companyNames.length === 0) {
            alert('æ²¡æœ‰æœ‰æ•ˆçš„ä¼ä¸šåç§°å¯å¯¼å…¥');
            return;
        }
        
        console.log("å‡†å¤‡å‘é€æ£€æŸ¥é‡å¤è¯·æ±‚ï¼Œå…¬å¸æ•°é‡:", companyNames.length);
        
        // ä¸¥æ ¼ç¡®ä¿æ˜¯æœ‰æ•ˆçš„JSONæ•°æ®
        const requestData = JSON.stringify({ company_names: companyNames });
        console.log("è¯·æ±‚æ•°æ®:", requestData);
        
        // å‘é€è¯·æ±‚
        fetch('/customer/api/check-duplicates', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Accept': 'application/json',
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').content
            },
            body: requestData
        })
        .then(response => {
            if (!response.ok) {
                return response.text().then(text => {
                    // å°è¯•è§£æå“åº”ä¸ºJSON
                    try {
                        const errData = JSON.parse(text);
                        throw new Error(`è¯·æ±‚å¤±è´¥: ${errData.message || response.statusText}`);
                    } catch (parseError) {
                        // å¦‚æœæ— æ³•è§£æä¸ºJSONï¼Œç›´æ¥è¿”å›æ–‡æœ¬
                        throw new Error(`è¯·æ±‚å¤±è´¥: ${response.status} ${response.statusText}. å“åº”: ${text}`);
                    }
                });
            }
            return response.json();
        })
        .then(data => {
            if (!data || typeof data !== 'object') {
                throw new Error('æœåŠ¡å™¨è¿”å›äº†æ— æ•ˆçš„æ•°æ®æ ¼å¼');
            }
            
            if (!data.success) {
                throw new Error(data.message || 'æœåŠ¡å™¨è¿”å›äº†é”™è¯¯çš„æ•°æ®æ ¼å¼');
            }
            
            conflicts = Array.isArray(data.conflicts) ? data.conflicts : [];
            console.log("æ£€æŸ¥é‡å¤å®Œæˆï¼Œå‘ç°å†²çª:", conflicts.length);
            
            if (conflicts.length > 0) {
                // æ˜¾ç¤ºå†²çªè¡¨æ ¼
                const conflictsBody = document.getElementById('conflictsTableBody');
                conflictsBody.innerHTML = '';
                
                // æ·»åŠ å†²çªæ•°é‡æ‘˜è¦ä¿¡æ¯
                const conflictsSummary = document.getElementById('conflictsSummary');
                conflictsSummary.innerHTML = `<strong>å…±å‘ç° ${conflicts.length} ä¸ªæ½œåœ¨å†²çª</strong>ï¼Œè¯·æ»šåŠ¨æŸ¥çœ‹æ‰€æœ‰å†…å®¹å¹¶å†³å®šå¦‚ä½•å¤„ç†`;
                
                conflicts.forEach((conflict, index) => {
                    if (!conflict || typeof conflict !== 'object') {
                        console.warn("å¿½ç•¥æ— æ•ˆçš„å†²çªæ•°æ®:", conflict);
                        return;
                    }
                    
                    // ç¡®ä¿æ˜¾ç¤ºç©ºå­—ç¬¦ä¸²è€Œä¸æ˜¯'none'æˆ–undefined
                    const displayValue = (val) => {
                        if (val === undefined || val === null || val === 'none' || (val.toString && val.toString().toLowerCase() === 'none')) {
                            return '';
                        }
                        return val;
                    };
                    
                    const importName = displayValue(conflict.import_name) || '';
                    const existingName = displayValue(conflict.existing_name) || '';
                    const similarity = typeof conflict.similarity === 'number' 
                        ? (conflict.similarity * 100).toFixed(2) 
                        : '0.00';
                    
                    // è·å–æ¨èæ“ä½œ
                    const recommendedAction = conflict.recommended_action || 'ignore';
                    
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>
                            <div class="btn-group btn-group-sm" role="group">
                                <button type="button" class="btn btn-outline-success btn-sm action-btn ${recommendedAction === 'override' ? 'active' : ''}" 
                                        data-index="${index}" data-action="override" title="è¦†ç›–å·²æœ‰å®¢æˆ·">
                                    <i class="fas fa-check"></i>
                                </button>
                                <button type="button" class="btn btn-outline-secondary btn-sm action-btn ${recommendedAction === 'ignore' ? 'active' : ''}" 
                                        data-index="${index}" data-action="ignore" title="å¿½ç•¥è¯¥æ¡æ•°æ®">
                                    <i class="fas fa-times"></i>
                                </button>
                                <button type="button" class="btn btn-outline-primary btn-sm action-btn ${recommendedAction === 'keep' ? 'active' : ''}" 
                                        data-index="${index}" data-action="keep" title="ä»ç„¶å¯¼å…¥ä¸ºæ–°å®¢æˆ·">
                                    <i class="fas fa-plus"></i>
                                </button>
                            </div>
                        </td>
                        <td>${importName}</td>
                        <td>${existingName}</td>
                        <td>${similarity}% ${recommendedAction === 'ignore' ? '<span class="badge bg-secondary">å»ºè®®è·³è¿‡</span>' : recommendedAction === 'keep' ? '<span class="badge bg-primary">å»ºè®®å¯¼å…¥</span>' : ''}</td>
                    `;
                    conflictsBody.appendChild(row);
                    
                    // é»˜è®¤è®¾ç½®ä¸ºæ¨èçš„æ“ä½œ
                    conflictActions[importName] = recommendedAction;
                });
                
                // æ·»åŠ æŒ‰é’®äº‹ä»¶ç›‘å¬
                document.querySelectorAll('.action-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const index = parseInt(this.dataset.index);
                        const action = this.dataset.action;
                        if (isNaN(index) || index < 0 || index >= conflicts.length) {
                            console.warn("æ— æ•ˆçš„å†²çªç´¢å¼•:", index);
                            return;
                        }
                        
                        const conflict = conflicts[index];
                        if (!conflict || !conflict.import_name) {
                            console.warn("æ— æ•ˆçš„å†²çªæ•°æ®:", conflict);
                            return;
                        }
                        
                        // æ›´æ–°æ“ä½œ
                        conflictActions[conflict.import_name] = action;
                        
                        // é«˜äº®é€‰ä¸­çš„æŒ‰é’®
                        const parentRow = this.closest('tr');
                        parentRow.querySelectorAll('.action-btn').forEach(b => {
                            b.classList.remove('active');
                        });
                        this.classList.add('active');
                    });
                });
                
                conflictsDiv.style.display = 'block';
            } else {
                conflictsDiv.style.display = 'none';
            }
            
            // æ˜¾ç¤ºå¯¼å…¥æŒ‰é’®
            importBtn.style.display = 'block';
        })
        .catch(error => {
            console.error('æ£€æŸ¥é‡å¤å¤±è´¥:', error);
            alert('æ£€æŸ¥é‡å¤å®¢æˆ·å¤±è´¥: ' + error.message);
            
            // å³ä½¿æœ‰é”™è¯¯ï¼Œä¹Ÿå…è®¸ç”¨æˆ·ç»§ç»­å¯¼å…¥
            importBtn.style.display = 'block';
        });
    }
    
    // è·³è¿‡æ‰€æœ‰å†²çª(æ”¹åä¸ºkeepAllConflicts)
    if (skipAllConflictsBtn) {
        skipAllConflictsBtn.addEventListener('click', function() {
            conflicts.forEach(conflict => {
                conflictActions[conflict.import_name] = 'keep';
            });
            
            document.querySelectorAll('.action-btn[data-action="keep"]').forEach(btn => {
                const parentRow = btn.closest('tr');
                parentRow.querySelectorAll('.action-btn').forEach(b => {
                    b.classList.remove('active');
                });
                btn.classList.add('active');
            });
            
            alert('å·²è®¾ç½®ä¸ºæ‰€æœ‰å†²çªéƒ½åˆ›å»ºä¸ºæ–°å®¢æˆ·');
        });
    }
    
    // å…¨éƒ¨å¯¼å…¥ä¸ºæ–°ç”¨æˆ·
    const keepAllConflictsBtn = document.getElementById('keepAllConflicts');
    if (keepAllConflictsBtn) {
        keepAllConflictsBtn.addEventListener('click', function() {
            conflicts.forEach(conflict => {
                conflictActions[conflict.import_name] = 'keep';
            });
            
            document.querySelectorAll('.action-btn[data-action="keep"]').forEach(btn => {
                const parentRow = btn.closest('tr');
                parentRow.querySelectorAll('.action-btn').forEach(b => {
                    b.classList.remove('active');
                });
                btn.classList.add('active');
            });
            
            alert('å·²è®¾ç½®ä¸ºæ‰€æœ‰å†²çªéƒ½åˆ›å»ºä¸ºæ–°å®¢æˆ·');
        });
    }
    
    // åº”ç”¨æ™ºèƒ½æ¨è
    const applyRecommendedBtn = document.getElementById('applyRecommendedActions');
    if (applyRecommendedBtn) {
        applyRecommendedBtn.addEventListener('click', function() {
            conflicts.forEach(conflict => {
                const recommendedAction = conflict.recommended_action || 'ignore';
                conflictActions[conflict.import_name] = recommendedAction;
                
                // é«˜äº®æ˜¾ç¤ºæ¨èçš„æŒ‰é’®
                const index = conflicts.indexOf(conflict);
                if (index !== -1) {
                    const btn = document.querySelector(`.action-btn[data-index="${index}"][data-action="${recommendedAction}"]`);
                    if (btn) {
                        const parentRow = btn.closest('tr');
                        parentRow.querySelectorAll('.action-btn').forEach(b => {
                            b.classList.remove('active');
                        });
                        btn.classList.add('active');
                    }
                }
            });
            
            alert('å·²åº”ç”¨æ‰€æœ‰æ™ºèƒ½æ¨èçš„å¤„ç†æ–¹å¼');
        });
    }
    
    // å¿½ç•¥æ‰€æœ‰å†²çª
    if (ignoreAllConflictsBtn) {
        ignoreAllConflictsBtn.addEventListener('click', function() {
            conflicts.forEach(conflict => {
                conflictActions[conflict.import_name] = 'ignore';
            });
            
            document.querySelectorAll('.action-btn[data-action="ignore"]').forEach(btn => {
                const parentRow = btn.closest('tr');
                parentRow.querySelectorAll('.action-btn').forEach(b => {
                    b.classList.remove('active');
                });
                btn.classList.add('active');
            });
            
            alert('å·²è®¾ç½®ä¸ºå¿½ç•¥æ‰€æœ‰å†²çªçš„å®¢æˆ·');
        });
    }
    
    // æ‰§è¡Œå¯¼å…¥
    if (importBtn) {
        importBtn.addEventListener('click', function() {
            if (parsedData.length === 0) {
                alert('æ²¡æœ‰æ•°æ®å¯å¯¼å…¥');
                return;
            }
            
            const ownerId = document.getElementById('ownerSelect').value;
            if (!ownerId) {
                alert('è¯·é€‰æ‹©å½’å±è´¦æˆ·');
                return;
            }
            
            // å‡†å¤‡å¯¼å…¥æ•°æ®
            const importData = {
                customers: parsedData,
                conflict_actions: conflictActions,
                owner_id: parseInt(ownerId)
            };
            
            console.log("å‡†å¤‡å¯¼å…¥æ•°æ®:", JSON.stringify(importData));
            
            // æ˜¾ç¤ºä¸€äº›ç»Ÿè®¡ä¿¡æ¯
            if (parsedData.length > 0) {
                console.log(`å‡†å¤‡å¯¼å…¥${parsedData.length}æ¡è®°å½•ï¼Œå…¶ä¸­åŒ…å«åˆ›å»ºæ—¶é—´çš„è®°å½•ï¼š${parsedData.filter(item => item.created_at).length}æ¡`);
                
                // è¾“å‡ºå‰å‡ æ¡è®°å½•çš„åˆ›å»ºæ—¶é—´ä¿¡æ¯ï¼Œå¸®åŠ©è°ƒè¯•
                parsedData.slice(0, 3).forEach((item, idx) => {
                    if (item.created_at) {
                        console.log(`è®°å½•${idx+1}çš„åˆ›å»ºæ—¶é—´: ${item.created_at}`);
                    }
                });
            }
            
            // æ˜¾ç¤ºè¿›åº¦æ¡
            progressDiv.style.display = 'block';
            const progressBar = progressDiv.querySelector('.progress-bar');
            progressBar.style.width = '0%';
            
            // å‘é€å¯¼å…¥è¯·æ±‚
            fetch('/customer/api/import', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').content
                },
                body: JSON.stringify(importData)
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`æœåŠ¡å™¨å“åº”é”™è¯¯: ${response.status} ${response.statusText}`);
                }
                progressBar.style.width = '50%';
                return response.json();
            })
            .then(data => {
                // æ›´æ–°è¿›åº¦æ¡ä¸º100%
                progressBar.style.width = '100%';
                
                if (!data || !data.success) {
                    throw new Error(data?.message || 'æœåŠ¡å™¨è¿”å›äº†é”™è¯¯çš„æ•°æ®æ ¼å¼');
                }
                
                // æ˜¾ç¤ºç»“æœ
                resultDiv.className = 'alert alert-success mt-3';
                resultDiv.textContent = data.message;
                resultDiv.style.display = 'block';
                
                // æ˜¾ç¤ºé”™è¯¯è¯¦æƒ…(å¦‚æœæœ‰)
                const errorDetailsDiv = document.getElementById('importErrorDetails');
                const errorDetailsBody = document.getElementById('errorDetailsTableBody');
                
                if (data && data.data && data.data.error_details && data.data.error_details.length > 0) {
                    // æ¸…ç©ºåŸæœ‰å†…å®¹
                    errorDetailsBody.innerHTML = '';
                    
                    // æ·»åŠ æ¯æ¡é”™è¯¯è®°å½•
                    data.data.error_details.forEach(error => {
                        const row = document.createElement('tr');
                        
                        // ç¡®ä¿æ˜¾ç¤ºç©ºå­—ç¬¦ä¸²è€Œä¸æ˜¯'none'æˆ–undefined
                        const displayValue = (val) => {
                            if (val === undefined || val === null || val === 'none' || (val.toString && val.toString().toLowerCase() === 'none')) {
                                return '';
                            }
                            return val;
                        };
                        
                        const companyName = error.record && error.record.company_name ? displayValue(error.record.company_name) : 'æœªçŸ¥';
                        const reason = displayValue(error.reason) || 'æœªçŸ¥é”™è¯¯';
                        
                        row.innerHTML = `
                            <td>${companyName}</td>
                            <td>${reason}</td>
                        `;
                        
                        errorDetailsBody.appendChild(row);
                    });
                    
                    // æ˜¾ç¤ºé”™è¯¯è¯¦æƒ…åŒºåŸŸ
                    errorDetailsDiv.style.display = 'block';
                } else {
                    // éšè—é”™è¯¯è¯¦æƒ…åŒºåŸŸ
                    errorDetailsDiv.style.display = 'none';
                }
                
                // ç¦ç”¨å¯¼å…¥æŒ‰é’®å¹¶è®¾ç½®å»¶æ—¶åˆ·æ–°
                importBtn.disabled = true;
                parseExcelBtn.disabled = true;
                
                setTimeout(() => {
                    window.location.reload();
                }, 3000);
            })
            .catch(error => {
                console.error('å¯¼å…¥å¤±è´¥:', error);
                progressBar.style.width = '100%';
                progressBar.classList.add('bg-danger');
                
                resultDiv.className = 'alert alert-danger mt-3';
                resultDiv.textContent = 'å¯¼å…¥è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯: ' + error.message;
                resultDiv.style.display = 'block';
                
                // æ˜¾ç¤ºé”™è¯¯è¯¦æƒ…(å¦‚æœæœ‰)
                const errorDetailsDiv = document.getElementById('importErrorDetails');
                const errorDetailsBody = document.getElementById('errorDetailsTableBody');
                
                if (error.response) {
                    error.response.json().then(data => {
                        if (data && data.data && data.data.error_details && data.data.error_details.length > 0) {
                            // æ¸…ç©ºåŸæœ‰å†…å®¹
                            errorDetailsBody.innerHTML = '';
                            
                            // æ·»åŠ æ¯æ¡é”™è¯¯è®°å½•
                            data.data.error_details.forEach(error => {
                                const row = document.createElement('tr');
                                
                                // ç¡®ä¿æ˜¾ç¤ºç©ºå­—ç¬¦ä¸²è€Œä¸æ˜¯'none'æˆ–undefined
                                const displayValue = (val) => {
                                    if (val === undefined || val === null || val === 'none' || (val.toString && val.toString().toLowerCase() === 'none')) {
                                        return '';
                                    }
                                    return val;
                                };
                                
                                const companyName = error.record && error.record.company_name ? displayValue(error.record.company_name) : 'æœªçŸ¥';
                                const reason = displayValue(error.reason) || 'æœªçŸ¥é”™è¯¯';
                                
                                row.innerHTML = `
                                    <td>${companyName}</td>
                                    <td>${reason}</td>
                                `;
                                
                                errorDetailsBody.appendChild(row);
                            });
                            
                            // æ˜¾ç¤ºé”™è¯¯è¯¦æƒ…åŒºåŸŸ
                            errorDetailsDiv.style.display = 'block';
                        }
                    }).catch(e => {
                        console.error('æ— æ³•è§£æé”™è¯¯å“åº”:', e);
                    });
                }
            });
        });
    }
});

// ä¼ä¸šæœç´¢åŠŸèƒ½
function initCompanySearch() {
    const companyInput = document.getElementById('companySearch');
    const companyResults = document.getElementById('companySearchResults');
    const companySearchBtn = document.getElementById('searchCompany');
    let companyDebounceTimer;
    
    // è¾“å…¥äº‹ä»¶å¤„ç†
    companyInput.addEventListener('input', function() {
        clearTimeout(companyDebounceTimer);
        const keyword = this.value.trim();
        
        // å¦‚æœè¾“å…¥ä¸ºç©ºï¼Œéšè—ç»“æœ
        if (keyword.length < 1) {
            companyResults.classList.remove('show');
            return;
        }
        
        // è®¾ç½®å»¶è¿Ÿï¼Œé¿å…é¢‘ç¹è¯·æ±‚
        companyDebounceTimer = setTimeout(function() {
            // å‘é€AJAXè¯·æ±‚
            fetch(`/customer/api/company/search?keyword=${encodeURIComponent(keyword)}`, {
                headers: {
                    'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').content
                }
            })
                .then(response => response.json())
                .then(data => {
                    // æ¸…ç©ºç»“æœå®¹å™¨
                    companyResults.innerHTML = '';
                    
                    // æ·»åŠ æ ‡é¢˜
                    const headerDiv = document.createElement('div');
                    headerDiv.className = 'suggestions-header';
                    headerDiv.textContent = 'ç›¸ä¼¼ä¼ä¸šï¼ˆä»…ä¾›å‚è€ƒï¼‰';
                    companyResults.appendChild(headerDiv);
                    
                    // æ·»åŠ ç»“æœé¡¹
                    data.results.forEach(company => {
                        const item = document.createElement('div');
                        item.className = 'dropdown-item company-search-item';
                        
                        // åˆ›å»ºå†…å®¹åŒº
                        const contentDiv = document.createElement('div');
                        contentDiv.style.display = 'inline';
                        
                        // æ·»åŠ ä¼ä¸šåç§°
                        const nameSpan = document.createElement('span');
                        nameSpan.className = 'company-name';
                        nameSpan.textContent = company.name;
                        contentDiv.appendChild(nameSpan);
                        
                        // æ·»åŠ åœ°åŒºä¿¡æ¯
                        if (company.location || (company.country && company.region)) {
                            const locationSpan = document.createElement('span');
                            locationSpan.className = 'company-location';
                            const locationText = company.location || 
                                                 ((company.country || '') + 
                                                 (company.region ? ' ' + company.region : ''));
                            locationSpan.textContent = ` | ${locationText}`;
                            contentDiv.appendChild(locationSpan);
                        }
                        
                        // æ·»åŠ æ‹¥æœ‰è€…ä¿¡æ¯
                        if (company.owner_name) {
                            const ownerSpan = document.createElement('span');
                            ownerSpan.className = 'company-owner';
                            ownerSpan.textContent = ` | ${company.owner_name}`;
                            contentDiv.appendChild(ownerSpan);
                        }
                        
                        // æ·»åŠ ç‚¹å‡»äº‹ä»¶å¤„ç†ï¼Œç‚¹å‡»æœç´¢ç»“æœé¡¹ç›´æ¥å¡«å……è¾“å…¥æ¡†
                        item.addEventListener('click', function() {
                            companyInput.value = company.name;
                            companyResults.classList.remove('show');
                        });
                        
                        item.appendChild(contentDiv);
                        companyResults.appendChild(item);
                    });
                    
                    // æ·»åŠ æç¤ºä¿¡æ¯
                    if (data.results.length > 0) {
                        const noticeDiv = document.createElement('div');
                        noticeDiv.className = 'reference-notice';
                        noticeDiv.textContent = 'ç‚¹å‡»å¯ç›´æ¥é€‰æ‹©ä¼ä¸šè¿›è¡ŒæŸ¥è¯¢';
                        companyResults.appendChild(noticeDiv);
                    }
                    
                    // æ˜¾ç¤ºä¸‹æ‹‰åˆ—è¡¨
                    companyResults.classList.add('show');
                })
                .catch(error => {
                    console.error('æœç´¢ä¼ä¸šå‡ºé”™:', error);
                    companyResults.classList.remove('show');
                });
        }, 200);
    });
    
    // å¤„ç†ç‚¹å‡»äº‹ä»¶
    companySearchBtn.addEventListener('click', function() {
        const searchTerm = companyInput.value.trim();
        if (searchTerm) {
            window.location.href = `/customer/?search=${encodeURIComponent(searchTerm)}`;
        }
    });
    
    // å¤„ç†å›è½¦é”®
    companyInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            companySearchBtn.click();
        }
    });
    
    // å¤„ç†ç„¦ç‚¹äº‹ä»¶
    companyInput.addEventListener('focus', function() {
        if (this.value.trim().length >= 1) {
            companyResults.classList.add('show');
        }
    });
    
    // ç‚¹å‡»å…¶ä»–åŒºåŸŸéšè—ç»“æœ
    document.addEventListener('click', function(event) {
        if (!companyInput.contains(event.target) && 
            !companyResults.contains(event.target)) {
            companyResults.classList.remove('show');
        }
    });
}

// è”ç³»äººæœç´¢åŠŸèƒ½
function initContactSearch() {
    const contactInput = document.getElementById('contactSearch');
    const contactResults = document.getElementById('contactSearchResults');
    const contactSearchBtn = document.getElementById('searchContact');
    let contactDebounceTimer;
    
    // è¾“å…¥äº‹ä»¶å¤„ç†
    contactInput.addEventListener('input', function() {
        clearTimeout(contactDebounceTimer);
        const keyword = this.value.trim();
        
        // å¦‚æœè¾“å…¥ä¸ºç©ºï¼Œéšè—ç»“æœ
        if (keyword.length < 1) {
            contactResults.classList.remove('show');
            return;
        }
        
        // è®¾ç½®å»¶è¿Ÿï¼Œé¿å…é¢‘ç¹è¯·æ±‚
        contactDebounceTimer = setTimeout(function() {
            // å‘é€AJAXè¯·æ±‚
            fetch(`/customer/api/contacts/search_by_name?keyword=${encodeURIComponent(keyword)}`, {
                headers: {
                    'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').content
                }
            })
            .then(response => response.json())
            .then(data => {
                contactResults.innerHTML = '';
                
                if (data.results && data.results.length > 0) {
                    // æ˜¾ç¤ºç»“æœä¸‹æ‹‰èœå•
                    contactResults.classList.add('show');
                    
                    // æ·»åŠ ç»“æœé¡¹
                    data.results.forEach(contact => {
                        const item = document.createElement('a');
                        item.className = 'dropdown-item d-flex justify-content-between align-items-center';
                        item.href = 'javascript:void(0)';
                        
                        // æ·»åŠ è”ç³»äººå§“åå’Œæ‰€å±ä¼ä¸š
                        item.innerHTML = `<span>${contact.name}</span><small class="text-muted ms-2">(${contact.company_name})</small>`;
                        
                        // è®¾ç½®æ ·å¼å’Œæƒé™æ ‡è®°
                        if (!contact.can_view_enterprise) {
                            item.classList.add('text-muted');
                            item.title = "è¯¥è”ç³»äººæ‰€å±ä¼ä¸šä¸åœ¨æ‚¨çš„è®¿é—®èŒƒå›´å†…";
                            item.style.cursor = 'not-allowed';
                            item.innerHTML += '<span class="badge bg-secondary ms-2">æ— æƒé™</span>';
                        } else {
                            // æœ‰æƒé™çš„è”ç³»äººç‚¹å‡»äº‹ä»¶å¤„ç†
                            item.addEventListener('click', function() {
                                contactInput.value = contact.name;
                                contactResults.classList.remove('show');
                                window.location.href = `/customer/view/${contact.company_id}`;
                            });
                        }
                        
                        contactResults.appendChild(item);
                    });
                } else {
                    contactResults.classList.remove('show');
                }
            })
            .catch(error => {
                console.error('æœç´¢è”ç³»äººå‡ºé”™:', error);
                contactResults.classList.remove('show');
            });
        }, 150); // å‡å°‘å»¶è¿Ÿæ—¶é—´ï¼Œæé«˜å“åº”é€Ÿåº¦
    });
    
    // å¤„ç†ç‚¹å‡»äº‹ä»¶
    contactSearchBtn.addEventListener('click', function() {
        const searchTerm = contactInput.value.trim();
        if (searchTerm) {
            window.location.href = `/customer/search_contacts?search=${encodeURIComponent(searchTerm)}`;
        }
    });
    
    // å¤„ç†å›è½¦é”®
    contactInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            contactSearchBtn.click();
        }
    });
    
    // å¤„ç†ç„¦ç‚¹äº‹ä»¶
    contactInput.addEventListener('focus', function() {
        if (this.value.trim().length >= 1) {
            contactResults.classList.add('show');
        }
    });
    
    // ç‚¹å‡»å…¶ä»–åŒºåŸŸéšè—è”ç³»äººç»“æœ
    document.addEventListener('click', function(event) {
        if (!contactInput.contains(event.target) && 
            !contactResults.contains(event.target)) {
            contactResults.classList.remove('show');
        }
    });
}

// æ·»åŠ æ— æƒé™ä¼ä¸šåˆ°åˆ—è¡¨
function addNoPermissionCompanyToList(company) {
    // æ£€æŸ¥è¡¨æ ¼æ˜¯å¦å­˜åœ¨
    const table = document.querySelector('.table tbody');
    if (!table) return;
    
    // æ£€æŸ¥æ˜¯å¦å·²ç»å­˜åœ¨ç›¸åŒIDçš„ä¼ä¸š
    const existingRow = document.querySelector(`tr[data-company-id="${company.id}"]`);
    if (existingRow) {
        // å¦‚æœå·²å­˜åœ¨ï¼Œé«˜äº®æ˜¾ç¤º
        existingRow.classList.add('table-warning');
        setTimeout(() => existingRow.classList.remove('table-warning'), 2000);
        return;
    }
    
    // åˆ›å»ºæ–°è¡Œ
    const newRow = document.createElement('tr');
    newRow.dataset.companyId = company.id;
    newRow.className = 'no-permission-company';
    
    // è®¾ç½®å•å…ƒæ ¼å†…å®¹
    newRow.innerHTML = `
        <td class="px-3"><span class="badge bg-info">--</span></td>
        <td class="px-3 text-muted">
            <span title="è¯¥ä¼ä¸šä¸åœ¨æ‚¨çš„æƒé™èŒƒå›´ï¼Œæ— æ³•è®¿é—®è¯¦æƒ…">${company.name}</span>
        </td>
        <td class="px-3">--</td>
        <td class="px-3">--</td>
        <td class="px-3">--</td>
        <td class="px-3">--</td>
        <td class="px-3">--</td>
        <td class="px-3">--</td>
        <td class="px-3"><span class="badge bg-secondary">æœªçŸ¥</span></td>
        <td class="px-3">--</td>
        <td class="px-3">--</td>
        <td class="px-3">--</td>
        <td class="px-3">
            <div class="btn-group btn-group-sm">
                <span class="text-muted small">æ— æƒé™æ“ä½œ</span>
            </div>
        </td>
    `;
    
    // æ·»åŠ æ–°è¡Œåˆ°è¡¨æ ¼é¡¶éƒ¨
    table.insertBefore(newRow, table.firstChild);
    
    // çŸ­æš‚é«˜äº®æ˜¾ç¤ºç„¶åæ¢å¤
    newRow.classList.add('table-warning');
    setTimeout(() => newRow.classList.remove('table-warning'), 2000);
}

// å¤šé€‰åˆ é™¤åŠŸèƒ½
document.addEventListener('DOMContentLoaded', function() {
    // å…¨é€‰/å–æ¶ˆå…¨é€‰
    const selectAllCheckbox = document.getElementById('selectAll');
    if (selectAllCheckbox) {
        selectAllCheckbox.addEventListener('change', function() {
            const checkboxes = document.querySelectorAll('.company-checkbox:not(:disabled)');
            checkboxes.forEach(checkbox => {
                checkbox.checked = selectAllCheckbox.checked;
            });
            updateBatchDeleteButton();
        });
    }
    
    // å•ä¸ªé€‰æ‹©æ¡†å˜åŒ–
    const companyCheckboxes = document.querySelectorAll('.company-checkbox');
    companyCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            updateBatchDeleteButton();
            
            // æ£€æŸ¥æ˜¯å¦æ‰€æœ‰å¯é€‰çš„éƒ½è¢«é€‰ä¸­äº†
            const allEnabled = document.querySelectorAll('.company-checkbox:not(:disabled)');
            const allChecked = document.querySelectorAll('.company-checkbox:not(:disabled):checked');
            
            if (selectAllCheckbox) {
                selectAllCheckbox.checked = allEnabled.length === allChecked.length && allEnabled.length > 0;
                selectAllCheckbox.indeterminate = allChecked.length > 0 && allChecked.length < allEnabled.length;
            }
        });
    });
    
    // æ›´æ–°æ‰¹é‡åˆ é™¤æŒ‰é’®çŠ¶æ€
    function updateBatchDeleteButton() {
        const batchDeleteBtn = document.getElementById('batchDeleteBtn');
        if (batchDeleteBtn) {
            const checked = document.querySelectorAll('.company-checkbox:checked');
            batchDeleteBtn.style.display = checked.length > 0 ? 'inline-block' : 'none';
            
            // æ›´æ–°åˆ é™¤æŒ‰é’®æ–‡æœ¬
            if (checked.length > 0) {
                batchDeleteBtn.innerHTML = `<i class="fas fa-trash"></i> æ‰¹é‡åˆ é™¤ (${checked.length})`;
            }
        }
    }
    
    // æ‰¹é‡åˆ é™¤æŒ‰é’®ç‚¹å‡»äº‹ä»¶
    const batchDeleteBtn = document.getElementById('batchDeleteBtn');
    if (batchDeleteBtn) {
        batchDeleteBtn.addEventListener('click', function() {
            const checked = document.querySelectorAll('.company-checkbox:checked');
            if (checked.length === 0) return;
            
            if (confirm(`ç¡®å®šè¦åˆ é™¤é€‰ä¸­çš„ ${checked.length} ä¸ªä¼ä¸šå—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼`)) {
                const companyIds = Array.from(checked).map(checkbox => checkbox.value);
                
                // å‘é€æ‰¹é‡åˆ é™¤è¯·æ±‚
                fetch('{{ url_for("customer.batch_delete_companies") }}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token() }}'
                    },
                    body: JSON.stringify({ company_ids: companyIds })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert(`æˆåŠŸåˆ é™¤ ${data.deleted_count} ä¸ªä¼ä¸šï¼`);
                        location.reload(); // åˆ·æ–°é¡µé¢
                    } else {
                        alert(`åˆ é™¤å¤±è´¥ï¼š${data.message}`);
                    }
                })
                .catch(error => {
                    console.error('æ‰¹é‡åˆ é™¤å‡ºé”™:', error);
                    alert('æ‰¹é‡åˆ é™¤è¯·æ±‚å¤±è´¥ï¼Œè¯·é‡è¯•');
                });
            }
        });
    }
});

// å¯¼å…¥è”ç³»äººåŠŸèƒ½
const importContactsBtn = document.getElementById('importContacts');
const contactImportModal = new bootstrap.Modal(document.getElementById('importContactModal'));
const contactOwnerSelect = document.getElementById('contactOwnerSelect');
const contactExcelFileInput = document.getElementById('contactExcelFile');
const parseContactExcelBtn = document.getElementById('parseContactExcelBtn');
const importContactBtn = document.getElementById('importContactBtn');
const contactPreviewDiv = document.getElementById('contactImportPreview');
const contactConflictsDiv = document.getElementById('contactImportConflicts');
const contactProgressDiv = document.getElementById('contactImportProgress');
const contactResultDiv = document.getElementById('contactImportResult');
const companyNotFoundDiv = document.getElementById('companyNotFoundDetails');
const contactErrorDetailsDiv = document.getElementById('contactImportErrorDetails');
const overrideAllConflictsBtn = document.getElementById('overrideAllConflicts');
const keepAllContactConflictsBtn = document.getElementById('keepAllContactConflicts');

let parsedContactData = [];
let contactConflicts = [];
let contactConflictActions = {};
let companyNotFound = [];

// æ‰“å¼€è”ç³»äººå¯¼å…¥æ¨¡æ€æ¡†
if (importContactsBtn) {
    importContactsBtn.addEventListener('click', function(e) {
        e.preventDefault();
        
        // é‡ç½®çŠ¶æ€
        document.getElementById('importContactForm').reset();
        contactPreviewDiv.style.display = 'none';
        contactConflictsDiv.style.display = 'none';
        contactProgressDiv.style.display = 'none';
        contactResultDiv.style.display = 'none';
        companyNotFoundDiv.style.display = 'none';
        contactErrorDetailsDiv.style.display = 'none';
        importContactBtn.style.display = 'none';
        parsedContactData = [];
        contactConflicts = [];
        contactConflictActions = {};
        companyNotFound = [];
        
        // åŠ è½½ç”¨æˆ·åˆ—è¡¨ï¼ˆåˆ†ç»„+çœŸå®å§“åï¼‰
        loadUsers(contactOwnerSelect);
        
        // æ˜¾ç¤ºæ¨¡æ€æ¡†
        contactImportModal.show();
    });
}

// é€šç”¨åŠ è½½ç”¨æˆ·åˆ—è¡¨å‡½æ•°
function loadUsers(selectElement) {
    fetch('/api/users/hierarchical', {
        headers: {
            'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').content
        }
    })
        .then(response => response.json())
        .then(data => {
            selectElement.innerHTML = '<option value="">è¯·é€‰æ‹©...</option>';
        if (data.success) {
            data.data.forEach(company => {
                const companyOptgroup = document.createElement('optgroup');
                companyOptgroup.label = company.name + ' (ä¼ä¸š)';
                company.users.forEach(user => {
                const option = document.createElement('option');
                option.value = user.id;
                    option.textContent = user.name;
                    companyOptgroup.appendChild(option);
            });
                selectElement.appendChild(companyOptgroup);
            });
        }
        })
        .catch(error => console.error('åŠ è½½ç”¨æˆ·å¤±è´¥:', error));
}

// è§£æè”ç³»äººExcelæ–‡ä»¶
if (parseContactExcelBtn) {
    parseContactExcelBtn.addEventListener('click', function() {
        const fileInput = document.getElementById('contactExcelFile');
        const ownerIdSelect = document.getElementById('contactOwnerSelect');
        
        if (!ownerIdSelect.value) {
            alert('è¯·é€‰æ‹©å½’å±è´¦æˆ·');
            return;
        }
        
        if (!fileInput.files.length) {
            alert('è¯·é€‰æ‹©Excelæ–‡ä»¶');
            return;
        }
        
        const file = fileInput.files[0];
        const reader = new FileReader();
        
        reader.onload = function(e) {
            try {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, {type: 'array'});
                // è”ç³»äººè¡¨
                const contactSheetName = workbook.SheetNames.find(name => name.toLowerCase().includes('contact database'));
                if (!contactSheetName) {
                    alert('æœªæ‰¾åˆ°åä¸º"contact database"çš„å·¥ä½œè¡¨');
                    return;
                }
                const contactWorksheet = workbook.Sheets[contactSheetName];
                const contactJsonData = XLSX.utils.sheet_to_json(contactWorksheet);
                // è¡ŒåŠ¨è®°å½•è¡¨
                const actionSheetName = workbook.SheetNames.find(name => name.toLowerCase().includes('contact detail'));
                let actionJsonData = [];
                if (actionSheetName) {
                    const actionWorksheet = workbook.Sheets[actionSheetName];
                    actionJsonData = XLSX.utils.sheet_to_json(actionWorksheet);
                }
                // è§£æè”ç³»äºº
                parsedContactData = contactJsonData.map(row => {
                    console.log("è§£æè”ç³»äººè¡Œæ•°æ®:", row);
                    let createdAt = null;
                    
                    // å°è¯•è§£æåˆ›å»ºæ—¶é—´
                    if (row['åˆ›å»ºæ—¶é—´']) {
                        try {
                            // å¢å¼ºæ—¥æœŸæ ¼å¼å¤„ç†
                            let dateValue = row['åˆ›å»ºæ—¶é—´'];
                            console.log("åŸå§‹Excelæ—¥æœŸå€¼:", dateValue, "ç±»å‹:", typeof dateValue);
                            
                            // æ£€æŸ¥æ˜¯å¦ä¸ºExcelæ•°å€¼æ—¥æœŸï¼ˆè‡ª1900å¹´ä»¥æ¥çš„å¤©æ•°ï¼‰
                            if (typeof dateValue === 'number' || (typeof dateValue === 'string' && !isNaN(dateValue) && dateValue.trim() !== '')) {
                                // å°è¯•å°†Excelæ•°å€¼æ—¥æœŸè½¬æ¢ä¸ºJSæ—¥æœŸ
                                let excelDateValue = parseFloat(dateValue);
                                if (excelDateValue > 59) { // 1900å¹´2æœˆ28æ—¥ä¹‹å
                                    excelDateValue -= 1;
                                }
                                const millisecondsPerDay = 24 * 60 * 60 * 1000;
                                let jsDate = new Date(Date.UTC(1900, 0, 1) + excelDateValue * millisecondsPerDay);
                                if (jsDate.toString() !== 'Invalid Date') {
                                    createdAt = jsDate;
                                    console.log("ä»Excelæ•°å€¼è½¬æ¢:", dateValue, "->", createdAt);
                                }
                            } else if (typeof dateValue === 'string') {
                                // å°è¯•å¸¸è§æ—¥æœŸæ ¼å¼
                                createdAt = new Date(dateValue);
                                if (createdAt.toString() === 'Invalid Date') {
                                    // å°è¯•è§£æDD/MM/YYYYæ ¼å¼
                                    const parts = dateValue.split(/[\/-]/);
                                    if (parts.length === 3) {
                                        // å°è¯•DD/MM/YYYY
                                        if (parts[0].length <= 2 && parts[1].length <= 2) {
                                            createdAt = new Date(parts[2], parts[1]-1, parts[0]);
                                        }
                                        // å°è¯•MM/DD/YYYY
                                        else if (parts[1].length <= 2 && parts[0].length <= 2) {
                                            createdAt = new Date(parts[2], parts[0]-1, parts[1]);
                                        }
                                        // å°è¯•YYYY/MM/DD
                                        else if (parts[0].length === 4) {
                                            createdAt = new Date(parts[0], parts[1]-1, parts[2]);
                                        }
                                        console.log("ä»åˆ†å‰²æ ¼å¼è½¬æ¢:", dateValue, "->", createdAt);
                                    }
                                }
                            }
                            
                            if (createdAt && createdAt.toString() !== 'Invalid Date') {
                                console.log("æœ€ç»ˆè§£æåçš„æ—¥æœŸ:", createdAt, "ISOæ ¼å¼:", createdAt.toISOString());
                            } else {
                                console.error("æ— æ³•è§£ææ—¥æœŸï¼Œä½¿ç”¨å½“å‰æ—¶é—´");
                                createdAt = new Date();
                            }
                        } catch (e) {
                            console.error("åˆ›å»ºæ—¶é—´è§£æé”™è¯¯:", e);
                            createdAt = new Date();
                        }
                    } else {
                        createdAt = new Date();
                    }
                    
                    return {
                        company_name: row['å…¬å¸åç§°'] || '',
                        name: row['è”ç³»äºº'] || '',
                        department: row['éƒ¨é—¨'] ? (row['éƒ¨é—¨'].toString().toLowerCase() === 'none' ? '' : row['éƒ¨é—¨']) : '',
                        position: row['èŒä½'] ? (row['èŒä½'].toString().toLowerCase() === 'none' ? '' : row['èŒä½']) : '',
                        phone: row['è”ç³»ç”µè¯'] ? (row['è”ç³»ç”µè¯'].toString().toLowerCase() === 'none' ? '' : row['è”ç³»ç”µè¯']) : '',
                        email: row['é‚®ä»¶ä¿¡ç®±'] ? (row['é‚®ä»¶ä¿¡ç®±'].toString().toLowerCase() === 'none' ? '' : row['é‚®ä»¶ä¿¡ç®±']) : '',
                        created_at: createdAt.toISOString(), // æ˜ç¡®è½¬æ¢ä¸ºISOå­—ç¬¦ä¸²
                        owner_id: parseInt(ownerIdSelect.value)
                    };
                });
                // è§£æè¡ŒåŠ¨è®°å½•
                let parsedActionData = [];
                let unmatchedActions = [];
                if (actionJsonData.length > 0) {
                    parsedActionData = actionJsonData.map(row => {
                        return {
                            contact_name: row['è”ç³»äºº'] || '',
                            company_name: row['å…³è”å…¬å¸'] || '',
                            project_name: row['å…³è”æœºä¼š'] || '',
                            date: row['æ²Ÿé€šæ—¥æœŸ'] || '',
                            communication: row['æ²Ÿé€šè¯¦æƒ…'] || '',
                            owner_name: row['å¡«å†™äºº'] || '',
                            created_at: row['æ²Ÿé€šæ—¥æœŸ'] || ''
                        };
                    });
                    // åŒ¹é…è”ç³»äºº
                    parsedContactData.forEach(contact => {
                        contact.action_records = [];
                    });
                    parsedActionData.forEach(action => {
                        const match = parsedContactData.find(c => c.name === action.contact_name && c.company_name === action.company_name);
                        if (match) {
                            match.action_records = match.action_records || [];
                            match.action_records.push(action);
                        } else {
                            unmatchedActions.push(action);
                        }
                    });
                }
                
                // æ˜¾ç¤ºé¢„è§ˆ
                const previewBody = document.getElementById('contactPreviewTableBody');
                previewBody.innerHTML = '';
                parsedContactData.slice(0, 5).forEach(item => {
                    const row = document.createElement('tr');
                    // ç¡®ä¿æ˜¾ç¤ºç©ºå­—ç¬¦ä¸²è€Œä¸æ˜¯'none'æˆ–undefined
                    const displayValue = (val) => {
                        if (val === undefined || val === null || val === 'none' || (val.toString && val.toString().toLowerCase() === 'none')) {
                            return '';
                        }
                        return val;
                    };
                    
                    row.innerHTML = `
                        <td>${displayValue(item.company_name)}</td>
                        <td>${displayValue(item.name)}</td>
                        <td>${displayValue(item.department)}</td>
                        <td>${displayValue(item.position)}</td>
                        <td>${displayValue(item.phone)}</td>
                        <td>${displayValue(item.email)}</td>
                        <td>${new Date(item.created_at).toLocaleString()}</td>
                        <td>${item.action_records ? item.action_records.length : 0}</td>
                    `;
                    previewBody.appendChild(row);
                });
                
                // æ˜¾ç¤ºé¢„è§ˆéƒ¨åˆ†
                contactPreviewDiv.style.display = 'block';
                
                // æ›´æ–°å¯¼å…¥ç»Ÿè®¡ä¿¡æ¯
                document.getElementById('totalContactsCount').textContent = parsedContactData.length;
                document.getElementById('companyNotFoundCount').textContent = '0'; // åˆå§‹åŒ–ä¸º0ï¼Œåç»­åœ¨æ£€æµ‹å†²çªæ—¶æ›´æ–°
                
                // æ£€æŸ¥å…¬å¸æ˜¯å¦å­˜åœ¨ï¼Œå¹¶æ£€æŸ¥è”ç³»äººå†²çª
                detectContactConflicts();
                
                // æ–°å¢ï¼šæ˜¾ç¤ºæ— æ³•åŒ¹é…çš„è¡ŒåŠ¨è®°å½•æ•°é‡
                if (unmatchedActions.length > 0) {
                    const actionUnmatchedDiv = document.getElementById('actionUnmatchedDetails');
                    if (actionUnmatchedDiv) {
                        actionUnmatchedDiv.style.display = 'block';
                        actionUnmatchedDiv.innerHTML = `<div class='alert alert-warning'>æœ‰ ${unmatchedActions.length} æ¡è¡ŒåŠ¨è®°å½•æ— æ³•åŒ¹é…åˆ°è”ç³»äººï¼Œå°†ä¸ä¼šå¯¼å…¥ã€‚</div>`;
                    }
                }
                
                // ä¿å­˜åˆ°å…¨å±€å˜é‡ï¼Œä¾›åç»­å¯¼å…¥
                window.parsedActionData = parsedActionData;
                window.unmatchedActions = unmatchedActions;
            } catch (error) {
                console.error('è§£æExcelå‡ºé”™:', error);
                alert('è§£æExcelæ–‡ä»¶å¤±è´¥ï¼š' + error.message);
            }
        };
        
        reader.onerror = function() {
            alert('è¯»å–æ–‡ä»¶å¤±è´¥');
        };
        
        reader.readAsArrayBuffer(file);
    });
}

// æ£€æµ‹è”ç³»äººå†²çªå’Œå…¬å¸å­˜åœ¨æ€§
function detectContactConflicts() {
    if (!parsedContactData.length) return;
    
    // æ¸…ç©ºä¸Šæ¬¡ç»“æœ
    companyNotFound = [];
    contactConflicts = [];
    contactConflictActions = {};
    
    // è·å–æ‰€æœ‰ä¼ä¸šåç§°
    const companyNames = [...new Set(parsedContactData.map(item => item.company_name))];
    
    // éªŒè¯å…¬å¸å’Œè”ç³»äºº
    fetch('/customer/api/check-contact-duplicates', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').content
        },
        body: JSON.stringify({
            contacts: parsedContactData,
            company_names: companyNames
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // å¤„ç†å…¬å¸ä¸å­˜åœ¨çš„æƒ…å†µ
            companyNotFound = data.company_not_found || [];
            
            // æ›´æ–°æœªæ‰¾åˆ°ç»‘å®šå…¬å¸çš„è®°å½•æ•°é‡
            document.getElementById('companyNotFoundCount').textContent = companyNotFound.length;
            
            // å¤„ç†è”ç³»äººå†²çª
            contactConflicts = data.conflicts || [];
            
            // æ˜¾ç¤ºå…¬å¸ä¸å­˜åœ¨è¯¦æƒ…
            if (companyNotFound.length > 0) {
                const notFoundBody = document.getElementById('companyNotFoundTableBody');
                notFoundBody.innerHTML = '';
                
                companyNotFound.forEach(item => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${item.name || 'æœªçŸ¥'}</td>
                        <td>${item.company_name || 'æœªçŸ¥'}</td>
                        <td>ç³»ç»Ÿä¸­æœªæ‰¾åˆ°å®Œå…¨åŒ¹é…çš„ä¼ä¸šåç§°</td>
                    `;
                    notFoundBody.appendChild(row);
                });
                
                companyNotFoundDiv.style.display = 'block';
            } else {
                companyNotFoundDiv.style.display = 'none';
            }
            
            // æ˜¾ç¤ºè”ç³»äººå†²çª
            if (contactConflicts.length > 0) {
                const conflictsBody = document.getElementById('contactConflictsTableBody');
                conflictsBody.innerHTML = '';
                
                contactConflicts.forEach((conflict, index) => {
                    // é»˜è®¤é€‰æ‹©ä¿ç•™ç°æœ‰æ•°æ®
                    contactConflictActions[conflict.contact_key] = 'keep';
                    
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>
                            <div class="btn-group btn-group-sm" role="group">
                                <button type="button" class="btn btn-outline-primary btn-action" data-key="${conflict.contact_key}" data-action="override">è¦†ç›–</button>
                                <button type="button" class="btn btn-outline-success btn-action active" data-key="${conflict.contact_key}" data-action="keep">ä¿ç•™</button>
                            </div>
                        </td>
                        <td>${conflict.import_contact.name}</td>
                        <td>${conflict.import_contact.company_name}</td>
                        <td>${conflict.existing_contact.name}</td>
                    `;
                    conflictsBody.appendChild(row);
                });
                
                // æ›´æ–°å†²çªæ‘˜è¦
                document.getElementById('contactConflictsSummary').innerHTML = `
                    <strong>å†²çªæ‘˜è¦:</strong> å‘ç° ${contactConflicts.length} ä¸ªé‡å¤è”ç³»äººï¼Œ
                    å·²é»˜è®¤é€‰æ‹©ä¿ç•™ç°æœ‰æ•°æ®ï¼Œå¦‚éœ€è¦†ç›–è¯·ç‚¹å‡»ç›¸åº”æŒ‰é’®ã€‚
                `;
                
                // æ·»åŠ å†²çªæ“ä½œæŒ‰é’®äº‹ä»¶
                document.querySelectorAll('#contactConflictsTableBody .btn-action').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const key = this.dataset.key;
                        const action = this.dataset.action;
                        
                        // æ›´æ–°æ“ä½œçŠ¶æ€
                        contactConflictActions[key] = action;
                        
                        // æ›´æ–°æŒ‰é’®çŠ¶æ€
                        const parentGroup = this.closest('.btn-group');
                        parentGroup.querySelectorAll('.btn-action').forEach(b => {
                            b.classList.remove('active');
                        });
                        this.classList.add('active');
                    });
                });
                
                contactConflictsDiv.style.display = 'block';
            } else {
                contactConflictsDiv.style.display = 'none';
            }
            
            // å¤„ç†æ‰¹é‡æ“ä½œ
            if (overrideAllConflictsBtn) {
                overrideAllConflictsBtn.addEventListener('click', function() {
                    contactConflicts.forEach(conflict => {
                        contactConflictActions[conflict.contact_key] = 'override';
                    });
                    
                    // æ›´æ–°UI
                    document.querySelectorAll('#contactConflictsTableBody .btn-action').forEach(btn => {
                        btn.classList.remove('active');
                        if (btn.dataset.action === 'override') {
                            btn.classList.add('active');
                        }
                    });
                    
                    alert('å·²è®¾ç½®å…¨éƒ¨å†²çªè”ç³»äººä¸ºè¦†ç›–æ¨¡å¼');
                });
            }
            
            if (keepAllContactConflictsBtn) {
                keepAllContactConflictsBtn.addEventListener('click', function() {
                    contactConflicts.forEach(conflict => {
                        contactConflictActions[conflict.contact_key] = 'keep';
                    });
                    
                    // æ›´æ–°UI
                    document.querySelectorAll('#contactConflictsTableBody .btn-action').forEach(btn => {
                        btn.classList.remove('active');
                        if (btn.dataset.action === 'keep') {
                            btn.classList.add('active');
                        }
                    });
                    
                    alert('å·²è®¾ç½®å…¨éƒ¨å†²çªè”ç³»äººä¸ºä¿ç•™æ¨¡å¼');
                });
            }
            
            // æ˜¾ç¤ºå¯¼å…¥æŒ‰é’®
            if (companyNotFound.length === 0) {
                importContactBtn.style.display = 'block';
            } else {
                importContactBtn.style.display = 'none';
                alert('æœ‰è”ç³»äººæ‰€å±çš„å…¬å¸åœ¨ç³»ç»Ÿä¸­ä¸å­˜åœ¨ï¼Œè¯·å…ˆè§£å†³è¿™äº›é—®é¢˜å†å¯¼å…¥');
            }
        } else {
            alert('æ£€æŸ¥å†²çªå¤±è´¥: ' + (data.message || 'æœªçŸ¥é”™è¯¯'));
        }
    })
    .catch(error => {
        console.error('æ£€æŸ¥è”ç³»äººå†²çªå‡ºé”™:', error);
        alert('æ£€æŸ¥å†²çªè¯·æ±‚å¤±è´¥ï¼Œè¯·é‡è¯•');
    });
}

// å¯¼å…¥è”ç³»äººç¡®è®¤
if (importContactBtn) {
    importContactBtn.addEventListener('click', function() {
        if (!confirm('ç¡®å®šè¦å¯¼å…¥è¿™äº›è”ç³»äººå—ï¼Ÿ')) return;
        
        // æ˜¾ç¤ºè¿›åº¦æ¡
        contactProgressDiv.style.display = 'block';
        contactProgressDiv.querySelector('.progress-bar').style.width = '30%';
        
        // å‘é€å¯¼å…¥è¯·æ±‚
        fetch('/customer/api/import-contacts', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').content
            },
            body: JSON.stringify({
                contacts: parsedContactData,
                conflict_actions: contactConflictActions,
                owner_id: document.getElementById('contactOwnerSelect').value,
                action_records: window.parsedActionData || []
            })
        })
        .then(response => response.json())
        .then(data => {
            // æ›´æ–°è¿›åº¦æ¡
            contactProgressDiv.querySelector('.progress-bar').style.width = '100%';
            
            // æ˜¾ç¤ºç»“æœ
            contactResultDiv.style.display = 'block';
            
            if (data.success) {
                contactResultDiv.className = 'alert alert-success mt-3';
                contactResultDiv.innerHTML = `
-                    <h6><i class="fas fa-check-circle"></i> å¯¼å…¥æˆåŠŸ!</h6>
-                    <p>æˆåŠŸå¯¼å…¥ ${data.data.imported} ä¸ªè”ç³»äººï¼Œæ›´æ–° ${data.data.updated} ä¸ªè”ç³»äººï¼Œè·³è¿‡ ${data.data.skipped} ä¸ªè”ç³»äººï¼Œé”™è¯¯ ${data.data.error} ä¸ªã€‚</p>
                     <h6 class="alert-heading"><i class="fas fa-check-circle"></i> å¯¼å…¥æˆåŠŸ!</h6>
                     <div class="row mt-2">
                        <div class="col-md-3">
                            <div class="card border-success">
                                <div class="card-body text-center p-2">
                                    <h5 class="card-title mb-0">${data.data.imported}</h5>
                                    <p class="card-text small">æˆåŠŸå¯¼å…¥</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card border-primary">
                                <div class="card-body text-center p-2">
                                    <h5 class="card-title mb-0">${data.data.updated}</h5>
                                    <p class="card-text small">å·²æ›´æ–°</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card border-info">
                                <div class="card-body text-center p-2">
                                    <h5 class="card-title mb-0">${data.data.skipped}</h5>
                                    <p class="card-text small">å·²è·³è¿‡</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card ${data.data.error > 0 ? 'border-danger' : 'border-secondary'}">
                                <div class="card-body text-center p-2">
                                    <h5 class="card-title mb-0">${data.data.error}</h5>
                                    <p class="card-text small">é”™è¯¯</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <p class="mt-2 mb-0">
                        <small>æ€»è®¡å¤„ç† ${data.data.total} æ¡è®°å½•ï¼Œå…¶ä¸­ ${data.data.notFoundCount || 0} æ¡å› æ‰¾ä¸åˆ°åŒ¹é…ä¼ä¸šè€Œæœªå¤„ç†ã€‚</small>
                    </p>
                `;
                
                // æ˜¾ç¤ºé”™è¯¯è¯¦æƒ…ï¼ˆå¦‚æœæœ‰ï¼‰
                if (data.data.error > 0 && data.data.error_details && data.data.error_details.length > 0) {
                    const errorTableBody = document.getElementById('contactErrorDetailsTableBody');
                    errorTableBody.innerHTML = '';
                    
                    data.data.error_details.forEach(err => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${err.record?.name || 'æœªçŸ¥'}</td>
                            <td>${err.record?.company_name || 'æœªçŸ¥'}</td>
                            <td>${err.reason || 'æœªçŸ¥é”™è¯¯'}</td>
                        `;
                        errorTableBody.appendChild(row);
                    });
                    
                    contactErrorDetailsDiv.style.display = 'block';
                } else {
                    contactErrorDetailsDiv.style.display = 'none';
                }
                
                // ç¦ç”¨å¯¼å…¥æŒ‰é’®
                importContactBtn.disabled = true;
            } else {
                contactResultDiv.className = 'alert alert-danger mt-3';
                contactResultDiv.innerHTML = `
                    <h6><i class="fas fa-exclamation-circle"></i> å¯¼å…¥å¤±è´¥!</h6>
                    <p>${data.message || 'æœªçŸ¥é”™è¯¯'}</p>
                `;
                
                // æ˜¾ç¤ºé”™è¯¯è¯¦æƒ…ï¼ˆå¦‚æœæœ‰ï¼‰
                if (data.data && data.data.error_details && data.data.error_details.length > 0) {
                    const errorTableBody = document.getElementById('contactErrorDetailsTableBody');
                    errorTableBody.innerHTML = '';
                    
                    data.data.error_details.forEach(err => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${err.record?.name || 'æœªçŸ¥'}</td>
                            <td>${err.record?.company_name || 'æœªçŸ¥'}</td>
                            <td>${err.reason || 'æœªçŸ¥é”™è¯¯'}</td>
                        `;
                        errorTableBody.appendChild(row);
                    });
                    
                    contactErrorDetailsDiv.style.display = 'block';
                }
            }
            // æ–°å¢ï¼šæ˜¾ç¤ºè¡ŒåŠ¨è®°å½•å¯¼å…¥ç»“æœ
            if (data.data && data.data.action_import_result) {
                contactResultDiv.innerHTML += `<div class='alert alert-info mt-2'>è¡ŒåŠ¨è®°å½•å¯¼å…¥ï¼šæˆåŠŸ ${data.data.action_import_result.success} æ¡ï¼Œå¤±è´¥ ${data.data.action_import_result.failed} æ¡ã€‚</div>`;
            }
        })
        .catch(error => {
            console.error('å¯¼å…¥è”ç³»äººå‡ºé”™:', error);
            contactProgressDiv.querySelector('.progress-bar').style.width = '100%';
            
            contactResultDiv.className = 'alert alert-danger mt-3';
            contactResultDiv.style.display = 'block';
            contactResultDiv.innerHTML = `
                <h6><i class="fas fa-exclamation-circle"></i> å¯¼å…¥è¯·æ±‚å¤±è´¥!</h6>
                <p>è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥å¹¶é‡è¯•</p>
            `;
        });
    });
}

// æ‰¹é‡åˆ é™¤æŒ‰é’®é€»è¾‘
const checkboxes = document.querySelectorAll('.company-checkbox');
const selectAllCheckbox = document.getElementById('selectAll');
const batchDeleteBtn = document.getElementById('batchDeleteBtn');

// æ›´æ–°æ‰¹é‡åˆ é™¤æŒ‰é’®æ˜¾ç¤ºçŠ¶æ€çš„å‡½æ•°
function updateBatchDeleteButtonVisibility() {
    const checkedCount = document.querySelectorAll('.company-checkbox:checked').length;
    
    if (checkedCount > 0) {
        batchDeleteBtn.style.display = 'inline-block';
        // æ·»åŠ åŠ¨ç”»æ•ˆæœ
        batchDeleteBtn.style.animation = 'fadeInRight 0.3s ease forwards';
    } else {
        // æ·»åŠ æ·¡å‡ºåŠ¨ç”»
        batchDeleteBtn.style.animation = 'fadeOutRight 0.3s ease forwards';
        setTimeout(() => {
            if (document.querySelectorAll('.company-checkbox:checked').length === 0) {
                batchDeleteBtn.style.display = 'none';
            }
        }, 300);
    }
    
    // æ›´æ–°åˆ é™¤æŒ‰é’®æ–‡æœ¬
    if (batchDeleteBtn) {
        batchDeleteBtn.innerHTML = `<i class="fas fa-trash"></i> æ‰¹é‡åˆ é™¤ (${checkedCount})`;
    }
}

// å…¨é€‰checkboxçš„ç‚¹å‡»äº‹ä»¶
if (selectAllCheckbox) {
    selectAllCheckbox.addEventListener('change', function() {
        const isChecked = this.checked;
        
        checkboxes.forEach(function(checkbox) {
            if (!checkbox.disabled) {
                checkbox.checked = isChecked;
            }
        });
        
        // æ·»åŠ è„‰å†²æ•ˆæœç»™å…¨é€‰
        if (isChecked) {
            this.parentElement.classList.add('checkbox-pulse');
            setTimeout(() => {
                this.parentElement.classList.remove('checkbox-pulse');
            }, 1000);
        }
        
        updateBatchDeleteButtonVisibility();
    });
}

// å•ä¸ªcheckboxçš„ç‚¹å‡»äº‹ä»¶
checkboxes.forEach(function(checkbox) {
    checkbox.addEventListener('change', updateBatchDeleteButtonVisibility);
});

// åˆå§‹æ£€æŸ¥
updateBatchDeleteButtonVisibility();
</script>

<!-- æ·»åŠ åŠ¨ç”»æ ·å¼ -->
<style>
    @keyframes fadeInRight {
        from {
            opacity: 0;
            transform: translateX(20px);
        }
        to {
            opacity: 1;
            transform: translateX(0);
        }
    }
    
    @keyframes fadeOutRight {
        from {
            opacity: 1;
            transform: translateX(0);
        }
        to {
            opacity: 0;
            transform: translateX(20px);
        }
    }
    
    @keyframes checkbox-pulse {
        0% {
            transform: scale(1);
            box-shadow: 0 0 0 0 rgba(13, 110, 253, 0.7);
        }
        70% {
            transform: scale(1.05);
            box-shadow: 0 0 0 10px rgba(13, 110, 253, 0);
        }
        100% {
            transform: scale(1);
            box-shadow: 0 0 0 0 rgba(13, 110, 253, 0);
        }
    }
    
    .checkbox-pulse {
        animation: checkbox-pulse 1s cubic-bezier(0.66, 0, 0, 1);
    }
</style>
{% endblock %}