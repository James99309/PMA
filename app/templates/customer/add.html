{% extends "base.html" %}

{% block title %}添加客户{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header">
                    <h4>添加企业</h4>
                </div>
                <div class="card-body">
                    <div class="alert alert-info" role="alert">
                        <h5 class="alert-heading"><i class="fas fa-info-circle"></i> 添加企业须知</h5>
                        <p>系统会检查您输入的企业名称是否已经存在。如果企业已存在：</p>
                        <ul>
                            <li>您可以看到已存在企业的名称作为参考</li>
                            <li>系统不会允许您添加名称完全相同的企业（忽略大小写和空格）</li>
                            <li>如需修改已有企业信息，请联系管理员</li>
                        </ul>
                    </div>
                    <form method="POST">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <div class="mb-3 position-relative">
                            <label for="company_name" class="form-label">企业名称</label>
                            <input type="text" class="form-control" id="company_name" name="company_name" required>
                            <div id="company-suggestions" class="position-absolute w-100 mt-1 d-none" style="z-index: 1000;"></div>
                            <div id="company-name-error" class="invalid-feedback"></div>
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-4">
                                <label for="country" class="form-label">国家/地区</label>
                                <select class="form-select" id="country" name="country" required>
                                    <option value="">请选择国家</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label for="province" class="form-label">省份/城市</label>
                                <select class="form-select" id="province" name="province" required>
                                    <option value="">请选择省份/城市</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label for="city" class="form-label">区域</label>
                                <select class="form-select" id="city" name="city" required>
                                    <option value="">请选择区域</option>
                                </select>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="address" class="form-label">详细地址</label>
                            <input type="text" class="form-control" id="address" name="address">
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="industry" class="form-label">行业</label>
                                <select class="form-select" id="industry" name="industry">
                                    <option value="">请选择行业</option>
                                    <option value="制造业">制造业</option>
                                    <option value="建筑业">建筑业</option>
                                    <option value="房地产业">房地产业</option>
                                    <option value="批发和零售业">批发和零售业</option>
                                    <option value="交通运输业">交通运输业</option>
                                    <option value="信息技术服务">信息技术服务</option>
                                    <option value="金融业">金融业</option>
                                    <option value="教育">教育</option>
                                    <option value="医疗卫生">医疗卫生</option>
                                    <option value="其他">其他</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="company_type" class="form-label">企业类型</label>
                                <select class="form-select" id="company_type" name="company_type" required>
                                    <option value="">-- 请选择企业类型 --</option>
                                    <option value="用户">用户</option>
                                    <option value="经销商">经销商</option>
                                    <option value="系统集成商">系统集成商</option>
                                    <option value="设计院及顾问">设计院及顾问</option>
                                    <option value="总承包单位">总承包单位</option>
                                </select>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="status" class="form-label">状态</label>
                            <select class="form-select" id="status" name="status">
                                <option value="活跃">活跃</option>
                                <option value="非活跃">非活跃</option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label for="notes" class="form-label">备注</label>
                            <textarea class="form-control" id="notes" name="notes" rows="3"></textarea>
                        </div>

                        <hr class="my-4">
                        <h5>主要联系人信息</h5>

                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="contact_name" class="form-label">联系人姓名</label>
                                <input type="text" class="form-control" id="contact_name" name="contact_name">
                            </div>
                            <div class="col-md-6">
                                <label for="contact_department" class="form-label">部门</label>
                                <input type="text" class="form-control" id="contact_department" name="contact_department">
                            </div>
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="contact_position" class="form-label">职位</label>
                                <input type="text" class="form-control" id="contact_position" name="contact_position">
                            </div>
                            <div class="col-md-6">
                                <label for="contact_phone" class="form-label">电话</label>
                                <input type="text" class="form-control" id="contact_phone" name="contact_phone">
                            </div>
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="contact_email" class="form-label">邮箱</label>
                                <input type="email" class="form-control" id="contact_email" name="contact_email">
                            </div>
                            <div class="col-md-6">
                                <label for="contact_notes" class="form-label">备注</label>
                                <input type="text" class="form-control" id="contact_notes" name="contact_notes">
                            </div>
                        </div>

                        <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                            <a href="{{ url_for('customer.list_companies') }}" class="btn btn-secondary me-md-2">取消</a>
                            <button type="submit" class="btn btn-primary">保存</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/area_data.js') }}"></script>
<script src="{{ url_for('static', filename='js/area_selector.js') }}"></script>
<script>
// 公司名称模糊搜索和自动填充功能
$(document).ready(function() {
    const companyInput = $('#company_name');
    const suggestionsContainer = $('#company-suggestions');
    const saveButton = $('button[type="submit"]');
    let debounceTimer;
    let selectedCompanyData = null;
    let matchedCompanies = []; // 存储所有匹配的公司名称
    
    // 获取错误消息容器
    const errorMsgElement = $('#company-name-error');
    
    // 创建建议下拉列表的样式
    suggestionsContainer.addClass('list-group shadow-sm');
    
    // 验证公司名称是否重复
    function validateCompanyName(inputValue) {
        const normalizedInput = inputValue.trim().toLowerCase();
        
        // 重置状态
        companyInput.removeClass('is-invalid');
        errorMsgElement.text('');
        saveButton.prop('disabled', false);
        
        // 检查是否与现有公司名称完全匹配（忽略大小写和空格）
        for (let company of matchedCompanies) {
            const companyName = company.name.trim().toLowerCase();
            if (normalizedInput === companyName) {
                // 设置错误状态
                companyInput.addClass('is-invalid');
                errorMsgElement.text('客户名称已存在，无法保存，请更换名称或联系管理员');
                saveButton.prop('disabled', true);
                return false;
            }
        }
        
        return true;
    }
    
    // 处理输入事件
    companyInput.on('input', function() {
        clearTimeout(debounceTimer);
        const keyword = $(this).val().trim();
        
        // 清除之前选择的公司数据
        selectedCompanyData = null;
        
        // 即使输入长度小于2，也要验证输入
        validateCompanyName(keyword);
        
        // 如果输入长度小于2，不进行搜索
        if (keyword.length < 2) {
            suggestionsContainer.empty().addClass('d-none');
            return;
        }
        
        // 设置延迟300ms后执行，避免频繁请求
        debounceTimer = setTimeout(function() {
            // 发送AJAX请求
            $.ajax({
                url: '/customer/api/company/search',
                type: 'GET',
                data: { keyword: keyword },
                success: function(response) {
                    // 清空匹配公司列表并重新填充
                    matchedCompanies = response.results || [];
                    
                    // 验证当前输入
                    validateCompanyName(companyInput.val());
                    
                    if (matchedCompanies.length > 0) {
                        // 显示建议列表
                        suggestionsContainer.empty().removeClass('d-none');
                        
                        // 添加每个建议项
                        matchedCompanies.forEach(function(company) {
                            const item = $('<a href="javascript:void(0)" class="list-group-item list-group-item-action"></a>')
                                .text(company.display);
                            
                            // 根据权限状态添加不同的点击事件和样式
                            if (company.has_permission) {
                                item.data('company', company)
                                    .on('click', function() {
                                        // 设置选中的公司数据
                                        selectedCompanyData = $(this).data('company');
                                        
                                        // 设置输入框值为公司名称
                                        companyInput.val(selectedCompanyData.name);
                                        
                                        // 自动填充其他字段
                                        fillCompanyData(selectedCompanyData);
                                        
                                        // 隐藏建议列表
                                        suggestionsContainer.addClass('d-none');
                                        
                                        // 验证公司名称
                                        validateCompanyName(selectedCompanyData.name);
                                    });
                            } else {
                                // 无权限的公司显示特殊样式
                                item.addClass('text-muted')
                                    .on('click', function() {
                                        // 只设置名称，不填充其他字段
                                        companyInput.val(company.name);
                                        
                                        // 隐藏建议列表
                                        suggestionsContainer.addClass('d-none');
                                        
                                        // 显示红色边框和错误消息
                                        companyInput.addClass('is-invalid');
                                        errorMsgElement.text('该客户已存在，无法保存，请更换名称或联系管理员');
                                        saveButton.prop('disabled', true);
                                        
                                        // 显示提示
                                        alert('该客户已存在，仅供参考，您无权限修改信息');
                                    });
                                
                                // 添加提示图标
                                item.prepend('<i class="fas fa-lock text-muted mr-2"></i> ');
                            }
                            
                            suggestionsContainer.append(item);
                        });
                    } else {
                        // 没有建议时隐藏列表
                        suggestionsContainer.empty().addClass('d-none');
                    }
                },
                error: function(xhr, status, error) {
                    console.error('搜索企业失败:', error);
                    suggestionsContainer.empty().addClass('d-none');
                }
            });
        }, 300);
    });
    
    // 失去焦点时隐藏建议列表（延迟处理以便点击建议列表项）
    companyInput.on('blur', function() {
        setTimeout(function() {
            suggestionsContainer.addClass('d-none');
            
            // 失去焦点时验证公司名称
            validateCompanyName(companyInput.val());
        }, 200);
    });
    
    // 获得焦点时，如果有内容则显示建议列表
    companyInput.on('focus', function() {
        const keyword = $(this).val().trim();
        if (keyword.length >= 2 && suggestionsContainer.children().length > 0) {
            suggestionsContainer.removeClass('d-none');
        }
    });
    
    // 自动填充公司数据
    function fillCompanyData(company) {
        // 设置区域选择器
        if (window.areaSelector) {
            if (company.country) {
                $('#country').val(company.country).trigger('change');
                if (company.province) {
                    setTimeout(() => {
                        $('#province').val(company.province).trigger('change');
                        if (company.city) {
                            setTimeout(() => {
                                $('#city').val(company.city);
                            }, 100);
                        }
                    }, 100);
                }
            }
        }
        
        // 设置其他字段
        $('#address').val(company.address || '');
        $('#industry').val(company.industry || '');
        $('#company_type').val(company.company_type || '');
        $('#status').val(company.status || 'active');
        $('#notes').val(company.notes || '');
    }
    
    // 表单提交前再次验证
    $('form').on('submit', function(e) {
        if (!validateCompanyName(companyInput.val())) {
            e.preventDefault();
            alert('客户名称已存在，无法保存，请更换名称或联系管理员');
            return false;
        }
    });
});
</script>
{% endblock %} 