{% extends "base.html" %}
{% from 'macros/ui_helpers.html' import render_button %}

{% block head %}
{{ super() }}
<!-- 强制清除浏览器缓存 -->
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">
<link rel="stylesheet" href="https://code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css">
<style>
    /* 产品名称下拉菜单容器 */
    .product-dropdown-container {
        position: relative;
    }

    /* 类别列表样式 */
    .category-list {
        display: none;
        position: absolute;
        width: 100%;
        max-height: 300px;
        overflow-y: auto;
        background-color: #fff;
        border: 1px solid #ced4da;
        border-radius: 0.25rem;
        z-index: 1000;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.15);
    }

    .category-list.show {
        display: block;
    }

    .category-item {
        padding: 8px 12px;
        cursor: pointer;
        border-bottom: 1px solid #e9ecef;
    }

    .category-item:hover {
        background-color: #f8f9fa;
    }

    .category-item.active {
        background-color: #e9ecef;
    }

    /* 产品名称列表样式 */
    .product-name-list {
        display: none;
        margin-left: 20px;
    }

    .product-name-list.show {
        display: block;
    }

    .product-name-item {
        padding: 6px 12px;
        cursor: pointer;
    }

    .product-name-item:hover {
        background-color: #f8f9fa;
    }

    /* 型号下拉菜单样式 */
    .model-list {
        display: none;
        position: absolute;
        width: 100%;
        max-height: 200px;
        overflow-y: auto;
        background-color: #fff;
        border: 1px solid #ced4da;
        border-radius: 0.25rem;
        z-index: 1000;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.15);
    }

    .model-list.show {
        display: block;
    }

    .model-item {
        padding: 8px 12px;
        cursor: pointer;
        border-bottom: 1px solid #e9ecef;
    }

    .model-item:hover {
        background-color: #f8f9fa;
    }

    /* 必填字段标记 */
    .required-field::after {
        content: "*";
        color: red;
        margin-left: 4px;
    }

    /* 输入框不可用时的样式 */
    .form-control:disabled,
    .form-control[readonly] {
        background-color: #e9ecef;
        opacity: 1;
    }

    /* 按钮间距 */
    .btn-toolbar .btn {
        margin-right: 10px;
    }

    /* 自定义数字输入框样式 */
    input[type="number"].form-control {
        text-align: right;
    }

    /* MN号输入框容器 */
    .mn-input-group {
        position: relative;
    }

    /* MN号校验反馈 */
    .mn-feedback {
        display: none;
        position: absolute;
        width: 100%;
        margin-top: 0.25rem;
        font-size: 80%;
    }

    .mn-feedback.valid {
        color: #28a745;
        display: block;
    }

    .mn-feedback.invalid {
        color: #dc3545;
        display: block;
    }

    /* 错误消息样式 */
    #mn-error-message {
        min-height: 1.5rem;
        font-weight: 500;
        color: #dc3545;
    }

    /* 产品图片上传区域样式 */
    .product-image-upload {
        width: 100%;
        max-width: 300px;
        margin-bottom: 20px;
    }

    .image-preview-container {
        width: 100%;
        padding-bottom: 100%; /* 1:1的比例，形成正方形 */
        position: relative;
        overflow: hidden;
        background-color: #f8f9fa;
        border-radius: 8px;
        margin-bottom: 1rem;
        border: 2px dashed #ced4da;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .image-preview-container:hover {
        border-color: #adb5bd;
    }

    .image-preview {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        object-fit: contain;
        display: none;
    }

    .image-placeholder {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        color: #adb5bd;
    }

    .image-placeholder i {
        font-size: 3rem;
        margin-bottom: 0.5rem;
    }

    .image-placeholder span {
        font-size: 0.9rem;
        text-align: center;
    }

    .image-file-input {
        display: none;
    }

    .image-actions {
        display: flex;
        justify-content: space-between;
    }

    /* PDF文件上传容器样式 */
    .pdf-upload-container {
        position: relative;
    }

    /* 当前PDF文件显示样式 */
    .current-pdf {
        margin-top: 10px;
        padding: 10px;
        background-color: #f8f9fa;
        border: 1px solid #ced4da;
        border-radius: 0.25rem;
    }

    .current-pdf .d-flex {
        align-items: center;
    }

    .current-pdf .text-danger {
        margin-right: 10px;
    }

    .current-pdf .btn {
        margin-left: auto;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="card">
        <div class="card-header">
            <h5>{% if product %}编辑产品{% else %}创建新产品{% endif %}</h5>
        </div>
        <div class="card-body">
            <form id="product-form" enctype="multipart/form-data">
                {% if product %}
                <input type="hidden" id="product-id" value="{{ product.id }}">
                {% endif %}

                <!-- 基本信息 -->
                <div class="row mb-4">
                    <div class="col-md-12">
                        <h6 class="border-bottom pb-2">基本信息</h6>
                    </div>

                    <!-- 产品图片上传区域 -->
                    <div class="col-md-6 mb-3">
                        <label class="form-label">产品图片</label>
                        <div class="product-image-upload">
                            <div class="image-preview-container" id="image-preview-container">
                                {% if product and product.image_path %}
                                <img src="{{ url_for('static', filename='uploads/products/' + product.image_path) }}"
                                     alt="产品图片"
                                     class="image-preview"
                                     id="image-preview"
                                     style="display: block;">
                                <div class="image-placeholder" style="display: none;">
                                    <i class="fas fa-cloud-upload-alt"></i>
                                    <span>点击上传图片<br>或拖放图片到此处</span>
                                </div>
                                {% else %}
                                <img src="" alt="产品图片" class="image-preview" id="image-preview">
                                <div class="image-placeholder">
                                    <i class="fas fa-cloud-upload-alt"></i>
                                    <span>点击上传图片<br>或拖放图片到此处</span>
                                </div>
                                {% endif %}
                                <input type="file" id="product-image" name="product_image" class="image-file-input" accept="image/*">
                            </div>
                            <div class="image-actions">
                                <button type="button" id="upload-image-btn" class="btn btn-sm btn-outline-primary">选择图片</button>
                                <button type="button" id="remove-image-btn" class="btn btn-sm btn-outline-danger" {% if not product or not product.image_path %}style="display: none;"{% endif %}>移除图片</button>
                            </div>
                            <small class="text-muted">支持JPG、PNG格式，图片大小不超过5MB，支持中文文件名 (v2.1)</small>
                        </div>
                    </div>

                    <!-- PDF文件上传 -->
                    <div class="col-md-6 mb-3">
                        <label for="product-pdf" class="form-label">产品文档</label>
                        <div class="pdf-upload-container">
                            <input type="file" class="form-control" id="product-pdf" name="product_pdf" accept=".pdf">
                            <div class="form-text">支持PDF格式，文件大小不超过12MB，支持中文文件名 (v2.1)</div>
                            {% if product and product.pdf_path %}
                            <div class="current-pdf mt-2">
                                <div class="d-flex align-items-center">
                                    <i class="fas fa-file-pdf text-danger me-2"></i>
                                    <span class="me-2">当前PDF文件</span>
                                    <a href="{{ url_for('product_route.download_pdf', id=product.id) }}" 
                                       class="btn btn-sm btn-outline-primary me-2" target="_blank">
                                        <i class="fas fa-download"></i> 下载
                                    </a>
                                    <button type="button" class="btn btn-sm btn-outline-danger" id="remove-pdf-btn">
                                        <i class="fas fa-trash"></i> 删除
                                    </button>
                                </div>
                            </div>
                            <input type="hidden" name="remove_pdf" id="remove-pdf-flag" value="false">
                            {% endif %}
                        </div>
                    </div>

                    <!-- 产品名称 (支持二级下拉) -->
                    <div class="col-md-6 mb-3">
                        <label for="product-name" class="form-label required-field">产品名称</label>
                        <div class="product-dropdown-container">
                            <input type="text" class="form-control" id="product-name" name="product_name" placeholder="选择或输入产品名称" required {% if product %}value="{{ product.product_name }}"{% endif %}>
                            <div class="category-list" id="category-list">
                                <!-- 类别列表将通过JavaScript动态加载 -->
                            </div>
                        </div>
                    </div>

                    <!-- 产品类别 -->
                    <div class="col-md-6 mb-3">
                        <label for="category" class="form-label">产品类别</label>
                        <select class="form-select" id="category" name="category">
                            <option value="">-- 选择产品类别 --</option>
                            <!-- 类别选项将通过JavaScript动态加载 -->
                        </select>
                    </div>

                    <!-- 产品型号 -->
                    <div class="col-md-6 mb-3">
                        <label for="model" class="form-label required-field">产品型号</label>
                        <div class="product-dropdown-container">
                            <input type="text" class="form-control" id="model" name="model" placeholder="选择或输入产品型号" required {% if product %}value="{{ product.model }}"{% endif %}>
                            <div class="model-list" id="model-list">
                                <!-- 型号列表将通过JavaScript动态加载 -->
                            </div>
                        </div>
                    </div>

                    <!-- 产品MN号 -->
                    <div class="col-md-6 mb-3">
                        <label for="product-mn" class="form-label required-field">产品MN号</label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="product-mn" name="product_mn" placeholder="输入MN号" required {% if product %}value="{{ product.product_mn }}"{% endif %}>
                            <button class="btn btn-outline-secondary" type="button" id="generate-mn" title="生成MN号">
                                <i class="fas fa-magic"></i>
                            </button>
                        </div>
                        <div id="mn-error-message" class="small mt-1"></div>
                        <small class="text-muted">MN号必须唯一</small>
                    </div>
                </div>

                <!-- 规格与价格 -->
                <div class="row mb-4">
                    <div class="col-md-12">
                        <h6 class="border-bottom pb-2">规格与价格</h6>
                    </div>

                    <!-- 产品类型 -->
                    <div class="col-md-6 mb-3">
                        <label for="type" class="form-label">产品类型</label>
                        <select class="form-select" id="type" name="type">
                            <option value="">-- 选择产品类型 --</option>
                            <option value="渠道产品">渠道产品</option>
                            <option value="项目产品">项目产品</option>
                            <option value="第三方产品">第三方产品</option>
                        </select>
                    </div>

                    <!-- 品牌 -->
                    <div class="col-md-6 mb-3">
                        <label for="brand" class="form-label">品牌</label>
                        <input type="text" class="form-control" id="brand" name="brand" placeholder="选择或输入产品品牌" list="brand-list" {% if product %}value="{{ product.brand }}"{% endif %}>
                        <datalist id="brand-list">
                            <!-- 品牌选项将通过JavaScript动态加载 -->
                        </datalist>
                        <div class="invalid-feedback">请选择或输入品牌</div>
                    </div>

                    <!-- 单位 -->
                    <div class="col-md-6 mb-3">
                        <label for="unit" class="form-label">单位</label>
                        <select class="form-select" id="unit" name="unit">
                            <option value="">-- 选择单位 --</option>
                            <!-- 单位选项将通过JavaScript动态加载 -->
                        </select>
                    </div>

                    <!-- 市场价格 -->
                    <div class="col-md-6 mb-3">
                        <label for="retail-price" class="form-label">市场价格</label>
                        <input type="number" class="form-control" id="retail-price" name="retail_price" placeholder="0.00" step="0.01" min="0" {% if product %}value="{{ product.retail_price }}"{% endif %}>
                    </div>

                    <!-- 生产状态 - 使用选择框 -->
                    <div class="col-md-6 mb-3">
                        <label for="status" class="form-label">生产状态</label>
                        <select class="form-select" id="status" name="status" {% if current_user.role != 'admin' %}disabled{% endif %}>
                          <option value="active" {% if product and product.status == 'active' %}selected{% endif %}>生产中</option>
                          <option value="discontinued" {% if product and product.status == 'discontinued' %}selected{% endif %}>已停产</option>
                          <option value="upcoming" {% if product and product.status == 'upcoming' %}selected{% endif %}>待上市</option>
                        </select>
                        {% if current_user.role != 'admin' %}
                        <small class="text-danger">仅管理员可修改状态</small>
                        {% endif %}
                    </div>
                </div>

                <!-- 规格说明 -->
                <div class="col-md-12 mb-3">
                    <label for="specification" class="form-label">规格说明</label>
                    <textarea class="form-control" id="specification" name="specification" rows="3" placeholder="产品规格说明">{% if product %}{{ product.specification }}{% endif %}</textarea>
                </div>

                <!-- 按钮工具栏 -->
                <div class="btn-toolbar">
                    {{ render_button('保存', type='submit', color='primary', icon='fas fa-save') }}
                    {{ render_button('取消', href=url_for('product_route.product_list'), color='secondary', icon='fas fa-times') }}
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script src="https://code.jquery.com/ui/1.13.2/jquery-ui.min.js"></script>
<script>
    // 全局变量
    let categories = [];
    let productNamesByCategory = {};
    let modelsByProductName = {};
    let mnCheckTimeout = null;
    let isMnValid = false;
    let isSelectingFromDropdown = false;
    let originalProductData = {}; // 保存原始产品数据
    let apiLoadCount = 0; // API加载计数器
    const totalApiToLoad = 3; // 需要加载的API总数：类别、单位、品牌

    // 保存原始数据函数
    function saveOriginalData() {
        const productId = document.getElementById('product-id');
        if (productId) {
            originalProductData = {
                product_name: document.getElementById('product-name').value,
                category: document.getElementById('category').value,
                model: document.getElementById('model').value,
                product_mn: document.getElementById('product-mn').value,
                type: document.getElementById('type').value,
                brand: document.getElementById('brand').value,
                unit: document.getElementById('unit').value,
                retail_price: document.getElementById('retail-price').value,
                status: document.getElementById('status').value,
                specification: document.getElementById('specification').value
            };
            console.log("所有API加载完成，原始数据已保存:", originalProductData);
        }
    }

    // 检查API是否全部加载完成
    function checkApiLoaded() {
        apiLoadCount++;
        console.log(`API加载进度: ${apiLoadCount}/${totalApiToLoad}`);
        if (apiLoadCount >= totalApiToLoad) {
            // 所有API已加载完成，现在保存原始数据
            saveOriginalData();
        }
    }

    // 页面加载完成后执行
    document.addEventListener('DOMContentLoaded', function() {
        // 加载类别数据
        loadCategories();

        // 加载单位数据
        loadUnits();

        // 加载产品类型数据
        loadTypes();

        // 加载品牌数据
        loadBrands();

        // 绑定产品名称输入框事件
        const productNameInput = document.getElementById('product-name');
        productNameInput.addEventListener('focus', function() {
            document.getElementById('category-list').classList.add('show');
        });

        productNameInput.addEventListener('input', function() {
            // 如果用户输入了内容，暂时隐藏下拉列表
            const categoryList = document.getElementById('category-list');
            if (this.value.trim() !== '') {
                categoryList.classList.remove('show');
            } else {
                categoryList.classList.add('show');
            }
        });

        // 绑定型号输入框事件
        const modelInput = document.getElementById('model');
        modelInput.addEventListener('click', function() {
            // 只有在点击时才显示下拉菜单
            const productName = document.getElementById('product-name').value;
            if (productName) {
                const showDropdown = true;
                if (modelsByProductName[productName]) {
                    renderModelList(modelsByProductName[productName], showDropdown);
                } else {
                    loadModelsByProductName(productName, showDropdown);
                }
            }
        });

        // 焦点事件修改为不自动显示下拉菜单
        modelInput.addEventListener('focus', function(e) {
            // 如果是通过点击获得焦点，则已经由click事件处理
            // 此处不再显示下拉菜单，只预加载数据
            if (e.detail === 0) { // 非鼠标点击导致的focus（如Tab键）
                const productName = document.getElementById('product-name').value;
                if (productName && !modelsByProductName[productName]) {
                    // 只加载数据，不显示下拉菜单
                    loadModelsByProductName(productName, false);
                }
            }
        });

        modelInput.addEventListener('input', function() {
            // 隐藏下拉列表
            document.getElementById('model-list').classList.remove('show');
        });

        // 绑定MN号输入框事件
        const mnInput = document.getElementById('product-mn');
        mnInput.addEventListener('input', function() {
            // 清除之前的延时检查
            if (mnCheckTimeout) {
                clearTimeout(mnCheckTimeout);
            }

            // 设置延时，避免频繁请求
            mnCheckTimeout = setTimeout(function() {
                checkMnAvailability();
            }, 500);
        });

        // 绑定生成MN号按钮事件
        document.getElementById('generate-mn').addEventListener('click', function() {
            // 简单实现：生成随机MN号
            // 实际项目中，可能需要调用特定的API或算法
            const randomMn = 'MN' + Date.now().toString().slice(-8) + Math.floor(Math.random() * 1000).toString().padStart(3, '0');
            document.getElementById('product-mn').value = randomMn;

            // 检查MN号是否可用
            checkMnAvailability();
        });

        // 处理表单提交
        $('#product-form').on('submit', function(e) {
            e.preventDefault();

            // 显示加载状态
            showLoading();

            // 清除所有错误提示
            $('.is-invalid').removeClass('is-invalid');
            $('.invalid-feedback').hide();

            // 创建FormData对象，用于文件上传
            const formData = new FormData(this);

            // 添加调试日志
            console.log('表单提交开始');
            console.log('生产状态:', $('#status').val());

            // 检查是否有图片上传
            const imageFile = $('#product-image')[0].files[0];
            if (imageFile) {
                console.log('检测到图片上传：', imageFile.name, imageFile.size, 'bytes');
            } else {
                console.log('没有新图片上传');
            }

            // 如果是编辑模式，设置更新API的URL
            let url = '/api/products/create';
            if ($('#product-id').length > 0) {
                const productId = $('#product-id').val();
                url = `/api/products/${productId}/update`;
                console.log('编辑模式，产品ID:', productId);
            }

            // 发送请求
            $.ajax({
                url: url,
                type: 'POST',
                data: formData,
                contentType: false, // 必须设为false，让jQuery不要设置Content-Type
                processData: false, // 必须设为false，让jQuery不要处理发送的数据
                success: function(response) {
                    console.log('请求成功:', response);
                    if (response.success) {
                        // 显示成功消息
                        showMessage('success', response.message);

                        // 如果是创建操作，清空表单
                        if (!$('#product-id').length) {
                            resetForm();
                        } else {
                            // 编辑成功后返回列表页面
                            setTimeout(function() {
                                window.location.href = '/products';
                            }, 1500);
                        }
                    } else {
                        showMessage('error', response.message);
                    }
                },
                error: function(xhr, status, error) {
                    console.error('请求错误:', xhr.responseText);
                    let errorMessage = '操作失败，请重试';
                    try {
                        const response = JSON.parse(xhr.responseText);
                        if (response.message) {
                            errorMessage = response.message;
                        }
                    } catch (e) {
                        console.error('解析错误响应失败:', e);
                    }

                    showMessage('error', errorMessage);
                },
                complete: function() {
                    // 隐藏加载状态
                    hideLoading();
                }
            });
        });

        // 如果是编辑模式，初始化相关数据
        const productId = document.getElementById('product-id');
        if (productId) {
            // 记录原始产品数据用于变更检测
            originalProductData = {
                product_name: document.getElementById('product-name').value,
                category: document.getElementById('category').value,
                model: document.getElementById('model').value,
                product_mn: document.getElementById('product-mn').value,
                type: document.getElementById('type').value,
                brand: document.getElementById('brand').value,
                unit: document.getElementById('unit').value,
                retail_price: document.getElementById('retail-price').value,
                status: document.getElementById('status').value,
                specification: document.getElementById('specification').value
            };

            // 仅加载型号数据，但不显示下拉菜单
            const showDropdown = false;
            loadModelsByProductName(document.getElementById('product-name').value, showDropdown);

            // 检查MN号是否有效
            checkMnAvailability();
        }

        // 点击页面其他位置关闭下拉列表
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.product-dropdown-container')) {
                document.getElementById('category-list').classList.remove('show');
                document.getElementById('model-list').classList.remove('show');
            }
        });

        // 初始化图片上传
        initImageUpload();

        // 初始化PDF删除功能
        initPdfRemove();

        // 初始化PDF文件上传验证
        initPdfUpload();
    });

    // 加载产品类别
    function loadCategories() {
        fetch('/api/products/categories')
            .then(response => {
                if (!response.ok) {
                    throw new Error('网络响应不正常');
                }
                return response.json();
            })
            .then(data => {
                // 定义类别的自定义顺序（与服务器端保持一致，作为备份）
                const categoryOrder = {
                    '基站': 1,
                    '合路平台': 2,
                    '直放站': 3,
                    '天线': 4,
                    '功率分配器': 5,
                    '功率/耦合器': 6,
                    '对讲机': 7,
                    '配件': 8,
                    '应用': 9,
                    '服务': 10
                };

                // 再次排序以确保顺序正确（以防服务器端排序失败）
                categories = data.sort((a, b) => {
                    const orderA = categoryOrder[a] || 999;
                    const orderB = categoryOrder[b] || 999;
                    return orderA - orderB;
                });

                // 渲染产品名称下拉列表的类别部分
                renderCategoryList();

                // 填充类别下拉框
                const categorySelect = document.getElementById('category');
                const firstOption = categorySelect.options[0];
                categorySelect.innerHTML = '';
                categorySelect.appendChild(firstOption);

                // 当前选择的类别（如果是编辑模式）
                const currentCategory = '{{ product.category if product else "" }}';

                // 添加从服务器获取的类别选项
                categories.forEach(category => {
                    const option = document.createElement('option');
                    option.value = category;
                    option.textContent = category;

                    // 如果是编辑模式，检查是否需要选中
                    if (currentCategory === category) {
                        option.selected = true;
                    }

                    categorySelect.appendChild(option);
                });

                // 添加类别选择变更事件
                categorySelect.addEventListener('change', function() {
                    // 产品类别选择变更时，不会影响产品名称的内容
                    // 可以在此添加其他处理逻辑
                });

                checkApiLoaded();
            })
            .catch(error => {
                console.error('加载产品类别失败:', error);
                document.getElementById('category-list').innerHTML = '<div class="p-3 text-danger">加载类别失败</div>';
            });
    }

    // 加载产品单位
    function loadUnits() {
        fetch('/api/products/units')
            .then(response => {
                if (!response.ok) {
                    throw new Error('网络响应不正常');
                }
                return response.json();
            })
            .then(data => {
                const unitSelect = document.getElementById('unit');
                // 保留第一个选项（-- 选择单位 --）
                const firstOption = unitSelect.options[0];
                unitSelect.innerHTML = '';
                unitSelect.appendChild(firstOption);

                // 当前选择的单位（如果是编辑模式）
                const currentUnit = '{{ product.unit if product else "" }}';

                // 添加从服务器获取的单位选项
                data.forEach(unit => {
                    const option = document.createElement('option');
                    option.value = unit;
                    option.textContent = unit;

                    // 如果是编辑模式，检查是否需要选中
                    if (currentUnit === unit) {
                        option.selected = true;
                    }

                    unitSelect.appendChild(option);
                });

                checkApiLoaded();
            })
            .catch(error => {
                console.error('加载产品单位失败:', error);
                // 不添加默认单位，仅显示错误信息
                const unitSelect = document.getElementById('unit');
                const firstOption = unitSelect.options[0];
                unitSelect.innerHTML = '';
                unitSelect.appendChild(firstOption);
            });
    }

    // 加载产品类型
    function loadTypes() {
        // 如果是编辑模式，设置产品类型选中状态
        const currentType = '{{ product.type if product else "" }}';
        if (currentType) {
            const typeSelect = document.getElementById('type');
            for (let i = 0; i < typeSelect.options.length; i++) {
                if (typeSelect.options[i].value === currentType) {
                    typeSelect.selectedIndex = i;
                    break;
                }
            }
        }

        checkApiLoaded();
    }

    // 加载产品品牌列表
    function loadBrands() {
        fetch('/api/products/brands')
            .then(response => {
                if (!response.ok) {
                    throw new Error('网络响应不正常');
                }
                return response.json();
            })
            .then(data => {
                const brandList = document.getElementById('brand-list');
                brandList.innerHTML = '';

                // 添加从服务器获取的品牌选项
                data.forEach(brand => {
                    const option = document.createElement('option');
                    option.value = brand;
                    brandList.appendChild(option);
                });

                console.log(`成功加载 ${data.length} 个品牌选项`);

                checkApiLoaded();
            })
            .catch(error => {
                console.error('加载产品品牌失败:', error);
            });
    }

    // 渲染类别列表
    function renderCategoryList() {
        const categoryList = document.getElementById('category-list');
        categoryList.innerHTML = '';

        categories.forEach(category => {
            const categoryItem = document.createElement('div');
            categoryItem.className = 'category-item';
            categoryItem.textContent = category;
            categoryItem.setAttribute('data-category', category);

            // 添加产品名称列表容器
            const productNameList = document.createElement('div');
            productNameList.className = 'product-name-list';
            productNameList.id = `product-names-${category.replace(/\s+/g, '-')}`;

            // 点击类别时加载产品名称
            categoryItem.addEventListener('click', function(e) {
                e.stopPropagation();

                // 切换显示产品名称列表
                const isActive = this.classList.contains('active');
                document.querySelectorAll('.category-item').forEach(item => {
                    item.classList.remove('active');
                    document.getElementById(`product-names-${item.getAttribute('data-category').replace(/\s+/g, '-')}`).classList.remove('show');
                });

                if (!isActive) {
                    this.classList.add('active');
                    productNameList.classList.add('show');
                    loadProductNamesByCategory(category);
                }
            });

            categoryItem.appendChild(productNameList);
            categoryList.appendChild(categoryItem);
        });
    }

    // 加载指定类别的产品名称
    function loadProductNamesByCategory(category) {
        // 如果已缓存该类别的产品名称，直接使用
        if (productNamesByCategory[category]) {
            renderProductNameList(category, productNamesByCategory[category]);
            return;
        }

        // 否则从服务器获取
        fetch(`/api/products/by-category?category=${encodeURIComponent(category)}`)
            .then(response => response.json())
            .then(data => {
                productNamesByCategory[category] = data;
                renderProductNameList(category, data);
            })
            .catch(error => {
                console.error(`加载类别 "${category}" 的产品名称失败:`, error);
            });
    }

    // 渲染产品名称列表
    function renderProductNameList(category, productNames) {
        const productNameList = document.getElementById(`product-names-${category.replace(/\s+/g, '-')}`);
        productNameList.innerHTML = '';

        if (productNames.length === 0) {
            const emptyItem = document.createElement('div');
            emptyItem.className = 'product-name-item';
            emptyItem.textContent = '(暂无产品)';
            productNameList.appendChild(emptyItem);
            return;
        }

        let isSelectingFromDropdown = false;

        productNames.forEach(productName => {
            const productNameItem = document.createElement('div');
            productNameItem.className = 'product-name-item';
            productNameItem.textContent = productName;

            // 点击产品名称时更新输入框
            productNameItem.addEventListener('click', function(e) {
                e.stopPropagation();

                isSelectingFromDropdown = true;

                // 更新产品名称输入框
                document.getElementById('product-name').value = productName;

                // 更新产品类别下拉框
                const categorySelect = document.getElementById('category');
                for (let i = 0; i < categorySelect.options.length; i++) {
                    if (categorySelect.options[i].value === category) {
                        categorySelect.selectedIndex = i;
                        break;
                    }
                }

                // 隐藏下拉列表
                document.getElementById('category-list').classList.remove('show');

                // 加载对应的产品型号数据，但不显示下拉菜单
                loadModelsByProductName(productName, false);

                // 自动聚焦到型号输入框，但不展开下拉菜单
                setTimeout(() => {
                    document.getElementById('model').focus();
                }, 100);

                isSelectingFromDropdown = false;
            });

            productNameList.appendChild(productNameItem);
        });
    }

    // 加载指定产品名称的型号
    function loadModelsByProductName(productName, showDropdown = false) {
        // 如果产品名称为空，清空型号列表
        if (!productName) {
            document.getElementById('model-list').innerHTML = '';
            document.getElementById('model-list').classList.remove('show');
            return;
        }

        // 如果已缓存该产品名称的型号，直接使用
        if (modelsByProductName[productName]) {
            renderModelList(modelsByProductName[productName], showDropdown);
            return;
        }

        // 否则从服务器获取
        fetch(`/api/products/by-name?product_name=${encodeURIComponent(productName)}`)
            .then(response => response.json())
            .then(data => {
                modelsByProductName[productName] = data;
                renderModelList(data, showDropdown);

                // 确保型号输入框获得焦点
                setTimeout(() => {
                    document.getElementById('model').focus();
                }, 50);
            })
            .catch(error => {
                console.error(`加载产品 "${productName}" 的型号失败:`, error);
            });
    }

    // 渲染型号列表
    function renderModelList(models, shouldShow = false) {
        const modelList = document.getElementById('model-list');
        modelList.innerHTML = '';

        if (models.length === 0) {
            modelList.classList.remove('show');
            return;
        }

        models.forEach(model => {
            const modelItem = document.createElement('div');
            modelItem.className = 'model-item';
            modelItem.textContent = model.model;
            modelItem.setAttribute('data-model', JSON.stringify(model));

            // 点击型号时更新输入框
            modelItem.addEventListener('click', function() {
                const modelData = JSON.parse(this.getAttribute('data-model'));

                // 只更新型号和MN号
                document.getElementById('model').value = modelData.model;
                document.getElementById('product-mn').value = modelData.product_mn;

                // 隐藏下拉列表
                modelList.classList.remove('show');

                // 检查MN号是否有效
                setTimeout(checkMnAvailability, 100);
            });

            modelList.appendChild(modelItem);
        });

        // 只有在shouldShow为true时才显示下拉菜单
        if (shouldShow) {
            modelList.classList.add('show');
        } else {
            modelList.classList.remove('show');
        }
    }

    // 检查MN号是否可用
    function checkMnAvailability() {
        const mnInput = document.getElementById('product-mn');
        const mnErrorMessage = document.getElementById('mn-error-message');
        const mn = mnInput.value.trim();

        // 清除之前的反馈
        mnErrorMessage.textContent = '';
        mnInput.style.color = '';
        mnInput.style.borderColor = '';

        // 如果MN号为空，直接返回
        if (!mn) {
            isMnValid = false;
            return;
        }

        // 构建请求URL
        let url = `/api/products/check-mn?product_mn=${encodeURIComponent(mn)}`;

        // 如果是编辑模式，需要排除当前产品
        const productId = document.getElementById('product-id');
        if (productId) {
            url += `&exclude_id=${productId.value}`;
        }

        // 发送请求
        fetch(url)
            .then(response => response.json())
            .then(data => {
                if (data.valid) {
                    mnErrorMessage.textContent = '';
                    isMnValid = true;
                } else {
                    mnErrorMessage.textContent = data.message || "MN号已被使用";
                    mnInput.style.color = '#dc3545';
                    mnInput.style.borderColor = '#dc3545';
                    isMnValid = false;
                }
            })
            .catch(error => {
                console.error('检查MN号失败:', error);
                mnErrorMessage.textContent = '检查MN号失败，请稍后再试';
                mnInput.style.color = '#dc3545';
                mnInput.style.borderColor = '#dc3545';
                isMnValid = false;
            });
    }

    // 比较产品数据，返回变更的字段及其旧值和新值
    function compareProductData(oldData, newData) {
        const changes = {};

        for (const field in newData) {
            // 处理retail_price字段为数值比较
            if (field === 'retail_price') {
                const oldValue = parseFloat(oldData[field]) || 0;
                const newValue = parseFloat(newData[field]) || 0;

                if (Math.abs(oldValue - newValue) > 0.01) {  // 考虑浮点数精度问题
                    changes[field] = {
                        old: oldValue.toFixed(2),
                        new: newValue.toFixed(2)
                    };
                }
            }
            // 特殊处理状态字段
            else if (field === 'status') {
                if (oldData[field] !== newData[field]) {
                    const statusTexts = {
                        'active': '生产中',
                        'discontinued': '已停产',
                        'upcoming': '待上市'
                    };
                    changes[field] = {
                        old: statusTexts[oldData[field]] || oldData[field],
                        new: statusTexts[newData[field]] || newData[field]
                    };
                }
            }
            // 处理字符串值 - 改进空值比较逻辑
            else {
                const oldValue = oldData[field] || '';
                const newValue = newData[field] || '';

                // 只有当两个值真正不同时才记录变更
                // 不将空字符串和未定义值视为不同
                if (oldValue.trim() !== newValue.trim()) {
                    // 只有当新值不为空，或者旧值不为空时才记录变更
                    // 避免空→空的变更
                    if (oldValue.trim() !== '' || newValue.trim() !== '') {
                        changes[field] = {
                            old: oldValue.trim() === '' ? '(空)' : oldValue,
                            new: newValue.trim() === '' ? '(空)' : newValue
                        };
                    }
                }
            }
        }

        console.log("变更字段:", Object.keys(changes));
        return changes;
    }

    // 获取字段的中文显示名称
    function getFieldDisplayName(field) {
        const fieldNames = {
            'product_name': '产品名称',
            'category': '产品类别',
            'model': '产品型号',
            'product_mn': 'MN号',
            'type': '产品类型',
            'brand': '品牌',
            'unit': '单位',
            'retail_price': '市场价格',
            'status': '生产状态',
            'specification': '规格说明'
        };

        return fieldNames[field] || field;
    }

    // 初始化图片上传组件
    function initImageUpload() {
        const previewContainer = document.getElementById('image-preview-container');
        const imagePreview = document.getElementById('image-preview');
        const imagePlaceholder = document.querySelector('.image-placeholder');
        const fileInput = document.getElementById('product-image');
        const uploadBtn = document.getElementById('upload-image-btn');
        const removeBtn = document.getElementById('remove-image-btn');

        // 点击预览区域触发文件选择
        previewContainer.addEventListener('click', function() {
            fileInput.click();
        });

        // 点击上传按钮触发文件选择
        uploadBtn.addEventListener('click', function(e) {
            e.preventDefault();
            fileInput.click();
        });

        // 文件拖放功能
        previewContainer.addEventListener('dragover', function(e) {
            e.preventDefault();
            previewContainer.style.borderColor = '#007bff';
        });

        previewContainer.addEventListener('dragleave', function() {
            previewContainer.style.borderColor = '#ced4da';
        });

        previewContainer.addEventListener('drop', function(e) {
            e.preventDefault();
            previewContainer.style.borderColor = '#ced4da';

            if (e.dataTransfer.files.length) {
                fileInput.files = e.dataTransfer.files;
                handleFileSelect();
            }
        });

        // 文件选择处理
        fileInput.addEventListener('change', handleFileSelect);

        function handleFileSelect() {
            if (fileInput.files && fileInput.files[0]) {
                const file = fileInput.files[0];

                // 检查文件类型
                if (!file.type.match('image.*')) {
                    alert('请选择图片文件（JPG、PNG）');
                    return;
                }

                // 检查文件大小（最大5MB）
                if (file.size > 5 * 1024 * 1024) {
                    alert('图片大小不能超过5MB');
                    return;
                }

                const reader = new FileReader();

                reader.onload = function(e) {
                    // 显示预览图
                    imagePreview.src = e.target.result;
                    imagePreview.style.display = 'block';
                    imagePlaceholder.style.display = 'none';
                    removeBtn.style.display = 'block';
                };

                reader.readAsDataURL(file);
            }
        }

        // 移除图片
        removeBtn.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation(); // 防止触发容器的点击事件

            // 清除文件输入
            fileInput.value = '';

            // 隐藏预览，显示占位符
            imagePreview.src = '';
            imagePreview.style.display = 'none';
            imagePlaceholder.style.display = 'flex';
            removeBtn.style.display = 'none';

            // 如果是编辑模式，添加标记以便服务器知道要删除图片
            if (document.getElementById('product-id')) {
                const removeImageFlag = document.createElement('input');
                removeImageFlag.type = 'hidden';
                removeImageFlag.name = 'remove_image';
                removeImageFlag.value = 'true';

                // 移除已存在的标记（如果有）
                const existingFlag = document.querySelector('input[name="remove_image"]');
                if (existingFlag) {
                    existingFlag.parentNode.removeChild(existingFlag);
                }

                document.getElementById('product-form').appendChild(removeImageFlag);
            }
        });
    }

    // 初始化PDF删除功能
    function initPdfRemove() {
        const removePdfBtn = document.getElementById('remove-pdf-btn');
        if (removePdfBtn) {
            removePdfBtn.addEventListener('click', function(e) {
                e.preventDefault();
                
                if (confirm('确定要删除当前的PDF文件吗？')) {
                    // 设置删除标记
                    document.getElementById('remove-pdf-flag').value = 'true';
                    
                    // 隐藏当前PDF显示区域
                    const currentPdfDiv = document.querySelector('.current-pdf');
                    if (currentPdfDiv) {
                        currentPdfDiv.style.display = 'none';
                    }
                    
                    // 显示提示信息
                    const pdfContainer = document.querySelector('.pdf-upload-container');
                    if (pdfContainer) {
                        const notice = document.createElement('div');
                        notice.className = 'alert alert-warning mt-2';
                        notice.innerHTML = '<i class="fas fa-exclamation-triangle"></i> PDF文件将在保存时删除';
                        pdfContainer.appendChild(notice);
                    }
                }
            });
        }
    }

    // 初始化PDF文件上传验证
    function initPdfUpload() {
        const pdfInput = document.getElementById('product-pdf');
        if (pdfInput) {
            pdfInput.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    // 检查文件类型
                    if (!file.type.match('application/pdf')) {
                        alert('请选择PDF文件');
                        e.target.value = '';
                        return;
                    }
                    
                    // 检查文件大小（最大12MB）
                    if (file.size > 12 * 1024 * 1024) {
                        alert('PDF文件大小不能超过12MB，请选择更小的文件');
                        e.target.value = '';
                        return;
                    }
                    
                    console.log('PDF文件检查通过:', file.name, '大小:', Math.round(file.size / 1024) + 'KB');
                }
            });
        }
    }

    // 添加UI辅助函数
    function showLoading() {
        // 添加加载遮罩
        if ($('#loading-overlay').length === 0) {
            $('body').append(`
                <div id="loading-overlay" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                    background: rgba(0,0,0,0.5); z-index: 9999; display: flex; align-items: center; justify-content: center;">
                    <div class="spinner-border text-light" role="status">
                        <span class="visually-hidden">加载中...</span>
                    </div>
                </div>
            `);
        } else {
            $('#loading-overlay').show();
        }
    }

    function hideLoading() {
        $('#loading-overlay').hide();
    }

    function showMessage(type, message) {
        // 移除已有的消息
        $('.alert-message').remove();

        // 创建消息元素
        const alertClass = type === 'success' ? 'alert-success' : 'alert-danger';
        const alertIcon = type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle';

        const alertHtml = `
            <div class="alert ${alertClass} alert-message" style="position: fixed; top: 20px; right: 20px; z-index: 9999; max-width: 300px;">
                <i class="fas ${alertIcon} me-2"></i> ${message}
            </div>
        `;

        // 显示消息
        $('body').append(alertHtml);

        // 3秒后自动隐藏
        setTimeout(() => {
            $('.alert-message').fadeOut('slow', function() {
                $(this).remove();
            });
        }, 3000);
    }

    function resetForm() {
        // 重置表单
        $('#product-form')[0].reset();

        // 清除图片预览
        $('#image-preview').attr('src', '').hide();
        $('.image-placeholder').show();
        $('#remove-image-btn').hide();

        // 将焦点设置到第一个输入框
        $('#product-name').focus();
    }
</script>
{% endblock %}
