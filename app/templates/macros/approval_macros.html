{% from "macros/ui_helpers.html" import render_pagination with context %}
{% from "macros/ui_helpers.html" import render_button with context %}
{% from "macros/ui_helpers.html" import render_user_badge with context %}
{% from "macros/ui_helpers.html" import render_owner with context %}
{% from "macros/ui_helpers.html" import render_quotation_number with context %}
{% from "macros/ui_helpers.html" import render_authorization_code with context %}
{% from "macros/ui_helpers.html" import render_pricing_order_number with context %}
{% from "macros/ui_helpers.html" import render_ajax_pagination with context %}

{# 审批时间线样式 #}
<style>
  .timeline {
    position: relative;
    padding-left: 25px;
    border-left: 1px solid #dee2e6;
  }

  .timeline-item {
    position: relative;
    margin-bottom: 1.5rem;
    padding-bottom: 0.5rem;
  }
  
  .timeline-item:last-child {
    margin-bottom: 0;
  }

  .timeline-marker {
    position: absolute;
    left: -31px;
    width: 15px;
    height: 15px;
    border-radius: 50%;
    border: 2px solid #fff;
  }

  .timeline-content {
    padding-left: 10px;
  }

  .timeline-title {
    font-size: 1rem;
    margin-bottom: 0.5rem;
  }
  
  /* 审批状态颜色 */
  .timeline-marker.bg-success {
    background-color: #28a745 !important;
  }
  
  .timeline-marker.bg-danger {
    background-color: #dc3545 !important;
  }
  
  .timeline-marker.bg-info {
    background-color: #17a2b8 !important;
  }
  
  .timeline-marker.bg-secondary {
    background-color: #6c757d !important;
  }
</style>

{# 审批列表显示 - 用于"我发起的"和"待我审批"两个标签页 #}
{% macro approval_table(approvals, mode='created') %}
  <!-- 批量操作工具栏 -->
  <div class="d-flex justify-content-between align-items-center mb-3 p-3 bg-light rounded">
    <div class="form-check">
      <input class="form-check-input" type="checkbox" id="selectAll">
      <label class="form-check-label" for="selectAll">
        全选
      </label>
    </div>
    <div id="batchActionsContainer" style="display: none;">
      {{ render_button('批量删除', type='button', color='danger', size='sm', icon='fas fa-trash', attrs='id="batchDeleteBtn"') }}
    </div>
  </div>
  
  <!-- 审批列表表格容器 -->
  <div class="approval-table-container" id="approvalTableContainer">
    <div class="table-responsive approval-table-scroll">
      <table class="table table-striped table-hover align-middle approval-table">
      <thead>
        <tr>
          <th width="50">
            <input type="checkbox" class="form-check-input" id="selectAllHeader">
          </th>
          {% if mode == 'pricing_order' %}
            <th width="200">批价单编号</th>
            <th width="200">流程名称</th>
            <th width="180">关联项目</th>
          {% elif mode == 'order' %}
            <th width="200">订单编号</th>
            <th width="200">流程名称</th>
            <th width="180">供应商/客户</th>
          {% else %}
            <th width="200">审批编号</th>
            <th width="200">流程名称</th>
            <th width="180">关联业务</th>
          {% endif %}
          <th width="150">提交人</th>
          <th width="150">当前审批人</th>
          <th width="120">状态</th>
          <th width="180" class="d-none d-md-table-cell">发起时间</th>
        </tr>
      </thead>
      <tbody>
        {% if approvals.items %}
          {% for item in approvals.items %}
            <tr>
              <td>
                <input type="checkbox" class="form-check-input approval-checkbox" value="{{ item.id }}">
              </td>
              <td>
                {# 强制使用业务详情页面URL，添加时间戳防止缓存 #}
                {% set business_url = get_approval_object_url(item) %}
                <a href="{{ business_url }}?_t={{ range(1000000, 9999999) | random }}" class="text-decoration-none" title="跳转到业务详情页面">
                  {% if item.object_type == 'pricing_order' %}
                    {# 批价单显示批价单编号 #}
                    {% if item.object_id %}
                      {% set pricing_order = get_pricing_order_by_id(item.object_id) %}
                      {% if pricing_order %}
                        {{ render_pricing_order_number(pricing_order.order_number) }}
                      {% else %}
                        <span class="badge rounded-pill bg-secondary">无编号</span>
                      {% endif %}
                    {% else %}
                      <span class="badge rounded-pill bg-secondary">无编号</span>
                    {% endif %}
                  {% elif item.object_type == 'purchase_order' %}
                    {# 订单显示订单编号 #}
                    {% if item.order is defined and item.order %}
                      <span class="badge rounded-pill bg-primary">{{ item.order.order_number }}</span>
                    {% elif item.business_object_name %}
                      <span class="badge rounded-pill bg-primary">{{ item.business_object_name }}</span>
                    {% else %}
                      <span class="badge rounded-pill bg-secondary">无编号</span>
                    {% endif %}
                  {% else %}
                    {# 其他类型显示审批编号 #}
                    <span class="badge rounded-pill" style="background-color: #ff8c00; color: white; font-weight: 500;">APV-{{ '%04d' % (item.id|int if item.id is not string else 0) }}</span>
                  {% endif %}
                </a>
                <div class="d-md-none small text-muted">
                  {{ get_object_type_display(item.object_type) }} · {{ format_datetime(item.started_at) }}
                </div>

              </td>
              <td>
                {% if item.process %}
                  {{ item.process.name }}
                {% else %}
                  <span class="text-muted">未知流程</span>
                {% endif %}
              </td>
              <td>
                {# 关联业务徽章 - 统一使用项目编号 #}
                {% if item.object_type == 'quotation' %}
                  {# 报价单审核 - 显示关联项目编号 #}
                  {% if item.object_id %}
                    {% set quotation = get_quotation_by_id(item.object_id) %}
                    {% if quotation and quotation.project_id %}
                      {% set project = get_project_by_id(quotation.project_id) %}
                      {% if project and project.authorization_code %}
                        {{ render_authorization_code(project.authorization_code, project.project_type) }}
                      {% else %}
                        <span class="badge bg-secondary">无项目编号</span>
                      {% endif %}
                    {% else %}
                      <span class="badge bg-secondary">无关联项目</span>
                    {% endif %}
                  {% else %}
                    <span class="badge bg-secondary">无关联</span>
                  {% endif %}
                {% elif item.object_type == 'project' %}
                  {# 项目审核 - 显示项目编号 #}
                  {% if item.object_id %}
                    {% set project = get_project_by_id(item.object_id) %}
                    {% if project and project.authorization_code %}
                      {{ render_authorization_code(project.authorization_code, project.project_type) }}
                    {% else %}
                      <span class="badge bg-secondary">无编号</span>
                    {% endif %}
                  {% else %}
                    <span class="badge bg-secondary">无关联</span>
                  {% endif %}
                {% elif item.object_type == 'customer' %}
                  {# 客户审核 - 显示客户编号或名称 #}
                  {% if item.object_id %}
                    {% set customer = get_customer_by_id(item.object_id) %}
                    {% if customer %}
                      <span class="badge bg-info rounded-pill">{{ customer.company_name[:10] }}...</span>
                    {% else %}
                      <span class="badge bg-secondary">无客户</span>
                    {% endif %}
                  {% else %}
                    <span class="badge bg-secondary">无关联</span>
                  {% endif %}
                {% elif item.object_type == 'pricing_order' %}
                  {# 批价单审核 - 显示关联项目编号 #}
                  {% if item.object_id %}
                    {% set pricing_order = get_pricing_order_by_id(item.object_id) %}
                    {% if pricing_order and pricing_order.project_id %}
                      {% set project = get_project_by_id(pricing_order.project_id) %}
                      {% if project and project.authorization_code %}
                        {{ render_authorization_code(project.authorization_code, project.project_type) }}
                      {% else %}
                        <span class="badge bg-secondary">无项目编号</span>
                      {% endif %}
                    {% else %}
                      <span class="badge bg-secondary">无关联项目</span>
                    {% endif %}
                  {% else %}
                    <span class="badge bg-secondary">无关联</span>
                  {% endif %}
                {% elif item.object_type == 'purchase_order' %}
                  {# 订单审核 - 显示供应商/客户公司 #}
                  {% if item.order is defined and item.order and item.order.company %}
                    <span class="badge bg-info rounded-pill">{{ item.order.company.company_name[:15] }}{% if item.order.company.company_name|length > 15 %}...{% endif %}</span>
                  {% elif item.business_object and item.business_object.company %}
                    <span class="badge bg-info rounded-pill">{{ item.business_object.company.company_name[:15] }}{% if item.business_object.company.company_name|length > 15 %}...{% endif %}</span>
                  {% else %}
                    <span class="badge bg-secondary">无关联公司</span>
                  {% endif %}
                {% else %}
                  <span class="badge bg-secondary">{{ get_object_type_display(item.object_type) }}</span>
                {% endif %}
              </td>
              <td>{{ render_owner(item.creator) }}</td>
              {% set current_step = get_current_step_info(item) %}
              {% set last_approver = get_last_approver(item) if item.status.name in ['APPROVED', 'REJECTED'] else None %}
              <td>{{ render_owner(last_approver or (current_step.approver if current_step else None)) }}</td>
              <td>
                {% if item.status.name == 'PENDING' %}
                  <span class="badge rounded-pill bg-warning text-dark">审批中</span>
                {% elif item.status.name == 'APPROVED' %}
                  <span class="badge rounded-pill bg-success text-white">已通过</span>
                {% elif item.status.name == 'REJECTED' %}
                  <span class="badge rounded-pill bg-danger text-white">已拒绝</span>
                {% elif item.status.name == 'DRAFT' %}
                  <span class="badge rounded-pill bg-secondary text-white">草稿</span>
                {% elif item.status.name == 'CANCELLED' %}
                  <span class="badge rounded-pill bg-secondary text-white">已取消</span>
                {% else %}
                  <span class="badge rounded-pill bg-secondary text-white">{{ item.status.name or '未知状态' }}</span>
                {% endif %}
              </td>
              <td class="d-none d-md-table-cell">{{ format_datetime_local(item.started_at) }}</td>
            </tr>
          {% endfor %}
        {% else %}
          <tr>
            <td colspan="8" class="text-center py-4">
              <div class="text-muted">
                <i class="fas fa-info-circle me-2"></i>
                {% if mode == 'pending' %}
                  暂无待审批的流程
                {% elif mode == 'all' %}
                  暂无审批记录
                {% else %}
                  暂无已创建的流程
                {% endif %}
              </div>
            </td>
          </tr>
        {% endif %}
      </tbody>
    </table>
    </div>
  </div>
  
  {# Ajax分页器 #}
  {% if approvals.pages > 1 %}
    <div class="d-flex justify-content-center py-3" id="paginationContainer">
      {{ render_ajax_pagination(approvals) }}
    </div>
  {% endif %}
  
  <!-- 批量删除确认模态框 -->
  <div class="modal fade" id="batchDeleteModal" tabindex="-1" aria-labelledby="batchDeleteModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="batchDeleteModalLabel">确认批量删除</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <p>您确定要删除选中的 <span id="selectedCount">0</span> 个审批流程吗？</p>
          <p class="text-danger"><i class="fas fa-exclamation-triangle me-1"></i> 此操作不可撤销！</p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
          <button type="button" class="btn btn-danger" id="confirmBatchDelete">确认删除</button>
        </div>
      </div>
    </div>
  </div>
  
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const selectAll = document.getElementById('selectAll');
      const selectAllHeader = document.getElementById('selectAllHeader');
      const checkboxes = document.querySelectorAll('.approval-checkbox');
      const batchActionsContainer = document.getElementById('batchActionsContainer');
      const batchDeleteBtn = document.getElementById('batchDeleteBtn');
      const batchDeleteModal = new bootstrap.Modal(document.getElementById('batchDeleteModal'));
      
      // 全选功能
      function updateSelectAll() {
        const checkedCount = document.querySelectorAll('.approval-checkbox:checked').length;
        const totalCount = checkboxes.length;
        
        selectAll.checked = checkedCount === totalCount && totalCount > 0;
        selectAllHeader.checked = selectAll.checked;
        selectAll.indeterminate = checkedCount > 0 && checkedCount < totalCount;
        selectAllHeader.indeterminate = selectAll.indeterminate;
        
        // 显示/隐藏批量操作按钮
        if (checkedCount > 0) {
          batchActionsContainer.style.display = 'block';
        } else {
          batchActionsContainer.style.display = 'none';
        }
      }
      
      // 全选事件
      [selectAll, selectAllHeader].forEach(checkbox => {
        checkbox.addEventListener('change', function() {
          checkboxes.forEach(cb => cb.checked = this.checked);
          updateSelectAll();
        });
      });
      
      // 单个复选框事件
      checkboxes.forEach(checkbox => {
        checkbox.addEventListener('change', updateSelectAll);
      });
      
      // 批量删除按钮事件
      batchDeleteBtn.addEventListener('click', function() {
        const selectedIds = Array.from(document.querySelectorAll('.approval-checkbox:checked')).map(cb => cb.value);
        document.getElementById('selectedCount').textContent = selectedIds.length;
        batchDeleteModal.show();
      });
      
      // 确认批量删除
      document.getElementById('confirmBatchDelete').addEventListener('click', function() {
        const selectedIds = Array.from(document.querySelectorAll('.approval-checkbox:checked')).map(cb => cb.value);
        
        if (selectedIds.length > 0) {
          // 创建表单并提交
          const form = document.createElement('form');
          form.method = 'POST';
          form.action = '{{ url_for("approval.batch_delete") }}';
          
          // 添加CSRF token
          const csrfToken = document.createElement('input');
          csrfToken.type = 'hidden';
          csrfToken.name = 'csrf_token';
          csrfToken.value = '{{ csrf_token() }}';
          form.appendChild(csrfToken);
          
          // 添加选中的ID
          selectedIds.forEach(id => {
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = 'approval_ids';
            input.value = id;
            form.appendChild(input);
          });
          
          document.body.appendChild(form);
          form.submit();
        }
        
        batchDeleteModal.hide();
      });
      
      // 初始化状态
      updateSelectAll();
    });
  </script>
{% endmacro %}

{# 渲染审批编号徽章 #}
{% macro render_approval_code(id) %}
  <span class="badge rounded-pill" style="background-color: #0c7cd0; color: white; font-family: 'Helvetica Neue', sans-serif; font-size: 0.85rem; font-weight: normal; padding: 0.3em 0.75em;">
    {% if id is string and id.startswith('po_') %}
      批价单-{{ id.split('_')[1] }}
    {% else %}
      APV-{{ '%04d' % (id|int if id is not string else 0) }}
    {% endif %}
  </span>
{% endmacro %}

{# 筛选器表单 #}
{% macro approval_filter_form(current_tab='created', object_type=None, status=None) %}
  <form class="filter-form mb-4" method="get">
    <input type="hidden" name="tab" value="{{ current_tab }}">
    
    <div class="row g-2">
      <div class="col-md-4 col-sm-6">
        <div class="form-group">
          <label for="object_type" class="form-label">业务类型</label>
          <select class="form-select" id="object_type" name="object_type">
            <option value="">全部类型</option>
            <option value="project" {% if object_type == 'project' %}selected{% endif %}>项目</option>
            <option value="quotation" {% if object_type == 'quotation' %}selected{% endif %}>报价单</option>
            <option value="customer" {% if object_type == 'customer' %}selected{% endif %}>客户</option>
            <option value="pricing_order" {% if object_type == 'pricing_order' %}selected{% endif %}>批价单</option>
            <option value="purchase_order" {% if object_type == 'purchase_order' %}selected{% endif %}>订单</option>
          </select>
        </div>
      </div>
      
      {% if current_tab == 'created' %}
        <div class="col-md-4 col-sm-6">
          <div class="form-group">
            <label for="status" class="form-label">审批状态</label>
            <select class="form-select" id="status" name="status">
              <option value="">全部</option>
              <option value="draft" {{ 'selected' if status == 'draft' else '' }}>草稿</option>
              <option value="pending" {{ 'selected' if status == 'pending' else '' }}>审批中</option>
              <option value="approved" {{ 'selected' if status == 'approved' else '' }}>已通过</option>
              <option value="rejected" {{ 'selected' if status == 'rejected' else '' }}>已拒绝</option>
            </select>
          </div>
        </div>
      {% elif current_tab == 'order' %}
        <div class="col-md-4 col-sm-6">
          <div class="form-group">
            <label for="status" class="form-label">订单状态</label>
            <select class="form-select" id="status" name="status">
              <option value="">全部</option>
              <option value="draft" {{ 'selected' if status == 'draft' else '' }}>草稿</option>
              <option value="pending" {{ 'selected' if status == 'pending' else '' }}>审批中</option>
              <option value="approved" {{ 'selected' if status == 'approved' else '' }}>已通过</option>
              <option value="rejected" {{ 'selected' if status == 'rejected' else '' }}>已拒绝</option>
              <option value="confirmed" {{ 'selected' if status == 'confirmed' else '' }}>已确认</option>
              <option value="shipped" {{ 'selected' if status == 'shipped' else '' }}>已发货</option>
              <option value="completed" {{ 'selected' if status == 'completed' else '' }}>已完成</option>
              <option value="cancelled" {{ 'selected' if status == 'cancelled' else '' }}>已取消</option>
            </select>
          </div>
        </div>
      {% endif %}
      
      <div class="col-md-{{ '4' if current_tab == 'created' else '8' }} col-sm-12 d-flex align-items-end">
        <div class="d-flex flex-wrap gap-2 w-100 justify-content-start">
          {{ render_filter_button("筛选", "submit", "btn-primary", "fa-filter") |safe }}
          
          <a href="{{ url_for('approval.center', tab=current_tab) }}" class="btn btn-outline-secondary btn-sm">
            <i class="fas fa-sync-alt me-1"></i> 重置
          </a>
        </div>
      </div>
    </div>
  </form>
{% endmacro %}

{# 审批时间线显示 - 用于详情页面展示审批流程历史 #}
{% macro render_approval_timeline(instance) %}
  <div class="card mb-4">
    <div class="card-header">
      <h5 class="mb-0">
        <i class="fas fa-history me-2"></i> 审批流程
        {% if instance.status.name == 'PENDING' %}
          <span class="badge rounded-pill bg-warning text-dark">审批中</span>
        {% elif instance.status.name == 'APPROVED' %}
          <span class="badge rounded-pill bg-success text-white">已通过</span>
        {% elif instance.status.name == 'REJECTED' %}
          <span class="badge rounded-pill bg-danger text-white">已拒绝</span>
        {% elif instance.status.name == 'CANCELLED' %}
          <span class="badge rounded-pill bg-secondary text-white">已取消</span>
        {% else %}
          <span class="badge rounded-pill bg-secondary text-white">未知状态</span>
        {% endif %}
      </h5>
    </div>
    <div class="card-body">
      <div class="timeline">
        {# 显示流程发起记录 #}
        <div class="timeline-item">
          <div class="timeline-marker bg-info"></div>
          <div class="timeline-content">
            <h4 class="timeline-title">流程发起</h4>
            <p>
              <strong>{{ get_user_display_name(instance.creator) }}</strong> 于 
              {{ format_datetime(instance.started_at) }} 发起审批
            </p>
          </div>
        </div>
        
        {# 显示各步骤审批记录 #}
        {% for record in instance.records %}
          <div class="timeline-item">
            <div class="timeline-marker {% if record.action == 'approve' %}bg-success{% else %}bg-danger{% endif %}"></div>
            <div class="timeline-content">
              <h4 class="timeline-title">{{ record.step.step_name }}</h4>
              <p>
                <strong>{{ get_user_display_name(record.approver) }}</strong> 
                {% if record.action == 'approve' %}
                  <span class="text-success">同意</span>
                {% else %}
                  <span class="text-danger">拒绝</span>
                {% endif %}
                于 {{ format_datetime(record.timestamp) }}
              </p>
              {% if record.comment %}
                <div class="mt-2 p-2 bg-light rounded">
                  <i class="fas fa-comment text-muted me-2"></i>{{ record.comment }}
                </div>
              {% endif %}
            </div>
          </div>
        {% endfor %}
        
        {# 显示当前步骤（如果流程尚未完成） #}
        {% if instance.status == ApprovalStatus.PENDING %}
          {% set current_step = get_current_step_info(instance) %}
          <div class="timeline-item">
            <div class="timeline-marker bg-warning"></div>
            <div class="timeline-content">
              <h4 class="timeline-title">{{ current_step.step_name }} <span class="badge bg-warning">当前步骤</span></h4>
              <p>待 <strong>{{ get_user_display_name(current_step.approver) }}</strong> 审批</p>
            </div>
          </div>
        {% endif %}
      </div>
    </div>
  </div>
{% endmacro %}

{# 审批表单 - 用于当前审批人进行审批操作 #}
{% macro render_approval_form(instance) %}
  {% if instance.status == ApprovalStatus.PENDING and can_user_approve(instance.id, current_user.id) %}
    <div class="card mb-4">
      <div class="card-header">
        <h5 class="mb-0"><i class="fas fa-tasks me-2"></i> 审批操作</h5>
      </div>
      <div class="card-body">
        <form action="{{ url_for('approval.approve', instance_id=instance.id) }}" method="POST">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
          <div class="form-group mb-3">
            <label for="comment" class="form-label">审批意见</label>
            <textarea class="form-control" id="comment" name="comment" rows="3" placeholder="请输入您的审批意见..."></textarea>
          </div>
          <div class="d-flex justify-content-between gap-2 flex-wrap">
            <button type="submit" name="action" value="approve" class="btn btn-success">
              <i class="fas fa-check-circle me-1"></i> 同意
            </button>
            <button type="submit" name="action" value="reject" class="btn btn-danger">
              <i class="fas fa-times-circle me-1"></i> 拒绝
            </button>
          </div>
        </form>
      </div>
    </div>
  {% endif %}
{% endmacro %}

{# 发起审批按钮 - 用于业务详情页面 #}
{% macro render_start_approval_button(object_type, object_id, user=None) %}
  {# 获取业务对象并检查权限 #}
  {% if object_type == 'project' %}
    {% set business_obj = get_project_by_id(object_id) %}
  {% elif object_type == 'quotation' %}
    {% set business_obj = get_quotation_by_id(object_id) %}
  {% elif object_type == 'customer' %}
    {% set business_obj = get_company_by_id(object_id) %}
  {% else %}
    {% set business_obj = none %}
  {% endif %}
  
  {# 使用传入的用户或current_user #}
  {% set active_user = user or current_user %}
  
  {# 检查用户是否有发起审批的权限 - 使用更直接的方式 #}
  {% set has_approval_permission = false %}
  {% if business_obj and active_user %}
    {% if active_user.is_authenticated %}
      {% set has_approval_permission = can_start_approval(business_obj, active_user) %}
    {% endif %}
  {% endif %}
  
  {% if has_approval_permission %}
    <div class="card mb-4">
      <div class="card-header">
        <h5 class="mb-0"><i class="fas fa-paper-plane me-2"></i> 审批操作</h5>
      </div>
      <div class="card-body">
        {% set history_instance = get_rejected_approval_history(object_type, object_id) %}
        {% if history_instance %}
          <div class="alert alert-warning p-0 mb-4">
            <div class="alert-heading bg-warning text-dark p-3 m-0 d-flex align-items-center justify-content-between">
              <div class="d-flex align-items-center">
                <i class="fas fa-exclamation-triangle me-2"></i>
                <span class="mb-0">审批被拒绝提醒</span>
              </div>
              <button class="btn btn-sm btn-outline-dark collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#rejectedApprovalDetails" aria-expanded="false" aria-controls="rejectedApprovalDetails" id="rejectedDetailsToggle">
                <i class="fas fa-chevron-down toggle-icon"></i> <span class="toggle-text">查看详情</span>
              </button>
            </div>
            
            <div class="p-3">
              <div class="d-flex flex-column gap-2">
                <!-- 流程信息 -->
                <div class="d-flex">
                  <div class="text-secondary" style="width: 100px;">拒绝流程：</div>
                  <div class="fw-bold">{{ history_instance.process.name }}</div>
                </div>
                
                <!-- 拒绝时间 -->
                <div class="d-flex">
                  <div class="text-secondary" style="width: 100px;">拒绝时间：</div>
                  <div>{{ format_datetime(history_instance.ended_at) }}</div>
                </div>
                
                <!-- 拒绝人 -->
                {% set last_record = history_instance.records|selectattr('action', 'eq', 'reject')|first %}
                {% if last_record %}
                <div class="d-flex">
                  <div class="text-secondary" style="width: 100px;">拒绝审批人：</div>
                  <div>{{ get_user_display_name(last_record.approver) }}</div>
                </div>
                {% endif %}
                
                <!-- 拒绝原因（如果有） -->
                {% if last_record and last_record.comment %}
                <div class="d-flex mt-2">
                  <div class="text-secondary" style="width: 100px;">拒绝原因：</div>
                  <div class="p-2 bg-light rounded flex-grow-1 border-start border-4 border-danger">{{ last_record.comment }}</div>
                </div>
                {% endif %}
              </div>
              
              <!-- 可折叠的审批流程详情 -->
              <div class="collapse mt-3" id="rejectedApprovalDetails">
                <div class="card card-body bg-light">
                  <h6 class="card-title"><i class="fas fa-history me-2"></i>审批流程详情</h6>
                  
                  <!-- 审批流程时间线 -->
                  <div class="timeline mt-3">
                    <!-- 流程发起记录 -->
                    <div class="timeline-item">
                      <div class="timeline-marker bg-info"></div>
                      <div class="timeline-content">
                        <h6 class="timeline-title">流程发起</h6>
                        <p class="small">
                          <strong>{{ get_user_display_name(history_instance.creator) }}</strong> 于 
                          {{ format_datetime(history_instance.started_at) }} 发起审批
                        </p>
                      </div>
                    </div>
                    
                    <!-- 获取模板的所有步骤 -->
                    {% set all_steps = get_template_steps(history_instance.process_id) %}
                    {% if all_steps %}
                      <!-- 获取所有实际审批记录 -->
                      {% set approved_records = history_instance.records|selectattr('action', 'eq', 'approve')|list %}
                      {% set rejected_records = history_instance.records|selectattr('action', 'eq', 'reject')|list %}
                      {% set all_records = approved_records + rejected_records %}
                      
                      <!-- 步骤遍历 -->
                      {% for step in all_steps %}
                        {% set step_record = none %}
                        {% for record in all_records %}
                          {% if record.step_id == step.id %}
                            {% set step_record = record %}
                          {% endif %}
                        {% endfor %}
                        
                        <div class="timeline-item">
                          <!-- 标记颜色：已通过为绿色，被拒绝为红色，未到达为灰色 -->
                          {% if step_record %}
                            {% if step_record.action == 'approve' %}
                              <div class="timeline-marker bg-success"></div>
                            {% else %}
                              <div class="timeline-marker bg-danger position-relative">
                                <i class="fas fa-times position-absolute" style="font-size: 0.6rem; top: 50%; left: 50%; transform: translate(-50%, -50%); color: white;"></i>
                              </div>
                            {% endif %}
                          {% else %}
                            <div class="timeline-marker bg-secondary"></div>
                          {% endif %}
                          
                          <div class="timeline-content">
                            <h6 class="timeline-title">
                              步骤 {{ step.step_order }}: {{ step.step_name }}
                              
                              <!-- 状态徽章 -->
                              {% if step_record %}
                                {% if step_record.action == 'approve' %}
                                  <span class="badge bg-success">已通过</span>
                                {% else %}
                                  <span class="badge bg-danger">已拒绝</span>
                                {% endif %}
                              {% else %}
                                <span class="badge bg-secondary">未到达</span>
                              {% endif %}
                            </h6>
                            
                            {% if step_record %}
                              <p class="small mb-1">
                                审批人: <strong>{{ get_user_display_name(step_record.approver) }}</strong>
                                审批时间: {{ format_datetime(step_record.timestamp) }}
                              </p>
                              
                              <!-- 拒绝原因展示 -->
                              {% if step_record.action == 'reject' and step_record.comment %}
                                <div class="mt-2 p-2 bg-white rounded border-start border-4 border-danger">
                                  <i class="fas fa-comment text-danger me-2"></i>{{ step_record.comment }}
                                </div>
                              {% endif %}
                            {% else %}
                              <p class="small text-muted">
                                审批人: {{ get_user_display_name(step.approver) }}
                              </p>
                            {% endif %}
                          </div>
                        </div>
                      {% endfor %}
                    {% endif %}
                  </div>
                </div>
              </div>
              
              <div class="mt-3 text-end">
                <span class="badge bg-success">您可以重新发起审批流程</span>
              </div>
            </div>
          </div>
          
          <!-- 添加展开/收起按钮的JavaScript -->
          <script>
            document.addEventListener('DOMContentLoaded', function() {
              const detailsToggle = document.getElementById('rejectedDetailsToggle');
              const toggleIcon = detailsToggle.querySelector('.toggle-icon');
              const toggleText = detailsToggle.querySelector('.toggle-text');
              
              // 监听折叠面板的展开/收起事件
              document.getElementById('rejectedApprovalDetails').addEventListener('show.bs.collapse', function () {
                toggleIcon.classList.remove('fa-chevron-down');
                toggleIcon.classList.add('fa-chevron-up');
                toggleText.textContent = '收起详情';
              });
              
              document.getElementById('rejectedApprovalDetails').addEventListener('hide.bs.collapse', function () {
                toggleIcon.classList.remove('fa-chevron-up');
                toggleIcon.classList.add('fa-chevron-down');
                toggleText.textContent = '查看详情';
              });
            });
          </script>
        {% endif %}
        
        <p>请选择合适的流程模板进行审批。</p>
        <form action="{{ url_for('approval.start_approval') }}" method="POST">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
          <input type="hidden" name="object_type" value="{{ object_type }}">
          <input type="hidden" name="object_id" value="{{ object_id }}">
          
          <div class="form-group mb-3">
            <label for="template_id" class="form-label">选择审批流程模板</label>
            <select class="form-select" id="template_id" name="template_id" required>
              <option value="">-- 请选择模板 --</option>
              {# 直接获取可用模板列表，不再使用条件判断 #}
              {% set templates = get_available_templates(object_type, object_id) %}
              {% for template in templates %}
                <option value="{{ template.id }}">{{ template.name }}</option>
              {% endfor %}
              {% if templates|length == 0 %}
                <option value="" disabled>无可用的审批模板，请联系管理员</option>
              {% endif %}
            </select>
          </div>
          
          <!-- 必填字段检查结果显示区域 -->
          <div id="required-fields-check" class="mb-3" style="display: none;">
            <!-- 动态内容将在这里显示 -->
          </div>
          
          <!-- 模板步骤预览区域 -->
          <div id="template-steps-preview" class="mb-3" style="display: none;">
            <!-- 动态内容将在这里显示 -->
          </div>
          
          <div class="d-flex gap-2">
            {{ render_button('发起审批', type='submit', color='primary', icon='fas fa-play-circle') }}
          </div>
        </form>
      </div>
    </div>
  {% else %}
    {# 用户没有权限时显示提示信息 #}
    <div class="card mb-4">
      <div class="card-header">
        <h5 class="mb-0"><i class="fas fa-lock me-2"></i> 审批操作</h5>
      </div>
      <div class="card-body">
        <div class="alert alert-info">
          <i class="fas fa-info-circle me-2"></i>
          您没有权限发起此审批流程。只有数据拥有者和项目的厂商销售负责人可以发起审批。
        </div>
      </div>
    </div>
  {% endif %}
{% endmacro %}

{# 业务对象审批状态展示 - 用于列表页显示审批状态 #}
{% macro render_object_approval_status(object_type, object_id) %}
  {% set instance = get_object_approval_instance(object_type, object_id) %}
  {% if instance %}
    {% if instance.status.name == 'PENDING' %}
      <span class="badge rounded-pill bg-warning text-dark">审批中</span>
    {% elif instance.status.name == 'APPROVED' %}
      <span class="badge rounded-pill bg-success text-white">已通过</span>
    {% elif instance.status.name == 'REJECTED' %}
      <span class="badge rounded-pill bg-danger text-white">已拒绝</span>
    {% elif instance.status.name == 'CANCELLED' %}
      <span class="badge rounded-pill bg-secondary text-white">已取消</span>
    {% else %}
      <span class="badge rounded-pill bg-secondary text-white">未知状态</span>
    {% endif %}
  {% else %}
    <span class="badge bg-secondary">未审批</span>
  {% endif %} 
{% endmacro %}

{# 渲染模块详情页面中的审批区域 - 统一版本 #}
{% macro render_approval_section(object_type, object_id, approval_instance=None, current_user=None) %}
<div class="row mt-4">
    <div class="col-12">
        {% if approval_instance %}
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="fas fa-clipboard-check me-2"></i>审批流程</h5>
                        <div class="d-flex gap-2">
                            <!-- 召回按钮 - 只有发起人且状态为pending时显示 -->
                            {% if approval_instance.status == ApprovalStatus.PENDING and current_user and current_user.id == approval_instance.created_by %}
                                <button type="button" class="btn btn-warning btn-sm" 
                                        data-bs-toggle="modal" 
                                        data-bs-target="#recallApprovalModal">
                                    <i class="fas fa-undo me-1"></i> 召回
                                </button>
                            {% endif %}
                            <!-- 查看详情按钮 -->
                            {% if approval_instance.id is number %}
                                <a href="{{ url_for('approval.detail', instance_id=approval_instance.id) }}" 
                                   class="btn btn-info btn-sm">
                                    <i class="fas fa-eye me-1"></i> 详情
                                </a>
                            {% else %}
                                <!-- 订单包装对象不支持审批详情页面 -->
                                <span class="btn btn-secondary btn-sm disabled">
                                    <i class="fas fa-eye me-1"></i> 详情不可用
                                </span>
                            {% endif %}
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <!-- 审批基本信息 -->
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <div class="card border-info">
                                <div class="card-header bg-info text-white">
                                    <h6 class="mb-0"><i class="fas fa-info-circle me-2"></i>基本信息</h6>
                                </div>
                                <div class="card-body">
                                    <table class="table table-sm mb-0">
                                        <tr>
                                            <th class="standard-font" style="width: 35%">审批编号</th>
                                            <td class="standard-font">{{ render_approval_code(approval_instance.id)|safe }}</td>
                                        </tr>
                                        <tr>
                                            <th class="standard-font">流程名称</th>
                                            <td class="standard-font">{{ approval_instance.process.name if approval_instance.process else '未知流程' }}</td>
                                        </tr>
                                        <tr>
                                            <th class="standard-font">发起人</th>
                                            <td class="standard-font">{{ approval_instance.creator.real_name or approval_instance.creator.username }}</td>
                                        </tr>
                                        <tr>
                                            <th class="standard-font">发起时间</th>
                                            <td class="standard-font">{{ format_datetime(approval_instance.started_at) }}</td>
                                        </tr>
                                        <tr>
                                            <th class="standard-font">当前状态</th>
                                            <td class="standard-font">
                                              {% if approval_instance.status.name == 'PENDING' %}
                                                <span class="badge rounded-pill bg-warning text-dark">审批中</span>
                                              {% elif approval_instance.status.name == 'APPROVED' %}
                                                <span class="badge rounded-pill bg-success text-white">已通过</span>
                                              {% elif approval_instance.status.name == 'REJECTED' %}
                                                <span class="badge rounded-pill bg-danger text-white">已拒绝</span>
                                              {% elif approval_instance.status.name == 'CANCELLED' %}
                                                <span class="badge rounded-pill bg-secondary text-white">已取消</span>
                                              {% else %}
                                                <span class="badge rounded-pill bg-secondary text-white">未知状态</span>
                                              {% endif %}
                                            </td>
                                        </tr>
                                        {% if approval_instance.ended_at %}
                                        <tr>
                                            <th class="standard-font">完成时间</th>
                                            <td class="standard-font">{{ format_datetime(approval_instance.ended_at) }}</td>
                                        </tr>
                                        {% endif %}
                                    </table>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <!-- 当前步骤信息或流程状态 -->
                            {% if approval_instance.status == ApprovalStatus.PENDING %}
                                {% set current_step = get_current_step_info(approval_instance) if get_current_step_info is defined %}
                                {% if current_step %}
                                <div class="card border-warning">
                                    <div class="card-header bg-warning text-dark">
                                        <h6 class="mb-0"><i class="fas fa-hourglass-half me-2"></i>当前步骤</h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between align-items-center mb-3">
                                            <div>
                                                <strong class="standard-font">{{ current_step.step_name }}</strong>
                                                <div class="text-muted standard-font">审批人: {{ current_step.approver.real_name or current_step.approver.username }}</div>
                                            </div>
                                            <div>
                                                <span class="badge bg-warning">待审批</span>
                                            </div>
                                        </div>
                                        
                                        <!-- 审批操作按钮 -->
                                        {% if current_user and can_user_approve and can_user_approve(approval_instance.id, current_user.id) %}
                                        {% set current_step = get_current_step_info(approval_instance) if get_current_step_info is defined %}
                                        {% set is_authorization_step = current_step and current_step.action_type == 'authorization' %}
                                        
                                        <div class="border-top pt-3">
                                            <h6 class="text-muted mb-2">审批操作</h6>
                                            
                                            {% if is_authorization_step and approval_instance.object_type == 'project' %}
                                              <!-- 授权步骤 - 显示进行授权按钮 -->
                                              <div class="d-flex gap-2">
                                                  <a href="{{ url_for('approval.authorize', instance_id=approval_instance.id) }}" class="btn btn-primary btn-sm">
                                                      <i class="fas fa-key me-1"></i> 进行授权
                                                  </a>
                                                  <button type="button" class="btn btn-danger btn-sm" onclick="openApprovalActionModal('reject')">
                                                      <i class="fas fa-times me-1"></i> 拒绝
                                                  </button>
                                              </div>
                                            {% else %}
                                              <!-- 普通审批步骤 - 显示通过/拒绝按钮 -->
                                              <div class="d-flex gap-2">
                                                  <button type="button" class="btn btn-success btn-sm" onclick="openApprovalActionModal('approve')">
                                                      <i class="fas fa-check me-1"></i> 通过
                                                  </button>
                                                  <button type="button" class="btn btn-danger btn-sm" onclick="openApprovalActionModal('reject')">
                                                      <i class="fas fa-times me-1"></i> 拒绝
                                                  </button>
                                              </div>
                                            {% endif %}
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                                {% endif %}
                            {% else %}
                                <div class="card border-secondary">
                                    <div class="card-header bg-secondary text-white">
                                        <h6 class="mb-0"><i class="fas fa-flag-checkered me-2"></i>流程状态</h6>
                                    </div>
                                    <div class="card-body text-center">
                                        {% if approval_instance.status == ApprovalStatus.APPROVED %}
                                            <i class="fas fa-check-circle text-success fa-3x mb-3"></i>
                                            <h5 class="text-success">审批已通过</h5>
                                        {% elif approval_instance.status == ApprovalStatus.REJECTED %}
                                            <i class="fas fa-times-circle text-danger fa-3x mb-3"></i>
                                            <h5 class="text-danger">审批已拒绝</h5>
                                        {% endif %}
                                        {% if approval_instance.ended_at %}
                                            <p class="text-muted standard-font">完成时间: {{ format_datetime(approval_instance.ended_at) }}</p>
                                        {% endif %}
                                    </div>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <!-- 报价单确认徽章操作区域 - 仅在报价单页面显示 -->
                    {% if object_type == 'quotation' and (current_user.role == 'admin' or current_user.role == 'solution_manager') %}
                    {% set quotation = get_quotation_by_id(object_id) if get_quotation_by_id is defined %}
                    {% if quotation %}
                    <div class="row mb-4">
                        <div class="col-12">
                            <div class="card border-info">
                                <div class="card-header bg-info text-white">
                                    <h6 class="mb-0"><i class="fas fa-certificate me-2"></i>确认徽章</h6>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="d-flex align-items-center gap-2 mb-2">
                                                <span class="text-muted">当前状态：</span>
                                                <span id="current-badge-display">
                                                    {% if quotation.confirmation_badge_html %}
                                                        {{ quotation.confirmation_badge_html|safe }}
                                                    {% else %}
                                                        <span class="text-muted">无</span>
                                                    {% endif %}
                                                </span>
                                            </div>
                                            
                                            {% if quotation.confirmation_badge_status != 'none' %}
                                            <div class="mb-2">
                                                <small class="text-muted">
                                                    {% if quotation.confirmation_badge_status == 'confirmed' and quotation.confirmer %}
                                                        已确认 - {{ quotation.confirmer.real_name or quotation.confirmer.username }}
                                                        {% if quotation.confirmed_at %}
                                                            ({{ quotation.confirmed_at.strftime('%Y-%m-%d %H:%M') }})
                                                        {% endif %}
                                                    {% elif quotation.confirmation_badge_status == 'pending' %}
                                                        待确认状态
                                                    {% endif %}
                                                </small>
                                            </div>
                                            {% endif %}
                                        </div>
                                        
                                        <div class="col-md-6">
                                            <div class="btn-group" role="group">
                                                <button type="button" class="btn btn-sm btn-outline-primary" onclick="showConfirmationBadgeModal()">
                                                    <i class="fas fa-check"></i> 设置确认
                                                </button>
                                                {% if quotation.confirmation_badge_status != 'none' %}
                                                <button type="button" class="btn btn-sm btn-outline-danger" onclick="clearConfirmationBadge()">
                                                    <i class="fas fa-times"></i> 清除
                                                </button>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                    {% endif %}
                    
                    <!-- 审批流程图 -->
                    <div class="card">
                        <div class="card-header bg-dark text-white">
                            <h6 class="mb-0"><i class="fas fa-sitemap me-2"></i>审批流程图</h6>
                        </div>
                        <div class="card-body">
                            <div class="approval-workflow">
                                <div class="timeline">
                                    {% set workflow_steps = get_workflow_steps(approval_instance) %}
                                    {% for step in workflow_steps %}
                                        <div class="timeline-item">
                                            <div class="timeline-marker 
                                                {% if step.is_completed and step.action and step.action == 'approve' %}
                                                    bg-success
                                                {% elif step.is_completed and step.action and step.action == 'reject' %}
                                                    bg-danger
                                                {% elif step.is_current %}
                                                    bg-warning
                                                {% else %}
                                                    bg-secondary
                                                {% endif %}
                                            "></div>
                                            <div class="timeline-content">
                                                <div class="d-flex justify-content-between">
                                                    <h6 class="timeline-title">步骤 {{ step.order }}: {{ step.name }}</h6>
                                                    {% if step.is_current %}
                                                        <span class="badge bg-warning">当前步骤</span>
                                                    {% elif step.is_completed and step.action %}
                                                        {% if step.action == 'approve' %}
                                                            <span class="badge bg-success">已通过</span>
                                                        {% else %}
                                                            <span class="badge bg-danger">已拒绝</span>
                                                        {% endif %}
                                                    {% endif %}
                                                </div>
                                                
                                                <p class="standard-font mb-1">审批人: {{ step.approver }}</p>
                                                
                                                {% if step.is_completed and step.timestamp %}
                                                    <p class="text-muted standard-font mb-1">审批时间: {{ format_datetime(step.timestamp) }}</p>
                                                    
                                                    {% if step.comment %}
                                                        <div class="mt-2 p-2 bg-light rounded">
                                                            <i class="fas fa-comment text-muted me-2"></i><span class="standard-font">{{ step.comment }}</span>
                                                        </div>
                                                    {% endif %}
                                                {% endif %}
                                            </div>
                                        </div>
                                    {% endfor %}
                                    
                                    <!-- 最终结果 -->
                                    <div class="timeline-item">
                                        <div class="timeline-marker 
                                            {% if approval_instance.status == ApprovalStatus.APPROVED %}
                                                bg-success
                                            {% elif approval_instance.status == ApprovalStatus.REJECTED %}
                                                bg-danger
                                            {% else %}
                                                bg-secondary
                                            {% endif %}
                                        "></div>
                                        <div class="timeline-content">
                                            <h6 class="timeline-title">流程结束</h6>
                                            <p class="standard-font">
                                                {% if approval_instance.status == ApprovalStatus.APPROVED %}
                                                    <span class="text-success"><i class="fas fa-check-circle me-1"></i>审批已通过</span>
                                                {% elif approval_instance.status == ApprovalStatus.REJECTED %}
                                                    <span class="text-danger"><i class="fas fa-times-circle me-1"></i>审批已拒绝</span>
                                                {% else %}
                                                    <span class="text-muted"><i class="fas fa-hourglass-half me-1"></i>审批进行中</span>
                                                {% endif %}
                                            </p>
                                            {% if approval_instance.ended_at %}
                                                <p class="text-muted standard-font">完成时间: {{ format_datetime(approval_instance.ended_at) }}</p>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 确认徽章设置模态框 - 仅在报价单页面显示 -->
            {% if object_type == 'quotation' and (current_user.role == 'admin' or current_user.role == 'solution_manager') %}
            <div class="modal fade" id="confirmationBadgeModal" tabindex="-1">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">设置确认徽章</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <div class="mb-3">
                                <label class="form-label">选择徽章颜色</label>
                                <div class="row g-2">
                                    <div class="col-auto">
                                        <button type="button" class="btn color-btn" style="background-color: #28a745; width: 40px; height: 40px;" 
                                                data-color="#28a745" title="绿色"></button>
                                    </div>
                                    <div class="col-auto">
                                        <button type="button" class="btn color-btn" style="background-color: #007bff; width: 40px; height: 40px;" 
                                                data-color="#007bff" title="蓝色"></button>
                                    </div>
                                    <div class="col-auto">
                                        <button type="button" class="btn color-btn" style="background-color: #ffc107; width: 40px; height: 40px;" 
                                                data-color="#ffc107" title="黄色"></button>
                                    </div>
                                    <div class="col-auto">
                                        <button type="button" class="btn color-btn" style="background-color: #fd7e14; width: 40px; height: 40px;" 
                                                data-color="#fd7e14" title="橙色"></button>
                                    </div>
                                    <div class="col-auto">
                                        <button type="button" class="btn color-btn" style="background-color: #e83e8c; width: 40px; height: 40px;" 
                                                data-color="#e83e8c" title="粉色"></button>
                                    </div>
                                    <div class="col-auto">
                                        <button type="button" class="btn color-btn" style="background-color: #6f42c1; width: 40px; height: 40px;" 
                                                data-color="#6f42c1" title="紫色"></button>
                                    </div>
                                </div>
                                <small class="text-muted">点击选择颜色</small>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">预览</label>
                                <div id="badge-preview">
                                    <span class="badge" style="background-color: #28a745; color: white; font-size: 0.75rem;">✓</span>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                            <button type="button" class="btn btn-primary" id="confirmBadgeBtn">确认设置</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <script>
                // 确认徽章相关功能
                let selectedColor = '#28a745'; // 默认绿色

                function showConfirmationBadgeModal() {
                    const modal = new bootstrap.Modal(document.getElementById('confirmationBadgeModal'));
                    modal.show();
                }

                function clearConfirmationBadge() {
                    if (!confirm('确定要清除确认徽章吗？')) {
                        return;
                    }
                    
                    fetch(`/quotation/{{ object_id }}/confirmation-badge`, {
                        method: 'DELETE',
                        headers: {
                            'Content-Type': 'application/json',
                        }
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            location.reload(); // 刷新页面显示最新状态
                        } else {
                            alert('清除失败: ' + data.message);
                        }
                    })
                    .catch(error => {
                        console.error('清除确认徽章失败:', error);
                        alert('清除失败，请重试');
                    });
                }

                // 颜色选择
                document.addEventListener('DOMContentLoaded', function() {
                    document.querySelectorAll('.color-btn').forEach(btn => {
                        btn.addEventListener('click', function() {
                            // 移除其他按钮的选中状态
                            document.querySelectorAll('.color-btn').forEach(b => b.classList.remove('border', 'border-dark'));
                            
                            // 设置当前按钮为选中状态
                            this.classList.add('border', 'border-dark');
                            
                            selectedColor = this.dataset.color;
                            
                            // 更新预览
                            const preview = document.getElementById('badge-preview');
                            preview.innerHTML = `<span class="badge" style="background-color: ${selectedColor}; color: white; font-size: 0.75rem;">✓</span>`;
                        });
                    });

                    // 确认设置按钮
                    const confirmBtn = document.getElementById('confirmBadgeBtn');
                    if (confirmBtn) {
                        confirmBtn.addEventListener('click', function() {
                            fetch(`/quotation/{{ object_id }}/confirmation-badge`, {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                },
                                body: JSON.stringify({
                                    color: selectedColor
                                })
                            })
                            .then(response => response.json())
                            .then(data => {
                                if (data.success) {
                                    location.reload(); // 刷新页面显示最新状态
                                } else {
                                    alert('设置失败: ' + data.message);
                                }
                            })
                            .catch(error => {
                                console.error('设置确认徽章失败:', error);
                                alert('设置失败，请重试');
                            });
                        });
                    }
                });
            </script>
            {% endif %}
            
            <!-- 审批操作模态框 -->
            {% if current_user and can_user_approve and can_user_approve(approval_instance.id, current_user.id) %}
            <div class="modal fade" id="approvalActionModal" tabindex="-1" aria-labelledby="approvalActionModalLabel" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="approvalActionModalLabel">审批操作</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <div id="approvalActionDisplay" class="alert mb-3">
                                <!-- 动态内容 -->
                            </div>
                            <div class="mb-3">
                                <label for="approvalComment" class="form-label">审批意见</label>
                                <textarea class="form-control" id="approvalComment" rows="3" placeholder="请输入您的审批意见..."></textarea>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                            <button type="button" class="btn" id="confirmApprovalBtn" onclick="submitApprovalAction()">确认</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <script>
                let currentApprovalAction = '';
                
                function openApprovalActionModal(action) {
                    currentApprovalAction = action;
                    
                    const actionDisplay = document.getElementById('approvalActionDisplay');
                    const confirmBtn = document.getElementById('confirmApprovalBtn');
                    
                    if (action === 'approve') {
                        actionDisplay.className = 'alert alert-success mb-3';
                        actionDisplay.innerHTML = '<i class="fas fa-check me-2"></i>您确定要通过此审批吗？';
                        confirmBtn.className = 'btn btn-success';
                        confirmBtn.innerHTML = '<i class="fas fa-check me-1"></i>确认通过';
                    } else {
                        actionDisplay.className = 'alert alert-danger mb-3';
                        actionDisplay.innerHTML = '<i class="fas fa-times me-2"></i>您确定要拒绝此审批吗？';
                        confirmBtn.className = 'btn btn-danger';
                        confirmBtn.innerHTML = '<i class="fas fa-times me-1"></i>确认拒绝';
                    }
                    
                    document.getElementById('approvalComment').value = '';
                    
                    const modal = new bootstrap.Modal(document.getElementById('approvalActionModal'));
                    modal.show();
                }
                
                function submitApprovalAction() {
                    const comment = document.getElementById('approvalComment').value;
                    
                    fetch('{{ url_for("approval.approve", instance_id=approval_instance.id) }}', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                            'X-CSRFToken': '{{ csrf_token() }}'
                        },
                        body: new URLSearchParams({
                            'action': currentApprovalAction,
                            'comment': comment
                        })
                    })
                    .then(response => {
                        if (response.ok) {
                            const modal = bootstrap.Modal.getInstance(document.getElementById('approvalActionModal'));
                            modal.hide();
                            
                            // 显示成功消息并刷新页面
                            alert(currentApprovalAction === 'approve' ? '审批已通过' : '审批已拒绝');
                            window.location.reload();
                        } else {
                            alert('操作失败，请重试');
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('操作失败，请重试');
                    });
                }
            </script>
            {% endif %}
            
            <!-- 召回确认模态框 -->
            {% if approval_instance.status == ApprovalStatus.PENDING and current_user and current_user.id == approval_instance.created_by %}
            <div class="modal fade" id="recallApprovalModal" tabindex="-1" aria-labelledby="recallApprovalModalLabel" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="recallApprovalModalLabel">确认召回审批</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <div class="alert alert-warning">
                                <i class="fas fa-exclamation-triangle me-2"></i>
                                您确定要召回此审批流程吗？召回后审批流程将被终止，需要重新发起。
                            </div>
                            <div class="mb-3">
                                <label for="recallReason" class="form-label">召回原因（可选）</label>
                                <textarea class="form-control" id="recallReason" rows="3" placeholder="请输入召回原因..."></textarea>
                            </div>
                            <div class="mb-3">
                                <strong>审批实例信息：</strong><br>
                                <small class="text-muted">
                                    实例ID：{{ approval_instance.id }}<br>
                                    流程名称：{{ approval_instance.process.name if approval_instance.process else '未知流程' }}<br>
                                    当前步骤：{{ approval_instance.current_step }}
                                </small>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                            <button type="button" class="btn btn-warning" onclick="confirmRecallApproval()">
                                <i class="fas fa-undo me-1"></i> 确认召回
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <script>
                function confirmRecallApproval() {
                    const reason = document.getElementById('recallReason').value;
                    
                    fetch('{{ url_for("approval.recall_approval", instance_id=approval_instance.id) }}', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': '{{ csrf_token() }}'
                        },
                        body: JSON.stringify({
                            reason: reason
                        })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            const modal = bootstrap.Modal.getInstance(document.getElementById('recallApprovalModal'));
                            modal.hide();
                            
                            alert('审批已成功召回');
                            window.location.reload();
                        } else {
                            alert('召回失败: ' + (data.message || '未知错误'));
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('召回失败，请稍后重试');
                    });
                }
            </script>
            {% endif %}
            
        {% else %}
            <!-- 没有审批实例时显示发起审批按钮 -->
            <div class="card">
                <div class="card-header bg-secondary text-white">
                    <h5 class="mb-0"><i class="fas fa-clipboard-check me-2"></i>审批流程</h5>
                </div>
                <div class="card-body text-center">
                    <i class="fas fa-clipboard-list fa-3x text-muted mb-3"></i>
                    <p class="text-muted">暂无审批流程</p>
                    {{ render_start_approval_button(object_type, object_id, current_user) }}
                </div>
            </div>
        {% endif %}
    </div>
</div>
{% endmacro %} 