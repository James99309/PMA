{% macro render_project_type(type) %}
    {% set color = '#6c757d' %}
    {% if type == 'sales_focus' %}{% set color = '#0B6EFD' %}{% endif %}
    {% if type == 'channel_follow' %}{% set color = '#5BC0DE' %}{% endif %}
    {% if type == 'business_opportunity' %}{% set color = '#198754' %}{% endif %}
    <span class="badge" style="background-color: {{ color }}; color: #fff;">{{ type|project_type_label('zh') }}</span>
{% endmacro %}

{% macro render_owner(owner) %}
  <span class="badge bg-secondary">
    {{ owner.real_name if owner and owner.real_name else owner.username if owner else '未知' }}
  </span>
{% endmacro %}

{% macro render_project_stage(stage) %}
  {% set color_map = {
    '发现': '#d3e3fc',
    '植入': '#b7ddc8',
    '招标前': '#91c79f',
    '招标中': '#6daf6c',
    '中标': '#559c4c',
    '批价': '#3c8c2c',
    '签约': '#216822',
    '失败': '#6e2b23',
    '搁置': '#9e9e9e'
  } %}
  {% set color = color_map.get(stage, '#6c757d') %}
  <span class="badge rounded-pill" style="background-color: {{ color }}; color: #fff;">{{ stage }}</span>
{% endmacro %}

{% macro render_authorization_code(code, project_type=None, size="normal") %}
  {% set bg_color = '#6c757d' %}  {# 默认灰 #}
  {% if code and code.startswith('CPJ') or project_type == '渠道跟进' %}
    {% set bg_color = '#5bc0de' %}
  {% elif code and code.startswith('SPJ') or project_type == '销售重点' %}
    {% set bg_color = '#0B6EFD' %}
  {% elif code and code.startswith('APJ') or project_type == '业务机会' %}
    {% set bg_color = '#198754' %}
  {% endif %}
  <span class="badge rounded-pill"
        style="font-family: 'Helvetica Neue', sans-serif;
               font-size: 0.75rem;
               padding: 0.35em 0.85em;
               background-color: {{ bg_color }};
               color: #fff;">
    {{ code or '无' }}
  </span>
{% endmacro %}

{% macro render_quotation_number(number, size="normal") %}
  {% if number %}
    {% if size == "large" %}
      <span class="badge rounded-pill" style="background-color: #e6e6e6; color: #0056b3; font-family: 'Helvetica Neue', sans-serif; font-size: 0.95rem; font-weight: normal; padding: 0.3em 0.75em;">{{ number }}</span>
    {% else %}
      <span class="badge rounded-pill" style="background-color: #e6e6e6; color: #0056b3; font-family: 'Helvetica Neue', sans-serif; font-size: 0.85rem; font-weight: normal; padding: 0.3em 0.75em;">{{ number }}</span>
    {% endif %}
  {% else %}
    {% if size == "large" %}
      <span class="badge rounded-pill" style="background-color: #e6e6e6; color: #0056b3; font-family: 'Helvetica Neue', sans-serif; font-size: 0.95rem; font-weight: normal; padding: 0.3em 0.75em;">无</span>
    {% else %}
      <span class="badge rounded-pill" style="background-color: #e6e6e6; color: #0056b3; font-family: 'Helvetica Neue', sans-serif; font-size: 0.85rem; font-weight: normal; padding: 0.3em 0.75em;">无</span>
    {% endif %}
  {% endif %}
{% endmacro %}

{% macro render_date(date, format='%Y-%m-%d') %}
  {% if date %}
    {{ date.strftime(format) }}
  {% else %}

  {% endif %}
{% endmacro %}

{% macro render_datetime(datetime, format='%Y-%m-%d %H:%M') %}
  {% if datetime %}
    {{ datetime.strftime(format) }}
  {% else %}

  {% endif %}
{% endmacro %}

{% macro render_currency(amount) %}
  {% if amount %}
    ￥{{ '{:,.2f}'.format(amount) }}
  {% else %}

  {% endif %}
{% endmacro %}

{% macro render_button(text, href=None, color="primary", size="md", icon=None, rounded="pill", extra_class="", type="a", attrs=None) %}
  {%- set inline_style = "" %}
  {%- if size == "sm" %}
    {%- set font_size = "text-sm" %}
    {%- set padding = "py-2 px-3" %}
  {%- elif size == "lg" %}
    {%- set font_size = "text-base" %}
    {%- set padding = "py-3 px-5" %}
  {%- elif size == "xs" %}
    {%- set font_size = "text-xs" %}
    {%- set padding = "py-1 px-2" %}
  {%- else %}
    {%- set font_size = "text-sm" %}
    {%- set padding = "py-2 px-4" %}
  {%- endif %}
  {%- if color == "primary" %}
    {%- set btn_class = "btn text-white me-2" %}
    {%- set inline_style = "background-color: #0C7CD0;" %}
  {%- elif color == "auxiliary" %}
    {%- set btn_class = "btn btn-auxiliary me-2" %}
    {%- set inline_style = "" %}
  {%- elif color == "secondary" %}
    {%- set btn_class = "btn bg-secondary text-white me-2" %}
  {%- elif color == "info" %}
    {%- set btn_class = "btn bg-info text-white me-2" %}
  {%- elif color == "danger" %}
    {%- set btn_class = "btn text-white me-2" %}
    {%- set inline_style = "background-color: #dc3545;" %}
  {%- else %}
    {%- set btn_class = "btn bg-light text-dark me-2" %}
  {%- endif %}
  {%- set btn_class = btn_class + " " + padding + " " + font_size %}
  {%- if rounded %} {%- set btn_class = btn_class + " rounded-" + rounded %} {%- endif %}
  {%- if extra_class %} {%- set btn_class = btn_class + " " + extra_class %} {%- endif %}
  {% if type == "a" %}
    <a href="{{ href or '#' }}" class="{{ btn_class }}" style="{{ inline_style }}" {{ attrs|safe }}>
      {%- if icon %}<i class="{{ icon }} me-1"></i>{% endif -%}
      {%- if icon %}
        <span class="d-none d-md-inline">{{ text }}</span>
      {%- else %}
        {{ text }}
      {%- endif %}
    </a>
  {% elif type == "button" %}
    <button type="button" class="{{ btn_class }}" style="{{ inline_style }}" {{ attrs|safe }}>
      {%- if icon %}<i class="{{ icon }} me-1"></i>{% endif -%}
      {%- if icon %}
        <span class="d-none d-md-inline">{{ text }}</span>
      {%- else %}
        {{ text }}
      {%- endif %}
    </button>
  {% elif type == "submit" %}
    <button type="submit" class="{{ btn_class }}" style="{{ inline_style }}" {{ attrs|safe }}>
      {%- if icon %}<i class="{{ icon }} me-1"></i>{% endif -%}
      {%- if icon %}
        <span class="d-none d-md-inline">{{ text }}</span>
      {%- else %}
        {{ text }}
      {%- endif %}
    </button>
  {% endif %}
{% endmacro %}


{% macro render_primary_contact_badge(value) %}
  {% if value %}
    <span class="badge bg-success rounded-pill">是</span>
  {% else %}
    <span class="badge bg-secondary rounded-pill">否</span>
  {% endif %}
{% endmacro %}

{% macro render_status_badge(value) %}
  {% if value == 'active' %}
    <span class="badge bg-success rounded-pill">活跃</span>
  {% else %}
    <span class="badge bg-secondary rounded-pill">不活跃</span>
  {% endif %}
{% endmacro %}

{% macro render_company_code(code) %}
  {% if code %}
    <span class="badge rounded-pill" style="background-color: #5bc0de; color: white;">
      企业代码：{{ code }}
    </span>
  {% endif %}
{% endmacro %}

{% macro render_confirm_cancel(confirm_text='确认', cancel_text='取消', confirm_href='#', cancel_href='#', confirm_color='primary', cancel_color='secondary', confirm_first=True, size='md', confirm_type='a') %}
  <div class="d-flex gap-2">
    {% if confirm_first %}
      {% if confirm_type == 'submit' %}
        {{ render_button(confirm_text, color=confirm_color, size=size, type='submit') }}
      {% else %}
      {{ render_button(confirm_text, href=confirm_href, color=confirm_color, size=size) }}
      {% endif %}
      {{ render_button(cancel_text, href=cancel_href, color=cancel_color, size=size) }}
    {% else %}
      {{ render_button(cancel_text, href=cancel_href, color=cancel_color, size=size) }}
      {% if confirm_type == 'submit' %}
        {{ render_button(confirm_text, color=confirm_color, size=size, type='submit') }}
      {% else %}
      {{ render_button(confirm_text, href=confirm_href, color=confirm_color, size=size) }}
      {% endif %}
    {% endif %}
  </div>
{% endmacro %}


{% macro render_floating_action_button_group(buttons=[], icon='fas fa-plus') %}
<style>
.fab-container {
  position: fixed;
  bottom: 20px;
  right: 20px;
  z-index: 9999;
}
.fab-btn {
  width: 48px;
  height: 48px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 18px;
  transition: all 0.3s ease;
}
.fab-group {
  display: none;
  flex-direction: column;
  align-items: flex-end;
  margin-bottom: 10px;
}
.fab-container:hover .fab-group {
  display: flex;
}
</style>

<div class="fab-container d-md-none">
  <div class="fab-group">
    {% for btn in buttons %}
    <a href="{{ btn.href or '#' }}" class="btn btn-secondary mb-2 px-3 py-1 text-white rounded-pill small">
      {{ btn.label }}
    </a>
    {% endfor %}
  </div>
  <button class="btn btn-dark fab-btn shadow"><i class="{{ icon }}"></i></button>
</div>
{% endmacro %}

{% macro render_table_header(fields, sort_field=None, sort_order=None, base_url=None) %}
<thead>
  <tr>
    {% for field in fields %}
      {# 排序链接处理 #}
      {% if field.sortable %}
        {% set next_order = 'asc' if sort_order != 'asc' or sort_field != field.name else 'desc' %}
        {% set sort_url = base_url ~ '?sort=' ~ field.name ~ '&order=' ~ next_order %}
      {% else %}
        {% set sort_url = None %}
      {% endif %}

      <th
        {% if field.width %} style="width: {{ field.width }};" {% endif %}
        {% if field.tooltip %} title="{{ field.tooltip }}" {% endif %}
        class="align-middle"
      >
        {% if field.sortable %}
          <a href="{{ sort_url }}" class="text-decoration-none text-dark">
            {{ field.label }}
            {% if sort_field == field.name %}
              {% if sort_order == 'asc' %}
                <i class="fas fa-sort-up ms-1"></i>
              {% else %}
                <i class="fas fa-sort-down ms-1"></i>
              {% endif %}
            {% else %}
              <i class="fas fa-sort ms-1 text-muted"></i>
            {% endif %}
          </a>
        {% else %}
          {{ field.label }}
        {% endif %}
      </th>
    {% endfor %}
  </tr>
</thead>
{% endmacro %}


{% macro render_table_header_cell(field, sort_field=None, sort_order='asc', base_url='') %}
<th class="px-3 py-3 position-relative" title="{{ field.tooltip or '' }}">
  <div class="d-flex justify-content-between align-items-center">
    {% if field.sortable %}
      <a href="{{ base_url }}?sort={{ field.name }}&order={{ 'desc' if sort_field == field.name and sort_order == 'asc' else 'asc' }}"
         class="text-dark {% if sort_field == field.name %}current-sort{% endif %}">
        {{ field.label }}
        {% if sort_field == field.name %}
          <i class="fas {% if sort_order == 'asc' %}fa-sort-up{% else %}fa-sort-down{% endif %}"></i>
        {% else %}
          <i class="fas fa-sort"></i>
        {% endif %}
      </a>
    {% else %}
      <span>{{ field.label }}</span>
    {% endif %}

    {# 筛选下拉图标 #}
    {% if field.filterable and field.options %}
      <div class="dropdown ms-2">
        <a href="#" role="button" class="text-muted" data-bs-toggle="dropdown" aria-expanded="false">
          <i class="fas fa-filter"></i>
        </a>
        <div class="dropdown-menu p-3" style="min-width: 240px;">
          <form method="get" action="">
            <input type="hidden" name="filter_field" value="{{ field.name }}">
            <input type="text" name="filter_search" class="form-control mb-2" placeholder="搜索选项..." oninput="filterOptions(this)">
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="{{ field.name }}_all" onclick="toggleAll(this, '{{ field.name }}')">
              <label class="form-check-label" for="{{ field.name }}_all">(全选)</label>
            </div>
            <div class="filter-options" id="{{ field.name }}_options" style="max-height: 200px; overflow-y: auto;">
              {% for opt in field.options %}
              <div class="form-check">
                <input class="form-check-input" type="checkbox" name="filter_value" value="{{ opt }}" id="{{ field.name }}_{{ loop.index }}"
                       {% if opt in field.selected %}checked{% endif %}>
                <label class="form-check-label" for="{{ field.name }}_{{ loop.index }}">{{ opt or '(空白)' }}</label>
              </div>
              {% endfor %}
            </div>
            <button type="submit" class="btn btn-primary btn-sm mt-2 w-100">应用筛选器</button>
          </form>
        </div>
      </div>
    {% endif %}
  </div>
</th>
{% endmacro %}




{# Excel 风格高级筛选表头宏 #}
{% macro render_advanced_filter_header(field, label, options=[], selected=[]) %}
<th class="position-relative px-3 py-3">
  <div class="d-flex justify-content-between align-items-center">
    <span>{{ label }}</span>
    <div class="dropdown">
      <a href="#" role="button" class="text-muted ms-2" data-bs-toggle="dropdown" aria-expanded="false">
        <i class="fas fa-filter"></i>
      </a>
      <div class="dropdown-menu p-3" style="min-width: 240px;">
        <form method="get" action="">
          <input type="hidden" name="filter_field" value="{{ field }}">
          <input type="text" name="filter_search" class="form-control mb-2" placeholder="搜索选项..." oninput="filterOptions(this)">
          <div class="form-check">
            <input class="form-check-input" type="checkbox" id="{{ field }}_all" onclick="toggleAll(this, '{{ field }}')">
            <label class="form-check-label" for="{{ field }}_all">(全选)</label>
          </div>
          <div class="filter-options" id="{{ field }}_options" style="max-height: 200px; overflow-y: auto;">
            {% for opt in options %}
            <div class="form-check">
              <input class="form-check-input" type="checkbox" name="filter_value" value="{{ opt }}" id="{{ field }}_{{ loop.index }}"
                     {% if opt in selected %}checked{% endif %}>
              <label class="form-check-label" for="{{ field }}_{{ loop.index }}">{{ opt or '(空白)' }}</label>
            </div>
            {% endfor %}
          </div>
          <button type="submit" class="btn btn-primary btn-sm mt-2 w-100">应用筛选器</button>
        </form>
      </div>
    </div>
  </div>
</th>
{% endmacro %}