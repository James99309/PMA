{% macro render_project_type(type) %}
    {% set color = '#6c757d' %}
    {% if type == 'sales_focus' %}{% set color = '#0B6EFD' %}{% endif %}
    {% if type == 'channel_follow' %}{% set color = '#5BC0DE' %}{% endif %}
    {% if type == 'business_opportunity' %}{% set color = '#198754' %}{% endif %}
    <span class="badge rounded-pill" style="background-color: {{ color }}; color: #fff;">{{ type|project_type_label('zh') }}</span>
{% endmacro %}

{% macro render_owner(owner) %}
  {% if owner %}
    {% set display_name = owner.real_name if owner.real_name else owner.username %}
    {% if owner.company_name == '和源通信（上海）股份有限公司' %}
      {# 厂商账户使用胶囊造型徽章 #}
      <span class="badge bg-primary rounded-pill">{{ display_name }}</span>
    {% else %}
      {# 非厂商账户使用默认造型徽章 #}
      <span class="badge bg-secondary">{{ display_name }}</span>
    {% endif %}
  {% else %}
    <span class="badge bg-secondary">未知</span>
  {% endif %}
{% endmacro %}

{% macro render_project_stage(stage) %}
  {% set color_map = {
    '发现': '#d3e3fc',
    '植入': '#b7ddc8',
    '招标前': '#91c79f',
    '招标中': '#6daf6c',
    '中标': '#559c4c',
    '批价': '#3c8c2c',
    '签约': '#216822',
    '失败': '#6e2b23',
    '搁置': '#9e9e9e'
  } %}
  {% set color = color_map.get(stage, '#6c757d') %}
  <span class="badge rounded-pill" style="background-color: {{ color }}; color: #fff;">{{ stage }}</span>
{% endmacro %}

{% macro render_authorization_code(code, project_type=None, size="normal") %}
  {% set bg_color = '#6c757d' %}  {# 默认灰 #}
  {% if code and code.startswith('CPJ') or project_type == '渠道跟进' %}
    {% set bg_color = '#5bc0de' %}
  {% elif code and code.startswith('SPJ') or project_type == '销售重点' %}
    {% set bg_color = '#0B6EFD' %}
  {% elif code and code.startswith('APJ') or project_type == '业务机会' %}
    {% set bg_color = '#198754' %}
  {% endif %}
  <span class="badge rounded-pill"
        style="font-family: 'Helvetica Neue', sans-serif;
               font-size: 0.75rem;
               padding: 0.35em 0.85em;
               background-color: {{ bg_color }};
               color: #fff;">
    {{ code or '无' }}
  </span>
{% endmacro %}

{% macro render_quotation_number(number, size="normal") %}
  {% if number %}
    {% if size == "large" %}
      <span class="badge rounded-pill" style="background-color: #e6e6e6; color: #0056b3; font-family: 'Helvetica Neue', sans-serif; font-size: 0.95rem; font-weight: normal; padding: 0.3em 0.75em;">{{ number }}</span>
    {% else %}
      <span class="badge rounded-pill" style="background-color: #e6e6e6; color: #0056b3; font-family: 'Helvetica Neue', sans-serif; font-size: 0.85rem; font-weight: normal; padding: 0.3em 0.75em;">{{ number }}</span>
    {% endif %}
  {% else %}
    {% if size == "large" %}
      <span class="badge rounded-pill" style="background-color: #e6e6e6; color: #0056b3; font-family: 'Helvetica Neue', sans-serif; font-size: 0.95rem; font-weight: normal; padding: 0.3em 0.75em;">无</span>
    {% else %}
      <span class="badge rounded-pill" style="background-color: #e6e6e6; color: #0056b3; font-family: 'Helvetica Neue', sans-serif; font-size: 0.85rem; font-weight: normal; padding: 0.3em 0.75em;">无</span>
    {% endif %}
  {% endif %}
{% endmacro %}

{% macro render_approval_badge(approval_status) %}
  {% if approval_status %}
    {% set badge_config = {
      'discover_approved': {'text': '发', 'label': '发现审核'},
      'embed_approved': {'text': '植', 'label': '植入审核'},
      'pre_tender_approved': {'text': '招', 'label': '招标前审核'},
      'tendering_approved': {'text': '标', 'label': '招标中审核'},
      'awarded_approved': {'text': '中', 'label': '中标审核'},
      'quoted_approved': {'text': '批', 'label': '批价审核'},
      'signed_approved': {'text': '签', 'label': '签约审核'},
      'rejected': {'text': '拒', 'label': '已拒绝'}
    } %}
    {% set config = badge_config.get(approval_status, {'text': '?', 'label': approval_status}) %}
    <span class="badge d-inline-flex align-items-center justify-content-center" 
          style="background: linear-gradient(135deg, #FFD700, #FFA500); 
                 color: #8B4513; 
                 font-size: 0.75rem; 
                 font-weight: bold;
                 padding: 0.25em;
                 border: 2px solid #DAA520;
                 width: 24px;
                 height: 24px;
                 position: relative;
                 box-shadow: 0 2px 4px rgba(255, 215, 0, 0.3);
                 clip-path: polygon(50% 0%, 65% 15%, 85% 15%, 100% 50%, 85% 85%, 65% 85%, 50% 100%, 35% 85%, 15% 85%, 0% 50%, 15% 15%, 35% 15%);"
          title="{{ config.label }}">
      <!-- 中心文字 -->
      <span style="position: relative; z-index: 1;">{{ config.text }}</span>
    </span>
  {% endif %}
{% endmacro %}

{% macro render_date(date, format='%Y-%m-%d') %}
  {% if date %}
    {{ date.strftime(format) }}
  {% else %}

  {% endif %}
{% endmacro %}

{% macro render_datetime(datetime, format='%Y-%m-%d %H:%M') %}
  {% if datetime %}
    {{ datetime.strftime(format) }}
  {% else %}

  {% endif %}
{% endmacro %}

{% macro render_currency(amount) %}
  {% if amount %}
    ￥{{ '{:,.2f}'.format(amount) }}
  {% else %}

  {% endif %}
{% endmacro %}

{% macro render_button(text, href=None, color="primary", size="md", icon=None, rounded="pill", extra_class="", type="a", attrs=None) %}
  {%- set inline_style = "" %}
  {%- if size == "sm" %}
    {%- set font_size = "text-sm" %}
    {%- set padding = "py-2 px-3" %}
  {%- elif size == "lg" %}
    {%- set font_size = "text-base" %}
    {%- set padding = "py-3 px-5" %}
  {%- elif size == "xs" %}
    {%- set font_size = "text-xs" %}
    {%- set padding = "py-1 px-2" %}
  {%- else %}
    {%- set font_size = "text-sm" %}
    {%- set padding = "py-2 px-4" %}
  {%- endif %}
  {%- if color == "primary" %}
    {%- set btn_class = "btn text-white me-2" %}
    {%- set inline_style = "background-color: #0C7CD0;" %}
  {%- elif color == "auxiliary" %}
    {%- set btn_class = "btn btn-auxiliary me-2" %}
    {%- set inline_style = "" %}
  {%- elif color == "secondary" %}
    {%- set btn_class = "btn bg-secondary text-white me-2" %}
  {%- elif color == "info" %}
    {%- set btn_class = "btn bg-info text-white me-2" %}
  {%- elif color == "warning" %}
    {%- set btn_class = "btn bg-warning text-dark me-2" %}
  {%- elif color == "danger" %}
    {%- set btn_class = "btn text-white me-2" %}
    {%- set inline_style = "background-color: #dc3545;" %}
  {%- else %}
    {%- set btn_class = "btn bg-light text-dark me-2" %}
  {%- endif %}
  {%- set btn_class = btn_class + " " + padding + " " + font_size %}
  {%- if rounded %} {%- set btn_class = btn_class + " rounded-" + rounded %} {%- endif %}
  {%- if extra_class %} {%- set btn_class = btn_class + " " + extra_class %} {%- endif %}
  {% if type == "a" %}
    <a href="{{ href or '#' }}" class="{{ btn_class }}" style="{{ inline_style }}" {{ attrs|safe }}>
      {%- if icon %}<i class="{{ icon }} me-1"></i>{% endif -%}
      {%- if icon %}
        <span class="d-none d-md-inline">{{ text }}</span>
      {%- else %}
        {{ text }}
      {%- endif %}
    </a>
  {% elif type == "button" %}
    <button type="button" class="{{ btn_class }}" style="{{ inline_style }}" {{ attrs|safe }}>
      {%- if icon %}<i class="{{ icon }} me-1"></i>{% endif -%}
      {%- if icon %}
        <span class="d-none d-md-inline">{{ text }}</span>
      {%- else %}
        {{ text }}
      {%- endif %}
    </button>
  {% elif type == "submit" %}
    <button type="submit" class="{{ btn_class }}" style="{{ inline_style }}" {{ attrs|safe }}>
      {%- if icon %}<i class="{{ icon }} me-1"></i>{% endif -%}
      {%- if icon %}
        <span class="d-none d-md-inline">{{ text }}</span>
      {%- else %}
        {{ text }}
      {%- endif %}
    </button>
  {% endif %}
{% endmacro %}


{% macro render_primary_contact_badge(value) %}
  {% if value %}
    <span class="badge bg-success rounded-pill">是</span>
  {% else %}
    <span class="badge bg-secondary rounded-pill">否</span>
  {% endif %}
{% endmacro %}

{% macro render_status_badge(value) %}
  {% if value == 'active' %}
    <span class="badge bg-success rounded-pill">活跃</span>
  {% else %}
    <span class="badge bg-secondary rounded-pill">不活跃</span>
  {% endif %}
{% endmacro %}

{% macro render_company_code(code) %}
  {% if code %}
    <span class="badge rounded-pill" style="background-color: #5bc0de; color: white;">
      企业代码：{{ code }}
    </span>
  {% endif %}
{% endmacro %}

{% macro render_confirm_cancel(confirm_text='确认', cancel_text='取消', confirm_href='#', cancel_href='#', confirm_color='primary', cancel_color='secondary', confirm_first=True, size='md', confirm_type='a') %}
  <div class="d-flex gap-2">
    {% if confirm_first %}
      {% if confirm_type == 'submit' %}
        {{ render_button(confirm_text, color=confirm_color, size=size, type='submit') }}
      {% else %}
      {{ render_button(confirm_text, href=confirm_href, color=confirm_color, size=size) }}
      {% endif %}
      {{ render_button(cancel_text, href=cancel_href, color=cancel_color, size=size) }}
    {% else %}
      {{ render_button(cancel_text, href=cancel_href, color=cancel_color, size=size) }}
      {% if confirm_type == 'submit' %}
        {{ render_button(confirm_text, color=confirm_color, size=size, type='submit') }}
      {% else %}
      {{ render_button(confirm_text, href=confirm_href, color=confirm_color, size=size) }}
      {% endif %}
    {% endif %}
  </div>
{% endmacro %}


{% macro render_floating_action_button_group(buttons=[], icon='fas fa-plus') %}
<style>
.fab-container {
  position: fixed;
  bottom: 20px;
  right: 20px;
  z-index: 9999;
}
.fab-btn {
  width: 48px;
  height: 48px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 18px;
  transition: all 0.3s ease;
}
.fab-group {
  display: none;
  flex-direction: column;
  align-items: flex-end;
  margin-bottom: 10px;
}
.fab-container:hover .fab-group {
  display: flex;
}
</style>

<div class="fab-container d-md-none">
  <div class="fab-group">
    {% for btn in buttons %}
    <a href="{{ btn.href or '#' }}" class="btn btn-secondary mb-2 px-3 py-1 text-white rounded-pill small">
      {{ btn.label }}
    </a>
    {% endfor %}
  </div>
  <button class="btn btn-dark fab-btn shadow"><i class="{{ icon }}"></i></button>
</div>
{% endmacro %}

{% macro render_table_header(fields, sort_field=None, sort_order=None, base_url=None) %}
<thead>
  <tr>
    {% for field in fields %}
      {# 排序链接处理 #}
      {% if field.sortable %}
        {% set next_order = 'asc' if sort_order != 'asc' or sort_field != field.name else 'desc' %}
        {% set sort_url = base_url ~ '?sort=' ~ field.name ~ '&order=' ~ next_order %}
      {% else %}
        {% set sort_url = None %}
      {% endif %}

      <th
        {% if field.width %} style="width: {{ field.width }};" {% endif %}
        {% if field.tooltip %} title="{{ field.tooltip }}" {% endif %}
        class="align-middle"
      >
        {% if field.sortable %}
          <a href="{{ sort_url }}" class="text-decoration-none text-dark">
            {{ field.label }}
            {% if sort_field == field.name %}
              {% if sort_order == 'asc' %}
                <i class="fas fa-sort-up ms-1"></i>
              {% else %}
                <i class="fas fa-sort-down ms-1"></i>
              {% endif %}
            {% else %}
              <i class="fas fa-sort ms-1 text-muted"></i>
            {% endif %}
          </a>
        {% else %}
          {{ field.label }}
        {% endif %}
      </th>
    {% endfor %}
  </tr>
</thead>
{% endmacro %}


{% macro render_table_header_cell(field, sort_field=None, sort_order='asc', base_url='') %}
<th class="px-3 py-3 position-relative" title="{{ field.tooltip or '' }}">
  <div class="d-flex justify-content-between align-items-center">
    {% if field.sortable %}
      <a href="{{ base_url }}?sort={{ field.name }}&order={{ 'desc' if sort_field == field.name and sort_order == 'asc' else 'asc' }}"
         class="text-dark {% if sort_field == field.name %}current-sort{% endif %}">
        {{ field.label }}
        {% if sort_field == field.name %}
          <i class="fas {% if sort_order == 'asc' %}fa-sort-up{% else %}fa-sort-down{% endif %}"></i>
        {% else %}
          <i class="fas fa-sort"></i>
        {% endif %}
      </a>
    {% else %}
      <span>{{ field.label }}</span>
    {% endif %}

    {# 筛选下拉图标 #}
    {% if field.filterable and field.options %}
      <div class="dropdown ms-2">
        <a href="#" role="button" class="text-muted" data-bs-toggle="dropdown" aria-expanded="false">
          <i class="fas fa-filter"></i>
        </a>
        <div class="dropdown-menu p-3" style="min-width: 240px;">
          <form method="get" action="">
            <input type="hidden" name="filter_field" value="{{ field.name }}">
            <input type="text" name="filter_search" class="form-control mb-2" placeholder="搜索选项..." oninput="filterOptions(this)">
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="{{ field.name }}_all" onclick="toggleAll(this, '{{ field.name }}')">
              <label class="form-check-label" for="{{ field.name }}_all">(全选)</label>
            </div>
            <div class="filter-options" id="{{ field.name }}_options" style="max-height: 200px; overflow-y: auto;">
              {% for opt in field.options %}
              <div class="form-check">
                <input class="form-check-input" type="checkbox" name="filter_value" value="{{ opt }}" id="{{ field.name }}_{{ loop.index }}"
                       {% if opt in field.selected %}checked{% endif %}>
                <label class="form-check-label" for="{{ field.name }}_{{ loop.index }}">{{ opt or '(空白)' }}</label>
              </div>
              {% endfor %}
            </div>
            <button type="submit" class="btn btn-primary btn-sm mt-2 w-100">应用筛选器</button>
          </form>
        </div>
      </div>
    {% endif %}
  </div>
</th>
{% endmacro %}




{# Excel 风格高级筛选表头宏 #}
{% macro render_advanced_filter_header(field, label, options=[], selected=[]) %}
<th class="position-relative px-3 py-3">
  <div class="d-flex justify-content-between align-items-center">
    <span>{{ label }}</span>
    <div class="dropdown">
      <a href="#" role="button" class="text-muted ms-2" data-bs-toggle="dropdown" aria-expanded="false">
        <i class="fas fa-filter"></i>
      </a>
      <div class="dropdown-menu p-3" style="min-width: 240px;">
        <form method="get" action="">
          <input type="hidden" name="filter_field" value="{{ field }}">
          <input type="text" name="filter_search" class="form-control mb-2" placeholder="搜索选项..." oninput="filterOptions(this)">
          <div class="form-check">
            <input class="form-check-input" type="checkbox" id="{{ field }}_all" onclick="toggleAll(this, '{{ field }}')">
            <label class="form-check-label" for="{{ field }}_all">(全选)</label>
          </div>
          <div class="filter-options" id="{{ field }}_options" style="max-height: 200px; overflow-y: auto;">
            {% for opt in options %}
            <div class="form-check">
              <input class="form-check-input" type="checkbox" name="filter_value" value="{{ opt }}" id="{{ field }}_{{ loop.index }}"
                     {% if opt in selected %}checked{% endif %}>
              <label class="form-check-label" for="{{ field }}_{{ loop.index }}">{{ opt or '(空白)' }}</label>
            </div>
            {% endfor %}
          </div>
          <button type="submit" class="btn btn-primary btn-sm mt-2 w-100">应用筛选器</button>
        </form>
      </div>
    </div>
  </div>
</th>
{% endmacro %}

{% macro render_tree_select(name, tree_data, selected_value=None, placeholder='请选择', required=False) %}
<select class="form-select tree-select" name="{{ name }}" id="{{ name }}" {% if required %}required{% endif %}>
  <option value="">{{ placeholder }}</option>
  {% for item in tree_data %}
    {{ _render_tree_option(item, selected_value, level=0) }}
  {% endfor %}
</select>

<script>
// 确保脚本在有ID为{{ name }}的元素时才执行
(function() {
  var selectId = "{{ name }}";
  
  function initTreeSelect() {
    var select = document.getElementById(selectId);
    if (!select) return;
    
    // 初始化下拉框，添加展开/折叠标记
    var options = select.querySelectorAll('option');
    
    options.forEach(function(option) {
      if (option.classList.contains('group-label')) {
        var level = parseInt(option.getAttribute('data-level') || '0');
        var indent = '\u00A0\u00A0'.repeat(level * 2); // 使用不间断空格
        
        // 添加展开/折叠标记
        option.innerHTML = indent + '+ ' + option.textContent;
        option.setAttribute('data-original-text', option.textContent);
        
        // 隐藏该组下的所有子选项（初始状态为折叠）
        var groupId = option.getAttribute('data-group-id');
        hideGroupOptions(select, groupId);
      }
    });
  }
  
  function hideGroupOptions(select, groupId) {
    var selector = '.group-' + groupId + ':not([data-group-id="' + groupId + '"])';
    var childOptions = select.querySelectorAll(selector);
    childOptions.forEach(function(childOption) {
      childOption.style.display = 'none';
    });
  }
  
  function showGroupOptions(select, groupId) {
    var selector = '.group-' + groupId + ':not([data-group-id="' + groupId + '"])';
    var childOptions = select.querySelectorAll(selector);
    childOptions.forEach(function(childOption) {
      childOption.style.display = '';
    });
  }
  
  // 当DOM内容加载完毕后初始化
  document.addEventListener('DOMContentLoaded', function() {
    initTreeSelect();
    
    // 添加点击事件监听
    var select = document.getElementById(selectId);
    if (select) {
      select.addEventListener('mousedown', function(e) {
        var option = e.target;
        if (option.tagName !== 'OPTION') return;
        
        if (option.classList.contains('group-label')) {
          e.preventDefault(); // 防止选择组标签
          
          var groupId = option.getAttribute('data-group-id');
          var isExpanded = option.getAttribute('data-expanded') === 'true';
          
          // 切换展开/折叠状态
          option.setAttribute('data-expanded', isExpanded ? 'false' : 'true');
          
          // 更新显示文本
          var originalText = option.getAttribute('data-original-text');
          var level = parseInt(option.getAttribute('data-level') || '0');
          var indent = '\u00A0\u00A0'.repeat(level * 2);
          
          if (isExpanded) {
            // 折叠
            option.innerHTML = indent + '+ ' + originalText;
            hideGroupOptions(select, groupId);
          } else {
            // 展开
            option.innerHTML = indent + '- ' + originalText;
            showGroupOptions(select, groupId);
          }
        }
      });
    }
  });
})();
</script>
{% endmacro %}

{% macro _render_tree_option(item, selected_value, level=0) %}
  {% set indent = '&nbsp;&nbsp;&nbsp;&nbsp;' * level %}
  
  {% if item.is_group %}
    <option 
      value="" 
      class="group-label group-{{ item.id }}" 
      data-group-id="{{ item.id }}" 
      data-level="{{ level }}" 
      data-expanded="false"
      disabled
    >
      {{ item.label }}
    </option>
  {% else %}
    <option 
      value="{{ item.id }}" 
      {% if item.id == selected_value %}selected{% endif %}
    >
      {{ indent|safe }}{{ item.label }}
    </option>
  {% endif %}
  
  {% if item.children %}
    {% for child in item.children %}
      {{ _render_tree_option(child, selected_value, level + 1) }}
    {% endfor %}
  {% endif %}
{% endmacro %}

{% macro render_tree_select_plugin(name, tree_data, selected_value=None, placeholder='请选择', required=False) %}
<div class="tree-select-container">
  <input type="hidden" name="{{ name }}" id="{{ name }}" value="{{ selected_value }}" {% if required %}required{% endif %}>
  <div class="tree-select-wrapper" id="{{ name }}_wrapper">
    <div class="tree-select-input form-control" id="{{ name }}_input">
      <span class="tree-select-placeholder">{{ placeholder }}</span>
      <span class="tree-selected-text" style="display:none;"></span>
      <span class="tree-select-arrow"><i class="fas fa-caret-down"></i></span>
    </div>
    <div class="tree-select-dropdown" id="{{ name }}_dropdown" style="display:none;">
      <div class="tree-container" id="{{ name }}_tree"></div>
    </div>
  </div>
</div>

<style>
  .tree-select-container {
    position: relative;
    width: 100%;
  }
  .tree-select-wrapper {
    position: relative;
  }
  .tree-select-input {
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: space-between;
    height: 36px;
    padding: 0.375rem 0.75rem;
  }
  .tree-select-placeholder {
    color: #6c757d;
  }
  .tree-selected-text {
    font-weight: normal;
  }
  .tree-select-arrow {
    margin-left: 8px;
  }
  .tree-select-dropdown {
    position: absolute;
    width: 100%;
    max-height: 300px;
    overflow-y: auto;
    background: white;
    border: 1px solid #ced4da;
    border-radius: 0.25rem;
    z-index: 1000;
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    margin-top: 2px;
    padding: 8px;
  }
  .tree-container {
    width: 100%;
  }
  .tree-container ul {
    padding-left: 1.2rem;
  }
  .tree-container li {
    list-style-type: none;
    padding: 3px 0;
  }
  .tree-container li .tree-node {
    display: flex;
    align-items: center;
  }
  .tree-container li .tree-icon {
    margin-right: 4px;
    cursor: pointer;
    width: 16px;
    text-align: center;
    color: #333;
  }
  .tree-container li .tree-icon i {
    font-size: 14px;
    color: #333;
    background: transparent;
  }
  .tree-container li .tree-label {
    cursor: pointer;
    padding: 3px 5px;
    border-radius: 3px;
  }
  .tree-container li .tree-label:hover {
    background-color: #f8f9fa;
  }
  .tree-container li .tree-label.selected {
    background-color: #e9f2ff;
  }
  .tree-container li .tree-label.group {
    font-weight: bold;
    cursor: default;
  }
  /* 定制+/-符号样式 */
  .tree-container .fa-plus-square::before {
    content: "+";
    font-family: monospace;
    font-weight: bold;
    font-size: 16px;
  }
  .tree-container .fa-minus-square::before {
    content: "-";
    font-family: monospace;
    font-weight: bold;
    font-size: 16px;
  }
</style>

<script>
  // 使用立即执行函数表达式避免全局变量污染
  (function initTreePlugin_{{ name | replace('-', '_') }}() {
    // 等待jQuery和DOM加载
    function init() {
      if (typeof jQuery !== 'undefined' && document.getElementById('{{ name }}')) {
        setupTree();
      } else {
        setTimeout(init, 50);
      }
    }
    
    function setupTree() {
      var $ = jQuery;
      var nameId = "{{ name }}";
      var treeDataStr = '{{ tree_data|tojson }}';
      var treeData;
      
      try {
        treeData = JSON.parse(treeDataStr.replace(/&quot;/g, '"'));
      } catch(e) {
        console.warn("树形数据解析错误:", e);
        treeData = [];
      }
      
      var selectedValue = "{{ selected_value }}";
      var wrapper = document.getElementById(nameId + '_wrapper');
      var input = document.getElementById(nameId + '_input');
      var dropdown = document.getElementById(nameId + '_dropdown');
      var hiddenInput = document.getElementById(nameId);
      var tree = document.getElementById(nameId + '_tree');
      
      if (!wrapper || !input || !dropdown || !hiddenInput || !tree) {
        console.warn("树形控件元素未找到:", nameId);
        return;
      }
      
      var placeholder = wrapper.querySelector('.tree-select-placeholder');
      var selectedText = wrapper.querySelector('.tree-selected-text');

      // 构建树结构HTML
      function buildTreeHTML(nodes, level = 0) {
        if (!nodes || nodes.length === 0) {
          return '<div class="text-muted text-center py-2">暂无可选用户</div>';
        }
        var html = '<ul style="' + (level > 0 ? 'display:none;' : '') + '">';
        nodes.forEach(function(node) {
          var hasChildren = node.children && node.children.length > 0;
          var isGroup = node.is_group;
          var cssClass = isGroup ? 'group' : '';
          var selectedClass = (node.id == selectedValue) ? 'selected' : '';
          html += '<li data-id="' + node.id + '" data-is-group="' + isGroup + '">';
          html += '<div class="tree-node">';
          if (hasChildren) {
            html += '<span class="tree-icon"><i class="fas fa-plus-square"></i></span>';
          } else {
            html += '<span class="tree-icon"></span>';
          }
          html += '<span class="tree-label ' + cssClass + ' ' + selectedClass + '">' + node.label + '</span>';
          html += '</div>';
          if (hasChildren) {
            html += buildTreeHTML(node.children, level + 1);
          }
          html += '</li>';
        });
        html += '</ul>';
        return html;
      }

      // 初始化树
      tree.innerHTML = buildTreeHTML(treeData);

      // 如果有已选值，显示对应文本
      if (selectedValue) {
        findSelectedNode();
      } else {
        selectedText.style.display = 'none';
        placeholder.style.display = 'inline';
      }

      function findSelectedNode() {
        var selectedNode = tree.querySelector('.tree-label.selected');
        if (selectedNode) {
          selectedText.textContent = selectedNode.textContent;
          selectedText.style.display = 'inline';
          placeholder.style.display = 'none';
          var li = selectedNode.closest('li');
          expandParents(li);
        }
      }
      
      function expandParents(li) {
        while (li) {
          var parentUl = li.parentElement;
          if (parentUl && parentUl.tagName === 'UL') {
            parentUl.style.display = 'block';
            var parentLi = parentUl.closest('li');
            if (parentLi) {
              var icon = parentLi.querySelector('.tree-icon i');
              if (icon) {
                icon.classList.remove('fa-plus-square');
                icon.classList.add('fa-minus-square');
              }
            }
            li = parentLi;
          } else {
            break;
          }
        }
      }

      input.addEventListener('click', function(e) {
        dropdown.style.display = dropdown.style.display === 'none' ? 'block' : 'none';
        e.stopPropagation();
      });
      
      document.addEventListener('click', function() {
        dropdown.style.display = 'none';
      });
      
      dropdown.addEventListener('click', function(e) {
        e.stopPropagation();
      });
      
      tree.addEventListener('click', function(e) {
        var target = e.target;
        // 处理展开/折叠图标点击
        if (target.parentElement && target.parentElement.classList.contains('tree-icon')) {
          var li = target.closest('li');
          var ul = li.querySelector('ul');
          if (ul) {
            if (ul.style.display === 'none') {
              ul.style.display = 'block';
              target.classList.remove('fa-plus-square');
              target.classList.add('fa-minus-square');
            } else {
              ul.style.display = 'none';
              target.classList.remove('fa-minus-square');
              target.classList.add('fa-plus-square');
            }
          }
          e.stopPropagation();
        }
        // 处理选择节点
        if (target.classList.contains('tree-label') && !target.classList.contains('group')) {
          var oldSelected = tree.querySelector('.tree-label.selected');
          if (oldSelected) {
            oldSelected.classList.remove('selected');
          }
          target.classList.add('selected');
          selectedText.textContent = target.textContent;
          selectedText.style.display = 'inline';
          placeholder.style.display = 'none';
          var nodeId = target.closest('li').getAttribute('data-id');
          hiddenInput.value = nodeId;
          dropdown.style.display = 'none';
          e.stopPropagation();
        }
      });
            
      // 处理模态框中的树状控件
      var modal = $(input).closest('.modal');
      if (modal.length) {
        modal.on('shown.bs.modal', function() {
          if (tree.innerHTML === '' || tree.children.length === 0) {
            tree.innerHTML = buildTreeHTML(treeData);
            if (selectedValue) {
              findSelectedNode();
            }
          }
        });
      }
    }
    
    // 开始初始化
    init();
  })();
</script>
{% endmacro %}
{% macro render_toggle_switch(name, checked=False, label_on="ON", label_off="OFF", size="md", extra_class="", attrs="") %}
<style>
.toggle-switch {
  position: relative;
  display: inline-block;
  width: 60px;
  height: 30px;
}
.toggle-switch input {
  opacity: 0;
  width: 0;
  height: 0;
}
.toggle-slider {
  position: absolute;
  background-color: #000;
  transition: .4s;
  border-radius: 34px;
  width: 100%;
  height: 100%;
}
.toggle-slider::before {
  position: absolute;
  content: "OFF";
  color: white;
  font-size: 12px;
  right: 8px;
  top: 50%;
  transform: translateY(-50%);
  transition: .4s;
}
.toggle-slider::after {
  content: "";
  position: absolute;
  height: 22px;
  width: 22px;
  left: 4px;
  bottom: 4px;
  background-color: white;
  border-radius: 50%;
  transition: .4s;
}
.toggle-switch input:checked + .toggle-slider::after {
  transform: translateX(30px);
}
.toggle-switch input:checked + .toggle-slider::before {
  content: "ON";
  left: 8px;
}
</style>

<div class="d-inline-flex align-items-center {{ extra_class }}">
  <label class="toggle-switch mb-0">
    <input type="checkbox" name="{{ name }}" {% if checked %}checked{% endif %} {{ attrs|safe }}>
    <span class="toggle-slider"></span>
  </label>
</div>
{% endmacro %}

{% macro render_project_rating(rating, size="normal", show_text=False, style="badge") %}
  {# 渲染项目五星评分 #}
  {% if style == "list" %}
    {# 项目列表样式：无底色，直接显示星星状态 #}
    {% if rating and rating > 0 %}
      <span class="project-rating-stars d-inline-flex align-items-center" title="{{ rating }}星评分">
        {% for i in range(1, 6) %}
          {% set star_value = i %}
          {% set rating_float = rating|float %}
          {% if star_value <= rating_float|int %}
            <i class="fas fa-star" style="color: #ffc107; font-size: 0.9rem; margin-right: 1px;"></i>
          {% elif star_value == (rating_float|int + 1) and (rating_float % 1) >= 0.5 %}
            <i class="fas fa-star-half-alt" style="color: #ffc107; font-size: 0.9rem; margin-right: 1px;"></i>
          {% else %}
            <i class="far fa-star" style="color: #dee2e6; font-size: 0.9rem; margin-right: 1px;"></i>
          {% endif %}
        {% endfor %}
      </span>
    {% endif %}
  {% else %}
    {# 徽章样式：原有的徽章显示 #}
    {% if rating %}
      {% set star_size = "fa-sm" if size == "small" else "fa-lg" if size == "large" else "" %}
      {% set badge_class = "badge bg-warning text-dark rounded-pill d-inline-flex align-items-center" %}
      {% if size == "small" %}
        {% set badge_class = badge_class + " px-2 py-1" %}
      {% elif size == "large" %}
        {% set badge_class = badge_class + " px-3 py-2" %}
      {% else %}
        {% set badge_class = badge_class + " px-2 py-1" %}
      {% endif %}
      
      <span class="{{ badge_class }}" title="{{ rating }}星评分">
        {% for i in range(1, 6) %}
          {% set star_value = i %}
          {% set rating_float = rating|float %}
          {% if star_value <= rating_float|int %}
            <i class="fas fa-star {{ star_size }}" style="color: #ffc107;"></i>
          {% elif star_value == (rating_float|int + 1) and (rating_float % 1) >= 0.5 %}
            <i class="fas fa-star-half-alt {{ star_size }}" style="color: #ffc107;"></i>
          {% else %}
            <i class="far fa-star {{ star_size }}" style="color: #dee2e6;"></i>
          {% endif %}
        {% endfor %}
        {% if show_text %}
          <span class="ms-1" style="font-size: 0.8em;">{{ rating }}星</span>
        {% endif %}
      </span>
    {% else %}
      <span class="badge bg-light text-muted rounded-pill px-2 py-1" title="未评分">
        {% for i in range(1, 6) %}
          <i class="far fa-star fa-sm" style="color: #dee2e6;"></i>
        {% endfor %}
        {% if show_text %}
          <span class="ms-1" style="font-size: 0.8em;">未评分</span>
        {% endif %}
      </span>
    {% endif %}
  {% endif %}
{% endmacro %}

{% macro render_rating_input(name, current_rating=None, required=False, disabled=False) %}
  {# 渲染可交互的五星评分输入组件 #}
  <div class="rating-input" data-rating="{{ current_rating or 0 }}">
    <input type="hidden" name="{{ name }}" id="{{ name }}" value="{{ current_rating or '' }}" {% if required %}required{% endif %}>
    <div class="star-rating d-flex align-items-center">
      {% for i in range(1, 6) %}
        <i class="rating-star fas fa-star fa-lg me-1" 
           data-rating="{{ i }}" 
           style="color: {% if current_rating and i <= current_rating %}#ffc107{% else %}#dee2e6{% endif %}; cursor: {% if not disabled %}pointer{% else %}default{% endif %};"
           {% if not disabled %}onclick="setRating('{{ name }}', {{ i }})"{% endif %}
           title="{{ i }}星"></i>
      {% endfor %}
      <span class="rating-text ms-2 text-muted">
        {% if current_rating %}
          {{ current_rating }}星
        {% else %}
          点击星星进行评分
        {% endif %}
      </span>
    </div>
  </div>

  <style>
    .rating-star:hover {
      {% if not disabled %}
      transform: scale(1.1);
      transition: transform 0.1s ease;
      {% endif %}
    }
  </style>

  <script>
    function setRating(inputName, rating) {
      // 设置隐藏输入框的值
      document.getElementById(inputName).value = rating;
      
      // 更新星星显示
      const container = document.querySelector(`input[name="${inputName}"]`).closest('.rating-input');
      const stars = container.querySelectorAll('.rating-star');
      const ratingText = container.querySelector('.rating-text');
      
      stars.forEach((star, index) => {
        if (index < rating) {
          star.style.color = '#ffc107';
        } else {
          star.style.color = '#dee2e6';
        }
      });
      
      // 更新文本
      ratingText.textContent = rating + '星';
      
      // 更新容器的data-rating属性
      container.setAttribute('data-rating', rating);
    }
    
    // 鼠标悬停效果
    document.addEventListener('DOMContentLoaded', function() {
      document.querySelectorAll('.rating-input').forEach(container => {
        const stars = container.querySelectorAll('.rating-star');
        const originalRating = container.getAttribute('data-rating');
        
        stars.forEach((star, index) => {
          star.addEventListener('mouseenter', function() {
            if (!this.onclick) return; // 如果禁用则跳过
            
            // 临时高亮到当前星星
            stars.forEach((s, i) => {
              if (i <= index) {
                s.style.color = '#ffc107';
              } else {
                s.style.color = '#dee2e6';
              }
            });
          });
        });
        
        container.addEventListener('mouseleave', function() {
          // 恢复原始评分显示
          stars.forEach((s, i) => {
            if (i < originalRating) {
              s.style.color = '#ffc107';
            } else {
              s.style.color = '#dee2e6';
            }
          });
        });
      });
    });
  </script>
{% endmacro %}

{# 分页组件宏 #}
{% macro render_pagination(pagination, endpoint=None, fragment='', url=None, extra_params='') %}
  {% if pagination.pages > 1 %}
    <nav aria-label="分页导航">
      <ul class="pagination pagination-sm justify-content-center mb-0">
        {# 上一页 #}
        {% if pagination.has_prev %}
          <li class="page-item">
            {% if url %}
              <a class="page-link" href="{{ url }}?page={{ pagination.prev_num }}{{ fragment }}">
                <i class="fas fa-chevron-left"></i>
              </a>
            {% elif endpoint %}
              <a class="page-link" href="{{ url_for(endpoint, page=pagination.prev_num) }}{{ extra_params }}{{ fragment }}">
                <i class="fas fa-chevron-left"></i>
              </a>
            {% else %}
              <a class="page-link" href="?page={{ pagination.prev_num }}{{ fragment }}">
                <i class="fas fa-chevron-left"></i>
              </a>
            {% endif %}
          </li>
        {% else %}
          <li class="page-item disabled">
            <span class="page-link">
              <i class="fas fa-chevron-left"></i>
            </span>
          </li>
        {% endif %}

        {# 页码 #}
        {% for page_num in pagination.iter_pages(left_edge=1, right_edge=1, left_current=2, right_current=2) %}
          {% if page_num %}
            {% if page_num != pagination.page %}
              <li class="page-item">
                {% if url %}
                  <a class="page-link" href="{{ url }}?page={{ page_num }}{{ fragment }}">{{ page_num }}</a>
                {% elif endpoint %}
                  <a class="page-link" href="{{ url_for(endpoint, page=page_num) }}{{ extra_params }}{{ fragment }}">{{ page_num }}</a>
                {% else %}
                  <a class="page-link" href="?page={{ page_num }}{{ fragment }}">{{ page_num }}</a>
                {% endif %}
              </li>
            {% else %}
              <li class="page-item active">
                <span class="page-link">{{ page_num }}</span>
              </li>
            {% endif %}
          {% else %}
            <li class="page-item disabled">
              <span class="page-link">…</span>
            </li>
          {% endif %}
        {% endfor %}

        {# 下一页 #}
        {% if pagination.has_next %}
          <li class="page-item">
            {% if url %}
              <a class="page-link" href="{{ url }}?page={{ pagination.next_num }}{{ fragment }}">
                <i class="fas fa-chevron-right"></i>
              </a>
            {% elif endpoint %}
              <a class="page-link" href="{{ url_for(endpoint, page=pagination.next_num) }}{{ extra_params }}{{ fragment }}">
                <i class="fas fa-chevron-right"></i>
              </a>
            {% else %}
              <a class="page-link" href="?page={{ pagination.next_num }}{{ fragment }}">
                <i class="fas fa-chevron-right"></i>
              </a>
            {% endif %}
          </li>
        {% else %}
          <li class="page-item disabled">
            <span class="page-link">
              <i class="fas fa-chevron-right"></i>
            </span>
          </li>
        {% endif %}
      </ul>
    </nav>
  {% endif %}
{% endmacro %}

{# 筛选按钮宏 #}
{% macro render_filter_button(text, type="button", color="primary", icon="") %}
  <button type="{{ type }}" class="btn btn-{{ color }} btn-sm">
    {% if icon %}
      <i class="{{ icon }} me-1"></i>
    {% endif %}
    {{ text }}
  </button>
{% endmacro %}

{# 用户徽章宏 - 显示用户真实姓名 #}
{% macro render_user_badge(user, color_class="bg-primary") %}
  {% if user %}
    <span class="badge {{ color_class }} text-white">{{ user.real_name or user.username }}</span>
  {% else %}
    <span class="badge bg-secondary text-white">未指定</span>
  {% endif %}
{% endmacro %}