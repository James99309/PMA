{% extends "base.html" %}
{% from 'macros/ui_helpers.html' import render_project_type, render_owner, render_datetime, render_currency, render_currency_with_symbol, render_quotation_number, render_project_stage, render_status_badge, render_button, render_confirmation_badge %}
{% from 'macros/ui_modals.html' import render_change_owner_modal %}

{% block title %}{{ _('æŠ¥ä»·ç®¡ç†') }} - {{ _('é¡¹ç›®ç®¡ç†ç³»ç»Ÿ') }}{% endblock %}

{% block styles %}
<style>
    /* æ»šåŠ¨æ§åˆ¶æŒ‰é’®æ ·å¼ */
    .scroll-controls {
        position: fixed;
        right: 20px;
        bottom: 20px;
        display: flex;
        flex-direction: column;
        z-index: 1000;
    }
    .scroll-controls button {
        margin-bottom: 5px;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }
    .scroll-controls button:hover {
        background-color: #e9ecef;
    }
    .current-sort {
        color: #0d6efd !important;
        font-weight: 500;
    }
    .table-hover tbody tr:hover {
        background-color: rgba(13, 110, 253, 0.05);
    }
    /* ç§»åŠ¨ç«¯å¡ç‰‡è§†å›¾æ ·å¼ */
    @media (max-width: 991.98px) {
        .card-title {
            font-size: 1.1rem;
        }
        .card-body {
            padding: 0.75rem;
        }
        .btn-group-sm .btn {
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
        }
        .shadow-sm {
            box-shadow: 0 .125rem .25rem rgba(0,0,0,.075)!important;
            border-radius: 0.5rem;
            border: none;
        }
        .fa-phone, .fa-envelope, .fa-user, .fa-clock,
        .fa-building, .fa-yen-sign, .fa-shipping-fast,
        .fa-calendar-plus, .fa-calendar-check {
            width: 16px;
            text-align: center;
        }
    }

    /* é¡¹ç›®æœç´¢ä¸‹æ‹‰èœå•æ ·å¼ */
    #project_dropdown {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: white;
        border: 1px solid #ced4da;
        border-radius: 0.375rem;
        box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
        z-index: 1050;
        display: none;
    }

    #project_dropdown.show {
        display: block;
    }

    #project_dropdown .dropdown-item {
        border: none;
        background: none;
        transition: background-color 0.15s ease-in-out;
    }

    #project_dropdown .dropdown-item:hover,
    #project_dropdown .dropdown-item.active {
        background-color: #f8f9fa;
    }

    #project_dropdown .dropdown-item:focus {
        background-color: #e9ecef;
    }

    #project_dropdown .project-name {
        color: #212529;
    }

    #project_dropdown .project-info {
        color: #6c757d;
        font-size: 0.75rem;
    }

    /* æœç´¢æ¡†å®¹å™¨æ ·å¼ */
    .position-relative {
        position: relative;
    }

    /* æ¸…é™¤æŒ‰é’®æ ·å¼ */
    #clearSearch {
        border-left: none;
    }

    #clearSearch:hover {
        background-color: #f8f9fa;
        border-color: #ced4da;
    }

    /* é¡¹ç›®åç§°é“¾æ¥æ ·å¼ */
    .project-link {
        color: #0d6efd !important;
        text-decoration: none !important;
        transition: color 0.15s ease-in-out;
    }

    .project-link:hover {
        color: #0a58ca !important;
        text-decoration: underline !important;
    }

    /* å®¡æ‰¹å¾½ç« æ ·å¼å·²è¿ç§»åˆ°æ ‡å‡†UIå‡½æ•°ï¼Œä¸å†éœ€è¦è‡ªå®šä¹‰æ ·å¼ */
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row page-title-container">
        <div class="col-12">
            <h1 class="page-title">{{ _('æŠ¥ä»·å•åˆ—è¡¨') }}</h1>
        </div>
    </div>

    <div class="row mb-3">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-8">
                            <div class="position-relative">
                                <div class="input-group">
                                    <input type="text" class="form-control" id="projectSearch" placeholder="{{ _('æœç´¢é¡¹ç›®åç§°æˆ–æˆæƒç¼–å·...') }}" value="{{ project_search or '' }}">
                                    <button class="btn btn-outline-secondary" type="button" id="searchProject">
                                        <i class="fas fa-search"></i>
                                    </button>
                                    <button class="btn btn-outline-secondary" type="button" id="clearSearch" title="{{ _('æ¸…é™¤æœç´¢') }}">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                                <!-- é¡¹ç›®æœç´¢ä¸‹æ‹‰èœå• -->
                                <div id="project_dropdown" class="dropdown-menu" style="width: 100%; max-height: 300px; overflow-y: auto; z-index: 1050;">
                                    <!-- æœç´¢ç»“æœä¼šåŠ¨æ€åŠ è½½åˆ°è¿™é‡Œ -->
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4 text-end">
                            {% if has_permission('quotation', 'create') and current_user.role == 'admin' %}
                            {{ render_button(_('æ‰¹é‡å¯¼å…¥'), '#', color='auxiliary', attrs='id="importQuotationsBtn"') }}
                            {% endif %}
                            {{ render_button(_('åˆ›å»ºæŠ¥ä»·å•'), url_for('quotation.create_quotation'), color='primary') }}
                            {% if has_permission('quotation', 'delete') %}
                            {{ render_button(_('æ‰¹é‡åˆ é™¤'), '#', color='danger', attrs='id="batchDeleteBtn" style="display: none;"') }}
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ç­›é€‰å™¨åŒºåŸŸ -->
    <div class="row mb-3" id="filterRow">
        <div class="col-12">
            <div class="card bg-light border-0">
                <div class="card-body py-2">
                    <div class="d-flex flex-wrap align-items-end gap-3">
                        <!-- è´Ÿè´£äººç­›é€‰ -->
                        <div class="flex-shrink-0">
                            <label class="form-label text-muted small mb-1">è´Ÿè´£äºº</label>
                            <select class="form-select form-select-sm" id="ownerFilter" style="min-width: 120px;">
                                <option value="">å…¨éƒ¨</option>
                                {% for user in available_users %}
                                <option value="{{ user.id }}" {% if owner_filter and owner_filter|int == user.id %}selected{% endif %}>
                                    {{ user.real_name or user.username }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <!-- é¡¹ç›®é˜¶æ®µç­›é€‰ -->
                        <div class="flex-shrink-0">
                            <label class="form-label text-muted small mb-1">é¡¹ç›®é˜¶æ®µ</label>
                            <select class="form-select form-select-sm" id="projectStageFilter" style="min-width: 120px;">
                                <option value="">å…¨éƒ¨</option>
                                {% for option in project_stage_options %}
                                <option value="{{ option.value }}" {% if project_stage_filter == option.value %}selected{% endif %}>
                                    {{ option.label }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <!-- é¡¹ç›®ç±»å‹ç­›é€‰ -->
                        <div class="flex-shrink-0">
                            <label class="form-label text-muted small mb-1">é¡¹ç›®ç±»å‹</label>
                            <select class="form-select form-select-sm" id="projectTypeFilter" style="min-width: 120px;">
                                <option value="">å…¨éƒ¨</option>
                                {% for option in project_type_options %}
                                <option value="{{ option.value }}" {% if project_type_filter == option.value %}selected{% endif %}>
                                    {{ option.label }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <!-- æ¸…ç©ºç­›é€‰æŒ‰é’® -->
                        <div class="flex-shrink-0">
                            {{ render_button('æ¸…ç©ºç­›é€‰', type='button', color='secondary', size='sm', icon='fas fa-times', extra_class='', attrs='id="clearFilters"') }}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ç§»åŠ¨ç«¯å¡ç‰‡è§†å›¾ - ä»…åœ¨å°å±å¹•æ˜¾ç¤º -->
    <div class="d-block d-lg-none mb-4">
        {% if not quotations %}
        <div class="alert alert-info text-center">{{ _('æš‚æ— æŠ¥ä»·å•æ•°æ®') }}</div>
        {% endif %}
        {% for quotation in quotations %}
        <div class="card mb-3 shadow-sm">
            <div class="card-body p-3">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <div class="d-flex align-items-center">
                        <span class="badge bg-info">{{ render_quotation_number(quotation.quotation_number) }}</span>
                        <!-- ä½¿ç”¨æ•°æ®åº“ç¡®è®¤å¾½ç« å­—æ®µï¼Œä¸è¯¦æƒ…é¡µé¢ä¿æŒä¸€è‡´ -->
                        {{ render_confirmation_badge(quotation) }}
                    </div>
                    {{ ui.render_status_badge(quotation.project.current_stage|project_stage_label('zh')) if quotation.project.current_stage else ui.render_status_badge(_('æœªè®¾ç½®')) }}
                </div>
                <div class="small mb-1">
                    <i class="fas fa-user text-secondary me-1"></i>{{ render_owner(quotation.owner) }}
                </div>
                <h5 class="card-title mb-2">
                    <a href="{{ url_for('project.view_project', project_id=quotation.project.id) }}" class="text-decoration-none project-link">
                        {{ quotation.project.project_name }}
                    </a>
                </h5>
                <div class="small mb-1">
                    <i class="fas fa-coins text-secondary me-1"></i>æ€»ä»·: {{ render_currency_with_symbol(quotation.amount, quotation.currency) }}
                </div>
                <div class="small mb-1">
                    <i class="fas fa-shipping-fast text-secondary me-1"></i>é˜¶æ®µ: {{ ui.render_status_badge(quotation.project.current_stage|project_stage_label('zh')) if quotation.project.current_stage else ui.render_status_badge('æœªè®¾ç½®') }}
                </div>
                <div class="small text-muted mb-2">
                    <i class="fas fa-building text-secondary me-1"></i>ç±»å‹: {{ render_project_type(quotation.project.project_type) }}
                </div>
                <div class="small text-muted mb-1">
                    <i class="fas fa-calendar-check me-1"></i>æ›´æ–°: {{ render_datetime(quotation.updated_at) }}
                </div>
                <div class="small text-muted">
                    <i class="fas fa-clock text-secondary me-1"></i>åˆ›å»º: {{ render_datetime(quotation.created_at) }}
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    <!-- PCç«¯è¡¨æ ¼è§†å›¾ - ä»…åœ¨å¤§å±å¹•æ˜¾ç¤º -->
    <div class="card d-none d-lg-block">
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-striped table-hover align-middle" style="font-size: 14px;">
                    <thead>
                        <tr class="bg-light text-dark">
                            {% if has_permission('quotation', 'delete') %}
                            <th class="px-3 py-3" style="width: 40px;">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="selectAll">
                                </div>
                            </th>
                            {% endif %}
                            <th class="px-3 py-3" style="min-width: 180px;">
                                <a href="{{ url_for('quotation.list_quotations', sort='quotation_number', order='asc' if sort_field == 'quotation_number' and sort_order == 'desc' else 'desc', project=project_search or '') }}" class="text-dark d-flex align-items-center {{ 'current-sort' if sort_field == 'quotation_number' }}">
                                    {{ _('æŠ¥ä»·ç¼–å·') }}
                                    {% if sort_field == 'quotation_number' %}
                                    <i class="fas fa-sort-{{ 'down' if sort_order == 'desc' else 'up' }} ms-1"></i>
                                    {% else %}
                                    <i class="fas fa-sort ms-1 text-muted"></i>
                                    {% endif %}
                                </a>
                            </th>
                            <th class="px-3" style="min-width: 100px;">
                                <a href="{{ url_for('quotation.list_quotations', sort='owner', order='asc' if sort_field == 'owner' and sort_order == 'desc' else 'desc', project=project_search or '') }}" class="text-dark d-flex align-items-center {{ 'current-sort' if sort_field == 'owner' }}">
                                    {{ _('æ‹¥æœ‰äºº') }}
                                    {% if sort_field == 'owner' %}
                                    <i class="fas fa-sort-{{ 'down' if sort_order == 'desc' else 'up' }} ms-1"></i>
                                    {% else %}
                                    <i class="fas fa-sort ms-1 text-muted"></i>
                                    {% endif %}
                                </a>
                            </th>
                            <th class="px-3" style="min-width: 200px;">
                                <a href="{{ url_for('quotation.list_quotations', sort='project_name', order='asc' if sort_field == 'project_name' and sort_order == 'desc' else 'desc', project=project_search or '') }}" class="text-dark d-flex align-items-center {{ 'current-sort' if sort_field == 'project_name' }}">
                                    {{ _('å…³è”é¡¹ç›®') }}
                                    {% if sort_field == 'project_name' %}
                                    <i class="fas fa-sort-{{ 'down' if sort_order == 'desc' else 'up' }} ms-1"></i>
                                    {% else %}
                                    <i class="fas fa-sort ms-1 text-muted"></i>
                                    {% endif %}
                                </a>
                            </th>
                            <th class="px-3" style="min-width: 120px;">
                                <a href="{{ url_for('quotation.list_quotations', sort='amount', order='asc' if sort_field == 'amount' and sort_order == 'desc' else 'desc', project=project_search or '') }}" class="text-dark d-flex align-items-center {{ 'current-sort' if sort_field == 'amount' }}">
                                    {{ _('æ€»ä»·') }}
                                    {% if sort_field == 'amount' %}
                                    <i class="fas fa-sort-{{ 'down' if sort_order == 'desc' else 'up' }} ms-1"></i>
                                    {% else %}
                                    <i class="fas fa-sort ms-1 text-muted"></i>
                                    {% endif %}
                                </a>
                            </th>
                            <th class="px-3" style="min-width: 120px;">
                                <a href="{{ url_for('quotation.list_quotations', sort='project_stage', order='asc' if sort_field == 'project_stage' and sort_order == 'desc' else 'desc', project=project_search or '') }}" class="text-dark d-flex align-items-center {{ 'current-sort' if sort_field == 'project_stage' }}">
                                    {{ _('é¡¹ç›®é˜¶æ®µ') }}
                                    {% if sort_field == 'project_stage' %}
                                    <i class="fas fa-sort-{{ 'down' if sort_order == 'desc' else 'up' }} ms-1"></i>
                                    {% else %}
                                    <i class="fas fa-sort ms-1 text-muted"></i>
                                    {% endif %}
                                </a>
                            </th>
                            <th class="px-3" style="min-width: 120px;">
                                <a href="{{ url_for('quotation.list_quotations', sort='project_type', order='asc' if sort_field == 'project_type' and sort_order == 'desc' else 'desc', project=project_search or '') }}" class="text-dark d-flex align-items-center {{ 'current-sort' if sort_field == 'project_type' }}">
                                    {{ _('é¡¹ç›®ç±»å‹') }}
                                    {% if sort_field == 'project_type' %}
                                    <i class="fas fa-sort-{{ 'down' if sort_order == 'desc' else 'up' }} ms-1"></i>
                                    {% else %}
                                    <i class="fas fa-sort ms-1 text-muted"></i>
                                    {% endif %}
                                </a>
                            </th>
                            <th class="px-3" style="min-width: 120px;">
                                <a href="{{ url_for('quotation.list_quotations', sort='updated_at', order='asc' if sort_field == 'updated_at' and sort_order == 'desc' else 'desc', project=project_search or '') }}" class="text-dark d-flex align-items-center {{ 'current-sort' if sort_field == 'updated_at' }}">
                                    {{ _('æ›´æ–°æ—¶é—´') }}
                                    {% if sort_field == 'updated_at' %}
                                    <i class="fas fa-sort-{{ 'down' if sort_order == 'desc' else 'up' }} ms-1"></i>
                                    {% else %}
                                    <i class="fas fa-sort ms-1 text-muted"></i>
                                    {% endif %}
                                </a>
                            </th>
                            <th class="px-3" style="min-width: 120px;">
                                <a href="{{ url_for('quotation.list_quotations', sort='created_at', order='asc' if sort_field == 'created_at' and sort_order == 'desc' else 'desc', project=project_search or '') }}" class="text-dark d-flex align-items-center {{ 'current-sort' if sort_field == 'created_at' }}">
                                    {{ _('åˆ›å»ºæ—¶é—´') }}
                                    {% if sort_field == 'created_at' %}
                                    <i class="fas fa-sort-{{ 'down' if sort_order == 'desc' else 'up' }} ms-1"></i>
                                    {% else %}
                                    <i class="fas fa-sort ms-1 text-muted"></i>
                                    {% endif %}
                                </a>
                            </th>
                        </tr>
                    </thead>
                    <tbody id="quotationTableBody">
                        {% include 'quotation/quotation_rows.html' %}
                        
                        <!-- ç©ºæ•°æ®è¡Œ -->
                        <tr id="emptyDataRow" class="{% if quotations %}d-none{% endif %}">
                            <td colspan="9" class="text-center py-4 text-muted">
                                <i class="fas fa-inbox fa-3x mb-3 d-block text-secondary opacity-50"></i>
                                <h5>æš‚æ— æŠ¥ä»·å•æ•°æ®</h5>
                                <p class="mb-0">å°è¯•è°ƒæ•´ç­›é€‰æ¡ä»¶æˆ–åˆ›å»ºæ–°çš„æŠ¥ä»·å•</p>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <!-- æ»šåŠ¨åŠ è½½æŒ‡ç¤ºå™¨ -->
    <div id="loadingIndicator" class="text-center py-3 d-none">
        <div class="spinner-border spinner-border-sm text-primary" role="status">
            <span class="visually-hidden">åŠ è½½ä¸­...</span>
        </div>
        <span class="ms-2 text-muted">æ­£åœ¨åŠ è½½æ›´å¤šæ•°æ®...</span>
    </div>
    
    <!-- æ²¡æœ‰æ›´å¤šæ•°æ®æç¤º -->
    <div id="noMoreData" class="text-center py-3 text-muted d-none">
        <i class="fas fa-check-circle me-1"></i>
        å·²åŠ è½½æ‰€æœ‰æ•°æ®
    </div>
</div>

<!-- æ·»åŠ æ»šåŠ¨æ§åˆ¶æŒ‰é’® -->
<div class="scroll-controls">
    <button type="button" class="btn btn-sm btn-light scroll-top" title="æ»šåŠ¨åˆ°é¡¶éƒ¨">
        <i class="fas fa-chevron-up"></i>
                                    </button>
    <button type="button" class="btn btn-sm btn-light scroll-bottom" title="æ»šåŠ¨åˆ°åº•éƒ¨">
        <i class="fas fa-chevron-down"></i>
    </button>
                                </div>

<!-- æ‰¹é‡å¯¼å…¥æŠ¥ä»·å•æ¨¡æ€çª—å£ -->
<div class="modal fade" id="importQuotationModal" tabindex="-1" aria-labelledby="importQuotationModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="importQuotationModalLabel">æ‰¹é‡å¯¼å…¥æŠ¥ä»·å•</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="å…³é—­"></button>
            </div>
            <div class="modal-body">
                <form id="importQuotationForm" enctype="multipart/form-data">
                    <div class="mb-3">
                        <label for="ownerSelect" class="form-label">è¯·é€‰æ‹©å½’å±è´¦æˆ·</label>
                        <select class="form-select" id="ownerSelect" name="owner_id">
                            <option value="">è¯·é€‰æ‹©å½’å±è´¦æˆ·</option>
                            <!-- é€‰é¡¹ä¼šé€šè¿‡JavaScriptåŠ¨æ€åŠ è½½ -->
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="quotationExcelFile" class="form-label">ä¸Šä¼ Excelæ–‡ä»¶ (.xlsxæˆ–.xls) <span class="text-danger">*</span></label>
                        <input class="form-control" type="file" id="quotationExcelFile" name="quotationExcelFile" accept=".xlsx, .xls" required>
                        <div class="form-text">è¯·ä¸Šä¼ åŒ…å«æŠ¥ä»·å•æ•°æ®çš„Excelæ–‡ä»¶ï¼Œç³»ç»Ÿå°†æ ¹æ®é¡¹ç›®åç§°è‡ªåŠ¨åˆ†ç»„ç”ŸæˆæŠ¥ä»·å•åŠæ˜ç»†</div>
                        <div class="mt-2">
                            <a class="small text-primary" data-bs-toggle="collapse" href="#excelFormatHelp" role="button">
                                <i class="fas fa-info-circle"></i> æŸ¥çœ‹Excelæ ¼å¼è¦æ±‚
                            </a>
                            <div class="collapse mt-2" id="excelFormatHelp">
                                <div class="card card-body bg-light">
                                    <p class="mb-1 fw-bold">Excelè¡¨æ ¼å¿…é¡»åŒ…å«ä»¥ä¸‹åˆ—ï¼š</p>
                                    <ul class="mb-2">
                                        <li><span class="text-danger fw-bold">é¡¹ç›®åç§°</span> - å¿…å¡«ï¼Œå°†æŒ‰æ­¤å­—æ®µåˆ†ç»„ä¸ºä¸åŒæŠ¥ä»·å•</li>
                                        <li><span class="fw-bold">äº§å“åç§°</span> - ä½œä¸ºæŠ¥ä»·å•æ˜ç»†é¡¹</li>
                                        <li><span class="fw-bold">å‹å·</span> - äº§å“å‹å·</li>
                                        <li><span class="fw-bold">å•ä»·</span> - äº§å“å•ä»·</li>
                                        <li><span class="fw-bold">åˆè®¡</span> - äº§å“æ€»ä»·</li>
                                    </ul>
                                    <p class="mb-1 small">æ³¨æ„ï¼šè¡¨å¤´åç§°å¿…é¡»ä¸ä¸Šè¿°åç§°å®Œå…¨ä¸€è‡´ï¼ŒåŒ…æ‹¬ä¸­æ–‡å­—ç¬¦</p>
                                    <p class="mb-1 small">å¦‚æœè§£æå‡ºé”™ï¼Œè¯·æ£€æŸ¥Excelè¡¨å¤´æ˜¯å¦åŒ…å«å¤šä½™çš„ç©ºæ ¼æˆ–ç‰¹æ®Šå­—ç¬¦</p>
                                    <p class="mb-2 small text-danger">é‡è¦ï¼šExcelè¡¨æ ¼çš„ç¬¬ä¸€è¡Œå¿…é¡»æ˜¯è¡¨å¤´è¡Œï¼Œä¸èƒ½åŒ…å«åˆå¹¶å•å…ƒæ ¼</p>
                                    <div class="alert alert-info small p-2 mb-2">
                                        <p class="mb-1 fw-bold"><i class="fas fa-info-circle"></i> å¯¼å…¥æç¤ºï¼š</p>
                                        <ul class="mb-0 ps-3">
                                            <li>å¦‚æœæ‚¨çš„æ–‡ä»¶å‡ºç°<code>__EMPTY</code>ç±»å‹çš„åˆ—ï¼Œè¯´æ˜Excelè¡¨å¤´æ ¼å¼å¼‚å¸¸</li>
                                            <li>ç³»ç»Ÿä¼šå°è¯•æ™ºèƒ½è¯†åˆ«åˆ—åï¼Œä½†å»ºè®®ä½¿ç”¨ä¸‹æ–¹çš„æ ‡å‡†æ¨¡æ¿</li>
                                            <li>ä»å…¶ä»–ç³»ç»Ÿå¯¼å‡ºçš„Excelå¯èƒ½éœ€è¦è°ƒæ•´æ ¼å¼åå†å¯¼å…¥</li>
                                            <li>å¦‚é‡é—®é¢˜ï¼Œè¯·å…ˆä¸‹è½½å¹¶ä½¿ç”¨æˆ‘ä»¬æä¾›çš„æ ‡å‡†æ¨¡æ¿</li>
                                        </ul>
                                    </div>
                                    <button type="button" class="btn btn-sm btn-outline-primary mt-2" id="downloadTemplateBtn">
                                        <i class="fas fa-download"></i> ä¸‹è½½Excelæ¨¡æ¿
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- è¿›åº¦æ¡åŒºåŸŸ -->
                    <div id="importProgress" class="mt-4" style="display: none;">
                        <h6>æ­£åœ¨å¤„ç†æ•°æ®...</h6>
                        <div class="progress">
                            <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%"></div>
                        </div>
                    </div>
                    
                    <!-- é¢„è§ˆåŒºåŸŸ -->
                    <div id="importPreview" class="mt-4" style="display: none;">
                        <h6>æŠ¥ä»·å•å¯¼å…¥é¢„è§ˆ</h6>
                        <div class="table-responsive">
                            <table class="table table-sm table-bordered table-hover">
                                <thead class="table-light">
                                    <tr>
                                        <th>æŠ¥ä»·å•ç¼–å·</th>
                                        <th>é¡¹ç›®åç§°</th>
                                        <th>é˜¶æ®µçŠ¶æ€</th>
                                        <th>æ€»ä»·</th>
                                        <th>æ˜ç»†æ•°é‡</th>
                        </tr>
                                </thead>
                                <tbody id="previewTableBody">
                                    <!-- é¢„è§ˆæ•°æ®ä¼šåŠ¨æ€åŠ è½½ -->
                    </tbody>
                </table>
                            <div id="previewMore" class="text-center mt-2" style="display: none;">
                                <p class="text-muted">è¿˜æœ‰æ›´å¤šæŠ¥ä»·å•æœªæ˜¾ç¤º...</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- å†²çªåŒºåŸŸ -->
                    <div id="importConflicts" class="mt-4" style="display: none;">
                        <h6>å­˜åœ¨é¡¹ç›®å†²çª</h6>
                        <p>ä»¥ä¸‹æŠ¥ä»·å•ä¸ç³»ç»Ÿä¸­å·²æœ‰çš„æŠ¥ä»·å•å­˜åœ¨å†²çªã€‚è¯·é€‰æ‹©å¦‚ä½•å¤„ç†è¿™äº›å†²çªï¼š</p>
                        
                        <!-- å†²çªè¯´æ˜ä¿¡æ¯ -->
                        <div id="conflictInfo" class="mb-2"></div>
                        
                        <div class="mb-2">
                            <button type="button" class="btn btn-sm btn-outline-primary" id="ignoreAllConflicts">å…¨éƒ¨å¿½ç•¥</button>
                            <button type="button" class="btn btn-sm btn-outline-primary" id="keepAllConflicts">å…¨éƒ¨æ·»åŠ </button>
                            <button type="button" class="btn btn-sm btn-outline-primary" id="overwriteAllConflicts">å…¨éƒ¨è¦†ç›–</button>
                        </div>
                        
                        <div class="table-responsive">
                            <table class="table table-sm table-bordered table-hover">
                                <thead class="table-light">
                                    <tr>
                                        <th>é¡¹ç›®åç§°</th>
                                        <th>ç°æœ‰æŠ¥ä»·å•</th>
                                        <th>å¯¼å…¥æŠ¥ä»·å•</th>
                                        <th>æ“ä½œ</th>
                                    </tr>
                                </thead>
                                <tbody id="conflictsTableBody">
                                    <!-- å†²çªæ•°æ®ä¼šåŠ¨æ€åŠ è½½ -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <!-- ç»“æœåŒºåŸŸ -->
                    <div id="importResult" class="mt-4" style="display: none;">
                        <div class="alert alert-success">
                            <h6><i class="fas fa-check-circle"></i> å¯¼å…¥å®Œæˆ</h6>
                            <p id="importSummary"></p>
                        </div>
                        
                        <div id="importErrorDetails" class="mt-3" style="display: none;">
                            <h6 class="text-danger">å¯¼å…¥é”™è¯¯è¯¦æƒ…:</h6>
                            <div class="table-responsive" style="max-height: 300px; overflow-y: auto;">
                                <table class="table table-sm table-bordered table-hover">
                                    <thead class="table-light">
                                        <tr>
                                            <th>è¡Œå·</th>
                                            <th>é¡¹ç›®åç§°</th>
                                            <th>é”™è¯¯åŸå› </th>
                                        </tr>
                                    </thead>
                                    <tbody id="errorDetailsTableBody">
                                        <!-- é”™è¯¯è¯¦æƒ…ä¼šåŠ¨æ€åŠ è½½ -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <div class="text-end mt-3">
                            <button type="button" class="btn btn-primary" id="closeImportResultBtn">ç¡®è®¤</button>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                <button type="button" class="btn btn-primary" id="parseExcelBtn">è§£ææ–‡ä»¶</button>
                <button type="button" class="btn btn-success" id="importBtn" style="display: none;">ç¡®è®¤å¯¼å…¥</button>
            </div>
        </div>
    </div>
</div>

<!-- æ‰¹é‡åˆ é™¤ç¡®è®¤æ¨¡æ€çª—å£ -->
<div class="modal fade" id="batchDeleteModal" tabindex="-1" aria-labelledby="batchDeleteModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="batchDeleteModalLabel">ç¡®è®¤æ‰¹é‡åˆ é™¤</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="å…³é—­"></button>
            </div>
            <div class="modal-body">
                <p>æ‚¨ç¡®å®šè¦åˆ é™¤é€‰ä¸­çš„ <span id="selectedCount">0</span> ä¸ªæŠ¥ä»·å•å—ï¼Ÿæ­¤æ“ä½œæ— æ³•æ’¤é”€ã€‚</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                <button type="button" class="btn btn-danger" id="confirmBatchDelete">ç¡®è®¤åˆ é™¤</button>
            </div>
        </div>
    </div>
</div>

<!-- æ·»åŠ Font Awesomeå›¾æ ‡åº“ -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">

<!-- æ·»åŠ è‡ªå®šä¹‰æ ·å¼ -->
<style>
    .table th {
        font-weight: 600;
        white-space: nowrap;
        background-color: #f8f9fa;
        position: sticky;
        top: 0;
        z-index: 2;
        box-shadow: 0 1px 1px rgba(0,0,0,0.1);
    }
    
    .table td {
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: 200px;
        position: relative;
        border-bottom: 1px solid #dee2e6;
        padding: 8px 12px;
        vertical-align: middle;
    }
    
    .table-responsive {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
        position: relative;
        max-height: 65vh; /* è®¾ç½®æœ€å¤§é«˜åº¦ä¸ºè§†å£é«˜åº¦çš„65% */
        overflow-y: auto; /* æ·»åŠ å‚ç›´æ»šåŠ¨ */
        scrollbar-width: thin;
        scroll-behavior: smooth;
    }
    
    .btn-group-sm > .btn {
        padding: .25rem .5rem;
    }

    /* ç§»é™¤å›ºå®šæ“ä½œåˆ—æ ·å¼ */
    /* 
    .table th:last-child,
    .table td:last-child {
        position: sticky;
        right: 0;
        background-color: #fff;
        z-index: 1;
        border-left: 1px solid #dee2e6;
    }

    .table th:last-child {
        background-color: #f8f9fa;
        z-index: 2;
    }

    .table tr:hover td:last-child {
        background-color: #f8f9fa;
    }
    */

    /* è°ƒæ•´å¾½ç« æ ·å¼ */
    .badge {
        font-size: 12px;
        padding: 5px 8px;
    }
    
    /* æ»šåŠ¨æ¡æ ·å¼ç¾åŒ– */
    .table-responsive::-webkit-scrollbar {
        width: 8px;
        height: 8px;
    }

    .table-responsive::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 4px;
    }

    .table-responsive::-webkit-scrollbar-thumb {
        background: #ccc;
        border-radius: 4px;
    }

    .table-responsive::-webkit-scrollbar-thumb:hover {
        background: #999;
    }
    
    /* å¥‡å¶è¡Œé¢œè‰²åŒºåˆ†ï¼Œå¢å¼ºå¯è¯»æ€§ */
    .table-striped > tbody > tr:nth-of-type(odd) > * {
        background-color: rgba(0, 0, 0, 0.02);
    }
    
    /* æ·»åŠ è¡¨æ ¼æ–‘é©¬çº¹æ•ˆæœï¼Œæ¯äº”è¡ŒåŠ å¼ºä¸€æ¬¡ */
    .table-striped > tbody > tr:nth-of-type(10n+5) > * {
        background-color: rgba(0, 0, 0, 0.04);
    }
    
    /* è¡Œç„¦ç‚¹æ•ˆæœ */
    .table tbody tr.highlight-row {
        background-color: rgba(13, 110, 253, 0.08) !important;
        outline: 1px solid rgba(13, 110, 253, 0.3);
        box-shadow: 0 0 5px rgba(13, 110, 253, 0.2);
    }
    
    /* è¡¨æ ¼å®¹å™¨æ ·å¼ */
    .card-body.p-0 {
        margin-bottom: 20px;
    }
    
    /* è¡¨æ ¼ç»“æ„æ ·å¼ */
    .table {
        margin-bottom: 0;
        border-collapse: separate;
        border-spacing: 0;
    }
    
    /* æ»šåŠ¨æ§åˆ¶æŒ‰é’®æ ·å¼ */
    .scroll-controls {
        position: fixed;
        right: 20px;
        bottom: 50px;
        display: flex;
        flex-direction: column;
        gap: 5px;
        z-index: 1000;
        opacity: 0.7;
        transition: opacity 0.3s;
    }

    .scroll-controls:hover {
        opacity: 1;
    }

    .scroll-controls button {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .scroll-controls button:hover {
        background-color: #f0f0f0;
    }
    
    /* æ’åºè¡¨å¤´æ ·å¼ */
    .table th a {
        text-decoration: none;
        color: #333;
        font-weight: 600;
        display: flex;
        align-items: center;
    }
    
    .table th a:hover {
        color: #0d6efd;
    }
    
    .table th a i.text-muted {
        opacity: 0.4;
    }
    
    .table th a:hover i.text-muted {
        opacity: 0.7;
    }
    
    /* å½“å‰æ’åºåˆ—é«˜äº® */
    .table th a.current-sort {
        color: #0d6efd;
    }
    
    /* å‚ç›´åˆ†éš”ç¬¦ */
    .table th a .sort-separator {
        margin: 0 5px;
        color: #ccc;
    }
    
    /* æ‰¹é‡åˆ é™¤æŒ‰é’®è„‰å†²åŠ¨ç”» */
    @keyframes btn-pulse {
        0% {
            transform: scale(1);
            box-shadow: 0 0 0 0 rgba(220, 53, 69, 0.7);
        }
        70% {
            transform: scale(1.05);
            box-shadow: 0 0 0 10px rgba(220, 53, 69, 0);
        }
        100% {
            transform: scale(1);
            box-shadow: 0 0 0 0 rgba(220, 53, 69, 0);
        }
    }
    
    .btn-pulse {
        animation: btn-pulse 1s;
    }
    
    /* æ‰¹é‡åˆ é™¤æŒ‰é’®æ·¡å…¥æ·¡å‡ºæ•ˆæœ */
    #batchDeleteBtn {
        transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
        opacity: 0;
        transform: translateY(5px);
    }
    
    #batchDeleteBtn[style*="display: inline-block"] {
        opacity: 1;
        transform: translateY(0);
        animation: btn-pulse 1s cubic-bezier(0.66, 0, 0, 1);
    }

    @keyframes fadeInRight {
        from {
            opacity: 0;
            transform: translateX(20px);
        }
        to {
            opacity: 1;
            transform: translateX(0);
        }
    }
    
    @keyframes fadeOutRight {
        from {
            opacity: 1;
            transform: translateX(0);
        }
        to {
            opacity: 0;
            transform: translateX(20px);
        }
    }
    
    @keyframes checkbox-pulse {
        0% {
            transform: scale(1);
            box-shadow: 0 0 0 0 rgba(13, 110, 253, 0.7);
        }
        70% {
            transform: scale(1.05);
            box-shadow: 0 0 0 10px rgba(13, 110, 253, 0);
        }
        100% {
            transform: scale(1);
            box-shadow: 0 0 0 0 rgba(13, 110, 253, 0);
        }
    }
    
    .checkbox-pulse {
        animation: checkbox-pulse 1s cubic-bezier(0.66, 0, 0, 1);
    }
</style>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script>
// å…¨å±€å”¯ä¸€å£°æ˜importModal
let importModal = null;
let needReloadAfterImport = false; // æ ‡è®°æ˜¯å¦éœ€è¦åˆ·æ–°é¡µé¢

// è·å–è¡¨æ ¼å®¹å™¨
const tableContainer = document.querySelector('.table-responsive');

// è®°ä½å’Œæ¢å¤æ»šåŠ¨ä½ç½®
if (tableContainer) {
    // å°è¯•ä»sessionStorageæ¢å¤æ»šåŠ¨ä½ç½®
    const savedScrollTop = sessionStorage.getItem('quotationListScrollTop');
    const savedScrollLeft = sessionStorage.getItem('quotationListScrollLeft');
    
    if (savedScrollTop !== null) {
        tableContainer.scrollTop = parseInt(savedScrollTop);
    }
    
    if (savedScrollLeft !== null) {
        tableContainer.scrollLeft = parseInt(savedScrollLeft);
    }
    
    // ä¿å­˜æ»šåŠ¨ä½ç½®
    tableContainer.addEventListener('scroll', function() {
        sessionStorage.setItem('quotationListScrollTop', this.scrollTop);
        sessionStorage.setItem('quotationListScrollLeft', this.scrollLeft);
    });
    
    // æ·»åŠ é”®ç›˜å¯¼èˆªæ”¯æŒ
    document.addEventListener('keydown', function(e) {
        // åªæœ‰å½“è¡¨æ ¼åŒºåŸŸå¯è§æ—¶æ‰å“åº”é”®ç›˜äº‹ä»¶
        if (isElementInViewport(tableContainer)) {
            // Homeé”® - æ»šåŠ¨åˆ°é¡¶éƒ¨
            if (e.key === 'Home') {
                tableContainer.scrollTop = 0;
                e.preventDefault();
            }
            // Endé”® - æ»šåŠ¨åˆ°åº•éƒ¨
            else if (e.key === 'End') {
                tableContainer.scrollTop = tableContainer.scrollHeight;
                e.preventDefault();
            }
            // Page Upé”® - å‘ä¸Šç¿»é¡µ
            else if (e.key === 'PageUp') {
                tableContainer.scrollTop -= tableContainer.clientHeight;
                e.preventDefault();
            }
            // Page Downé”® - å‘ä¸‹ç¿»é¡µ
            else if (e.key === 'PageDown') {
                tableContainer.scrollTop += tableContainer.clientHeight;
                e.preventDefault();
            }
        }
    });
}

// æ£€æŸ¥å…ƒç´ æ˜¯å¦åœ¨è§†å£ä¸­
function isElementInViewport(el) {
    const rect = el.getBoundingClientRect();
    return (
        rect.top >= 0 &&
        rect.left >= 0 &&
        rect.bottom <= (window.innerHeight || document.documentElement.clientHeight) &&
        rect.right <= (window.innerWidth || document.documentElement.clientWidth)
    );
}

// å¤„ç†æ»šåŠ¨æ§åˆ¶æŒ‰é’®
const scrollTopBtn = document.querySelector('.scroll-top');
const scrollBottomBtn = document.querySelector('.scroll-bottom');

if (scrollTopBtn && tableContainer) {
    scrollTopBtn.addEventListener('click', function() {
        tableContainer.scrollTop = 0;
    });
}

if (scrollBottomBtn && tableContainer) {
    scrollBottomBtn.addEventListener('click', function() {
        tableContainer.scrollTop = tableContainer.scrollHeight;
    });
}

// æ ¹æ®æ»šåŠ¨ä½ç½®æ˜¾ç¤º/éšè—æ»šåŠ¨æŒ‰é’®
const scrollControls = document.querySelector('.scroll-controls');
if (scrollControls && tableContainer) {
    // åˆå§‹éšè—
    if (tableContainer.scrollHeight <= tableContainer.clientHeight) {
        scrollControls.style.display = 'none';
    }
    
    // ç›‘å¬è¡¨æ ¼å®¹å™¨çš„æ»šåŠ¨äº‹ä»¶
    tableContainer.addEventListener('scroll', function() {
        // å¦‚æœè¡¨æ ¼å†…å®¹ä¸éœ€è¦æ»šåŠ¨ï¼Œåˆ™éšè—æ§åˆ¶æŒ‰é’®
        if (tableContainer.scrollHeight <= tableContainer.clientHeight) {
            scrollControls.style.display = 'none';
            return;
        }
        
        // å¦åˆ™æ˜¾ç¤ºæ§åˆ¶æŒ‰é’®
        scrollControls.style.display = 'flex';
    });
    
    // ç›‘å¬çª—å£å¤§å°å˜åŒ–
    window.addEventListener('resize', function() {
        if (tableContainer.scrollHeight <= tableContainer.clientHeight) {
            scrollControls.style.display = 'none';
        } else {
            scrollControls.style.display = 'flex';
        }
    });
}

// æ·»åŠ è¡Œæ»šåŠ¨ç„¦ç‚¹æ•ˆæœ
if (tableContainer) {
    const rows = document.querySelectorAll('.table tbody tr');
    let lastHighlightedRow = null;
    
    // é¼ æ ‡æ»‘è¿‡è¡Œæ—¶æ·»åŠ é«˜äº®
    rows.forEach(row => {
        row.addEventListener('mouseenter', function() {
            if (lastHighlightedRow) {
                lastHighlightedRow.classList.remove('highlight-row');
            }
            this.classList.add('highlight-row');
            lastHighlightedRow = this;
        });
    });
    
    // é¼ æ ‡ç¦»å¼€è¡¨æ ¼åŒºåŸŸæ—¶ç§»é™¤é«˜äº®
    tableContainer.addEventListener('mouseleave', function() {
        if (lastHighlightedRow) {
            lastHighlightedRow.classList.remove('highlight-row');
            lastHighlightedRow = null;
        }
    });
    
    // æ»šåŠ¨æ—¶è®¡ç®—å¯è§è¡Œå¹¶é«˜äº®ä¸­å¿ƒè¡Œ
    tableContainer.addEventListener('scroll', function() {
        // èŠ‚æµæ»šåŠ¨äº‹ä»¶å¤„ç†ï¼Œé¿å…æ€§èƒ½é—®é¢˜
        if (window.scrollThrottled) return;
        window.scrollThrottled = true;
        
        setTimeout(() => {
            highlightCenterRow();
            window.scrollThrottled = false;
        }, 100);
    });
    
    // é«˜äº®ä¸­å¿ƒè¡Œå‡½æ•°
    function highlightCenterRow() {
        if (rows.length === 0) return;
        
        const containerRect = tableContainer.getBoundingClientRect();
        const containerMiddle = containerRect.top + containerRect.height / 2;
        
        let closestRow = null;
        let minDistance = Infinity;
        
        // æ‰¾å‡ºæœ€é è¿‘ä¸­å¿ƒçš„è¡Œ
        rows.forEach(row => {
            const rowRect = row.getBoundingClientRect();
            const rowMiddle = rowRect.top + rowRect.height / 2;
            const distance = Math.abs(rowMiddle - containerMiddle);
            
            // åªè€ƒè™‘å¯è§è¡Œ
            if (rowRect.top <= containerRect.bottom && 
                rowRect.bottom >= containerRect.top) {
                if (distance < minDistance) {
                    minDistance = distance;
                    closestRow = row;
                }
            }
        });
        
        // æ›´æ–°é«˜äº®
        if (closestRow && closestRow !== lastHighlightedRow) {
            if (lastHighlightedRow) {
                lastHighlightedRow.classList.remove('highlight-row');
            }
            closestRow.classList.add('highlight-row');
            lastHighlightedRow = closestRow;
        }
    }
}

// æ¸²æŸ“æˆæƒç¼–å·å¾½ç« ï¼ˆæ¨¡æ‹Ÿå®å‡½æ•°ï¼‰
function renderAuthorizationCodeBadge(code, projectType) {
    if (!code) {
        return '<span class="badge rounded-pill" style="background-color: #6c757d; color: #fff; font-family: \'Helvetica Neue\', sans-serif; font-size: 0.75rem; padding: 0.35em 0.85em;">æ— </span>';
    }
    
    let bgColor = '#6c757d'; // é»˜è®¤ç°è‰²
    
    // æ ¹æ®é¡¹ç›®ç±»å‹æˆ–ç¼–å·å‰ç¼€ç¡®å®šé¢œè‰²
    if (code.startsWith('CPJ') || projectType === 'æ¸ é“è·Ÿè¿›') {
        bgColor = '#5bc0de';
    } else if (code.startsWith('SPJ') || projectType === 'é”€å”®é‡ç‚¹') {
        bgColor = '#0B6EFD';
    } else if (code.startsWith('APJ') || projectType === 'ä¸šåŠ¡æœºä¼š') {
        bgColor = '#198754';
    }
    
    return `<span class="badge rounded-pill" style="font-family: 'Helvetica Neue', sans-serif; font-size: 0.75rem; padding: 0.35em 0.85em; background-color: ${bgColor}; color: #fff;">${code}</span>`;
}

// æ¸²æŸ“è´Ÿè´£äººå¾½ç« ï¼ˆæ¨¡æ‹Ÿå®å‡½æ•°ï¼‰
function renderOwnerBadge(ownerName, companyName = null, isVendorUser = false) {
    if (!ownerName) {
        return '<span class="badge bg-secondary">æœªçŸ¥</span>';
    }
    
    // å¦‚æœæ˜¯å‚å•†è´¦æˆ·ï¼Œä½¿ç”¨èƒ¶å›Šé€ å‹å¾½ç« 
    if (isVendorUser) {
        return `<span class="badge bg-primary rounded-pill">${ownerName}</span>`;
    } else {
        // éå‚å•†è´¦æˆ·ä½¿ç”¨é»˜è®¤é€ å‹å¾½ç« 
        return `<span class="badge bg-secondary">${ownerName}</span>`;
    }
}

// åˆå§‹åŒ–é¡¹ç›®æœç´¢è‡ªåŠ¨å®ŒæˆåŠŸèƒ½
function initProjectAutocomplete() {
    let searchTimeout;
    
    // é¡¹ç›®æœç´¢è¾“å…¥æ¡†äº‹ä»¶
    $('#projectSearch').on('input', function() {
        const query = $(this).val().trim();
        
        // æ¸…é™¤ä¹‹å‰çš„æœç´¢å®šæ—¶å™¨
        clearTimeout(searchTimeout);
        
        // å¦‚æœè¾“å…¥ä¸ºç©ºï¼Œéšè—ä¸‹æ‹‰èœå•
        if (query.length === 0) {
            hideProjectDropdown();
            return;
        }
        
        // è®¾ç½®æœç´¢å»¶è¿Ÿï¼Œé¿å…é¢‘ç¹è¯·æ±‚
        searchTimeout = setTimeout(() => {
            searchProjects(query);
        }, 300);
    });
    
    // é¡¹ç›®æœç´¢æ¡†è·å¾—ç„¦ç‚¹æ—¶
    $('#projectSearch').on('focus', function() {
        const query = $(this).val().trim();
        if (query.length > 0) {
            searchProjects(query);
        }
    });
    
    // é¡¹ç›®æœç´¢æ¡†å¤±å»ç„¦ç‚¹æ—¶ï¼ˆå»¶è¿Ÿéšè—ï¼Œå…è®¸ç‚¹å‡»ä¸‹æ‹‰é¡¹ï¼‰
    $('#projectSearch').on('blur', function() {
        setTimeout(() => {
            hideProjectDropdown();
        }, 200);
    });
    
    // æ¸…é™¤æœç´¢å¤„ç†å‡½æ•°
    function handleClearSearch() {
        console.log('ğŸ§¹ æ¸…é™¤æœç´¢æ¡ä»¶...');
        
        // æ¸…é™¤æœç´¢æ¡†å†…å®¹
        if (document.getElementById('projectSearch')) {
            document.getElementById('projectSearch').value = '';
        }
        hideProjectDropdown();
        
        // é‡ç½®æ»šåŠ¨çŠ¶æ€
        sessionStorage.removeItem('quotationListScrollTop');
        sessionStorage.removeItem('quotationListScrollLeft');
        
        // è·å–å½“å‰URLå‚æ•°
        const params = new URLSearchParams(window.location.search);
        
        // æ¸…é™¤æœç´¢å‚æ•°
        params.delete('project');
        params.delete('offset'); // é‡ç½®åˆ†é¡µ
        
        // æ„å»ºæ–°çš„URL
        const newUrl = `${window.location.pathname}?${params.toString()}`;
        console.log('ğŸš€ æ¸…é™¤æœç´¢åè·³è½¬åˆ°:', newUrl);
        window.location.href = newUrl;
    }
    
    // æ¸…é™¤æœç´¢æŒ‰é’® - ç»Ÿä¸€å‡½æ•°é£æ ¼
    const clearSearchBtn = document.getElementById('clearSearch');
    if (clearSearchBtn) {
        clearSearchBtn.addEventListener('click', handleClearSearch);
        console.log('âœ… æ¸…é™¤æœç´¢æŒ‰é’®äº‹ä»¶å·²ç»‘å®š');
    } else {
        console.log('âŒ æ— æ³•ç»‘å®šæ¸…é™¤æœç´¢æŒ‰é’®äº‹ä»¶ - å…ƒç´ ä¸å­˜åœ¨');
    }
    
    // é”®ç›˜å¯¼èˆªæ”¯æŒ
    $('#projectSearch').on('keydown', function(e) {
        const $dropdown = $('#project_dropdown');
        const $items = $dropdown.find('.dropdown-item');
        
        if (!$dropdown.hasClass('show') || $items.length === 0) {
            return;
        }
        
        let $current = $items.filter('.active');
        let index = $current.length > 0 ? $items.index($current) : -1;
        
        switch(e.keyCode) {
            case 38: // ä¸Šç®­å¤´
                e.preventDefault();
                index = index > 0 ? index - 1 : $items.length - 1;
                break;
            case 40: // ä¸‹ç®­å¤´
                e.preventDefault();
                index = index < $items.length - 1 ? index + 1 : 0;
                break;
            case 13: // å›è½¦
                e.preventDefault();
                if (index >= 0) {
                    $items.eq(index).click();
                } else {
                    // å¦‚æœæ²¡æœ‰é€‰ä¸­é¡¹ï¼Œæ‰§è¡Œæœç´¢
                    performSearch();
                }
                return;
            case 27: // ESC
                e.preventDefault();
                hideProjectDropdown();
                return;
            default:
                return;
        }
        
        // æ›´æ–°é€‰ä¸­çŠ¶æ€
        $items.removeClass('active');
        $items.eq(index).addClass('active');
    });
}

// æœç´¢é¡¹ç›®
function searchProjects(query) {
    if (query.length < 1) {
        $('#project_dropdown').removeClass('show');
        return;
    }
    
    // ä½¿ç”¨æŠ¥ä»·å•æœç´¢ç«¯ç‚¹ï¼Œç›´æ¥æœç´¢æŠ¥ä»·å•
    $.ajax({
        url: '/api/v1/search/quotations',
        method: 'GET',
        data: {
            q: query,
            limit: 10
        },
        success: function(response) {
            console.log('æœç´¢å“åº”:', response);
            if (response.success && response.data) {
                showQuotationDropdown(response.data);
            } else {
                showQuotationDropdown([]);
            }
        },
        error: function(xhr, status, error) {
            console.error('æœç´¢æŠ¥ä»·å•å¤±è´¥:', error);
            showQuotationDropdown([]);
        }
    });
}

// æ˜¾ç¤ºæŠ¥ä»·å•ä¸‹æ‹‰èœå•
function showQuotationDropdown(quotations) {
    const $dropdown = $('#project_dropdown');
    $dropdown.empty();
    
    if (quotations.length === 0) {
        $dropdown.append('<div class="dropdown-item-text text-muted">æœªæ‰¾åˆ°ç›¸å…³æŠ¥ä»·å•</div>');
    } else {
        quotations.forEach(function(quotation) {
            const $item = $('<a href="#" class="dropdown-item"></a>');
            
            // æ„å»ºæ˜¾ç¤ºå†…å®¹ - åªæ˜¾ç¤ºé¡¹ç›®åç§°å’Œé‡‘é¢ï¼Œé¡¹ç›®åç§°å­—ä½“ç¼©å°2å·ä¸”ä¸åŠ ç²—
            let displayHtml = `
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <div style="font-size: 0.875rem;">${quotation.project_name}</div>
                    </div>
                    <div class="text-end">
                        <small class="text-success fw-bold">
                            Â¥${quotation.amount ? quotation.amount.toLocaleString() : '0'}
                        </small>
                    </div>
                </div>
            `;
            
            $item.html(displayHtml);
            $item.data('quotation', quotation);
            
            $item.on('click', function() {
                const selectedQuotation = $(this).data('quotation');
                selectQuotation(selectedQuotation);
                $dropdown.removeClass('show');
            });
            
            $dropdown.append($item);
        });
    }
    
    $dropdown.addClass('show');
}

// éšè—é¡¹ç›®ä¸‹æ‹‰èœå•
function hideProjectDropdown() {
    $('#project_dropdown').removeClass('show');
}

// é€‰æ‹©æŠ¥ä»·å•
function selectQuotation(quotation) {
    console.log('é€‰æ‹©æŠ¥ä»·å•:', quotation);
    
    // æ¸…ç©ºæœç´¢æ¡†
    $('#projectSearch').val('');
    
    // éšè—ä¸‹æ‹‰èœå•
    hideProjectDropdown();
    
    // ç›´æ¥è·³è½¬åˆ°æŠ¥ä»·å•è¯¦æƒ…é¡µé¢
    window.location.href = `{{ url_for('quotation.view_quotation', id=0) }}`.replace('0', quotation.quotation_id);
}


// å…¨å±€å˜é‡
let parsedQuotations = [];
let quotationDetails = {};
let conflicts = [];
let conflictActions = {};
let skippedHeaderRows = 0; // ç”¨äºè®°å½•è¿‡æ»¤æ‰çš„è¡¨å¤´è¡Œæ•°é‡

function copyQuotation(id) {
    if (confirm('ç¡®å®šè¦å¤åˆ¶è¿™ä¸ªæŠ¥ä»·å•å—ï¼Ÿ')) {
        fetch(`/quotation/quotation/${id}/copy`, {
            method: 'POST',
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                window.location.reload();
            } else {
                alert('å¤åˆ¶å¤±è´¥: ' + data.error);
            }
        })
        .catch(error => {
            console.error('å¤åˆ¶æŠ¥ä»·å•æ—¶å‡ºé”™:', error);
            alert('å¤åˆ¶æŠ¥ä»·å•æ—¶å‡ºé”™');
        });
    }
}

function deleteQuotation(id) {
    if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªæŠ¥ä»·å•å—ï¼Ÿ')) {
        fetch(`/quotation/${id}/delete`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
        }).then(response => {
            if (response.ok) {
                window.location.reload();
            } else {
                alert('åˆ é™¤å¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        });
    }
}

// æ‰¹é‡åˆ é™¤åŠŸèƒ½
document.addEventListener('DOMContentLoaded', function() {
    try {
    // åˆå§‹åŒ–é¡¹ç›®æœç´¢è‡ªåŠ¨å®ŒæˆåŠŸèƒ½
    initProjectAutocomplete();
    
    const projectSearch = document.getElementById('projectSearch');
    const searchBtn = document.getElementById('searchProject');
    const batchDeleteBtn = document.getElementById('batchDeleteBtn');
    const selectAllCheckbox = document.getElementById('selectAll');
    const quotationCheckboxes = document.querySelectorAll('.quotation-checkbox');
    const selectedCountSpan = document.getElementById('selectedCount');
    const confirmBatchDeleteBtn = document.getElementById('confirmBatchDelete');
    const batchDeleteModal = new bootstrap.Modal(document.getElementById('batchDeleteModal'));
    
    // ç­›é€‰å™¨å…ƒç´ 
    const ownerFilter = document.getElementById('ownerFilter');
    const projectTypeFilter = document.getElementById('projectTypeFilter');
    const projectStageFilter = document.getElementById('projectStageFilter');
    const clearFiltersBtn = document.getElementById('clearFilters');
    
    // åˆå§‹åŒ–éªŒè¯å‡½æ•°
    function validateQuotationListElements() {
        console.log('=== æŠ¥ä»·å•åˆ—è¡¨å…ƒç´ éªŒè¯ ===');
        console.log('å½“å‰ç”¨æˆ·:', '{{ current_user.username }}', 'è§’è‰²:', '{{ current_user.role }}');
        
        const elements = {
            projectSearch: projectSearch,
            searchBtn: searchBtn,
            clearSearchBtn: document.getElementById('clearSearch'),
            batchDeleteBtn: batchDeleteBtn,
            confirmBatchDeleteBtn: confirmBatchDeleteBtn,
            ownerFilter: ownerFilter,
            projectTypeFilter: projectTypeFilter,
            projectStageFilter: projectStageFilter,
            clearFiltersBtn: clearFiltersBtn
        };
        
        let missingElements = [];
        
        for (const [name, element] of Object.entries(elements)) {
            if (element) {
                console.log(`âœ… ${name}: å·²æ‰¾åˆ°`);
                if (element.options && element.options.length) {
                    console.log(`   - åŒ…å« ${element.options.length} ä¸ªé€‰é¡¹`);
                }
            } else {
                console.log(`âŒ ${name}: æœªæ‰¾åˆ°`);
                missingElements.push(name);
            }
        }
        
        if (missingElements.length > 0) {
            console.warn('âš ï¸ ç¼ºå¤±çš„å…ƒç´ :', missingElements.join(', '));
        } else {
            console.log('ğŸ‰ æ‰€æœ‰å…³é”®å…ƒç´ éƒ½å·²æ­£ç¡®åŠ è½½');
        }
        
        console.log('========================');
        return missingElements.length === 0;
    }
    
    // æ‰§è¡Œåˆå§‹åŒ–éªŒè¯
    const allElementsLoaded = validateQuotationListElements();
    
    // æµ‹è¯•ç­›é€‰åŠŸèƒ½
    function testFilterFunctionality() {
        console.log('ğŸ§ª æµ‹è¯•ç­›é€‰åŠŸèƒ½...');
        
        // æ£€æŸ¥å½“å‰URLå‚æ•°
        const currentParams = new URLSearchParams(window.location.search);
        console.log('å½“å‰URLå‚æ•°:', currentParams.toString());
        
        // æ£€æŸ¥ç­›é€‰å™¨å½“å‰å€¼
        if (ownerFilter) {
            console.log('è´Ÿè´£äººç­›é€‰å™¨å½“å‰å€¼:', ownerFilter.value);
        }
        if (projectTypeFilter) {
            console.log('é¡¹ç›®ç±»å‹ç­›é€‰å™¨å½“å‰å€¼:', projectTypeFilter.value);
        }
        if (projectStageFilter) {
            console.log('é¡¹ç›®é˜¶æ®µç­›é€‰å™¨å½“å‰å€¼:', projectStageFilter.value);
        }
        
        console.log('ç­›é€‰åŠŸèƒ½æµ‹è¯•å®Œæˆ');
    }
    
    // å»¶è¿Ÿæ‰§è¡Œæµ‹è¯•ï¼Œç¡®ä¿é¡µé¢å®Œå…¨åŠ è½½
    setTimeout(testFilterFunctionality, 1000);
    
    // ç»Ÿä¸€å‡½æ•°é£æ ¼æ€»ç»“
    function summarizeEventBindings() {
        console.log('=== äº‹ä»¶ç»‘å®šæ€»ç»“ ===');
        console.log('ğŸ“‹ å·²é‡‡ç”¨ç»Ÿä¸€å‡½æ•°é£æ ¼çš„äº‹ä»¶å¤„ç†å™¨:');
        console.log('  ğŸ” handleProjectSearch - é¡¹ç›®æœç´¢');
        console.log('  âŒ¨ï¸ handleSearchKeyPress - æœç´¢å›è½¦é”®');
        console.log('  ğŸ§¹ handleClearSearch - æ¸…é™¤æœç´¢');
        console.log('  ğŸ“Š handleFilterChange - ç­›é€‰å™¨å˜æ›´');
        console.log('  ğŸ§½ handleClearFilters - æ¸…é™¤ç­›é€‰');
        console.log('  ğŸ—‘ï¸ handleBatchDeleteClick - æ‰¹é‡åˆ é™¤');
        console.log('  âœ… handleConfirmBatchDelete - ç¡®è®¤æ‰¹é‡åˆ é™¤');
        console.log('  ğŸ“‹ handleSelectAllChange - å…¨é€‰å¤é€‰æ¡†');
        console.log('  â˜‘ï¸ handleSingleCheckboxChange - å•ä¸ªå¤é€‰æ¡†');
        console.log('ğŸ‰ æ‰€æœ‰ä¸»è¦æŒ‰é”®éƒ½å·²é‡‡ç”¨ç»Ÿä¸€å‡½æ•°é£æ ¼!');
        console.log('========================');
    }
    
    // å»¶è¿Ÿæ‰§è¡Œæ€»ç»“ï¼Œç¡®ä¿æ‰€æœ‰ç»‘å®šå®Œæˆ
    setTimeout(summarizeEventBindings, 1200);
    
    
    // æ›´æ–°æ‰¹é‡åˆ é™¤æŒ‰é’®æ˜¾ç¤ºçŠ¶æ€çš„å‡½æ•°
    function updateBatchDeleteButtonVisibility() {
        // æ£€æŸ¥æŒ‰é’®æ˜¯å¦å­˜åœ¨ï¼Œé¿å…ç©ºæŒ‡é’ˆé”™è¯¯
        if (!batchDeleteBtn) {
            console.log('âš ï¸ æ‰¹é‡åˆ é™¤æŒ‰é’®ä¸å­˜åœ¨ï¼Œè·³è¿‡çŠ¶æ€æ›´æ–°');
            return;
        }
        
        const checkedCount = document.querySelectorAll('.quotation-checkbox:checked').length;
        
        if (checkedCount > 0) {
            batchDeleteBtn.style.animation = '';
            batchDeleteBtn.style.display = 'inline-block';
            // åªæ˜¾ç¤ºæŒ‰é’®ï¼Œä¸æ˜¾ç¤ºæ•°é‡
            batchDeleteBtn.innerHTML = `<i class="fas fa-trash"></i> æ‰¹é‡åˆ é™¤`;
            // æ›´æ–°æ¨¡æ€æ¡†ä¸­çš„æ•°é‡
            if (selectedCountSpan) {
                selectedCountSpan.textContent = checkedCount;
            }
        } else {
            // ç›´æ¥éšè—æŒ‰é’®ï¼Œä¸ç”¨åŠ¨ç”»å’Œå»¶è¿Ÿ
            batchDeleteBtn.style.display = 'none';
        }
    }
    
    // åˆå§‹åŒ–æ£€æŸ¥æ‰¹é‡åˆ é™¤æŒ‰é’®çŠ¶æ€
    updateBatchDeleteButtonVisibility();
    
    // å…¨é€‰å¤é€‰æ¡†å¤„ç†å‡½æ•°
    function handleSelectAllChange() {
        const isChecked = this.checked;
        
        quotationCheckboxes.forEach(function(checkbox) {
            checkbox.checked = isChecked;
        });
        
        // æ·»åŠ è„‰å†²æ•ˆæœç»™å…¨é€‰
        if (isChecked) {
            this.parentElement.classList.add('checkbox-pulse');
            setTimeout(() => {
                this.parentElement.classList.remove('checkbox-pulse');
            }, 1000);
        }
        
        updateBatchDeleteButtonVisibility();
        console.log('ğŸ“‹ å…¨é€‰çŠ¶æ€å˜æ›´:', isChecked);
    }
    
    // å•ä¸ªå¤é€‰æ¡†å¤„ç†å‡½æ•°
    function handleSingleCheckboxChange() {
        // å¦‚æœå–æ¶ˆå‹¾é€‰ï¼Œæ›´æ–°å…¨é€‰checkbox
        if (!this.checked && selectAllCheckbox && selectAllCheckbox.checked) {
            selectAllCheckbox.checked = false;
        }
        
        // å¦‚æœæ‰€æœ‰å¯é€‰çš„éƒ½è¢«é€‰ä¸­ï¼Œæ›´æ–°å…¨é€‰checkbox
        if (selectAllCheckbox) {
            const allChecked = Array.from(quotationCheckboxes).every(cb => cb.checked);
            selectAllCheckbox.checked = allChecked;
        }
        
        // æ·»åŠ è„‰å†²æ•ˆæœç»™å˜åŒ–çš„å¤é€‰æ¡†
        this.parentElement.classList.add('checkbox-pulse');
        setTimeout(() => {
            this.parentElement.classList.remove('checkbox-pulse');
        }, 1000);
        
        updateBatchDeleteButtonVisibility();
        console.log('â˜‘ï¸ å•ä¸ªå¤é€‰æ¡†çŠ¶æ€å˜æ›´:', this.checked);
    }
    
    // å…¨é€‰checkboxäº‹ä»¶ç»‘å®š - ç»Ÿä¸€å‡½æ•°é£æ ¼
    if (selectAllCheckbox) {
        selectAllCheckbox.addEventListener('change', handleSelectAllChange);
        console.log('âœ… å…¨é€‰å¤é€‰æ¡†äº‹ä»¶å·²ç»‘å®š');
    } else {
        console.log('âŒ æ— æ³•ç»‘å®šå…¨é€‰å¤é€‰æ¡†äº‹ä»¶ - å…ƒç´ ä¸å­˜åœ¨');
    }
    
    // å•ä¸ªcheckboxäº‹ä»¶ç»‘å®š - ç»Ÿä¸€å‡½æ•°é£æ ¼
    quotationCheckboxes.forEach(function(checkbox, index) {
        checkbox.addEventListener('change', handleSingleCheckboxChange);
    });
    if (quotationCheckboxes.length > 0) {
        console.log(`âœ… ${quotationCheckboxes.length}ä¸ªå•ä¸ªå¤é€‰æ¡†äº‹ä»¶å·²ç»‘å®š`);
    } else {
        console.log('âŒ æ— å•ä¸ªå¤é€‰æ¡†å…ƒç´ éœ€è¦ç»‘å®šäº‹ä»¶');
    }
    
    // æ‰§è¡Œé¡¹ç›®æœç´¢å¤„ç†å‡½æ•°
    function handleProjectSearch() {
        console.log('ğŸ” æ‰§è¡Œé¡¹ç›®æœç´¢...');
        
        // é‡ç½®æ»šåŠ¨çŠ¶æ€
        sessionStorage.removeItem('quotationListScrollTop');
        sessionStorage.removeItem('quotationListScrollLeft');
        
        // è·å–å½“å‰URLå‚æ•°
        const params = new URLSearchParams(window.location.search);
        
        // é‡ç½®åˆ†é¡µ
        params.delete('offset');
        
        // è®¾ç½®æœç´¢å‚æ•°
        const searchValue = projectSearch ? projectSearch.value.trim() : '';
        if (searchValue) {
            params.set('project', searchValue);
        } else {
            params.delete('project');
        }
        
        // æ„å»ºæ–°çš„URL
        const newUrl = `${window.location.pathname}?${params.toString()}`;
        console.log('ğŸš€ æœç´¢è·³è½¬åˆ°:', newUrl);
        window.location.href = newUrl;
    }
    
    // å›è½¦é”®æœç´¢å¤„ç†å‡½æ•°
    function handleSearchKeyPress(e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            handleProjectSearch();
        }
    }
    
    // æœç´¢å¤„ç† - ç»Ÿä¸€å‡½æ•°é£æ ¼
    if (searchBtn) {
        searchBtn.addEventListener('click', handleProjectSearch);
        console.log('âœ… æœç´¢æŒ‰é’®äº‹ä»¶å·²ç»‘å®š');
    } else {
        console.log('âŒ æ— æ³•ç»‘å®šæœç´¢æŒ‰é’®äº‹ä»¶ - å…ƒç´ ä¸å­˜åœ¨');
    }
    
    if (projectSearch) {
        projectSearch.addEventListener('keypress', handleSearchKeyPress);
        console.log('âœ… æœç´¢æ¡†å›è½¦é”®äº‹ä»¶å·²ç»‘å®š');
    } else {
        console.log('âŒ æ— æ³•ç»‘å®šæœç´¢æ¡†äº‹ä»¶ - å…ƒç´ ä¸å­˜åœ¨');
    }
    
    // ç­›é€‰åŠŸèƒ½ - å‚è€ƒå®¢æˆ·ç®¡ç†æ¨¡å—è®¾è®¡
    function applyFilters() {
        console.log('ğŸ”„ å¼€å§‹åº”ç”¨ç­›é€‰...');
        
        // é‡ç½®æ»šåŠ¨çŠ¶æ€
        sessionStorage.removeItem('quotationListScrollTop');
        sessionStorage.removeItem('quotationListScrollLeft');
        
        // è·å–å½“å‰URLå‚æ•°
        const params = new URLSearchParams(window.location.search);
        
        // æ¸…é™¤ä¹‹å‰çš„ç­›é€‰å‚æ•°
        params.delete('owner_filter');
        params.delete('project_type_filter');
        params.delete('project_stage_filter');
        params.delete('offset'); // é‡ç½®åˆ†é¡µ
        
        // ä¿ç•™æœç´¢å‚æ•°
        if (projectSearch && projectSearch.value.trim()) {
            params.set('project', projectSearch.value.trim());
            console.log('ä¿ç•™é¡¹ç›®æœç´¢:', projectSearch.value.trim());
        }
        
        // æ·»åŠ æ–°çš„ç­›é€‰å‚æ•°
        if (ownerFilter && ownerFilter.value) {
            params.set('owner_filter', ownerFilter.value);
            console.log('æ·»åŠ è´Ÿè´£äººç­›é€‰:', ownerFilter.value);
        }
        if (projectTypeFilter && projectTypeFilter.value) {
            params.set('project_type_filter', projectTypeFilter.value);
            console.log('æ·»åŠ é¡¹ç›®ç±»å‹ç­›é€‰:', projectTypeFilter.value);
        }
        if (projectStageFilter && projectStageFilter.value) {
            params.set('project_stage_filter', projectStageFilter.value);
            console.log('æ·»åŠ é¡¹ç›®é˜¶æ®µç­›é€‰:', projectStageFilter.value);
        }
        
        // æ„å»ºæ–°çš„URL  
        const newUrl = `${window.location.pathname}?${params.toString()}`;
        console.log('ğŸš€ è·³è½¬åˆ°URL:', newUrl);
        
        // éªŒè¯ç­›é€‰å‚æ•°
        console.log('ğŸ“Š å½“å‰ç­›é€‰çŠ¶æ€:');
        console.log('  è´Ÿè´£äºº:', ownerFilter ? ownerFilter.value : 'N/A');
        console.log('  é¡¹ç›®ç±»å‹:', projectTypeFilter ? projectTypeFilter.value : 'N/A');
        console.log('  é¡¹ç›®é˜¶æ®µ:', projectStageFilter ? projectStageFilter.value : 'N/A');
        
        // è·³è½¬åˆ°æ–°çš„URL
        window.location.href = newUrl;
    }
    
    // ç­›é€‰å™¨å˜æ›´å¤„ç†å‡½æ•°
    function handleFilterChange(filterType, value) {
        console.log(`ğŸ“Š ${filterType}ç­›é€‰å™¨å˜æ›´:`, value);
        applyFilters();
    }
    
    // ç­›é€‰å™¨äº‹ä»¶ç›‘å¬ - ç»Ÿä¸€å‡½æ•°é£æ ¼
    if (ownerFilter) {
        ownerFilter.addEventListener('change', function() {
            handleFilterChange('è´Ÿè´£äºº', this.value);
        });
        console.log('âœ… è´Ÿè´£äººç­›é€‰å™¨äº‹ä»¶å·²ç»‘å®š');
    } else {
        console.log('âŒ æ— æ³•ç»‘å®šè´Ÿè´£äººç­›é€‰å™¨äº‹ä»¶ - å…ƒç´ ä¸å­˜åœ¨');
    }
    
    if (projectTypeFilter) {
        projectTypeFilter.addEventListener('change', function() {
            handleFilterChange('é¡¹ç›®ç±»å‹', this.value);
        });
        console.log('âœ… é¡¹ç›®ç±»å‹ç­›é€‰å™¨äº‹ä»¶å·²ç»‘å®š');
    } else {
        console.log('âŒ æ— æ³•ç»‘å®šé¡¹ç›®ç±»å‹ç­›é€‰å™¨äº‹ä»¶ - å…ƒç´ ä¸å­˜åœ¨');
    }
    
    if (projectStageFilter) {
        projectStageFilter.addEventListener('change', function() {
            handleFilterChange('é¡¹ç›®é˜¶æ®µ', this.value);
        });
        console.log('âœ… é¡¹ç›®é˜¶æ®µç­›é€‰å™¨äº‹ä»¶å·²ç»‘å®š');
    } else {
        console.log('âŒ æ— æ³•ç»‘å®šé¡¹ç›®é˜¶æ®µç­›é€‰å™¨äº‹ä»¶ - å…ƒç´ ä¸å­˜åœ¨');
    }
    
    // æ¸…é™¤ç­›é€‰å¤„ç†å‡½æ•°
    function handleClearFilters() {
        console.log('ğŸ§¹ æ¸…é™¤æ‰€æœ‰ç­›é€‰æ¡ä»¶...');
        
        // é‡ç½®æ»šåŠ¨çŠ¶æ€
        sessionStorage.removeItem('quotationListScrollTop');
        sessionStorage.removeItem('quotationListScrollLeft');
        
        // è·å–å½“å‰URLå‚æ•°
        const params = new URLSearchParams(window.location.search);
        
        // æ¸…é™¤ç­›é€‰å‚æ•°
        params.delete('owner_filter');
        params.delete('project_type_filter');
        params.delete('project_stage_filter');
        params.delete('offset'); // é‡ç½®åˆ†é¡µ
        
        // ä¿ç•™é¡¹ç›®æœç´¢å‚æ•°
        // projectå‚æ•°å¦‚æœå­˜åœ¨åˆ™ä¿ç•™
        
        // æ„å»ºæ–°çš„URL
        const newUrl = `${window.location.pathname}?${params.toString()}`;
        console.log('ğŸš€ æ¸…é™¤ç­›é€‰åè·³è½¬åˆ°:', newUrl);
        window.location.href = newUrl;
    }
    
    // æ¸…é™¤ç­›é€‰æŒ‰é’® - ç»Ÿä¸€å‡½æ•°é£æ ¼
    if (clearFiltersBtn) {
        clearFiltersBtn.addEventListener('click', handleClearFilters);
        console.log('âœ… æ¸…é™¤ç­›é€‰æŒ‰é’®äº‹ä»¶å·²ç»‘å®š');
    } else {
        console.log('âŒ æ— æ³•ç»‘å®šæ¸…é™¤ç­›é€‰æŒ‰é’®äº‹ä»¶ - å…ƒç´ ä¸å­˜åœ¨');
    }
    
    // æ‰¹é‡åˆ é™¤å¤„ç†å‡½æ•°
    function handleBatchDeleteClick() {
        const checkedCount = document.querySelectorAll('.quotation-checkbox:checked').length;
        if (checkedCount > 0) {
            if (selectedCountSpan) {
                selectedCountSpan.textContent = checkedCount;
            }
            batchDeleteModal.show();
        }
    }
    
    // ç¡®è®¤æ‰¹é‡åˆ é™¤å¤„ç†å‡½æ•°
    function handleConfirmBatchDelete() {
        const checkedBoxes = document.querySelectorAll('.quotation-checkbox:checked');
        const quotationIds = Array.from(checkedBoxes).map(cb => cb.value);
        
        if (quotationIds.length === 0) {
            batchDeleteModal.hide();
            return;
        }
        
        console.log('ğŸ—‘ï¸ æ‰§è¡Œæ‰¹é‡åˆ é™¤ï¼ŒIDåˆ—è¡¨:', quotationIds);
        
        // å‘é€æ‰¹é‡åˆ é™¤è¯·æ±‚
        fetch("{{ url_for('quotation.batch_delete_quotations') }}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').content
            },
            body: JSON.stringify({ quotation_ids: quotationIds })
        })
        .then(response => response.json())
        .then(data => {
            batchDeleteModal.hide();
            
            if (data.success) {
                console.log('âœ… æ‰¹é‡åˆ é™¤æˆåŠŸ:', data.message);
                // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
                const alertDiv = document.createElement('div');
                alertDiv.className = 'alert alert-success alert-dismissible fade show';
                alertDiv.innerHTML = `
                    <strong>æˆåŠŸ!</strong> ${data.message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                `;
                document.querySelector('.container-fluid').prepend(alertDiv);
                
                // åˆ·æ–°é¡µé¢æˆ–ç§»é™¤å·²åˆ é™¤çš„è¡Œ
                setTimeout(() => {
                    window.location.reload();
                }, 1500);
            } else {
                console.error('âŒ æ‰¹é‡åˆ é™¤å¤±è´¥:', data.message);
                // æ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯
                const alertDiv = document.createElement('div');
                alertDiv.className = 'alert alert-danger alert-dismissible fade show';
                alertDiv.innerHTML = `
                    <strong>é”™è¯¯!</strong> ${data.message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                `;
                document.querySelector('.container-fluid').prepend(alertDiv);
            }
        })
        .catch(error => {
            console.error('âŒ æ‰¹é‡åˆ é™¤æŠ¥ä»·å•æ—¶å‡ºé”™:', error);
            batchDeleteModal.hide();
            
            // æ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯
            const alertDiv = document.createElement('div');
            alertDiv.className = 'alert alert-danger alert-dismissible fade show';
            alertDiv.innerHTML = `
                <strong>é”™è¯¯!</strong> æ‰¹é‡åˆ é™¤è¯·æ±‚å¤±è´¥
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            `;
            document.querySelector('.container-fluid').prepend(alertDiv);
        });
    }
    
    // æ‰¹é‡åˆ é™¤æŒ‰é’®äº‹ä»¶ç»‘å®š - ç»Ÿä¸€å‡½æ•°é£æ ¼
    if (batchDeleteBtn) {
        batchDeleteBtn.addEventListener('click', handleBatchDeleteClick);
        console.log('âœ… æ‰¹é‡åˆ é™¤æŒ‰é’®äº‹ä»¶å·²ç»‘å®š');
    } else {
        console.log('âŒ æ— æ³•ç»‘å®šæ‰¹é‡åˆ é™¤æŒ‰é’®äº‹ä»¶ - å…ƒç´ ä¸å­˜åœ¨');
    }
    
    // ç¡®è®¤æ‰¹é‡åˆ é™¤æŒ‰é’®äº‹ä»¶ç»‘å®š - ç»Ÿä¸€å‡½æ•°é£æ ¼
    if (confirmBatchDeleteBtn) {
        confirmBatchDeleteBtn.addEventListener('click', handleConfirmBatchDelete);
        console.log('âœ… ç¡®è®¤æ‰¹é‡åˆ é™¤æŒ‰é’®äº‹ä»¶å·²ç»‘å®š');
    } else {
        console.log('âŒ æ— æ³•ç»‘å®šç¡®è®¤æ‰¹é‡åˆ é™¤æŒ‰é’®äº‹ä»¶ - å…ƒç´ ä¸å­˜åœ¨');
    }
} catch (error) {
    console.error('åˆå§‹åŒ–æŠ¥ä»·å•åˆ—è¡¨åŠŸèƒ½æ—¶å‡ºé”™:', error);
}
});

// æŠ¥ä»·å•æ‰¹é‡å¯¼å…¥åŠŸèƒ½
document.addEventListener('DOMContentLoaded', function() {
    const importQuotationsBtn = document.getElementById('importQuotationsBtn');
    const importModal = new bootstrap.Modal(document.getElementById('importQuotationModal'));
    const ownerSelect = document.getElementById('ownerSelect');
    const quotationExcelFile = document.getElementById('quotationExcelFile');
    const parseExcelBtn = document.getElementById('parseExcelBtn');
    const importBtn = document.getElementById('importBtn');
    const previewDiv = document.getElementById('importPreview');
    const conflictsDiv = document.getElementById('importConflicts');
    const progressDiv = document.getElementById('importProgress');
    const resultDiv = document.getElementById('importResult');
    const ignoreAllConflictsBtn = document.getElementById('ignoreAllConflicts');
    const keepAllConflictsBtn = document.getElementById('keepAllConflicts');
    const overwriteAllConflictsBtn = document.getElementById('overwriteAllConflicts');
    
    let parsedQuotations = [];
    let quotationDetails = {};
    let conflicts = [];
    let conflictActions = {};
    
    // æ‰“å¼€å¯¼å…¥æ¨¡æ€æ¡†
    if (importQuotationsBtn) {
        importQuotationsBtn.addEventListener('click', function() {
            // é‡ç½®è¡¨å•å’ŒçŠ¶æ€
            document.getElementById('importQuotationForm').reset();
            importBtn.style.display = 'none';
            previewDiv.style.display = 'none';
            conflictsDiv.style.display = 'none';
            progressDiv.style.display = 'none';
            resultDiv.style.display = 'none';
            document.getElementById('previewTableBody').innerHTML = '';
            document.getElementById('conflictsTableBody').innerHTML = '';
            document.getElementById('errorDetailsTableBody').innerHTML = '';
            
            // è·å–ç”¨æˆ·åˆ—è¡¨ç”¨äºé€‰æ‹©å½’å±è´¦æˆ·
            fetch('/api/accounts/list')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        ownerSelect.innerHTML = '<option value="">è¯·é€‰æ‹©å½’å±è´¦æˆ·</option>';
                        
                        // æŒ‰ä¼ä¸šåˆ†ç»„ç”¨æˆ·
                        const companiesUsers = {};
                        data.users.forEach(user => {
                            if (!companiesUsers[user.company]) {
                                companiesUsers[user.company] = [];
                            }
                            companiesUsers[user.company].push(user);
                        });
                        
                        // åˆ›å»ºé€‰é¡¹ç»„
                        for (const company in companiesUsers) {
                            const optgroup = document.createElement('optgroup');
                            optgroup.label = company;
                            
                            companiesUsers[company].forEach(user => {
                                const option = document.createElement('option');
                                option.value = user.id;
                                option.textContent = user.name;
                                optgroup.appendChild(option);
                            });
                            
                            ownerSelect.appendChild(optgroup);
                        }
                    } else {
                        console.error('è·å–ç”¨æˆ·åˆ—è¡¨å¤±è´¥:', data.message);
                    }
                })
                .catch(error => {
                    console.error('è·å–ç”¨æˆ·åˆ—è¡¨å¤±è´¥:', error);
                });
            
            // æ˜¾ç¤ºæ¨¡æ€æ¡†
            importModal.show();
        });
    }
    
    // è§£æExcelæ–‡ä»¶
    if (parseExcelBtn) {
        parseExcelBtn.addEventListener('click', function() {
            const fileInput = document.getElementById('quotationExcelFile');
            
            if (!fileInput.files.length) {
                alert('è¯·é€‰æ‹©Excelæ–‡ä»¶');
                return;
            }
            
            const file = fileInput.files[0];
            const reader = new FileReader();
            
            resultDiv.style.display = 'none';
            progressDiv.style.display = 'block';
            const progressBar = progressDiv.querySelector('.progress-bar');
            progressBar.style.width = '30%';
            
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    progressBar.style.width = '50%';
                    
                    // è§£æExcelæ–‡ä»¶
                    const workbook = XLSX.read(data, { type: 'array' });
                    
                    // è·å–ç¬¬ä¸€ä¸ªå·¥ä½œè¡¨
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    
                    // å°†å·¥ä½œè¡¨è½¬æ¢ä¸ºJSON
                    // ä½¿ç”¨æ›´å¤šé€‰é¡¹æ¥ç¡®ä¿æ­£ç¡®è§£æ
                    const excelData = XLSX.utils.sheet_to_json(worksheet, { 
                        raw: false, 
                        defval: '',  // ç©ºå•å…ƒæ ¼ä½¿ç”¨ç©ºå­—ç¬¦ä¸²
                        blankrows: false, // è·³è¿‡ç©ºè¡Œ
                        range: 0,  // ä»ç¬¬ä¸€è¡Œå¼€å§‹
                        dateNF: 'yyyy-mm-dd', // æ—¥æœŸæ ¼å¼
                        header: 'A' // ä½¿ç”¨é»˜è®¤è¡¨å¤´
                    });
                    
                    // æ£€æŸ¥æ˜¯å¦ä¸ºç©º
                    if (excelData.length === 0) {
                        alert('Excelæ–‡ä»¶ä¸­æ²¡æœ‰æ•°æ®');
                        progressDiv.style.display = 'none';
                        return;
                    }
                    
                    // å°è¯•æ ‡å‡†æ–¹å¼è¯»å–ï¼ˆå‡è®¾Excelæœ‰æ­£ç¡®çš„è¡¨å¤´è¡Œï¼‰
                    const standardData = XLSX.utils.sheet_to_json(worksheet, { 
                        raw: false, 
                        defval: '',
                        blankrows: false
                    });
                    
                    // æ‰“å°è°ƒè¯•ä¿¡æ¯
                    console.log('æ— è¡¨å¤´è§£ææ•°æ®:', excelData);
                    console.log('æ ‡å‡†è§£ææ•°æ®:', standardData);
                    
                    let useData = standardData;
                    
                    // æ£€æµ‹æ˜¯å¦æœ‰__EMPTYç±»å‹çš„åˆ—ï¼Œè¿™æ„å‘³ç€Excelå¯èƒ½ç¼ºå°‘æ ‡å‡†è¡¨å¤´
                    const hasEmptyColumns = standardData.length > 0 && 
                                         Object.keys(standardData[0] || {}).some(key => key.startsWith('__EMPTY'));
                    
                    console.log('æ˜¯å¦åŒ…å«__EMPTYåˆ—:', hasEmptyColumns);
                    
                    // æ£€æŸ¥æ˜¯å¦æ˜¯ä¸€ä¸ªåˆå¹¶å•å…ƒæ ¼çš„è¡¨æ ¼ï¼ˆåªç”¨äºæ—¥å¿—åˆ†æï¼‰
                    try {
                        const merges = worksheet['!merges'] || [];
                        console.log('è¡¨æ ¼åŒ…å«çš„åˆå¹¶å•å…ƒæ ¼æ•°é‡:', merges.length);
                        if (merges.length > 0) {
                            console.log('æ£€æµ‹åˆ°åˆå¹¶å•å…ƒæ ¼ï¼Œè¿™å¯èƒ½å½±å“è§£æ');
                        }
                    } catch (e) {
                        console.warn('æ£€æŸ¥åˆå¹¶å•å…ƒæ ¼å‡ºé”™:', e);
                    }
                    
                    // å¦‚æœæ£€æµ‹åˆ°__EMPTYåˆ—ï¼Œåˆ™ä½¿ç”¨ç¬¬ä¸€è¡Œä½œä¸ºè¡¨å¤´é‡æ–°è§£æ
                    if (hasEmptyColumns && standardData.length > 0) {
                        console.log('æ£€æµ‹åˆ°ç©ºåˆ—å¤´ï¼Œå°è¯•ä½¿ç”¨ç¬¬ä¸€è¡Œä½œä¸ºè¡¨å¤´');
                        
                        // è·å–å·¥ä½œè¡¨çš„èŒƒå›´
                        const range = XLSX.utils.decode_range(worksheet['!ref']);
                        
                        // ä»ç¬¬ä¸€è¡Œæå–è¡¨å¤´
                        const headers = [];
                        for(let C = range.s.c; C <= range.e.c; ++C) {
                            const cell = worksheet[XLSX.utils.encode_cell({r:0, c:C})];
                            headers.push(cell && cell.v ? String(cell.v).trim() : `åˆ—${C+1}`);
                        }
                        
                        console.log('ä»ç¬¬ä¸€è¡Œæå–çš„è¡¨å¤´:', headers);
                        
                        // å¦‚æœæ‰¾åˆ°äº†"é¡¹ç›®åç§°"æˆ–"é¡¹ç›®"ç­‰å…³é”®åˆ—ï¼Œä½¿ç”¨è‡ªå®šä¹‰è¡¨å¤´é‡æ–°è§£æ
                        if (headers.some(h => h.includes('é¡¹ç›®'))) {
                            // ä½¿ç”¨è‡ªå®šä¹‰è¡¨å¤´é‡æ–°è§£æ
                            const customData = XLSX.utils.sheet_to_json(worksheet, {
                                header: headers,
                                range: 1,  // ä»ç¬¬äºŒè¡Œå¼€å§‹ï¼ˆè·³è¿‡è¡¨å¤´ï¼‰
                                raw: false,
                                defval: ''
                            });
                            
                            console.log('ä½¿ç”¨è‡ªå®šä¹‰è¡¨å¤´è§£æçš„æ•°æ®:', customData);
                            useData = customData;
                        }
                    }
                    
                    // å¦‚æœæ ‡å‡†æ–¹å¼è§£æå¤±è´¥ï¼Œå°è¯•å…¶ä»–æ–¹å¼
                    if (useData.length === 0 && excelData.length > 0) {
                        console.log('æ ‡å‡†è§£ææ— ç»“æœï¼Œä½¿ç”¨æ— è¡¨å¤´è§£æç»“æœ');
                        useData = excelData;
                    }
                    
                    console.log('æœ€ç»ˆä½¿ç”¨çš„Excelè§£ææ•°æ®ï¼š', useData);
                    console.log('ç¬¬ä¸€æ¡è®°å½•ï¼š', useData[0]);
                    console.log('ç¬¬ä¸€æ¡è®°å½•çš„é”®ï¼š', Object.keys(useData[0] || {}));
                    
                    progressBar.style.width = '70%';
                    
                    // æŒ‰é¡¹ç›®åç§°åˆ†ç»„
                    const groupedByProject = {};
                    
                    // ä¸ºäº†è§£å†³åˆ—åå¯èƒ½åŒ…å«ç©ºæ ¼æˆ–ä¸å®Œå…¨åŒ¹é…çš„é—®é¢˜ï¼Œå…ˆæ‰¾åˆ°é¡¹ç›®åç§°åˆ—çš„å®é™…é”®å
                    let projectNameKey = 'é¡¹ç›®åç§°';
                    const possibleKeys = Object.keys(useData[0] || {});
                    
                    // æ·»åŠ å¯¹__EMPTY_å¼€å¤´åˆ—çš„æ”¯æŒ
                    const projectKeyVariants = [
                        'é¡¹ç›®åç§°', 'é¡¹ç›® åç§°', 'é¡¹ç›®  åç§°', 'é¡¹ç›®å ç§°', 'é¡¹ ç›®åç§°', 'é¡¹ç›®', 
                        'ProjectName', 'Project Name'
                    ];
                    
                    // å…ˆå°è¯•ç²¾ç¡®åŒ¹é…
                    for (const variant of projectKeyVariants) {
                        if (possibleKeys.includes(variant)) {
                            projectNameKey = variant;
                            console.log('æ‰¾åˆ°é¡¹ç›®åç§°åˆ—:', projectNameKey);
                            break;
                        }
                    }
                    
                    // å¦‚æœæ²¡æ‰¾åˆ°ï¼Œå°è¯•åŒ¹é…__EMPTY_å¼€å¤´çš„åˆ—
                    if (projectNameKey === 'é¡¹ç›®åç§°' && !possibleKeys.includes('é¡¹ç›®åç§°')) {
                        // æ£€æŸ¥æ˜¯å¦æœ‰åŒ…å«"é¡¹ç›®"æˆ–"åç§°"çš„åˆ—ï¼ˆä»è¡¨æ ¼çš„ç¬¬ä¸€è¡Œæ£€æµ‹ï¼‰
                        for (let i = 0; i < possibleKeys.length; i++) {
                            const key = possibleKeys[i];
                            if (key.startsWith('__EMPTY')) {
                                // å°è¯•æ£€æŸ¥è¯¥åˆ—çš„ç¬¬ä¸€ä¸ªå€¼æ˜¯å¦åŒ…å«"é¡¹ç›®"å…³é”®è¯
                                const firstValue = useData[0][key];
                                if (firstValue && (
                                    typeof firstValue === 'string' && (
                                        firstValue.includes('é¡¹ç›®') || 
                                        firstValue.toLowerCase().includes('project')
                                    )
                                )) {
                                    projectNameKey = key;
                                    console.log('åœ¨__EMPTYåˆ—ä¸­æ‰¾åˆ°å¯èƒ½çš„é¡¹ç›®åç§°åˆ—:', key, 'é¦–å€¼:', firstValue);
                                    break;
                                }
                            }
                        }
                    }
                    
                    // å¦‚æœç²¾ç¡®åŒ¹é…å¤±è´¥ï¼Œå°è¯•æ¨¡ç³ŠåŒ¹é…
                    if (projectNameKey === 'é¡¹ç›®åç§°' && !possibleKeys.includes('é¡¹ç›®åç§°')) {
                        // å°è¯•æŸ¥æ‰¾åŒ…å«å…³é”®è¯çš„é”®
                        const fuzzyMatch = possibleKeys.find(key => 
                            (key.includes('é¡¹ç›®') && key.includes('åç§°')) || 
                            (key.toLowerCase().includes('project') && key.toLowerCase().includes('name')));
                        
                        if (fuzzyMatch) {
                            projectNameKey = fuzzyMatch;
                            console.log('æ¨¡ç³ŠåŒ¹é…åˆ°é¡¹ç›®åç§°åˆ—:', projectNameKey);
                        } else {
                            // å¦‚æœè¿˜æ˜¯æ‰¾ä¸åˆ°ï¼Œå°è¯•ä½¿ç”¨ç¬¬2åˆ—æˆ–ç¬¬3åˆ—
                            if (possibleKeys.includes('B') || possibleKeys.includes('__EMPTY_1')) {
                                projectNameKey = possibleKeys.includes('B') ? 'B' : '__EMPTY_1';
                                console.log('ä½¿ç”¨ç¬¬2åˆ—ä½œä¸ºé¡¹ç›®åç§°åˆ—:', projectNameKey);
                            } else if (possibleKeys.includes('C') || possibleKeys.includes('__EMPTY_2')) {
                                projectNameKey = possibleKeys.includes('C') ? 'C' : '__EMPTY_2';
                                console.log('ä½¿ç”¨ç¬¬3åˆ—ä½œä¸ºé¡¹ç›®åç§°åˆ—:', projectNameKey);
                            }
                        }
                    }
                    
                    console.log('æœ€ç»ˆä½¿ç”¨çš„é¡¹ç›®åç§°åˆ—é”®:', projectNameKey);
                    console.log('å¯ç”¨çš„åˆ—é”®:', possibleKeys);
                    
                    // è¿‡æ»¤è®°å½•è®¡æ•°
                    let totalRows = 0;
                    let skippedHeaderRows = 0;
                    let validDataRows = 0;
                    
                    useData.forEach(row => {
                        totalRows++;
                        // ç¡®ä¿é¡¹ç›®åç§°å­˜åœ¨
                        const projectName = row[projectNameKey];
                        if (!projectName) {
                            return;
                        }
                        
                        // æ£€æŸ¥é¡¹ç›®åç§°æ˜¯å¦ä¸ºè¡¨å¤´ï¼Œå¦‚æœæ˜¯åˆ™è·³è¿‡
                        // å¦‚æœé¡¹ç›®åç§°ç­‰äºåˆ—åæœ¬èº«ï¼Œå¾ˆå¯èƒ½æ˜¯è¡¨å¤´
                        if (projectName === 'é¡¹ç›®åç§°' || projectName === 'é¡¹ç›®' || 
                            projectName.toLowerCase() === 'project' || 
                            projectName.toLowerCase() === 'project name' ||
                            projectName.toLowerCase() === 'projectname') {
                            console.log('è·³è¿‡ç–‘ä¼¼è¡¨å¤´è¡Œ:', projectName);
                            skippedHeaderRows++;
                            return;
                        }
                        
                        // æ£€æŸ¥é¡¹ç›®åç§°æ˜¯å¦åŒ…å«å¸¸è§è¡¨å¤´å…³é”®è¯
                        const headerKeywords = ['è¡¨å¤´', 'åˆ—å', 'header', 'column', 'title', 'åç§°', 'è¡¨æ ¼'];
                        if (headerKeywords.some(keyword => 
                            projectName.toLowerCase().includes(keyword.toLowerCase()))) {
                            console.log('è·³è¿‡åŒ…å«è¡¨å¤´å…³é”®è¯çš„è¡Œ:', projectName);
                            skippedHeaderRows++;
                            return;
                        }
                        
                        // æ£€æŸ¥æ˜¯å¦æ•´è¡Œéƒ½æ˜¯åˆ—åï¼Œè€Œä¸æ˜¯å®é™…æ•°æ®
                        // å¦‚æœä¸€è¡Œä¸­å¤šä¸ªå­—æ®µéƒ½ä¸å…¸å‹åˆ—ååŒ¹é…ï¼Œåˆ™å¯èƒ½æ˜¯è¡¨å¤´
                        const typicalColumnNames = ['äº§å“åç§°', 'å‹å·', 'å•ä»·', 'æ•°é‡', 'åˆè®¡', 'æ€»ä»·', 'é˜¶æ®µ', 'æ—¥æœŸ', 'å¤‡æ³¨'];
                        let headerMatchCount = 0;
                        
                        typicalColumnNames.forEach(colName => {
                            // éå†è¡Œä¸­çš„æ‰€æœ‰å­—æ®µå€¼
                            Object.values(row).forEach(value => {
                                if (typeof value === 'string' && 
                                    (value === colName || 
                                     value.toLowerCase() === colName.toLowerCase() ||
                                     value.includes(colName))) {
                                    headerMatchCount++;
                                }
                            });
                        });
                        
                        // å¦‚æœåŒ¹é…äº†å¤šä¸ªåˆ—åï¼Œåˆ¤å®šä¸ºè¡¨å¤´è¡Œ
                        if (headerMatchCount >= 3) {
                            console.log('è·³è¿‡ç–‘ä¼¼è¡¨å¤´è¡Œ(å¤šåˆ—åŒ¹é…):', projectName, 'åŒ¹é…æ•°:', headerMatchCount);
                            skippedHeaderRows++;
                            return;
                        }
                        
                        // æ£€æŸ¥æ•°å€¼å‹å­—æ®µæ˜¯å¦ç¼ºå¤±æˆ–éæ•°å€¼ï¼Œå¦‚æœæ˜¯åˆ™å¯èƒ½æ˜¯è¡¨å¤´
                        const numericKeywords = ['ä»·æ ¼', 'å•ä»·', 'åˆè®¡', 'æ€»ä»·', 'æ•°é‡'];
                        let numericFieldCount = 0;
                        let numericValueCount = 0;
                        
                        // æ£€æŸ¥æœ‰å¤šå°‘ä¸ªæ•°å€¼å‹å­—æ®µç¡®å®åŒ…å«æ•°å€¼
                        Object.entries(row).forEach(([key, value]) => {
                            // æ£€æŸ¥å­—æ®µåæ˜¯å¦ä¸ºæ•°å€¼å‹å­—æ®µ
                            const isNumericField = numericKeywords.some(keyword => 
                                key.toLowerCase().includes(keyword.toLowerCase()));
                            
                            if (isNumericField) {
                                numericFieldCount++;
                                
                                // æ£€æŸ¥å€¼æ˜¯å¦ä¸ºæ•°å€¼
                                const numValue = parseFloat(value);
                                if (!isNaN(numValue)) {
                                    numericValueCount++;
                                }
                            }
                        });
                        
                        // å¦‚æœæœ‰æ•°å€¼å­—æ®µä½†éƒ½ä¸æ˜¯æ•°å€¼ï¼Œå¾ˆå¯èƒ½æ˜¯è¡¨å¤´
                        if (numericFieldCount >= 2 && numericValueCount === 0) {
                            console.log('è·³è¿‡ç–‘ä¼¼è¡¨å¤´è¡Œ(æ— æ•°å€¼):', projectName);
                            skippedHeaderRows++;
                            return;
                        }
                        
                        // å¦‚æœæ‰€æœ‰å­—æ®µå€¼çš„é•¿åº¦éƒ½å¾ˆçŸ­ï¼ˆé€šå¸¸æ˜¯åˆ—åï¼‰ï¼Œå¯èƒ½æ˜¯è¡¨å¤´
                        const fieldValues = Object.values(row).filter(v => typeof v === 'string');
                        const shortFieldCount = fieldValues.filter(v => v.length < 8).length;
                        if (fieldValues.length >= 5 && shortFieldCount / fieldValues.length > 0.8) {
                            console.log('è·³è¿‡ç–‘ä¼¼è¡¨å¤´è¡Œ(çŸ­å­—æ®µ):', projectName);
                            skippedHeaderRows++;
                            return;
                        }
                        
                        if (!groupedByProject[projectName]) {
                            groupedByProject[projectName] = [];
                        }
                        
                        groupedByProject[projectName].push(row);
                        validDataRows++;
                    });
                    
                    console.log(`Excelè§£æç»Ÿè®¡: æ€»è¡Œæ•°=${totalRows}, æœ‰æ•ˆæ•°æ®è¡Œ=${validDataRows}, è·³è¿‡è¡¨å¤´/æ— æ•ˆè¡Œ=${skippedHeaderRows}`);
                    if (skippedHeaderRows > 0) {
                        console.log(`å·²è‡ªåŠ¨è¿‡æ»¤ ${skippedHeaderRows} è¡Œç–‘ä¼¼è¡¨å¤´æ•°æ®`);
                    }
                    
                    // è§£æå‡ºæŠ¥ä»·å•æ•°æ®å’Œæ˜ç»†æ•°æ®
                    parsedQuotations = [];
                    quotationDetails = {};
                    
                    // æ£€æŸ¥æ˜¯å¦æœ‰é¡¹ç›®åç§°åˆ—
                    const hasProjectNameColumn = useData.some(row => row[projectNameKey] !== undefined);
                    if (!hasProjectNameColumn) {
                        console.error('Excelè§£æç»“æœ:', useData);
                        console.error('Excelä¸­æ‰¾ä¸åˆ°é¡¹ç›®åç§°åˆ—ï¼Œæ£€æŸ¥ç¬¬ä¸€è¡Œè®°å½•çš„é”®:', Object.keys(useData[0] || {}));
                        console.error('å½“å‰å°è¯•çš„é¡¹ç›®åç§°é”®:', projectNameKey);
                        alert(`Excelæ–‡ä»¶ä¸­ç¼ºå°‘å¿…è¦çš„"é¡¹ç›®åç§°"åˆ—ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶æ ¼å¼ï¼\nå¯èƒ½çš„åŸå› ï¼š\n1. è¡¨å¤´åç§°ä¸åŒ¹é…"é¡¹ç›®åç§°"\n2. Excelæ ¼å¼ä¸æ­£ç¡®\n3. åˆ—ååŒ…å«ç©ºæ ¼æˆ–ç‰¹æ®Šå­—ç¬¦\n\nå½“å‰å°è¯•çš„åˆ—å: ${projectNameKey}\nå¯ç”¨çš„åˆ—å: ${possibleKeys.join(', ')}`);
                        progressDiv.style.display = 'none';
                        return;
                    }
                    
                    // å¤„ç†æ¯ä¸ªé¡¹ç›®çš„æŠ¥ä»·å•
                    for (const projectName in groupedByProject) {
                        const projectDetails = groupedByProject[projectName];
                        
                        // å¦‚æœé¡¹ç›®åç§°ä¸ºç©ºæˆ–é¡¹ç›®ä¸‹æ²¡æœ‰æ˜ç»†ï¼Œè·³è¿‡
                        if (!projectName || projectName.trim() === '' || projectDetails.length === 0) {
                            console.warn('è·³è¿‡æ— æ•ˆé¡¹ç›®åç§°æˆ–æ— æ˜ç»†çš„é¡¹ç›®:', projectName);
                            continue;
                        }
                        
                        // å–ç¬¬ä¸€æ¡è®°å½•ä½œä¸ºæŠ¥ä»·å•æ•°æ®
                        const firstRecord = projectDetails[0];
                        
                        // æŸ¥æ‰¾ç›¸å…³åˆ—é”®
                        const findColumnKey = (possibleNames, defaultValue = '') => {
                            for (const name of possibleNames) {
                                if (possibleKeys.includes(name)) {
                                    return name;
                                }
                            }
                            
                            // æ¨¡ç³ŠåŒ¹é…
                            for (const name of possibleNames) {
                                const fuzzyKey = possibleKeys.find(key => 
                                    (key.includes(name) || 
                                    (typeof name === 'string' && key.toLowerCase().includes(name.toLowerCase()))));
                                if (fuzzyKey) return fuzzyKey;
                            }
                            
                            // åœ¨__EMPTYåˆ—ä¸­æŸ¥æ‰¾
                            const emptyKeys = possibleKeys.filter(key => key.startsWith('__EMPTY'));
                            for (const key of emptyKeys) {
                                const firstValue = useData[0][key];
                                if (firstValue) {
                                    for (const name of possibleNames) {
                                        if (typeof firstValue === 'string' && 
                                            (firstValue.includes(name) || 
                                            (typeof name === 'string' && firstValue.toLowerCase().includes(name.toLowerCase())))) {
                                            return key;
                                        }
                                    }
                                }
                            }
                            
                            return defaultValue;
                        };
                        
                        // æŸ¥æ‰¾å…³é”®åˆ—
                        const productNameKey = findColumnKey(['äº§å“åç§°', 'äº§å“', 'åç§°', 'äº§å“å‹å·åç§°', 'product'], '');
                        const productModelKey = findColumnKey(['å‹å·', 'è§„æ ¼å‹å·', 'äº§å“å‹å·', 'model'], '');
                        const priceKey = findColumnKey(['å•ä»·', 'ä»·æ ¼', 'äº§å“å•ä»·', 'price'], '');
                        const quantityKey = findColumnKey(['æ•°é‡', 'äº§å“æ•°é‡', 'quantity'], '');
                        const totalKey = findColumnKey(['åˆè®¡', 'æ€»ä»·', 'äº§å“æ€»ä»·', 'total'], '');
                        const stageKey = findColumnKey(['é˜¶æ®µçŠ¶æ€', 'é˜¶æ®µ', 'é¡¹ç›®é˜¶æ®µ', 'stage'], '');
                        const dateKey = findColumnKey(['æ—¥æœŸ', 'æ—¶é—´', 'åˆ›å»ºæ—¥æœŸ', 'date'], '');
                        
                        console.log('è¯†åˆ«çš„åˆ—æ˜ å°„:',
                            'äº§å“åç§°åˆ—:', productNameKey,
                            'å‹å·åˆ—:', productModelKey,
                            'å•ä»·åˆ—:', priceKey,
                            'æ•°é‡åˆ—:', quantityKey,
                            'åˆè®¡åˆ—:', totalKey,
                            'é˜¶æ®µåˆ—:', stageKey,
                            'æ—¥æœŸåˆ—:', dateKey
                        );
                        
                        // è®¡ç®—é¡¹ç›®æ€»é¢
                        let totalAmount = 0;
                        projectDetails.forEach(detail => {
                            // å°è¯•ä»åˆè®¡å­—æ®µè·å–é‡‘é¢ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™å°è¯•è®¡ç®—å•ä»·*æ•°é‡
                            let amount = 0;
                            
                            // è·å–åˆè®¡å€¼
                            if (totalKey && detail[totalKey] && !isNaN(parseFloat(detail[totalKey]))) {
                                amount = parseFloat(detail[totalKey]);
                            } 
                            // è®¡ç®—å•ä»·*æ•°é‡
                            else if (priceKey && quantityKey && 
                                     detail[priceKey] && detail[quantityKey]) {
                                const unitPrice = parseFloat(detail[priceKey]);
                                const quantity = parseFloat(detail[quantityKey]);
                                if (!isNaN(unitPrice) && !isNaN(quantity)) {
                                    amount = unitPrice * quantity;
                                }
                            }
                            
                            if (!isNaN(amount)) {
                                totalAmount += amount;
                            }
                        });
                        
                        // ç”ŸæˆæŠ¥ä»·å•
                        const today = new Date();
                        let createdDate;
                        // å°è¯•è§£ææ—¥æœŸ
                        try {
                            // æ”¯æŒå¤šç§æ—¥æœŸæ ¼å¼
                            const dateStr = dateKey ? firstRecord[dateKey] : null;
                            if (dateStr) {
                                // å°è¯•å¸¸è§æ ¼å¼ MM/DD/YY
                                if (/^\d{1,2}\/\d{1,2}\/\d{2,4}$/.test(dateStr)) {
                                    const parts = dateStr.split('/');
                                    // ç¾å¼æ—¥æœŸæ ¼å¼ MM/DD/YY(YY)
                                    const month = parseInt(parts[0]) - 1;
                                    const day = parseInt(parts[1]);
                                    let year = parseInt(parts[2]);
                                    // å¤„ç†ä¸¤ä½å¹´ä»½
                                    if (year < 100) {
                                        year = year < 50 ? 2000 + year : 1900 + year;
                                    }
                                    createdDate = new Date(year, month, day);
                                } else {
                                    // å°è¯•ISOæ ¼å¼æˆ–å…¶ä»–å¸¸è§æ ¼å¼
                                    createdDate = new Date(dateStr);
                                }
                            }
                        } catch (e) {
                            console.warn('æ—¥æœŸè§£æé”™è¯¯:', e);
                        }
                        
                        // å¦‚æœæ—¥æœŸæ— æ•ˆï¼Œä½¿ç”¨ä»Šå¤©çš„æ—¥æœŸ
                        if (!createdDate || isNaN(createdDate.getTime())) {
                            createdDate = today;
                        }
                        
                        const quotation = {
                            project_name: projectName,
                            project_stage: stageKey ? (firstRecord[stageKey] || '') : '',
                            amount: totalAmount,
                            created_at: createdDate.toISOString().split('T')[0],
                            updated_at: today.toISOString().split('T')[0],
                            total_details: projectDetails.length
                        };
                        
                        quotation.quotation_number = generateQuotationNumber(createdDate);
                        parsedQuotations.push(quotation);
                        
                        // ä¿å­˜è¯¥æŠ¥ä»·å•çš„æ˜ç»†æ•°æ®
                        quotationDetails[projectName] = projectDetails.map(detail => {
                            // ç¡®ä¿æ•°å€¼ç±»å‹çš„å€¼æœ‰æ•ˆ
                            const parseNumber = (value, defaultVal = 0) => {
                                if (!value || value === '') return defaultVal;
                                const parsed = parseFloat(value);
                                return isNaN(parsed) ? defaultVal : parsed;
                            };
                            
                            return {
                                product_name: productNameKey ? (detail[productNameKey] || '') : '',
                                product_model: productModelKey ? (detail[productModelKey] || '') : '',
                                product_desc: findColumnKey(['æŒ‡æ ‡æè¿°', 'æè¿°', 'è¯´æ˜']) ? (detail[findColumnKey(['æŒ‡æ ‡æè¿°', 'æè¿°', 'è¯´æ˜'])] || '') : '',
                                brand: findColumnKey(['å“ç‰Œæƒ…å†µ', 'å“ç‰Œ', 'å‚å•†']) ? (detail[findColumnKey(['å“ç‰Œæƒ…å†µ', 'å“ç‰Œ', 'å‚å•†'])] || '') : '',
                                unit: findColumnKey(['å•ä½', 'unit']) ? (detail[findColumnKey(['å•ä½', 'unit'])] || '') : '',
                                discount: parseNumber(detail[findColumnKey(['æŠ˜æ‰£', 'discount'])], 1),
                                market_price: parseNumber(detail[findColumnKey(['é›¶å”®å•ä»·', 'å¸‚åœºä»·', 'æ ‡å‡†ä»·'])]),
                                unit_price: parseNumber(detail[priceKey]),
                                total_price: parseNumber(detail[totalKey]),
                                product_mn: findColumnKey(['MN', 'å‹å·ç¼–ç ']) ? (detail[findColumnKey(['MN', 'å‹å·ç¼–ç '])] || '') : '',
                                created_at: dateKey ? (detail[dateKey] || new Date().toISOString().split('T')[0]) : new Date().toISOString().split('T')[0],
                                updated_at: findColumnKey(['æ›´æ–°æ—¶é—´']) ? (detail[findColumnKey(['æ›´æ–°æ—¶é—´'])] || new Date().toISOString().split('T')[0]) : new Date().toISOString().split('T')[0]
                            };
                        });
                    }
                    
                    // æ˜¾ç¤ºé¢„è§ˆ
                    progressBar.style.width = '100%';
                    setTimeout(() => {
                        progressDiv.style.display = 'none';
                        showQuotationPreview();
                        importBtn.style.display = 'block';
                        
                        // æ£€æŸ¥æŠ¥ä»·å•ä¸å½“å‰ç³»ç»Ÿä¸­çš„å†²çª
                        checkQuotationConflicts(parsedQuotations)
                            .then(data => {
                                if (data.success) {
                                    conflicts = data.conflicts || [];
                                    
                                    // å¦‚æœæ£€æµ‹åˆ°å†²çªï¼Œæ˜¾ç¤ºå†²çªå¤„ç†åŒºåŸŸ
                                    if (conflicts.length > 0) {
                                        showConflicts();
                                    }
                                } else {
                                    console.error('æ£€æŸ¥å†²çªå¤±è´¥:', data.message);
                                    alert('æ£€æŸ¥å†²çªå¤±è´¥: ' + data.message);
                                }
                            })
                            .catch(error => {
                                console.error('å¤„ç†å†²çªæ£€æŸ¥æ—¶å‡ºé”™:', error);
                            });
                    }, 500);
                } catch (error) {
                    console.error('è§£æExcelæ–‡ä»¶é”™è¯¯:', error);
                    console.error('é”™è¯¯è¯¦æƒ…:', error.stack);
                    
                    // ä½¿ç”¨é”™è¯¯è¯Šæ–­åŠŸèƒ½
                    const errorAnalysis = analyzeExcelImportError(error, file.name, possibleKeys);
                    
                    // æ„å»ºè¯¦ç»†é”™è¯¯æ¶ˆæ¯
                    let errorMessage = `è§£æExcelæ–‡ä»¶æ—¶å‡ºé”™: ${errorAnalysis.message}\n\n`;
                    
                    if (errorAnalysis.possibleCauses.length > 0) {
                        errorMessage += 'å¯èƒ½çš„åŸå› :\n';
                        errorAnalysis.possibleCauses.forEach((cause, index) => {
                            errorMessage += `${index+1}. ${cause}\n`;
                        });
                        errorMessage += '\n';
                    }
                    
                    if (errorAnalysis.solutions.length > 0) {
                        errorMessage += 'å»ºè®®è§£å†³æ–¹æ¡ˆ:\n';
                        errorAnalysis.solutions.forEach((solution, index) => {
                            errorMessage += `${index+1}. ${solution}\n`;
                        });
                    }
                    
                    alert(errorMessage);
                    progressDiv.style.display = 'none';
                }
            };
            
            reader.onerror = function() {
                alert('è¯»å–æ–‡ä»¶æ—¶å‡ºé”™');
                progressDiv.style.display = 'none';
            };
            
            reader.readAsArrayBuffer(file);
        });
    }
    
    // ç”ŸæˆæŠ¥ä»·å•ç¼–å·
    function generateQuotationNumber(date) {
        // ç¡®ä¿dateæ˜¯æœ‰æ•ˆçš„Dateå¯¹è±¡
        if (!(date instanceof Date) || isNaN(date.getTime())) {
            date = new Date(); // å¦‚æœæ—¥æœŸæ— æ•ˆï¼Œä½¿ç”¨å½“å‰æ—¥æœŸ
        }
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const prefix = `QU${year}${month}-`;
        
        // ä»localStorageè·å–å½“å‰æœˆä»½çš„æœ€ååºå·
        let lastSequence = 0;
        const storageKey = `quotation_sequence_${year}${month}`;
        
        try {
            const savedSequence = localStorage.getItem(storageKey);
            if (savedSequence) {
                lastSequence = parseInt(savedSequence, 10);
            }
        } catch (e) {
            console.warn('æ— æ³•ä»localStorageè¯»å–åºå·', e);
        }
        
        // é€’å¢åºå·
        const sequence = lastSequence + 1;
        
        // æ›´æ–°localStorageä¸­çš„åºå·
        try {
            localStorage.setItem(storageKey, sequence.toString());
        } catch (e) {
            console.warn('æ— æ³•ä¿å­˜åºå·åˆ°localStorage', e);
        }
        
        // æ ¼å¼åŒ–ä¸ºä¸‰ä½æ•°
        const formattedSequence = String(sequence).padStart(3, '0');
        
        return `${prefix}${formattedSequence}`;
    }
    
    // æ£€æŸ¥æŠ¥ä»·å•å†²çª
    function checkQuotationConflicts(quotations) {
        console.log('æ£€æŸ¥æŠ¥ä»·å•å†²çªï¼Œä¼ å…¥æ•°æ®:', quotations);
        
        // éªŒè¯è¾“å…¥æ•°æ®
        if (!quotations || !Array.isArray(quotations) || quotations.length === 0) {
            console.error('æ²¡æœ‰æœ‰æ•ˆçš„æŠ¥ä»·å•æ•°æ®ç”¨äºæ£€æŸ¥å†²çª', quotations);
            alert('æ²¡æœ‰æœ‰æ•ˆçš„æŠ¥ä»·å•æ•°æ®ç”¨äºæ£€æŸ¥å†²çªï¼Œè¯·æ£€æŸ¥Excelæ–‡ä»¶æ ¼å¼æ˜¯å¦æ­£ç¡®ã€‚');
            return Promise.reject('æ²¡æœ‰æœ‰æ•ˆçš„æŠ¥ä»·å•æ•°æ®ç”¨äºæ£€æŸ¥å†²çª');
        }
        
        // éªŒè¯æ¯ä¸ªæŠ¥ä»·å•å¯¹è±¡
        for (const quotation of quotations) {
            if (!quotation.project_name || quotation.project_name.trim() === '') {
                console.error('æŠ¥ä»·å•ç¼ºå°‘é¡¹ç›®åç§°', quotation);
                alert('æŸäº›æŠ¥ä»·å•ç¼ºå°‘é¡¹ç›®åç§°ï¼Œè¯·æ£€æŸ¥Excelæ–‡ä»¶æ ¼å¼ã€‚');
                return Promise.reject('æŠ¥ä»·å•ç¼ºå°‘é¡¹ç›®åç§°');
            }
        }
        
        return fetch('/api/quotations/check-conflicts', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ quotations: quotations })
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('æ£€æŸ¥å†²çªè¯·æ±‚å¤±è´¥: ' + response.status);
            }
            return response.json();
        })
        .then(data => {
            console.log('å†²çªæ£€æŸ¥ç»“æœ:', data);
            return data;
        })
        .catch(error => {
            console.error('æ£€æŸ¥å†²çªå‘ç”Ÿé”™è¯¯:', error);
            alert('æ£€æŸ¥å†²çªæ—¶å‘ç”Ÿé”™è¯¯: ' + error.message);
            throw error;
        });
    }
    
    // æ˜¾ç¤ºæŠ¥ä»·å•é¢„è§ˆ
    function showQuotationPreview() {
        const previewTbody = document.getElementById('previewTableBody');
        previewTbody.innerHTML = '';
        
        // æ˜¾ç¤ºæœ€å¤š5æ¡é¢„è§ˆ
        const previewLimit = Math.min(parsedQuotations.length, 5);
        
        for (let i = 0; i < previewLimit; i++) {
            const quotation = parsedQuotations[i];
            const row = document.createElement('tr');
            
            row.innerHTML = `
                <td>${quotation.quotation_number}</td>
                <td>${quotation.project_name}</td>
                <td>${quotation.project_stage}</td>
                <td>${formatCurrency(quotation.amount)}</td>
                <td>${quotation.total_details} é¡¹</td>
            `;
            
            previewTbody.appendChild(row);
        }
        
        // æ˜¾ç¤ºæç¤ºä¿¡æ¯
        const previewMore = document.getElementById('previewMore');
        if (parsedQuotations.length > 5) {
            previewMore.style.display = 'block';
            previewMore.querySelector('p').textContent = `å…± ${parsedQuotations.length} ä¸ªæŠ¥ä»·å•å¾…å¯¼å…¥ï¼Œä»…æ˜¾ç¤ºå‰ 5 ä¸ª`;
        } else {
            previewMore.style.display = 'none';
        }
        
        // å¦‚æœæœ‰è¿‡æ»¤æ‰çš„è¡¨å¤´è¡Œï¼Œæ˜¾ç¤ºæç¤º
        if (typeof skippedHeaderRows !== 'undefined' && skippedHeaderRows > 0) {
            // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨è¿‡æ»¤æç¤º
            let filterInfo = document.getElementById('headerFilterInfo');
            if (!filterInfo) {
                filterInfo = document.createElement('div');
                filterInfo.id = 'headerFilterInfo';
                filterInfo.className = 'alert alert-info mt-2';
                previewDiv.appendChild(filterInfo);
            }
            
            // æ›´æ–°æç¤ºå†…å®¹
            filterInfo.innerHTML = `
                <i class="fas fa-info-circle"></i> ç³»ç»Ÿå·²è‡ªåŠ¨è¯†åˆ«å¹¶è¿‡æ»¤æ‰ <strong>${skippedHeaderRows}</strong> è¡Œç–‘ä¼¼è¡¨å¤´æˆ–æ— æ•ˆæ•°æ®ã€‚
                è¿™äº›è¡Œé€šå¸¸æ˜¯è¡¨å¤´é‡å¤ã€æ ¼å¼é”™è¯¯æˆ–ä¸åŒ…å«æœ‰æ•ˆæ•°æ®çš„è¡Œã€‚
            `;
        }
        
        previewDiv.style.display = 'block';
    }
    
    // æ˜¾ç¤ºå†²çª
    function showConflicts() {
        const conflictsTbody = document.getElementById('conflictsTableBody');
        conflictsTbody.innerHTML = '';
        
        // åœ¨å†²çªæ ‡é¢˜ä¸Šæ–¹æ·»åŠ è¯´æ˜ä¿¡æ¯
        const conflictInfoDiv = document.getElementById('conflictInfo');
        if (conflictInfoDiv) {
            conflictInfoDiv.innerHTML = `
                <div class="alert alert-info">
                    <ul class="mb-0">
                        <li><strong>å¿½ç•¥</strong>: è·³è¿‡æ­¤é¡¹ç›®ï¼Œä¸å¯¼å…¥ä»»ä½•æ˜ç»†</li>
                        <li><strong>æ·»åŠ </strong>: å°†æ˜ç»†æ·»åŠ åˆ°å·²æœ‰çš„æŠ¥ä»·å•ä¸­ï¼Œä¸ä¼šåˆ›å»ºæ–°çš„æŠ¥ä»·å•</li>
                        <li><strong>è¦†ç›–</strong>: åˆ é™¤å·²æœ‰æŠ¥ä»·å•åŠå…¶æ˜ç»†ï¼Œåˆ›å»ºå…¨æ–°çš„æŠ¥ä»·å•</li>
                    </ul>
                    <p class="mt-2 mb-0 small text-danger">æ³¨æ„: å¯¹äºå·²æœ‰æŠ¥ä»·å•çš„é¡¹ç›®ï¼Œé€‰æ‹©"æ·»åŠ "é€‰é¡¹ä¸ä¼šä½¿ç”¨è¡¨æ ¼ä¸­çš„æ–°ç¼–å·ï¼Œè€Œæ˜¯ä¿ç•™åŸæœ‰æŠ¥ä»·å•ç¼–å·</p>
                </div>
            `;
        }
        
        conflicts.forEach((conflict, index) => {
            const row = document.createElement('tr');
            
            row.innerHTML = `
                <td>${conflict.project_name}</td>
                <td>${conflict.existing_quotation ? conflict.existing_quotation.quotation_number : 'æ— '}</td>
                <td>${parsedQuotations.find(q => q.project_name === conflict.project_name).quotation_number}</td>
                <td>
                    <select class="form-select form-select-sm conflict-action" data-index="${index}">
                        <option value="ignore" selected>å¿½ç•¥</option>
                        <option value="add">æ·»åŠ åˆ°å·²æœ‰æŠ¥ä»·å•</option>
                        <option value="overwrite">è¦†ç›–ç°æœ‰æŠ¥ä»·å•</option>
                    </select>
                </td>
            `;
            
            conflictsTbody.appendChild(row);
            
            // åˆå§‹åŒ–å†²çªæ“ä½œ
            conflictActions[index] = 'ignore';
        });
        
        // æ·»åŠ å†²çªæ“ä½œå˜æ›´äº‹ä»¶ç›‘å¬
        document.querySelectorAll('.conflict-action').forEach(select => {
            select.addEventListener('change', function() {
                const index = this.getAttribute('data-index');
                conflictActions[index] = this.value;
            });
        });
        
        conflictsDiv.style.display = 'block';
    }
    
    // å…¨éƒ¨å¿½ç•¥å†²çª
    if (ignoreAllConflictsBtn) {
        ignoreAllConflictsBtn.addEventListener('click', function() {
            document.querySelectorAll('.conflict-action').forEach(select => {
                select.value = 'ignore';
                const index = select.getAttribute('data-index');
                conflictActions[index] = 'ignore';
            });
        });
    }
    
    // å…¨éƒ¨æ·»åŠ å†²çª
    if (keepAllConflictsBtn) {
        keepAllConflictsBtn.addEventListener('click', function() {
            document.querySelectorAll('.conflict-action').forEach(select => {
                select.value = 'add';
                const index = select.getAttribute('data-index');
                conflictActions[index] = 'add';
            });
        });
    }
    
    // å…¨éƒ¨è¦†ç›–å†²çª
    if (overwriteAllConflictsBtn) {
        overwriteAllConflictsBtn.addEventListener('click', function() {
            document.querySelectorAll('.conflict-action').forEach(select => {
                select.value = 'overwrite';
                const index = select.getAttribute('data-index');
                conflictActions[index] = 'overwrite';
            });
        });
    }
    
    // å¯¼å…¥æŠ¥ä»·å•
    if (importBtn) {
        importBtn.addEventListener('click', function() {
            const ownerId = ownerSelect.value;
            
            if (parsedQuotations.length === 0) {
                alert('æ²¡æœ‰å¯å¯¼å…¥çš„æ•°æ®');
                return;
            }
            
            // æ˜¾ç¤ºè¿›åº¦æ¡
            resultDiv.style.display = 'none';
            progressDiv.style.display = 'block';
            const progressBar = progressDiv.querySelector('.progress-bar');
            progressBar.style.width = '0%';
            
            // ç¦ç”¨å¯¼å…¥æŒ‰é’®ï¼Œé˜²æ­¢é‡å¤æäº¤
            importBtn.disabled = true;
            
            // æ•°æ®æ ¡éªŒ
            let hasError = false;
            let errorMessage = '';
            
            // æ£€æŸ¥æ¯ä¸ªæŠ¥ä»·å•
            parsedQuotations.forEach((quotation, index) => {
                // æ£€æŸ¥æ€»ä»·æ˜¯å¦ä¸º0
                if (quotation.amount <= 0) {
                    hasError = true;
                    errorMessage += `â€¢ é¡¹ç›®"${quotation.project_name}"çš„æ€»ä»·ä¸ºé›¶ï¼Œè¯·æ£€æŸ¥æ˜ç»†æ•°æ®\n`;
                }
                
                // æ£€æŸ¥æ˜ç»†æ•°é‡
                const details = quotationDetails[quotation.project_name];
                if (!details || details.length === 0) {
                    hasError = true;
                    errorMessage += `â€¢ é¡¹ç›®"${quotation.project_name}"æ²¡æœ‰æ˜ç»†æ•°æ®\n`;
                }
            });
            
            // å¦‚æœæœ‰é”™è¯¯ï¼Œæ˜¾ç¤ºç¡®è®¤å¯¹è¯æ¡†
            if (hasError) {
                const confirmImport = confirm(`å¯¼å…¥æ•°æ®å­˜åœ¨ä»¥ä¸‹é—®é¢˜:\n${errorMessage}\næ˜¯å¦ä»è¦ç»§ç»­å¯¼å…¥ï¼Ÿ`);
                if (!confirmImport) {
                    // ç”¨æˆ·å–æ¶ˆå¯¼å…¥
                    importBtn.disabled = false;
                    progressDiv.style.display = 'none';
                    return;
                }
            }
            
            // å‡†å¤‡éœ€è¦å¯¼å…¥çš„æ•°æ®ï¼Œç¡®ä¿æ¯ä¸ªé¡¹ç›®åç§°åªå‡ºç°ä¸€æ¬¡
            const quotationsToImport = [];
            const processedProjects = new Set(); // ç”¨äºè·Ÿè¸ªå·²å¤„ç†çš„é¡¹ç›®åç§°
            
            parsedQuotations.forEach((quotation, index) => {
                // è·³è¿‡å·²å¤„ç†çš„é¡¹ç›®
                if (processedProjects.has(quotation.project_name)) {
                    console.log(`è·³è¿‡é‡å¤çš„é¡¹ç›®åç§°: ${quotation.project_name}`);
                    return;
                }
                
                // æ£€æŸ¥æ˜¯å¦æ˜¯å†²çªé¡¹
                const conflictIndex = conflicts.findIndex(c => c.project_name === quotation.project_name);
                
                // å¦‚æœæ˜¯å†²çªé¡¹ï¼Œä¸”å†²çªå¤„ç†æ–¹å¼æ˜¯å¿½ç•¥ï¼Œåˆ™è·³è¿‡
                if (conflictIndex !== -1 && conflictActions[conflictIndex] === 'ignore') {
                    return;
                }
                
                // æ ‡è®°ä¸ºå·²å¤„ç†
                processedProjects.add(quotation.project_name);
                
                // æ·»åŠ åˆ°è¦å¯¼å…¥çš„åˆ—è¡¨
                quotationsToImport.push({
                    ...quotation,
                    details: quotationDetails[quotation.project_name],
                    conflict_action: conflictIndex !== -1 ? conflictActions[conflictIndex] : null
                });
            });
            
            // æ£€æŸ¥å¯¼å…¥æ•°æ®
            console.log('è¦å¯¼å…¥çš„æŠ¥ä»·å•æ•°æ®:', quotationsToImport);
            console.log(`è§£æäº† ${parsedQuotations.length} ä¸ªæŠ¥ä»·å•ï¼Œå»é‡åå‡†å¤‡å¯¼å…¥ ${quotationsToImport.length} ä¸ª`);
            quotationsToImport.forEach(q => {
                console.log(`é¡¹ç›® ${q.project_name} æ˜ç»†æ•°é‡:`, q.details ? q.details.length : 0);
                console.log(`é¡¹ç›® ${q.project_name} æ€»ä»·:`, q.amount);
            });
            
            // å‘é€æ•°æ®åˆ°æœåŠ¡å™¨
            fetch('/api/quotations/import', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token() }}'
                },
                body: JSON.stringify({
                    owner_id: ownerId,
                    quotations: quotationsToImport
                })
            })
            .then(response => response.json())
            .then(data => {
                // å¯ç”¨å¯¼å…¥æŒ‰é’®
                importBtn.disabled = false;
                progressBar.style.width = '100%';
                
                setTimeout(() => {
                    progressDiv.style.display = 'none';
                    
                    if (data.success) {
                        // æ˜¾ç¤ºå¯¼å…¥ç»“æœ
                        const summaryElem = document.getElementById('importSummary');
                        summaryElem.innerHTML = `
                            æˆåŠŸå¯¼å…¥ ${data.imported_count} ä¸ªæŠ¥ä»·å•ï¼Œ
                            å…± ${data.details_count} æ¡æ˜ç»†ï¼Œ
                            è·³è¿‡ ${data.skipped_count} ä¸ªå†²çªé¡¹ï¼Œ
                            å‡ºé”™ ${data.error_count} é¡¹ã€‚
                        `;
                        
                        // å¦‚æœæœ‰é”™è¯¯ï¼Œæ˜¾ç¤ºé”™è¯¯è¯¦æƒ…
                        const errorDetailsDiv = document.getElementById('importErrorDetails');
                        if (data.error_count > 0 && data.error_details && data.error_details.length > 0) {
                            const errorTbody = document.getElementById('errorDetailsTableBody');
                            errorTbody.innerHTML = '';
                            
                            data.error_details.forEach(error => {
                                const row = document.createElement('tr');
                                row.innerHTML = `
                                    <td>${error.line}</td>
                                    <td>${error.project_name}</td>
                                    <td>${error.reason}</td>
                                `;
                                errorTbody.appendChild(row);
                            });
                            
                            errorDetailsDiv.style.display = 'block';
                        } else {
                            errorDetailsDiv.style.display = 'none';
                        }
                        
                        resultDiv.style.display = 'block';
                        // æ ‡è®°æ˜¯å¦éœ€è¦åˆ·æ–°é¡µé¢
                        needReloadAfterImport = data.imported_count > 0;
                        // ä¸å†è‡ªåŠ¨åˆ·æ–°é¡µé¢ï¼Œç­‰å¾…ç”¨æˆ·ç‚¹å‡»ç¡®è®¤
                    } else {
                        alert('å¯¼å…¥å¤±è´¥: ' + data.message);
                    }
                }, 500);
            })
            .catch(error => {
                console.error('å¯¼å…¥æŠ¥ä»·å•æ—¶å‡ºé”™:', error);
                alert('å¯¼å…¥æŠ¥ä»·å•æ—¶å‡ºé”™');
                importBtn.disabled = false;
                progressDiv.style.display = 'none';
            });
        });
    }
    
    // æ ¼å¼åŒ–è´§å¸æ•°å­—
    function formatCurrency(value) {
        if (value === undefined || value === null) return 'Â¥0.00';
        return 'Â¥' + parseFloat(value).toFixed(2).replace(/\d(?=(\d{3})+\.)/g, '$&,');
    }

    // å‡†å¤‡å¯¼å…¥å‡½æ•°
    function prepareForImport() {
        // æ— å†²çªï¼Œç›´æ¥æ˜¾ç¤ºå¯¼å…¥æŒ‰é’®
        importBtn.style.display = 'block';
        // éšè—å†²çªåŒºåŸŸ
        conflictsDiv.style.display = 'none';
    }

    // å¤„ç†Excelæ¨¡æ¿ä¸‹è½½
    const downloadTemplateBtn = document.getElementById('downloadTemplateBtn');
    if (downloadTemplateBtn) {
        downloadTemplateBtn.addEventListener('click', function() {
            // åˆ›å»ºä¸€ä¸ªç©ºçš„å·¥ä½œç°¿
            const wb = XLSX.utils.book_new();
            
            // åˆ›å»ºè¡¨å¤´
            const headers = ['é¡¹ç›®åç§°', 'äº§å“åç§°', 'å‹å·', 'æŒ‡æ ‡æè¿°', 'å“ç‰Œæƒ…å†µ', 'å•ä½', 'æ•°é‡', 'å•ä»·', 'åˆè®¡', 'æŠ˜æ‰£', 'é›¶å”®å•ä»·', 'æ—¥æœŸ', 'é˜¶æ®µçŠ¶æ€'];
            
            // ç¤ºä¾‹æ•°æ®
            const sampleData = [
                ['æ±Ÿè‹çœæŸå¤§å­¦æ•°æ®ä¸­å¿ƒå»ºè®¾é¡¹ç›®', 'ç½‘ç»œå®‰å…¨å­˜å‚¨è®¾å¤‡', 'NFX-GATW', 'ç½‘ç»œå­˜å‚¨å®‰å…¨ç½‘å…³', 'è‡ªç ”', 'å°', 1, 450000, 450000, 0.9, 500000, '2025/4/18', 'ç²¾è£…ä¿®'],
                ['æ±Ÿè‹çœæŸå¤§å­¦æ•°æ®ä¸­å¿ƒå»ºè®¾é¡¹ç›®', 'å®šå‘è€¦åˆå™¨', 'EVDC-6 LT', 'æ™ºèƒ½å®šå‘è€¦åˆæ£€æµ‹', 'è‡ªç ”', 'å°', 2, 35000, 70000, 0.85, 41176.47, '2025/4/18', 'ç²¾è£…ä¿®'],
                ['åŒ—äº¬æŸå­¦æ ¡å»ºç­‘æ”¹é€ å·¥ç¨‹', 'è¿ç»´å·¥å…·åŒ…', 'ACC-NUT', 'å†…å«å…¨å¥—ç³»ç»Ÿç»´æŠ¤å·¥å…·', 'åŸå‚', 'å¥—', 1, 10000, 10000, 1, 10000, '2025/4/15', 'åˆæ­¥è®¾è®¡']
            ];
            
            // å°†è¡¨å¤´å’Œç¤ºä¾‹æ•°æ®åˆå¹¶
            const wsData = [headers, ...sampleData];
            
            // åˆ›å»ºå·¥ä½œè¡¨
            const ws = XLSX.utils.aoa_to_sheet(wsData);
            
            // è®¾ç½®åˆ—å®½
            ws['!cols'] = [
                {wch: 35}, // é¡¹ç›®åç§°
                {wch: 20}, // äº§å“åç§°
                {wch: 15}, // å‹å·
                {wch: 25}, // æŒ‡æ ‡æè¿°
                {wch: 15}, // å“ç‰Œæƒ…å†µ
                {wch: 8},  // å•ä½
                {wch: 8},  // æ•°é‡
                {wch: 12}, // å•ä»·
                {wch: 12}, // åˆè®¡
                {wch: 8},  // æŠ˜æ‰£
                {wch: 12}, // é›¶å”®å•ä»·
                {wch: 12}, // æ—¥æœŸ
                {wch: 15}  // é˜¶æ®µçŠ¶æ€
            ];
            
            // è®¾ç½®å•å…ƒæ ¼æ ·å¼ï¼ˆæ¨¡æ‹Ÿï¼ŒçœŸå®æ ·å¼éœ€è¦å…¶ä»–åº“æ”¯æŒï¼‰
            // å¼ºè°ƒè¡¨å¤´
            for (let i = 0; i < headers.length; i++) {
                const cellRef = XLSX.utils.encode_cell({r: 0, c: i});
                if (!ws[cellRef]) ws[cellRef] = { v: headers[i] };
                ws[cellRef].s = { font: { bold: true }, fill: { fgColor: { rgb: "FFDDDDDD" } } };
            }
            
            // ä¸ºå·¥ä½œç°¿æ·»åŠ å·¥ä½œè¡¨
            XLSX.utils.book_append_sheet(wb, ws, "æŠ¥ä»·å•æ¨¡æ¿");
            
            // æ·»åŠ è¯´æ˜å·¥ä½œè¡¨
            const instrSheet = XLSX.utils.aoa_to_sheet([
                ['æŠ¥ä»·å•Excelå¯¼å…¥æ ¼å¼è¯´æ˜'],
                [''],
                ['1. è¡¨æ ¼å¿…é¡»åŒ…å«"é¡¹ç›®åç§°"åˆ—ï¼Œç³»ç»Ÿå°†æŒ‰æ­¤åˆ—åˆ†ç»„ç”ŸæˆæŠ¥ä»·å•'],
                ['2. å¿…è¦çš„åˆ—åŒ…æ‹¬ï¼šé¡¹ç›®åç§°ã€äº§å“åç§°ã€å‹å·ã€å•ä»·/æ•°é‡(æˆ–åˆè®¡)'],
                ['3. è¡¨å¤´åç§°è¦å°½é‡ä¸æ¨¡æ¿ä¿æŒä¸€è‡´ï¼Œå¦åˆ™å¯èƒ½æ— æ³•æ­£ç¡®è§£æ'],
                ['4. å¦‚æœåˆ—åè¢«åˆå¹¶å•å…ƒæ ¼ï¼Œå¯èƒ½ä¼šå½±å“å¯¼å…¥ï¼Œè¯·é¿å…ä½¿ç”¨åˆå¹¶å•å…ƒæ ¼'],
                ['5. æ‰€æœ‰æ•°å€¼åˆ—è¯·ç¡®ä¿æ˜¯æ•°å€¼æ ¼å¼ï¼Œé¿å…ä½¿ç”¨æ–‡æœ¬æ ¼å¼'],
                ['6. æ—¥æœŸå»ºè®®ä½¿ç”¨YYYY/MM/DDæ ¼å¼'],
                [''],
                ['å¦‚æœå¯¼å…¥å¤±è´¥ï¼Œè¯·å°è¯•ä»¥ä¸‹æ“ä½œï¼š'],
                ['1. ä½¿ç”¨æ­¤æ¨¡æ¿é‡æ–°å½•å…¥æ•°æ®'],
                ['2. ç¡®ä¿è¡¨å¤´æ˜¯ç¬¬ä¸€è¡Œï¼Œæ²¡æœ‰åˆå¹¶å•å…ƒæ ¼'],
                ['3. æ£€æŸ¥å¿…è¦åˆ—æ˜¯å¦å­˜åœ¨ä¸”å‘½åæ­£ç¡®'],
                ['4. ç¡®ä¿æ¯è¡Œæ•°æ®å¯¹åº”ä¸€ä¸ªäº§å“ï¼Œä¸”éƒ½æœ‰é¡¹ç›®åç§°']
            ]);
            
            // è®¾ç½®è¯´æ˜åˆ—å®½
            instrSheet['!cols'] = [{wch: 60}];
            
            // æ·»åŠ è¯´æ˜å·¥ä½œè¡¨
            XLSX.utils.book_append_sheet(wb, instrSheet, "ä½¿ç”¨è¯´æ˜");
            
            // å¯¼å‡ºExcelæ–‡ä»¶
            XLSX.writeFile(wb, "æŠ¥ä»·å•å¯¼å…¥æ¨¡æ¿.xlsx");
        });
    }

    // æ·»åŠ Excelè§£æé”™è¯¯è¯Šæ–­åŠŸèƒ½
    function analyzeExcelImportError(errorObj, fileName = '', possibleKeys = []) {
        console.error('Excelå¯¼å…¥é”™è¯¯åˆ†æ:', errorObj);
        
        let errorAnalysis = {
            message: 'æœªçŸ¥é”™è¯¯',
            possibleCauses: [],
            solutions: []
        };
        
        // æ ¹æ®é”™è¯¯ç±»å‹åˆ†æ
        if (errorObj instanceof Error) {
            errorAnalysis.message = errorObj.message;
            
            // æ£€æŸ¥å¸¸è§é”™è¯¯æ¨¡å¼
            if (errorObj.message.includes('Unexpected token') || errorObj.message.includes('JSON')) {
                errorAnalysis.possibleCauses.push('Excelæ–‡ä»¶æ ¼å¼è§£æå¤±è´¥');
                errorAnalysis.possibleCauses.push('æ–‡ä»¶å¯èƒ½å·²æŸåæˆ–æ ¼å¼ä¸å…¼å®¹');
                errorAnalysis.solutions.push('è¯·ä½¿ç”¨æ ‡å‡†Excelæ ¼å¼(.xlsx)é‡æ–°ä¿å­˜æ–‡ä»¶');
                errorAnalysis.solutions.push('é¿å…ä½¿ç”¨è¿‡æ—§ç‰ˆæœ¬çš„Excelæˆ–å…¶ä»–ç”µå­è¡¨æ ¼è½¯ä»¶åˆ›å»ºçš„æ–‡ä»¶');
            }
            else if (errorObj.message.includes('é¡¹ç›®åç§°')) {
                errorAnalysis.possibleCauses.push('æ‰¾ä¸åˆ°"é¡¹ç›®åç§°"åˆ—');
                errorAnalysis.possibleCauses.push('è¡¨å¤´è¡Œå¯èƒ½ä¸åœ¨ç¬¬ä¸€è¡Œ');
                errorAnalysis.possibleCauses.push('Excelä¸­çš„åˆ—åä¸ç³»ç»Ÿè¦æ±‚ä¸åŒ¹é…');
                
                if (possibleKeys && possibleKeys.length > 0) {
                    if (possibleKeys.some(k => k.startsWith('__EMPTY'))) {
                        errorAnalysis.possibleCauses.push('è¡¨å¤´æ ¼å¼å¼‚å¸¸ï¼Œæ£€æµ‹åˆ°ç©ºåˆ—å');
                        errorAnalysis.solutions.push('è¯·ç¡®ä¿Excelç¬¬ä¸€è¡ŒåŒ…å«æœ‰æ•ˆçš„åˆ—å');
                        errorAnalysis.solutions.push('é¿å…ä½¿ç”¨åˆå¹¶å•å…ƒæ ¼ä½œä¸ºè¡¨å¤´');
                    }
                }
                
                errorAnalysis.solutions.push('è¯·ä½¿ç”¨ç³»ç»Ÿæä¾›çš„Excelæ¨¡æ¿');
                errorAnalysis.solutions.push('ç¡®ä¿è¡¨æ ¼ç¬¬ä¸€è¡Œæ˜¯åˆ—åï¼Œä¸”åŒ…å«"é¡¹ç›®åç§°"åˆ—');
            }
            else if (errorObj.message.includes('read') || errorObj.message.includes('access')) {
                errorAnalysis.possibleCauses.push('æ— æ³•è¯»å–æ–‡ä»¶');
                errorAnalysis.possibleCauses.push('æ–‡ä»¶å¯èƒ½è¢«å…¶ä»–ç¨‹åºé”å®š');
                errorAnalysis.solutions.push('å…³é—­æ‰€æœ‰æ‰“å¼€çš„Excelç¨‹åºåé‡è¯•');
                errorAnalysis.solutions.push('é‡æ–°ä¸Šä¼ æ–‡ä»¶');
            }
        }
        
        // æ·»åŠ ä¸€äº›é€šç”¨çš„è§£å†³æ–¹æ¡ˆ
        if (errorAnalysis.solutions.length === 0) {
            errorAnalysis.solutions.push('ä¸‹è½½å¹¶ä½¿ç”¨ç³»ç»Ÿæä¾›çš„æ ‡å‡†Excelæ¨¡æ¿');
            errorAnalysis.solutions.push('ç¡®ä¿Excelç¬¬ä¸€è¡Œä¸ºåˆ—åï¼Œä¸”åŒ…å«å¿…è¦çš„åˆ—');
            errorAnalysis.solutions.push('é¿å…ä½¿ç”¨åˆå¹¶å•å…ƒæ ¼ã€å…¬å¼æˆ–ç‰¹æ®Šæ ¼å¼');
        }
        
        return errorAnalysis;
    }

    // å°†importModalæå‡ä¸ºå…¨å±€å”¯ä¸€å£°æ˜
    if (!importModal) {
        importModal = new bootstrap.Modal(document.getElementById('importQuotationModal'));
    }
    const closeImportResultBtn = document.getElementById('closeImportResultBtn');
    if (closeImportResultBtn) {
        closeImportResultBtn.addEventListener('click', function() {
            importModal.hide();
            if (needReloadAfterImport) {
                window.location.reload();
            }
        });
    }

    document.addEventListener('DOMContentLoaded', function() {
        // ... existing code ...
        // åˆå§‹åŒ–å¯¼å…¥æ¨¡æ€æ¡†
        if (!importModal) {
            importModal = new bootstrap.Modal(document.getElementById('importQuotationModal'));
        }
        const closeImportResultBtn = document.getElementById('closeImportResultBtn');
        if (closeImportResultBtn) {
            closeImportResultBtn.addEventListener('click', function() {
                importModal.hide();
                if (needReloadAfterImport) {
                    window.location.reload();
                }
            });
        }
        // ... existing code ...
    });
});

// æ»šåŠ¨åŠ è½½ç›¸å…³JavaScript
document.addEventListener('DOMContentLoaded', function() {
    // æ»šåŠ¨åŠ è½½ç›¸å…³å˜é‡
    let currentOffset = {{ offset + quotations|length }};
    let isLoading = false;
    let hasMore = {{ has_more | tojson }};
    const limit = {{ limit }};
    
    console.log('ğŸ”„ åˆå§‹åŒ–æ»šåŠ¨åŠ è½½çŠ¶æ€:');
    console.log('  å½“å‰åç§»é‡:', currentOffset);
    console.log('  æ˜¯å¦è¿˜æœ‰æ›´å¤šæ•°æ®:', hasMore);
    console.log('  æ¯é¡µé™åˆ¶:', limit);
    
    // è·å–å½“å‰URLå‚æ•° - å‚è€ƒå®¢æˆ·ç®¡ç†æ¨¡å—è®¾è®¡
    function getCurrentParams() {
        const url = new URL(window.location.href);
        return {
            search: url.searchParams.get('search'),
            project: url.searchParams.get('project'),
            sort: url.searchParams.get('sort'),
            order: url.searchParams.get('order'),
            owner_filter: url.searchParams.get('owner_filter'),
            project_type_filter: url.searchParams.get('project_type_filter'),
            project_stage_filter: url.searchParams.get('project_stage_filter')
        };
    }
    
    // åŠ è½½æ›´å¤šæ•°æ®
    function loadMoreData() {
        if (isLoading || !hasMore) return;
        
        isLoading = true;
        document.getElementById('loadingIndicator').classList.remove('d-none');
        
        const params = getCurrentParams();
        const url = new URL('{{ url_for("quotation.load_more_quotations") }}', window.location.origin);
        url.searchParams.set('offset', currentOffset);
        url.searchParams.set('limit', limit);
        
        // æ·»åŠ æ‰€æœ‰ç­›é€‰å‚æ•°
        if (params.search) url.searchParams.set('search', params.search);
        if (params.project) url.searchParams.set('project', params.project);
        if (params.sort) url.searchParams.set('sort', params.sort);
        if (params.order) url.searchParams.set('order', params.order);
        if (params.owner_filter) url.searchParams.set('owner_filter', params.owner_filter);
        if (params.project_type_filter) url.searchParams.set('project_type_filter', params.project_type_filter);
        if (params.project_stage_filter) url.searchParams.set('project_stage_filter', params.project_stage_filter);
        
        console.log('ğŸ“¡ åŠ è½½æ›´å¤šæ•°æ®è¯·æ±‚URL:', url.toString());
        
        fetch(url)
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    console.error('âŒ æœåŠ¡å™¨è¿”å›é”™è¯¯:', data.error);
                    hasMore = false;
                    return;
                }
                
                const tableBody = document.getElementById('quotationTableBody');
                const emptyRow = tableBody.querySelector('tr[id*="empty"]');
                
                // å¦‚æœæœ‰æ–°æ•°æ®ï¼Œæ·»åŠ åˆ°è¡¨æ ¼ä¸­
                if (data.html && data.html.trim()) {
                    // éšè—ç©ºæ•°æ®è¡Œï¼ˆå¦‚æœå­˜åœ¨ï¼‰
                    if (emptyRow) {
                        emptyRow.style.display = 'none';
                    }
                    tableBody.insertAdjacentHTML('beforeend', data.html);
                    console.log('âœ… æˆåŠŸè¿½åŠ ', (data.html.match(/<tr/g) || []).length, 'è¡Œæ•°æ®');
                } else {
                    console.log('âš ï¸ æ²¡æœ‰è¿”å›æ–°çš„HTMLæ•°æ®');
                }
                
                currentOffset = data.loaded_count || currentOffset;
                hasMore = data.has_more;
                
                console.log('ğŸ“Š æ›´æ–°çŠ¶æ€: offset=', currentOffset, ', hasMore=', hasMore);
                
                // é‡æ–°åˆå§‹åŒ–æ–°åŠ è½½å†…å®¹çš„äº‹ä»¶ç›‘å¬å™¨
                initializeQuotationEvents();
                
                if (!hasMore) {
                    document.getElementById('noMoreData').classList.remove('d-none');
                    console.log('ğŸ å·²åŠ è½½æ‰€æœ‰æ•°æ®ï¼Œåœæ­¢æ»šåŠ¨åŠ è½½');
                }
            })
            .catch(error => {
                console.error('åŠ è½½æ•°æ®å¤±è´¥:', error);
                // æ˜¾ç¤ºç”¨æˆ·å‹å¥½çš„é”™è¯¯æç¤º
                const tableBody = document.getElementById('quotationTableBody');
                tableBody.insertAdjacentHTML('beforeend', 
                    '<tr><td colspan="100%" class="text-center text-danger py-3">' +
                    '<i class="fas fa-exclamation-triangle me-2"></i>åŠ è½½æ•°æ®å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•' +
                    '</td></tr>'
                );
            })
            .finally(() => {
                isLoading = false;
                document.getElementById('loadingIndicator').classList.add('d-none');
            });
    }
    
    // é‡ç½®åˆ—è¡¨æ•°æ®
    function resetListData() {
        const tableBody = document.getElementById('quotationTableBody');
        // ä¿ç•™è¡¨å¤´ï¼Œæ¸…ç©ºæ•°æ®è¡Œ
        const rows = tableBody.querySelectorAll('tr:not([id*="empty"])');
        rows.forEach(row => row.remove());
        
        currentOffset = 0;
        hasMore = true;
        document.getElementById('noMoreData').classList.add('d-none');
        
        // æ»šåŠ¨åˆ°é¡µé¢é¡¶éƒ¨
        window.scrollTo({ top: 0, behavior: 'smooth' });
        
        // åŠ è½½ç¬¬ä¸€æ‰¹æ•°æ®
        loadMoreData();
    }
    
    // æ»šåŠ¨ç›‘å¬ä¼˜åŒ– - æé«˜é˜²æŠ–å»¶è¿Ÿå’Œæ”¹å–„è§¦å‘é€»è¾‘
    let scrollTimer;
    
    window.addEventListener('scroll', function() {
        clearTimeout(scrollTimer);
        scrollTimer = setTimeout(function() {
            // é˜²æ­¢é‡å¤è§¦å‘åŠ è½½ï¼ˆä½¿ç”¨å·²æœ‰çš„isLoadingçŠ¶æ€ï¼‰
            if (isLoading || !hasMore) {
                return;
            }
            
            // ä½¿ç”¨æ›´ç²¾ç¡®çš„æ»šåŠ¨è§¦å‘è®¡ç®—
            const scrollHeight = document.documentElement.scrollHeight;
            const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
            const clientHeight = window.innerHeight;
            
            // å½“æ»šåŠ¨åˆ°è·ç¦»åº•éƒ¨æ—¶å¼€å§‹åŠ è½½ï¼ˆå“åº”å¼é˜ˆå€¼ï¼‰
            const threshold = Math.min(800, clientHeight * 0.5); // æœ€å¤§800pxæˆ–è§†çª—é«˜åº¦çš„50%
            
            if (scrollTop + clientHeight >= scrollHeight - threshold) {
                loadMoreData();
            }
        }, 200); // å¢åŠ é˜²æŠ–å»¶è¿Ÿåˆ°200msï¼Œå‡å°‘è§¦å‘é¢‘ç‡
    }, { passive: true }); // ä½¿ç”¨passiveäº‹ä»¶ç›‘å¬å™¨æé«˜æ€§èƒ½
    
    // åˆå§‹åŒ–æŠ¥ä»·å•ç›¸å…³äº‹ä»¶ï¼ˆç”¨äºæ–°åŠ è½½çš„å†…å®¹ï¼‰
    function initializeQuotationEvents() {
        // é‡æ–°åˆå§‹åŒ–æ‰¹é‡é€‰æ‹©åŠŸèƒ½
        const quotationCheckboxes = document.querySelectorAll('.quotation-checkbox');
        quotationCheckboxes.forEach(checkbox => {
            if (!checkbox.hasAttribute('data-initialized')) {
                checkbox.addEventListener('change', updateBatchDeleteButton);
                checkbox.setAttribute('data-initialized', 'true');
            }
        });
        
        // é‡æ–°åˆå§‹åŒ–å…¶ä»–äº¤äº’åŠŸèƒ½
        // å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ å…¶ä»–éœ€è¦é‡æ–°ç»‘å®šçš„äº‹ä»¶
    }
    
    // åˆå§‹æ˜¾ç¤ºçŠ¶æ€è®¾ç½®
    if (!hasMore && currentOffset > 0) {
        document.getElementById('noMoreData').classList.remove('d-none');
    }
    
    // æ³¨æ„ï¼šç­›é€‰å’Œæœç´¢åŠŸèƒ½é€šè¿‡å·²æœ‰çš„äº‹ä»¶å¤„ç†ç¨‹åºå®ç°
    // ä¸è¦åœ¨è¿™é‡Œé‡å¤ç»‘å®šç­›é€‰äº‹ä»¶ï¼Œé¿å…ä¸ç°æœ‰ç­›é€‰åŠŸèƒ½å†²çª
});
</script>
{% endblock %}
