# æ‰¹ä»·å•å®¡æ‰¹æ•°é‡ä¿®æ”¹é—®é¢˜ä¿®å¤æ–¹æ¡ˆ

## ğŸš¨ é—®é¢˜æè¿°

**ç°è±¡**ï¼šæ‰¹ä»·å•å®¡æ‰¹é€šè¿‡åï¼Œç»“ç®—å•ä¸­äº§å“çš„æ˜ç»†æ•°é‡éƒ½å˜æˆäº†1ï¼Œè€ŒåŸæœ¬çš„æ•°é‡ä¸¢å¤±äº†ã€‚

**å½±å“**ï¼šè¿™ä¼šå¯¼è‡´ç»“ç®—é‡‘é¢é”™è¯¯ï¼Œä¸¥é‡å½±å“ä¸šåŠ¡æ•°æ®å‡†ç¡®æ€§ã€‚

## ğŸ” é—®é¢˜æ ¹å› åˆ†æ

### 1. æƒé™æ§åˆ¶æ­£ç¡®
- åç«¯æƒé™è®¾ç½®æ­£ç¡®ï¼šå®¡æ‰¹çŠ¶æ€ä¸‹ `can_edit_quantity` è¿”å› `False`
- å‰ç«¯æ¨¡æ¿æ­£ç¡®ï¼šå®¡æ‰¹çŠ¶æ€ä¸‹æ•°é‡å­—æ®µæ˜¾ç¤ºä¸ºæ–‡æœ¬è€Œä¸æ˜¯è¾“å…¥æ¡†

### 2. å‰ç«¯æ•°æ®æ”¶é›†é”™è¯¯
**é—®é¢˜ä»£ç **ï¼š`app/templates/pricing_order/edit_pricing_order.html` ç¬¬4243è¡Œ
```javascript
const quantity = parseInt($row.find('.quantity').val()) || 1;
```

**é—®é¢˜åŸå› **ï¼š
- å®¡æ‰¹çŠ¶æ€ä¸‹ï¼Œæ•°é‡å­—æ®µæ¸²æŸ“ä¸º `{{ detail.quantity }}` æ–‡æœ¬ï¼Œæ²¡æœ‰ `.quantity` è¾“å…¥æ¡†
- JavaScriptå°è¯•ä»ä¸å­˜åœ¨çš„è¾“å…¥æ¡†è·å–å€¼ï¼Œå¾—åˆ° `undefined`
- `parseInt(undefined)` è¿”å› `NaN`ï¼Œç„¶åä½¿ç”¨é»˜è®¤å€¼ `1`

### 3. åç«¯ä¿å­˜é€»è¾‘é—®é¢˜
**é—®é¢˜ä»£ç **ï¼š`app/services/pricing_order_service.py` ç¬¬1301è¡Œ
```python
if 'quantity' in detail_data:
    old_quantity = detail.quantity
    detail.quantity = int(detail_data['quantity'])
```

**é—®é¢˜åŸå› **ï¼š
- å®¡æ‰¹æ—¶ä¸åº”è¯¥å…è®¸ä¿®æ”¹æ•°é‡ï¼Œä½†ä»£ç ä»ä¼šå¤„ç† `quantity` å­—æ®µ
- å‰ç«¯ä¼ é€’çš„é”™è¯¯æ•°é‡å€¼ï¼ˆ1ï¼‰è¢«ç›´æ¥ä¿å­˜åˆ°æ•°æ®åº“

## ğŸ› ï¸ ä¿®å¤æ–¹æ¡ˆ

### æ–¹æ¡ˆ1ï¼šå‰ç«¯ä¿®å¤ï¼ˆæ¨èï¼‰
ä¿®æ”¹å‰ç«¯æ•°æ®æ”¶é›†é€»è¾‘ï¼Œæ­£ç¡®å¤„ç†å®¡æ‰¹çŠ¶æ€ä¸‹çš„æ•°é‡è·å–ã€‚

#### ä¿®å¤ä½ç½®ï¼š`collectSettlementDetails()` å‡½æ•°

```javascript
// ä¿®å¤å‰
const quantity = parseInt($row.find('.quantity').val()) || 1;

// ä¿®å¤å
let quantity = 1; // é»˜è®¤å€¼
const $quantityInput = $row.find('input.quantity');
if ($quantityInput.length > 0) {
    // å¦‚æœæ‰¾åˆ°è¾“å…¥æ¡†ï¼Œä»è¾“å…¥æ¡†è·å–
    quantity = parseInt($quantityInput.val()) || 1;
} else {
    // å¦‚æœæ²¡æœ‰è¾“å…¥æ¡†ï¼ˆå®¡æ‰¹çŠ¶æ€ï¼‰ï¼Œä»æ–‡æœ¬ä¸­æå–æ•°é‡
    const $quantityCell = $row.find('td').eq(7); // æ•°é‡æ˜¯ç¬¬8åˆ—ï¼ˆä»0å¼€å§‹æ˜¯7ï¼‰
    const quantityText = $quantityCell.text().trim();
    const quantityMatch = quantityText.match(/^\\d+/);
    if (quantityMatch) {
        quantity = parseInt(quantityMatch[0]) || 1;
    }
}
```

### æ–¹æ¡ˆ2ï¼šåç«¯æƒé™å¼ºåŒ–ï¼ˆå¿…éœ€ï¼‰
åœ¨å®¡æ‰¹ä¿å­˜æ—¶ï¼Œä¸¥æ ¼ç¦æ­¢ä¿®æ”¹æ•°é‡å­—æ®µã€‚

#### ä¿®å¤ä½ç½®ï¼š`save_approval_data()` å‡½æ•°

```python
# ä¿®å¤å‰
if 'quantity' in detail_data:
    old_quantity = detail.quantity
    detail.quantity = int(detail_data['quantity'])

# ä¿®å¤å
if 'quantity' in detail_data:
    # ğŸ”¥ å…³é”®ä¿®å¤ï¼šå®¡æ‰¹çŠ¶æ€ä¸‹ä¸¥ç¦ä¿®æ”¹æ•°é‡
    if pricing_order.status == 'pending':
        logger.warning(f"å®¡æ‰¹çŠ¶æ€ä¸‹æ‹’ç»ä¿®æ”¹æ•°é‡ï¼šäº§å“={product_name}, å°è¯•ä» {detail.quantity} æ”¹ä¸º {detail_data['quantity']}")
    else:
        old_quantity = detail.quantity
        detail.quantity = int(detail_data['quantity'])
        logger.info(f"æ›´æ–°ç»“ç®—å•æ˜ç»† {detail.id}: æ•°é‡ä» {old_quantity} æ›´æ–°ä¸º {detail.quantity}")
```

### æ–¹æ¡ˆ3ï¼šå‰ç«¯æ¨¡æ¿å¢å¼ºï¼ˆå¯é€‰ï¼‰
åœ¨å®¡æ‰¹çŠ¶æ€ä¸‹æ·»åŠ éšè—çš„æ•°é‡å­—æ®µï¼Œä¾›JavaScriptè¯»å–ã€‚

```html
<!-- ä¿®å¤å‰ -->
{% if can_edit_quantity %}
<input type="number" class="form-control quantity" value="{{ detail.quantity }}">
{% else %}
{{ detail.quantity }}
{% endif %}

<!-- ä¿®å¤å -->
{% if can_edit_quantity %}
<input type="number" class="form-control quantity" value="{{ detail.quantity }}">
{% else %}
{{ detail.quantity }}
<input type="hidden" class="quantity" value="{{ detail.quantity }}">
{% endif %}
```

## ğŸš€ ç«‹å³ä¿®å¤æ­¥éª¤

### ç¬¬1æ­¥ï¼šå‰ç«¯ç´§æ€¥ä¿®å¤
```javascript
// åœ¨æµè§ˆå™¨æ§åˆ¶å°æ‰§è¡Œä»¥ä¸‹ä»£ç è¿›è¡Œä¸´æ—¶ä¿®å¤
function fixQuantityCollection() {
    window.collectSettlementDetails = function() {
        const details = [];
        const $settlementTable = $('#settlementTable');
        if ($settlementTable.length === 0) {
            console.log('ç»“ç®—å•è¡¨æ ¼ä¸å­˜åœ¨ï¼Œè¿”å›ç©ºæ•°ç»„');
            return details;
        }
        
        $settlementTable.find('tbody tr').each(function() {
            const $row = $(this);
            const $productNameInput = $row.find('.product-name');
            
            if ($productNameInput.length === 0) {
                return true;
            }
            
            const productName = $productNameInput.val();
            if (!productName || !productName.trim()) {
                return true;
            }
            
            const id = $row.data('id');
            
            // ğŸ”¥ ä¿®å¤æ•°é‡è·å–é€»è¾‘
            let quantity = 1;
            const $quantityInput = $row.find('input.quantity');
            if ($quantityInput.length > 0) {
                quantity = parseInt($quantityInput.val()) || 1;
            } else {
                // ä»æ•°é‡åˆ—çš„æ–‡æœ¬ä¸­æå–ï¼ˆç¬¬8åˆ—ï¼Œç´¢å¼•7ï¼‰
                const $quantityCell = $row.find('td').eq(7);
                const quantityText = $quantityCell.text().trim();
                const quantityMatch = quantityText.match(/^\\d+/);
                if (quantityMatch) {
                    quantity = parseInt(quantityMatch[0]) || 1;
                }
            }
            
            const marketPrice = parseFloat($row.find('.product-price').data('raw-value')) || parseFloat($row.find('.product-price').val().replace(/[^\\d.]/g, '')) || 0;
            const unitPrice = parseFloat($row.find('.discounted-price').data('raw-value')) || parseFloat($row.find('.discounted-price').val().replace(/[^\\d.]/g, '')) || 0;
            const discountRate = parseFloat($row.find('.discount-rate').val()) || 100;
            
            console.log(`ä¿®å¤åæ”¶é›† - äº§å“: ${productName}, æ•°é‡: ${quantity}, å•ä»·: ${unitPrice}`);
            
            details.push({
                id: id,
                product_name: productName.trim(),
                product_model: $row.find('.product-model').val() || '',
                product_desc: $row.find('.product-spec').val() || '',
                brand: $row.find('.product-brand').val() || '',
                unit: $row.find('.product-unit').val() || 'å°',
                product_mn: $row.find('.product-mn').val() || '',
                market_price: marketPrice,
                quantity: quantity, // ä¿®å¤åçš„æ•°é‡
                discount_rate: discountRate,
                unit_price: unitPrice
            });
        });
        
        console.log('ä¿®å¤åæ”¶é›†åˆ°çš„ç»“ç®—å•æ˜ç»†:', details);
        return details;
    };
    
    console.log('âœ… æ•°é‡æ”¶é›†é€»è¾‘å·²ä¿®å¤ï¼');
}

// æ‰§è¡Œä¿®å¤
fixQuantityCollection();
```

### ç¬¬2æ­¥ï¼šéªŒè¯ä¿®å¤æ•ˆæœ
1. åœ¨å®¡æ‰¹é¡µé¢æ‰“å¼€æµè§ˆå™¨æ§åˆ¶å°
2. æ‰§è¡Œä¸Šè¿°ä¿®å¤ä»£ç 
3. æ¨¡æ‹Ÿç‚¹å‡»å®¡æ‰¹é€šè¿‡ï¼Œè§‚å¯Ÿæ§åˆ¶å°è¾“å‡ºçš„æ•°é‡æ˜¯å¦æ­£ç¡®

### ç¬¬3æ­¥ï¼šä»£ç å±‚é¢ä¿®å¤
æˆ‘å°†ç«‹å³ä¿®æ”¹ç›¸å…³ä»£ç æ–‡ä»¶ï¼Œç¡®ä¿é—®é¢˜æ°¸ä¹…è§£å†³ã€‚

## ğŸ¯ é¢„æœŸæ•ˆæœ

ä¿®å¤åï¼š
- âœ… å®¡æ‰¹è¿‡ç¨‹ä¸­ä¸ä¼šä¿®æ”¹äº§å“æ•°é‡
- âœ… ç»“ç®—å•æ•°é‡ä¿æŒåŸå§‹å€¼ä¸å˜
- âœ… åªæœ‰æŠ˜æ‰£ç‡å’Œå•ä»·å¯ä»¥åœ¨å®¡æ‰¹ä¸­è°ƒæ•´
- âœ… æ€»é‡‘é¢è®¡ç®—å‡†ç¡®ï¼ŒåŸºäºæ­£ç¡®çš„æ•°é‡

## ğŸ“‹ æµ‹è¯•æ¸…å•

- [ ] åˆ›å»ºæ‰¹ä»·å•ï¼Œè®¾ç½®ä¸åŒäº§å“æ•°é‡ï¼ˆå¦‚2ã€5ã€10ï¼‰
- [ ] æäº¤å®¡æ‰¹
- [ ] å®¡æ‰¹äººç™»å½•ï¼Œç¡®è®¤æ•°é‡å­—æ®µä¸ºåªè¯»
- [ ] è°ƒæ•´æŠ˜æ‰£ç‡åç‚¹å‡»é€šè¿‡
- [ ] éªŒè¯å®¡æ‰¹é€šè¿‡åæ•°é‡ä¿æŒä¸å˜
- [ ] æ£€æŸ¥ç»“ç®—å•æ€»é‡‘é¢æ˜¯å¦æ­£ç¡®

ä¿®å¤å®Œæˆåï¼Œæ­¤é—®é¢˜å°†ä¸å†å‡ºç°ï¼Œç¡®ä¿ä¸šåŠ¡æ•°æ®çš„å‡†ç¡®æ€§å’Œå®Œæ•´æ€§ã€‚ 