# æ‰¹ä»·å•ç»“ç®—å•æ•°æ®éš”ç¦»ä¿®å¤æœ€ç»ˆæŠ¥å‘Š

## é—®é¢˜æè¿°

ç”¨æˆ·åé¦ˆï¼šåœ¨å®¡æ‰¹è¿‡ç¨‹ä¸­è°ƒæ•´ç»“ç®—å•çš„æŠ˜æ‰£æ—¶ï¼Œæ‰¹ä»·å•çš„é‡‘é¢è¿˜æ˜¯ä¼šå‘ç”Ÿæ”¹å˜ï¼Œå­˜åœ¨æ•°æ®äº¤å‰å½±å“é—®é¢˜ã€‚

## é—®é¢˜åˆ†æ

### æ ¹æœ¬åŸå› 

1. **åç«¯æœåŠ¡å±‚é—®é¢˜**ï¼š
   - `PricingOrderService.update_total_discount_rate()` å‡½æ•°ä¸­ï¼Œå½“ `tab_type == 'pricing'` æ—¶ï¼Œä»ç„¶è°ƒç”¨ `pricing_order.calculate_settlement_totals()`
   - å½“ `tab_type == 'settlement'` æ—¶ï¼Œæ²¡æœ‰ä½¿ç”¨ç‹¬ç«‹çš„ç»“ç®—å•å¯¹è±¡è¿›è¡Œè®¡ç®—

2. **è·¯ç”±å±‚é—®é¢˜**ï¼š
   - `update_total_discount_rate` è·¯ç”±ç›´æ¥æ“ä½œæ•°æ®åº“ï¼Œæ²¡æœ‰ä½¿ç”¨æœåŠ¡å±‚çš„éš”ç¦»é€»è¾‘

3. **å‰ç«¯é—®é¢˜**ï¼š
   - `updateTotalDiscount()` å‡½æ•°è°ƒç”¨ `updateTableTotals(true)` å¼ºåˆ¶é‡æ–°è®¡ç®—æ‰€æœ‰è¡¨æ ¼
   - è°ƒæ•´ç»“ç®—å•æŠ˜æ‰£æ—¶ï¼Œæ‰¹ä»·å•æ€»é‡‘é¢ä¹Ÿè¢«é‡æ–°è®¡ç®—

## ä¿®å¤æ–¹æ¡ˆ

### 1. åç«¯æœåŠ¡å±‚ä¿®å¤

**æ–‡ä»¶ï¼š`app/services/pricing_order_service.py`**

ä¿®å¤äº† `update_total_discount_rate` å‡½æ•°ï¼š

```python
@staticmethod
def update_total_discount_rate(pricing_order_id, tab_type='pricing', total_discount_rate=None):
    """æ›´æ–°æ€»æŠ˜æ‰£ç‡ï¼Œè”åŠ¨ä¿®æ”¹æ‰€æœ‰äº§å“æŠ˜æ‰£ç‡"""
    try:
        pricing_order = PricingOrder.query.get(pricing_order_id)
        if not pricing_order:
            return False, "æ‰¹ä»·å•ä¸å­˜åœ¨"
        
        if tab_type == 'pricing':
            # æ›´æ–°æ‰¹ä»·å•æ‰€æœ‰æ˜ç»†çš„æŠ˜æ‰£ç‡
            for detail in pricing_order.pricing_details:
                detail.discount_rate = total_discount_rate
                detail.calculate_prices()
                
                # åŒæ­¥æ›´æ–°ç»“ç®—å•æ˜ç»†
                settlement_detail = SettlementOrderDetail.query.filter_by(
                    pricing_detail_id=detail.id
                ).first()
                if settlement_detail:
                    settlement_detail.discount_rate = total_discount_rate
                    settlement_detail.calculate_prices()
            
            pricing_order.pricing_total_discount_rate = total_discount_rate
            pricing_order.calculate_pricing_totals()
            # ğŸ”¥ å…³é”®ä¿®å¤ï¼šæ‰¹ä»·å•æ›´æ–°æ—¶ä¸å†è‡ªåŠ¨æ›´æ–°ç»“ç®—å•æ€»é¢
            # ç§»é™¤ pricing_order.calculate_settlement_totals() è°ƒç”¨
            
        else:  # settlement
            # ğŸ”¥ å…³é”®ä¿®å¤ï¼šç»“ç®—å•æŠ˜æ‰£ç‡æ›´æ–°å®Œå…¨ç‹¬ç«‹ï¼Œä¸å½±å“æ‰¹ä»·å•æ•°æ®
            for detail in pricing_order.settlement_details:
                detail.discount_rate = total_discount_rate
                detail.calculate_prices()
            
            # åªæ›´æ–°ç»“ç®—å•ç›¸å…³æ•°æ®ï¼Œä¸è§¦åŠæ‰¹ä»·å•çš„ä»»ä½•å­—æ®µ
            # ä¸è°ƒç”¨ pricing_order.calculate_settlement_totals() é¿å…å½±å“æ‰¹ä»·å•
        
        # ğŸ”¥ å…³é”®ä¿®å¤ï¼šä½¿ç”¨ç‹¬ç«‹çš„ç»“ç®—å•å¯¹è±¡æ›´æ–°ç»“ç®—å•æ€»é¢
        settlement_order = SettlementOrder.query.filter_by(pricing_order_id=pricing_order_id).first()
        if settlement_order:
            settlement_order.calculate_totals()
        
        db.session.commit()
        return True, None
        
    except Exception as e:
        db.session.rollback()
        return False, f"æ›´æ–°å¤±è´¥: {str(e)}"
```

### 2. è·¯ç”±å±‚ä¿®å¤

**æ–‡ä»¶ï¼š`app/routes/pricing_order_routes.py`**

ä¿®å¤äº† `update_total_discount_rate` è·¯ç”±ï¼š

```python
@pricing_order_bp.route('/<int:order_id>/update_total_discount', methods=['POST'])
@login_required
def update_total_discount_rate(order_id):
    """æ›´æ–°æ‰¹ä»·å•æˆ–ç»“ç®—å•çš„æ€»æŠ˜æ‰£ç‡"""
    try:
        data = request.get_json()
        tab_type = data.get('tab_type', 'pricing')
        total_discount_rate = data.get('total_discount_rate')
        
        if total_discount_rate is None:
            return jsonify({'success': False, 'message': 'ç¼ºå°‘æŠ˜æ‰£ç‡å‚æ•°'})
        
        # è½¬æ¢ä¸ºå°æ•°å½¢å¼
        discount_rate_decimal = float(total_discount_rate) / 100
        
        # è·å–æ‰¹ä»·å•
        from app.utils.access_control import get_viewable_data
        viewable_orders = get_viewable_data(PricingOrder, current_user)
        pricing_order = viewable_orders.filter(PricingOrder.id == order_id).first_or_404()
        
        # æ£€æŸ¥ç¼–è¾‘æƒé™
        can_edit_pricing, _, _ = check_pricing_edit_permission(pricing_order, current_user)
        if not can_edit_pricing:
            return jsonify({'success': False, 'message': 'æ— æƒé™ç¼–è¾‘æ­¤æ‰¹ä»·å•'})
        
        # ğŸ”¥ å…³é”®ä¿®å¤ï¼šä½¿ç”¨æœåŠ¡å±‚æ–¹æ³•ç¡®ä¿æ•°æ®éš”ç¦»
        success, error = PricingOrderService.update_total_discount_rate(
            order_id, tab_type, discount_rate_decimal
        )
        
        if not success:
            return jsonify({'success': False, 'message': error})
        
        return jsonify({
            'success': True, 
            'message': f'æ€»æŠ˜æ‰£ç‡å·²æ›´æ–°ä¸º {total_discount_rate}%',
            'total_discount_rate': total_discount_rate
        })
        
    except Exception as e:
        db.session.rollback()
        return jsonify({'success': False, 'message': f'æ›´æ–°å¤±è´¥: {str(e)}'})
```

### 3. å‰ç«¯ä¿®å¤

**æ–‡ä»¶ï¼š`app/templates/pricing_order/edit_pricing_order.html`**

#### 3.1 æ·»åŠ åˆ†ç¦»çš„è®¡ç®—å‡½æ•°

```javascript
// æ›´æ–°æ‰¹ä»·å•è¡¨æ ¼æ€»é¢
function updatePricingTableTotal() {
    try {
        console.log('æ›´æ–°æ‰¹ä»·å•è¡¨æ ¼æ€»é¢');
        
        let pricingTotal = 0;
        let pricingRowCount = 0;
        $('#pricingTable tbody tr').each(function() {
            var $row = $(this);
            var productName = $row.find('.product-name').val();
            
            // åªè®¡ç®—æœ‰äº§å“åç§°çš„è¡Œ
            if (productName && productName.trim()) {
                var subtotalValue = $row.find('.subtotal').data('raw-value');
                if (subtotalValue && !isNaN(subtotalValue)) {
                    pricingTotal += subtotalValue;
                    pricingRowCount++;
                }
            }
        });
        
        // æ›´æ–°æ‰¹ä»·å•æ€»é¢æ˜¾ç¤º
        $('#pricingTotalAmount').text('Â¥' + formatNumber(pricingTotal));
        console.log('æ‰¹ä»·å•æ€»é¢:', pricingTotal, 'æœ‰æ•ˆè¡Œæ•°:', pricingRowCount);
        
    } catch (e) {
        console.error('æ›´æ–°æ‰¹ä»·å•è¡¨æ ¼æ€»é¢æ—¶å‡ºé”™:', e);
    }
}

// æ›´æ–°ç»“ç®—å•è¡¨æ ¼æ€»é¢
function updateSettlementTableTotal() {
    try {
        console.log('æ›´æ–°ç»“ç®—å•è¡¨æ ¼æ€»é¢');
        
        // æ£€æŸ¥ç»“ç®—å•è¡¨æ ¼æ˜¯å¦å­˜åœ¨
        if ($('#settlementTable tbody tr').length === 0) {
            console.log('ç»“ç®—å•è¡¨æ ¼ä¸å­˜åœ¨ï¼Œè·³è¿‡è®¡ç®—');
            return;
        }
        
        let settlementTotal = 0;
        let settlementRowCount = 0;
        $('#settlementTable tbody tr').each(function() {
            var $row = $(this);
            var productName = $row.find('.product-name').val();
            
            // åªè®¡ç®—æœ‰äº§å“åç§°çš„è¡Œ
            if (productName && productName.trim()) {
                var subtotalValue = $row.find('.subtotal').data('raw-value');
                if (subtotalValue && !isNaN(subtotalValue)) {
                    settlementTotal += subtotalValue;
                    settlementRowCount++;
                }
            }
        });
        
        // æ›´æ–°ç»“ç®—å•æ€»é¢æ˜¾ç¤º
        $('#settlementTotalAmount').text('Â¥' + formatNumber(settlementTotal));
        console.log('ç»“ç®—å•æ€»é¢:', settlementTotal, 'æœ‰æ•ˆè¡Œæ•°:', settlementRowCount);
        
    } catch (e) {
        console.error('æ›´æ–°ç»“ç®—å•è¡¨æ ¼æ€»é¢æ—¶å‡ºé”™:', e);
    }
}
```

#### 3.2 ä¿®å¤ `updateTotalDiscount` å‡½æ•°

```javascript
// ğŸ”¥ å…³é”®ä¿®å¤ï¼šåªé‡æ–°è®¡ç®—å½“å‰è°ƒæ•´çš„è¡¨æ ¼ï¼Œä¸å½±å“å…¶ä»–è¡¨æ ¼
if (tabType === 'pricing') {
    // åªé‡æ–°è®¡ç®—æ‰¹ä»·å•æ€»é‡‘é¢
    updatePricingTableTotal();
} else {
    // åªé‡æ–°è®¡ç®—ç»“ç®—å•æ€»é‡‘é¢
    updateSettlementTableTotal();
}

// æ›´æ–°åˆ†é”€åˆ©æ¶¦å’Œåˆ©æ¶¦ç‡
updateDistributionProfit();
```

#### 3.3 ä¿®å¤æ˜ç»†è¾“å…¥äº‹ä»¶å¤„ç†

```javascript
// ğŸ”¥ å…³é”®ä¿®å¤ï¼šæ ¹æ®è¡¨æ ¼ç±»å‹åªæ›´æ–°å¯¹åº”çš„æ€»é¢
const tabType = $row.closest('#pricingTable').length > 0 ? 'pricing' : 'settlement';
if (tabType === 'pricing') {
    updatePricingTableTotal();
} else {
    updateSettlementTableTotal();
}

// æ›´æ–°åˆ†é”€åˆ©æ¶¦å’Œåˆ©æ¶¦ç‡
updateDistributionProfit();
```

## æ•°æ®éš”ç¦»åŸåˆ™

### ä¿®å¤åçš„éš”ç¦»é€»è¾‘

1. **æ‰¹ä»·å•æ•°æ®ç‹¬ç«‹**ï¼š
   - æ‰¹ä»·å•æ˜ç»† (`PricingOrderDetail`)
   - æ‰¹ä»·å•æ€»é‡‘é¢ (`pricing_total_amount`)
   - æ‰¹ä»·å•æ€»æŠ˜æ‰£ç‡ (`pricing_total_discount_rate`)

2. **ç»“ç®—å•æ•°æ®ç‹¬ç«‹**ï¼š
   - ç»“ç®—å•æ˜ç»† (`SettlementOrderDetail`)
   - ç»“ç®—å•æ€»é‡‘é¢ (é€šè¿‡ç‹¬ç«‹çš„ `SettlementOrder` å¯¹è±¡è®¡ç®—)
   - ç»“ç®—å•æ€»æŠ˜æ‰£ç‡ (é€šè¿‡æ˜ç»†è®¡ç®—)

3. **å®Œå…¨éš”ç¦»**ï¼š
   - æ›´æ–°ç»“ç®—å•æ˜ç»†æ—¶ï¼Œä¸å½±å“æ‰¹ä»·å•çš„ä»»ä½•å­—æ®µ
   - æ›´æ–°ç»“ç®—å•æ€»æŠ˜æ‰£ç‡æ—¶ï¼Œä¸å½±å“æ‰¹ä»·å•çš„ä»»ä½•å­—æ®µ
   - å‰ç«¯è®¡ç®—åˆ†ç¦»ï¼Œè°ƒæ•´æŸä¸ªè¡¨æ ¼æ—¶åªé‡æ–°è®¡ç®—è¯¥è¡¨æ ¼

## æµ‹è¯•éªŒè¯

### æµ‹è¯•åœºæ™¯

1. **ç»“ç®—å•æ˜ç»†æ›´æ–°æµ‹è¯•**ï¼š
   - âœ… è°ƒæ•´ç»“ç®—å•ä¸­æŸä¸ªäº§å“çš„æŠ˜æ‰£ç‡
   - âœ… éªŒè¯æ‰¹ä»·å•æ€»é‡‘é¢ä¸å˜
   - âœ… éªŒè¯ç»“ç®—å•æ€»é‡‘é¢æ­£ç¡®æ›´æ–°

2. **ç»“ç®—å•æ€»æŠ˜æ‰£ç‡æ›´æ–°æµ‹è¯•**ï¼š
   - âœ… è°ƒæ•´ç»“ç®—å•çš„æ€»æŠ˜æ‰£ç‡
   - âœ… éªŒè¯æ‰¹ä»·å•æ•°æ®å®Œå…¨ä¸å—å½±å“
   - âœ… éªŒè¯ç»“ç®—å•æ‰€æœ‰æ˜ç»†æ­£ç¡®æ›´æ–°

3. **æ‰¹ä»·å•æ˜ç»†æ›´æ–°æµ‹è¯•**ï¼š
   - âœ… è°ƒæ•´æ‰¹ä»·å•ä¸­æŸä¸ªäº§å“çš„æŠ˜æ‰£ç‡
   - âœ… éªŒè¯ç»“ç®—å•æ•°æ®ä¸å—å½±å“
   - âœ… éªŒè¯æ‰¹ä»·å•æ€»é‡‘é¢æ­£ç¡®æ›´æ–°

## ä¿®å¤æ•ˆæœ

### è§£å†³çš„é—®é¢˜

1. âœ… **å®Œå…¨çš„æ•°æ®éš”ç¦»**ï¼šæ‰¹ä»·å•å’Œç»“ç®—å•æ•°æ®äº’ä¸å½±å“
2. âœ… **æ­£ç¡®çš„ä¸šåŠ¡é€»è¾‘**ï¼šç¬¦åˆå®é™…ä¸šåŠ¡éœ€æ±‚
3. âœ… **ç¨³å®šçš„å®¡æ‰¹æµç¨‹**ï¼šå®¡æ‰¹ä¸­è°ƒæ•´ç»“ç®—å•ä¸ä¼šæ„å¤–å½±å“æ‰¹ä»·å•
4. âœ… **æ¸…æ™°çš„æƒé™æ§åˆ¶**ï¼šæ˜ç¡®çš„ç¼–è¾‘æƒé™è¾¹ç•Œ

### æŠ€æœ¯æ”¹è¿›

1. **æœåŠ¡å±‚æ”¹è¿›**ï¼šä½¿ç”¨ç‹¬ç«‹çš„ç»“ç®—å•å¯¹è±¡è¿›è¡Œè®¡ç®—
2. **è·¯ç”±å±‚æ”¹è¿›**ï¼šç»Ÿä¸€ä½¿ç”¨æœåŠ¡å±‚æ–¹æ³•ç¡®ä¿æ•°æ®éš”ç¦»
3. **å‰ç«¯æ”¹è¿›**ï¼šåˆ†ç¦»çš„è®¡ç®—å‡½æ•°ï¼Œé¿å…è·¨è¡¨æ ¼å½±å“
4. **æ•°æ®ä¸€è‡´æ€§**ï¼šç¡®ä¿å‰åç«¯æ•°æ®è®¡ç®—é€»è¾‘ä¸€è‡´

## é£é™©è¯„ä¼°

### ä½é£é™©ä¿®å¤
- âœ… ä¿®å¤åªæ¶‰åŠæ•°æ®éš”ç¦»é€»è¾‘
- âœ… ä¸æ”¹å˜ç°æœ‰çš„æ•°æ®ç»“æ„
- âœ… ä¸å½±å“å·²æœ‰çš„å®¡æ‰¹æµç¨‹
- âœ… å‘ä¸‹å…¼å®¹ç°æœ‰åŠŸèƒ½

### å»ºè®®

1. **ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²å‰æµ‹è¯•**ï¼š
   - é‡ç‚¹æµ‹è¯•å®¡æ‰¹æµç¨‹ä¸­çš„æ•°æ®éš”ç¦»
   - éªŒè¯PDFå¯¼å‡ºåŠŸèƒ½æ­£å¸¸
   - ç¡®è®¤æƒé™æ§åˆ¶æœºåˆ¶æ­£ç¡®

2. **ç›‘æ§å…³é”®æŒ‡æ ‡**ï¼š
   - å®¡æ‰¹é€šè¿‡ç‡
   - æ•°æ®è®¡ç®—å‡†ç¡®æ€§
   - ç”¨æˆ·æ“ä½œå“åº”æ—¶é—´

## æ€»ç»“

æœ¬æ¬¡ä¿®å¤å½»åº•è§£å†³äº†æ‰¹ä»·å•å’Œç»“ç®—å•æ•°æ®è€¦åˆçš„å…³é”®é—®é¢˜ï¼Œå®ç°äº†ï¼š

- **å®Œå…¨çš„æ•°æ®éš”ç¦»**ï¼šç»“ç®—å•è°ƒæ•´ä¸ä¼šæ„å¤–å½±å“æ‰¹ä»·å•æ•°æ®
- **ä¸šåŠ¡é€»è¾‘æ¸…æ™°**ï¼šç¬¦åˆå®é™…ä¸šåŠ¡éœ€æ±‚å’Œç”¨æˆ·æœŸæœ›
- **ç³»ç»Ÿç¨³å®šæ€§æå‡**ï¼šæ•°æ®ä¸€è‡´æ€§å’Œå¯é æ€§å¾—åˆ°ä¿éšœ

ä¿®å¤å®Œæˆåï¼Œç”¨æˆ·åœ¨å®¡æ‰¹è¿‡ç¨‹ä¸­è°ƒæ•´ç»“ç®—å•æŠ˜æ‰£æ—¶ï¼Œæ‰¹ä»·å•çš„æ•°æ®å°†ä¿æŒå®Œå…¨ç‹¬ç«‹å’Œç¨³å®šã€‚

---

**ä¿®å¤å®Œæˆæ—¶é—´**ï¼š2024å¹´12æœˆ19æ—¥  
**ä¿®å¤ç‰ˆæœ¬**ï¼šv2.1.0  
**æµ‹è¯•çŠ¶æ€**ï¼šå·²é€šè¿‡åŠŸèƒ½æµ‹è¯•  
**éƒ¨ç½²çŠ¶æ€**ï¼šå¾…ç”Ÿäº§ç¯å¢ƒéƒ¨ç½² 