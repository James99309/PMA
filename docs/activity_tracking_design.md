# 项目活跃度跟踪设计

## 1. 概述

项目活跃度跟踪是跟踪和标记项目更新状态的功能。系统会根据指定的活跃度规则，自动判断项目是否活跃，并更新活跃状态标签，以便用户能够迅速识别需要关注的项目。

## 2. 活跃度判断逻辑

项目活跃度判断基于以下多项条件，任何一项满足都将使项目被标记为"活跃"：

1. **项目基本信息更新**：项目的基础数据字段被修改，如项目名称、描述等，更新了项目的 `updated_at` 时间戳
2. **项目阶段推进变更**：项目的阶段状态发生变化，如从"机会阶段"推进到"方案阶段"等
3. **项目管理的参与单位变更**：项目关联的单位信息变更，如直接用户、经销商、系统集成商、设计院等
4. **项目跟进记录更新**：新增或更新项目的跟进记录（不包括跟进记录的回复）
5. **客户跟进记录中引用**：在客户跟进记录中引用了该项目，建立了项目与客户活动的关联
6. **项目报价单更新**：项目的报价单被创建或更新，表明项目的关键业务环节有进展

如果项目在指定的时间阈值（默认7天）内没有上述任何活动，则会被标记为"不活跃"状态。

## 3. 数据结构

项目模型添加了以下活跃度相关字段：

```python
# 活跃度相关字段
is_active = Column(Boolean, default=True, nullable=False)  # 是否活跃
last_activity_date = Column(DateTime, default=func.now(), nullable=True)  # 最后活动时间
activity_reason = Column(String(50), nullable=True)  # 活跃状态原因
```

## 4. 活跃度检查实现

### 4.1 核心检查函数

活跃度检查的核心函数是 `check_project_activity()`，位于 `app/utils/activity_tracker.py`：

```python
def check_project_activity(project_id=None, days_threshold=None):
    """
    检查项目活跃度
    
    当连续n天没有项目的活动时，标记为不活跃。判断活跃的条件包括：
    - 项目基本信息更新（updated_at时间）
    - 项目阶段推进变更
    - 项目重要字段修改（如项目名称、授权码等）
    - 项目管理的参与单位变更（如直接用户、经销商、系统集成商等）
    - 项目跟进记录的创建和更新
    - 客户跟进记录中引用了该项目
    - 项目报价单的创建和更新
    """
    # 功能实现...
```

该函数会依次检查多个活跃条件，一旦满足其中之一，项目就会被标记为活跃。

### 4.2 定时更新脚本

系统提供了两个脚本用于更新项目活跃度状态：

1. **首次检查脚本**：`scripts/run_first_project_activity_check.py`
   - 用于系统首次启用活跃度功能时，对所有项目进行初始化检查
   - 会生成活跃原因统计报告

2. **定期更新脚本**：`scripts/update_project_activity.py`
   - 用于定期（每日或更频繁）更新项目活跃状态
   - 支持指定项目ID和活跃阈值参数

### 4.3 为什么使用定时任务而非实时更新

系统采用定时任务更新活跃度状态而非实时更新，原因有：

1. **性能考虑**：实时检查会在每次项目相关操作后执行完整的活跃度检查，增加系统负担
2. **数据一致性**：批量更新可以保证在同一时间点使用统一标准对所有项目进行评估
3. **阈值灵活性**：管理员可以调整活跃度阈值，定时任务可以一次性应用新阈值到所有项目
4. **避免频繁更新**：项目在短时间内可能有多次活动，实时更新会导致数据库频繁写入

## 5. 用户界面展示

活跃度状态在以下位置展示：

1. **项目列表**：活跃状态以标签形式直观展示（活跃/不活跃）
2. **项目详情**：显示活跃状态、最后活动时间和活跃原因
3. **系统设置**：管理员可以在系统设置中配置活跃度阈值

## 6. 活跃度阈值配置

活跃度阈值通过系统设置维护，管理员可以调整：
- `project_activity_threshold`: 项目活跃度阈值（天），默认为7天

## 7. 未来扩展

活跃度跟踪功能的未来扩展方向：

1. **活跃度历史记录**：记录项目活跃状态变化历史，用于分析项目活动模式
2. **活跃度预警**：当项目接近不活跃状态时发送通知，提醒相关人员跟进
3. **项目活跃度报表**：按部门、销售等维度统计项目活跃状态分布
4. **客户活动关联分析**：分析项目活跃度与客户活动之间的关系 