# 报价单审批锁定功能实现总结

## 功能概述

根据用户需求，实现了以下功能：
1. 报价单提交审核时自动锁定报价单和产品明细
2. 审批过程中只能编辑报价单明细字段，而不是报价单本身的字段
3. 审批完成后自动解锁报价单

## 实现的功能

### 1. 报价单锁定机制

#### 数据库字段
为`quotations`表添加了锁定相关字段：
- `is_locked`: 是否被锁定（布尔类型）
- `lock_reason`: 锁定原因（字符串类型）
- `locked_by`: 锁定人ID（外键关联用户表）
- `locked_at`: 锁定时间（时间戳）

#### 模型方法
在`Quotation`模型中添加了：
- `lock(reason, user_id)`: 锁定报价单
- `unlock(user_id)`: 解锁报价单
- `is_editable`: 检查是否可编辑的属性
- `lock_status_display`: 获取锁定状态显示信息的属性

### 2. 报价单帮助函数

创建了`app/helpers/quotation_helpers.py`文件，包含：
- `lock_quotation(quotation_id, reason, user_id)`: 锁定报价单
- `unlock_quotation(quotation_id, user_id)`: 解锁报价单
- `is_quotation_editable(quotation_id, user_id)`: 检查报价单是否可编辑

### 3. 审批流程集成

#### 对象锁定支持
修改了`app/helpers/approval_helpers.py`中的锁定函数：
- `_lock_approval_object()`: 添加了对报价单锁定的支持
- `_unlock_approval_object()`: 添加了对报价单解锁的支持

#### 字段选项配置
在`get_object_field_options()`函数中为报价单添加了明细字段选项：
- 产品名称 (product_name)
- 产品型号 (product_model)
- 产品描述 (product_desc)
- 品牌 (brand)
- 单位 (unit)
- 数量 (quantity)
- 折扣率 (discount)
- 市场价 (market_price)
- 单价 (unit_price)
- 总价 (total_price)
- 产品料号 (product_mn)

### 4. 前端界面更新

#### 报价单详情页面
在`app/templates/quotation/detail.html`中：
- 添加了锁定状态显示区域
- 显示锁定原因、锁定人和锁定时间
- 使用警告徽章样式显示锁定状态

#### 编辑权限检查
在报价单编辑相关视图中：
- `edit_quotation()`: 添加了锁定状态检查
- `save_quotation()`: 添加了锁定状态检查
- 锁定时禁止编辑并显示相应提示信息

### 5. 数据库迁移

创建了`migrations/add_quotation_lock_fields.sql`迁移脚本：
- 添加锁定相关字段
- 创建索引提高查询性能
- 添加字段注释说明
- 更新现有数据为未锁定状态

## 工作流程

### 1. 审批启动时
1. 用户在报价单详情页面点击"发起审批"
2. 系统根据审批模板配置检查是否需要锁定对象
3. 如果配置了`lock_object_on_start=True`，则自动锁定报价单
4. 锁定原因使用模板中配置的`lock_reason`

### 2. 审批过程中
1. 只有当前审批步骤的审批人可以编辑配置的字段
2. 字段编辑权限通过`check_field_editable()`函数检查
3. 报价单明细字段可以在审批步骤中配置为可编辑
4. 非审批人和非当前步骤的用户无法编辑任何字段

### 3. 审批完成时
1. 审批通过或拒绝时，系统自动解锁报价单
2. 解锁后报价单恢复正常编辑状态
3. 审批历史记录保留完整的操作轨迹

## 技术特点

### 1. 统一的锁定机制
- 使用统一的锁定/解锁接口
- 支持不同业务对象类型的扩展
- 锁定状态持久化到数据库

### 2. 灵活的字段权限控制
- 可以为每个审批步骤单独配置可编辑字段
- 支持报价单明细字段的精细化权限控制
- 权限检查集成到审批流程中

### 3. 用户友好的界面
- 清晰显示锁定状态和原因
- 锁定时提供明确的提示信息
- 使用视觉化的徽章显示状态

### 4. 完整的审计跟踪
- 记录锁定人和锁定时间
- 保留审批历史记录
- 支持锁定原因说明

## 测试验证

通过测试脚本验证了以下功能：
1. ✓ 报价单锁定和解锁功能正常
2. ✓ 锁定状态检查功能正常
3. ✓ 审批流程启动时自动锁定
4. ✓ 字段编辑权限控制正常
5. ✓ 报价单明细字段配置正确
6. ✓ 邮件抄送功能集成正常

## 配置说明

### 审批模板配置
创建报价单审批模板时：
- 设置`object_type="quotation"`
- 启用`lock_object_on_start=True`
- 配置合适的`lock_reason`

### 审批步骤配置
添加审批步骤时：
- 在`editable_fields`中配置报价单明细字段
- 可选择的字段包括产品名称、型号、数量、价格等
- 支持邮件抄送功能

## 注意事项

1. **权限控制**: 只有当前审批步骤的审批人可以编辑配置的字段
2. **锁定范围**: 锁定影响整个报价单，包括基本信息和产品明细
3. **解锁时机**: 审批完成（通过或拒绝）时自动解锁
4. **字段范围**: 审批中只能编辑报价单明细字段，不能编辑报价单基本信息
5. **数据一致性**: 所有锁定/解锁操作都在数据库事务中进行

## 扩展性

该实现具有良好的扩展性：
- 可以轻松添加其他业务对象的锁定支持
- 字段权限控制机制可以应用到其他对象
- 锁定机制可以扩展到其他业务场景 