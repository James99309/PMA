# 项目授权编号动作设计方案

## 1. 设计目标

设计并实现一个在现有审批流程中增加的"授权编号"动作，实现以下目标：

1. 在项目类审批流程中增加授权编号动作
2. 审批过程中锁定所有项目编辑功能
3. 授权审批人可以修改项目类型并进行授权
4. 审批通过后自动生成授权编号并更新项目信息
5. 基于项目类型使用不同的编号前缀规则（CPJ/SPJ/APJ）
6. 更新项目报备日期为审批当天

## 2. 系统架构

设计将基于现有的审批流程系统进行扩展，主要涉及以下几个核心模块：

1. **审批流程配置**：添加带授权编号动作的审批流程模板
2. **审批步骤扩展**：增加授权编号动作类型和相关参数配置
3. **审批执行引擎**：扩展现有的审批处理逻辑，支持授权动作
4. **项目管理模块**：添加对项目锁定和授权编号生成的支持
5. **用户界面**：更新审批页面，支持项目类型修改和授权编号预览

## 3. 数据模型设计

### 3.1 ApprovalStep 扩展

在现有的 ApprovalStep 模型中添加动作类型和参数配置：

```python
class ApprovalStep(db.Model):
    # 现有字段...
    
    # 新增字段
    action_type = db.Column(db.String(50), nullable=True, comment="步骤动作类型，如 authorization")
    action_params = db.Column(db.JSON, nullable=True, comment="动作参数，JSON格式")
```

### 3.2 项目锁定状态

在项目模型中添加锁定状态字段：

```python
class Project(db.Model):
    # 现有字段...
    
    # 新增字段
    is_locked = db.Column(db.Boolean, default=False, comment="是否锁定编辑")
    locked_reason = db.Column(db.String(100), nullable=True, comment="锁定原因")
    locked_by = db.Column(db.Integer, db.ForeignKey("users.id"), nullable=True, comment="锁定人ID")
    locked_at = db.Column(db.DateTime, nullable=True, comment="锁定时间")
```

## 4. 系统交互流程

### 4.1 创建授权编号审批流程模板

1. 管理员创建新的审批流程模板（如"项目授权编号审批"）
2. 配置审批步骤，其中包含一个特殊的"授权编号"步骤
3. 为授权步骤设置动作类型为"authorization"
4. 为授权步骤分配有权限的审批人（如销售总监）

### 4.2 发起授权编号审批

1. 项目所有者在项目详情页选择"授权编号审批"流程
2. 系统检查项目状态和必填字段
3. 系统创建审批实例并自动锁定项目编辑功能
4. 通知相关审批人

### 4.3 授权审批处理

1. 审批人在审批页面查看项目信息
2. 审批人可以修改项目类型（销售重点/渠道跟进/业务机会）
3. 系统根据项目类型预览授权编号格式
4. 审批人提交审批意见（同意/拒绝）

### 4.4 审批完成后流程

1. 如果审批拒绝，自动解锁项目并记录反馈意见
2. 如果审批通过，系统根据项目类型生成授权编号
3. 更新项目报备日期为当前日期
4. 更新项目授权编号字段
5. 解锁项目，但授权编号字段不允许再次修改

## 5. 接口设计

### 5.1 审批流程配置接口扩展

```python
def create_approval_step(process_id, step_name, approver_id, action_type=None, action_params=None, send_email=True):
    """
    创建审批步骤，支持指定动作类型和参数
    
    Args:
        process_id: 流程模板ID
        step_name: 步骤名称
        approver_id: 审批人ID
        action_type: 动作类型，如 "authorization"
        action_params: 动作参数，字典格式
        send_email: 是否发送邮件通知
    
    Returns:
        创建的步骤对象
    """
    # 实现代码...
```

### 5.2 审批处理接口扩展

```python
def process_approval(instance_id, action, project_type=None, comment=None, user_id=None):
    """
    处理审批操作，支持项目类型修改
    
    Args:
        instance_id: 审批实例ID
        action: 审批动作（ApprovalAction枚举值）
        project_type: 项目类型，用于授权步骤
        comment: 审批意见
        user_id: 操作人ID
    
    Returns:
        布尔值，表示操作是否成功
    """
    # 实现代码...
```

### 5.3 项目锁定和解锁接口

```python
def lock_project(project_id, reason, user_id=None):
    """
    锁定项目，防止编辑
    
    Args:
        project_id: 项目ID
        reason: 锁定原因
        user_id: 锁定人ID
    
    Returns:
        布尔值，表示是否成功锁定
    """
    # 实现代码...
```

```python
def unlock_project(project_id, user_id=None):
    """
    解锁项目
    
    Args:
        project_id: 项目ID
        user_id: 解锁人ID
    
    Returns:
        布尔值，表示是否成功解锁
    """
    # 实现代码...
```

## 6. 用户界面设计

### 6.1 流程配置界面

![流程配置界面草图](图片链接)

**特性**：
- 流程模板名称和描述字段
- 动作类型选择器（普通/授权编号）
- 授权动作参数配置区域

### 6.2 授权审批页面

![授权审批页面草图](图片链接)

**特性**：
- 项目信息概览
- 项目类型修改下拉框
- 授权编号预览区域
- 审批意见输入框
- 同意/拒绝操作按钮

### 6.3 项目锁定状态展示

![项目锁定状态展示草图](图片链接)

**特性**：
- 在项目详情页显示锁定状态
- 锁定信息包括原因、锁定人和时间
- 所有编辑按钮在锁定状态下禁用
- 锁定状态通知横幅

## 7. 实现细节

### 7.1 授权编号生成规则

根据项目类型自动生成如下格式的编号：

- 渠道跟进 CPJ 年份（四位）月份（二位）-（001）递增
- 销售重点 SPJ 年份（四位）月份（二位）-（001）递增
- 业务机会 APJ 年份（四位）月份（二位）-（001）递增

### 7.2 项目锁定机制

- 发起授权审批时自动锁定项目
- 锁定状态下项目详情页所有编辑功能禁用
- 审批结束后（通过或拒绝）自动解锁项目
- 允许管理员手动解锁项目（应急情况）

### 7.3 审批流程中的数据安全

- 使用事务确保授权编号生成和项目更新的原子性
- 记录所有操作日志以便追踪
- 审批过程中对项目数据的修改仅限于授权审批人
- 授权编号一旦生成不可修改

## 8. 权限控制

- 只有项目所有者和管理员可以发起授权编号审批
- 只有被指定的审批人可以执行授权操作
- 管理员可以查看和管理所有授权审批
- 授权编号相关统计分析功能仅对管理层开放

## 9. 测试计划

1. **单元测试**：测试授权编号生成逻辑和项目锁定/解锁功能
2. **集成测试**：测试完整的授权审批流程
3. **UI测试**：测试用户界面的交互和响应
4. **安全测试**：验证权限控制和数据安全
5. **性能测试**：测试系统在高并发情况下的表现

## 10. 部署与迁移计划

1. 创建数据库迁移脚本，添加新字段
2. 更新现有审批流程相关代码
3. 添加新的授权编号动作处理逻辑
4. 更新用户界面模板和JavaScript
5. 部署前进行全面测试
6. 制定回滚计划（紧急情况使用）

## 11. 文档和培训

1. 更新开发者文档，说明新增功能的实现细节
2. 编写用户操作手册，详细解释授权审批流程
3. 制作培训材料，对管理员和审批人进行培训
4. 提供常见问题解答和故障排除指南

## 12. 后续扩展规划

1. 支持更多类型的自动化审批动作
2. 增加审批流程状态的可视化监控
3. 添加审批流程的数据统计和分析功能
4. 优化审批通知方式，支持多渠道推送 