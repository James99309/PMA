# 绩效权限控制修正报告

## 修正内容

根据用户要求，对绩效设置功能的权限控制进行了重要修正：

### 原有权限逻辑（错误）
- 个人用户可以编辑自己的绩效设置
- 管理员可以编辑所有人的绩效设置

### 修正后权限逻辑（正确）
1. **个人用户**：只能查看自己的绩效设置，**不能编辑**
2. **具备账户设置模块权限的用户**：可以编辑权限范围内账户的绩效设置
3. **管理员**：拥有所有权限，可以编辑任何人的绩效设置

## 技术实现

### 1. 后端权限检查修正

**文件：** `app/views/performance.py`

#### 目标设置页面权限检查
```python
# 检查是否有编辑权限：
# 1. 管理员可以编辑所有人的目标
# 2. 具备用户管理模块编辑权限的可以编辑权限范围内用户的目标  
# 3. 个人用户只能查看自己的，不能编辑
can_edit_targets = (
    current_user.role == 'admin' or 
    (current_user.has_permission('user', 'edit') and selected_user_id in [u.id for u in accessible_users])
)
```

#### 保存目标接口权限检查
```python
# 权限检查：只有管理员或具备用户管理编辑权限的用户可以设置目标
accessible_users = get_accessible_users(current_user)
accessible_user_ids = [u.id for u in accessible_users]

can_edit = (
    current_user.role == 'admin' or 
    (current_user.has_permission('user', 'edit') and user_id in accessible_user_ids)
)

if not can_edit:
    return jsonify({'success': False, 'message': '没有权限设置绩效目标'})
```

### 2. 前端界面权限控制

**文件：** `app/templates/performance/target_settings.html`

#### 权限提示信息
- 当用户没有编辑权限时，显示明确的权限说明
- 区分个人用户和其他用户的提示文案

#### 界面元素控制
- **批量操作区域**：只有具备编辑权限的用户才能看到
- **输入框**：没有编辑权限时变为只读状态 (`readonly` 属性)
- **下拉选择器**：没有编辑权限时禁用 (`disabled` 属性)
- **保存按钮**：替换为"仅查看模式"提示

#### JavaScript函数权限控制
```javascript
// 在所有编辑相关函数中添加权限检查
{% if not can_edit_targets %}
showToast('warning', '您没有权限修改绩效目标');
return;
{% endif %}
```

## 权限体系说明

### 权限模块
系统使用 `user` 模块的 `edit` 权限来控制账户设置功能：
- `has_permission('user', 'edit')` 决定用户是否可以管理其他用户的账户信息
- 这个权限同时控制绩效目标设置功能

### 数据访问控制
通过 `get_accessible_users()` 函数确定用户可以管理的账户范围：
- 考虑归属关系和数据可见性
- 确保用户只能操作自己权限范围内的数据

## 用户体验说明

### 不同角色的界面体验

#### 1. 管理员 (admin)
- ✅ 可以查看和编辑所有用户的绩效目标
- ✅ 可以使用所有批量操作功能
- ✅ 所有输入框和按钮正常可用

#### 2. 具备账户设置权限的用户
- ✅ 可以查看和编辑权限范围内用户的绩效目标
- ✅ 可以使用所有批量操作功能
- ✅ 所有输入框和按钮正常可用

#### 3. 普通用户
- ✅ 可以查看自己的绩效目标设置
- ❌ 无法编辑任何绩效目标（包括自己的）
- ❌ 看不到批量操作区域
- ❌ 所有输入框变为只读状态
- ❌ 保存按钮变为"仅查看模式"提示
- ℹ️ 显示权限说明："个人用户只能查看自己的绩效目标，无法编辑"

## 安全性保障

### 多层权限检查
1. **路由级别**：在视图函数中检查用户权限
2. **数据级别**：通过数据访问控制确保权限范围
3. **API级别**：在保存接口中再次验证权限
4. **前端级别**：通过模板条件和JavaScript阻止无权限操作

### 权限验证逻辑
- 基于成熟的权限模块系统
- 与现有账户管理权限保持一致
- 支持细粒度的数据访问控制

## 测试验证

通过测试脚本验证了权限逻辑的正确性：
- ✅ 管理员用户拥有完整权限
- ✅ 普通用户没有编辑权限
- ✅ 权限检查函数工作正常
- ✅ 界面权限控制生效

## 总结

此次修正确保了绩效目标设置功能的权限控制符合企业管理需求：
- 个人用户只能查看，不能随意修改绩效目标
- 只有具备相应管理权限的用户才能设置绩效目标
- 管理员保持完整的管理权限
- 界面清晰提示权限状态，提升用户体验

这样的权限设计既保证了数据的安全性，又符合企业的管理层级关系。
