# 折扣权限控制功能测试指导

## 🎯 测试目的
验证服务经理和销售总监在批价单编辑页面中设置折扣率时，能够正确显示红色背景警告。

## ✅ 修复内容

### 1. 问题诊断
- **问题**：前端JavaScript选择器使用了错误的属性 `data-field="discount_rate"`
- **实际情况**：批价单页面中折扣率输入框使用的是CSS类 `class="discount-rate"`

### 2. 修复细节
- 更新了JavaScript选择器从 `input[data-field="discount_rate"]` 到 `input.discount-rate`
- 更新了前端权限保存逻辑，现在会正确传递折扣限制数据到后端
- 修复了数据库中的折扣权限设置

### 3. 当前权限设置
- **销售总监 (gxh)**：批价折扣下限 35%，结算折扣下限 25%
- **服务经理 (xuhao)**：批价折扣下限 40%，结算折扣下限 30%

## 🧪 测试步骤

### 步骤1：使用销售总监账号测试
1. 登录用户：`gxh` (销售总监)
2. 进入任意批价单编辑页面
3. 在批价单明细表格中，输入折扣率：
   - **预期行为**：输入低于35%的折扣率（如30%）应该显示红色背景和白色文字
   - **预期行为**：输入35%或以上的折扣率应该显示正常样式

### 步骤2：使用服务经理账号测试
1. 登录用户：`xuhao` (服务经理)
2. 进入任意批价单编辑页面
3. 在批价单明细表格中，输入折扣率：
   - **预期行为**：输入低于40%的折扣率（如35%）应该显示红色背景和白色文字
   - **预期行为**：输入40%或以上的折扣率应该显示正常样式

### 步骤3：测试总折扣率输入框
1. 在批价单页面底部的"总折扣率"输入框中也应该有相同的权限检查
2. 输入低于权限下限的值应该显示红色警告

## 📋 测试检查清单

- [ ] 销售总监输入30%折扣率显示红色警告
- [ ] 销售总监输入35%折扣率显示正常样式
- [ ] 销售总监输入40%折扣率显示正常样式
- [ ] 服务经理输入35%折扣率显示红色警告
- [ ] 服务经理输入40%折扣率显示正常样式
- [ ] 服务经理输入45%折扣率显示正常样式
- [ ] 总折扣率输入框也有相同的权限检查
- [ ] 警告提示信息显示正确的权限下限值

## 🎨 预期样式
当折扣率低于权限下限时，输入框应该：
- 背景色：红色 (#dc3545)
- 文字颜色：白色
- 边框颜色：红色
- 下方显示警告信息：⚠️ 折扣率低于权限下限 XX%

## 🔧 故障排除
如果测试失败，请检查：
1. 用户角色是否正确设置为 `sales_director` 或 `service_manager`
2. 浏览器控制台是否有JavaScript错误
3. 折扣权限数据是否正确传递到前端（检查 `window.discountLimits` 对象）

## 📝 技术细节
- **前端检查**：基于CSS类选择器 `input.discount-rate`
- **权限服务**：`DiscountPermissionService.get_user_discount_limits()`
- **样式类**：`.discount-warning`
- **检查频率**：实时检查（input事件）+ 页面加载时检查 