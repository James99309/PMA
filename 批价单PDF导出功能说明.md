# 批价单PDF导出功能说明

## 功能概述

批价单PDF导出功能允许用户将批价单和结算单导出为标准的PDF格式文档，便于打印、存档和分享。系统提供了三种PDF导出选项：

1. **批价单PDF** - 仅包含批价单信息和产品明细
2. **结算单PDF** - 仅包含结算单信息和产品明细（需要相应权限）
3. **合并PDF** - 包含批价单和结算单的完整信息（需要相应权限）

## 功能特点

### 📋 标准化模板
- 采用专业的企业文档模板设计
- 包含公司标识和水印
- 支持多页文档自动分页
- 页眉页脚包含页码和公司信息

### 🎨 美观的样式
- 清晰的表格布局
- 专业的配色方案
- 合理的字体和间距
- 响应式表格设计

### 🔒 权限控制
- 批价单PDF：所有有权限查看批价单的用户
- 结算单PDF：仅限管理员、渠道经理、销售总监、服务经理
- 合并PDF：同结算单权限要求

### 📊 完整信息
- 基本信息：批价单号、项目名称、创建日期等
- 客户信息：经销商、分销商信息
- 产品明细：完整的产品列表和价格信息
- 审批记录：完整的审批流程和意见
- 汇总信息：总金额、折扣率、利润分析等

## 使用方法

### 在批价单编辑页面导出

1. 进入任意批价单的编辑页面
2. 滚动到页面底部，找到"PDF文档导出"区域
3. 根据需要选择相应的导出选项：
   - 点击"导出批价单PDF"生成批价单文档
   - 点击"导出结算单PDF"生成结算单文档（需要权限）
   - 点击"导出合并PDF"生成完整文档（需要权限）
4. 浏览器将自动下载生成的PDF文件

### 在批价单列表页面导出

1. 进入批价单列表页面
2. 在每个批价单的操作列中，点击"PDF"下拉按钮
3. 选择需要的PDF类型进行导出

## PDF文档内容

### 批价单PDF包含：
- 文档标题和公司信息
- 批价单基本信息表
- 批价产品明细表
- 批价汇总信息
- 审批记录表
- 生成时间和页脚信息

### 结算单PDF包含：
- 文档标题和公司信息
- 结算单基本信息表
- 结算产品明细表
- 分销利润分析
- 结算汇总信息
- 审批记录表
- 生成时间和页脚信息

### 合并PDF包含：
- 批价单完整信息（第1页）
- 结算单完整信息（第2页起）
- 分销利润对比分析
- 完整的审批记录

## 技术实现

### 依赖库
- **WeasyPrint**: HTML到PDF转换引擎
- **cffi**: C语言外部函数接口
- **Pillow**: 图像处理库

### 文件结构
```
app/
├── services/
│   └── pdf_generator.py          # PDF生成服务
├── templates/
│   └── pdf/
│       ├── pricing_order_template.html    # 批价单模板
│       ├── settlement_order_template.html # 结算单模板
│       └── combined_order_template.html   # 合并模板
└── routes/
    └── pricing_order_routes.py    # PDF导出路由
```

### 样式特点
- A4纸张大小，适合打印
- 2cm页边距，专业布局
- 宋体字体，符合中文文档习惯
- 蓝色主题色，与系统保持一致
- 表格边框和斑马纹，提高可读性

## 权限说明

### 查看权限
- 批价单创建人
- 项目销售负责人
- 管理员、渠道经理、销售总监、服务经理
- 当前审批人（审批中状态）

### 结算单权限
仅限以下角色可以查看和导出结算单相关PDF：
- 管理员 (admin)
- 渠道经理 (channel_manager)
- 销售总监 (sales_director)
- 服务经理 (service_manager)

## 文件命名规则

生成的PDF文件按以下规则命名：
- 批价单PDF：`批价单_PO202506-001_20250101_143022.pdf`
- 结算单PDF：`结算单_PO202506-001_20250101_143022.pdf`
- 合并PDF：`批价结算单_PO202506-001_20250101_143022.pdf`

格式：`文档类型_批价单号_生成日期时间.pdf`

## 注意事项

1. **临时文件清理**：PDF生成后会自动清理临时文件，无需手动处理
2. **网络要求**：PDF生成需要服务器处理，请确保网络连接稳定
3. **浏览器兼容**：建议使用现代浏览器（Chrome、Firefox、Safari、Edge）
4. **文件大小**：根据产品明细数量，PDF文件大小通常在100KB-2MB之间
5. **生成时间**：复杂文档可能需要几秒钟生成时间，请耐心等待

## 故障排除

### 常见问题

**Q: PDF导出按钮不显示？**
A: 检查您是否有查看该批价单的权限，或联系管理员确认权限设置。

**Q: 点击导出没有反应？**
A: 请检查浏览器是否阻止了下载，或者刷新页面重试。

**Q: PDF内容显示不完整？**
A: 这可能是数据问题，请检查批价单的明细数据是否完整。

**Q: 结算单PDF选项不可用？**
A: 结算单PDF需要特定权限，请联系管理员确认您的角色权限。

### 技术支持

如遇到其他问题，请联系系统管理员或技术支持团队。

---

*本功能由PMA项目管理系统提供，版本更新可能会带来界面和功能的改进。* 