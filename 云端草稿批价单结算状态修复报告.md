# äº‘ç«¯è‰ç¨¿æ‰¹ä»·å•ç»“ç®—çŠ¶æ€ä¿®å¤æŠ¥å‘Š

## ğŸš¨ é—®é¢˜æè¿°

æ ¹æ®æ‚¨æä¾›çš„æˆªå›¾ï¼Œäº‘ç«¯æ•°æ®åº“ä¸­å­˜åœ¨**è‰ç¨¿çŠ¶æ€çš„æ‰¹ä»·å•**ï¼Œä½†å®ƒä»¬çš„**ç»“ç®—å•å’Œç»“ç®—å•æ˜ç»†å´å¤„äºå¾…ç»“ç®—çŠ¶æ€**ï¼Œå¯¼è‡´è¿™äº›æœªå®¡æ‰¹çš„æ‰¹ä»·å•é”™è¯¯åœ°æ˜¾ç¤ºåœ¨ç»“ç®—æ¨¡å—ä¸­ã€‚

### ğŸ“Š é—®é¢˜è¡¨ç°
- æˆªå›¾æ˜¾ç¤ºï¼šSO202506-003 å’Œ SO202506-002 ä¸¤ä¸ªç»“ç®—å•
- è¿™ä¸¤ä¸ªç»“ç®—å•å¯¹åº”çš„æ‰¹ä»·å•åº”è¯¥æ˜¯è‰ç¨¿çŠ¶æ€
- ä½†ç»“ç®—å•æ˜ç»†æ˜¾ç¤ºä¸º"å¾…ç»“ç®—"çŠ¶æ€ï¼Œå¯¼è‡´åœ¨ç»“ç®—æ¨¡å—ä¸­å¯è§

## ğŸ” é—®é¢˜æ ¹å› åˆ†æ

### æ­£ç¡®çš„çŠ¶æ€é€»è¾‘åº”è¯¥æ˜¯ï¼š
```
æ‰¹ä»·å•çŠ¶æ€ â†’ ç»“ç®—å•çŠ¶æ€ â†’ æ˜ç»†çŠ¶æ€ â†’ ç»“ç®—æ¨¡å—æ˜¾ç¤º
draft      â†’ draft      â†’ draft   â†’ âŒ ä¸æ˜¾ç¤º
pending    â†’ draft      â†’ draft   â†’ âŒ ä¸æ˜¾ç¤º  
rejected   â†’ draft      â†’ draft   â†’ âŒ ä¸æ˜¾ç¤º
approved   â†’ approved   â†’ pending â†’ âœ… æ˜¾ç¤ºï¼ˆå¾…ç»“ç®—ï¼‰
approved   â†’ approved   â†’ settled â†’ âŒ ä¸æ˜¾ç¤ºï¼ˆå·²ç»“ç®—ï¼‰
```

### å½“å‰äº‘ç«¯çš„é”™è¯¯çŠ¶æ€ï¼š
```
æ‰¹ä»·å•çŠ¶æ€ â†’ ç»“ç®—å•çŠ¶æ€ â†’ æ˜ç»†çŠ¶æ€ â†’ ç»“ç®—æ¨¡å—æ˜¾ç¤º
draft      â†’ draft      â†’ pending â†’ âœ… é”™è¯¯æ˜¾ç¤ºï¼
```

## ğŸ› ï¸ ä¿®å¤æ–¹æ¡ˆ

### 1. æ£€æŸ¥é—®é¢˜æ•°æ®SQL

```sql
-- æ£€æŸ¥è‰ç¨¿æ‰¹ä»·å•å¯¹åº”çš„ç»“ç®—å•çŠ¶æ€
SELECT 
    so.id,
    so.order_number,
    so.status as settlement_status,
    po.order_number as pricing_order_number,
    po.status as pricing_status
FROM settlement_orders so
JOIN pricing_orders po ON so.pricing_order_id = po.id
WHERE po.status = 'draft' AND so.status != 'draft';

-- æ£€æŸ¥è‰ç¨¿æ‰¹ä»·å•å¯¹åº”çš„æ˜ç»†çŠ¶æ€
SELECT 
    COUNT(*) as wrong_detail_count,
    STRING_AGG(DISTINCT sod.settlement_status, ', ') as wrong_statuses
FROM settlement_order_details sod
JOIN pricing_orders po ON sod.pricing_order_id = po.id
WHERE po.status = 'draft' AND sod.settlement_status != 'draft';
```

### 2. ä¿®å¤SQLï¼ˆè¯·åœ¨äº‘ç«¯æ•°æ®åº“ä¸­æ‰§è¡Œï¼‰

```sql
-- å¼€å§‹äº‹åŠ¡
BEGIN;

-- 1. ä¿®å¤ç»“ç®—å•çŠ¶æ€ï¼šå°†è‰ç¨¿æ‰¹ä»·å•å¯¹åº”çš„ç»“ç®—å•é‡ç½®ä¸ºè‰ç¨¿çŠ¶æ€
UPDATE settlement_orders 
SET 
    status = 'draft',
    approved_by = NULL,
    approved_at = NULL
WHERE id IN (
    SELECT so.id
    FROM settlement_orders so
    JOIN pricing_orders po ON so.pricing_order_id = po.id
    WHERE po.status = 'draft' AND so.status != 'draft'
);

-- 2. ä¿®å¤ç»“ç®—å•æ˜ç»†çŠ¶æ€ï¼šå°†è‰ç¨¿æ‰¹ä»·å•å¯¹åº”çš„æ˜ç»†é‡ç½®ä¸ºè‰ç¨¿çŠ¶æ€
UPDATE settlement_order_details 
SET settlement_status = 'draft'
WHERE id IN (
    SELECT sod.id
    FROM settlement_order_details sod
    JOIN pricing_orders po ON sod.pricing_order_id = po.id
    WHERE po.status = 'draft' AND sod.settlement_status != 'draft'
);

-- æäº¤äº‹åŠ¡
COMMIT;
```

### 3. éªŒè¯ä¿®å¤ç»“æœSQL

```sql
-- éªŒè¯ï¼šæ£€æŸ¥æ˜¯å¦è¿˜æœ‰é—®é¢˜æ•°æ®
SELECT 
    'ç»“ç®—å•çŠ¶æ€é—®é¢˜' as issue_type,
    COUNT(*) as count
FROM settlement_orders so
JOIN pricing_orders po ON so.pricing_order_id = po.id
WHERE po.status = 'draft' AND so.status != 'draft'

UNION ALL

SELECT 
    'æ˜ç»†çŠ¶æ€é—®é¢˜' as issue_type,
    COUNT(*) as count
FROM settlement_order_details sod
JOIN pricing_orders po ON sod.pricing_order_id = po.id
WHERE po.status = 'draft' AND sod.settlement_status != 'draft';

-- æŸ¥çœ‹ä¿®å¤åçš„çŠ¶æ€åˆ†å¸ƒ
SELECT 
    po.status as pricing_status,
    so.status as settlement_status,
    COUNT(*) as count
FROM settlement_orders so
JOIN pricing_orders po ON so.pricing_order_id = po.id
GROUP BY po.status, so.status
ORDER BY po.status, so.status;
```

## ğŸ“‹ é¢„æœŸä¿®å¤ç»“æœ

### ä¿®å¤å‰ï¼ˆé—®é¢˜çŠ¶æ€ï¼‰ï¼š
- è‰ç¨¿æ‰¹ä»·å• â†’ ç»“ç®—å•çŠ¶æ€é”™è¯¯ â†’ æ˜ç»†çŠ¶æ€é”™è¯¯ â†’ é”™è¯¯æ˜¾ç¤ºåœ¨ç»“ç®—æ¨¡å—

### ä¿®å¤åï¼ˆæ­£ç¡®çŠ¶æ€ï¼‰ï¼š
- è‰ç¨¿æ‰¹ä»·å• â†’ ç»“ç®—å• draft â†’ æ˜ç»† draft â†’ ä¸åœ¨ç»“ç®—æ¨¡å—æ˜¾ç¤º

## ğŸ¯ å…·ä½“æ“ä½œæ­¥éª¤

1. **è¿æ¥äº‘ç«¯æ•°æ®åº“**ï¼š
   ```
   Host: dpg-cr3gn4o8fa8c73bq61mg-a.oregon-postgres.render.com
   Database: pma_db_sp8d
   User: pma_db_sp8d_user
   ```

2. **æ‰§è¡Œæ£€æŸ¥SQL**ï¼š
   - å…ˆè¿è¡Œæ£€æŸ¥SQLç¡®è®¤é—®é¢˜æ•°æ®æ•°é‡

3. **æ‰§è¡Œä¿®å¤SQL**ï¼š
   - è¿è¡Œä¸Šé¢çš„ä¿®å¤SQLï¼ˆåŒ…å«äº‹åŠ¡ï¼‰

4. **éªŒè¯ç»“æœ**ï¼š
   - è¿è¡ŒéªŒè¯SQLç¡®è®¤ä¿®å¤æˆåŠŸ

5. **åˆ·æ–°ç»“ç®—æ¨¡å—**ï¼š
   - ä¿®å¤å®Œæˆåï¼Œåˆ·æ–°ç»“ç®—æ¨¡å—é¡µé¢
   - è‰ç¨¿çŠ¶æ€çš„æ‰¹ä»·å•åº”è¯¥ä¸å†æ˜¾ç¤º

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **æ•°æ®å®‰å…¨**ï¼šä¿®å¤SQLä½¿ç”¨äº†äº‹åŠ¡ï¼Œå¦‚æœå‡ºç°é—®é¢˜å¯ä»¥å›æ»š
2. **ä¸šåŠ¡é€»è¾‘**ï¼šä¿®å¤åè‰ç¨¿æ‰¹ä»·å•å°†ä¸åœ¨ç»“ç®—æ¨¡å—æ˜¾ç¤ºï¼Œè¿™æ˜¯æ­£ç¡®çš„ä¸šåŠ¡é€»è¾‘
3. **ç³»ç»Ÿä¸€è‡´æ€§**ï¼šä¿®å¤ç¡®ä¿äº†æ‰¹ä»·å•çŠ¶æ€ä¸ç»“ç®—å•çŠ¶æ€çš„ä¸€è‡´æ€§

## ğŸ”„ é˜²æ­¢é—®é¢˜å†æ¬¡å‘ç”Ÿ

### ä»£ç å±‚é¢çš„ä¿æŠ¤
åœ¨æ‰¹ä»·å•çŠ¶æ€å˜æ›´æ—¶ï¼Œç¡®ä¿åŒæ­¥æ›´æ–°ç»“ç®—å•å’Œæ˜ç»†çŠ¶æ€ï¼š

```python
def reset_settlement_approval_status(pricing_order_id):
    """é‡ç½®ç»“ç®—å•å®¡æ‰¹çŠ¶æ€ï¼ˆä¿ç•™æ•°æ®ï¼Œä»…é‡ç½®çŠ¶æ€ï¼‰"""
    # é‡ç½®ç‹¬ç«‹ç»“ç®—å•çŠ¶æ€ä¸ºè‰ç¨¿
    settlement_order = SettlementOrder.query.filter_by(pricing_order_id=pricing_order_id).first()
    if settlement_order:
        settlement_order.status = 'draft'
        settlement_order.approved_by = None
        settlement_order.approved_at = None
    
    # é‡ç½®ç»“ç®—å•æ˜ç»†çš„ç»“ç®—çŠ¶æ€
    settlement_details = SettlementOrderDetail.query.filter_by(pricing_order_id=pricing_order_id).all()
    for detail in settlement_details:
        detail.settlement_status = 'draft'
        detail.settlement_date = None
        detail.settlement_notes = None
```

è¿™ä¸ªå‡½æ•°åœ¨ä»¥ä¸‹åœºæ™¯ä¼šè¢«è°ƒç”¨ï¼š
- æ‰¹ä»·å•è¢«æ‹’ç»æ—¶
- æ‰¹ä»·å•è¢«å¬å›æ—¶
- ç®¡ç†å‘˜é€€å›æ‰¹ä»·å•æ—¶

ç¡®ä¿çŠ¶æ€ä¸€è‡´æ€§å¾—åˆ°ç»´æŠ¤ã€‚ 