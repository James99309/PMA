# æ‰¹ä»·å•æŠ˜æ‰£æƒé™æ§åˆ¶åŠŸèƒ½å®ç°æ€»ç»“

## ğŸ¯ åŠŸèƒ½æ¦‚è§ˆ

æœ¬æ¬¡å¼€å‘å®ç°äº†å®Œæ•´çš„æ‰¹ä»·å•å’Œç»“ç®—å•æŠ˜æ‰£æƒé™æ§åˆ¶ç³»ç»Ÿï¼ŒåŒ…æ‹¬ï¼š

- **æƒé™ç®¡ç†ç•Œé¢**ï¼šåœ¨è§’è‰²æƒé™ç®¡ç†é¡µé¢æ·»åŠ æŠ˜æ‰£ä¸‹é™è®¾ç½®
- **å®æ—¶æƒé™æ£€æŸ¥**ï¼šåœ¨æ‰¹ä»·å•ç¼–è¾‘é¡µé¢å®æ—¶æ£€æŸ¥æŠ˜æ‰£ç‡æƒé™
- **è§†è§‰æç¤ºç³»ç»Ÿ**ï¼šè¶…å‡ºæƒé™çš„æŠ˜æ‰£ç‡æ˜¾ç¤ºçº¢è‰²èƒŒæ™¯å’Œç™½è‰²æ–‡å­—
- **APIæ”¯æŒ**ï¼šæä¾›æŠ˜æ‰£æƒé™æ£€æŸ¥å’Œç®¡ç†çš„å®Œæ•´API

## âœ… å·²å®ŒæˆåŠŸèƒ½

### 1. æ•°æ®åº“ç»“æ„æ‰©å±•

- âœ… ä¸º `role_permissions` è¡¨æ·»åŠ äº†ä»¥ä¸‹å­—æ®µï¼š
  - `pricing_discount_limit` DECIMAL(5,2) - æ‰¹ä»·æŠ˜æ‰£ä¸‹é™
  - `settlement_discount_limit` DECIMAL(5,2) - ç»“ç®—æŠ˜æ‰£ä¸‹é™

- âœ… ä¸ºå„è§’è‰²è®¾ç½®äº†é»˜è®¤æŠ˜æ‰£æƒé™ï¼š
  ```
  è§’è‰²               æ‰¹ä»·æŠ˜æ‰£ä¸‹é™    ç»“ç®—æŠ˜æ‰£ä¸‹é™
  admin/ceo          0%             0%        (æ— é™åˆ¶)
  channel_manager    40%            30%
  sales_director     35%            25% 
  business_admin     45%            35%
  finance_director   30%            20%
  service_manager    40%            30%
  ```

### 2. æƒé™æœåŠ¡å¼€å‘

**æ–‡ä»¶**: `app/services/discount_permission_service.py`

- âœ… `DiscountPermissionService` æœåŠ¡ç±»
- âœ… `get_user_discount_limits()` - è·å–ç”¨æˆ·æŠ˜æ‰£ä¸‹é™
- âœ… `check_discount_permission()` - æ£€æŸ¥æŠ˜æ‰£æ˜¯å¦è¶…å‡ºæƒé™
- âœ… `get_discount_warning_class()` - è·å–CSSè­¦å‘Šæ ·å¼

### 3. APIæ¥å£å®ç°

**æ–‡ä»¶**: `app/api/v1/discount_permissions.py`

- âœ… `GET /api/v1/discount/limits` - è·å–å½“å‰ç”¨æˆ·æŠ˜æ‰£ä¸‹é™
- âœ… `POST /api/v1/discount/check` - æ£€æŸ¥å…·ä½“æŠ˜æ‰£ç‡æƒé™
- âœ… `POST /api/v1/discount/save` - ä¿å­˜è§’è‰²æŠ˜æ‰£æƒé™ï¼ˆç®¡ç†å‘˜ä¸“ç”¨ï¼‰

### 4. æƒé™ç®¡ç†ç•Œé¢

**æ–‡ä»¶**: `app/templates/user/role_permissions.html`

- âœ… åœ¨æƒé™ç®¡ç†é¡µé¢è¡¨æ ¼å¤–æ·»åŠ äº†æŠ˜æ‰£æƒé™è®¾ç½®åŒºåŸŸ
- âœ… åŒ…å«æ‰¹ä»·æŠ˜æ‰£ä¸‹é™å’Œç»“ç®—æŠ˜æ‰£ä¸‹é™è¾“å…¥æ¡†
- âœ… é¢„å¡«å……å½“å‰è§’è‰²å·²æœ‰çš„æŠ˜æ‰£æƒé™
- âœ… ä¸ç¼–è¾‘æ¨¡å¼è”åŠ¨ï¼Œåªè¯»/å¯ç¼–è¾‘çŠ¶æ€åˆ‡æ¢

### 5. æ‰¹ä»·å•é¡µé¢é›†æˆ

**æ–‡ä»¶**: `app/templates/pricing_order/edit_pricing_order.html`

- âœ… æ·»åŠ äº†CSSæ ·å¼ `.discount-warning` (çº¢è‰²èƒŒæ™¯ç™½è‰²æ–‡å­—)
- âœ… åœ¨é¡µé¢åˆå§‹åŒ–æ—¶ä¼ é€’ç”¨æˆ·æŠ˜æ‰£æƒé™ä¿¡æ¯
- âœ… æ·»åŠ äº†JavaScriptæŠ˜æ‰£æƒé™æ£€æŸ¥å‡½æ•°
- âœ… å®æ—¶ç›‘å¬æŠ˜æ‰£ç‡è¾“å…¥æ¡†å˜åŒ–

### 6. æµ‹è¯•åŠŸèƒ½

**æ–‡ä»¶**: `app/templates/test_discount_ui.html`

- âœ… åˆ›å»ºäº†å®Œæ•´çš„æŠ˜æ‰£æƒé™æµ‹è¯•é¡µé¢
- âœ… æ”¯æŒæ‰¹ä»·å•å’Œç»“ç®—å•æŠ˜æ‰£ç‡æµ‹è¯•
- âœ… å®æ—¶æ˜¾ç¤ºæƒé™æ£€æŸ¥ç»“æœå’Œè§†è§‰æç¤º
- âœ… è®¿é—®åœ°å€ï¼š`/test/discount-ui`

## ğŸ”§ æŠ€æœ¯å®ç°è¯¦æƒ…

### æ•°æ®åº“æ¶æ„

```sql
-- è§’è‰²æƒé™è¡¨æ‰©å±•
ALTER TABLE role_permissions 
ADD COLUMN pricing_discount_limit DECIMAL(5,2),
ADD COLUMN settlement_discount_limit DECIMAL(5,2);
```

### æƒé™æ£€æŸ¥é€»è¾‘

```python
def check_discount_permission(user, discount_rate, order_type='pricing'):
    limits = get_user_discount_limits(user)
    limit = limits['pricing_discount_limit'] if order_type == 'pricing' else limits['settlement_discount_limit']
    
    if limit is None:
        return {'allowed': True, 'exceeds': False}
    
    exceeds = discount_rate < limit  # æŠ˜æ‰£ç‡ä½äºä¸‹é™ä¸ºè¶…é™
    return {'allowed': not exceeds, 'exceeds': exceeds, 'limit': limit}
```

### å‰ç«¯è§†è§‰æç¤º

```css
.discount-warning {
    background-color: #dc3545 !important;
    color: white !important;
    border-color: #dc3545 !important;
}
```

```javascript
function checkDiscountPermission(inputElement) {
    // è·å–æŠ˜æ‰£ç‡å’Œç±»å‹
    const discountRate = parseFloat(inputElement.value);
    const orderType = inputElement.closest('#pricing-content') ? 'pricing' : 'settlement';
    
    // æ£€æŸ¥æƒé™å¹¶åº”ç”¨æ ·å¼
    if (discountRate < limit) {
        inputElement.classList.add('discount-warning');
    } else {
        inputElement.classList.remove('discount-warning');
    }
}
```

## ğŸ® ä½¿ç”¨æ–¹å¼

### 1. ç®¡ç†å‘˜è®¾ç½®æƒé™

1. ç™»å½•ç®¡ç†å‘˜è´¦æˆ·
2. è®¿é—® `/user/manage-permissions`
3. é€‰æ‹©è¦è®¾ç½®çš„è§’è‰²
4. åœ¨"æŠ˜æ‰£æƒé™è®¾ç½®"åŒºåŸŸè¾“å…¥æ‰¹ä»·å’Œç»“ç®—æŠ˜æ‰£ä¸‹é™
5. ç‚¹å‡»"ç¼–è¾‘"å"ä¿å­˜æƒé™è®¾ç½®"

### 2. ç”¨æˆ·ä½¿ç”¨ä½“éªŒ

1. ç™»å½•æœ‰æŠ˜æ‰£é™åˆ¶çš„è§’è‰²è´¦æˆ·ï¼ˆå¦‚æ¸ é“ç»ç†ï¼‰
2. è®¿é—®æ‰¹ä»·å•ç¼–è¾‘é¡µé¢
3. åœ¨æŠ˜æ‰£ç‡è¾“å…¥æ¡†ä¸­è¾“å…¥ä½äºæƒé™ä¸‹é™çš„å€¼
4. è¾“å…¥æ¡†ç«‹å³æ˜¾ç¤ºçº¢è‰²èƒŒæ™¯å’Œç™½è‰²æ–‡å­—
5. è¾“å…¥ç¬¦åˆæƒé™çš„æŠ˜æ‰£ç‡ï¼Œæ ·å¼æ¢å¤æ­£å¸¸

### 3. æµ‹è¯•åŠŸèƒ½

è®¿é—® `/test/discount-ui` å¯ä»¥ï¼š
- æŸ¥çœ‹å½“å‰ç”¨æˆ·çš„æŠ˜æ‰£æƒé™
- æµ‹è¯•ä¸åŒæŠ˜æ‰£ç‡çš„æƒé™æ£€æŸ¥
- å®æ—¶æŸ¥çœ‹è§†è§‰æç¤ºæ•ˆæœ

## ğŸ“Š æƒé™æ•ˆæœç¤ºä¾‹

ä»¥ `test_channel_manager` ç”¨æˆ·ä¸ºä¾‹ï¼ˆæ‰¹ä»·40%/ç»“ç®—30%ä¸‹é™ï¼‰ï¼š

| æŠ˜æ‰£ç‡ | æ‰¹ä»·å•çŠ¶æ€ | ç»“ç®—å•çŠ¶æ€ | è§†è§‰æ•ˆæœ |
|--------|------------|------------|----------|
| 25%    | ğŸ”´ è¶…é™    | ğŸ”´ è¶…é™    | çº¢è‰²èƒŒæ™¯ |
| 35%    | ğŸ”´ è¶…é™    | âœ… å…è®¸    | çº¢è‰²èƒŒæ™¯ |
| 45%    | âœ… å…è®¸    | âœ… å…è®¸    | æ­£å¸¸æ ·å¼ |

## ğŸ”’ å®‰å…¨ç‰¹æ€§

- **è§’è‰²æƒé™æ§åˆ¶**ï¼šåŸºäºç”¨æˆ·è§’è‰²åŠ¨æ€è·å–æŠ˜æ‰£ä¸‹é™
- **ç®¡ç†å‘˜ç‰¹æƒ**ï¼šåªæœ‰ç®¡ç†å‘˜å¯ä»¥è®¾ç½®æŠ˜æ‰£æƒé™
- **å®æ—¶æ£€æŸ¥**ï¼šå‰ç«¯è¾“å…¥æ—¶ç«‹å³éªŒè¯ï¼Œé˜²æ­¢æäº¤è¶…é™æ•°æ®
- **APIæƒé™éªŒè¯**ï¼šæ‰€æœ‰APIéƒ½éœ€è¦ç™»å½•éªŒè¯

## ğŸš€ æ‰©å±•å»ºè®®

1. **å®¡æ‰¹æµç¨‹é›†æˆ**ï¼šè¶…å‡ºæƒé™çš„æŠ˜æ‰£å¯è§¦å‘æ›´é«˜çº§åˆ«å®¡æ‰¹
2. **å†å²è®°å½•**ï¼šè®°å½•æŠ˜æ‰£æƒé™çš„ä¿®æ”¹å†å²
3. **æ‰¹é‡æ“ä½œ**ï¼šæ”¯æŒæ‰¹é‡è®¾ç½®å¤šä¸ªè§’è‰²çš„æŠ˜æ‰£æƒé™
4. **æ›´ç»†ç²’åº¦æ§åˆ¶**ï¼šæ”¯æŒæŒ‰äº§å“ç±»åˆ«æˆ–å®¢æˆ·ç±»å‹è®¾ç½®ä¸åŒä¸‹é™

## ğŸ“ æ–‡ä»¶æ¸…å•

### æ–°å¢æ–‡ä»¶
- `app/services/discount_permission_service.py` - æŠ˜æ‰£æƒé™æœåŠ¡
- `app/api/v1/discount_permissions.py` - æŠ˜æ‰£æƒé™API
- `app/templates/test_discount_ui.html` - æµ‹è¯•é¡µé¢
- `app/routes/test_routes.py` - æµ‹è¯•è·¯ç”±

### ä¿®æ”¹æ–‡ä»¶
- `app/models/role_permissions.py` - æ·»åŠ æŠ˜æ‰£ä¸‹é™å­—æ®µ
- `app/templates/user/role_permissions.html` - æƒé™ç®¡ç†ç•Œé¢
- `app/templates/pricing_order/edit_pricing_order.html` - æ‰¹ä»·å•é¡µé¢é›†æˆ
- `app/routes/pricing_order_routes.py` - æ·»åŠ æŠ˜æ‰£æƒé™ä¼ é€’
- `app/views/user.py` - æƒé™ä¿å­˜é€»è¾‘æ›´æ–°
- `app/api/v1/__init__.py` - APIæ¨¡å—å¯¼å…¥
- `app/__init__.py` - æµ‹è¯•è·¯ç”±æ³¨å†Œ

## âœ¨ æ€»ç»“

æœ¬æ¬¡å¼€å‘æˆåŠŸå®ç°äº†å®Œæ•´çš„æŠ˜æ‰£æƒé™æ§åˆ¶ç³»ç»Ÿï¼Œä»æ•°æ®åº“è®¾è®¡åˆ°å‰ç«¯äº¤äº’éƒ½å·²å®Œæˆã€‚ç”¨æˆ·åœ¨è®¾ç½®æŠ˜æ‰£æ—¶å¯ä»¥å®æ—¶çœ‹åˆ°æƒé™æç¤ºï¼Œç®¡ç†å‘˜å¯ä»¥çµæ´»é…ç½®å„è§’è‰²çš„æŠ˜æ‰£æƒé™ï¼Œä¸ºä¼ä¸šçš„æŠ˜æ‰£ç®¡ç†æä¾›äº†æœ‰æ•ˆçš„æ§åˆ¶æ‰‹æ®µã€‚ 